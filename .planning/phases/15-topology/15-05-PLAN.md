---
phase: 15-topology
plan: 05
type: execute
wave: 3
depends_on: ["15-01", "15-04"]
files_modified:
  - src/components/commit/CommitDetailsBlade.tsx
  - src/components/commit/FileTreeBlade.tsx
  - src/components/RepositoryView.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a commit in topology shows full details in a blade panel (TOPO-01)"
    - "Commit details include author, date, full SHA, commit message, parent SHAs (TOPO-02)"
    - "Commit details include list of changed files with status indicators (TOPO-03)"
    - "File list is togglable between directory tree view and flat list view"
    - "Per-file stats show GitHub-style colored bars with +/- insertion/deletion counts"
    - "Selecting a file in commit details pushes a diff blade (TOPO-04, HIST-02)"
  artifacts:
    - path: "src/components/commit/CommitDetailsBlade.tsx"
      provides: "Full commit details blade with file tree"
      contains: "CommitDetailsBlade"
    - path: "src/components/commit/FileTreeBlade.tsx"
      provides: "File tree component with tree/flat toggle and per-file stats"
      contains: "FileTreeBlade"
  key_links:
    - from: "src/components/commit/CommitDetailsBlade.tsx"
      to: "src/hooks/useBladeNavigation.ts"
      via: "openDiff to push diff blade when file is selected"
      pattern: "openDiff"
    - from: "src/components/RepositoryView.tsx"
      to: "src/components/commit/CommitDetailsBlade.tsx"
      via: "renderBlade maps commit-details type to CommitDetailsBlade"
      pattern: "CommitDetailsBlade"
---

<objective>
Create the CommitDetailsBlade component that shows full commit information (author, date, SHA, message, parent SHAs, changed files) in a blade panel. Includes a file tree with tree/flat toggle and GitHub-style per-file stats. Selecting a file pushes a diff blade.

Purpose: This implements TOPO-01, TOPO-02, TOPO-03, and wires to TOPO-04. It also satisfies HIST-01 (selecting a commit shows details) and HIST-02 (view diff of files in historical commits). The commit details blade is the central inspection interface.

Output: CommitDetailsBlade and FileTreeBlade components. RepositoryView updated to render CommitDetailsBlade for commit-details blades.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-topology/15-04-SUMMARY.md
@src/components/topology/TopologyCommitDetails.tsx
@src/components/commit/CommitDetails.tsx
@src/components/staging/StagingPanel.tsx
@src/components/staging/FileTreeView.tsx
@src/hooks/useBladeNavigation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FileTreeBlade component with tree/flat toggle and per-file stats</name>
  <files>src/components/commit/FileTreeBlade.tsx</files>
  <action>
Create `src/components/commit/FileTreeBlade.tsx` -- a reusable file tree component for commit details that supports both tree and flat view modes, matching the existing StagingPanel UX pattern.

**Props:**
```typescript
interface FileTreeBladeProps {
  files: FileChanged[];  // From bindings.ts (path, status, additions, deletions)
  onSelectFile: (filePath: string) => void;
  selectedFile?: string;
}
```

**State:**
- `viewMode: 'tree' | 'flat'` (default: 'flat')
- `searchFilter: string` (default: '')

**Header bar:**
- Search input (matching existing FileTreeSearch pattern): `<input type="text" placeholder="Filter files..." />`
- View toggle buttons (matching StagingPanel pattern):
  - Tree view button: FolderTree icon
  - Flat list button: List icon
  - Use same toggle UI: `bg-ctp-surface0 rounded p-0.5` container with two buttons

**Flat view (default):**
- Render each file as a clickable row
- Row layout: `flex items-center gap-2 text-sm py-1.5 px-3 hover:bg-ctp-surface0/50 cursor-pointer rounded-sm`
- Status indicator: single character (A/M/D/R) with color coding:
  - `added` = `text-ctp-green`, show "A"
  - `modified` = `text-ctp-yellow`, show "M"
  - `deleted` = `text-ctp-red`, show "D"
  - `renamed` = `text-ctp-blue`, show "R"
  - `copied` = `text-ctp-teal`, show "C"
- File path: `text-ctp-subtext1 truncate flex-1`
- **GitHub-style per-file stats bar** (LOCKED DECISION):
  - Show `+{additions}` in green and `-{deletions}` in red, as text
  - Then a mini colored bar: a `div` with `h-2 rounded-full overflow-hidden flex` containing:
    - Green segment: `bg-ctp-green` with width proportional to additions/(additions+deletions)
    - Red segment: `bg-ctp-red` with width proportional to deletions/(additions+deletions)
  - Total width of bar: `w-16` (64px)
  - Example: `+42 -8` [===========---]
- Selected file: `bg-ctp-surface0 ring-1 ring-ctp-blue/30`
- onClick: call `onSelectFile(file.path)`
- Filter: if `searchFilter` is set, only show files whose path includes the filter (case-insensitive)

**Tree view:**
- Build a directory tree from file paths (split on `/`)
- Render folders as collapsible sections (using `<details open>` elements, same as sidebar)
- Folder: `<summary>` with FolderOpen icon, folder name, count badge
- Files inside folders: same row layout as flat view
- Sort: folders first, then files alphabetically

**Summary line at top:**
- `{files.length} files changed` with total additions/deletions:
- `<span class="text-ctp-green">+{totalAdditions}</span> <span class="text-ctp-red">-{totalDeletions}</span>`
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to check TypeScript compiles.
  </verify>
  <done>
FileTreeBlade component provides tree/flat toggle, search filter, GitHub-style per-file stats bars, and file selection callback. Matches existing StagingPanel UX patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CommitDetailsBlade and wire into RepositoryView</name>
  <files>src/components/commit/CommitDetailsBlade.tsx, src/components/RepositoryView.tsx</files>
  <action>
**CommitDetailsBlade.tsx** -- Full commit details displayed in a blade panel:

**Props:**
```typescript
interface CommitDetailsBladeProps {
  oid: string;
}
```

**Data fetching:**
- Use `useQuery` with `queryKey: ["commitDetails", oid]` and `queryFn: () => commands.getCommitDetails(oid)` -- same pattern as existing TopologyCommitDetails.tsx
- Show Skeleton loading state (matching Phase 14 pattern)

**Layout (scrollable, full blade height):**
1. **Commit message section:**
   - Full commit message: `text-base text-ctp-text whitespace-pre-wrap` (first line as heading, rest as body)
   - Parse first line separately with `message.split('\n')[0]` for the subject

2. **Metadata section** (card-like, `bg-ctp-surface0/30 rounded-lg p-3`):
   - Author: User icon + `authorName <authorEmail>` in `text-sm text-ctp-subtext1`
   - Date: Clock icon + formatted date `new Date(authorTimestampMs).toLocaleString()` in `text-sm text-ctp-subtext1`
   - Full SHA: GitCommit icon + full `oid` in `font-mono text-xs text-ctp-overlay1` (clickable to copy to clipboard)
   - Parent SHAs: `parentOids.map(p => p.substring(0, 7)).join(', ')` in `font-mono text-xs text-ctp-overlay0`
   - Committer (if different from author): show separately

3. **Files changed section:**
   - Render `<FileTreeBlade>` with:
     - `files={details.filesChanged}`
     - `onSelectFile={(filePath) => openDiff(oid, filePath)}`
     - `selectedFile` from local state (optional, for highlighting)
   - Use `useBladeNavigation().openDiff` to push a diff blade when file is selected

**Wire into RepositoryView.tsx:**
1. Import `CommitDetailsBlade` from `./commit/CommitDetailsBlade`
2. In the `renderBlade` function, update the `commit-details` case:
   ```typescript
   case 'commit-details':
     return (
       <BladePanel title="Commit" showBack onBack={goBack}>
         <CommitDetailsBlade oid={String(blade.props.oid)} />
       </BladePanel>
     );
   ```
3. Replace the placeholder div that was added in Plan 15-04

**Old components cleanup:**
- The old `TopologyCommitDetails.tsx` is no longer used (CommitDetailsBlade replaces it). Delete it or mark it as deprecated.
- The old `CommitDetails.tsx` in `components/commit/` was used by the History tab's right panel. It will be replaced by CommitDetailsBlade in Plan 15-06 when history integration is done. For now, leave it in place.
- Update `src/components/topology/index.ts` to remove `TopologyCommitDetails` export if it was deleted
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to verify TypeScript compiles. Then: `grep -n "CommitDetailsBlade\|FileTreeBlade" src/components/RepositoryView.tsx src/components/commit/CommitDetailsBlade.tsx` to confirm wiring.
  </verify>
  <done>
CommitDetailsBlade shows full commit information (author, date, full SHA, message, parent SHAs, changed files with stats). FileTreeBlade provides tree/flat toggle with GitHub-style colored stats bars. Clicking a file in the commit details pushes a diff blade via useBladeNavigation. RepositoryView renders CommitDetailsBlade for commit-details blade type.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors (excluding known bindings.ts issue)
2. Clicking a commit in topology opens CommitDetailsBlade (TOPO-01)
3. Details show author, date, full SHA, message, parent SHAs (TOPO-02)
4. Changed files list with status indicators (A/M/D) and GitHub-style stats bars (TOPO-03)
5. Tree/flat toggle works (matching StagingPanel UX)
6. Clicking a file in the list pushes a diff blade (TOPO-04 wiring)
</verification>

<success_criteria>
- CommitDetailsBlade displays all required commit metadata (TOPO-02)
- File tree supports tree/flat view toggle per locked decision
- Per-file stats show GitHub-style colored bars (+/- counts) per locked decision
- Selecting a file pushes a commit-diff blade (wires to TOPO-04)
- Component fetches data via existing getCommitDetails command
</success_criteria>

<output>
After completion, create `.planning/phases/15-topology/15-05-SUMMARY.md`
</output>
