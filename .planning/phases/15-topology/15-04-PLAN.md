---
phase: 15-topology
plan: 04
type: execute
wave: 2
depends_on: ["15-02", "15-03"]
files_modified:
  - src/components/RepositoryView.tsx
  - src/components/Header.tsx
  - src/App.tsx
  - src/stores/topology.ts
  - src/hooks/useCommitGraph.ts
autonomous: true

must_haves:
  truths:
    - "RepositoryView uses blade-based layout instead of 3-panel tab layout"
    - "Left sidebar stays fixed with branches, stashes, tags (unchanged)"
    - "Main area renders BladeContainer with blade stack"
    - "Header shows ProcessNavigation for switching between Staging and Topology"
    - "Topology auto-refreshes after commits via repository-changed event"
    - "When no commit is selected in topology, graph fills the blade with a helpful message overlay"
  artifacts:
    - path: "src/components/RepositoryView.tsx"
      provides: "Rewritten layout using blade navigation"
      contains: "BladeContainer"
    - path: "src/components/Header.tsx"
      provides: "ProcessNavigation integrated into header bar"
      contains: "ProcessNavigation"
    - path: "src/App.tsx"
      provides: "Topology auto-refresh on repository-changed event"
      contains: "useTopologyStore"
  key_links:
    - from: "src/components/RepositoryView.tsx"
      to: "src/stores/blades.ts"
      via: "useBladeStore for blade stack"
      pattern: "useBladeStore"
    - from: "src/components/RepositoryView.tsx"
      to: "src/components/blades/BladeContainer.tsx"
      via: "renders BladeContainer with renderBlade function"
      pattern: "BladeContainer"
    - from: "src/App.tsx"
      to: "src/stores/topology.ts"
      via: "topology auto-refresh in repository-changed listener"
      pattern: "useTopologyStore.*loadGraph"
---

<objective>
Rewrite RepositoryView.tsx to replace the 3-panel resizable layout with the blade-based navigation model. Integrate ProcessNavigation into the Header. Add topology auto-refresh to fix v1.0 tech debt.

Purpose: This is the central integration plan that wires together the blade system (Plan 15-02) and restyled topology (Plan 15-03) into the actual application layout. It also fixes the v1.0 tech debt where topology required manual tab switch to refresh after commits.

Output: RepositoryView uses blades, Header includes process switcher, topology auto-refreshes on repository changes.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-topology/15-02-SUMMARY.md
@.planning/phases/15-topology/15-03-SUMMARY.md
@src/components/RepositoryView.tsx
@src/components/Header.tsx
@src/App.tsx
@src/stores/topology.ts
@src/hooks/useCommitGraph.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite RepositoryView.tsx with blade layout</name>
  <files>src/components/RepositoryView.tsx</files>
  <action>
Rewrite `src/components/RepositoryView.tsx` to replace the 3-panel tab-based layout with the blade model. The sidebar stays, but the middle+right panels are replaced by a BladeContainer.

**New layout structure:**
```
<ResizablePanelLayout direction="horizontal">
  <ResizablePanel id="sidebar" defaultSize={20} minSize={15} maxSize={30}>
    {/* Left sidebar - UNCHANGED from current: branches, stashes, tags, gitflow, worktrees, commit form */}
  </ResizablePanel>
  <ResizeHandle />
  <ResizablePanel id="blades" defaultSize={80}>
    <BladeContainer renderBlade={renderBlade} />
  </ResizablePanel>
</ResizablePanelLayout>
```

**Key changes:**
1. Remove the middle panel (Changes/History/Topology tabs) and right panel (FileViewer/CommitDetails/TopologyPanel)
2. Remove `activeTab` state, `selectedCommit` state, and all tab-switching logic
3. Remove direct TopologyCommitDetails usage (this moves to a blade in Plan 15-05)
4. Import `BladeContainer` from `../components/blades`
5. Import `useBladeStore` from `../stores/blades`
6. Import `useBladeNavigation` from `../hooks/useBladeNavigation`

**renderBlade function** -- Map blade types to components:
```typescript
const renderBlade = useCallback((blade: Blade) => {
  switch (blade.type) {
    case 'staging-changes':
      return (
        <BladePanel title="Changes">
          <StagingPanel />
        </BladePanel>
      );
    case 'topology-graph':
      return (
        <BladePanel title="Topology">
          <TopologyPanel />
        </BladePanel>
      );
    case 'commit-details':
      return (
        <BladePanel title="Commit" showBack onBack={goBack}>
          {/* Placeholder for now -- Plan 15-05 will create CommitDetailsBlade */}
          <div className="p-4 text-ctp-subtext0 text-sm">
            Commit details for {String(blade.props.oid).substring(0, 7)}
          </div>
        </BladePanel>
      );
    case 'commit-diff':
      return (
        <BladePanel title={String(blade.props.filePath || 'Diff')} showBack onBack={goBack}>
          {/* Placeholder for now -- Plan 15-06 will create DiffBlade */}
          <div className="p-4 text-ctp-subtext0 text-sm">
            Diff viewer placeholder
          </div>
        </BladePanel>
      );
    default:
      return <div>Unknown blade type</div>;
  }
}, [goBack]);
```

**Staging process integration:**
- When the blade process is 'staging' and the root blade is 'staging-changes', the StagingPanel renders inside the blade
- The existing FileViewer needs to work alongside StagingPanel. For the staging flow: StagingPanel shows in the blade, and when a file is selected, it should show the diff. For now, render both StagingPanel and FileViewer side by side within the staging blade:
  ```typescript
  case 'staging-changes':
    return (
      <BladePanel title="Changes">
        <div className="flex h-full">
          <div className="w-[300px] shrink-0 border-r border-ctp-surface0 overflow-hidden">
            <StagingPanel />
          </div>
          <div className="flex-1 min-w-0">
            <FileViewer />
          </div>
        </div>
      </BladePanel>
    );
  ```

**Topology process integration:**
- TopologyPanel renders in the topology root blade
- Clicking a commit in the graph will push a commit-details blade (handled by the onSelect callback -- wire `useBladeNavigation().openCommitDetails(oid)` to the topology store's selectCommit action)

**Wire commit selection to blade navigation:**
- In the topology-graph blade, when a commit is selected in TopologyPanel, call `openCommitDetails(oid)` to push a new blade
- Modify TopologyPanel to accept an `onCommitSelect?: (oid: string) => void` prop. When a node is clicked, call this prop instead of just setting selectedCommit in the store
- In renderBlade for topology-graph, pass `onCommitSelect={openCommitDetails}` to TopologyPanel

**TOPO-07 compliance** -- When no commit is selected (topology root blade), the graph fills the full blade. No separate "select a commit" placeholder needed because the graph itself IS the content.

**Keep all existing sidebar content and dialogs** -- branches, stashes, tags, gitflow, worktrees, commit form, CreateWorktreeDialog, DeleteWorktreeDialog. These are unchanged.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to verify TypeScript compiles.
  </verify>
  <done>
RepositoryView uses blade-based layout. Left sidebar unchanged. Main area uses BladeContainer with renderBlade mapping blade types to components. Staging shows StagingPanel+FileViewer side by side. Topology shows TopologyPanel with commit selection pushing a new blade.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ProcessNavigation into Header and add topology auto-refresh</name>
  <files>src/components/Header.tsx, src/App.tsx, src/stores/topology.ts</files>
  <action>
**Header.tsx changes:**
1. Import `ProcessNavigation` from `./blades`
2. Import `useRepositoryStore` (already imported)
3. In the header JSX, after the BranchSwitcher and before the right-side buttons, add the ProcessNavigation component. Place it in the center area of the header:
   - After the `{status && (<> ... <BranchSwitcher /> </>)}` block
   - Add: `{status && <ProcessNavigation className="ml-4" />}`
   - This puts the Staging/Topology switcher in the header bar when a repo is open

**App.tsx changes -- topology auto-refresh (fixes v1.0 tech debt, TOPO-06):**
1. Import `useTopologyStore` from `./stores/topology`
2. In the `repository-changed` event listener (already exists), add topology refresh:
   ```typescript
   // After the existing invalidateQueries calls:
   // Debounced topology refresh to avoid rapid refreshes during batch operations
   const topologyState = useTopologyStore.getState();
   if (topologyState.nodes.length > 0) {
     // Only refresh if topology has been loaded (user has viewed it)
     topologyState.loadGraph();
   }
   ```
3. Note: We access the store via `useTopologyStore.getState()` (not a hook) because this is inside an event listener callback, not a React component render. This is the correct Zustand pattern for accessing state outside of React.
4. The debouncing is handled naturally because `loadGraph` sets `isLoading: true` at the start, and subsequent calls during loading are effectively no-ops because they'll overwrite each other's results with the latest data.

**topology.ts minor update:**
- Add a `lastRefreshTimestamp` field to the store state to track when the topology was last refreshed. Initialize to `0`.
- In `loadGraph`, set `lastRefreshTimestamp: Date.now()` in the success set() call
- This allows the UI to detect stale topology data if needed
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to verify TypeScript compiles. Then grep for the key integrations: `grep -n "ProcessNavigation\|useTopologyStore" src/components/Header.tsx src/App.tsx`.
  </verify>
  <done>
Header shows ProcessNavigation for Staging/Topology process switching. Topology auto-refreshes after commits via repository-changed event listener in App.tsx. Topology store tracks lastRefreshTimestamp.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors (excluding known bindings.ts issue)
2. RepositoryView no longer has Changes/History/Topology tabs -- uses BladeContainer instead
3. Header shows "Staging" and "Topology" process buttons between navigation pills and action buttons
4. Switching processes changes the root blade content
5. Topology auto-refreshes when files change (repository-changed event)
6. Left sidebar is completely unchanged
</verification>

<success_criteria>
- 3-panel tab layout replaced with blade-based layout (sidebar + blade container)
- ProcessNavigation visible in header when repo is open
- Staging process shows StagingPanel + FileViewer in a single blade
- Topology process shows TopologyPanel in a single blade
- Topology auto-refreshes after commits (v1.0 tech debt fixed, TOPO-06)
- Clicking a commit in topology pushes a commit-details blade
</success_criteria>

<output>
After completion, create `.planning/phases/15-topology/15-04-SUMMARY.md`
</output>
