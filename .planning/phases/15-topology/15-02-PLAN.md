---
phase: 15-topology
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/blades.ts
  - src/components/blades/BladeContainer.tsx
  - src/components/blades/BladePanel.tsx
  - src/components/blades/BladeStrip.tsx
  - src/components/blades/ProcessNavigation.tsx
  - src/components/blades/index.ts
  - src/hooks/useBladeNavigation.ts
  - src/lib/animations.ts
autonomous: true

must_haves:
  truths:
    - "Blade store manages a stack of blade panels with push/pop/popToIndex operations"
    - "BladeContainer renders the blade stack with AnimatePresence slide-in animations"
    - "Previous blades compress to narrow strips showing title and back arrow"
    - "ProcessNavigation provides entry points for Staging and Topology processes"
    - "Active blade fills remaining space, strips have fixed narrow width"
  artifacts:
    - path: "src/stores/blades.ts"
      provides: "Zustand blade stack state management"
      contains: "useBladeStore"
    - path: "src/components/blades/BladeContainer.tsx"
      provides: "Blade stack renderer with AnimatePresence"
      contains: "BladeContainer"
    - path: "src/components/blades/BladeStrip.tsx"
      provides: "Compressed blade strip (narrow panel with title + back)"
      contains: "BladeStrip"
    - path: "src/components/blades/ProcessNavigation.tsx"
      provides: "Header bar process entry points"
      contains: "ProcessNavigation"
  key_links:
    - from: "src/components/blades/BladeContainer.tsx"
      to: "src/stores/blades.ts"
      via: "useBladeStore hook"
      pattern: "useBladeStore"
    - from: "src/components/blades/BladeContainer.tsx"
      to: "src/components/blades/BladeStrip.tsx"
      via: "renders strips for non-active blades"
      pattern: "BladeStrip"
---

<objective>
Build the blade navigation system -- a stack-based panel model (Azure Portal pattern) where each action pushes a new blade from the right and previous blades compress to narrow strips. This replaces the current 3-panel tab-based layout.

Purpose: The blade system is the architectural foundation for the entire Phase 15 UI. All subsequent plans (topology graph, commit details, diff viewer) render inside blades. This must exist before any content blades can be built.

Output: Blade store, BladeContainer, BladePanel, BladeStrip, ProcessNavigation components, and useBladeNavigation hook.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-topology/15-RESEARCH.md
@src/stores/topology.ts
@src/lib/animations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blade store and navigation hook</name>
  <files>src/stores/blades.ts, src/hooks/useBladeNavigation.ts</files>
  <action>
Create `src/stores/blades.ts` -- a Zustand store managing blade navigation state:

```typescript
interface Blade {
  id: string;
  type: BladeType;
  title: string;
  props: Record<string, unknown>;
}

type BladeType =
  | 'staging-changes'    // StagingPanel as blade
  | 'topology-graph'     // TopologyPanel as blade
  | 'commit-details'     // Commit details blade
  | 'commit-diff'        // Diff viewer blade
  ;

type ProcessType = 'staging' | 'topology';

interface BladeState {
  activeProcess: ProcessType;
  bladeStack: Blade[];

  // Actions
  setProcess: (process: ProcessType) => void;
  pushBlade: (blade: Omit<Blade, 'id'>) => void;
  popBlade: () => void;
  popToIndex: (index: number) => void;
  replaceBlade: (blade: Omit<Blade, 'id'>) => void;
  resetStack: () => void;
}
```

Implementation:
- `setProcess(process)`: Sets `activeProcess`, resets `bladeStack` to the root blade for that process. For 'staging', push a single blade `{ type: 'staging-changes', title: 'Changes', props: {} }`. For 'topology', push `{ type: 'topology-graph', title: 'Topology', props: {} }`.
- `pushBlade(blade)`: Generate a unique id with `crypto.randomUUID()`, append to `bladeStack`.
- `popBlade()`: Remove last blade from stack. Never pop below 1 (the root blade).
- `popToIndex(index)`: Slice `bladeStack` to `index + 1` (keep blades 0 through index).
- `replaceBlade(blade)`: Pop current blade and push new one (for switching files in diff view).
- `resetStack()`: Reset to single root blade for current process.
- Default state: `activeProcess: 'staging'`, `bladeStack: [{ id: 'root', type: 'staging-changes', title: 'Changes', props: {} }]`

Create `src/hooks/useBladeNavigation.ts` -- convenience hook:

```typescript
export function useBladeNavigation() {
  const store = useBladeStore();
  
  const openCommitDetails = (oid: string) => {
    store.pushBlade({
      type: 'commit-details',
      title: 'Commit',
      props: { oid },
    });
  };

  const openDiff = (oid: string, filePath: string) => {
    store.pushBlade({
      type: 'commit-diff',
      title: filePath.split('/').pop() || filePath,
      props: { oid, filePath },
    });
  };

  const goBack = () => store.popBlade();
  const goToRoot = () => store.resetStack();

  return {
    ...store,
    openCommitDetails,
    openDiff,
    goBack,
    goToRoot,
  };
}
```
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to check for TypeScript errors (ignoring the known bindings.ts issue).
  </verify>
  <done>
Blade store exists with push/pop/popToIndex/setProcess operations. Navigation hook provides convenience methods for opening commit details and diff blades.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create blade UI components and process navigation</name>
  <files>src/components/blades/BladeContainer.tsx, src/components/blades/BladePanel.tsx, src/components/blades/BladeStrip.tsx, src/components/blades/ProcessNavigation.tsx, src/components/blades/index.ts, src/lib/animations.ts</files>
  <action>
Create the blade UI component directory `src/components/blades/` with these files:

**BladeStrip.tsx** -- Compressed previous blade (narrow vertical strip):
- Props: `{ title: string; icon?: React.ReactNode; onExpand: () => void }`
- Render a `button` element, `w-10 shrink-0` width
- Vertical border on right: `border-r border-ctp-surface0`
- Background: `bg-ctp-base hover:bg-ctp-surface0 transition-colors`
- Content: ChevronLeft icon (lucide, `w-4 h-4 text-ctp-overlay1`) at top, then title text rotated vertically using `[writing-mode:vertical-lr] rotate-180` (so text reads top-to-bottom), `text-xs text-ctp-subtext0`
- onClick calls `onExpand`
- Add `aria-label={`Expand ${title} panel`}` for accessibility

**BladePanel.tsx** -- Wrapper for the active (rightmost) blade:
- Props: `{ children: React.ReactNode; title: string; onBack?: () => void; showBack?: boolean }`
- Full height flex column
- Header bar: `h-10 px-3 flex items-center gap-2 border-b border-ctp-surface0 bg-ctp-crust shrink-0`
  - If `showBack` is true, render a back button with ArrowLeft icon that calls `onBack`
  - Title text: `text-sm font-medium text-ctp-subtext1 truncate`
- Content area: `flex-1 min-h-0 overflow-hidden` wrapping `{children}`

**BladeContainer.tsx** -- Manages the blade stack with animations:
- Import `AnimatePresence, motion` from framer-motion
- Import `useBladeStore` from stores/blades
- Read `bladeStack` and `popToIndex` from store
- Render a `div` with `className="flex h-full overflow-hidden"`
- Map over `bladeStack`:
  - For all blades EXCEPT the last: render `<BladeStrip>` with `onExpand={() => popToIndex(index)}`
  - For the LAST blade (active): wrap in `<motion.div>` with:
    - `key={blade.id}`
    - `initial={{ x: "100%", opacity: 0 }}`
    - `animate={{ x: 0, opacity: 1 }}`
    - `exit={{ x: "100%", opacity: 0 }}`
    - `transition={{ type: "spring", stiffness: 300, damping: 30 }}`
    - `className="flex-1 min-w-0"` (fills remaining space)
  - Use `AnimatePresence mode="popLayout"` to wrap the active blade's motion.div
- IMPORTANT: The BladeContainer does NOT render blade content itself. It provides a `renderBlade` prop or uses a children render pattern. For simplicity, accept a `renderBlade: (blade: Blade) => React.ReactNode` prop that the parent (RepositoryView) will provide to map blade types to actual components.

**ProcessNavigation.tsx** -- Header bar process entry points:
- Props: `{ className?: string }`
- Import `useBladeStore` from stores/blades
- Read `activeProcess` and `setProcess` from store
- Define process list:
  ```
  const PROCESSES = [
    { id: 'staging', label: 'Staging', icon: Files },
    { id: 'topology', label: 'Topology', icon: Network },
  ] as const;
  ```
- Render a `div` with `flex items-center gap-1` containing buttons for each process
- Each button: `px-3 py-1.5 rounded-md text-sm flex items-center gap-2 transition-colors`
  - Active: `bg-ctp-surface0 text-ctp-text`
  - Inactive: `text-ctp-subtext0 hover:text-ctp-subtext1 hover:bg-ctp-surface0/50`
- onClick calls `setProcess(process.id)`
- Icons: Files from lucide for Staging, Network from lucide for Topology

**index.ts** -- barrel exports:
```typescript
export { BladeContainer } from './BladeContainer';
export { BladePanel } from './BladePanel';
export { BladeStrip } from './BladeStrip';
export { ProcessNavigation } from './ProcessNavigation';
```

**Animations addition** -- Add blade slide-in variants to `src/lib/animations.ts`:
```typescript
export const bladeSlideIn: Variants = {
  hidden: { x: "100%", opacity: 0 },
  show: {
    x: 0,
    opacity: 1,
    transition: { type: "spring", stiffness: 300, damping: 30 },
  },
  exit: {
    x: "100%",
    opacity: 0,
    transition: { type: "spring", stiffness: 300, damping: 30 },
  },
};
```
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to verify no TypeScript errors in new blade components.
  </verify>
  <done>
All blade UI components exist: BladeContainer (animated stack), BladePanel (active blade wrapper), BladeStrip (compressed strip), ProcessNavigation (Staging/Topology switcher). Blade slide animation variants added to animations.ts.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors (excluding known bindings.ts issue)
2. BladeContainer accepts a renderBlade function and displays blade stack
3. BladeStrip shows vertical title text and expands on click
4. ProcessNavigation shows Staging and Topology buttons
5. Blade store correctly manages push/pop/setProcess operations
</verification>

<success_criteria>
- Blade store manages blade stack with push/pop/popToIndex/setProcess
- BladeContainer renders blade stack with framer-motion slide-in animations
- BladeStrip compresses to narrow w-10 strip with vertical title
- ProcessNavigation provides Staging/Topology process switching
- All components use Catppuccin theme tokens
</success_criteria>

<output>
After completion, create `.planning/phases/15-topology/15-02-SUMMARY.md`
</output>
