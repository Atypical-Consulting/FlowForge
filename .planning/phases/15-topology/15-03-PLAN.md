---
phase: 15-topology
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/topology/CommitBadge.tsx
  - src/components/topology/BranchEdge.tsx
  - src/components/topology/LaneHeader.tsx
  - src/components/topology/LaneBackground.tsx
  - src/components/topology/layoutUtils.ts
  - src/components/topology/TopologyPanel.tsx
  - src/components/topology/index.ts
  - src/stores/topology.ts
autonomous: true

must_haves:
  truths:
    - "Commit nodes render as Ungit-style rounded rectangle badges with type icon and subject"
    - "Edges render as straight angled merge lines (not curved Bezier)"
    - "Lane colors follow locked Gitflow semantic mapping: main=ctp-blue, develop=ctp-green, feature=ctp-mauve, release=ctp-peach, hotfix=ctp-red"
    - "Branch labels appear in a fixed column header row above the graph"
    - "Lane columns have faint background tint matching semantic color"
  artifacts:
    - path: "src/components/topology/CommitBadge.tsx"
      provides: "Ungit-style rounded rectangle commit node"
      contains: "CommitBadge"
    - path: "src/components/topology/BranchEdge.tsx"
      provides: "Straight angled merge line edge"
      contains: "getAngledEdgePath"
    - path: "src/components/topology/LaneHeader.tsx"
      provides: "Fixed column header row with branch labels"
      contains: "LaneHeader"
    - path: "src/components/topology/layoutUtils.ts"
      provides: "Updated color mapping and layout constants"
      contains: "ctp-blue"
  key_links:
    - from: "src/components/topology/TopologyPanel.tsx"
      to: "src/components/topology/CommitBadge.tsx"
      via: "React Flow nodeTypes registration"
      pattern: "nodeTypes.*commit.*CommitBadge"
    - from: "src/components/topology/TopologyPanel.tsx"
      to: "src/components/topology/BranchEdge.tsx"
      via: "React Flow edgeTypes registration"
      pattern: "edgeTypes.*gitflow.*BranchEdge"
---

<objective>
Restyle the topology graph from the current card-style nodes with Bezier edges to Ungit-style compact rounded-rectangle badges with straight angled merge lines and Gitflow semantic lane colors.

Purpose: This implements the locked visual style decisions -- Ungit-style badges, straight angled lines, lane background tints, and the corrected Gitflow color mapping (main=blue instead of peach, feature=mauve instead of blue, etc.).

Output: New CommitBadge, BranchEdge, LaneHeader, LaneBackground components replacing the old CommitNode and CommitEdge. Updated color mapping in layoutUtils.ts.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-topology/15-RESEARCH.md
@src/components/topology/CommitNode.tsx
@src/components/topology/CommitEdge.tsx
@src/components/topology/layoutUtils.ts
@src/components/topology/TopologyPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update color mapping and layout constants</name>
  <files>src/components/topology/layoutUtils.ts</files>
  <action>
Rewrite `src/components/topology/layoutUtils.ts` with the following changes:

1. **Update GITFLOW_COLORS** to match locked Gitflow semantic mapping (CRITICAL -- this is a locked decision):
```typescript
export const GITFLOW_COLORS: Record<BranchType, string> = {
  main: "var(--ctp-blue)",        // Was: var(--ctp-peach)
  develop: "var(--ctp-green)",    // Unchanged
  feature: "var(--ctp-mauve)",    // Was: var(--ctp-blue)
  release: "var(--ctp-peach)",    // Was: var(--ctp-mauve)
  hotfix: "var(--ctp-red)",       // Unchanged
  other: "var(--ctp-overlay0)",   // Unchanged
};
```

2. **Update node dimensions** for compact badge style:
```typescript
const NODE_WIDTH = 200;   // Was: 220
const NODE_HEIGHT = 40;   // Was: 60
```

3. **Add Tailwind color class maps** for badge styling (CSS classes, not CSS variables):
```typescript
export const BRANCH_BADGE_STYLES: Record<BranchType, string> = {
  main: "border-ctp-blue bg-ctp-blue/10 hover:bg-ctp-blue/20",
  develop: "border-ctp-green bg-ctp-green/10 hover:bg-ctp-green/20",
  feature: "border-ctp-mauve bg-ctp-mauve/10 hover:bg-ctp-mauve/20",
  release: "border-ctp-peach bg-ctp-peach/10 hover:bg-ctp-peach/20",
  hotfix: "border-ctp-red bg-ctp-red/10 hover:bg-ctp-red/20",
  other: "border-ctp-overlay0 bg-ctp-surface0/50 hover:bg-ctp-surface1/50",
};

export const BRANCH_RING_COLORS: Record<BranchType, string> = {
  main: "ring-ctp-blue",
  develop: "ring-ctp-green",
  feature: "ring-ctp-mauve",
  release: "ring-ctp-peach",
  hotfix: "ring-ctp-red",
  other: "ring-ctp-overlay0",
};

export const BRANCH_LANE_BG: Record<BranchType, string> = {
  main: "bg-ctp-blue/5",
  develop: "bg-ctp-green/5",
  feature: "bg-ctp-mauve/5",
  release: "bg-ctp-peach/5",
  hotfix: "bg-ctp-red/5",
  other: "bg-ctp-overlay0/5",
};
```

4. **Add conventional commit type icon mapping** for badge icons:
```typescript
export const COMMIT_TYPE_ICONS: Record<string, string> = {
  feat: 'Sparkles',
  fix: 'Bug',
  docs: 'FileText',
  style: 'Paintbrush',
  refactor: 'Hammer',
  perf: 'Zap',
  test: 'TestTube',
  chore: 'Settings',
  ci: 'Rocket',
  build: 'Package',
  revert: 'Undo',
};

export function parseConventionalType(message: string): string | null {
  const match = message.match(
    /^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+?\))?(!)?:/
  );
  return match ? match[1] : null;
}
```

5. Keep the existing `layoutGraph` function and `CommitNodeData`/`CommitEdgeData` interfaces. The `layoutGraph` function uses dagre and remains the same. Only the constants and color maps change.

6. Export everything that was previously exported plus the new items.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to check for TypeScript errors.
  </verify>
  <done>
Color mapping updated to locked Gitflow semantics. Node dimensions compacted for badge style. New style maps and conventional commit parser exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CommitBadge, BranchEdge, LaneHeader, LaneBackground, and update TopologyPanel</name>
  <files>src/components/topology/CommitBadge.tsx, src/components/topology/BranchEdge.tsx, src/components/topology/LaneHeader.tsx, src/components/topology/LaneBackground.tsx, src/components/topology/TopologyPanel.tsx, src/components/topology/index.ts</files>
  <action>
**CommitBadge.tsx** -- Replaces CommitNode.tsx. Ungit-style rounded rectangle badge:
- Same React Flow custom node pattern: `memo(({ data }: NodeProps<Node<CommitNodeData>>))`
- Render a compact rounded rectangle: `px-2.5 py-1.5 rounded-lg border cursor-pointer transition-all min-w-[200px] h-[40px] flex items-center gap-2`
- Use `BRANCH_BADGE_STYLES[data.branchType]` for border/bg colors
- Selected state: `ring-2 ${BRANCH_RING_COLORS[data.branchType]} ring-offset-1 ring-offset-ctp-base shadow-lg`
- Layout inside the badge (horizontal, single row):
  1. Conventional commit type icon (14x14): Parse `data.message` with `parseConventionalType()`. If found, render the corresponding Lucide icon (`Sparkles`, `Bug`, etc.) at `w-3.5 h-3.5` with `text-ctp-overlay1`. If not found, render a `GitCommit` icon as fallback.
  2. Message subject: `text-xs text-ctp-text truncate flex-1` -- show the commit message subject (truncated)
  3. Short OID: `text-[11px] font-mono text-ctp-overlay0 shrink-0` -- `data.shortOid`
- Handles: `<Handle type="target" position={Position.Top}>` and `<Handle type="source" position={Position.Bottom}>` with `className="!bg-transparent !border-0 !w-0 !h-0"` (invisible handles -- edges connect to node center)
- onClick: `data.onSelect?.(data.oid)`
- Import icon components dynamically or use a map. Since all icons are from lucide-react, create a local `ICON_MAP`:
  ```typescript
  const ICON_MAP: Record<string, React.ElementType> = {
    feat: Sparkles, fix: Bug, docs: FileText, style: Paintbrush,
    refactor: Hammer, perf: Zap, test: TestTube, chore: Settings,
    ci: Rocket, build: Package, revert: Undo,
  };
  ```

**BranchEdge.tsx** -- Replaces CommitEdge.tsx. Straight angled merge lines:
- Same React Flow custom edge pattern: `memo(({ id, sourceX, sourceY, targetX, targetY, data }: EdgeProps<Edge<CommitEdgeData>>))`
- Custom path function `getAngledEdgePath(sourceX, sourceY, targetX, targetY)`:
  - If `sourceX === targetX`: straight vertical line `M ${sourceX} ${sourceY} L ${targetX} ${targetY}`
  - Otherwise: angled path with midpoint -- `M ${sourceX} ${sourceY} L ${sourceX} ${midY} L ${targetX} ${midY} L ${targetX} ${targetY}` where `midY = sourceY + (targetY - sourceY) * 0.5`
- Color from `GITFLOW_COLORS[data?.branchType || 'other']`
- Render two SVG `<path>` elements (no framer-motion animation on auto-refresh to avoid visual noise per research pitfalls):
  1. Background glow: `strokeWidth={3} strokeOpacity={0.15}`
  2. Main edge: `strokeWidth={2} strokeOpacity={0.8}`
- No animation on edges (remove the motion.path from old CommitEdge to prevent visual noise on auto-refresh)

**LaneHeader.tsx** -- Fixed column header row above the graph:
- Props: `{ lanes: Array<{ column: number; branchName: string; branchType: BranchType }> }`
- Render a horizontal bar positioned above the graph
- Each lane label: branch name in a small rounded pill with the lane's semantic color
- Use `BRANCH_BADGE_STYLES` for coloring each pill
- `text-xs font-medium px-2 py-0.5 rounded-full`
- Position labels according to the dagre column positions (this will be wired in TopologyPanel)

**LaneBackground.tsx** -- Colored lane column background tints:
- Props: `{ lanes: Array<{ column: number; branchType: BranchType; x: number; width: number }> }`
- Render SVG `<rect>` elements as background behind the graph nodes
- Each rect: full viewport height, positioned at the lane's x coordinate, with width matching the column width
- Fill color: use the Catppuccin color with very low opacity (5-8%)
- This component renders as a React Flow Background-like element

**TopologyPanel.tsx** -- Update to use new components:
- Replace `nodeTypes = { commit: CommitNode }` with `nodeTypes = { commit: CommitBadge }`
- Replace `edgeTypes = { gitflow: CommitEdge }` with `edgeTypes = { gitflow: BranchEdge }`
- Import the new components instead of the old ones
- Keep all existing logic (useCommitGraph, useMemo for layout, loading states, error states, load more button)
- Remove the old CommitNode import
- Add a `laneInfo` useMemo that extracts unique branch lanes from nodes (group by column, get branch name and type for each lane)
- Render `<LaneHeader>` above the ReactFlow component if lane info is available
- The LaneBackground can be rendered as a custom Background element inside ReactFlow or as an overlay -- use an SVG layer behind the nodes

**index.ts** -- Update barrel exports:
- Replace `CommitNode` export with `CommitBadge`
- Replace `CommitEdge` export with `BranchEdge`
- Add `LaneHeader` and `LaneBackground` exports
- Keep `TopologyPanel`, `TopologyCommitDetails`, `layoutGraph`, `getBranchColor`, `GITFLOW_COLORS` exports

NOTE: The old `CommitNode.tsx` and `CommitEdge.tsx` files can be deleted or left in place (they won't be imported). Prefer deleting them to keep the codebase clean.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to verify TypeScript compiles. Then visually inspect that the new components have no obvious import errors.
  </verify>
  <done>
Topology graph uses Ungit-style compact badges with conventional commit type icons, straight angled merge lines, corrected Gitflow semantic lane colors (main=blue, feature=mauve, release=peach), lane header row, and lane background tints. Old CommitNode and CommitEdge are replaced.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors (excluding known bindings.ts issue)
2. CommitBadge renders compact rounded rectangles with type icon + subject + short OID
3. BranchEdge renders straight angled lines (no curves)
4. Color mapping: main=ctp-blue, develop=ctp-green, feature=ctp-mauve, release=ctp-peach, hotfix=ctp-red
5. LaneHeader shows branch labels above graph
6. TopologyPanel registers new node/edge types correctly
</verification>

<success_criteria>
- Commit nodes are compact (~200x40px) rounded rectangle badges per Ungit style
- Edges use straight angled merge lines, not curved Bezier paths
- Gitflow lane colors match locked decision exactly
- Branch labels in fixed column header row above graph
- Conventional commit type icons parsed from message and displayed on badges
</success_criteria>

<output>
After completion, create `.planning/phases/15-topology/15-03-SUMMARY.md`
</output>
