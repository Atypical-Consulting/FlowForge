---
phase: 15-topology
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/git/diff.rs
  - src-tauri/src/git/mod.rs
  - src-tauri/src/lib.rs
  - src/bindings.ts
autonomous: true

must_haves:
  truths:
    - "Backend can return diff data for any file in any historical commit"
    - "New command follows same pattern as existing get_file_diff"
    - "TypeScript bindings are regenerated with new command available"
  artifacts:
    - path: "src-tauri/src/git/diff.rs"
      provides: "get_commit_file_diff Tauri command"
      contains: "pub async fn get_commit_file_diff"
    - path: "src/bindings.ts"
      provides: "TypeScript bindings including getCommitFileDiff"
      contains: "getCommitFileDiff"
  key_links:
    - from: "src-tauri/src/lib.rs"
      to: "src-tauri/src/git/diff.rs"
      via: "command registration in collect_commands!"
      pattern: "get_commit_file_diff"
---

<objective>
Add a new Rust Tauri command `get_commit_file_diff` that returns the diff of a specific file between a commit and its first parent. This enables the frontend to display diffs for any file in any historical commit, not just staging diffs.

Purpose: Without this command, the diff blade (Plan 15-06) cannot show historical commit file diffs. The existing `get_file_diff` only supports staging diffs (HEAD vs index, index vs workdir). This is the missing backend capability identified in research.

Output: New `get_commit_file_diff` command registered in Tauri, TypeScript bindings regenerated.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src-tauri/src/git/diff.rs
@src-tauri/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement get_commit_file_diff Rust command</name>
  <files>src-tauri/src/git/diff.rs, src-tauri/src/git/mod.rs, src-tauri/src/lib.rs</files>
  <action>
Add a new public async Tauri command `get_commit_file_diff` to `src-tauri/src/git/diff.rs`. The function signature:

```rust
#[tauri::command]
#[specta::specta]
pub async fn get_commit_file_diff(
    oid: String,
    path: String,
    context_lines: u32,
    state: State<'_, RepositoryState>,
) -> Result<FileDiff, GitError>
```

Implementation details:
1. Get repo path from state (same pattern as `get_file_diff`)
2. Call `detect_language(&path)` for the language field
3. Inside `spawn_blocking`:
   a. Open repo at `repo_path`
   b. Parse `oid` string to `git2::Oid` using `git2::Oid::from_str(&oid)`, map error to `GitError::OperationFailed`
   c. Find the commit: `repo.find_commit(commit_oid)?`
   d. Get commit tree: `commit.tree()?`
   e. Get parent tree: if `commit.parent_count() > 0`, use `Some(commit.parent(0)?.tree()?)`, else `None`
   f. Get old_content from parent tree using the existing `get_blob_content(&repo, tree, &path)?` helper (already in diff.rs). If no parent tree, use `String::new()`
   g. Get new_content from commit tree using `get_blob_content(&repo, &commit_tree, &path)?`
   h. Generate hunks: create `DiffOptions` with `context_lines(context_lines).pathspec(&path)`, then `repo.diff_tree_to_tree(parent_tree.as_ref(), Some(&commit_tree), Some(&mut diff_opts))?`
   i. Iterate diff with `foreach` to detect binary and collect `DiffHunk` structs (same pattern as `get_staged_diff`)
   j. Return `FileDiff { path, old_content, new_content, hunks, is_binary, language }`

Then register the command:
1. In `src-tauri/src/git/mod.rs`: ensure `diff::get_commit_file_diff` is re-exported (check current exports, add if missing)
2. In `src-tauri/src/lib.rs`:
   a. Add `get_commit_file_diff` to the `use` import from `git::diff`
   b. Add `get_commit_file_diff` to the `collect_commands!` macro, in the "Diff commands" section next to `get_file_diff`
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && cargo check --manifest-path src-tauri/Cargo.toml` to verify the Rust code compiles without errors.
  </verify>
  <done>
`get_commit_file_diff` command compiles and is registered in Tauri's command handler. The command accepts an OID string, file path, and context lines, and returns a `FileDiff` struct with old/new content, hunks, binary flag, and language.
  </done>
</task>

<task type="auto">
  <name>Task 2: Regenerate TypeScript bindings</name>
  <files>src/bindings.ts</files>
  <action>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && cargo build --manifest-path src-tauri/Cargo.toml` to trigger the specta TypeScript binding generation (it runs in the `#[cfg(debug_assertions)]` build script).

After building, verify that `src/bindings.ts` now contains a `getCommitFileDiff` function in the `commands` object. The generated signature should accept `(oid: string, path: string, contextLines: number)` and return a `Result<FileDiff, ...>`.

Note: The pre-existing TS2440 error in bindings.ts line 1493 is a known issue in auto-generated code -- ignore it.
  </action>
  <verify>
Run `grep -n "getCommitFileDiff" /Users/phmatray/Repositories/github-phm/FlowForge/src/bindings.ts` to confirm the new command appears in the generated bindings.
  </verify>
  <done>
TypeScript bindings contain `getCommitFileDiff` function that the frontend can call to fetch historical commit file diffs.
  </done>
</task>

</tasks>

<verification>
1. `cargo check --manifest-path src-tauri/Cargo.toml` passes (Rust compiles)
2. `src/bindings.ts` contains `getCommitFileDiff` function
3. The new command reuses existing `FileDiff`, `DiffHunk` types and `get_blob_content` helper
</verification>

<success_criteria>
- New `get_commit_file_diff` Tauri command exists and compiles
- Command accepts (oid, path, context_lines) and returns FileDiff
- TypeScript bindings regenerated with `getCommitFileDiff` available
- No regressions in existing `get_file_diff` functionality
</success_criteria>

<output>
After completion, create `.planning/phases/15-topology/15-01-SUMMARY.md`
</output>
