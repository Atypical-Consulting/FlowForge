---
phase: 15-topology
plan: 06
type: execute
wave: 4
depends_on: ["15-05"]
files_modified:
  - src/components/commit/DiffBlade.tsx
  - src/components/commit/CommitHistory.tsx
  - src/components/RepositoryView.tsx
  - src/hooks/useKeyboardShortcuts.ts
  - src/stores/blades.ts
autonomous: true

must_haves:
  truths:
    - "User can view diff of any file in a selected commit (TOPO-04)"
    - "Diff viewer shows old vs new content with syntax highlighting (HIST-03)"
    - "Unified diff by default with toggle to switch to side-by-side"
    - "User can select a commit in History view to see its details (HIST-01)"
    - "Keyboard shortcuts: Escape closes blade, arrow keys navigate commits"
    - "Diff blade uses existing Monaco DiffEditor with Catppuccin theme"
  artifacts:
    - path: "src/components/commit/DiffBlade.tsx"
      provides: "Historical commit diff viewer blade"
      contains: "DiffBlade"
    - path: "src/components/commit/CommitHistory.tsx"
      provides: "Updated CommitHistory that opens blades on commit select"
      contains: "useBladeNavigation"
  key_links:
    - from: "src/components/commit/DiffBlade.tsx"
      to: "src/bindings.ts"
      via: "calls getCommitFileDiff for historical diffs"
      pattern: "getCommitFileDiff"
    - from: "src/components/commit/CommitHistory.tsx"
      to: "src/hooks/useBladeNavigation.ts"
      via: "openCommitDetails on commit selection"
      pattern: "openCommitDetails"
---

<objective>
Create the DiffBlade component for viewing historical commit file diffs using Monaco DiffEditor. Integrate CommitHistory into the blade navigation so selecting a commit in history opens the commit details blade. Add keyboard shortcuts for blade navigation.

Purpose: This completes the remaining requirements -- TOPO-04 (view diff of any file), HIST-01 (select commit in history), HIST-02 (view diff of historical files), HIST-03 (diff shows old vs new content). Also implements the locked keyboard shortcuts for blade navigation.

Output: DiffBlade component, updated CommitHistory for blade integration, keyboard shortcuts for blade navigation.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-topology/15-05-SUMMARY.md
@src/components/viewers/DiffViewer.tsx
@src/components/commit/CommitHistory.tsx
@src/hooks/useKeyboardShortcuts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiffBlade for historical commit diffs</name>
  <files>src/components/commit/DiffBlade.tsx</files>
  <action>
Create `src/components/commit/DiffBlade.tsx` -- a blade that shows the diff of a specific file in a specific commit, using the Monaco DiffEditor.

**Props:**
```typescript
interface DiffBladeProps {
  oid: string;
  filePath: string;
}
```

**Data fetching:**
- Use `useQuery` with `queryKey: ["commitFileDiff", oid, filePath, contextLines]`
- `queryFn: () => commands.getCommitFileDiff(oid, filePath, contextLines)` (from Plan 15-01's new command)
- `contextLines` default to 3 (same as existing DiffViewer)

**State:**
- `inline: boolean` (default: `true` -- unified diff by default per locked decision)

**Layout (full blade height, flex column):**
1. **Toolbar** (same pattern as existing DiffViewer.tsx):
   - `flex items-center gap-2 px-3 py-2 border-b border-ctp-surface0 bg-ctp-crust`
   - File path: `text-sm text-ctp-subtext1 truncate flex-1`
   - Inline/side-by-side toggle button:
     - If inline: show Columns icon (click switches to side-by-side)
     - If side-by-side: show AlignJustify icon (click switches to inline)
   - Binary indicator if `diff.isBinary`

2. **Monaco DiffEditor** (same config as existing DiffViewer.tsx):
   ```typescript
   <DiffEditor
     original={diff.oldContent}
     modified={diff.newContent}
     language={diff.language}
     theme="flowforge-dark"
     options={{
       readOnly: true,
       renderSideBySide: !inline,
       originalEditable: false,
       automaticLayout: true,
       scrollBeyondLastLine: false,
       minimap: { enabled: false },
       fontSize: 13,
       lineNumbers: "on",
       folding: true,
       wordWrap: "off",
       renderLineHighlight: "all",
       scrollbar: {
         verticalScrollbarSize: 10,
         horizontalScrollbarSize: 10,
       },
     }}
   />
   ```

**Loading state:** Skeleton loader (Loader2 spinner centered)
**Error state:** Red error message
**Binary file state:** "Binary file -- diff not available" message

**IMPORTANT -- Monaco memory management (from research pitfalls):**
- Do NOT mount/unmount DiffEditor on every blade open/close
- The component mounts once when the blade is visible and unmounts when the blade is removed from the stack
- Use React Query caching so re-opening the same file is instant (`staleTime: 60000`)
- The `automaticLayout: true` option handles resize when blade width changes

**Wire into RepositoryView.tsx:**
1. Import `DiffBlade` from `./commit/DiffBlade`
2. In `renderBlade`, update the `commit-diff` case:
   ```typescript
   case 'commit-diff':
     return (
       <BladePanel
         title={String(blade.props.filePath).split('/').pop() || 'Diff'}
         showBack
         onBack={goBack}
       >
         <DiffBlade
           oid={String(blade.props.oid)}
           filePath={String(blade.props.filePath)}
         />
       </BladePanel>
     );
   ```
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to verify TypeScript compiles. Then: `grep -n "getCommitFileDiff\|DiffBlade" src/components/commit/DiffBlade.tsx src/components/RepositoryView.tsx`.
  </verify>
  <done>
DiffBlade displays historical commit file diffs using Monaco DiffEditor. Supports unified/side-by-side toggle. Uses the new getCommitFileDiff backend command. Wired into RepositoryView's renderBlade function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate CommitHistory with blade navigation and add keyboard shortcuts</name>
  <files>src/components/commit/CommitHistory.tsx, src/components/RepositoryView.tsx, src/hooks/useKeyboardShortcuts.ts, src/stores/blades.ts</files>
  <action>
**CommitHistory.tsx changes -- HIST-01 compliance:**
The History view needs to be accessible from the blade system. There are two approaches:
1. Make CommitHistory a blade type (add 'history-list' blade)
2. Embed CommitHistory within the staging process or as a separate process

For the blade integration, add CommitHistory as part of the staging process. When user is in staging and wants history, they can access it. But the LOCKED DECISION says "Two root blade processes: Staging and Topology" -- history is part of the Topology process since it's about inspecting commits.

**Solution:** Add a 'history-list' blade type that shows CommitHistory. When a commit is selected in history, push a commit-details blade. Wire this into the Topology process.

1. In `src/stores/blades.ts`, add `'history-list'` to the `BladeType` union type.

2. In `src/components/commit/CommitHistory.tsx`:
   - The component currently accepts `onSelectCommit` and `selectedOid` props
   - Modify to also accept an optional `onCommitSelect?: (oid: string) => void` prop
   - When `onCommitSelect` is provided, use it instead of `onSelectCommit` for the click handler
   - This allows CommitHistory to work both ways: old way (setting local state) and new way (pushing blades)

3. In `src/components/RepositoryView.tsx`:
   - Import `CommitHistory` from `./commit/CommitHistory`
   - In the topology process, update the root blade to include both topology graph and a way to access history
   - Add a small tab bar within the topology blade that switches between "Graph" and "History" views
   - OR: Add a "History" button in the topology blade header that switches the topology root blade to show CommitHistory
   - **Best approach:** Add a sub-navigation within the topology root blade:
     ```typescript
     case 'topology-graph': {
       const [topologyView, setTopologyView] = useState<'graph' | 'history'>('graph');
       // This won't work directly in switch -- extract to a component
     }
     ```
   - **Extract a TopologyRootBlade component** that encapsulates the graph/history toggle:
     ```typescript
     function TopologyRootBlade() {
       const [view, setView] = useState<'graph' | 'history'>('graph');
       const { openCommitDetails } = useBladeNavigation();
       return (
         <div className="flex flex-col h-full">
           <div className="flex items-center gap-1 px-3 py-1.5 border-b border-ctp-surface0 bg-ctp-crust shrink-0">
             <button onClick={() => setView('graph')} className={...}>
               <Network className="w-4 h-4" /> Graph
             </button>
             <button onClick={() => setView('history')} className={...}>
               <History className="w-4 h-4" /> History
             </button>
           </div>
           <div className="flex-1 min-h-0">
             {view === 'graph' ? (
               <TopologyPanel onCommitSelect={openCommitDetails} />
             ) : (
               <CommitHistory onCommitSelect={openCommitDetails} />
             )}
           </div>
         </div>
       );
     }
     ```
   - Use TopologyRootBlade in the renderBlade for 'topology-graph' type
   - This satisfies HIST-01: user can select a commit in History view and it opens the commit details blade

**Keyboard shortcuts (LOCKED DECISIONS):**
In `src/hooks/useKeyboardShortcuts.ts`, add blade navigation shortcuts:

1. **Escape** -- Close current blade (pop blade):
   - Import `useBladeStore` from stores/blades
   - Add: `useHotkeys('escape', () => { const store = useBladeStore.getState(); if (store.bladeStack.length > 1) store.popBlade(); }, { enableOnFormTags: false })`

2. **J/K** -- Scroll topology graph (handled by React Flow's built-in pan, but add for list scrolling):
   - These can be handled at the component level rather than globally. Skip global registration for J/K -- they're better handled by the TopologyPanel/CommitHistory components with focus management.

3. **Arrow keys** for commit navigation -- handled by React Flow for the graph. For CommitHistory:
   - Add `onKeyDown` handler to CommitHistory list items for ArrowUp/ArrowDown to move selection
   - This is component-level, not global shortcuts

4. **Enter** -- Open details for selected commit:
   - If topology store has selectedCommit and active process is topology:
   - `useHotkeys('enter', () => { const topologyStore = useTopologyStore.getState(); const bladeStore = useBladeStore.getState(); if (topologyStore.selectedCommit && bladeStore.activeProcess === 'topology') { /* push commit details blade */ } })`

Note: Be careful not to interfere with existing keyboard shortcuts (mod+o for open, mod+comma for settings, etc.). Use `enableOnFormTags: false` and only activate when relevant.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -v "bindings.ts" | head -20` to verify TypeScript compiles. Then: `grep -rn "useHotkeys.*escape\|useHotkeys.*enter\|TopologyRootBlade\|onCommitSelect" src/`.
  </verify>
  <done>
DiffBlade renders historical diffs. CommitHistory integrated with blade navigation -- selecting a commit pushes commit details blade (HIST-01). TopologyRootBlade provides graph/history toggle within topology process. Keyboard shortcuts: Escape pops blade, Enter opens selected commit details. All 10 requirements (TOPO-01 through TOPO-07, HIST-01 through HIST-03) are now covered.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors (excluding known bindings.ts issue)
2. DiffBlade shows old vs new content with syntax highlighting (HIST-03)
3. Unified diff default with side-by-side toggle (locked decision)
4. CommitHistory accessible from Topology process via graph/history toggle
5. Selecting a commit in history opens commit details blade (HIST-01)
6. Selecting a file in commit details opens diff blade (TOPO-04, HIST-02)
7. Escape key closes current blade
8. Full blade chain works: Topology Graph -> Commit Details -> File Diff
</verification>

<success_criteria>
- DiffBlade shows historical file diffs using Monaco DiffEditor (TOPO-04, HIST-02, HIST-03)
- Unified diff default with toggle to side-by-side (locked decision)
- CommitHistory integrated into Topology process (HIST-01)
- TopologyRootBlade provides graph/history sub-navigation
- Keyboard shortcuts: Escape closes blade, Enter opens commit details
- Full drill-down chain functional: graph/history -> commit details -> file diff
</success_criteria>

<output>
After completion, create `.planning/phases/15-topology/15-06-SUMMARY.md`
</output>
