---
phase: 23-branch-management
plan: 04
type: execute
wave: 2
depends_on: [23-01, 23-02, 23-03]
files_modified:
  - src/components/branches/BranchScopeSelector.tsx
  - src/components/branches/BranchTypeBadge.tsx
  - src/components/branches/CollapsibleSection.tsx
  - src/components/branches/BranchList.tsx
  - src/components/branches/BranchItem.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a segmented control to switch between Local, Remote, and Last Used branch views"
    - "User sees a Quick Access section with pinned branches at the top of the branch list"
    - "User sees a Recent section showing recently checked-out branches below Quick Access"
    - "User can pin/unpin branches via a pin icon that appears on hover"
    - "Each branch item shows a colored badge indicating its Gitflow type (main, develop, feature, etc.)"
    - "Pinned section is always visible regardless of active scope selection"
  artifacts:
    - path: "src/components/branches/BranchScopeSelector.tsx"
      provides: "Segmented control for Local/Remote/Last Used filtering"
      exports: ["BranchScopeSelector"]
    - path: "src/components/branches/BranchTypeBadge.tsx"
      provides: "Color-coded branch type badge (WCAG compliant: color + text)"
      exports: ["BranchTypeBadge"]
    - path: "src/components/branches/CollapsibleSection.tsx"
      provides: "Animated collapsible section with chevron and count"
      exports: ["CollapsibleSection"]
    - path: "src/components/branches/BranchList.tsx"
      provides: "Refactored branch list with tiered sections and scope selector"
    - path: "src/components/branches/BranchItem.tsx"
      provides: "Enhanced branch item with pin toggle, type badge, and selection support"
  key_links:
    - from: "src/components/branches/BranchList.tsx"
      to: "src/hooks/useBranchScopes.ts"
      via: "import { useBranchScopes }"
      pattern: "useBranchScopes"
    - from: "src/components/branches/BranchItem.tsx"
      to: "src/stores/branchMetadata.ts"
      via: "pin/unpin via metadata store"
      pattern: "useBranchMetadataStore|pinBranch|unpinBranch"
    - from: "src/components/branches/BranchTypeBadge.tsx"
      to: "src/lib/branchClassifier.ts"
      via: "import { classifyBranch, BRANCH_BADGE_STYLES }"
      pattern: "BRANCH_BADGE_STYLES"
---

<objective>
Build the branch scope selector, tiered section layout, and enhanced branch items with pinning and type badges.

Purpose: This is the main UI plan for BRANCH-01 (recent branches), BRANCH-02 (pinned branches), BRANCH-03 (scope selector), and BRANCH-05 (feature branch visual distinction). It refactors the existing flat branch list into a tiered layout (Quick Access > Recent > Scoped All) with a segmented control for scope switching.

Output: Three new UI components (BranchScopeSelector, BranchTypeBadge, CollapsibleSection) and refactored BranchList + BranchItem with full feature integration.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-branch-management/23-01-SUMMARY.md
@.planning/phases/23-branch-management/23-02-SUMMARY.md
@src/components/branches/BranchList.tsx
@src/components/branches/BranchItem.tsx
@src/hooks/useBranchScopes.ts (from plan 23-02)
@src/stores/branchMetadata.ts (from plan 23-02)
@src/lib/branchClassifier.ts (from plan 23-01)
@src/components/navigation/RepoSwitcherItem.tsx (pin icon pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BranchScopeSelector, BranchTypeBadge, and CollapsibleSection components</name>
  <files>src/components/branches/BranchScopeSelector.tsx, src/components/branches/BranchTypeBadge.tsx, src/components/branches/CollapsibleSection.tsx</files>
  <action>
**BranchScopeSelector.tsx — Segmented control for scope filtering:**

A segmented control using `role="radiogroup"` with `role="radio"` buttons. Follows WAI-ARIA radiogroup pattern.

Props: `{ scopes: BranchScopeDefinition[], activeScopeId: string, onChange: (scopeId: string) => void }`

Implementation:
- Container: `div` with `role="radiogroup"` and `aria-label="Branch scope"`
- Styling: `flex bg-ctp-surface0 rounded-md p-0.5 mx-2 mb-2`
- Each segment: `button` with `role="radio"`, `aria-checked={active}`, `type="button"`
- Active segment: `bg-ctp-surface1 text-ctp-text shadow-sm`
- Inactive segment: `text-ctp-overlay1 hover:text-ctp-subtext0`
- Font: `text-xs font-medium rounded-sm transition-all`
- Keyboard: Arrow left/right cycle through scopes (add onKeyDown handler)

**BranchTypeBadge.tsx — Branch type visual indicator:**

Shows a colored badge with text label for Gitflow branch types. Returns null for "other" type.

Props: `{ branchName: string }` (classifies internally) OR `{ branchType: GitflowBranchType }` (direct)

Implementation:
- Import `classifyBranch` and `BRANCH_BADGE_STYLES` from branchClassifier
- Define text color map: `{ main: "text-ctp-blue", develop: "text-ctp-green", feature: "text-ctp-mauve", release: "text-ctp-peach", hotfix: "text-ctp-red", other: "" }`
- Badge: `span` with `text-xs px-1.5 py-0.5 rounded border font-medium shrink-0`
- Plus badge style from BRANCH_BADGE_STYLES and text color
- Add `aria-label={`${type} branch`}` for accessibility (WCAG 1.4.1 — color + text)
- Return null if type is "other"

**CollapsibleSection.tsx — Animated section with header:**

Collapsible section using framer-motion AnimatePresence for smooth height animation.

Props: `{ title: string, count?: number, icon?: React.ReactNode, defaultOpen?: boolean, children: React.ReactNode }`

Implementation:
- State: `const [isOpen, setIsOpen] = useState(defaultOpen ?? true)`
- Header: `button` with `type="button"`, `aria-expanded={isOpen}`, click toggles
- Header style: `w-full flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-ctp-overlay0 uppercase tracking-wider hover:text-ctp-subtext0 transition-colors`
- Chevron: `ChevronRight` icon from lucide-react, animated rotation via `motion.span` (0 -> 90 degrees)
- Count badge: `span` with count in parentheses, `text-ctp-overlay0 font-normal`
- Content: wrapped in `AnimatePresence initial={false}`, conditional `motion.div` with height animate (0 -> "auto")
- Content container: `max-h-[300px] overflow-y-auto` to prevent sidebar overflow
- Transition: `duration: 0.2, ease: "easeOut"`, `overflow: "hidden"` on motion.div
- Return null if no children AND empty (controlled by parent)
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` — no new errors. Verify all three components export correctly.</verify>
  <done>Three new components created: BranchScopeSelector (segmented control with ARIA radiogroup), BranchTypeBadge (WCAG-compliant color + text badge), CollapsibleSection (framer-motion animated collapse). All follow existing Catppuccin + Tailwind patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor BranchList for tiered sections and BranchItem for pin/badge</name>
  <files>src/components/branches/BranchList.tsx, src/components/branches/BranchItem.tsx</files>
  <action>
**BranchList.tsx — Full refactor to tiered layout:**

Replace the current flat list with a structured layout using the new hooks and components.

The layout structure from top to bottom:
1. Error banner (keep existing pattern)
2. BranchScopeSelector (Local | Remote | Last Used)
3. CollapsibleSection "Quick Access" — pinned branches (always visible, scope-independent)
4. CollapsibleSection "Recent" — recently checked-out branches (always visible, scope-independent)
5. Main branch list — filtered by active scope
6. CreateBranchDialog and MergeDialog (keep existing)

Key changes:
- Replace `useBranchStore` direct usage with `useBranchScopes()` hook
- Initialize metadata on mount: call `useBranchMetadataStore.getState().initMetadata()` in useEffect
- Load all branches (including remote): call `loadAllBranches(true)` on mount
- Use `pinnedBranches`, `recentBranches`, and `branches` (scope-filtered) from the hook
- Scope selector at top: `<BranchScopeSelector scopes={scopes} activeScopeId={activeScopeId} onChange={setScope} />`
- Quick Access section: `<CollapsibleSection title="Quick Access" icon={<Pin />} count={pinnedBranches.length}>` — only render if pinnedBranches.length > 0
- Recent section: `<CollapsibleSection title="Recent" icon={<Clock />} count={recentBranches.length}>` — only render if recentBranches.length > 0
- Main list: render scope-filtered branches in the remaining area
- Pass `EnrichedBranch` to BranchItem instead of `BranchInfo`
- Keep existing merge dialog and create branch dialog logic untouched

IMPORTANT: The branch checkout handler should also record the branch visit via metadata store:
```typescript
const handleCheckout = async (branchName: string) => {
  const success = await checkoutBranch(branchName);
  if (success && repoPath) {
    await useBranchMetadataStore.getState().recordBranchVisit(repoPath, branchName);
  }
};
```

**BranchItem.tsx — Enhanced with pin button and type badge:**

Add pin toggle and branch type badge to each branch item. Accept `EnrichedBranch` instead of `BranchInfo`.

Changes:
- Props: Change `branch: BranchInfo` to `branch: EnrichedBranch`. Add `onTogglePin?: () => void`.
- Add `group/item` class to the container div for pin icon hover visibility
- Pin button (before the branch name): Using `Pin` icon from lucide-react
  - If pinned: always visible, `text-ctp-blue hover:text-ctp-sapphire`, `fill-current` on icon
  - If not pinned: `opacity-0 group-hover/item:opacity-100`, `text-ctp-overlay0 hover:text-ctp-subtext0`
  - onClick: `e.stopPropagation(); onTogglePin?.();`
  - title/aria-label: "Unpin branch" / "Pin branch"
  - Use existing pattern from RepoSwitcherItem.tsx for consistency
- Branch type badge (after the branch name): `<BranchTypeBadge branchType={branch.branchType} />`
- Keep all existing action buttons (checkout, merge, delete) unchanged
- Keep existing loading state handling unchanged
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` — no new errors. Visually verify the branch list renders with scope selector at top, Quick Access section for pinned branches, Recent section for recently used branches, and main list filtered by scope.</verify>
  <done>BranchList refactored with tiered layout: scope selector > Quick Access (pinned) > Recent > scope-filtered main list. BranchItem enhanced with pin toggle icon and branch type badge. Checkout records branch visit in metadata store. All using useBranchScopes hook.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` — no new type errors
2. BranchScopeSelector renders with Local | Remote | Last Used options
3. Pinned branches appear in Quick Access section regardless of scope selection
4. Recent branches appear in Recent section sorted by most recent first
5. Scope selector filters the main branch list (Local shows non-remote, Remote shows remote-only, Last Used shows recently visited)
6. Pin icon appears on hover for unpinned branches, always visible for pinned ones
7. Branch type badges show correct colors (feature=purple/mauve, main=blue, etc.)
8. CollapsibleSection animates open/close with framer-motion
</verification>

<success_criteria>
- BRANCH-01: Recent branches section shows recently checked-out branches
- BRANCH-02: Quick Access section shows pinned branches, pin toggle works
- BRANCH-03: Scope selector switches between Local, Remote, and Last Used views
- BRANCH-05 (partial): Branch type badges visible with correct colors in branch list
- Pinned section is scope-independent (always visible)
- All sections use CollapsibleSection with max-height overflow prevention
- Accessibility: ARIA radiogroup on scope selector, color + text on badges
</success_criteria>

<output>
After completion, create `.planning/phases/23-branch-management/23-04-SUMMARY.md`
</output>
