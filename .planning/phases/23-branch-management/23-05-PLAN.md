---
phase: 23-branch-management
plan: 05
type: execute
wave: 2
depends_on: [23-01, 23-02, 23-03]
files_modified:
  - src/lib/bulkBranchOps.ts
  - src/hooks/useBulkSelect.ts
  - src/components/branches/BulkDeleteDialog.tsx
  - src/components/branches/BranchBulkActions.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter bulk selection mode to select multiple branches for deletion"
    - "Protected branches (main, develop, Gitflow-configured) cannot be selected for deletion"
    - "Confirmation dialog shows exactly which branches will be deleted with merged/unmerged status"
    - "Bulk delete continues through individual failures and reports per-branch results"
  artifacts:
    - path: "src/lib/bulkBranchOps.ts"
      provides: "Bulk delete pipeline with Gitflow protection and error aggregation"
      exports: ["bulkDeleteBranches", "getProtectedBranches", "BulkDeleteOptions", "BulkOperationResult"]
    - path: "src/hooks/useBulkSelect.ts"
      provides: "Multi-select state management with shift-click range selection"
      exports: ["useBulkSelect"]
    - path: "src/components/branches/BulkDeleteDialog.tsx"
      provides: "Confirmation dialog listing branches to delete with protection display"
      exports: ["BulkDeleteDialog"]
    - path: "src/components/branches/BranchBulkActions.tsx"
      provides: "Toolbar for entering/exiting bulk mode with select-all and delete actions"
      exports: ["BranchBulkActions"]
  key_links:
    - from: "src/lib/bulkBranchOps.ts"
      to: "src/bindings.ts"
      via: "commands.batchDeleteBranches"
      pattern: "batchDeleteBranches"
    - from: "src/components/branches/BulkDeleteDialog.tsx"
      to: "src/lib/bulkBranchOps.ts"
      via: "import { getProtectedBranches }"
      pattern: "getProtectedBranches"
---

<objective>
Build the bulk branch deletion system with Gitflow protection, multi-select, and confirmation dialog.

Purpose: BRANCH-04 requires bulk merged-branch cleanup with Gitflow branch protection. This plan creates the entire pipeline: a utility module for protected branch detection and batch deletion, a selection state hook, a confirmation dialog, and a toolbar component. These are standalone components that will be integrated into BranchList in plan 23-06.

Output: Four new files providing the complete bulk delete capability — ready for integration.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-branch-management/23-03-SUMMARY.md
@src/bindings.ts (batchDeleteBranches command, BatchDeleteResult type)
@src/stores/branches.ts (loadBranches for refresh after delete)
@src/stores/gitflow.ts (GitflowStatus for protected branch detection)
@src/lib/branchClassifier.ts (EnrichedBranch type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulkBranchOps utility and useBulkSelect hook</name>
  <files>src/lib/bulkBranchOps.ts, src/hooks/useBulkSelect.ts</files>
  <action>
**src/lib/bulkBranchOps.ts — Bulk operation utility:**

This module handles protected branch detection and orchestrates batch deletion.

Types:
```typescript
export interface BulkDeleteOptions {
  branchNames: string[];
  force: boolean;
}

export interface BulkOperationResult {
  succeeded: string[];
  failed: { name: string; error: string }[];
  skipped: string[];
  totalDeleted: number;
  totalFailed: number;
}
```

Functions:

1. `getProtectedBranches(gitflowStatus: GitflowStatus | null): Set<string>`
   - Always protect "main", "master", "develop"
   - If gitflowStatus has context.isInitialized, also protect the configured mainBranch and developBranch from gitflowStatus config (these might be custom names like "production" or "development")
   - Import `GitflowStatus` type from bindings

2. `async bulkDeleteBranches(options: BulkDeleteOptions): Promise<BulkOperationResult>`
   - Call `commands.batchDeleteBranches(options.branchNames, options.force)` from bindings
   - Map the BatchDeleteResult into BulkOperationResult format:
     - succeeded = results where deleted === true
     - failed = results where deleted === false (with error message)
   - Handle the overall command error case (wrap in try/catch)
   - Return the result

Note: Protection filtering happens in the UI layer (BulkDeleteDialog) BEFORE calling this function. The Rust backend does not know about protected branches — it's a UI policy.

**src/hooks/useBulkSelect.ts — Selection state management:**

A hook for managing multi-select state for branch items.

```typescript
export function useBulkSelect(branchNames: string[]) {
  const [selected, setSelected] = useState<Set<string>>(new Set());
  const [selectionMode, setSelectionMode] = useState(false);
  const [lastSelected, setLastSelected] = useState<string | null>(null);

  const toggleSelect = useCallback((name: string, shiftKey: boolean) => {
    setSelected(prev => {
      const next = new Set(prev);
      if (shiftKey && lastSelected) {
        // Range select between lastSelected and name
        const startIdx = branchNames.indexOf(lastSelected);
        const endIdx = branchNames.indexOf(name);
        if (startIdx !== -1 && endIdx !== -1) {
          const [from, to] = startIdx < endIdx ? [startIdx, endIdx] : [endIdx, startIdx];
          for (let i = from; i <= to; i++) {
            next.add(branchNames[i]);
          }
        }
      } else {
        if (next.has(name)) {
          next.delete(name);
        } else {
          next.add(name);
        }
      }
      return next;
    });
    setLastSelected(name);
  }, [branchNames, lastSelected]);

  const selectAllMerged = useCallback((mergedBranchNames: string[]) => {
    setSelected(new Set(mergedBranchNames));
  }, []);

  const clearSelection = useCallback(() => {
    setSelected(new Set());
    setLastSelected(null);
  }, []);

  const enterSelectionMode = useCallback(() => {
    setSelectionMode(true);
  }, []);

  const exitSelectionMode = useCallback(() => {
    setSelectionMode(false);
    clearSelection();
  }, [clearSelection]);

  return {
    selected,
    selectedCount: selected.size,
    selectionMode,
    toggleSelect,
    selectAllMerged,
    clearSelection,
    enterSelectionMode,
    exitSelectionMode,
    isSelected: (name: string) => selected.has(name),
  };
}
```
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` — no new errors. Verify exports: `grep -n "export" src/lib/bulkBranchOps.ts src/hooks/useBulkSelect.ts`.</verify>
  <done>bulkBranchOps.ts provides getProtectedBranches (reads Gitflow config) and bulkDeleteBranches (calls Rust batch command). useBulkSelect.ts provides selection state with shift-click range select, select-all-merged, and explicit mode toggle.</done>
</task>

<task type="auto">
  <name>Task 2: Create BulkDeleteDialog and BranchBulkActions components</name>
  <files>src/components/branches/BulkDeleteDialog.tsx, src/components/branches/BranchBulkActions.tsx</files>
  <action>
**BulkDeleteDialog.tsx — Confirmation dialog with protection display:**

A modal dialog showing exactly which branches will be deleted, with merged/unmerged indicators and protected branch callout.

Props:
```typescript
interface BulkDeleteDialogProps {
  branches: EnrichedBranch[];       // branches to delete
  protectedBranches: string[];       // names of protected branches
  isDeleting: boolean;               // loading state
  onConfirm: () => void;
  onCancel: () => void;
}
```

Layout:
- Fixed overlay: `fixed inset-0 bg-black/50 flex items-center justify-center z-50`
- Dialog card: `bg-ctp-mantle border border-ctp-surface1 rounded-lg p-6 w-[28rem] max-h-[80vh] overflow-y-auto shadow-xl`
- Title: `Delete {N} branch{es}?` with `text-lg font-semibold text-ctp-text`
- Branch list: scrollable list (max-h-48 overflow-y-auto) showing each branch with:
  - GitBranch icon, branch name (truncated), merged/unmerged indicator
  - Merged: green text "(merged)"
  - Unmerged: yellow text with AlertTriangle icon "unmerged"
- Protected callout: if protectedBranches.length > 0, show `Shield` icon + "Protected: {names} (not affected)" in blue text
- Unmerged warning: if any branches are unmerged, show yellow warning text
- "This action cannot be undone." warning in overlay0 text
- Buttons: Cancel (ghost) + Delete N (red bg, disabled during isDeleting, show Loader2 spinner)

**BranchBulkActions.tsx — Toolbar for bulk mode:**

A toolbar bar that appears at the top of the branch list section when bulk operations are available.

Props:
```typescript
interface BranchBulkActionsProps {
  selectionMode: boolean;
  selectedCount: number;
  onEnterSelectionMode: () => void;
  onExitSelectionMode: () => void;
  onSelectAllMerged: () => void;
  onDeleteSelected: () => void;
}
```

Layout:
- When NOT in selection mode: A single "Clean up" button with broom/Trash2 icon, `text-xs text-ctp-overlay1 hover:text-ctp-text` in the section header area
- When IN selection mode: A toolbar with:
  - "Select all merged" button (text button)
  - "{N} selected" count indicator
  - "Delete" button (red, disabled if selectedCount === 0)
  - "Cancel" button (exits selection mode)
- Styling: `flex items-center gap-2 px-3 py-1.5 bg-ctp-surface0/50 rounded-md mx-2 mb-2`

Import icons: `Trash2`, `Shield`, `AlertTriangle`, `GitBranch`, `Loader2`, `X` from lucide-react.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` — no new errors. Verify exports: `grep -n "export function" src/components/branches/BulkDeleteDialog.tsx src/components/branches/BranchBulkActions.tsx`.</verify>
  <done>BulkDeleteDialog shows branch list with merged/unmerged status, protected branch callout with shield icon, and red delete confirmation button. BranchBulkActions provides toolbar for entering/exiting bulk mode with select-all-merged and delete actions. Both follow existing Catppuccin styling patterns.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` — no new type errors
2. Protected branches include main, master, develop, and Gitflow-configured names
3. BulkDeleteDialog lists branches with merged/unmerged indicators
4. BulkDeleteDialog shows shield icon with protected branch names
5. BulkDeleteDialog delete button is disabled during deletion (isDeleting)
6. BranchBulkActions toggles between "Clean up" button and selection toolbar
7. All 4 files are NEW — minimal risk to existing code
</verification>

<success_criteria>
- BRANCH-04 (infrastructure): Complete bulk delete pipeline from UI to Rust
- Protected branches (main/develop + Gitflow config) cannot be selected for deletion
- Confirmation dialog shows per-branch merged/unmerged status
- Bulk operations continue through individual failures
- Selection mode is explicit (toolbar toggle) — no conflict with checkout clicks
- TypeScript compiles without new errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-branch-management/23-05-SUMMARY.md`
</output>
