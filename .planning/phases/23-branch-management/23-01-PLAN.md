---
phase: 23-branch-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/branchClassifier.ts
  - src/components/topology/TopologyPanel.tsx
  - src/components/topology/layoutUtils.ts
autonomous: true

must_haves:
  truths:
    - "Branch classification logic exists in exactly ONE place (branchClassifier.ts)"
    - "Feature branches use ctp-mauve/purple (#cba6f7) everywhere â€” topology, sidebar, gitflow diagram"
    - "All branch color lookups (hex, CSS var, Tailwind class, badge style, ring color) import from branchClassifier.ts"
  artifacts:
    - path: "src/lib/branchClassifier.ts"
      provides: "Single source of truth for branch classification and ALL color systems"
      exports: ["classifyBranch", "GitflowBranchType", "BRANCH_TYPE_COLORS", "BRANCH_TYPE_TW", "BRANCH_HEX_COLORS", "BRANCH_BADGE_STYLES", "BRANCH_RING_COLORS", "EnrichedBranch"]
    - path: "src/components/topology/TopologyPanel.tsx"
      provides: "Topology panel using unified classifier (no local classifyBranch)"
      contains: "import.*classifyBranch.*from.*branchClassifier"
    - path: "src/components/topology/layoutUtils.ts"
      provides: "Layout utils importing colors from branchClassifier (no local color maps)"
      contains: "import.*BRANCH_HEX_COLORS.*from.*branchClassifier"
  key_links:
    - from: "src/components/topology/TopologyPanel.tsx"
      to: "src/lib/branchClassifier.ts"
      via: "import { classifyBranch }"
      pattern: "import.*classifyBranch.*from.*branchClassifier"
    - from: "src/components/topology/layoutUtils.ts"
      to: "src/lib/branchClassifier.ts"
      via: "import { BRANCH_HEX_COLORS, BRANCH_BADGE_STYLES, BRANCH_RING_COLORS }"
      pattern: "import.*BRANCH_HEX_COLORS.*from.*branchClassifier"
---

<objective>
Unify the branch classification and color systems into a single source of truth.

Purpose: The codebase has THREE separate branch classification/color systems (branchClassifier.ts, layoutUtils.ts, TopologyPanel.tsx local copy). This causes feature branches to show green in the sidebar but purple in the topology graph. BRANCH-05 requires feature=purple everywhere. This plan consolidates all three into `branchClassifier.ts`, making it the canonical module for branch types and colors across the entire app.

Output: A single `branchClassifier.ts` module that exports all color representations (hex, CSS var, Tailwind, badge styles, ring colors) alongside the `classifyBranch` function and `EnrichedBranch` type. All consumers import from this one file.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/branchClassifier.ts
@src/components/topology/layoutUtils.ts
@src/components/topology/TopologyPanel.tsx
@src/bindings.ts (BranchType enum, BranchInfo struct)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand branchClassifier.ts as single source of truth for all branch colors</name>
  <files>src/lib/branchClassifier.ts</files>
  <action>
Expand `branchClassifier.ts` to be the ONE canonical module for branch type classification and ALL color representations. Keep the existing `GitflowBranchType` type and `classifyBranch` function, but:

1. **Update `classifyBranch`** to handle ref-prefixed names (strip `refs/heads/` and `origin/` prefixes) and recognize `development` and `dev` as develop. Also recognize `feature-`, `release-`, and `hotfix-` prefixes (dash variant). This makes it match the TopologyPanel's more comprehensive version.

2. **Adopt topology colors as canonical** (from layoutUtils.ts). The unified color mapping is:
   - main: blue (#89b4fa, ctp-blue)
   - develop: green (#a6e3a1, ctp-green)
   - feature: mauve/purple (#cba6f7, ctp-mauve) -- THIS IS THE KEY CHANGE per BRANCH-05
   - release: peach (#fab387, ctp-peach)
   - hotfix: red (#f38ba8, ctp-red)
   - other: overlay1 (#6c7086, ctp-overlay1)

3. **Update BRANCH_TYPE_COLORS** (CSS vars):
   - main: `var(--catppuccin-color-blue)` (was red)
   - develop: `var(--catppuccin-color-green)` (was blue)
   - feature: `var(--catppuccin-color-mauve)` (was green)
   - release: `var(--catppuccin-color-peach)` (unchanged)
   - hotfix: `var(--catppuccin-color-red)` (was mauve)
   - other: `var(--catppuccin-color-overlay1)` (unchanged)

4. **Update BRANCH_TYPE_TW** (Tailwind tokens):
   - main: `ctp-blue`, develop: `ctp-green`, feature: `ctp-mauve`, release: `ctp-peach`, hotfix: `ctp-red`, other: `ctp-overlay1`

5. **Add NEW exports** (moved from layoutUtils.ts):
   - `BRANCH_HEX_COLORS: Record<GitflowBranchType, string>` -- hex colors for SVG rendering
   - `BRANCH_BADGE_STYLES: Record<GitflowBranchType, string>` -- Tailwind badge classes (border + bg + hover)
   - `BRANCH_RING_COLORS: Record<GitflowBranchType, string>` -- Tailwind ring classes for focus/selection

6. **Add `EnrichedBranch` interface** extending BranchInfo:
   ```typescript
   import type { BranchInfo } from "../bindings";

   export interface EnrichedBranch extends BranchInfo {
     branchType: GitflowBranchType;
     isPinned: boolean;
     lastVisited: number | null;
   }
   ```

NOTE: The Gitflow diagram components (GitflowDiagram.tsx, GitflowBranchReference.tsx, GitflowActionCards.tsx, GitflowCheatsheetBlade.tsx) already import `BRANCH_TYPE_COLORS` and `classifyBranch` from branchClassifier.ts, so their colors will update automatically once we change the color maps. No changes needed to those files.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` -- should have no new type errors. Verify that `BRANCH_HEX_COLORS`, `BRANCH_BADGE_STYLES`, `BRANCH_RING_COLORS`, and `EnrichedBranch` are exported.</verify>
  <done>branchClassifier.ts exports classifyBranch (handles ref prefixes), GitflowBranchType, EnrichedBranch, and 5 color maps (BRANCH_TYPE_COLORS, BRANCH_TYPE_TW, BRANCH_HEX_COLORS, BRANCH_BADGE_STYLES, BRANCH_RING_COLORS) -- all with feature=mauve/purple.</done>
</task>

<task type="auto">
  <name>Task 2: Remove duplicate color maps from layoutUtils.ts and classifyBranch from TopologyPanel.tsx</name>
  <files>src/components/topology/layoutUtils.ts, src/components/topology/TopologyPanel.tsx</files>
  <action>
**layoutUtils.ts:**
1. Remove the local `BRANCH_HEX_COLORS`, `BRANCH_BADGE_STYLES`, and `BRANCH_RING_COLORS` constant definitions.
2. Add import: `import { BRANCH_HEX_COLORS, BRANCH_BADGE_STYLES, BRANCH_RING_COLORS } from "../../lib/branchClassifier";`
3. Re-export them so existing consumers in the topology directory still work: `export { BRANCH_HEX_COLORS, BRANCH_BADGE_STYLES, BRANCH_RING_COLORS };`
4. Keep all other code (layout constants, PositionedNode, PositionedEdge, LaneLine, computeLayout, parseConventionalType) untouched.

**TopologyPanel.tsx:**
1. Remove the local `classifyBranch` function (lines 16-27).
2. Add import: `import { classifyBranch } from "../../lib/branchClassifier";`
3. Keep all other code untouched. The usage on line 69 (`branchType: classifyBranch(name)`) will continue to work.

Verify that no other files in the topology directory have local classifyBranch copies or color map definitions by searching before making changes.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` -- no new errors. Search for duplicate classifyBranch definitions: `grep -rn "function classifyBranch" src/` should return exactly ONE result (in branchClassifier.ts). Search for duplicate BRANCH_HEX_COLORS definitions: `grep -rn "BRANCH_HEX_COLORS.*Record" src/` should return exactly ONE result (in branchClassifier.ts).</verify>
  <done>TopologyPanel.tsx imports classifyBranch from branchClassifier.ts (no local copy). layoutUtils.ts imports and re-exports all color maps from branchClassifier.ts (no local definitions). Zero duplicate classification or color logic in the codebase.</done>
</task>

</tasks>

<verification>
1. `grep -rn "function classifyBranch" src/` returns exactly one result (in branchClassifier.ts)
2. `grep -rn "BRANCH_HEX_COLORS.*:" src/lib/branchClassifier.ts` shows feature: "#cba6f7" (purple/mauve)
3. `grep -rn "ctp-green" src/lib/branchClassifier.ts` returns only develop entries (NOT feature)
4. `grep -rn "ctp-mauve" src/lib/branchClassifier.ts` returns feature entries
5. `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` has no new errors
6. The Gitflow diagram components (already importing from branchClassifier.ts) will automatically use the new colors
</verification>

<success_criteria>
- Single `branchClassifier.ts` is the ONLY file defining branch type classification and colors
- Feature branches map to mauve/purple (#cba6f7) in ALL color representations
- TopologyPanel.tsx has no local `classifyBranch` function
- layoutUtils.ts has no local color constant definitions (re-exports from branchClassifier.ts)
- EnrichedBranch type is exported for use by composition hooks in later plans
- TypeScript compiles without new errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-branch-management/23-01-SUMMARY.md`
</output>
