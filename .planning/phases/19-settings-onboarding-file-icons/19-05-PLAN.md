---
phase: 19-settings-onboarding-file-icons
plan: 05
type: execute
wave: 2
depends_on: [1]
files_modified:
  - src/components/WelcomeView.tsx
  - src/components/welcome/GitInitBanner.tsx
  - src/components/welcome/index.ts
autonomous: true

must_haves:
  truths:
    - "Opening a non-git folder via 'Open Repository' button shows a GitInitBanner instead of a red error"
    - "Dropping a non-git folder shows a GitInitBanner instead of a thrown error"
    - "GitInitBanner displays the folder name and a 'Set default branch to main' checkbox (checked by default)"
    - "Clicking 'Initialize Repository' runs git_init, then auto-opens the repo and adds to recent repos"
    - "Clicking 'Cancel' dismisses the banner without side effects"
    - "Init errors are shown inline below the action buttons"
    - "Valid git repos still open normally in both dialog and drag-drop flows"
  artifacts:
    - path: "src/components/welcome/GitInitBanner.tsx"
      provides: "Inline banner component for git init prompt"
      exports: ["GitInitBanner"]
    - path: "src/components/WelcomeView.tsx"
      provides: "Updated WelcomeView with git init flow for non-repo folders"
      exports: ["WelcomeView"]
  key_links:
    - from: "src/components/welcome/GitInitBanner.tsx"
      to: "src/bindings.ts"
      via: "imports commands for gitInit"
      pattern: "import.*commands.*from.*bindings"
    - from: "src/components/welcome/GitInitBanner.tsx"
      to: "src/stores/repository.ts"
      via: "imports useRepositoryStore for openRepository after init"
      pattern: "import.*useRepositoryStore.*from.*repository"
    - from: "src/components/WelcomeView.tsx"
      to: "src/components/welcome/GitInitBanner.tsx"
      via: "imports GitInitBanner for rendering when non-git folder detected"
      pattern: "import.*GitInitBanner.*from.*welcome/GitInitBanner"
---

<objective>
When a user opens a folder that is not a Git repository, show an inline banner offering to run git init, with a checkbox to set the default branch to "main".

Purpose: This satisfies requirement ONBR-01 -- "Opening a folder that is not a Git repository shows a prompt offering to run git init." The banner replaces the generic red error for non-git folders. After successful initialization, the repository auto-opens. This uses the git_init Rust command from Plan 19-01.

Output: A GitInitBanner component and modified WelcomeView that detects non-git folders and offers initialization.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/WelcomeView.tsx
@src/components/welcome/index.ts
@src/stores/repository.ts
@src/bindings.ts
@src/lib/animations.ts
@src/lib/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitInitBanner component</name>
  <files>src/components/welcome/GitInitBanner.tsx</files>
  <action>
Create `src/components/welcome/GitInitBanner.tsx` -- an extracted component for the git init prompt banner.

The component accepts:
- `path: string` -- the filesystem path that was attempted but is not a git repo
- `onDismiss: () => void` -- called when user clicks Cancel

Implementation:
1. Import: motion (framer-motion), AlertCircle/GitBranch/Loader2 (lucide-react), useState (react), commands (bindings), fadeInUp (animations), getErrorMessage (errors), useRecentRepos, useRepositoryStore, Button
2. Extract folder name from path: `path.split("/").pop() || path.split("\\").pop() || path`
3. Local state: `useMainBranch` (boolean, default true), `isInitializing` (boolean, default false), `initError` (string | null, default null)
4. `handleInitialize` async function:
   - Set isInitializing true, clear initError
   - Call `commands.gitInit(path, useMainBranch ? "main" : null)`
   - On success: call `openRepository(path)`, then `addRecentRepo(path)` -- app transitions to RepositoryView
   - On error: extract error message and set initError
   - Finally: set isInitializing false

5. Render structure:
   - `motion.div` with `fadeInUp` animation, `role="region"`, `aria-label="Git repository initialization"`
   - Styling: `flex flex-col gap-3 p-4 bg-ctp-surface0/50 backdrop-blur-sm border border-ctp-surface1 rounded-lg`
   - Header: GitBranch icon (blue) + "This folder is not a Git repository" + "Would you like to initialize [folderName]?"
   - Checkbox: "Set default branch to main" (ml-8 for alignment), disabled during init
   - Buttons (ml-8): "Initialize Repository" (primary, size sm, shows Loader2 spinner when initializing) + "Cancel" (ghost, size sm)
   - Error display: inline below buttons if initError is set, with AlertCircle icon in red

The visual style matches the existing error banner pattern but uses info/blue tones instead of red.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors.
  </verify>
  <done>
GitInitBanner component created with initialization flow, loading state, error display, and branch checkbox.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update welcome/index.ts barrel export</name>
  <files>src/components/welcome/index.ts</files>
  <action>
Update `src/components/welcome/index.ts` to export the new GitInitBanner component.

Add this line to the existing barrel export:
```typescript
export { GitInitBanner } from "./GitInitBanner";
```

Read the current index.ts first to see existing exports, then add the new one in the appropriate location.
  </action>
  <verify>
Verify the barrel export file includes GitInitBanner.
  </verify>
  <done>
welcome/index.ts barrel export includes GitInitBanner alongside AnimatedGradientBg.
  </done>
</task>

<task type="auto">
  <name>Task 3: Modify WelcomeView to show init banner for non-git folders</name>
  <files>src/components/WelcomeView.tsx</files>
  <action>
Update `src/components/WelcomeView.tsx` to detect non-git-repository folders and show the GitInitBanner instead of a generic error.

**Step 1**: Add import for GitInitBanner. After the existing welcome imports, add:
```typescript
import { GitInitBanner } from "./welcome/GitInitBanner";
```
(Or import from `"./welcome"` if the barrel export is used)

**Step 2**: Add local state for the init banner path. After the existing `useState` declarations, add:
```typescript
const [pendingInitPath, setPendingInitPath] = useState<string | null>(null);
```

**Step 3**: Replace the `openDialog` callback to check `isGitRepository` BEFORE attempting to open. This avoids the error flow entirely for non-git folders.

Replace the current `openDialog` with:
```typescript
const openDialog = useCallback(async () => {
  try {
    clearError();
    setPendingInitPath(null);
    const selected = await open({
      directory: true,
      multiple: false,
      title: "Open Git Repository",
    });

    if (selected && typeof selected === "string") {
      // Check if it's a git repository first
      const isRepo = await commands.isGitRepository(selected);
      if (isRepo.status === "ok" && isRepo.data) {
        // Valid git repo -- open it
        await openRepository(selected);
        await addRecentRepo(selected);
      } else {
        // Not a git repo -- show init banner
        setPendingInitPath(selected);
      }
    }
  } catch (e) {
    console.error("Failed to open repository:", e);
  }
}, [openRepository, addRecentRepo, clearError]);
```

**Step 4**: Modify the `handleDrop` callback to also show the init banner for non-git folders. Replace the try block inside handleDrop (after getting `path`) with:
```typescript
try {
  // Check if it's a git repository
  const isRepo = await commands.isGitRepository(path);
  if (isRepo.status === "ok" && isRepo.data) {
    await openRepository(path);
    await addRecentRepo(path);
  } else {
    // Not a git repo -- show init banner
    setPendingInitPath(path);
  }
} catch (e) {
  console.error("Failed to open dropped repository:", e);
}
```

**Step 5**: Add the GitInitBanner to the JSX render. After the error display `{error && (...)}` block and before the recent repos block, insert:
```tsx
{/* Git init banner */}
{pendingInitPath && !error && (
  <GitInitBanner
    path={pendingInitPath}
    onDismiss={() => setPendingInitPath(null)}
  />
)}
```

The visual order should be:
1. Welcome header + Open/Clone buttons
2. Error display (if any)
3. GitInitBanner (if pendingInitPath is set and no error)
4. RecentRepos

**Step 6**: Verify that the `pendingInitPath` and `setPendingInitPath` are included in the dependency arrays of the callbacks if needed. The `clearError` call already clears the error state, and `setPendingInitPath(null)` at the start of `openDialog` ensures opening a new folder replaces any previous init banner.
  </action>
  <verify>
1. Run `npx tsc --noEmit` and confirm no type errors (ignore pre-existing TS2440)
2. Verify opening a non-git folder shows the init banner (not a red error)
3. Verify opening a valid git folder still opens normally
4. Verify dropping a non-git folder shows the init banner
5. Verify dropping a valid git folder still opens normally
6. Verify "Initialize Repository" in the banner initializes and auto-opens the repo
7. Verify "Cancel" dismisses the banner
  </verify>
  <done>
WelcomeView modified to detect non-git folders and show GitInitBanner. Both dialog and drag-drop flows updated. Valid git repos open as before.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignore pre-existing TS2440 in bindings.ts)
2. Opening a non-git folder via "Open Repository" button shows the init banner
3. Dropping a non-git folder shows the init banner
4. Init banner displays the folder name
5. Init banner has "Set default branch to main" checkbox, checked by default
6. Clicking "Initialize Repository" shows loading state (spinner + "Initializing...")
7. After successful init, the repository auto-opens (transitions to RepositoryView)
8. After successful init, the path is added to recent repos
9. Clicking "Cancel" dismisses the banner
10. If initialization fails, error message appears inline below the buttons
11. Opening a valid git repo still works as before (no init banner)
12. Drag-drop of a valid git repo still works as before
13. Opening a new folder while init banner is showing replaces it
14. Banner uses fadeInUp animation consistent with the error display
15. Unchecking the branch checkbox and initializing creates repo without specifying branch
</verification>

<success_criteria>
- Inline banner in WelcomeView when non-git folder is opened
- "Initialize Repository" button runs git_init and auto-opens repo on success
- "Cancel" button dismisses the banner
- "Set default branch to main" checkbox (checked by default)
- Both open-dialog and drag-drop flows show the banner for non-git folders
</success_criteria>

<output>
After completion, create `.planning/phases/19-settings-onboarding-file-icons/19-05-SUMMARY.md`
</output>
