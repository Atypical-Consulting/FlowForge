---
phase: 19-settings-onboarding-file-icons
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/settings.ts
  - src/lib/platform.ts
  - src/components/settings/SettingsWindow.tsx
  - src/components/settings/SettingsField.tsx
  - src/components/WelcomeView.tsx
autonomous: true

must_haves:
  truths:
    - "SettingsCategory union includes 'integrations' alongside existing 'general', 'git', 'appearance'"
    - "IntegrationsSettings interface has editor: string and terminal: string (empty string = not configured)"
    - "Settings interface includes integrations: IntegrationsSettings"
    - "initSettings() uses a generic mergeSettings() helper that handles any future categories without code changes"
    - "platform.ts exports getPlatform(), isMac, isWindows, isLinux, and modKeyLabel"
    - "SettingsWindow uses a declarative settingsTabs array with component references instead of a switch statement"
    - "SettingsWindow has ARIA tablist/tab/tabpanel roles and keyboard navigation"
    - "SettingsField provides a reusable label+description+children wrapper for form fields"
  artifacts:
    - path: "src/stores/settings.ts"
      provides: "Extended settings store with integrations category and generic merge helper"
      exports: ["useSettingsStore", "SettingsCategory", "Settings", "IntegrationsSettings", "GeneralSettings", "GitSettings"]
    - path: "src/lib/platform.ts"
      provides: "Platform detection utility with cached result"
      exports: ["Platform", "getPlatform", "isMac", "isWindows", "isLinux", "modKeyLabel"]
    - path: "src/components/settings/SettingsWindow.tsx"
      provides: "Refactored settings window with declarative tab array and ARIA roles"
      exports: ["SettingsWindow"]
    - path: "src/components/settings/SettingsField.tsx"
      provides: "Reusable settings form field wrapper"
      exports: ["SettingsField"]
  key_links:
    - from: "src/components/settings/SettingsWindow.tsx"
      to: "src/stores/settings.ts"
      via: "imports SettingsCategory type and useSettingsStore"
      pattern: "import.*SettingsCategory.*from.*settings"
    - from: "src/components/WelcomeView.tsx"
      to: "src/lib/platform.ts"
      via: "imports modKeyLabel for keyboard shortcut display"
      pattern: "import.*modKeyLabel.*from.*platform"
---

<objective>
Extend the settings store with an integrations category, create a platform detection utility, refactor SettingsWindow to use a declarative tab array with ARIA roles, and create a reusable SettingsField component.

Purpose: This plan establishes the frontend infrastructure needed by the Integrations tab (Plan 19-04), Git settings expansion (Plan 19-03), and git init prompt (Plan 19-05). The settings store needs a new category for editor/terminal preferences. The platform utility centralizes scattered navigator.platform checks and is needed for platform-aware dropdown options. The tab refactor eliminates the switch statement and adds accessibility. The SettingsField wrapper provides consistent form layouts.

Output: Extended settings store, platform utility, refactored SettingsWindow (with Integrations tab entry commented out, to be activated by Plan 19-04), and SettingsField component. No new visible integrations UI yet.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/stores/settings.ts
@src/components/settings/SettingsWindow.tsx
@src/components/settings/GeneralSettings.tsx
@src/components/settings/GitSettings.tsx
@src/components/settings/AppearanceSettings.tsx
@src/components/WelcomeView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend settings store with integrations category</name>
  <files>src/stores/settings.ts</files>
  <action>
Modify `src/stores/settings.ts` to add the `integrations` category.

**Step 1**: Update `SettingsCategory` type (line 4):
Change `export type SettingsCategory = "general" | "git" | "appearance";`
to `export type SettingsCategory = "general" | "git" | "integrations" | "appearance";`

**Step 2**: Add `IntegrationsSettings` interface after the existing `GitSettings` interface (after line 13):
```typescript
export interface IntegrationsSettings {
  /** Preferred external editor identifier or custom path. Empty string = not configured */
  editor: string;
  /** Preferred terminal shell identifier or custom path. Empty string = not configured */
  terminal: string;
}
```

**Step 3**: Update the `Settings` interface to include integrations:
```typescript
export interface Settings {
  general: GeneralSettings;
  git: GitSettings;
  integrations: IntegrationsSettings;
}
```

**Step 4**: Update `defaultSettings` to include integrations:
```typescript
const defaultSettings: Settings = {
  general: {
    defaultTab: "changes",
  },
  git: {
    defaultRemote: "origin",
    autoFetchInterval: null,
  },
  integrations: {
    editor: "",
    terminal: "",
  },
};
```

**Step 5**: Add a generic merge helper above the store definition and update `initSettings` to use it.

Add before `export const useSettingsStore`:
```typescript
/** Merge saved settings over defaults, handling missing categories gracefully. */
function mergeSettings(defaults: Settings, saved: Partial<Settings>): Settings {
  const result = { ...defaults };
  for (const key of Object.keys(defaults) as (keyof Settings)[]) {
    if (saved[key]) {
      result[key] = { ...defaults[key], ...saved[key] } as Settings[typeof key];
    }
  }
  return result;
}
```

Then update the `initSettings` body. Replace the current per-category merge:
```typescript
if (saved) {
  const merged: Settings = {
    general: { ...defaultSettings.general, ...saved.general },
    git: { ...defaultSettings.git, ...saved.git },
  };
  set({ settings: merged });
}
```
With:
```typescript
if (saved) {
  const merged = mergeSettings(defaultSettings, saved);
  set({ settings: merged });
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors in settings.ts. Verify the Settings type includes all three categories.
  </verify>
  <done>
Settings store extended with IntegrationsSettings (editor, terminal). SettingsCategory includes "integrations". initSettings uses generic mergeSettings helper. Backward compatible with existing saved settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create platform detection utility</name>
  <files>src/lib/platform.ts, src/components/WelcomeView.tsx</files>
  <action>
Create `src/lib/platform.ts` to centralize the scattered `navigator.platform` checks found in 5+ files.

```typescript
/**
 * Centralized platform detection utility.
 *
 * Replaces scattered navigator.platform checks across the codebase.
 * Used for keyboard shortcut labels, platform-aware editor/terminal options, etc.
 */

export type Platform = "macos" | "windows" | "linux";

let cachedPlatform: Platform | null = null;

/**
 * Detect the current operating system platform.
 * Result is cached after first call.
 */
export function getPlatform(): Platform {
  if (cachedPlatform) return cachedPlatform;
  const p = navigator.platform.toLowerCase();
  if (p.includes("mac")) cachedPlatform = "macos";
  else if (p.includes("win")) cachedPlatform = "windows";
  else cachedPlatform = "linux";
  return cachedPlatform;
}

/** Whether the current platform is macOS */
export const isMac = getPlatform() === "macos";

/** Whether the current platform is Windows */
export const isWindows = getPlatform() === "windows";

/** Whether the current platform is Linux */
export const isLinux = getPlatform() === "linux";

/** Platform-specific modifier key label (Cmd on macOS, Ctrl elsewhere) */
export const modKeyLabel = isMac ? "Cmd" : "Ctrl";
```

Then update `src/components/WelcomeView.tsx` line 183 to demonstrate the utility:
- Add import at top: `import { modKeyLabel } from "../lib/platform";`
- Replace `{navigator.platform.includes("Mac") ? "Cmd" : "Ctrl"}+O` with `{modKeyLabel}+O`

NOTE: Do NOT refactor the other 4 files with `navigator.platform` usage. They work fine. The utility is created primarily for IntegrationsSettings (Plan 19-04). Migrations can happen incrementally later.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors in platform.ts or WelcomeView.tsx.
  </verify>
  <done>
platform.ts exports Platform type, getPlatform function, isMac/isWindows/isLinux booleans, and modKeyLabel string. WelcomeView uses modKeyLabel.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create reusable SettingsField component</name>
  <files>src/components/settings/SettingsField.tsx</files>
  <action>
Create `src/components/settings/SettingsField.tsx` -- a reusable wrapper for consistent label/description/children layout across all settings forms.

```typescript
interface SettingsFieldProps {
  /** The field label text */
  label: string;
  /** Optional help/description text shown below the label */
  description?: string;
  /** Unique ID for accessibility linking (htmlFor + aria-describedby) */
  htmlFor?: string;
  /** Form control(s) to render */
  children: React.ReactNode;
}

/**
 * Reusable wrapper for settings form fields.
 * Provides consistent label, optional description, and children layout.
 */
export function SettingsField({
  label,
  description,
  htmlFor,
  children,
}: SettingsFieldProps) {
  const descId = htmlFor ? `${htmlFor}-desc` : undefined;

  return (
    <div>
      <label
        htmlFor={htmlFor}
        className="block text-sm font-medium text-ctp-subtext1 mb-2"
      >
        {label}
      </label>
      {description && (
        <p id={descId} className="text-xs text-ctp-overlay0 mb-2">
          {description}
        </p>
      )}
      {children}
    </div>
  );
}
```

This mirrors the exact label styling already used in GitSettings.tsx (`text-sm font-medium text-ctp-subtext1 mb-2`) so existing visual appearance is maintained. Will be consumed by Plans 19-03 and 19-04.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors in SettingsField.tsx.
  </verify>
  <done>
SettingsField component created with label, description, htmlFor, and children props. Matches existing styling.
  </done>
</task>

<task type="auto">
  <name>Task 4: Refactor SettingsWindow to declarative tab array with ARIA</name>
  <files>src/components/settings/SettingsWindow.tsx</files>
  <action>
Replace the entire content of `src/components/settings/SettingsWindow.tsx` with a refactored version that uses a declarative tab array, eliminates the switch statement, and adds ARIA roles + keyboard navigation.

```typescript
import { type LucideIcon, GitBranch, Palette, Settings, Wrench } from "lucide-react";
import { type SettingsCategory, useSettingsStore } from "../../stores/settings";
import { Dialog, DialogContent } from "../ui/dialog";
import { AppearanceSettings } from "./AppearanceSettings";
import { GeneralSettings } from "./GeneralSettings";
import { GitSettings } from "./GitSettings";

/** Declarative tab definition -- add new tabs here. */
interface SettingsTabDef {
  id: SettingsCategory;
  label: string;
  icon: LucideIcon;
  component: React.ComponentType;
}

/**
 * Ordered list of settings tabs.
 * To add a new tab: import the component, add an entry here.
 * No switch statement or other wiring needed.
 */
const settingsTabs: SettingsTabDef[] = [
  { id: "general", label: "General", icon: Settings, component: GeneralSettings },
  { id: "git", label: "Git", icon: GitBranch, component: GitSettings },
  // Integrations tab -- uncommented by Plan 19-04 when component is created:
  // { id: "integrations", label: "Integrations", icon: Wrench, component: IntegrationsSettings },
  { id: "appearance", label: "Appearance", icon: Palette, component: AppearanceSettings },
];

export function SettingsWindow() {
  const { isOpen, closeSettings, activeCategory, setCategory } =
    useSettingsStore();

  const activeTab = settingsTabs.find((t) => t.id === activeCategory);
  const ActiveComponent = activeTab?.component ?? null;

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && closeSettings()}>
      <DialogContent className="max-w-2xl h-[500px] p-0 flex overflow-hidden">
        <div
          role="tablist"
          aria-label="Settings categories"
          className="w-[180px] border-r border-ctp-surface0 bg-ctp-base p-2 flex flex-col gap-1"
        >
          <h2 className="text-sm font-semibold text-ctp-text px-3 py-2">
            Settings
          </h2>
          {settingsTabs.map((tab, index) => {
            const Icon = tab.icon;
            return (
              <button
                key={tab.id}
                role="tab"
                id={`settings-tab-${tab.id}`}
                aria-selected={activeCategory === tab.id}
                aria-controls={`settings-panel-${tab.id}`}
                tabIndex={activeCategory === tab.id ? 0 : -1}
                type="button"
                onClick={() => setCategory(tab.id)}
                onKeyDown={(e) => {
                  const len = settingsTabs.length;
                  let nextIndex: number | null = null;
                  switch (e.key) {
                    case "ArrowDown":
                    case "ArrowRight":
                      e.preventDefault();
                      nextIndex = (index + 1) % len;
                      break;
                    case "ArrowUp":
                    case "ArrowLeft":
                      e.preventDefault();
                      nextIndex = (index - 1 + len) % len;
                      break;
                    case "Home":
                      e.preventDefault();
                      nextIndex = 0;
                      break;
                    case "End":
                      e.preventDefault();
                      nextIndex = len - 1;
                      break;
                  }
                  if (nextIndex !== null) {
                    const nextTab = settingsTabs[nextIndex];
                    setCategory(nextTab.id);
                    document.getElementById(`settings-tab-${nextTab.id}`)?.focus();
                  }
                }}
                className={`flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ctp-blue ${
                  activeCategory === tab.id
                    ? "bg-ctp-blue text-ctp-base font-medium"
                    : "text-ctp-subtext1 hover:bg-ctp-surface0 hover:text-ctp-text"
                }`}
              >
                <Icon className="w-4 h-4" />
                {tab.label}
              </button>
            );
          })}
        </div>

        <div
          role="tabpanel"
          id={`settings-panel-${activeCategory}`}
          aria-labelledby={`settings-tab-${activeCategory}`}
          tabIndex={0}
          className="flex-1 p-6 overflow-y-auto"
        >
          {ActiveComponent && <ActiveComponent />}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

Key changes from the original:
1. Declarative `settingsTabs` array replaces hardcoded `categories` array + switch statement
2. `LucideIcon` type used instead of pre-rendered JSX nodes -- icons render inline
3. ARIA roles added: `role="tablist"`, `role="tab"`, `role="tabpanel"`, `aria-selected`, `aria-controls`
4. Keyboard navigation: Arrow keys cycle tabs, Home/End jump to first/last
5. Focus management with `tabIndex` roving and `focus-visible:ring-2`
6. Integrations tab entry is commented out -- Plan 19-04 will uncomment it
7. `Wrench` icon is imported but unused until Plan 19-04 uncomments the entry
  </action>
  <verify>
1. Run `npx tsc --noEmit` and confirm no type errors (ignore pre-existing TS2440 in bindings.ts)
2. Verify the switch statement is gone from SettingsWindow.tsx
3. Verify General, Git, and Appearance tabs still render correctly
4. Verify tab keyboard navigation works (Arrow keys)
  </verify>
  <done>
SettingsWindow refactored to declarative settingsTabs array. Switch statement eliminated. ARIA tablist/tab/tabpanel roles and keyboard navigation added. Integrations tab entry commented out, ready for Plan 19-04.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignore pre-existing TS2440 in bindings.ts)
2. SettingsCategory includes "general", "git", "integrations", "appearance"
3. IntegrationsSettings interface has editor and terminal fields (both string)
4. defaultSettings includes integrations: { editor: "", terminal: "" }
5. initSettings uses generic mergeSettings() helper
6. platform.ts exports getPlatform, isMac, isWindows, isLinux, modKeyLabel
7. WelcomeView uses modKeyLabel instead of inline navigator.platform check
8. SettingsField component renders label + optional description + children
9. SettingsWindow uses declarative tab array (no switch statement)
10. Settings tabs have proper ARIA roles (tablist, tab, tabpanel)
11. Arrow keys navigate between settings tabs
</verification>

<success_criteria>
- Settings store extended with integrations category, fully backward-compatible
- Platform utility created for use by Integrations tab and WelcomeView
- SettingsWindow refactored for easy tab extensibility with ARIA roles
- SettingsField wrapper ready for use by Plans 19-03 and 19-04
</success_criteria>

<output>
After completion, create `.planning/phases/19-settings-onboarding-file-icons/19-02-SUMMARY.md`
</output>
