---
phase: 43-infrastructure-prep
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/conventional-commits/index.ts
  - src/extensions/sandbox/sandbox-api-surface.ts
  - src/extensions/sandbox/SandboxedExtensionAPI.ts
autonomous: true

must_haves:
  truths:
    - "CC store state resets to initial values when Conventional Commits extension is disabled"
    - "Re-enabling CC extension shows empty form, not stale data from previous activation"
    - "onDidNavigate, events, and settings are classified as sandbox-safe in sandbox-api-surface.ts"
    - "SandboxedExtensionAPI proxies onDidNavigate, events, and settings to the host API"
  artifacts:
    - path: "src/extensions/conventional-commits/index.ts"
      provides: "api.onDispose callback that resets CC store"
      contains: "useConventionalStore"
    - path: "src/extensions/sandbox/sandbox-api-surface.ts"
      provides: "3 new sandbox-safe methods in SANDBOX_SAFE_METHODS"
      contains: "onDidNavigate"
    - path: "src/extensions/sandbox/SandboxedExtensionAPI.ts"
      provides: "Proxy methods for onDidNavigate, events, settings"
      contains: "onDidNavigate"
  key_links:
    - from: "src/extensions/conventional-commits/index.ts"
      to: "src/stores/conventional.ts"
      via: "useConventionalStore.getState().reset() in onDispose"
      pattern: "useConventionalStore\\.getState\\(\\)\\.reset\\(\\)"
    - from: "src/extensions/sandbox/SandboxedExtensionAPI.ts"
      to: "src/extensions/ExtensionAPI.ts"
      via: "this.hostApi.onDidNavigate/events/settings delegation"
      pattern: "this\\.hostApi\\."
---

<objective>
Wire CC store reset on extension disable (INFRA-06) and expand the sandbox API surface with 3 new methods (INFRA-07).

Purpose: INFRA-06 prevents ghost state in the conventional commits form when the extension is toggled off and on. INFRA-07 exposes `onDidNavigate`, `events`, and `settings` as sandbox-safe methods so sandboxed extensions can access navigation events, pub/sub, and key-value settings.

Output: CC extension calls `store.reset()` via `api.onDispose()`, sandbox-api-surface.ts includes 3 new methods, SandboxedExtensionAPI proxies them.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/extensions/conventional-commits/index.ts
@src/extensions/sandbox/sandbox-api-surface.ts
@src/extensions/sandbox/SandboxedExtensionAPI.ts
@src/extensions/ExtensionAPI.ts
@src/stores/conventional.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CC store reset on extension disable</name>
  <files>src/extensions/conventional-commits/index.ts</files>
  <action>
Add a `useConventionalStore.getState().reset()` call via `api.onDispose()` in the CC extension's `onActivate` function.

**Add import at top of file:**
```typescript
import { useConventionalStore } from "../../stores/conventional";
```

**At the end of `onActivate`, before the closing brace, add:**
```typescript
  // Reset CC store when extension is disabled -- prevents ghost state on re-enable
  api.onDispose(() => {
    useConventionalStore.getState().reset();
  });
```

**Why `api.onDispose()` instead of `onDeactivate`:**
- `onDispose` runs during `api.cleanup()` which executes AFTER `onDeactivate`
- `api.cleanup()` is the authoritative cleanup path that handles all registry unregistrations
- Using `onDispose` keeps the reset in the same lifecycle phase as other cleanup operations
- The existing `onDeactivate(): void` remains as-is (no-op comment is still valid for blade/command unregistrations which are handled by `api.cleanup()`)

**What `reset()` clears (verified from `src/stores/conventional.ts` line 224):**
- `commitType`, `scope`, `description`, `body` -- form fields
- `isBreaking`, `breakingDescription` -- breaking change state
- `isAmend`, `activeTemplate` -- mode state
- `typeSuggestion`, `inferredScope` -- inference state
- `validation`, `isValidating` -- validation state

Note: `scopeFrequencies` and `pushAfterCommit` are NOT reset by the current `reset()` method. This is acceptable for Phase 43 because:
- `scopeFrequencies` is fetched data that will be re-fetched on next use
- `pushAfterCommit` is a user workflow preference that can be considered a session setting
If ghost data is observed on these fields, a follow-up task can expand `reset()` to include them.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- zero new type errors.
Run `npx vitest run --reporter=verbose 2>&1` -- all existing tests pass.
Verify that `useConventionalStore` is imported in the CC extension index.ts.
Verify that `api.onDispose` is called with a function that calls `.reset()`.
  </verify>
  <done>
CC extension registers a dispose callback that resets `useConventionalStore` to initial state. Disabling CC and re-enabling it shows a clean empty form.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 3 new sandbox-safe methods to sandbox API surface</name>
  <files>src/extensions/sandbox/sandbox-api-surface.ts, src/extensions/sandbox/SandboxedExtensionAPI.ts</files>
  <action>
**Part A: Update `src/extensions/sandbox/sandbox-api-surface.ts`**

Add `onDidNavigate`, `events`, and `settings` to the `SANDBOX_SAFE_METHODS` array:

```typescript
export const SANDBOX_SAFE_METHODS = [
  "onDidGit",
  "onWillGit",
  "onDispose",
  "onDidNavigate",
  "events",
  "settings",
] as const;
```

**Rationale for sandbox-safe classification:**
- `onDidNavigate`: Handler receives serializable `BladeNavigationEvent` (blade type string, props object, stack depth number). No DOM or React access needed.
- `events`: Pub/sub with `unknown` payloads that must be serializable for Worker boundary. `emit(event, data)` and `on(event, handler)` both deal with serializable data.
- `settings`: `get/set/remove/getAll/clear` methods all return `Promise<T>` with serializable values. Settings are stored via `tauri-plugin-store`.

No changes needed to `REQUIRES_TRUST_METHODS` -- the 3 new methods are sandbox-safe, not requires-trust.

**Part B: Update `src/extensions/sandbox/SandboxedExtensionAPI.ts`**

Add proxy methods that delegate to the host API. These must be added AFTER the existing `onDispose` method and BEFORE the `trustError` private method.

**Add imports:**
First check what types are needed from ExtensionAPI. The `onDidNavigate` handler type, `events` return type, and `settings` return type. These should be imported from ExtensionAPI or their respective modules.

Add to imports section:
```typescript
import type { BladeNavigationEvent } from "../../machines/navigation/types";
```

**Add the 3 proxy methods inside the class:**

```typescript
  onDidNavigate(handler: (event: BladeNavigationEvent) => void): () => void {
    return this.hostApi.onDidNavigate(handler);
  }

  get events() {
    return this.hostApi.events;
  }

  get settings() {
    return this.hostApi.settings;
  }
```

**Note about `events` and `settings`:** These are getter properties on ExtensionAPI that return objects with methods (`emit`, `on` for events; `get`, `set`, `remove`, `getAll`, `clear` for settings). The proxy simply exposes the same objects. This works because the objects returned by the host API use serializable parameters.

**Verify compile-time exhaustiveness:** The existing `_AssertTrustCovered` type at the bottom of the file checks that all `REQUIRES_TRUST_METHODS` have corresponding declarations. Since we're only adding to `SANDBOX_SAFE_METHODS`, this type doesn't need updating. However, verify it still compiles cleanly.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- zero new type errors.
Run `npx vitest run --reporter=verbose 2>&1` -- all existing tests pass.
Verify that `SANDBOX_SAFE_METHODS` array includes exactly 6 entries: `onDidGit`, `onWillGit`, `onDispose`, `onDidNavigate`, `events`, `settings`.
Verify that `SandboxedExtensionAPI` has `onDidNavigate`, `events`, and `settings` proxy methods/properties.
Verify that the `_AssertTrustCovered` compile-time check still passes (no change needed to REQUIRES_TRUST_METHODS).
  </verify>
  <done>
`sandbox-api-surface.ts` classifies `onDidNavigate`, `events`, and `settings` as sandbox-safe. `SandboxedExtensionAPI` proxies all 3 to the host API. The compile-time exhaustiveness check passes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` passes with zero new errors
2. `npx vitest run` -- all existing tests pass
3. CC extension index.ts contains `api.onDispose(() => useConventionalStore.getState().reset())`
4. `SANDBOX_SAFE_METHODS` has 6 entries (was 3)
5. `SandboxedExtensionAPI` has `onDidNavigate`, `events`, and `settings` proxy members
</verification>

<success_criteria>
- CC store resets when extension is disabled (no ghost form data on re-enable)
- `SANDBOX_SAFE_METHODS` includes `onDidNavigate`, `events`, `settings`
- `SandboxedExtensionAPI` proxies all 3 new methods to host API
- Compile-time exhaustiveness check passes
- All type-checks and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/43-infrastructure-prep/43-03-SUMMARY.md`
</output>
