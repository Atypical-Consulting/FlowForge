---
phase: 12-workflows
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/git/commit.rs
  - src-tauri/src/lib.rs
  - src/components/commit/CommitForm.tsx
  - src/components/commit/ConventionalCommitForm.tsx
  - src/hooks/useKeyboardShortcuts.ts
autonomous: true

must_haves:
  truths:
    - "get_last_commit_message command returns subject and body separately"
    - "Checking amend checkbox loads previous commit message"
    - "Confirmation dialog appears before executing amend"
    - "If user has typed text, prompt asks whether to replace with previous message"
  artifacts:
    - path: "src-tauri/src/git/commit.rs"
      provides: "get_last_commit_message command"
      exports: ["get_last_commit_message", "LastCommitMessage"]
    - path: "src/components/commit/CommitForm.tsx"
      provides: "Amend pre-fill and confirmation"
      contains: "amend.*confirm"
  key_links:
    - from: "CommitForm.tsx"
      to: "commands.getLastCommitMessage"
      via: "useQuery on amend toggle"
      pattern: "getLastCommitMessage"
    - from: "useKeyboardShortcuts.ts"
      to: "amend-toggle event"
      via: "custom event dispatch"
      pattern: "amend-toggle"
---

<objective>
Implement amend commit with message pre-fill and confirmation.

Purpose: Users can amend the last commit with the previous message pre-filled for editing.
Output: Backend command for last commit message, frontend pre-fill logic, confirmation dialog.
</objective>

<execution_context>
@C:\Users\matrayp\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\matrayp\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-workflows/12-CONTEXT.md
@.planning/phases/12-workflows/12-RESEARCH.md
@src-tauri/src/git/commit.rs
@src/components/commit/CommitForm.tsx
@src/components/commit/ConventionalCommitForm.tsx
@src/hooks/useKeyboardShortcuts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add get_last_commit_message backend command</name>
  <files>src-tauri/src/git/commit.rs, src-tauri/src/lib.rs</files>
  <action>
Add to `src-tauri/src/git/commit.rs`:

1. Define `LastCommitMessage` struct:
   ```rust
   #[derive(Debug, Clone, Serialize, Deserialize, Type)]
   #[serde(rename_all = "camelCase")]
   pub struct LastCommitMessage {
       pub subject: String,
       pub body: Option<String>,
       pub full_message: String,
   }
   ```

2. Implement `get_last_commit_message` command:
   ```rust
   #[tauri::command]
   #[specta::specta]
   pub async fn get_last_commit_message(
       state: State<'_, RepositoryState>,
   ) -> Result<LastCommitMessage, GitError> {
       // Get repo path
       // spawn_blocking
       // Get HEAD commit
       // Parse message: first line = subject, rest = body
       // Return LastCommitMessage
   }
   ```

3. Message parsing logic:
   - `full_message` = entire commit message
   - `subject` = first line (before first newline)
   - `body` = everything after first blank line (if exists), trimmed
   - Handle edge cases: no body, multiple blank lines, trailing whitespace

4. Register in lib.rs: add to generate_handler![]
  </action>
  <verify>
Run `cargo check` - compiles.
Run `npm run tauri:gen` - LastCommitMessage type in bindings.ts.
  </verify>
  <done>
get_last_commit_message returns subject and body separately, registered in bindings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement amend pre-fill and confirmation in CommitForm</name>
  <files>src/components/commit/CommitForm.tsx, src/components/commit/ConventionalCommitForm.tsx, src/hooks/useKeyboardShortcuts.ts</files>
  <action>
1. Update `src/components/commit/CommitForm.tsx`:

   a. Add query for last commit message:
      ```typescript
      const { data: lastMessage } = useQuery({
        queryKey: ["lastCommitMessage"],
        queryFn: () => commands.getLastCommitMessage(),
        enabled: amend, // Only fetch when amend is checked
      });
      ```

   b. Handle amend checkbox change:
      - When checking amend AND message is empty: auto-fill with lastMessage.fullMessage
      - When checking amend AND message has content: show confirm dialog
        "You have unsaved text. Replace with previous commit message?"
        [Keep Current] [Load Previous]
      - If "Load Previous": setMessage(lastMessage.fullMessage)

   c. Add confirmation before amend commit:
      - Before commitMutation.mutate, if amend is true:
        Show window.confirm("Amend will rewrite the last commit. This cannot be undone. Continue?")
      - Only proceed if confirmed

   d. After successful amend: setAmend(false), clear message

2. Update `src/components/commit/ConventionalCommitForm.tsx`:
   - Add amend checkbox to the form (similar to CommitForm)
   - When amend checked: fetch last message, parse into conventional format if possible
   - Pre-fill type, scope, subject, body from parsed message
   - Add same confirmation dialog before amend

3. Update `src/hooks/useKeyboardShortcuts.ts`:
   - Add shortcut for amend toggle: `mod+shift+m` (M for aMend - avoiding conflict with Shift+A for Stage All)
   - Dispatch custom event: `document.dispatchEvent(new CustomEvent("toggle-amend"))`
   - CommitForm listens for this event and toggles amend state
  </action>
  <verify>
Run `npm run typecheck` - no errors.
Run `npm run dev`:
- Check amend box with empty message -> previous message loads
- Check amend box with text -> confirmation appears
- Ctrl+Shift+M toggles amend checkbox
- Clicking "Amend Commit" shows confirmation dialog
  </verify>
  <done>
Amend checkbox pre-fills message, asks before overwriting user text, confirms before executing amend.
  </done>
</task>

</tasks>

<verification>
- `cargo check` passes
- `npm run typecheck` passes
- Checking amend with empty message loads previous commit message
- Checking amend with existing text prompts user
- Amend commit shows confirmation dialog
- Ctrl+Shift+M toggles amend checkbox
</verification>

<success_criteria>
- get_last_commit_message returns subject and body separately
- Checking amend checkbox loads previous commit message
- Confirmation dialog appears before executing amend
- If user has typed text, prompt asks whether to replace
- Keyboard shortcut Ctrl+Shift+M toggles amend (not Shift+A which is Stage All)
- Works in both simple and conventional commit modes
</success_criteria>

<output>
After completion, create `.planning/phases/12-workflows/12-05-SUMMARY.md`
</output>
