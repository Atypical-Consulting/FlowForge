---
phase: 41-sandbox-polish
plan: 04
type: execute
wave: 2
depends_on: ["41-02"]
files_modified:
  - src/extensions/__tests__/github.test.ts
  - src/extensions/__tests__/ExtensionHost.test.ts
autonomous: true

must_haves:
  truths:
    - "GitHub extension lifecycle tests cover activate, deactivate, and registry cleanup"
    - "ExtensionHost lifecycle tests cover registerBuiltIn, activate, deactivate, and error recovery"
    - "All 4 built-in extensions have lifecycle test coverage"
    - "Trust level is verified in extension registration tests"
  artifacts:
    - path: "src/extensions/__tests__/github.test.ts"
      provides: "GitHub extension lifecycle tests"
    - path: "src/extensions/__tests__/ExtensionHost.test.ts"
      provides: "ExtensionHost store lifecycle tests"
  key_links:
    - from: "src/extensions/__tests__/github.test.ts"
      to: "src/extensions/github/index.ts"
      via: "imports onActivate and onDeactivate"
      pattern: "onActivate|onDeactivate"
    - from: "src/extensions/__tests__/ExtensionHost.test.ts"
      to: "src/extensions/ExtensionHost.ts"
      via: "imports useExtensionHost"
      pattern: "useExtensionHost"
---

<objective>
Add extension lifecycle tests for the GitHub extension (the only built-in without tests) and for ExtensionHost itself, covering activate, deactivate, registry cleanup, trust level, and error recovery.

Purpose: The success criteria requires "extension lifecycle tests cover activate, deactivate, and registry cleanup for all new registries." The GitHub extension is the most complex (7 blades, 5 commands, 4 toolbar items, store subscriptions, polling) but has zero tests. ExtensionHost has zero direct tests despite managing the entire extension lifecycle.

Output: Two new test files with comprehensive lifecycle coverage, bringing extension test count from 33 to ~50+.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/41-sandbox-polish/41-02-SUMMARY.md
@src/extensions/__tests__/gitflow.test.ts
@src/extensions/github/index.ts
@src/extensions/ExtensionHost.ts
@src/extensions/ExtensionAPI.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub extension lifecycle tests</name>
  <files>
    src/extensions/__tests__/github.test.ts
  </files>
  <action>
Create `src/extensions/__tests__/github.test.ts` following the established pattern from `gitflow.test.ts` and `conventional-commits.test.ts`.

**Mock setup required:**

1. Mock all 8 async component imports (GitHubAuthBlade, GitHubAccountBlade, GitHubStatusButton, PullRequestListBlade, PullRequestDetailBlade, IssueListBlade, IssueDetailBlade, CreatePullRequestBlade):
   ```typescript
   vi.mock("../../extensions/github/blades/GitHubAuthBlade", () => ({
     GitHubAuthBlade: () => null,
   }));
   // ... same pattern for all 8 component imports
   ```

2. Mock the GitHub store:
   ```typescript
   vi.mock("../../extensions/github/githubStore", () => ({
     useGitHubStore: {
       getState: () => ({
         isAuthenticated: false,
         detectedRemotes: [],
         checkAuth: vi.fn(),
         resetRemotes: vi.fn(),
         detectRemotes: vi.fn(),
         signOut: vi.fn(),
         isAuthenticating: false,
         cancelAuth: vi.fn(),
       }),
       subscribe: vi.fn(() => vi.fn()),
     },
     getSelectedRemote: vi.fn(),
     cancelGitHubPolling: vi.fn(),
   }));
   ```

3. Mock the repository store (IMPORTANT: use the NEW import path after shim removal):
   ```typescript
   vi.mock("../../stores/domain/git-ops", () => ({
     useGitOpsStore: {
       getState: () => ({
         repoStatus: null,
       }),
       subscribe: vi.fn(() => vi.fn()),
     },
   }));
   ```
   Note: The GitHub extension's import of `useRepositoryStore` was updated in Plan 02 to `useGitOpsStore`. The mock path must match the actual import path used in the source after shim removal.

4. Mock other dependencies:
   ```typescript
   vi.mock("../../lib/bladeOpener", () => ({
     openBlade: vi.fn(),
   }));
   vi.mock("../../lib/queryClient", () => ({
     queryClient: { removeQueries: vi.fn() },
   }));
   vi.mock("../../lib/toolbarRegistry", () => {
     const actions = new Map();
     return {
       useToolbarRegistry: {
         getState: () => ({
           actions,
           register: vi.fn((action: any) => { actions.set(action.id, action); }),
           unregisterBySource: vi.fn((source: string) => {
             for (const [id, a] of actions) {
               if ((a as any).source === source) actions.delete(id);
             }
           }),
           refreshVisibility: vi.fn(),
         }),
         setState: vi.fn(),
       },
     };
   });
   ```

**Test cases (minimum 8 tests):**

1. `"registers 7 blade types on activation"` -- call `onActivate(api)`, verify all 7 blades registered via `getBladeRegistration()`: sign-in, account, pull-requests, pull-request, issues, issue, create-pr (all with `ext:github:` prefix).

2. `"blade types use ext:github: namespace"` -- verify each registered blade type starts with `ext:github:`.

3. `"registers 5 commands on activation"` -- verify 5 commands registered via commandRegistry: sign-in, sign-out, open-pull-requests, open-issues, create-pull-request.

4. `"registers 4 toolbar actions on activation"` -- verify 4 toolbar actions registered: github-status, open-pull-requests, open-issues, create-pr.

5. `"cleanup removes all blade registrations"` -- after `onActivate(api)`, call `api.cleanup()`, verify all 7 blades are unregistered.

6. `"cleanup removes all command registrations"` -- verify all 5 commands removed after cleanup.

7. `"cleanup removes all toolbar registrations"` -- verify toolbar `unregisterBySource` called with `ext:github`.

8. `"onDeactivate cancels polling and cleans up"` -- call `onDeactivate()`, verify `cancelGitHubPolling` was called, and `queryClient.removeQueries` was called with the github key.

**Pattern reference:** Follow `src/extensions/__tests__/gitflow.test.ts` for the exact test structure (imports, beforeEach setup, afterEach cleanup).
  </action>
  <verify>
    - `npx vitest run src/extensions/__tests__/github.test.ts` passes all 8+ tests
    - Tests cover: blade registration (7), command registration (5), toolbar registration (4), cleanup, deactivate
  </verify>
  <done>
    GitHub extension has comprehensive lifecycle tests: activation registers 7 blades + 5 commands + 4 toolbar actions, cleanup removes all registrations, deactivate cancels polling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ExtensionHost lifecycle tests with trust level verification</name>
  <files>
    src/extensions/__tests__/ExtensionHost.test.ts
  </files>
  <action>
Create `src/extensions/__tests__/ExtensionHost.test.ts` to test the ExtensionHost Zustand store lifecycle.

**Mock setup:**

1. Mock Tauri dependencies:
   ```typescript
   vi.mock("@tauri-apps/api/core", () => ({
     convertFileSrc: vi.fn((path: string) => `asset://${path}`),
   }));
   vi.mock("../../bindings", () => ({
     commands: {
       discoverExtensions: vi.fn(),
     },
   }));
   vi.mock("../../lib/store", () => ({
     getStore: vi.fn(() => ({
       get: vi.fn(() => []),
       set: vi.fn(),
       save: vi.fn(),
     })),
   }));
   vi.mock("../../stores/toast", () => ({
     toast: { error: vi.fn(), success: vi.fn(), info: vi.fn() },
   }));
   ```

2. Mock all registry modules (bladeRegistry, commandRegistry, toolbarRegistry, contextMenuRegistry, sidebarPanelRegistry, statusBarRegistry, gitHookBus) -- use the same mock pattern from ExtensionAPI.test.ts.

**Test cases (minimum 8 tests):**

1. `"registerBuiltIn creates ExtensionInfo with active status"` -- register a simple built-in extension, verify status is "active" in the extensions Map.

2. `"registerBuiltIn sets trustLevel to built-in"` -- register a built-in extension, verify `ext.trustLevel === "built-in"`.

3. `"registerBuiltIn sets builtIn flag to true"` -- verify `ext.builtIn === true`.

4. `"deactivateExtension transitions to disabled status"` -- register, then deactivate. Verify status changes from "active" to "disabled".

5. `"deactivateExtension calls api.cleanup()"` -- register an extension that contributes a toolbar action. Deactivate and verify the toolbar registration is cleaned up.

6. `"deactivateExtension calls onDeactivate callback"` -- register with a `deactivate` callback. Deactivate and verify the callback was called.

7. `"re-activation after deactivation works"` -- register, deactivate, then activate again via `activateExtension(id)`. Verify status returns to "active".

8. `"activation failure sets error status and cleans up"` -- register a built-in extension whose `activate` throws. Verify status is "error", error message is set, and partial registrations are cleaned up.

**Structure:**

```typescript
import { vi, describe, it, expect, beforeEach } from "vitest";
import { useExtensionHost } from "../ExtensionHost";
import type { BuiltInExtensionConfig } from "../extensionTypes";

// ... mocks ...

describe("ExtensionHost", () => {
  beforeEach(() => {
    // Reset the store to initial state
    useExtensionHost.setState({
      extensions: new Map(),
      isDiscovering: false,
    });
  });

  // ... tests ...
});
```

**Important:** The `registerBuiltIn` method is async. Await it in each test. The `deactivateExtension` and `activateExtension` methods are also async.

For the trust level test, after Plan 01 is complete, `registerBuiltIn` should set `trustLevel: "built-in"` on the ExtensionInfo. If it does not (because Plan 01 is not merged yet), add a note that this test will pass after 41-01.
  </action>
  <verify>
    - `npx vitest run src/extensions/__tests__/ExtensionHost.test.ts` passes all 8+ tests
    - Tests cover: registerBuiltIn, trustLevel, deactivation, cleanup, re-activation, error recovery
    - `npx vitest run` -- all tests pass (new + existing)
  </verify>
  <done>
    ExtensionHost has lifecycle tests covering registration, trust level, deactivation, cleanup, re-activation, and error recovery. All 4 built-in extensions now have lifecycle test coverage (content-viewers, conventional-commits, gitflow, github).
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run src/extensions/__tests__/` -- all extension tests pass
2. `npx vitest run` -- full test suite passes
3. Extension test count: 33 (existing) + ~16 (new) = ~49+ total extension tests
4. All 4 built-in extensions have lifecycle test files
5. ExtensionHost has direct lifecycle tests
6. Trust level is verified in tests
</verification>

<success_criteria>
- GitHub extension has lifecycle tests covering activate (7 blades, 5 commands, 4 toolbar), cleanup, and deactivate
- ExtensionHost has lifecycle tests covering registerBuiltIn, trust level, deactivation, cleanup, re-activation, error recovery
- All 4 built-in extensions have lifecycle test coverage
- Total extension test count increases from 33 to 49+
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/41-sandbox-polish/41-04-SUMMARY.md`
</output>
