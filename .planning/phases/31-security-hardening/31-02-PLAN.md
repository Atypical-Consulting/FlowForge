---
phase: 31-security-hardening
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src-tauri/tauri.conf.json
  - src-tauri/capabilities/default.json
  - src-tauri/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "The app enforces a strict Content-Security-Policy that blocks inline scripts and external script sources"
    - "The asset protocol is disabled since no frontend code uses it"
    - "Tauri capabilities contain only the minimum permissions needed with no overly broad grants"
    - "Development mode preserves hot module reload functionality via devCsp"
  artifacts:
    - path: "src-tauri/tauri.conf.json"
      provides: "Strict CSP and devCsp configuration, disabled asset protocol"
      contains: "script-src 'self'"
    - path: "src-tauri/capabilities/default.json"
      provides: "Minimal capability permissions without core:default"
      contains: "core:app:default"
    - path: "src-tauri/Cargo.toml"
      provides: "Tauri without protocol-asset feature"
  key_links:
    - from: "src-tauri/tauri.conf.json"
      to: "CSP enforcement"
      via: "Tauri security.csp config"
      pattern: "\"csp\""
    - from: "src-tauri/capabilities/default.json"
      to: "Permission grants"
      via: "Tauri capability system"
      pattern: "core:app:default"
---

<objective>
Apply strict Content-Security-Policy, disable the unused asset protocol, and audit Tauri capabilities to enforce least-privilege permissions.

Purpose: With external dependencies eliminated in Plan 01, the CSP can now be maximally strict — no external domains needed in any directive. This is the prerequisite security boundary for all v1.5 extension and GitHub integration work.

Output: Production CSP blocks all external script/connection sources, asset protocol disabled, capabilities narrowed to actual usage.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-security-hardening/31-01-SUMMARY.md
@src-tauri/tauri.conf.json
@src-tauri/capabilities/default.json
@src-tauri/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure strict CSP and disable asset protocol in tauri.conf.json</name>
  <files>
    src-tauri/tauri.conf.json
  </files>
  <action>
    **Goal:** Replace `"csp": null` with a strict Content-Security-Policy and set `"devCsp"` for development. Disable the asset protocol entirely.

    **Replace the `security` block in `src-tauri/tauri.conf.json`:**

    ```json
    "security": {
      "csp": {
        "default-src": "'self' customprotocol: asset:",
        "script-src": "'self'",
        "style-src": "'self' 'unsafe-inline'",
        "img-src": "'self' asset: http://asset.localhost blob: data: https:",
        "font-src": "'self' data:",
        "connect-src": "ipc: http://ipc.localhost",
        "worker-src": "'self' blob:",
        "object-src": "'none'",
        "base-uri": "'self'",
        "form-action": "'self'",
        "frame-ancestors": "'none'"
      },
      "devCsp": {
        "default-src": "'self' customprotocol: asset:",
        "script-src": "'self' 'unsafe-eval'",
        "style-src": "'self' 'unsafe-inline'",
        "img-src": "'self' asset: http://asset.localhost blob: data: https:",
        "font-src": "'self' data:",
        "connect-src": "ipc: http://ipc.localhost http://localhost:* ws://localhost:*",
        "worker-src": "'self' blob:",
        "object-src": "'none'",
        "base-uri": "'self'",
        "form-action": "'self'",
        "frame-ancestors": "'none'"
      },
      "assetProtocol": {
        "enable": false,
        "scope": []
      }
    }
    ```

    **CSP directive rationale:**

    | Directive | Value | Why |
    |-----------|-------|-----|
    | `default-src` | `'self' customprotocol: asset:` | Baseline fallback; Tauri custom protocols |
    | `script-src` | `'self'` | Only local scripts; Tauri auto-hashes the inline FOUC script in index.html at compile time |
    | `style-src` | `'self' 'unsafe-inline'` | Tailwind + framer-motion inline styles (23 occurrences in 13 files); safe — styles cannot execute code |
    | `img-src` | `'self' asset: http://asset.localhost blob: data: https:` | Local images + MarkdownImage external images + data URIs for icons |
    | `font-src` | `'self' data:` | Local fonts + data URI fonts |
    | `connect-src` | `ipc: http://ipc.localhost` | Only Tauri IPC — all external API calls go through Rust backend |
    | `worker-src` | `'self' blob:` | Monaco editor web workers (loaded via blob: URLs) |
    | `object-src` | `'none'` | No plugins/embeds ever needed |
    | `base-uri` | `'self'` | Prevent base tag injection |
    | `form-action` | `'self'` | No external form submissions |
    | `frame-ancestors` | `'none'` | Prevent framing (clickjacking) |

    **devCsp differences from production:**
    - `script-src` adds `'unsafe-eval'` — needed for Vite HMR
    - `connect-src` adds `http://localhost:* ws://localhost:*` — needed for Vite dev server and WebSocket HMR

    **Asset protocol:** Disabled entirely. All three researchers confirmed zero usage of `convertFileSrc()` or `asset://` protocol in the frontend. The `"scope": []` provides defense-in-depth.

    **Inline script in index.html:** The FOUC prevention script on lines 9-29 of index.html will be automatically handled by Tauri. Tauri v2 computes a SHA hash of inline scripts at compile time and adds it to the CSP automatically. No manual nonce or hash management needed.
  </action>
  <verify>
    1. Run `cd src-tauri && cargo build` — Rust compiles (config is valid JSON)
    2. Run `npm run dev` and open the app — app loads normally, Vite HMR works, Monaco loads
    3. Open browser dev tools Network tab — verify no blocked requests
    4. Check that the CSP header is present in the document response
  </verify>
  <done>
    Production CSP enforces: no external scripts (`script-src 'self'`), no external connections (`connect-src ipc: http://ipc.localhost`), no plugins (`object-src 'none'`), no framing (`frame-ancestors 'none'`). Development CSP preserves Vite HMR. Asset protocol is disabled. The inline FOUC script in index.html is auto-hashed by Tauri.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit and narrow Tauri capabilities to minimum required permissions</name>
  <files>
    src-tauri/capabilities/default.json
    src-tauri/Cargo.toml
  </files>
  <action>
    **Goal:** Replace the overly broad `core:default` with specific module permissions and remove the unused `protocol-asset` Cargo feature.

    **Step 1 - Replace `core:default` in `src-tauri/capabilities/default.json`:**

    Current state:
    ```json
    {
      "permissions": [
        "core:default",          // Too broad: includes core:tray, core:menu, core:image (unused)
        "opener:default",
        "dialog:default",
        "store:default",
        "core:window:default",   // Duplicate: already included in core:default
        "window-state:default"
      ]
    }
    ```

    Replace with:
    ```json
    {
      "$schema": "../gen/schemas/desktop-schema.json",
      "identifier": "default",
      "description": "Minimum capabilities for FlowForge — no tray, menu, or image permissions",
      "windows": ["main"],
      "permissions": [
        "core:app:default",
        "core:event:default",
        "core:path:default",
        "core:resources:default",
        "core:webview:default",
        "core:window:default",
        "opener:default",
        "dialog:default",
        "store:default",
        "window-state:default"
      ]
    }
    ```

    **What was removed and why:**

    | Permission | Reason for Removal |
    |------------|--------------------|
    | `core:default` (umbrella) | Replaced by specific modules below |
    | `core:tray:default` | App has no system tray icon — zero tray usage in codebase |
    | `core:menu:default` | App uses no native menus — all UI is in webview |
    | `core:image:default` | No native image processing — all images handled in frontend |
    | Duplicate `core:window:default` | Was listed twice (once in `core:default`, once explicitly) |

    **What was kept and why:**

    | Permission | Reason |
    |------------|--------|
    | `core:app:default` | App version, name, exit functionality |
    | `core:event:default` | Tauri event system (used by stores, navigation) |
    | `core:path:default` | OS path resolution (used by file operations) |
    | `core:resources:default` | Access bundled resources (gitignore templates, etc.) |
    | `core:webview:default` | Webview management (required) |
    | `core:window:default` | Window operations (resize, minimize, etc.) |
    | `opener:default` | Open URLs in system browser (NuGet links, GitHub links) |
    | `dialog:default` | File/folder picker dialogs (used in Init Repo) |
    | `store:default` | Persistent key-value store (settings, preferences) |
    | `window-state:default` | Remember window position/size across sessions |

    **Step 2 - Remove `protocol-asset` feature from `src-tauri/Cargo.toml`:**

    Change the tauri dependency from:
    ```toml
    tauri = { version = "2", features = ["protocol-asset"] }
    ```
    to:
    ```toml
    tauri = { version = "2", features = [] }
    ```

    This removes the compiled-in asset protocol handler since we disabled it in tauri.conf.json. Defense-in-depth: even if someone re-enables the config, the protocol handler won't be compiled in.
  </action>
  <verify>
    1. Run `cd src-tauri && cargo build` — compiles successfully without protocol-asset feature
    2. Run `npm run dev` and open the app — all features work:
       - File picker in Init Repo blade (dialog:default)
       - Settings persist across restart (store:default)
       - Window remembers position (window-state:default)
       - External links open in browser (opener:default)
    3. Run `grep "core:default" src-tauri/capabilities/default.json` — returns zero matches
    4. Run `grep "protocol-asset" src-tauri/Cargo.toml` — returns zero matches
  </verify>
  <done>
    Capabilities contain exactly the minimum permissions needed: 5 specific core modules + 4 plugin permissions. No unused tray/menu/image permissions. No duplicate entries. Asset protocol feature removed from Cargo.toml. The capability file is documented with rationale in the description field.
  </done>
</task>

</tasks>

<verification>
1. `cd src-tauri && cargo build` — Rust compiles with new CSP config and without protocol-asset
2. `npm run dev` — app runs in dev mode with devCsp, HMR works
3. `npm run build && cd src-tauri && cargo build --release` — production build succeeds with strict CSP
4. No `core:default` in capabilities — only specific modules
5. No `protocol-asset` in Cargo.toml
6. CSP blocks external script/connection sources in production
</verification>

<success_criteria>
- Strict CSP is configured: `script-src 'self'`, `connect-src ipc: http://ipc.localhost`, `object-src 'none'`
- devCsp preserves Vite HMR with `'unsafe-eval'` and `ws://localhost:*`
- Asset protocol disabled in config and removed from Cargo features
- Capabilities narrowed from `core:default` to 5 specific core modules
- No unused permissions (tray, menu, image) remain
- App functions correctly in both dev and production modes
</success_criteria>

<output>
After completion, create `.planning/phases/31-security-hardening/31-02-SUMMARY.md`
</output>
