---
phase: 03-core-git-branches
plan: 05
type: execute
wave: 3
depends_on: ["03-01", "03-04"]
files_modified:
  - src/stores/branches.ts
  - src/components/branches/BranchList.tsx
  - src/components/branches/BranchItem.tsx
  - src/components/branches/CreateBranchDialog.tsx
  - src/components/branches/MergeDialog.tsx
  - src/components/Header.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of all local branches with current branch highlighted"
    - "User can create a new branch with optional immediate checkout"
    - "User can switch to a different branch via UI"
    - "User can delete a branch with merge safety warning"
    - "User can initiate merge from branch list and see result/conflicts"
  artifacts:
    - path: "src/stores/branches.ts"
      provides: "Branch state management"
      exports: ["useBranchStore"]
    - path: "src/components/branches/BranchList.tsx"
      provides: "Branch list component"
    - path: "src/components/branches/CreateBranchDialog.tsx"
      provides: "Create branch modal"
    - path: "src/components/branches/MergeDialog.tsx"
      provides: "Merge confirmation and progress dialog"
  key_links:
    - from: "src/components/branches/BranchList.tsx"
      to: "commands.listBranches"
      via: "store action"
      pattern: "commands\\.listBranches"
    - from: "src/components/Header.tsx"
      to: "BranchList"
      via: "dropdown integration"
      pattern: "BranchList|BranchSelector"
---

<objective>
Create the frontend branch management UI including zustand store, branch list with CRUD operations, and integration with the header.

Purpose: Enable users to visually manage branches, switch between them, create new ones, and perform merges.

Output: Branch store and 4 React components for complete branch management.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-git-branches/03-RESEARCH.md
@.planning/phases/03-core-git-branches/03-01-SUMMARY.md
@.planning/phases/03-core-git-branches/03-04-SUMMARY.md

# Existing patterns to follow
@src/stores/staging.ts
@src/stores/repository.ts
@src/components/Header.tsx
@src/bindings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create branches.ts zustand store</name>
  <files>src/stores/branches.ts</files>
  <action>
Create `src/stores/branches.ts` following the pattern from staging.ts and repository.ts:

```typescript
import { create } from "zustand";
import type { BranchInfo, MergeResult } from "../bindings";
import { commands } from "../bindings";

interface BranchState {
  // State
  branches: BranchInfo[];
  isLoading: boolean;
  error: string | null;
  mergeInProgress: boolean;
  lastMergeResult: MergeResult | null;

  // Actions
  loadBranches: () => Promise<void>;
  createBranch: (name: string, checkout: boolean) => Promise<BranchInfo | null>;
  checkoutBranch: (name: string) => Promise<boolean>;
  deleteBranch: (name: string, force: boolean) => Promise<boolean>;
  mergeBranch: (sourceBranch: string) => Promise<MergeResult | null>;
  abortMerge: () => Promise<boolean>;
  clearError: () => void;
}

export const useBranchStore = create<BranchState>((set, get) => ({
  branches: [],
  isLoading: false,
  error: null,
  mergeInProgress: false,
  lastMergeResult: null,

  loadBranches: async () => {
    set({ isLoading: true, error: null });
    const result = await commands.listBranches();
    if (result.status === "ok") {
      set({ branches: result.data, isLoading: false });
    } else {
      const errorMsg = "message" in result.error ? result.error.message : result.error.type;
      set({ error: errorMsg, isLoading: false });
    }
  },

  createBranch: async (name, checkout) => {
    set({ isLoading: true, error: null });
    const result = await commands.createBranch(name, checkout);
    if (result.status === "ok") {
      await get().loadBranches();
      return result.data;
    } else {
      const errorMsg = "message" in result.error ? result.error.message : result.error.type;
      set({ error: errorMsg, isLoading: false });
      return null;
    }
  },

  checkoutBranch: async (name) => {
    set({ isLoading: true, error: null });
    const result = await commands.checkoutBranch(name);
    if (result.status === "ok") {
      await get().loadBranches();
      return true;
    } else {
      const errorMsg = "message" in result.error ? result.error.message : result.error.type;
      set({ error: errorMsg, isLoading: false });
      return false;
    }
  },

  deleteBranch: async (name, force) => {
    set({ isLoading: true, error: null });
    const result = await commands.deleteBranch(name, force);
    if (result.status === "ok") {
      await get().loadBranches();
      return true;
    } else {
      const errorMsg = "message" in result.error ? result.error.message : result.error.type;
      set({ error: errorMsg, isLoading: false });
      return false;
    }
  },

  mergeBranch: async (sourceBranch) => {
    set({ isLoading: true, error: null, mergeInProgress: true });
    const result = await commands.mergeBranch(sourceBranch);
    if (result.status === "ok") {
      set({ lastMergeResult: result.data, mergeInProgress: false, isLoading: false });
      await get().loadBranches();
      return result.data;
    } else {
      const errorMsg = "message" in result.error ? result.error.message : result.error.type;
      set({ error: errorMsg, mergeInProgress: false, isLoading: false });
      return null;
    }
  },

  abortMerge: async () => {
    const result = await commands.abortMerge();
    if (result.status === "ok") {
      set({ mergeInProgress: false, lastMergeResult: null });
      await get().loadBranches();
      return true;
    }
    return false;
  },

  clearError: () => set({ error: null }),
}));
```
  </action>
  <verify>
TypeScript compiles without errors: `npm run typecheck` or `tsc --noEmit`
  </verify>
  <done>
useBranchStore provides state management for branches with load, create, checkout, delete, merge, and abort operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BranchList and BranchItem components</name>
  <files>src/components/branches/BranchList.tsx, src/components/branches/BranchItem.tsx</files>
  <action>
Create branch list components following existing patterns from staging components:

**src/components/branches/BranchItem.tsx**:
```tsx
import { GitBranch, Check, Trash2, GitMerge } from "lucide-react";
import type { BranchInfo } from "../../bindings";
import { cn } from "../../lib/utils";

interface BranchItemProps {
  branch: BranchInfo;
  onCheckout: () => void;
  onDelete: () => void;
  onMerge: () => void;
  disabled?: boolean;
}

export function BranchItem({ branch, onCheckout, onDelete, onMerge, disabled }: BranchItemProps) {
  return (
    <div
      className={cn(
        "flex items-center justify-between px-3 py-2 rounded-md",
        branch.isHead ? "bg-blue-900/30 border border-blue-700" : "hover:bg-gray-800",
        disabled && "opacity-50"
      )}
    >
      <div className="flex items-center gap-2 min-w-0 flex-1">
        <GitBranch className="w-4 h-4 shrink-0 text-gray-400" />
        <span className="truncate font-medium">{branch.name}</span>
        {branch.isHead && (
          <Check className="w-4 h-4 shrink-0 text-green-400" />
        )}
        {branch.isMerged && !branch.isHead && (
          <span className="text-xs text-gray-500 px-1.5 py-0.5 bg-gray-800 rounded">merged</span>
        )}
      </div>
      <div className="flex items-center gap-1">
        {!branch.isHead && (
          <>
            <button
              onClick={onCheckout}
              disabled={disabled}
              className="p-1.5 hover:bg-gray-700 rounded text-gray-400 hover:text-white"
              title="Switch to branch"
            >
              <Check className="w-4 h-4" />
            </button>
            <button
              onClick={onMerge}
              disabled={disabled}
              className="p-1.5 hover:bg-gray-700 rounded text-gray-400 hover:text-white"
              title="Merge into current branch"
            >
              <GitMerge className="w-4 h-4" />
            </button>
            <button
              onClick={onDelete}
              disabled={disabled}
              className="p-1.5 hover:bg-gray-700 rounded text-gray-400 hover:text-red-400"
              title="Delete branch"
            >
              <Trash2 className="w-4 h-4" />
            </button>
          </>
        )}
      </div>
    </div>
  );
}
```

**src/components/branches/BranchList.tsx**:
```tsx
import { useEffect, useState } from "react";
import { Plus, RefreshCw } from "lucide-react";
import { useBranchStore } from "../../stores/branches";
import { BranchItem } from "./BranchItem";
import { CreateBranchDialog } from "./CreateBranchDialog";
import { MergeDialog } from "./MergeDialog";
import { cn } from "../../lib/utils";

export function BranchList() {
  const { branches, isLoading, error, loadBranches, checkoutBranch, deleteBranch, mergeBranch, lastMergeResult, clearError } = useBranchStore();
  const [showCreateDialog, setShowCreateDialog] = useState(false);
  const [mergingBranch, setMergingBranch] = useState<string | null>(null);

  useEffect(() => {
    loadBranches();
  }, [loadBranches]);

  const handleDelete = async (name: string, isMerged: boolean | null) => {
    if (!isMerged) {
      const confirmed = window.confirm(
        `Branch "${name}" has unmerged commits. Force delete?`
      );
      if (!confirmed) return;
      await deleteBranch(name, true);
    } else {
      await deleteBranch(name, false);
    }
  };

  const handleMerge = (branchName: string) => {
    setMergingBranch(branchName);
  };

  const confirmMerge = async () => {
    if (mergingBranch) {
      await mergeBranch(mergingBranch);
      // Dialog will show result
    }
  };

  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center justify-between p-3 border-b border-gray-800">
        <h2 className="text-sm font-semibold text-gray-300">Branches</h2>
        <div className="flex gap-1">
          <button
            onClick={() => loadBranches()}
            disabled={isLoading}
            className="p-1.5 hover:bg-gray-800 rounded text-gray-400 hover:text-white"
          >
            <RefreshCw className={cn("w-4 h-4", isLoading && "animate-spin")} />
          </button>
          <button
            onClick={() => setShowCreateDialog(true)}
            className="p-1.5 hover:bg-gray-800 rounded text-gray-400 hover:text-white"
          >
            <Plus className="w-4 h-4" />
          </button>
        </div>
      </div>

      {error && (
        <div className="p-3 bg-red-900/30 border-b border-red-800 text-red-300 text-sm">
          {error}
          <button onClick={clearError} className="ml-2 underline">dismiss</button>
        </div>
      )}

      <div className="flex-1 overflow-y-auto p-2 space-y-1">
        {branches.map((branch) => (
          <BranchItem
            key={branch.name}
            branch={branch}
            onCheckout={() => checkoutBranch(branch.name)}
            onDelete={() => handleDelete(branch.name, branch.isMerged)}
            onMerge={() => handleMerge(branch.name)}
            disabled={isLoading}
          />
        ))}
      </div>

      {showCreateDialog && (
        <CreateBranchDialog onClose={() => setShowCreateDialog(false)} />
      )}

      {mergingBranch && (
        <MergeDialog
          sourceBranch={mergingBranch}
          result={lastMergeResult}
          onConfirm={confirmMerge}
          onClose={() => {
            setMergingBranch(null);
            clearError();
          }}
        />
      )}
    </div>
  );
}
```

Import cn from utils if needed.
  </action>
  <verify>
TypeScript compiles. Components render without errors in dev mode.
  </verify>
  <done>
BranchList displays all branches with BranchItem rows. Each item shows branch name, HEAD indicator, merged status, and action buttons for checkout/merge/delete.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CreateBranchDialog and MergeDialog components</name>
  <files>src/components/branches/CreateBranchDialog.tsx, src/components/branches/MergeDialog.tsx, src/components/Header.tsx</files>
  <action>
**src/components/branches/CreateBranchDialog.tsx**:
```tsx
import { useState } from "react";
import { X } from "lucide-react";
import { useBranchStore } from "../../stores/branches";

interface CreateBranchDialogProps {
  onClose: () => void;
}

export function CreateBranchDialog({ onClose }: CreateBranchDialogProps) {
  const { createBranch, isLoading, error } = useBranchStore();
  const [name, setName] = useState("");
  const [checkout, setCheckout] = useState(true);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!name.trim()) return;
    const result = await createBranch(name.trim(), checkout);
    if (result) {
      onClose();
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-gray-900 border border-gray-700 rounded-lg p-6 w-96">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold">Create Branch</h3>
          <button onClick={onClose} className="p-1 hover:bg-gray-800 rounded">
            <X className="w-5 h-5" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm text-gray-400 mb-1">Branch name</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="feature/my-feature"
              className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:outline-none focus:border-blue-500"
              autoFocus
            />
          </div>

          <label className="flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              checked={checkout}
              onChange={(e) => setCheckout(e.target.checked)}
              className="rounded"
            />
            <span>Switch to new branch after creation</span>
          </label>

          {error && (
            <p className="text-red-400 text-sm">{error}</p>
          )}

          <div className="flex justify-end gap-2">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 text-sm text-gray-400 hover:text-white"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={!name.trim() || isLoading}
              className="px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 rounded disabled:opacity-50"
            >
              {isLoading ? "Creating..." : "Create"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```

**src/components/branches/MergeDialog.tsx**:
```tsx
import { X, Check, AlertTriangle, GitMerge } from "lucide-react";
import type { MergeResult } from "../../bindings";
import { useBranchStore } from "../../stores/branches";

interface MergeDialogProps {
  sourceBranch: string;
  result: MergeResult | null;
  onConfirm: () => void;
  onClose: () => void;
}

export function MergeDialog({ sourceBranch, result, onConfirm, onClose }: MergeDialogProps) {
  const { isLoading, abortMerge } = useBranchStore();

  const handleAbort = async () => {
    await abortMerge();
    onClose();
  };

  // Show confirmation before merge
  if (!result) {
    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div className="bg-gray-900 border border-gray-700 rounded-lg p-6 w-96">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-semibold flex items-center gap-2">
              <GitMerge className="w-5 h-5" />
              Merge Branch
            </h3>
            <button onClick={onClose} className="p-1 hover:bg-gray-800 rounded">
              <X className="w-5 h-5" />
            </button>
          </div>

          <p className="text-gray-300 mb-4">
            Merge <strong>{sourceBranch}</strong> into current branch?
          </p>

          <div className="flex justify-end gap-2">
            <button onClick={onClose} className="px-4 py-2 text-sm text-gray-400 hover:text-white">
              Cancel
            </button>
            <button
              onClick={onConfirm}
              disabled={isLoading}
              className="px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 rounded disabled:opacity-50"
            >
              {isLoading ? "Merging..." : "Merge"}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Show result after merge
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-gray-900 border border-gray-700 rounded-lg p-6 w-96">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold">Merge Result</h3>
          <button onClick={onClose} className="p-1 hover:bg-gray-800 rounded">
            <X className="w-5 h-5" />
          </button>
        </div>

        {result.success && !result.hasConflicts && (
          <div className="flex items-center gap-2 text-green-400 mb-4">
            <Check className="w-5 h-5" />
            <span>
              {result.fastForwarded ? "Fast-forwarded" : "Merged"} successfully
              {result.analysis === "UpToDate" && " (already up to date)"}
            </span>
          </div>
        )}

        {result.hasConflicts && (
          <div className="space-y-3">
            <div className="flex items-center gap-2 text-yellow-400">
              <AlertTriangle className="w-5 h-5" />
              <span>Merge conflicts detected</span>
            </div>
            <div className="text-sm text-gray-400">
              <p className="mb-2">Conflicted files:</p>
              <ul className="list-disc list-inside space-y-1">
                {result.conflictedFiles.map((file) => (
                  <li key={file} className="text-red-400">{file}</li>
                ))}
              </ul>
            </div>
            <p className="text-sm text-gray-500">
              Resolve conflicts manually, then stage and commit.
            </p>
            <button
              onClick={handleAbort}
              className="px-4 py-2 text-sm bg-red-600 hover:bg-red-700 rounded"
            >
              Abort Merge
            </button>
          </div>
        )}

        <div className="flex justify-end mt-4">
          <button onClick={onClose} className="px-4 py-2 text-sm bg-gray-700 hover:bg-gray-600 rounded">
            Close
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Update Header.tsx** to include branch dropdown:
- Add import for BranchList or create BranchSelector
- Replace static branch display with clickable dropdown
- When clicked, show BranchList in a popover/dropdown panel
- Keep showing current branch name in header
  </action>
  <verify>
TypeScript compiles. Dialogs render and function correctly. Header shows branch dropdown.
  </verify>
  <done>
CreateBranchDialog provides form for new branch with checkout option. MergeDialog shows confirmation, then result with conflict handling and abort option. Header integrates branch selector.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run typecheck` - TypeScript compiles without errors
2. `npm run tauri dev` - app starts successfully
3. Branch list visible and populated in UI
4. Can create new branch via dialog
5. Can switch branches via UI
6. Can delete branch with confirmation for unmerged
7. Can merge branch and see result/conflicts
8. Header shows current branch with dropdown to change
</verification>

<success_criteria>
- useBranchStore provides complete branch state management
- BranchList shows all local branches with HEAD indicator
- BranchItem provides checkout, merge, delete actions
- CreateBranchDialog allows naming new branch with optional checkout
- MergeDialog shows confirmation, result, and conflict handling
- Header integrates branch selection dropdown
- All components follow existing Tailwind/Lucide patterns
- Loading and error states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-git-branches/03-05-SUMMARY.md`
</output>
