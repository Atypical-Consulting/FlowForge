---
phase: 06-conventional-commits
plan: 06
type: execute
wave: 4
depends_on: ["06-03", "06-05"]
files_modified:
  - src/components/changelog/ChangelogDialog.tsx
  - src/components/changelog/ChangelogPreview.tsx
  - src/stores/changelogStore.ts
  - src/components/Header.tsx
autonomous: true

must_haves:
  truths:
    - "User can generate changelog from repository history"
    - "Changelog is grouped by commit type"
    - "User can copy or export changelog"
  artifacts:
    - path: "src/components/changelog/ChangelogDialog.tsx"
      provides: "Dialog for changelog generation"
      exports: ["ChangelogDialog"]
    - path: "src/stores/changelogStore.ts"
      provides: "Zustand store for changelog state"
      exports: ["useChangelogStore"]
  key_links:
    - from: "src/components/changelog/ChangelogDialog.tsx"
      to: "src/stores/changelogStore.ts"
      via: "store usage"
      pattern: "useChangelogStore"
---

<objective>
Create the changelog generation UI with dialog, preview, and export functionality.

Purpose: Allow users to generate, preview, and export changelogs from conventional commit history.
Output: Changelog dialog component with generation options and markdown preview.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-conventional-commits/06-03-SUMMARY.md
@.planning/phases/06-conventional-commits/06-05-SUMMARY.md
@src/components/ui/Dialog.tsx
@src/components/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create changelog store and types</name>
  <files>src/stores/changelogStore.ts</files>
  <action>
1. Create `src/stores/changelogStore.ts`:

```typescript
import { create } from 'zustand';
import { invoke } from '@tauri-apps/api/core';

interface ChangelogCommit {
  hash: string;
  scope: string | null;
  description: string;
  breaking: boolean;
  author: string;
  date: string;
}

interface CommitGroup {
  commit_type: string;
  title: string;
  commits: ChangelogCommit[];
}

interface ChangelogOutput {
  markdown: string;
  commit_count: number;
  groups: CommitGroup[];
}

interface ChangelogState {
  // Options
  fromRef: string;
  toRef: string;
  version: string;
  
  // Output
  changelog: ChangelogOutput | null;
  isGenerating: boolean;
  error: string | null;
  
  // Dialog
  isDialogOpen: boolean;
  
  // Actions
  setFromRef: (ref: string) => void;
  setToRef: (ref: string) => void;
  setVersion: (version: string) => void;
  
  openDialog: () => void;
  closeDialog: () => void;
  
  generate: () => Promise<void>;
  reset: () => void;
}

export const useChangelogStore = create<ChangelogState>((set, get) => ({
  // Initial state
  fromRef: '',
  toRef: 'HEAD',
  version: '',
  changelog: null,
  isGenerating: false,
  error: null,
  isDialogOpen: false,
  
  // Setters
  setFromRef: (ref) => set({ fromRef: ref }),
  setToRef: (ref) => set({ toRef: ref }),
  setVersion: (version) => set({ version }),
  
  openDialog: () => set({ isDialogOpen: true }),
  closeDialog: () => set({ isDialogOpen: false }),
  
  generate: async () => {
    const { fromRef, toRef, version } = get();
    set({ isGenerating: true, error: null });
    
    try {
      const result = await invoke<ChangelogOutput>('generate_changelog_cmd', {
        fromRef: fromRef || null,
        toRef: toRef || null,
        version: version || null,
      });
      set({ changelog: result, isGenerating: false });
    } catch (e) {
      set({ error: String(e), isGenerating: false });
    }
  },
  
  reset: () => set({
    fromRef: '',
    toRef: 'HEAD',
    version: '',
    changelog: null,
    error: null,
  }),
}));

export type { ChangelogOutput, CommitGroup, ChangelogCommit };
```
  </action>
  <verify>
    - TypeScript compiles without errors
    - Store exports correctly
  </verify>
  <done>Changelog Zustand store created with all state and actions</done>
</task>

<task type="auto">
  <name>Task 2: Create ChangelogPreview and ChangelogDialog components</name>
  <files>src/components/changelog/ChangelogPreview.tsx, src/components/changelog/ChangelogDialog.tsx</files>
  <action>
1. Create `src/components/changelog/ChangelogPreview.tsx`:

```typescript
import type { ChangelogOutput } from '../../stores/changelogStore';

interface ChangelogPreviewProps {
  changelog: ChangelogOutput;
}

export function ChangelogPreview({ changelog }: ChangelogPreviewProps) {
  const handleCopy = async () => {
    await navigator.clipboard.writeText(changelog.markdown);
  };
  
  return (
    <div className="space-y-4">
      {/* Stats */}
      <div className="flex items-center gap-4 text-sm text-muted-foreground">
        <span>{changelog.commit_count} commits</span>
        <span>{changelog.groups.length} groups</span>
      </div>
      
      {/* Copy button */}
      <button
        onClick={handleCopy}
        className="flex items-center gap-2 px-3 py-1.5 text-sm border border-border rounded hover:bg-accent"
      >
        üìã Copy to clipboard
      </button>
      
      {/* Markdown preview */}
      <div className="p-4 bg-muted/30 border border-border rounded max-h-[400px] overflow-y-auto">
        <pre className="text-sm font-mono whitespace-pre-wrap">
          {changelog.markdown}
        </pre>
      </div>
      
      {/* Group breakdown */}
      <div className="space-y-2">
        <h4 className="text-sm font-medium">Breakdown</h4>
        <div className="grid grid-cols-2 gap-2 text-sm">
          {changelog.groups.map((group) => (
            <div key={group.commit_type} className="flex justify-between p-2 bg-muted/20 rounded">
              <span>{group.title}</span>
              <span className="text-muted-foreground">{group.commits.length}</span>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
```

2. Create `src/components/changelog/ChangelogDialog.tsx`:

```typescript
import { useChangelogStore } from '../../stores/changelogStore';
import { ChangelogPreview } from './ChangelogPreview';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '../ui/Dialog';

export function ChangelogDialog() {
  const {
    isDialogOpen,
    closeDialog,
    fromRef,
    toRef,
    version,
    setFromRef,
    setToRef,
    setVersion,
    changelog,
    isGenerating,
    error,
    generate,
    reset,
  } = useChangelogStore();
  
  const handleClose = () => {
    closeDialog();
    reset();
  };
  
  return (
    <Dialog open={isDialogOpen} onOpenChange={(open) => !open && handleClose()}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Generate Changelog</DialogTitle>
        </DialogHeader>
        
        <div className="space-y-4 py-4">
          {/* Options */}
          {!changelog && (
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="text-sm font-medium">From (tag/commit)</label>
                  <input
                    type="text"
                    value={fromRef}
                    onChange={(e) => setFromRef(e.target.value)}
                    placeholder="e.g., v1.0.0 (leave empty for all)"
                    className="w-full p-2 bg-background border border-border rounded focus:border-primary focus:outline-none"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm font-medium">To (tag/commit)</label>
                  <input
                    type="text"
                    value={toRef}
                    onChange={(e) => setToRef(e.target.value)}
                    placeholder="HEAD"
                    className="w-full p-2 bg-background border border-border rounded focus:border-primary focus:outline-none"
                  />
                </div>
              </div>
              
              <div className="space-y-2">
                <label className="text-sm font-medium">Version (optional)</label>
                <input
                  type="text"
                  value={version}
                  onChange={(e) => setVersion(e.target.value)}
                  placeholder="e.g., 1.1.0 (for header)"
                  className="w-full p-2 bg-background border border-border rounded focus:border-primary focus:outline-none"
                />
              </div>
              
              {error && (
                <div className="p-3 bg-red-500/10 border border-red-500/20 rounded text-red-400 text-sm">
                  {error}
                </div>
              )}
              
              <button
                onClick={generate}
                disabled={isGenerating}
                className="w-full py-2 px-4 bg-primary text-primary-foreground rounded hover:bg-primary/90 disabled:opacity-50"
              >
                {isGenerating ? 'Generating...' : 'Generate Changelog'}
              </button>
            </div>
          )}
          
          {/* Preview */}
          {changelog && (
            <div className="space-y-4">
              <ChangelogPreview changelog={changelog} />
              
              <div className="flex gap-2">
                <button
                  onClick={reset}
                  className="flex-1 py-2 px-4 border border-border rounded hover:bg-accent"
                >
                  Generate Another
                </button>
                <button
                  onClick={handleClose}
                  className="py-2 px-4 bg-primary text-primary-foreground rounded hover:bg-primary/90"
                >
                  Done
                </button>
              </div>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

3. Create index file:

```typescript
// src/components/changelog/index.ts
export { ChangelogDialog } from './ChangelogDialog';
export { ChangelogPreview } from './ChangelogPreview';
```
  </action>
  <verify>
    - TypeScript compiles without errors
    - Dialog renders correctly
  </verify>
  <done>Changelog dialog and preview components created</done>
</task>

<task type="auto">
  <name>Task 3: Integrate changelog into Header or menu</name>
  <files>src/components/Header.tsx, src/App.tsx</files>
  <action>
1. Find the Header component and add a changelog button:
   - Look for existing menu structure or action buttons
   - Add a "Generate Changelog" button that calls `useChangelogStore().openDialog()`

2. Add the ChangelogDialog to the app root (or where other dialogs are rendered):

```typescript
// In App.tsx or similar root component
import { ChangelogDialog } from './components/changelog';

// In the render:
<ChangelogDialog />
```

3. Example Header integration:

```typescript
import { useChangelogStore } from '../stores/changelogStore';

// Inside Header component:
const openChangelog = useChangelogStore((s) => s.openDialog);

// In the render, add to menu or toolbar:
<button
  onClick={openChangelog}
  className="flex items-center gap-2 px-3 py-1.5 text-sm hover:bg-accent rounded"
  title="Generate Changelog"
>
  üìù Changelog
</button>
```

4. Ensure the button is visible in the UI - could be in:
   - Header toolbar
   - Git menu dropdown
   - Repository actions area
  </action>
  <verify>
    - Changelog button visible in UI
    - Clicking opens dialog
    - Generate works end-to-end
  </verify>
  <done>Changelog generation accessible from main UI</done>
</task>

</tasks>

<verification>
```bash
# Type check
npm run typecheck || pnpm typecheck

# Check component files exist
ls -la src/components/changelog/*.tsx

# Build to verify no errors
npm run build || pnpm build
```
</verification>

<success_criteria>
- [ ] changelogStore.ts created with all state and actions
- [ ] ChangelogPreview.tsx renders markdown with copy button
- [ ] ChangelogDialog.tsx provides options and preview
- [ ] Dialog integrated into Header or menu
- [ ] Generate produces grouped changelog
- [ ] Copy to clipboard works
- [ ] TypeScript compiles without errors
- [ ] End-to-end flow works: button ‚Üí dialog ‚Üí generate ‚Üí preview ‚Üí copy
</success_criteria>

<output>
After completion, create `.planning/phases/06-conventional-commits/06-06-SUMMARY.md`
</output>
