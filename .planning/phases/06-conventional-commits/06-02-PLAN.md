---
phase: 06-conventional-commits
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/Cargo.toml
  - src-tauri/src/git/changelog.rs
  - src-tauri/src/git/mod.rs
autonomous: true

must_haves:
  truths:
    - "Changelog can be generated from commit history"
    - "Commits are grouped by type in conventional order"
    - "Breaking changes are highlighted in changelog"
  artifacts:
    - path: "src-tauri/src/git/changelog.rs"
      provides: "Changelog generation with Tera templates"
      exports: ["generate_changelog", "ChangelogOptions", "ChangelogOutput"]
  key_links:
    - from: "src-tauri/src/git/changelog.rs"
      to: "tera crate"
      via: "Tera::render"
      pattern: "tera::Tera"
---

<objective>
Implement the Rust backend module for changelog generation from conventional commits.

Purpose: Generate formatted changelogs grouped by commit type from repository history.
Output: `changelog.rs` module with Tera-based changelog generation.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-conventional-commits/06-RESEARCH.md
@src-tauri/src/git/history.rs
@src-tauri/src/git/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Tera dependency and create changelog.rs module</name>
  <files>src-tauri/Cargo.toml, src-tauri/src/git/changelog.rs, src-tauri/src/git/mod.rs</files>
  <action>
1. Add to Cargo.toml dependencies:
   - `tera = "1"`
   - `chrono = "0.4"` (if not already present)

2. Create `src-tauri/src/git/changelog.rs` with:
   - ChangelogOptions struct:
     - from_ref: Option<String> (tag/commit to start from)
     - to_ref: Option<String> (tag/commit to end at, default HEAD)
     - include_unreleased: bool (default true)
     - group_by_scope: bool (default false)
   
   - ChangelogOutput struct:
     - markdown: String (rendered changelog)
     - commit_count: usize
     - groups: Vec<CommitGroup>
   
   - CommitGroup struct:
     - commit_type: String
     - title: String (e.g., "Features" for feat)
     - commits: Vec<ChangelogCommit>
   
   - ChangelogCommit struct:
     - hash: String (short)
     - scope: Option<String>
     - description: String
     - breaking: bool
     - author: String
     - date: String

3. Add `pub mod changelog;` to `src-tauri/src/git/mod.rs`

All structs must derive Serialize, Clone, Debug, and specta::Type.
  </action>
  <verify>
    - `cargo check` passes
    - Module is exported from git mod
  </verify>
  <done>Changelog types defined and Tera dependency added</done>
</task>

<task type="auto">
  <name>Task 2: Implement changelog generation with Tera templates</name>
  <files>src-tauri/src/git/changelog.rs</files>
  <action>
1. Define the default Tera template as a const:
```rust
const DEFAULT_TEMPLATE: &str = r#"
# Changelog

{% for group in groups %}
## {{ group.title }}

{% for commit in group.commits %}
- {% if commit.scope %}**{{ commit.scope }}:** {% endif %}{{ commit.description }}{% if commit.breaking %} ⚠️ **BREAKING**{% endif %} ([{{ commit.hash }}])
{% endfor %}

{% endfor %}
"#;
```

2. Implement `generate_changelog(repo: &Repository, options: ChangelogOptions) -> Result<ChangelogOutput, ChangelogError>`:
   - Use git2 to walk commit history from to_ref back to from_ref
   - Parse each commit message with git_conventional::Commit::parse
   - Skip commits that don't parse as conventional
   - Group commits by type
   - Order groups: feat → fix → perf → refactor → docs → style → test → chore → ci → build
   - Map type to title: "feat" → "Features", "fix" → "Bug Fixes", etc.
   - Render with Tera

3. Implement `group_commits_by_type(commits: Vec<ChangelogCommit>) -> Vec<CommitGroup>`:
   - Define TYPE_ORDER constant for ordering
   - Define TYPE_TITLES HashMap for display names
   - Group, then sort by TYPE_ORDER

4. Define ChangelogError enum with variants:
   - GitError(String)
   - ParseError(String)
   - TemplateError(String)
  </action>
  <verify>
    - Unit test: generate changelog from mock commits
    - Test ordering of groups
    - Test breaking change highlighting
  </verify>
  <done>Changelog generates grouped, ordered markdown from commit history</done>
</task>

<task type="auto">
  <name>Task 3: Add version/tag range support</name>
  <files>src-tauri/src/git/changelog.rs</files>
  <action>
1. Implement `get_commits_in_range(repo: &Repository, from: Option<&str>, to: Option<&str>) -> Result<Vec<CommitInfo>, ChangelogError>`:
   - If from is None, go back to beginning (or limit to 500 commits)
   - If to is None, use HEAD
   - Resolve refs (tags, branches, commits) to Oid
   - Walk revisions with RevWalk
   - Stop when reaching from_ref

2. Implement `find_previous_tag(repo: &Repository, current: &str) -> Option<String>`:
   - List all tags
   - Sort by semver if possible, else by date
   - Return tag before current

3. Add to ChangelogOptions:
   - version: Option<String> (version header for unreleased section)
   - date: Option<String> (date for version header)

4. Update template to optionally include version header:
```rust
const VERSIONED_TEMPLATE: &str = r#"
# Changelog

## {% if version %}{{ version }}{% else %}Unreleased{% endif %}{% if date %} ({{ date }}){% endif %}

{% for group in groups %}
### {{ group.title }}

{% for commit in group.commits %}
- {% if commit.scope %}**{{ commit.scope }}:** {% endif %}{{ commit.description }}{% if commit.breaking %} ⚠️ **BREAKING**{% endif %}
{% endfor %}

{% endfor %}
"#;
```
  </action>
  <verify>
    - Test with tag range
    - Test with version header
    - Test semver tag sorting
  </verify>
  <done>Changelog supports version ranges and tag-based generation</done>
</task>

</tasks>

<verification>
```bash
# Build check
cargo check

# Run tests
cargo test changelog

# Verify module exports
grep -r "pub mod changelog" src-tauri/src/git/
grep -r "pub fn" src-tauri/src/git/changelog.rs
```
</verification>

<success_criteria>
- [ ] Tera and chrono dependencies added
- [ ] changelog.rs module created with all types
- [ ] generate_changelog produces grouped markdown
- [ ] Commits ordered by type (feat first, chore last)
- [ ] Breaking changes highlighted
- [ ] Tag/version range filtering works
- [ ] All functions have unit tests
- [ ] cargo check and cargo test pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-conventional-commits/06-02-SUMMARY.md`
</output>
