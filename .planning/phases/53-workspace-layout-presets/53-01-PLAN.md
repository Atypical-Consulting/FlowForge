---
phase: 53-workspace-layout-presets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/lib/layoutPresets.ts
  - src/core/stores/domain/preferences/layout.slice.ts
  - src/core/stores/domain/preferences/index.ts
  - src/core/commands/layout.ts
  - src/core/commands/index.ts
  - src/core/components/menu-bar/menu-definitions.ts
autonomous: true

must_haves:
  truths:
    - "Layout presets (Review, Commit, Explore, Focus) are defined as data objects with id, label, icon, description, layout sizes, and visible panels"
    - "Layout state (active preset, panel sizes, hidden panels, focused panel) is managed in a Zustand slice with Tauri Store persistence"
    - "Layout commands (4 preset selectors + toggle sidebar + reset layout) appear in the command palette"
    - "View menu contains Layout preset entries and a Toggle Sidebar + Reset Layout action"
  artifacts:
    - path: "src/core/lib/layoutPresets.ts"
      provides: "Preset definitions as LAYOUT_PRESETS array and PresetId type"
      exports: ["LAYOUT_PRESETS", "LayoutPreset", "PresetId", "DEFAULT_PRESET_ID"]
    - path: "src/core/stores/domain/preferences/layout.slice.ts"
      provides: "Zustand layout slice with state and actions"
      exports: ["createLayoutSlice", "LayoutSlice", "LayoutState"]
    - path: "src/core/commands/layout.ts"
      provides: "Command registrations for layout presets, toggle sidebar, reset layout"
    - path: "src/core/components/menu-bar/menu-definitions.ts"
      provides: "Updated View menu with layout entries"
  key_links:
    - from: "src/core/commands/layout.ts"
      to: "src/core/lib/layoutPresets.ts"
      via: "imports LAYOUT_PRESETS to iterate and register one command per preset"
      pattern: "LAYOUT_PRESETS\\.forEach|for.*of.*LAYOUT_PRESETS"
    - from: "src/core/commands/layout.ts"
      to: "src/core/stores/domain/preferences/layout.slice.ts"
      via: "calls setActivePreset, togglePanel, resetLayout from usePreferencesStore"
      pattern: "usePreferencesStore\\.getState\\(\\)\\.(setActivePreset|togglePanel|resetLayout)"
    - from: "src/core/stores/domain/preferences/index.ts"
      to: "src/core/stores/domain/preferences/layout.slice.ts"
      via: "composes layout slice into PreferencesStore type and creation"
      pattern: "createLayoutSlice"
---

<objective>
Create the data foundation for workspace layout presets: preset definitions, Zustand layout state slice with Tauri Store persistence, command registrations for the command palette, and View menu entries.

Purpose: Establishes the state management and command surface for layout presets before wiring them to the actual panel components. Separates data/state concerns from UI wiring.
Output: Layout presets as data, layout slice in preferences store, 7 commands registered, View menu updated with layout section.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-workspace-layout-presets/53-RESEARCH.md
@src/core/stores/domain/preferences/index.ts
@src/core/stores/domain/preferences/types.ts
@src/core/stores/domain/preferences/diff.slice.ts
@src/core/stores/domain/preferences/settings.slice.ts
@src/core/lib/store.ts
@src/core/lib/commandRegistry.ts
@src/core/commands/index.ts
@src/core/commands/navigation.ts
@src/core/components/menu-bar/menu-definitions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create layout preset definitions and Zustand layout slice</name>
  <files>
    src/core/lib/layoutPresets.ts
    src/core/stores/domain/preferences/layout.slice.ts
    src/core/stores/domain/preferences/index.ts
  </files>
  <action>
**1. Create `src/core/lib/layoutPresets.ts`:**

Define the layout preset data model. Each preset maps panel IDs to percentage sizes.

```typescript
import type { LucideIcon } from "lucide-react";
import { LayoutGrid, GitCommitHorizontal, FolderSearch, Maximize2 } from "lucide-react";

export interface LayoutPreset {
  id: PresetId;
  label: string;
  icon: LucideIcon;
  description: string;
  /** Panel id -> percentage size (0..100). Keys match Panel id props in RepositoryView. */
  layout: Record<string, number>;
  /** Which panels are visible in this preset (sidebar collapsed = not visible) */
  visiblePanels: string[];
}

export type PresetId = "review" | "commit" | "explore" | "focus";

export const DEFAULT_PRESET_ID: PresetId = "review";

export const LAYOUT_PRESETS: LayoutPreset[] = [
  {
    id: "review",
    label: "Review",
    icon: LayoutGrid,
    description: "Balanced view for code review",
    layout: { sidebar: 20, blades: 80 },
    visiblePanels: ["sidebar", "blades"],
  },
  {
    id: "commit",
    label: "Commit",
    icon: GitCommitHorizontal,
    description: "Emphasize staging area for committing",
    layout: { sidebar: 30, blades: 70 },
    visiblePanels: ["sidebar", "blades"],
  },
  {
    id: "explore",
    label: "Explore",
    icon: FolderSearch,
    description: "Maximize blade area for browsing",
    layout: { sidebar: 15, blades: 85 },
    visiblePanels: ["sidebar", "blades"],
  },
  {
    id: "focus",
    label: "Focus",
    icon: Maximize2,
    description: "Full-screen blade area, sidebar hidden",
    layout: { sidebar: 0, blades: 100 },
    visiblePanels: ["blades"],
  },
];

/** Lookup a preset by ID. Returns undefined if not found. */
export function getPresetById(id: string): LayoutPreset | undefined {
  return LAYOUT_PRESETS.find((p) => p.id === id);
}
```

**2. Create `src/core/stores/domain/preferences/layout.slice.ts`:**

Follow the exact same pattern as `diff.slice.ts` (StateCreator with PreferencesStore + PreferencesMiddleware generics). The state tracks:
- `activePreset`: PresetId | "custom" — current preset or "custom" if user manually resized
- `panelSizes`: `Record<string, number>` — actual panel sizes `{ sidebar: 20, blades: 80 }`
- `hiddenPanels`: `string[]` — panels toggled off by user
- `focusedPanel`: `string | null` — non-null when a panel is maximized (focus mode)

Default state: `activePreset: "review"`, `panelSizes: { sidebar: 20, blades: 80 }`, `hiddenPanels: []`, `focusedPanel: null`.

Actions:
- `setActivePreset(presetId: PresetId)`: Look up preset from `getPresetById`, update `panelSizes` to preset's `layout`, update `hiddenPanels` based on preset's `visiblePanels`, set `focusedPanel` to null, persist via `getStore()` to key `"layout"`, and `store.save()`.
- `setPanelSizes(sizes: Record<string, number>)`: Update `panelSizes`, set `activePreset` to `"custom"` (user manually resized), persist.
- `togglePanel(panelId: string)`: Toggle `panelId` in `hiddenPanels`. If adding (hiding), panel was visible. If removing (showing), panel was hidden. Persist. Set `activePreset` to `"custom"`.
- `enterFocusMode(panelId: string)`: Set `focusedPanel` to `panelId`. Do NOT persist (focus mode is transient).
- `exitFocusMode()`: Set `focusedPanel` to null.
- `resetLayout()`: Reset to `defaultLayoutState`, persist.
- `initLayout()`: Read key `"layout"` from `getStore()`, merge with defaults using spread, set state.

Wrap all store mutations in try/catch like diff.slice.ts does. Use `store.set("layout", ...)` / `store.save()` for persistence.

**3. Wire layout slice into preferences store (`index.ts`):**

- Import `createLayoutSlice` and `LayoutSlice` from `./layout.slice`
- Add `LayoutSlice` to the `PreferencesStore` union type
- Spread `createLayoutSlice(...args)` in the devtools callback
- Add `state.initLayout()` to the `Promise.all` in `initAllPreferences()`
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — zero new type errors (ignore pre-existing TS2440 in bindings.ts). Verify `layoutPresets.ts` exports LAYOUT_PRESETS with 4 entries. Verify `index.ts` imports and composes the layout slice.
  </verify>
  <done>
Layout presets defined as data with 4 preset objects. Layout slice integrated into preferences store with 7 actions (setActivePreset, setPanelSizes, togglePanel, enterFocusMode, exitFocusMode, resetLayout, initLayout). State persists to Tauri Store under key "layout". initAllPreferences() calls initLayout().
  </done>
</task>

<task type="auto">
  <name>Task 2: Register layout commands and add View menu entries</name>
  <files>
    src/core/commands/layout.ts
    src/core/commands/index.ts
    src/core/components/menu-bar/menu-definitions.ts
  </files>
  <action>
**1. Create `src/core/commands/layout.ts`:**

Register 7 commands using the `registerCommand` pattern from `navigation.ts`:

- One command per preset (4 total): `layout-preset-review`, `layout-preset-commit`, `layout-preset-explore`, `layout-preset-focus`. Iterate `LAYOUT_PRESETS` to generate these. Category: `"Navigation"`. Each calls `usePreferencesStore.getState().setActivePreset(preset.id)`. Use the preset's icon. No keyboard shortcuts for presets.

- `toggle-sidebar`: Title "Toggle Sidebar", category "Navigation", icon `PanelLeft` from lucide-react, shortcut `"mod+\\"`, calls `usePreferencesStore.getState().togglePanel("sidebar")`. Enabled only when repo is open (`!!useRepositoryStore.getState().repoStatus`).

- `reset-layout`: Title "Reset Layout to Default", category "Navigation", icon `RotateCcw` from lucide-react, calls `usePreferencesStore.getState().resetLayout()`.

- `toggle-focus-mode`: Title "Toggle Focus Mode", category "Navigation", icon `Maximize2` from lucide-react, calls: if `focusedPanel` is non-null, call `exitFocusMode()`; else call `enterFocusMode("blades")`. Enabled only when repo is open.

Import `LAYOUT_PRESETS` from `../../lib/layoutPresets`, `usePreferencesStore` from `../../stores/domain/preferences`, `useGitOpsStore` from `../../stores/domain/git-ops`, and icons from `lucide-react`.

**2. Add import to `src/core/commands/index.ts`:**

Add `import "./layout";` after the existing imports. This triggers command registration at module load time.

**3. Update `src/core/components/menu-bar/menu-definitions.ts`:**

Add new entries to the `view` menu `items` array, after the existing Extension Manager entry:

```typescript
// Add these imports at the top:
import { FolderSearch, GitCommitHorizontal, LayoutGrid, Maximize2, PanelLeft, RotateCcw } from "lucide-react";

// Add after the "view-extensions" entry in the view menu items:
{ type: "divider", id: "view-div-layout" },
{
  type: "action",
  id: "view-layout-review",
  label: "Layout: Review",
  icon: LayoutGrid,
  commandId: "layout-preset-review",
},
{
  type: "action",
  id: "view-layout-commit",
  label: "Layout: Commit",
  icon: GitCommitHorizontal,
  commandId: "layout-preset-commit",
},
{
  type: "action",
  id: "view-layout-explore",
  label: "Layout: Explore",
  icon: FolderSearch,
  commandId: "layout-preset-explore",
},
{
  type: "action",
  id: "view-layout-focus",
  label: "Layout: Focus",
  icon: Maximize2,
  commandId: "layout-preset-focus",
},
{ type: "divider", id: "view-div-panels" },
{
  type: "action",
  id: "view-toggle-sidebar",
  label: "Toggle Sidebar",
  icon: PanelLeft,
  shortcut: "mod+\\",
  commandId: "toggle-sidebar",
},
{
  type: "action",
  id: "view-reset-layout",
  label: "Reset Layout",
  icon: RotateCcw,
  commandId: "reset-layout",
},
```

Note: Some icons may already be imported (RotateCcw is already imported). Only add missing imports. Check existing imports before adding duplicates.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — zero new type errors. Open command palette (Cmd+K) and search "layout" — should show all 7 layout commands. Open View menu — should show Layout presets section and Panel toggle section after the Extension Manager entry.
  </verify>
  <done>
7 layout commands registered in the command palette (4 presets + toggle sidebar + reset layout + toggle focus mode). View menu updated with layout preset entries and panel toggle entries, separated by dividers. Commands are wired to the layout slice actions in the preferences store.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignoring pre-existing bindings.ts error)
2. `LAYOUT_PRESETS` exports 4 presets with correct structure (id, label, icon, description, layout, visiblePanels)
3. `usePreferencesStore.getState()` has all layout slice methods: setActivePreset, setPanelSizes, togglePanel, enterFocusMode, exitFocusMode, resetLayout, initLayout
4. `initAllPreferences()` includes `initLayout()` in its Promise.all
5. Command palette shows 7 layout-related commands when searching "layout"
6. View menu has Layout section (4 presets) and Panels section (toggle sidebar, reset layout)
</verification>

<success_criteria>
- Layout preset definitions exist as typed data objects with all required fields
- Layout state persists to Tauri Store under the "layout" key
- Layout commands are discoverable via command palette search
- View menu contains layout and panel entries with correct icons and shortcuts
- Type checking passes with zero new errors
</success_criteria>

<output>
After completion, create `.planning/phases/53-workspace-layout-presets/53-01-SUMMARY.md`
</output>
