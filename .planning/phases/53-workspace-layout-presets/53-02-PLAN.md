---
phase: 53-workspace-layout-presets
plan: 02
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - src/core/components/layout/ResizablePanelLayout.tsx
  - src/core/components/layout/index.ts
  - src/core/components/RepositoryView.tsx
  - src/core/blades/_shared/BladePanel.tsx
  - src/core/hooks/useKeyboardShortcuts.ts
autonomous: true

must_haves:
  truths:
    - "User can select from layout presets via View menu or command palette and see the panel sizes change"
    - "User can maximize the blade container to fullscreen by double-clicking its panel header, and press Esc to exit focus mode"
    - "User can toggle the sidebar on/off via Cmd+Backslash or the Toggle Sidebar command, with the blade container redistributing to fill the space"
    - "User's panel sizes persist across app restarts and restore correctly on launch"
    - "User can reset layout to default via the Reset Layout command"
    - "When user manually resizes panels, the active preset indicator changes to custom"
  artifacts:
    - path: "src/core/components/layout/ResizablePanelLayout.tsx"
      provides: "ResizablePanelLayout and ResizablePanel wrappers with imperative ref forwarding and collapsible support"
    - path: "src/core/components/RepositoryView.tsx"
      provides: "RepositoryView wired to layout store with imperative group/panel refs, onLayoutChanged persistence, focus mode"
    - path: "src/core/blades/_shared/BladePanel.tsx"
      provides: "BladePanel with double-click focus mode on header"
    - path: "src/core/hooks/useKeyboardShortcuts.ts"
      provides: "Escape key handler with focus mode exit priority, toggle sidebar shortcut"
  key_links:
    - from: "src/core/components/RepositoryView.tsx"
      to: "src/core/stores/domain/preferences/layout.slice.ts"
      via: "subscribes to layoutState, calls setActivePreset/setPanelSizes/enterFocusMode/exitFocusMode"
      pattern: "usePreferencesStore.*layoutState|setActivePreset|setPanelSizes"
    - from: "src/core/components/RepositoryView.tsx"
      to: "react-resizable-panels"
      via: "useGroupRef and usePanelRef for imperative layout control"
      pattern: "useGroupRef|usePanelRef|groupRef\\.current\\.setLayout|sidebarRef\\.current\\.(collapse|expand)"
    - from: "src/core/blades/_shared/BladePanel.tsx"
      to: "src/core/stores/domain/preferences/layout.slice.ts"
      via: "calls enterFocusMode on double-click"
      pattern: "enterFocusMode|onDoubleClick"
    - from: "src/core/hooks/useKeyboardShortcuts.ts"
      to: "src/core/stores/domain/preferences/layout.slice.ts"
      via: "checks focusedPanel and calls exitFocusMode before blade pop on Escape"
      pattern: "focusedPanel|exitFocusMode"
---

<objective>
Wire the layout store to the actual panel components via the react-resizable-panels imperative API, implement focus mode (double-click header + Esc exit), add panel size persistence via onLayoutChanged, and add the toggle-sidebar keyboard shortcut.

Purpose: Connects the data foundation from Plan 01 to the real UI, making all four requirements (LYOT-01 through LYOT-04) functional.
Output: Working layout presets with programmatic switching, focus mode, sidebar toggle, size persistence, and keyboard shortcuts.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-workspace-layout-presets/53-RESEARCH.md
@.planning/phases/53-workspace-layout-presets/53-01-SUMMARY.md
@src/core/components/layout/ResizablePanelLayout.tsx
@src/core/components/layout/index.ts
@src/core/components/RepositoryView.tsx
@src/core/blades/_shared/BladePanel.tsx
@src/core/hooks/useKeyboardShortcuts.ts
@src/core/lib/layoutPresets.ts
@src/core/stores/domain/preferences/layout.slice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance ResizablePanelLayout and wire RepositoryView to layout store</name>
  <files>
    src/core/components/layout/ResizablePanelLayout.tsx
    src/core/components/layout/index.ts
    src/core/components/RepositoryView.tsx
  </files>
  <action>
**1. Enhance `ResizablePanelLayout.tsx`:**

The wrapper currently passes through `id` and `orientation` to the `<Group>` component but does NOT support:
- `groupRef` prop for imperative control
- `onLayoutChanged` callback for persistence

Update `ResizablePanelLayout`:
- Add optional `groupRef` prop of type `Ref<GroupImperativeHandle | null>` (import from `react-resizable-panels`)
- Add optional `onLayoutChanged` prop of type `(layout: Layout) => void` (import `Layout` type from `react-resizable-panels`)
- Forward both to the `<Group>` component

Update `ResizablePanel`:
- Add optional `panelRef` prop of type `Ref<PanelImperativeHandle | null>` (import from `react-resizable-panels`)
- Add optional `collapsible` prop (boolean)
- Add optional `collapsedSize` prop (number — will be converted to `"${n}%"` string like the other size props)
- Add optional `onResize` prop matching the Panel's `onResize` signature
- Forward all to the `<Panel>` component
- Convert `collapsedSize` number to `"${n}%"` string the same way `defaultSize` is converted

Update `index.ts` to also re-export the `Layout` type from `react-resizable-panels` for consumers (just `export type { Layout } from "react-resizable-panels";`).

**2. Rewrite `RepositoryView.tsx` to wire layout store:**

Import `useGroupRef`, `usePanelRef` from `react-resizable-panels`. Import `usePreferencesStore` from the preferences store. Import `getPresetById` from `../../lib/layoutPresets`. Import `useEffect`, `useCallback`, `useRef` from React.

Add imperative refs:
```typescript
const groupRef = useGroupRef();
const sidebarRef = usePanelRef();
```

Subscribe to layout state:
```typescript
const layoutState = usePreferencesStore((s) => s.layoutState);
const setActivePreset = usePreferencesStore((s) => s.setActivePreset);
const setPanelSizes = usePreferencesStore((s) => s.setPanelSizes);
```

**Apply preset changes via useEffect:**
When `layoutState.activePreset` changes and is NOT "custom", look up the preset and apply it imperatively:
```typescript
useEffect(() => {
  if (layoutState.activePreset === "custom") return;
  const preset = getPresetById(layoutState.activePreset);
  if (!preset || !groupRef.current) return;

  // Apply layout via imperative API
  groupRef.current.setLayout(preset.layout);

  // Handle sidebar collapse/expand for focus preset
  if (!preset.visiblePanels.includes("sidebar")) {
    sidebarRef.current?.collapse();
  } else if (sidebarRef.current?.isCollapsed()) {
    sidebarRef.current?.expand();
  }
}, [layoutState.activePreset]);
```

**Handle focus mode via useEffect:**
When `layoutState.focusedPanel` changes:
```typescript
useEffect(() => {
  if (layoutState.focusedPanel === "blades") {
    // Maximize blades: collapse sidebar
    sidebarRef.current?.collapse();
    groupRef.current?.setLayout({ sidebar: 0, blades: 100 });
  } else if (layoutState.focusedPanel === null) {
    // Restore to active preset's layout
    const preset = getPresetById(layoutState.activePreset);
    if (preset && groupRef.current) {
      groupRef.current.setLayout(preset.layout);
      if (preset.visiblePanels.includes("sidebar")) {
        sidebarRef.current?.expand();
      }
    } else {
      // custom: restore saved sizes
      groupRef.current?.setLayout(layoutState.panelSizes);
      if (!layoutState.hiddenPanels.includes("sidebar")) {
        sidebarRef.current?.expand();
      }
    }
  }
}, [layoutState.focusedPanel]);
```

**Handle sidebar toggle via useEffect:**
When `layoutState.hiddenPanels` changes:
```typescript
useEffect(() => {
  const sidebarHidden = layoutState.hiddenPanels.includes("sidebar");
  if (sidebarHidden) {
    sidebarRef.current?.collapse();
  } else if (sidebarRef.current?.isCollapsed()) {
    sidebarRef.current?.expand();
  }
}, [layoutState.hiddenPanels]);
```

**Persist manual resize via onLayoutChanged:**
Create a stable callback ref to avoid re-registering:
```typescript
const isApplyingPreset = useRef(false);

const handleLayoutChanged = useCallback((layout: Layout) => {
  // Don't mark as "custom" when we're programmatically applying a preset
  if (isApplyingPreset.current) return;
  setPanelSizes(layout as Record<string, number>);
}, [setPanelSizes]);
```

Set `isApplyingPreset.current = true` before `groupRef.current.setLayout()` calls and `false` after using a microtask (`queueMicrotask`).

**Wire to ResizablePanelLayout:**
- Pass `groupRef` to `<ResizablePanelLayout>`
- Pass `onLayoutChanged={handleLayoutChanged}` to `<ResizablePanelLayout>`
- Pass `panelRef={sidebarRef}` to the sidebar `<ResizablePanel>`
- Add `collapsible` and `collapsedSize={0}` to the sidebar `<ResizablePanel>`
- Keep existing `defaultSize`, `minSize`, `maxSize` on both panels

Do NOT change the existing sidebar content, commit form, BladeContainer, or DynamicSidebarPanels rendering. Only modify the layout wrapper props and add the state wiring.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — zero new type errors. Visually: open the app, go to View menu, click "Layout: Focus" — sidebar should collapse and blade area should expand to fill. Click "Layout: Review" — sidebar should reappear at 20%. Manually drag the resize handle — the active preset should become "custom" (visible in devtools or command palette search showing no active preset indicator).
  </verify>
  <done>
ResizablePanelLayout and ResizablePanel wrappers forward imperative refs and collapsible props. RepositoryView wires layout store to panel imperative API: preset changes are applied programmatically, manual resizes persist to Tauri Store and set preset to "custom", sidebar toggles via collapse/expand, and focus mode maximizes the blade area.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement focus mode on BladePanel header double-click</name>
  <files>
    src/core/blades/_shared/BladePanel.tsx
  </files>
  <action>
Add double-click handler to the BladePanel header `<div>` (the one with `className="h-10 px-3 flex items-center..."`) to trigger focus mode.

Import `usePreferencesStore` from the preferences store.

Add an `onDoubleClick` handler to the header div:
```typescript
const handleDoubleClick = () => {
  const { layoutState, enterFocusMode, exitFocusMode } = usePreferencesStore.getState();
  if (layoutState.focusedPanel) {
    exitFocusMode();
  } else {
    enterFocusMode("blades");
  }
};
```

Apply to the header div:
```html
<div
  className="h-10 px-3 flex items-center gap-2 border-b border-ctp-surface0 bg-ctp-crust shrink-0"
  onDoubleClick={handleDoubleClick}
>
```

Also add a visual indicator when in focus mode. Subscribe to `layoutState.focusedPanel`:
```typescript
const isFocused = usePreferencesStore((s) => s.layoutState.focusedPanel !== null);
```

When `isFocused` is true, add a subtle visual cue to the header — change the background to `bg-ctp-blue/10` and add a small "Exit focus: Esc" hint text at the end of the header bar (only when focused), using `text-[10px] text-ctp-subtext0`:

```tsx
{isFocused && (
  <span className="ml-auto text-[10px] text-ctp-subtext0 shrink-0">
    Esc to exit focus
  </span>
)}
```

Make sure this hint comes AFTER the existing `trailing` div (or inside the trailing area if no trailing is provided). Place it logically so it doesn't break the existing layout. If `trailing` exists, add the hint after the trailing div. If no `trailing`, show the hint as the rightmost element.

Add `title="Double-click to toggle focus mode"` to the header div for discoverability.

Do NOT modify any other part of BladePanel — keep the children, back button, title, titleContent, and trailing behavior exactly as they are.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — zero new type errors. Visually: open a blade (e.g., commit details), double-click the blade panel header — sidebar should collapse and blade should fill the screen. The header should show "Esc to exit focus" hint. Double-click again — layout should restore.
  </verify>
  <done>
BladePanel header supports double-click to toggle focus mode. Visual indicator ("Esc to exit focus") appears when in focus mode. Focus mode maximizes the blade container by collapsing the sidebar. Double-clicking again exits focus mode.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Escape and toggle-sidebar keyboard shortcuts</name>
  <files>
    src/core/hooks/useKeyboardShortcuts.ts
  </files>
  <action>
**1. Update the Escape key handler:**

In the existing `useHotkeys("escape", ...)` handler, add focus mode exit as priority 2 (between command palette check and blade pop):

```typescript
useHotkeys(
  "escape",
  () => {
    // Priority 1: Don't pop blade if command palette is open
    if (useCommandPaletteStore.getState().paletteIsOpen) return;

    // Priority 2: Exit focus mode if active
    const { layoutState, exitFocusMode } = usePreferencesStore.getState();
    if (layoutState.focusedPanel) {
      exitFocusMode();
      return;
    }

    // Priority 3: Pop blade stack
    getNavigationActor().send({ type: "POP_BLADE" });
  },
  { enableOnFormTags: false },
);
```

Import `usePreferencesStore` (add to existing imports from `../stores/domain/preferences`). The import already exists for `usePreferencesStore` in the keyboard shortcuts file (used by `toggleNavBranchDropdown` in the branches shortcut section — check if it's already imported). If not imported, add: `import { usePreferencesStore } from "../stores/domain/preferences";`

**2. Add toggle sidebar keyboard shortcut:**

Add a new `useHotkeys` call for `mod+\\` (Cmd+Backslash on Mac, Ctrl+Backslash on Windows):

```typescript
// Toggle sidebar visibility
useHotkeys(
  "mod+\\",
  (e) => {
    e.preventDefault();
    if (status) {
      usePreferencesStore.getState().togglePanel("sidebar");
    }
  },
  { preventDefault: true, enabled: !!status },
);
```

Place this after the existing `mod+shift+o` (Clone Repository) shortcut and before the `mod+1` (Show Changes) shortcut, in the "Navigation" group of shortcuts.

**3. Update the JSDoc comment** at the top of the function to include the new shortcuts:
- `Escape`: Exit focus mode (if active), else pop blade
- `Cmd/Ctrl+\`: Toggle sidebar visibility

Do NOT modify any existing shortcut behavior — only add the focus mode priority check to Escape and the new sidebar toggle shortcut.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — zero new type errors. Test: (1) Enter focus mode via double-click, press Escape — focus mode should exit, blade should NOT pop. (2) Press Escape again — blade should pop (normal behavior). (3) Press Cmd+Backslash — sidebar should toggle off. Press again — sidebar should toggle back on.
  </verify>
  <done>
Escape key exits focus mode before popping blade stack (3-priority chain: palette > focus > blade). Cmd+Backslash toggles sidebar visibility. Existing keyboard shortcuts unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignoring pre-existing bindings.ts error)
2. Layout presets apply correctly via View menu: Review (20/80), Commit (30/70), Explore (15/85), Focus (0/100)
3. Double-clicking blade panel header enters focus mode (sidebar collapses, blade fills screen)
4. Pressing Escape while in focus mode exits focus mode (sidebar restores) without popping blade
5. Pressing Escape when NOT in focus mode pops blade (existing behavior preserved)
6. Cmd+Backslash toggles sidebar visibility
7. Manually resizing panels persists sizes and changes preset to "custom"
8. Reset Layout command restores default Review preset (20/80)
9. Panel sizes restore after app restart (Tauri Store persistence via "layout" key)
</verification>

<success_criteria>
- LYOT-01: User selects presets from View menu or command palette; panels resize to preset configuration
- LYOT-02: User double-clicks blade header to maximize; Esc exits focus mode; visual indicator shows "Esc to exit focus"
- LYOT-03: User toggles sidebar via Cmd+Backslash or Toggle Sidebar command; blade container fills remaining space
- LYOT-04: Panel sizes persist across app restart via Tauri Store; Reset Layout restores defaults
- All existing keyboard shortcuts and panel behaviors unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/53-workspace-layout-presets/53-02-SUMMARY.md`
</output>
