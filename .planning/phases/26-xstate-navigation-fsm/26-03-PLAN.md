---
phase: 26-xstate-navigation-fsm
plan: 03
type: execute
wave: 3
depends_on: ["26-02"]
files_modified:
  - src/hooks/useBladeNavigation.ts
  - src/lib/bladeOpener.ts
  - src/components/blades/BladeContainer.tsx
  - src/components/blades/BladeStrip.tsx
  - src/components/blades/ProcessNavigation.tsx
  - src/hooks/useKeyboardShortcuts.ts
  - src/components/Header.tsx
  - src/components/blades/BladeBreadcrumb.tsx
  - src/components/blades/DiffBlade.tsx
  - src/components/blades/RepoBrowserBlade.tsx
  - src/components/markdown/MarkdownLink.tsx
  - src/components/gitflow/GitflowPanel.tsx
  - src/lib/animations.ts
  - src/stores/blades.ts
autonomous: true

must_haves:
  truths:
    - "All blade navigation goes through FSM events -- no direct useBladeStore mutation calls remain"
    - "useBladeNavigation() hook returns same API shape but delegates to FSM actor internally"
    - "BladeContainer reads bladeStack and lastAction from FSM for direction-aware animations"
    - "Keyboard shortcuts (Escape, Backspace) send FSM events via getNavigationActor()"
    - "bladeOpener.ts sends PUSH_BLADE events via getNavigationActor()"
    - "ProcessNavigation sends SWITCH_PROCESS events via FSM actor"
    - "Push animation slides in from right, pop slides in from left, replace crossfades, reset fades"
    - "Screen reader announces navigation action type (Opened/Returned to/Switched to)"
  artifacts:
    - path: "src/hooks/useBladeNavigation.ts"
      provides: "FSM-backed blade navigation hook"
      contains: "useNavigationActorRef"
    - path: "src/lib/bladeOpener.ts"
      provides: "Non-React blade opener using getNavigationActor"
      contains: "getNavigationActor"
    - path: "src/components/blades/BladeContainer.tsx"
      provides: "Direction-aware blade animations driven by FSM lastAction"
      contains: "lastAction"
    - path: "src/lib/animations.ts"
      provides: "Direction-aware blade transition variants"
      contains: "bladeTransitionVariants"
  key_links:
    - from: "src/hooks/useBladeNavigation.ts"
      to: "src/machines/navigation/context.tsx"
      via: "useNavigationActorRef() + useSelector"
      pattern: "useNavigationActorRef"
    - from: "src/lib/bladeOpener.ts"
      to: "src/machines/navigation/context.tsx"
      via: "getNavigationActor().send()"
      pattern: "getNavigationActor"
    - from: "src/components/blades/BladeContainer.tsx"
      to: "src/machines/navigation/selectors.ts"
      via: "selectBladeStack, selectLastAction"
      pattern: "selectBladeStack"
    - from: "src/hooks/useKeyboardShortcuts.ts"
      to: "src/machines/navigation/context.tsx"
      via: "getNavigationActor().send()"
      pattern: "getNavigationActor"
---

<objective>
Migrate all blade store consumers from imperative Zustand calls to FSM events, add direction-aware blade animations, and deprecate the old blade store.

Purpose: This is the big migration plan. Every file that calls `useBladeStore()` or `useBladeStore.getState()` for navigation operations switches to the FSM actor. The old Zustand blade store is deprecated (kept but no longer the source of truth). Direction-aware animations (NAV-09) and enhanced screen reader announcements are added to BladeContainer.

Output: Zero remaining `useBladeStore` calls for navigation. All operations go through FSM events. Direction-aware animations working.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-xstate-navigation-fsm/26-01-SUMMARY.md
@.planning/phases/26-xstate-navigation-fsm/26-02-SUMMARY.md
@.planning/phases/26-xstate-navigation-fsm/26-RESEARCH-UX.md
@.planning/phases/26-xstate-navigation-fsm/26-RESEARCH-IMPLEMENTATION.md

@src/hooks/useBladeNavigation.ts
@src/lib/bladeOpener.ts
@src/components/blades/BladeContainer.tsx
@src/components/blades/BladeStrip.tsx
@src/components/blades/ProcessNavigation.tsx
@src/hooks/useKeyboardShortcuts.ts
@src/components/Header.tsx
@src/components/blades/BladeBreadcrumb.tsx
@src/components/blades/DiffBlade.tsx
@src/components/blades/RepoBrowserBlade.tsx
@src/components/markdown/MarkdownLink.tsx
@src/components/gitflow/GitflowPanel.tsx
@src/stores/blades.ts
@src/lib/animations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate core navigation hooks and bridges to FSM</name>
  <files>
    src/hooks/useBladeNavigation.ts
    src/lib/bladeOpener.ts
    src/hooks/useKeyboardShortcuts.ts
    src/lib/animations.ts
  </files>
  <action>
    **Rewrite `src/hooks/useBladeNavigation.ts`:**
    1. Remove `import { useBladeStore }` -- replace with FSM imports
    2. Import `useNavigationActorRef` from `../machines/navigation/context`
    3. Import `useSelector` from `@xstate/react`
    4. Import selectors from `../machines/navigation/selectors`
    5. Keep the same exported API shape: `openBlade`, `openDiff`, `openStagingDiff`, `goBack`, `goToRoot`, plus all the store spread fields
    6. Internally:
       - `const actorRef = useNavigationActorRef();`
       - `const bladeStack = useSelector(actorRef, selectBladeStack);`
       - `const activeProcess = useSelector(actorRef, selectActiveProcess);`
       - `openBlade<K>` sends `{ type: 'PUSH_BLADE', bladeType, title, props }` -- singleton guard is now in the FSM, remove the local SINGLETON_TYPES check
       - `goBack` sends `{ type: 'POP_BLADE' }`
       - `goToRoot` sends `{ type: 'RESET_STACK' }`
       - `openDiff` and `openStagingDiff` use the same logic but call `actorRef.send()` instead of `store.pushBlade()`
    7. Return object must include: `openBlade`, `openDiff`, `openStagingDiff`, `goBack`, `goToRoot`, `bladeStack`, `activeProcess`, `popBlade`, `popToIndex`, `replaceBlade`, `resetStack`, `setProcess`, `pushBlade` (all delegating to actorRef.send)
    8. The `replaceBlade` function signature needs to match the old one: `replaceBlade({ type, title, props })` -> `actorRef.send({ type: 'REPLACE_BLADE', bladeType, title, props })`
    9. **IMPORTANT:** `pushBlade` in the old API accepts `{ type, title, props }` object. The FSM event uses `bladeType` instead of `type` to avoid collision with XState's event `type` field. Map accordingly.

    **Rewrite `src/lib/bladeOpener.ts`:**
    1. Remove `import { useBladeStore }` -- replace with `import { getNavigationActor } from '../machines/navigation/context'`
    2. Remove the `SINGLETON_TYPES` array (singleton enforcement is in the FSM guard)
    3. `openBlade()` sends `{ type: 'PUSH_BLADE', bladeType: type, title: resolvedTitle, props }` via `getNavigationActor().send()`
    4. Keep the same external function signature

    **Rewrite keyboard shortcuts in `src/hooks/useKeyboardShortcuts.ts`:**
    1. Remove `import { useBladeStore }` (keep `openBlade` from bladeOpener)
    2. Import `getNavigationActor` from `../machines/navigation/context`
    3. Escape handler: `getNavigationActor().send({ type: 'POP_BLADE' })` -- the FSM guard handles root blade protection
    4. Backspace handler: same as Escape
    5. Enter handler (topology commit details): read `activeProcess` and `bladeStack.length` from `getNavigationActor().getSnapshot().context` instead of `useBladeStore.getState()`
    6. The `openBlade` import from bladeOpener still works (it now sends FSM events)

    **Add direction-aware animation variants to `src/lib/animations.ts`:**
    1. Add new export `bladeTransitionVariants`:
    ```typescript
    export type BladeTransitionDirection = 'push' | 'pop' | 'replace' | 'reset' | 'init';

    export const bladeTransitionVariants: Variants = {
      initial: (direction: BladeTransitionDirection) => {
        switch (direction) {
          case 'push': return { x: '100%', opacity: 0 };
          case 'pop': return { x: '-30%', opacity: 0 };
          case 'replace': return { opacity: 0, scale: 0.98 };
          case 'reset': return { opacity: 0, scale: 0.95 };
          default: return { x: 40, opacity: 0 };
        }
      },
      animate: { x: 0, opacity: 1, scale: 1 },
      exit: (direction: BladeTransitionDirection) => {
        switch (direction) {
          case 'push': return { x: '-30%', opacity: 0 };
          case 'pop': return { x: '100%', opacity: 0 };
          case 'replace': return { opacity: 0, scale: 0.98 };
          case 'reset': return { opacity: 0, scale: 0.95 };
          default: return { x: 40, opacity: 0 };
        }
      },
    };

    export const bladeTransitionConfig = {
      push: { type: "tween" as const, ease: "easeOut", duration: 0.2 },
      pop: { type: "tween" as const, ease: "easeOut", duration: 0.18 },
      replace: { type: "tween" as const, ease: "easeInOut", duration: 0.15 },
      reset: { type: "tween" as const, ease: "easeOut", duration: 0.25 },
      init: { type: "tween" as const, ease: "easeOut", duration: 0.2 },
    };
    ```
    2. Keep existing `bladeSlideIn` export for backward compat (other files may reference it)
  </action>
  <verify>
    ```bash
    # Type-check
    npx tsc --noEmit 2>&1 | grep -v "bindings.ts"

    # No useBladeStore in migrated files
    grep -n "useBladeStore" src/hooks/useBladeNavigation.ts src/lib/bladeOpener.ts src/hooks/useKeyboardShortcuts.ts
    # Should return nothing

    # FSM imports present
    grep -n "getNavigationActor\|useNavigationActorRef\|useSelector" src/hooks/useBladeNavigation.ts src/lib/bladeOpener.ts src/hooks/useKeyboardShortcuts.ts
    ```
  </verify>
  <done>
    useBladeNavigation hook delegates to FSM actor. bladeOpener.ts sends FSM events. Keyboard shortcuts send FSM events. Direction-aware animation variants defined. No useBladeStore imports in these files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all component consumers and add direction-aware animations</name>
  <files>
    src/components/blades/BladeContainer.tsx
    src/components/blades/ProcessNavigation.tsx
    src/components/Header.tsx
    src/components/blades/BladeBreadcrumb.tsx
    src/components/blades/DiffBlade.tsx
    src/components/blades/RepoBrowserBlade.tsx
    src/components/markdown/MarkdownLink.tsx
    src/components/gitflow/GitflowPanel.tsx
    src/stores/blades.ts
  </files>
  <action>
    **Rewrite `src/components/blades/BladeContainer.tsx`:**
    1. Remove `import { useBladeStore }` -- use FSM context
    2. Import `useNavigationActorRef` from `../../machines/navigation/context`
    3. Import `useSelector` from `@xstate/react`
    4. Import `selectBladeStack`, `selectLastAction` from `../../machines/navigation/selectors`
    5. Import `bladeTransitionVariants`, `bladeTransitionConfig` from `../../lib/animations`
    6. Import `useReducedMotion` from `framer-motion`
    7. Read state via selectors:
       ```tsx
       const actorRef = useNavigationActorRef();
       const bladeStack = useSelector(actorRef, selectBladeStack);
       const lastAction = useSelector(actorRef, selectLastAction);
       const shouldReduceMotion = useReducedMotion();
       const activeBlade = bladeStack[bladeStack.length - 1];
       ```
    8. Use `AnimatePresence mode="popLayout" custom={lastAction}`:
       ```tsx
       <AnimatePresence mode="popLayout" custom={lastAction}>
         <motion.div
           key={activeBlade.id}
           custom={lastAction}
           variants={bladeTransitionVariants}
           initial="initial"
           animate="animate"
           exit="exit"
           transition={shouldReduceMotion ? { duration: 0 } : bladeTransitionConfig[lastAction] || bladeTransitionConfig.push}
           className="flex-1 min-w-0"
         >
           <BladeRenderer blade={activeBlade} goBack={() => actorRef.send({ type: 'POP_BLADE' })} />
         </motion.div>
       </AnimatePresence>
       ```
    9. popToIndex for strips: `() => actorRef.send({ type: 'POP_TO_INDEX', index })`
    10. Enhanced screen reader announcements (NAV-09 accessibility):
       ```tsx
       <div aria-live="polite" className="sr-only">
         {lastAction === 'push' && `Opened ${activeBlade.title}`}
         {lastAction === 'pop' && `Returned to ${activeBlade.title}`}
         {lastAction === 'replace' && `Switched to ${activeBlade.title}`}
         {lastAction === 'reset' && `Navigated to ${activeBlade.title}`}
       </div>
       ```

    **Migrate `src/components/blades/ProcessNavigation.tsx`:**
    1. Remove `import { useBladeStore }` and `import type { ProcessType }`
    2. Import `useNavigationActorRef` and `useSelector` from FSM
    3. Import `selectActiveProcess` from selectors
    4. Import `ProcessType` from `../../machines/navigation/types`
    5. Read: `const actorRef = useNavigationActorRef(); const activeProcess = useSelector(actorRef, selectActiveProcess);`
    6. setProcess: `() => actorRef.send({ type: 'SWITCH_PROCESS', process: id })`

    **Migrate remaining component consumers:**
    These components currently use `useBladeNavigation()` hook or `useBladeStore()` directly. For components using `useBladeNavigation()`, they need NO changes (the hook internals changed in Task 1). Only fix components with DIRECT `useBladeStore` imports:

    - `src/components/Header.tsx`: Check if it imports `useBladeStore` directly. If so, switch to `useBladeNavigation()` or direct FSM calls. The Header uses `resetStack` and `openBlade` -- both available through `useBladeNavigation()`.
    - `src/components/blades/BladeBreadcrumb.tsx`: Uses `useBladeStore()` for `popToIndex` and `replaceBlade`. Switch to `useBladeNavigation()` hook (which now delegates to FSM).
    - `src/components/blades/DiffBlade.tsx`: Uses `useBladeStore()` for `replaceBlade`. Switch to `useBladeNavigation()`.
    - `src/components/blades/RepoBrowserBlade.tsx`: Uses `useBladeStore()` for `pushBlade` and `replaceBlade`. Switch to `useBladeNavigation()`.
    - `src/components/markdown/MarkdownLink.tsx`: Uses `useBladeStore()` for `replaceBlade` and `pushBlade`. Switch to `useBladeNavigation()`.
    - `src/components/gitflow/GitflowPanel.tsx`: Already uses `useBladeNavigation()` -- no change needed.

    **Deprecate `src/stores/blades.ts`:**
    1. Add a deprecation comment at the top: `/** @deprecated Use NavigationProvider + useBladeNavigation() or getNavigationActor(). This store is kept for backward compat during migration. */`
    2. Do NOT delete it yet -- some tests or edge cases may still reference it
    3. Verify no remaining `useBladeStore` imports exist in non-test, non-store files

    **After all migrations, verify no `useBladeStore` imports remain in component/hook/lib files** (test files and the store definition itself are exempt).
  </action>
  <verify>
    ```bash
    # No useBladeStore in components/hooks/lib (excluding tests and the store itself)
    grep -rn "useBladeStore" src/ --include="*.ts" --include="*.tsx" | grep -v "test\|__mocks__\|stores/blades.ts\|stores/blades.test"

    # Type-check
    npx tsc --noEmit 2>&1 | grep -v "bindings.ts"

    # Build succeeds
    npx vite build 2>&1 | tail -5

    # All tests pass
    npx vitest run
    ```
  </verify>
  <done>
    All component consumers migrated to FSM. BladeContainer uses direction-aware animations driven by lastAction. ProcessNavigation sends SWITCH_PROCESS events. Screen reader announces navigation type. No useBladeStore imports in component/hook/lib files (only in deprecated store definition and tests). App builds and all tests pass.
  </done>
</task>

</tasks>

<verification>
```bash
# Zero useBladeStore imports in production code (excluding store def and old tests)
grep -rn "useBladeStore" src/ --include="*.ts" --include="*.tsx" | grep -v "stores/blades\|test\|__mocks__"

# FSM is the source of truth
grep -rn "getNavigationActor\|useNavigationActorRef" src/ --include="*.ts" --include="*.tsx" | wc -l
# Should be > 5

# Build passes
npx vite build 2>&1 | tail -5

# All tests pass
npx vitest run

# Direction-aware animations present
grep "bladeTransitionVariants\|lastAction" src/components/blades/BladeContainer.tsx
```
</verification>

<success_criteria>
- Zero `useBladeStore` calls in production code (components, hooks, lib)
- useBladeNavigation() hook returns same API shape, delegates to FSM
- bladeOpener.ts uses getNavigationActor().send()
- Keyboard shortcuts use getNavigationActor().send()
- BladeContainer shows direction-aware animations (push=right, pop=left, replace=crossfade, reset=fade-scale)
- AnimatePresence uses custom prop for exit animation direction
- Screen reader announcements include action type
- ProcessNavigation sends SWITCH_PROCESS FSM event
- useReducedMotion respected for accessibility
- App builds without errors
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/26-xstate-navigation-fsm/26-03-SUMMARY.md`
</output>
