---
phase: 07-worktree-management
plan: 04
type: execute
wave: 4
depends_on: ["07-03"]
files_modified:
  - src/components/worktree/CreateWorktreeDialog.tsx
  - src/components/worktree/DeleteWorktreeDialog.tsx
  - src/components/worktree/index.ts
  - src/components/RepositoryView.tsx
autonomous: false

must_haves:
  truths:
    - "User can create a new worktree from any branch via dialog"
    - "User can select worktree directory using native picker"
    - "User can delete a worktree with confirmation dialog"
    - "Delete dialog offers branch deletion option when appropriate"
  artifacts:
    - path: "src/components/worktree/CreateWorktreeDialog.tsx"
      provides: "Worktree creation dialog"
      exports: ["CreateWorktreeDialog"]
    - path: "src/components/worktree/DeleteWorktreeDialog.tsx"
      provides: "Worktree deletion confirmation dialog"
      exports: ["DeleteWorktreeDialog"]
  key_links:
    - from: "src/components/worktree/CreateWorktreeDialog.tsx"
      to: "@tauri-apps/plugin-dialog"
      via: "open() for directory picker"
      pattern: "open\\(.*directory.*true"
    - from: "src/components/worktree/CreateWorktreeDialog.tsx"
      to: "src/stores/worktrees.ts"
      via: "createWorktree action"
      pattern: "createWorktree"
---

<objective>
Implement the CreateWorktreeDialog and DeleteWorktreeDialog components with directory picker integration.

Purpose: Complete the worktree management UI with creation and deletion flows that meet all requirements.
Output: Functional dialogs for creating and deleting worktrees with proper UX patterns.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-worktree-management/07-RESEARCH.md
@.planning/phases/07-worktree-management/07-03-SUMMARY.md
@src/components/ui/dialog.tsx
@src/components/branches/CreateBranchDialog.tsx
@src/components/worktree/WorktreePanel.tsx
@src/stores/worktrees.ts
@src/stores/branches.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CreateWorktreeDialog component</name>
  <files>src/components/worktree/CreateWorktreeDialog.tsx, src/components/worktree/index.ts</files>
  <action>
Create `src/components/worktree/CreateWorktreeDialog.tsx`:

```tsx
import { open } from "@tauri-apps/plugin-dialog";
import { Folder } from "lucide-react";
import { useState, useEffect } from "react";
import { useBranchStore } from "../../stores/branches";
import { useWorktreeStore } from "../../stores/worktrees";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "../ui/dialog";
import { Button } from "../ui/button";
import { Input } from "../ui/input";

interface CreateWorktreeDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function CreateWorktreeDialog({
  open: isOpen,
  onOpenChange,
}: CreateWorktreeDialogProps) {
  const { branches, loadBranches } = useBranchStore();
  const { createWorktree, isLoading, error, clearError } = useWorktreeStore();

  const [name, setName] = useState("");
  const [path, setPath] = useState("");
  const [selectedBranch, setSelectedBranch] = useState<string>("");
  const [createNewBranch, setCreateNewBranch] = useState(false);
  const [newBranchName, setNewBranchName] = useState("");

  // Load branches when dialog opens
  useEffect(() => {
    if (isOpen) {
      loadBranches();
      clearError();
    }
  }, [isOpen, loadBranches, clearError]);

  // Reset form when dialog closes
  useEffect(() => {
    if (!isOpen) {
      setName("");
      setPath("");
      setSelectedBranch("");
      setCreateNewBranch(false);
      setNewBranchName("");
    }
  }, [isOpen]);

  const handleSelectDirectory = async () => {
    const selected = await open({
      directory: true,
      multiple: false,
      title: "Select Worktree Location",
    });
    if (selected && typeof selected === "string") {
      setPath(selected);
      // Auto-fill name from directory name if empty
      if (!name) {
        const dirName = selected.split(/[/\\]/).pop() || "";
        setName(dirName);
      }
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!name.trim() || !path.trim()) return;

    const result = await createWorktree({
      name: name.trim(),
      path: path.trim(),
      branch: createNewBranch ? newBranchName.trim() : selectedBranch || null,
      createBranch: createNewBranch,
    });

    if (result) {
      onOpenChange(false);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Create Worktree</DialogTitle>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-4">
          {/* Worktree Name */}
          <div>
            <label htmlFor="wt-name" className="block text-sm text-ctp-subtext0 mb-1">
              Worktree Name
            </label>
            <Input
              id="wt-name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="feature-worktree"
              autoFocus
            />
          </div>

          {/* Directory Selection */}
          <div>
            <label className="block text-sm text-ctp-subtext0 mb-1">
              Directory
            </label>
            <div className="flex gap-2">
              <Input
                value={path}
                onChange={(e) => setPath(e.target.value)}
                placeholder="/path/to/worktree"
                className="flex-1"
              />
              <Button
                type="button"
                variant="secondary"
                onClick={handleSelectDirectory}
              >
                <Folder className="w-4 h-4" />
              </Button>
            </div>
          </div>

          {/* Branch Selection */}
          <div>
            <label className="block text-sm text-ctp-subtext0 mb-1">
              Branch
            </label>
            
            <label className="flex items-center gap-2 text-sm mb-2">
              <input
                type="checkbox"
                checked={createNewBranch}
                onChange={(e) => setCreateNewBranch(e.target.checked)}
                className="rounded"
              />
              <span>Create new branch</span>
            </label>

            {createNewBranch ? (
              <Input
                value={newBranchName}
                onChange={(e) => setNewBranchName(e.target.value)}
                placeholder="new-branch-name"
              />
            ) : (
              <select
                value={selectedBranch}
                onChange={(e) => setSelectedBranch(e.target.value)}
                className="w-full px-3 py-2 bg-ctp-surface0 border border-ctp-surface1 rounded text-sm focus:outline-none focus:border-ctp-blue"
              >
                <option value="">Use current HEAD</option>
                {branches.map((branch) => (
                  <option key={branch.name} value={branch.name}>
                    {branch.name}
                    {branch.isHead && " (current)"}
                  </option>
                ))}
              </select>
            )}
          </div>

          {/* Error Display */}
          {error && <p className="text-ctp-red text-sm">{error}</p>}

          <DialogFooter>
            <Button
              type="button"
              variant="ghost"
              onClick={() => onOpenChange(false)}
            >
              Cancel
            </Button>
            <Button
              type="submit"
              disabled={!name.trim() || !path.trim() || isLoading}
            >
              {isLoading ? "Creating..." : "Create"}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```

Update `src/components/worktree/index.ts` to export:
```typescript
export { CreateWorktreeDialog } from "./CreateWorktreeDialog";
```
  </action>
  <verify>
    - TypeScript compiles without errors
    - Dialog opens and shows form fields
    - Directory picker button opens native dialog
  </verify>
  <done>CreateWorktreeDialog with branch selection and directory picker</done>
</task>

<task type="auto">
  <name>Task 2: Create DeleteWorktreeDialog component</name>
  <files>src/components/worktree/DeleteWorktreeDialog.tsx, src/components/worktree/index.ts</files>
  <action>
Create `src/components/worktree/DeleteWorktreeDialog.tsx`:

```tsx
import { AlertTriangle } from "lucide-react";
import { useState, useMemo } from "react";
import { useWorktreeStore } from "../../stores/worktrees";
import { useBranchStore } from "../../stores/branches";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "../ui/dialog";
import { Button } from "../ui/button";

interface DeleteWorktreeDialogProps {
  worktreeName: string | null;
  onOpenChange: (open: boolean) => void;
}

export function DeleteWorktreeDialog({
  worktreeName,
  onOpenChange,
}: DeleteWorktreeDialogProps) {
  const { worktrees, deleteWorktree, isLoading, error, clearError } = useWorktreeStore();
  const { branches } = useBranchStore();
  
  const [deleteBranch, setDeleteBranch] = useState(false);
  const [forceDelete, setForceDelete] = useState(false);

  const worktree = useMemo(
    () => worktrees.find((wt) => wt.name === worktreeName),
    [worktrees, worktreeName]
  );

  // Check if branch is merged (can be safely deleted)
  const branchInfo = useMemo(() => {
    if (!worktree?.branch) return null;
    return branches.find((b) => b.name === worktree.branch);
  }, [branches, worktree]);

  const canDeleteBranch = branchInfo?.isMerged === true;
  const isDirty = worktree?.status === "Dirty" || worktree?.status === "Conflicts";

  const handleDelete = async () => {
    if (!worktreeName) return;
    
    const success = await deleteWorktree(
      worktreeName,
      forceDelete,
      deleteBranch
    );
    
    if (success) {
      onOpenChange(false);
      setDeleteBranch(false);
      setForceDelete(false);
    }
  };

  const handleClose = () => {
    onOpenChange(false);
    clearError();
    setDeleteBranch(false);
    setForceDelete(false);
  };

  return (
    <Dialog open={!!worktreeName} onOpenChange={handleClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Delete Worktree</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          {/* Warning for dirty worktree */}
          {isDirty && (
            <div className="flex items-start gap-3 p-3 bg-ctp-yellow/10 border border-ctp-yellow/30 rounded">
              <AlertTriangle className="w-5 h-5 text-ctp-yellow shrink-0 mt-0.5" />
              <div className="text-sm">
                <p className="font-medium text-ctp-yellow">
                  This worktree has uncommitted changes
                </p>
                <p className="text-ctp-subtext0 mt-1">
                  {worktree?.status === "Conflicts" 
                    ? "There are unresolved merge conflicts."
                    : "You may lose work if you proceed."}
                </p>
              </div>
            </div>
          )}

          <p className="text-sm text-ctp-text">
            Are you sure you want to delete the worktree{" "}
            <span className="font-medium">"{worktreeName}"</span>?
          </p>

          {worktree?.path && (
            <p className="text-xs text-ctp-subtext0 font-mono bg-ctp-surface0 p-2 rounded">
              {worktree.path}
            </p>
          )}

          {/* Force delete option for dirty worktrees */}
          {isDirty && (
            <label className="flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                checked={forceDelete}
                onChange={(e) => setForceDelete(e.target.checked)}
                className="rounded"
              />
              <span className="text-ctp-red">Force delete (discard uncommitted changes)</span>
            </label>
          )}

          {/* Delete branch option */}
          {worktree?.branch && !worktree.isMain && (
            <label className="flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                checked={deleteBranch}
                onChange={(e) => setDeleteBranch(e.target.checked)}
                className="rounded"
                disabled={!canDeleteBranch}
              />
              <span className={!canDeleteBranch ? "text-ctp-overlay0" : ""}>
                Also delete branch "{worktree.branch}"
                {!canDeleteBranch && " (not fully merged)"}
              </span>
            </label>
          )}

          {/* Error Display */}
          {error && <p className="text-ctp-red text-sm">{error}</p>}
        </div>

        <DialogFooter>
          <Button type="button" variant="ghost" onClick={handleClose}>
            Cancel
          </Button>
          <Button
            type="button"
            variant="destructive"
            onClick={handleDelete}
            disabled={isLoading || (isDirty && !forceDelete)}
          >
            {isLoading ? "Deleting..." : "Delete"}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

Update `src/components/worktree/index.ts`:
```typescript
export { WorktreeItem } from "./WorktreeItem";
export { WorktreePanel } from "./WorktreePanel";
export { CreateWorktreeDialog } from "./CreateWorktreeDialog";
export { DeleteWorktreeDialog } from "./DeleteWorktreeDialog";
```
  </action>
  <verify>
    - TypeScript compiles without errors
    - Dialog shows warning for dirty worktrees
    - Branch deletion option disabled if not merged
    - Force delete required for dirty worktrees
  </verify>
  <done>DeleteWorktreeDialog with branch deletion option and dirty worktree handling</done>
</task>

<task type="auto">
  <name>Task 3: Wire dialogs into RepositoryView</name>
  <files>src/components/RepositoryView.tsx</files>
  <action>
1. Update imports in RepositoryView.tsx:
```typescript
import { CreateWorktreeDialog, DeleteWorktreeDialog, WorktreePanel } from "./worktree";
```

2. Ensure state for dialogs exists (may already be there from Plan 03):
```typescript
const [showWorktreeDialog, setShowWorktreeDialog] = useState(false);
const [worktreeToDelete, setWorktreeToDelete] = useState<string | null>(null);
```

3. Add dialogs at the end of the component, before the closing tag:
```tsx
{/* Worktree Dialogs */}
<CreateWorktreeDialog
  open={showWorktreeDialog}
  onOpenChange={setShowWorktreeDialog}
/>
<DeleteWorktreeDialog
  worktreeName={worktreeToDelete}
  onOpenChange={(open) => !open && setWorktreeToDelete(null)}
/>
```

4. Update WorktreePanel props to pass the delete handler:
```tsx
<WorktreePanel
  showCreateDialog={showWorktreeDialog}
  onCloseCreateDialog={() => setShowWorktreeDialog(false)}
  onOpenDeleteDialog={(name) => setWorktreeToDelete(name)}
/>
```
  </action>
  <verify>
    - `pnpm tauri dev` runs without errors
    - Click "+" in Worktrees header -> CreateWorktreeDialog opens
    - Click delete button on worktree -> DeleteWorktreeDialog opens
    - Creating worktree refreshes list
    - Deleting worktree removes it from list
  </verify>
  <done>Dialogs wired up and functional in RepositoryView</done>
</task>

</tasks>

<verification>
Complete end-to-end testing:
1. Open app and navigate to a git repository
2. Expand Worktrees section - see main worktree and any existing linked worktrees
3. Click "+" to create new worktree:
   - Select directory via picker
   - Choose existing branch or create new
   - Click Create - worktree appears in list
4. Click delete on a worktree:
   - See confirmation dialog
   - If dirty, see warning and force option
   - If branch merged, see delete branch option
   - Confirm deletion - worktree removed
5. Click "Open in explorer" - file explorer opens to worktree path
6. Click "Switch to" - app context switches to that worktree's repo
</verification>

<success_criteria>
- WORK-04: User can create a new worktree from any branch (two-click flow) - DONE
- WORK-05: User can specify worktree directory location - DONE
- WORK-06: User can delete a worktree with cleanup confirmation - DONE
- WORK-07: Deleting a worktree offers to delete the linked branch if fully merged - DONE
All requirements WORK-01 through WORK-09 are now complete.
</success_criteria>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete worktree management feature with panel, create dialog, delete dialog, context switching, and explorer integration</what-built>
  <how-to-verify>
    1. Open app with a git repository
    2. Check Worktrees section shows main worktree with status
    3. Create a new worktree:
       - Click "+" button
       - Click folder icon, select a directory
       - Choose "Create new branch" and name it
       - Click Create
    4. Verify new worktree appears in list with correct branch
    5. Click "Open in explorer" - native file browser opens
    6. Click "Switch to" - app reloads with new worktree as context
    7. Delete the test worktree:
       - Click delete icon
       - If branch merged, check "Also delete branch"
       - Click Delete
    8. Verify worktree removed from list
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/07-worktree-management/07-04-SUMMARY.md`
</output>
