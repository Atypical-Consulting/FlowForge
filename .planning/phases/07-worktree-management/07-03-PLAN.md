---
phase: 07-worktree-management
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - src/components/worktree/WorktreeItem.tsx
  - src/components/worktree/WorktreePanel.tsx
  - src/components/worktree/index.ts
  - src/components/RepositoryView.tsx
autonomous: true

must_haves:
  truths:
    - "User sees all active worktrees in the sidebar panel"
    - "Each worktree shows branch name and status indicator"
    - "User can expand/collapse the Worktrees section"
    - "Status colors match: green=clean, yellow=dirty, red=conflicts"
  artifacts:
    - path: "src/components/worktree/WorktreeItem.tsx"
      provides: "Single worktree row component"
      exports: ["WorktreeItem"]
    - path: "src/components/worktree/WorktreePanel.tsx"
      provides: "Worktree list panel"
      exports: ["WorktreePanel"]
    - path: "src/components/RepositoryView.tsx"
      provides: "Sidebar with Worktrees section"
      contains: "WorktreePanel"
  key_links:
    - from: "src/components/worktree/WorktreePanel.tsx"
      to: "src/stores/worktrees.ts"
      via: "useWorktreeStore hook"
      pattern: "useWorktreeStore"
    - from: "src/components/RepositoryView.tsx"
      to: "src/components/worktree/WorktreePanel.tsx"
      via: "import and render"
      pattern: "WorktreePanel"
---

<objective>
Create the WorktreePanel and WorktreeItem components and integrate into the sidebar.

Purpose: Provide visual worktree management UI that matches the existing sidebar patterns (Branches, Stash, Tags).
Output: WorktreePanel in sidebar showing all worktrees with status, branch info, and action buttons.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-worktree-management/07-RESEARCH.md
@.planning/phases/07-worktree-management/07-02-SUMMARY.md
@src/components/RepositoryView.tsx
@src/components/branches/BranchItem.tsx
@src/components/stash/StashList.tsx
@src/stores/worktrees.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorktreeItem component</name>
  <files>src/components/worktree/WorktreeItem.tsx, src/components/worktree/index.ts</files>
  <action>
1. Create directory `src/components/worktree/`

2. Create `src/components/worktree/WorktreeItem.tsx`:

```tsx
import { FolderGit2, ExternalLink, Trash2, ArrowRightLeft, Home } from "lucide-react";
import type { WorktreeInfo } from "../../bindings";
import { cn } from "../../lib/utils";

interface WorktreeItemProps {
  worktree: WorktreeInfo;
  isSelected: boolean;
  onSelect: () => void;
  onOpenInExplorer: () => void;
  onSwitchTo: () => void;
  onDelete: () => void;
}

const statusColors = {
  Clean: "text-ctp-green",
  Dirty: "text-ctp-yellow", 
  Conflicts: "text-ctp-red",
  Invalid: "text-ctp-overlay0",
};

const statusLabels = {
  Clean: "Clean",
  Dirty: "Uncommitted changes",
  Conflicts: "Has conflicts",
  Invalid: "Invalid worktree",
};

export function WorktreeItem({
  worktree,
  isSelected,
  onSelect,
  onOpenInExplorer,
  onSwitchTo,
  onDelete,
}: WorktreeItemProps) {
  return (
    <div
      className={cn(
        "group px-3 py-2 cursor-pointer transition-colors",
        "hover:bg-ctp-surface0/50",
        isSelected && "bg-ctp-surface0"
      )}
      onClick={onSelect}
    >
      <div className="flex items-center gap-2">
        {/* Icon */}
        <div className={cn("shrink-0", statusColors[worktree.status])}>
          {worktree.isMain ? (
            <Home className="w-4 h-4" />
          ) : (
            <FolderGit2 className="w-4 h-4" />
          )}
        </div>

        {/* Name and branch */}
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-1.5">
            <span className="font-medium text-sm truncate">{worktree.name}</span>
            {worktree.isMain && (
              <span className="text-[10px] px-1.5 py-0.5 rounded bg-ctp-surface1 text-ctp-subtext0">
                main
              </span>
            )}
          </div>
          {worktree.branch && (
            <div className="text-xs text-ctp-subtext0 truncate">
              {worktree.branch}
            </div>
          )}
        </div>

        {/* Status indicator */}
        <div
          className={cn("w-2 h-2 rounded-full shrink-0", {
            "bg-ctp-green": worktree.status === "Clean",
            "bg-ctp-yellow": worktree.status === "Dirty",
            "bg-ctp-red": worktree.status === "Conflicts",
            "bg-ctp-overlay0": worktree.status === "Invalid",
          })}
          title={statusLabels[worktree.status]}
        />

        {/* Action buttons (show on hover) */}
        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
          {!worktree.isMain && (
            <button
              type="button"
              onClick={(e) => {
                e.stopPropagation();
                onSwitchTo();
              }}
              className="p-1 hover:bg-ctp-surface1 rounded text-ctp-subtext0 hover:text-ctp-text"
              title="Switch to this worktree"
            >
              <ArrowRightLeft className="w-3.5 h-3.5" />
            </button>
          )}
          <button
            type="button"
            onClick={(e) => {
              e.stopPropagation();
              onOpenInExplorer();
            }}
            className="p-1 hover:bg-ctp-surface1 rounded text-ctp-subtext0 hover:text-ctp-text"
            title="Open in file explorer"
          >
            <ExternalLink className="w-3.5 h-3.5" />
          </button>
          {!worktree.isMain && (
            <button
              type="button"
              onClick={(e) => {
                e.stopPropagation();
                onDelete();
              }}
              className="p-1 hover:bg-ctp-red/20 rounded text-ctp-subtext0 hover:text-ctp-red"
              title="Delete worktree"
            >
              <Trash2 className="w-3.5 h-3.5" />
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
```

3. Create `src/components/worktree/index.ts`:
```typescript
export { WorktreeItem } from "./WorktreeItem";
export { WorktreePanel } from "./WorktreePanel";
```
  </action>
  <verify>
    - TypeScript compiles without errors
    - Component renders worktree info correctly
  </verify>
  <done>WorktreeItem displays name, branch, status with action buttons</done>
</task>

<task type="auto">
  <name>Task 2: Create WorktreePanel component</name>
  <files>src/components/worktree/WorktreePanel.tsx</files>
  <action>
Create `src/components/worktree/WorktreePanel.tsx`:

```tsx
import { useEffect, useState } from "react";
import { useWorktreeStore } from "../../stores/worktrees";
import { WorktreeItem } from "./WorktreeItem";

interface WorktreePanelProps {
  showCreateDialog: boolean;
  onCloseCreateDialog: () => void;
  onOpenDeleteDialog: (worktreeName: string) => void;
}

export function WorktreePanel({
  showCreateDialog,
  onCloseCreateDialog,
  onOpenDeleteDialog,
}: WorktreePanelProps) {
  const {
    worktrees,
    isLoading,
    error,
    selectedWorktree,
    loadWorktrees,
    selectWorktree,
    openInExplorer,
    switchToWorktree,
    clearError,
  } = useWorktreeStore();

  const [worktreeToDelete, setWorktreeToDelete] = useState<string | null>(null);

  // Load worktrees on mount and when repository changes
  useEffect(() => {
    loadWorktrees();
  }, [loadWorktrees]);

  if (isLoading && worktrees.length === 0) {
    return (
      <div className="p-3 text-ctp-subtext0 text-sm">
        Loading worktrees...
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-3">
        <div className="text-ctp-red text-sm mb-2">{error}</div>
        <button
          type="button"
          onClick={clearError}
          className="text-xs text-ctp-subtext0 hover:text-ctp-text"
        >
          Dismiss
        </button>
      </div>
    );
  }

  if (worktrees.length === 0) {
    return (
      <div className="p-3 text-ctp-subtext0 text-sm">
        No worktrees found
      </div>
    );
  }

  return (
    <div className="divide-y divide-ctp-surface0">
      {worktrees.map((worktree) => (
        <WorktreeItem
          key={worktree.name}
          worktree={worktree}
          isSelected={selectedWorktree === worktree.name}
          onSelect={() => selectWorktree(worktree.name)}
          onOpenInExplorer={() => openInExplorer(worktree.path)}
          onSwitchTo={() => switchToWorktree(worktree.path)}
          onDelete={() => onOpenDeleteDialog(worktree.name)}
        />
      ))}
    </div>
  );
}
```

Note: CreateWorktreeDialog and DeleteWorktreeDialog will be implemented in Plan 04.
  </action>
  <verify>
    - TypeScript compiles without errors
    - Panel renders list of worktrees
    - Loading and error states display correctly
  </verify>
  <done>WorktreePanel shows all worktrees with loading/error states</done>
</task>

<task type="auto">
  <name>Task 3: Integrate WorktreePanel into RepositoryView sidebar</name>
  <files>src/components/RepositoryView.tsx</files>
  <action>
1. Add imports to RepositoryView.tsx:
```typescript
import { FolderGit2 } from "lucide-react";
import { WorktreePanel } from "./worktree";
```

2. Add state for worktree dialogs:
```typescript
const [showWorktreeDialog, setShowWorktreeDialog] = useState(false);
const [worktreeToDelete, setWorktreeToDelete] = useState<string | null>(null);
```

3. Add Worktrees section to the left sidebar, after the Gitflow section:
```tsx
{/* Worktrees section */}
<details className="border-b border-ctp-surface0">
  <summary className="p-3 cursor-pointer hover:bg-ctp-surface0/50 flex items-center gap-2 select-none sticky top-0 bg-ctp-base z-10">
    <FolderGit2 className="w-4 h-4" />
    <span className="font-semibold text-sm flex-1">Worktrees</span>
    <button
      type="button"
      onClick={(e) => {
        e.preventDefault();
        setShowWorktreeDialog(true);
      }}
      className="p-1 hover:bg-ctp-surface1 rounded text-ctp-subtext0 hover:text-ctp-text"
      title="Create new worktree"
    >
      <Plus className="w-3.5 h-3.5" />
    </button>
  </summary>
  <div className="max-h-64 overflow-y-auto">
    <WorktreePanel
      showCreateDialog={showWorktreeDialog}
      onCloseCreateDialog={() => setShowWorktreeDialog(false)}
      onOpenDeleteDialog={(name) => setWorktreeToDelete(name)}
    />
  </div>
</details>
```

4. Follow the exact same pattern as Branches, Stash, Tags sections for consistency.
  </action>
  <verify>
    - `pnpm tauri dev` shows Worktrees section in sidebar
    - Section expands/collapses correctly
    - "+" button is visible in section header
    - Worktrees list renders inside section
  </verify>
  <done>Worktrees section visible in sidebar matching other sections' pattern</done>
</task>

</tasks>

<verification>
- `pnpm tauri dev` shows application with Worktrees in sidebar
- WorktreeItem displays name, branch, status dot, and action buttons
- WorktreePanel lists all worktrees from the store
- Clicking worktree selects it
- "Open in explorer" button works (opens file explorer)
- "Switch to" button triggers context switch
</verification>

<success_criteria>
- WORK-01: Worktree panel displays all active worktrees - DONE
- WORK-02: Each worktree shows its linked branch name - DONE
- WORK-03: Each worktree shows its status (clean/dirty/conflicts) - DONE
- WORK-08: User can open a worktree in system file explorer - DONE (button works)
- WORK-09: User can switch context to a different worktree - DONE (button triggers action)
</success_criteria>

<output>
After completion, create `.planning/phases/07-worktree-management/07-03-SUMMARY.md`
</output>
