---
phase: 08-polish-performance
plan: 06
type: execute
wave: 4
depends_on: ["08-01", "08-02", "08-03", "08-04", "08-05"]
files_modified:
  - src-tauri/Cargo.toml
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Release binary is under 50MB"
    - "Application uses under 200MB memory at idle"
    - "Common operations complete in under 100ms"
    - "File watcher events trigger UI refresh"
  artifacts:
    - path: "src-tauri/Cargo.toml"
      provides: "Optimized release profile"
      contains: "lto = true"
  key_links:
    - from: "src/App.tsx"
      to: "repository-changed event"
      via: "listen + invalidateQueries"
      pattern: "repository-changed"
---

<objective>
Configure Cargo release profile for binary size optimization and integrate file watcher with frontend refresh.

Purpose: Fulfills PERF-01 (operation speed), PERF-02 (memory), PERF-03 (binary size). Final polish before release.
Output: Optimized release build and working file watcher integration.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-polish-performance/08-RESEARCH.md
@.planning/phases/08-polish-performance/08-02-SUMMARY.md

@src-tauri/Cargo.toml
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Cargo release profile and integrate file watcher</name>
  <files>
    - src-tauri/Cargo.toml
    - src/App.tsx
  </files>
  <action>
1. Update `src-tauri/Cargo.toml` with optimized release profile:

```toml
[profile.release]
# Link-time optimization for smaller binary
lto = true
# Single codegen unit for better optimization
codegen-units = 1
# Strip symbols from binary
strip = true
# Optimize for size
opt-level = "s"
# Abort on panic (smaller than unwind)
panic = "abort"
```

Note: These settings will increase build time but significantly reduce binary size.

2. Update `src/App.tsx` to listen for file watcher events:

```typescript
import { listen } from "@tauri-apps/api/event";
import { useQueryClient } from "@tanstack/react-query";

function App() {
  const queryClient = useQueryClient();
  const initTheme = useThemeStore((s) => s.initTheme);
  const { status } = useRepositoryStore();
  
  // Register global keyboard shortcuts
  useKeyboardShortcuts();
  
  useEffect(() => {
    initTheme();
  }, [initTheme]);
  
  // Listen for file watcher events
  useEffect(() => {
    if (!status) return;
    
    const unlisten = listen<{ paths: string[] }>("repository-changed", (event) => {
      console.log("Repository changed:", event.payload.paths);
      
      // Invalidate relevant queries to trigger refresh
      queryClient.invalidateQueries({ queryKey: ["stagingStatus"] });
      queryClient.invalidateQueries({ queryKey: ["commitHistory"] });
    });
    
    return () => {
      unlisten.then((fn) => fn());
    };
  }, [status, queryClient]);

  return (
    // ... rest of component
  );
}
```

The file watcher backend (from 08-02) emits `repository-changed` events. This listener invalidates React Query caches, triggering automatic refetch of staging status and commit history.
  </action>
  <verify>
1. Build release: `npm run tauri build`
2. Check binary size (should be under 50MB)
3. Open app, open repo
4. In terminal, modify a file: `echo "test" >> some-file.txt`
5. Verify staging panel updates within ~500ms without manual refresh
  </verify>
  <done>Release profile optimized and file watcher integrated with frontend</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 8: Polish & Performance implementation:
- Theme toggle (Light/Dark/System) with persistence
- Keyboard shortcuts for common operations
- Commit search by message text
- Undo last Git operation
- File watcher for external changes
- Release build optimization
  </what-built>
  <how-to-verify>
**Build and Test:**

1. Build release version:
   ```bash
   npm run tauri build
   ```

2. **Binary size (PERF-03):**
   ```bash
   ls -lh src-tauri/target/release/bundle/macos/FlowForge.app
   # Or check DMG/installer size
   ```
   Expected: Under 50MB

3. **Theme toggle (UX-02, UX-03):**
   - Launch app
   - Click theme toggle in header
   - Toggle Light -> Dark -> System
   - Close and reopen app - theme should persist
   - No flash of wrong theme on load

4. **Keyboard shortcuts (UX-04):**
   - Open a repo with changes
   - Press Cmd+Shift+A (stage all)
   - Press Cmd+Shift+P (push)
   - Press Cmd+O (open repo picker)
   - Hover over buttons to see shortcut hints

5. **Commit search (UX-05):**
   - Open repo with commits
   - Type in search box above commit list
   - See results filter in real-time
   - Clear search to see all commits

6. **Undo operation (UX-06):**
   - Make a commit
   - Click undo button in header
   - Confirm in dialog
   - See commit reversed

7. **File watcher (PERF-05):**
   - Open a repo
   - In terminal, modify a file: `echo "test" >> README.md`
   - Staging panel should update within ~500ms (no manual refresh)

8. **Memory usage (PERF-02):**
   - Open Activity Monitor (Mac) or Task Manager (Windows)
   - With app idle and repo open, memory should be under 200MB

9. **Operation speed (PERF-01):**
   - Operations should feel instant (<100ms)
   - No perceptible lag on stage, commit, search
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Release binary under 50MB (PERF-03)
2. Memory under 200MB at idle (PERF-02)
3. Operations feel instant (PERF-01)
4. File watcher triggers refresh within 500ms (PERF-05)
5. Theme toggle works with persistence (UX-02, UX-03)
6. Keyboard shortcuts work (UX-04)
7. Commit search works (UX-05)
8. Undo works (UX-06)
</verification>

<success_criteria>
- All UX requirements (UX-01 through UX-09) satisfied
- All PERF requirements (PERF-01 through PERF-05) satisfied
- Application ready for v1.0 release
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-performance/08-06-SUMMARY.md`
</output>
