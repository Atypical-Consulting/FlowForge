---
phase: 08-polish-performance
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - package.json
  - src/hooks/useKeyboardShortcuts.ts
  - src/App.tsx
  - src/components/staging/StagingPanel.tsx
  - src/components/sync/SyncButtons.tsx
autonomous: true

must_haves:
  truths:
    - "User can stage all files with Cmd/Ctrl+Shift+A"
    - "User can commit staged files with Cmd/Ctrl+Enter"
    - "User can push with Cmd/Ctrl+Shift+P"
    - "User can pull with Cmd/Ctrl+Shift+L"
    - "User can open repo with Cmd/Ctrl+O"
    - "Shortcuts are discoverable via tooltip hints"
  artifacts:
    - path: "src/hooks/useKeyboardShortcuts.ts"
      provides: "Global keyboard shortcut registration"
      exports: ["useKeyboardShortcuts", "formatShortcut"]
    - path: "package.json"
      provides: "react-hotkeys-hook dependency"
      contains: "react-hotkeys-hook"
  key_links:
    - from: "src/hooks/useKeyboardShortcuts.ts"
      to: "react-hotkeys-hook"
      via: "useHotkeys"
      pattern: "useHotkeys"
    - from: "src/App.tsx"
      to: "src/hooks/useKeyboardShortcuts.ts"
      via: "useKeyboardShortcuts()"
      pattern: "useKeyboardShortcuts"
---

<objective>
Implement global keyboard shortcuts for common Git operations using react-hotkeys-hook.

Purpose: Fulfills UX-04 (keyboard shortcuts for common operations). Power users can work faster.
Output: Working shortcuts for stage, commit, push, pull with discoverable hints.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-polish-performance/08-RESEARCH.md

@src/App.tsx
@src/components/staging/StagingPanel.tsx
@src/components/sync/SyncButtons.tsx
@src/stores/staging.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-hotkeys-hook and create shortcuts hook</name>
  <files>
    - package.json
    - src/hooks/useKeyboardShortcuts.ts
  </files>
  <action>
1. Install react-hotkeys-hook:
```bash
npm install react-hotkeys-hook@^4
```

2. Create `src/hooks/useKeyboardShortcuts.ts`:

```typescript
import { useHotkeys } from "react-hotkeys-hook";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { commands } from "../bindings";
import { useRepositoryStore } from "../stores/repository";

/**
 * Keyboard shortcuts for common Git operations.
 * 
 * Shortcuts:
 * - Cmd/Ctrl+O: Open repository
 * - Cmd/Ctrl+Shift+A: Stage all files
 * - Cmd/Ctrl+Enter: Commit (when in commit form)
 * - Cmd/Ctrl+Shift+P: Push
 * - Cmd/Ctrl+Shift+L: Pull (L for "pull Latest")
 * - Cmd/Ctrl+Shift+F: Fetch
 */
export function useKeyboardShortcuts() {
  const queryClient = useQueryClient();
  const { status } = useRepositoryStore();
  
  // Stage all mutation
  const stageAllMutation = useMutation({
    mutationFn: () => commands.stageAll(),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["stagingStatus"] });
    },
  });
  
  // Push mutation
  const pushMutation = useMutation({
    mutationFn: () => commands.push(),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["commitHistory"] });
    },
  });
  
  // Pull mutation
  const pullMutation = useMutation({
    mutationFn: () => commands.pull(),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["commitHistory"] });
      queryClient.invalidateQueries({ queryKey: ["stagingStatus"] });
    },
  });
  
  // Fetch mutation
  const fetchMutation = useMutation({
    mutationFn: () => commands.fetch(),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["commitHistory"] });
    },
  });
  
  // Open repo shortcut - dispatches custom event (already handled in App.tsx)
  useHotkeys("mod+o", (e) => {
    e.preventDefault();
    document.dispatchEvent(new CustomEvent("open-repository-dialog"));
  }, { preventDefault: true });
  
  // Stage all shortcut - only when repo is open
  useHotkeys("mod+shift+a", (e) => {
    e.preventDefault();
    if (status) {
      stageAllMutation.mutate();
    }
  }, { preventDefault: true, enabled: !!status });
  
  // Push shortcut
  useHotkeys("mod+shift+p", (e) => {
    e.preventDefault();
    if (status) {
      pushMutation.mutate();
    }
  }, { preventDefault: true, enabled: !!status });
  
  // Pull shortcut (using L for "Latest")
  useHotkeys("mod+shift+l", (e) => {
    e.preventDefault();
    if (status) {
      pullMutation.mutate();
    }
  }, { preventDefault: true, enabled: !!status });
  
  // Fetch shortcut
  useHotkeys("mod+shift+f", (e) => {
    e.preventDefault();
    if (status) {
      fetchMutation.mutate();
    }
  }, { preventDefault: true, enabled: !!status });
  
  // Return loading states for UI feedback
  return {
    isStaging: stageAllMutation.isPending,
    isPushing: pushMutation.isPending,
    isPulling: pullMutation.isPending,
    isFetching: fetchMutation.isPending,
  };
}

/**
 * Format shortcut for display (handles Mac vs Windows)
 */
export function formatShortcut(shortcut: string): string {
  const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
  return shortcut
    .replace("mod", isMac ? "⌘" : "Ctrl")
    .replace("shift", isMac ? "⇧" : "Shift")
    .replace("alt", isMac ? "⌥" : "Alt")
    .replace(/\+/g, isMac ? "" : "+");
}
```

Note: `mod` in react-hotkeys-hook automatically maps to Cmd on Mac and Ctrl on Windows.
  </action>
  <verify>
```bash
npm run build
```
Should compile without errors.
  </verify>
  <done>react-hotkeys-hook installed and shortcuts hook created</done>
</task>

<task type="auto">
  <name>Task 2: Integrate shortcuts with App and add discoverable hints</name>
  <files>
    - src/App.tsx
    - src/components/sync/SyncButtons.tsx
    - src/components/staging/StagingPanel.tsx
  </files>
  <action>
1. Update `src/App.tsx`:
   - Remove the existing manual keyboard listener for Cmd+O (replaced by hook)
   - Import and call useKeyboardShortcuts() at component level

```typescript
import { useKeyboardShortcuts } from "./hooks/useKeyboardShortcuts";

function App() {
  const initTheme = useThemeStore((s) => s.initTheme);
  
  // Register global keyboard shortcuts
  useKeyboardShortcuts();
  
  useEffect(() => {
    initTheme();
  }, [initTheme]);

  // Remove the old useEffect with handleKeyDown for Cmd+O
  // ... rest of component
}
```

2. Update `src/components/sync/SyncButtons.tsx`:
   - Add shortcut hints to button titles
   - Import formatShortcut helper

```typescript
import { formatShortcut } from "../../hooks/useKeyboardShortcuts";

// Update button titles to include shortcuts:
<Button
  title={`Push (${formatShortcut("mod+shift+P")})`}
  // ...
>

<Button
  title={`Pull (${formatShortcut("mod+shift+L")})`}
  // ...
>

<Button
  title={`Fetch (${formatShortcut("mod+shift+F")})`}
  // ...
>
```

3. Update `src/components/staging/StagingPanel.tsx`:
   - Add shortcut hint to "Stage All" button

```typescript
import { formatShortcut } from "../../hooks/useKeyboardShortcuts";

// In the "Stage All" button:
<button
  type="button"
  onClick={() => stageAllMutation.mutate()}
  className="text-xs text-ctp-subtext0 hover:text-ctp-text"
  title={`Stage All (${formatShortcut("mod+shift+A")})`}
>
  Stage All
</button>
```

4. The commit shortcut (Cmd+Enter) is already partially implemented in ConventionalCommitForm.tsx. Verify it works and add tooltip if missing.
  </action>
  <verify>
1. `npm run dev` + `npm run tauri dev`
2. Test shortcuts:
   - Cmd/Ctrl+O opens file picker
   - Cmd/Ctrl+Shift+A stages all (when repo open with changes)
   - Cmd/Ctrl+Shift+P pushes
   - Cmd/Ctrl+Shift+L pulls
3. Hover over buttons to see shortcut hints in tooltips
  </verify>
  <done>Shortcuts work globally and are discoverable via tooltips</done>
</task>

</tasks>

<verification>
1. All shortcuts work on both Mac and Windows keyboard layouts
2. Shortcuts only activate when appropriate (repo open, etc.)
3. Shortcuts don't conflict with browser/OS defaults
4. Tooltips show correct key combinations for current platform
5. Multiple rapid shortcut presses don't cause issues
</verification>

<success_criteria>
- UX-04: Keyboard shortcuts for stage, commit, push work
- Shortcuts are discoverable (tooltips show key combinations)
- Platform-appropriate key display (Cmd vs Ctrl)
- No conflicts with existing shortcuts (like Cmd+O which already existed)
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-performance/08-03-SUMMARY.md`
</output>
