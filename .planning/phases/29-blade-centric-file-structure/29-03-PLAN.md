---
phase: 29-blade-centric-file-structure
plan: 03
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/blades/viewer-code/ViewerCodeBlade.tsx
  - src/blades/viewer-code/ViewerCodeBlade.test.tsx
  - src/blades/viewer-code/registration.ts
  - src/blades/viewer-code/index.ts
  - src/blades/viewer-markdown/ViewerMarkdownBlade.tsx
  - src/blades/viewer-markdown/ViewerMarkdownBlade.test.tsx
  - src/blades/viewer-markdown/registration.ts
  - src/blades/viewer-markdown/index.ts
  - src/blades/viewer-nupkg/ViewerNupkgBlade.tsx
  - src/blades/viewer-nupkg/ViewerNupkgBlade.test.tsx
  - src/blades/viewer-nupkg/registration.ts
  - src/blades/viewer-nupkg/index.ts
  - src/blades/changelog/ChangelogBlade.tsx
  - src/blades/changelog/ChangelogBlade.test.tsx
  - src/blades/changelog/registration.ts
  - src/blades/changelog/store.ts
  - src/blades/changelog/components/ChangelogPreview.tsx
  - src/blades/changelog/index.ts
autonomous: true

must_haves:
  truths:
    - "viewer-code blade loads and renders source code files with syntax highlighting"
    - "viewer-markdown blade loads and renders markdown files with proper formatting"
    - "viewer-nupkg blade loads and renders NuGet package information"
    - "changelog blade loads, generates changelog, and shows preview"
    - "Changelog store is accessible only within the changelog blade directory"
  artifacts:
    - path: "src/blades/viewer-code/registration.ts"
      provides: "Auto-discovered registration for viewer-code blade"
      contains: "registerBlade"
    - path: "src/blades/viewer-markdown/registration.ts"
      provides: "Auto-discovered registration for viewer-markdown blade"
      contains: "registerBlade"
    - path: "src/blades/viewer-nupkg/registration.ts"
      provides: "Auto-discovered registration for viewer-nupkg blade"
      contains: "registerBlade"
    - path: "src/blades/changelog/registration.ts"
      provides: "Auto-discovered registration for changelog blade"
      contains: "registerBlade"
    - path: "src/blades/changelog/store.ts"
      provides: "Blade-specific changelog Zustand store (moved from stores/)"
      contains: "useChangelogStore"
  key_links:
    - from: "src/blades/viewer-markdown/ViewerMarkdownBlade.tsx"
      to: "src/components/markdown/MarkdownRenderer.tsx"
      via: "shared component import (stays in components/markdown/)"
      pattern: 'components/markdown/MarkdownRenderer'
    - from: "src/blades/changelog/ChangelogBlade.tsx"
      to: "src/blades/changelog/store.ts"
      via: "blade-specific store import"
      pattern: 'from.*\./store'
---

<objective>
Migrate 3 viewer blades and the changelog blade (with its exclusive store) to the new blade-centric structure.

Purpose: Handle the next tier of complexity -- blades with shared hook dependencies (useRepoFile) and the first blade-specific store move (changelogStore). The markdown sub-components in `components/markdown/` stay shared since they're infrastructure.

Output: 4 more blade directories under `src/blades/`, changelog store moved into its blade directory. 8/15 blades migrated total.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-blade-centric-file-structure/29-RESEARCH.md
@.planning/phases/29-blade-centric-file-structure/29-01-SUMMARY.md

@src/components/blades/registrations/viewer-code.ts
@src/components/blades/registrations/viewer-markdown.ts
@src/components/blades/registrations/viewer-nupkg.ts
@src/components/blades/registrations/changelog.ts
@src/components/blades/ViewerCodeBlade.tsx
@src/components/blades/ViewerMarkdownBlade.tsx
@src/components/blades/ViewerNupkgBlade.tsx
@src/components/blades/ChangelogBlade.tsx
@src/stores/changelogStore.ts
@src/components/changelog/ChangelogPreview.tsx
@src/hooks/useRepoFile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate viewer-code, viewer-markdown, and viewer-nupkg blades</name>
  <files>
    src/blades/viewer-code/ViewerCodeBlade.tsx
    src/blades/viewer-code/ViewerCodeBlade.test.tsx
    src/blades/viewer-code/registration.ts
    src/blades/viewer-code/index.ts
    src/blades/viewer-markdown/ViewerMarkdownBlade.tsx
    src/blades/viewer-markdown/ViewerMarkdownBlade.test.tsx
    src/blades/viewer-markdown/registration.ts
    src/blades/viewer-markdown/index.ts
    src/blades/viewer-nupkg/ViewerNupkgBlade.tsx
    src/blades/viewer-nupkg/ViewerNupkgBlade.test.tsx
    src/blades/viewer-nupkg/registration.ts
    src/blades/viewer-nupkg/index.ts
  </files>
  <action>
    Apply the per-blade migration checklist for each of the 3 viewer blades:

    1. Create directory, `git mv` component + test file
    2. Create registration.ts with lazy import pattern
    3. Create index.ts barrel (types-only exports, or empty for simple blades)
    4. Fix all imports in moved files
    5. Delete old registration file from `components/blades/registrations/`

    **viewer-code special handling:**
    - Uses `useRepoFile` hook from `hooks/` -- this is a SHARED hook (used by both viewer-code and viewer-markdown). Update import path to `../../hooks/useRepoFile` or `@/hooks/useRepoFile`.
    - Uses BladeContent* components -- update imports to `../_shared` barrel.

    **viewer-markdown special handling:**
    - Uses `useRepoFile` hook -- same as viewer-code, keep as shared import.
    - Imports `MarkdownRenderer` from `components/markdown/` -- this is SHARED infrastructure. Update relative path: `../../components/markdown/MarkdownRenderer` or `@/components/markdown/MarkdownRenderer`.
    - Uses BladeContent* components -- update imports to `../_shared` barrel.
    - Do NOT move `components/markdown/` into the blade -- it's shared infrastructure.

    **viewer-nupkg special handling:**
    - Check if ViewerNupkgBlade imports any sub-components (NugetPackageViewer). If so, the sub-component file should move into the blade directory.
    - Grep `src/components/` for any nupkg-related files and move blade-specific ones.

    Registration files should all use `React.lazy()` pattern:
    ```typescript
    import { lazy } from "react";
    import { registerBlade } from "@/lib/bladeRegistry";
    import { renderPathBreadcrumb } from "@/lib/bladeUtils";

    const ViewerCodeBlade = lazy(() =>
      import("./ViewerCodeBlade").then((m) => ({ default: m.ViewerCodeBlade }))
    );

    registerBlade<{ filePath: string; oid?: string }>({
      type: "viewer-code",
      defaultTitle: (props) => props.filePath.split("/").pop() || "Code",
      component: ViewerCodeBlade,
      lazy: true,
      renderTitleContent: (props) => renderPathBreadcrumb(props.filePath),
    });
    ```

    IMPORTANT: Use `git mv` for all moves. Verify `@/` imports resolve if tsconfig paths were configured in Plan 01, otherwise use relative paths.
  </action>
  <verify>
    - `ls src/blades/viewer-code/` shows all 4 files
    - `ls src/blades/viewer-markdown/` shows all 4 files
    - `ls src/blades/viewer-nupkg/` shows all 4 files (+ any sub-components)
    - `tsc --noEmit` passes
    - `vitest run` passes
    - `grep -r "useRepoFile" src/blades/viewer-code/` shows shared import path (not blade-local)
    - `grep -r "MarkdownRenderer" src/blades/viewer-markdown/` shows shared import from components/markdown/
    - Old registration files deleted for all 3 blades
  </verify>
  <done>3 viewer blades migrated to `src/blades/{name}/` with co-located files. Shared hooks (useRepoFile) and shared components (MarkdownRenderer) correctly imported from their shared locations. Old registrations deleted.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate changelog blade with exclusive store and sub-component</name>
  <files>
    src/blades/changelog/ChangelogBlade.tsx
    src/blades/changelog/ChangelogBlade.test.tsx
    src/blades/changelog/registration.ts
    src/blades/changelog/store.ts
    src/blades/changelog/components/ChangelogPreview.tsx
    src/blades/changelog/index.ts
  </files>
  <action>
    1. Create `src/blades/changelog/` and `src/blades/changelog/components/` directories.

    2. `git mv src/components/blades/ChangelogBlade.tsx src/blades/changelog/`
    3. `git mv src/components/blades/ChangelogBlade.test.tsx src/blades/changelog/`
    4. `git mv src/stores/changelogStore.ts src/blades/changelog/store.ts`
    5. `git mv src/components/changelog/ChangelogPreview.tsx src/blades/changelog/components/`
    6. Check if `src/components/changelog/index.ts` exists and has content -- if it only re-exports ChangelogPreview, delete it. If it exports things used elsewhere, keep it.

    7. Create `src/blades/changelog/registration.ts`:
       ```typescript
       import { lazy } from "react";
       import { registerBlade } from "@/lib/bladeRegistry";

       const ChangelogBlade = lazy(() =>
         import("./ChangelogBlade").then((m) => ({ default: m.ChangelogBlade }))
       );

       registerBlade({
         type: "changelog",
         defaultTitle: "Changelog",
         component: ChangelogBlade,
         lazy: true,
         singleton: true,
       });
       ```

    8. Create `src/blades/changelog/index.ts` barrel:
       ```typescript
       // Public API for changelog blade
       export type { ChangelogOutput } from "./store";
       ```
       Only export types that other modules might need. If `ChangelogOutput` is not used outside the blade, export nothing.

    9. Update imports inside moved files:
       - `ChangelogBlade.tsx`: Change `from "../../stores/changelogStore"` to `from "./store"`
       - `ChangelogBlade.tsx`: Update BladeContent* imports to `from "../_shared"`
       - `ChangelogPreview.tsx`: Change `from "../../stores/changelogStore"` to `from "../store"` (relative within blade)
       - Fix any other relative imports in moved files

    10. Add `/** @package */` JSDoc annotation to internal files (if Biome noPrivateImports is enabled):
        - `store.ts`: Mark `useChangelogStore` as `@package`
        - `components/ChangelogPreview.tsx`: Mark component as `@package`
        - `ChangelogBlade.tsx`: Mark component as `@package` (only importable within blade dir, registered via registration.ts)

    11. Delete old registration file: `git rm src/components/blades/registrations/changelog.ts`
    12. Delete old changelog component directory if empty: `rm -rf src/components/changelog/` (only if ChangelogPreview was the only file there and index.ts was just a barrel)
  </action>
  <verify>
    - `ls -R src/blades/changelog/` shows ChangelogBlade.tsx, ChangelogBlade.test.tsx, registration.ts, store.ts, index.ts, components/ChangelogPreview.tsx
    - `tsc --noEmit` passes
    - `vitest run` passes
    - `grep -r "changelogStore" src/stores/` returns nothing (store moved)
    - `grep -r "from.*stores/changelogStore\|from.*stores/changelog" src/` returns nothing (no stale imports)
    - Old registration deleted, old components/changelog/ removed
  </verify>
  <done>Changelog blade migrated with co-located exclusive store and sub-component. `changelogStore.ts` moved to `blades/changelog/store.ts`. `ChangelogPreview.tsx` moved to `blades/changelog/components/`. All imports updated. Old files cleaned up. 8/15 blades migrated total. TypeScript compiles, tests pass.</done>
</task>

</tasks>

<verification>
- `tsc --noEmit` passes
- `vitest run` -- all tests pass
- 4 new blade directories exist: viewer-code, viewer-markdown, viewer-nupkg, changelog
- Changelog has co-located store.ts and components/ChangelogPreview.tsx
- Shared hooks (useRepoFile) remain in `src/hooks/` (not moved)
- Shared components (markdown/) remain in `src/components/markdown/` (not moved)
- changelogStore.ts no longer exists in `src/stores/`
- 8 blades now in new structure, 7 remaining in old structure
- All 15 blades discoverable via dual-glob
</verification>

<success_criteria>
1. 4 more blades migrated (viewer-code, viewer-markdown, viewer-nupkg, changelog)
2. changelogStore moved into `blades/changelog/store.ts`
3. ChangelogPreview moved into `blades/changelog/components/`
4. Shared hooks and components correctly remain in shared locations
5. 8/15 blades total in new structure
6. TypeScript compiles, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/29-blade-centric-file-structure/29-03-SUMMARY.md`
</output>
