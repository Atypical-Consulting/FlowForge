---
phase: 29-blade-centric-file-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/blades/_shared/BladeContainer.tsx
  - src/blades/_shared/BladeRenderer.tsx
  - src/blades/_shared/BladePanel.tsx
  - src/blades/_shared/BladeStrip.tsx
  - src/blades/_shared/BladeLoadingFallback.tsx
  - src/blades/_shared/BladeErrorBoundary.tsx
  - src/blades/_shared/BladeToolbar.tsx
  - src/blades/_shared/BladeContentLoading.tsx
  - src/blades/_shared/BladeContentError.tsx
  - src/blades/_shared/BladeContentEmpty.tsx
  - src/blades/_shared/BladeBreadcrumb.tsx
  - src/blades/_shared/ProcessNavigation.tsx
  - src/blades/_shared/NavigationGuardDialog.tsx
  - src/blades/_shared/FileTreeBlade.tsx
  - src/blades/_shared/index.ts
  - src/blades/_discovery.ts
  - src/blades/diff/types.ts
  - src/blades/diff/index.ts
  - src/stores/bladeTypes.ts
  - src/lib/previewRegistry.ts
  - src/App.tsx
  - tsconfig.json
  - biome.json
autonomous: true

must_haves:
  truths:
    - "All 15 blade types still load and render after scaffolding changes"
    - "Shared blade infrastructure is available from blades/_shared barrel import"
    - "DiffSource type is importable from blades/diff/index.ts without circular dependency"
    - "TypeScript path alias @/* resolves correctly in IDE and build"
  artifacts:
    - path: "src/blades/_shared/index.ts"
      provides: "Public barrel exporting all shared blade infrastructure components"
      exports: ["BladeContainer", "BladeRenderer", "BladePanel", "BladeStrip", "BladeLoadingFallback", "BladeErrorBoundary", "BladeToolbar", "BladeContentLoading", "BladeContentError", "BladeContentEmpty", "BladeBreadcrumb", "ProcessNavigation", "NavigationGuardDialog", "FileTreeBlade"]
    - path: "src/blades/_discovery.ts"
      provides: "Dual-glob auto-discovery scanning both old and new blade locations"
      contains: "import.meta.glob"
    - path: "src/blades/diff/types.ts"
      provides: "Extracted DiffSource type definition"
      exports: ["DiffSource"]
    - path: "src/blades/diff/index.ts"
      provides: "Public barrel re-exporting DiffSource"
      exports: ["DiffSource"]
  key_links:
    - from: "src/App.tsx"
      to: "src/blades/_discovery.ts"
      via: "side-effect import"
      pattern: 'import.*blades/_discovery'
    - from: "src/stores/bladeTypes.ts"
      to: "src/blades/diff/types.ts"
      via: "type import through barrel"
      pattern: 'import type.*DiffSource.*blades/diff'
    - from: "src/blades/_discovery.ts"
      to: "src/components/blades/registrations/*.ts"
      via: "dual-glob import.meta.glob (old location still scanned)"
      pattern: 'components/blades/registrations'
---

<objective>
Scaffold the new blade-centric directory structure and prerequisite type extractions.

Purpose: Establish the `src/blades/` directory tree, move shared infrastructure to `blades/_shared/`, create the dual-glob discovery module, extract the DiffSource type to break the circular dependency, configure TypeScript path aliases, and enable Biome `noPrivateImports` rule -- all without moving any individual blade yet.

Output: Working scaffolding where all 15 existing blades still load via dual-glob discovery, shared infrastructure importable from `blades/_shared`, and DiffSource importable from `blades/diff/index.ts`.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-blade-centric-file-structure/29-RESEARCH.md

@src/components/blades/index.ts
@src/components/blades/registrations/index.ts
@src/components/blades/BladeContainer.tsx
@src/components/blades/BladeRenderer.tsx
@src/components/blades/BladePanel.tsx
@src/components/blades/BladeStrip.tsx
@src/components/blades/BladeLoadingFallback.tsx
@src/components/blades/BladeErrorBoundary.tsx
@src/components/blades/BladeToolbar.tsx
@src/components/blades/BladeContentLoading.tsx
@src/components/blades/BladeContentError.tsx
@src/components/blades/BladeContentEmpty.tsx
@src/components/blades/BladeBreadcrumb.tsx
@src/components/blades/ProcessNavigation.tsx
@src/components/blades/NavigationGuardDialog.tsx
@src/components/blades/FileTreeBlade.tsx
@src/components/blades/DiffBlade.tsx
@src/stores/bladeTypes.ts
@src/lib/previewRegistry.ts
@src/App.tsx
@tsconfig.json
@biome.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move shared blade infrastructure to blades/_shared/ and create discovery module</name>
  <files>
    src/blades/_shared/BladeContainer.tsx
    src/blades/_shared/BladeRenderer.tsx
    src/blades/_shared/BladePanel.tsx
    src/blades/_shared/BladeStrip.tsx
    src/blades/_shared/BladeLoadingFallback.tsx
    src/blades/_shared/BladeErrorBoundary.tsx
    src/blades/_shared/BladeToolbar.tsx
    src/blades/_shared/BladeContentLoading.tsx
    src/blades/_shared/BladeContentError.tsx
    src/blades/_shared/BladeContentEmpty.tsx
    src/blades/_shared/BladeBreadcrumb.tsx
    src/blades/_shared/ProcessNavigation.tsx
    src/blades/_shared/NavigationGuardDialog.tsx
    src/blades/_shared/FileTreeBlade.tsx
    src/blades/_shared/index.ts
    src/blades/_discovery.ts
    src/components/blades/index.ts
    src/App.tsx
  </files>
  <action>
    1. Create `src/blades/_shared/` directory.

    2. Use `git mv` to move these 14 infrastructure files from `src/components/blades/` to `src/blades/_shared/`:
       - BladeContainer.tsx, BladeRenderer.tsx, BladePanel.tsx, BladeStrip.tsx
       - BladeLoadingFallback.tsx, BladeErrorBoundary.tsx, BladeToolbar.tsx
       - BladeContentLoading.tsx, BladeContentError.tsx, BladeContentEmpty.tsx
       - BladeBreadcrumb.tsx, ProcessNavigation.tsx, NavigationGuardDialog.tsx
       - FileTreeBlade.tsx (reusable sub-component, NOT a blade type)

    3. Create `src/blades/_shared/index.ts` barrel file that exports all 14 components:
       ```typescript
       export { BladeContainer } from "./BladeContainer";
       export { BladePanel } from "./BladePanel";
       export { BladeStrip } from "./BladeStrip";
       export { BladeRenderer } from "./BladeRenderer";
       export { BladeErrorBoundary } from "./BladeErrorBoundary";
       export { BladeLoadingFallback } from "./BladeLoadingFallback";
       export { BladeToolbar } from "./BladeToolbar";
       export { BladeContentLoading } from "./BladeContentLoading";
       export { BladeContentError } from "./BladeContentError";
       export { BladeContentEmpty } from "./BladeContentEmpty";
       export { BladeBreadcrumb } from "./BladeBreadcrumb";
       export { ProcessNavigation } from "./ProcessNavigation";
       export { NavigationGuardDialog } from "./NavigationGuardDialog";
       export { FileTreeBlade } from "./FileTreeBlade";
       ```

    4. Update ALL imports across the codebase that reference the moved infrastructure files. After git mv, relative imports within moved files need updating (they now live at different depth). Also update:
       - `src/components/blades/index.ts` -- remove infrastructure exports, keep only blade component exports (or remove file entirely if all exports moved)
       - All blade components that import from `./BladeContentLoading`, `./BladeContentError`, etc. -- update to relative path to `../_shared/` or `../../blades/_shared/`
       - Any file outside `src/blades/` that imports infrastructure -- use relative paths for now

    5. Create `src/blades/_discovery.ts` with dual-glob pattern that scans BOTH old and new registration locations:
       ```typescript
       import { clearRegistry, getAllBladeTypes } from "../lib/bladeRegistry";

       // Dual-glob: scan new per-blade registrations AND old flat directory
       const modules = import.meta.glob(
         [
           "./*/registration.{ts,tsx}",                         // New location
           "../components/blades/registrations/*.{ts,tsx}",     // Old location (migration period)
           "!../components/blades/registrations/index.ts",      // Exclude old barrel
           "!./_shared/**",                                     // Exclude infrastructure
         ],
         { eager: true }
       );

       // Guard against misconfigured paths
       if (import.meta.env.DEV && Object.keys(modules).length === 0) {
         console.error("[BladeRegistry] No registration modules found -- check blade directories and registrations/");
       }

       // Dev-mode exhaustiveness check
       if (import.meta.env.DEV && !import.meta.hot?.data?.isUpdate) {
         const registered = new Set(getAllBladeTypes());
         const EXPECTED_TYPES: string[] = [
           "staging-changes", "topology-graph", "commit-details", "diff",
           "viewer-nupkg", "viewer-image", "viewer-markdown", "viewer-3d",
           "viewer-code", "repo-browser", "settings", "changelog",
           "gitflow-cheatsheet", "init-repo", "conventional-commit",
         ];
         const missing = EXPECTED_TYPES.filter(t => !registered.has(t as any));
         if (missing.length > 0) {
           console.warn(
             `[BladeRegistry] Missing registrations: ${missing.join(", ")}. ` +
             `Create a registration.ts in src/blades/{blade-name}/ for each.`
           );
         }
       }

       // HMR: clear registry before re-execution so re-registration is clean
       if (import.meta.hot) {
         import.meta.hot.accept();
         import.meta.hot.dispose((data) => {
           data.isUpdate = true;
           clearRegistry();
         });
       }
       ```

    6. Update `src/App.tsx` import from `"./components/blades/registrations"` to `"./blades/_discovery"`.

    IMPORTANT: Use `git mv` for all file moves to preserve git history. After moving files, fix all broken relative imports in the moved files themselves (they now live at `src/blades/_shared/` instead of `src/components/blades/`). Grep for all imports of moved files across the codebase and update them.
  </action>
  <verify>
    - `tsc --noEmit` passes (ignoring pre-existing TS2440 in bindings.ts)
    - `vitest run` passes (all existing tests)
    - `grep -r "components/blades/BladeContainer\|components/blades/BladeRenderer\|components/blades/BladePanel\|components/blades/BladeStrip\|components/blades/BladeLoadingFallback\|components/blades/BladeErrorBoundary\|components/blades/BladeToolbar\|components/blades/BladeContentLoading\|components/blades/BladeContentError\|components/blades/BladeContentEmpty\|components/blades/BladeBreadcrumb\|components/blades/ProcessNavigation\|components/blades/NavigationGuardDialog\|components/blades/FileTreeBlade" src/` returns no results (no stale imports)
    - `ls src/blades/_shared/*.tsx` lists all 14 files
    - `cat src/blades/_discovery.ts` shows dual-glob pattern
  </verify>
  <done>All 14 shared infrastructure files live in `src/blades/_shared/` with barrel export. Discovery module uses dual-glob to scan both old registrations/ and new per-blade registration.ts files. App.tsx imports from new discovery location. All imports updated, TypeScript compiles, tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Extract DiffSource type, configure tsconfig paths, and enable Biome noPrivateImports</name>
  <files>
    src/blades/diff/types.ts
    src/blades/diff/index.ts
    src/stores/bladeTypes.ts
    src/lib/previewRegistry.ts
    src/components/blades/registrations/diff.tsx
    src/components/blades/DiffBlade.tsx
    tsconfig.json
    biome.json
  </files>
  <action>
    1. Create `src/blades/diff/` directory (will hold the diff blade later; for now just the extracted type).

    2. Create `src/blades/diff/types.ts` with the DiffSource type extracted from DiffBlade.tsx:
       ```typescript
       /**
        * Blade input: diff source configuration.
        * Public type -- imported by bladeTypes.ts and previewRegistry.ts.
        */
       export type DiffSource =
         | { mode: "staging"; filePath: string; staged: boolean }
         | { mode: "commit"; oid: string; filePath: string };
       ```
       Verify the exact shape matches what's in DiffBlade.tsx before writing.

    3. Create `src/blades/diff/index.ts` barrel:
       ```typescript
       export type { DiffSource } from "./types";
       ```

    4. Update DiffBlade.tsx: Remove the `DiffSource` type export. Add `import type { DiffSource } from "../../blades/diff/types";` (or appropriate relative path). Keep the component export unchanged.

    5. Update `src/stores/bladeTypes.ts`: Change `import type { DiffSource } from "../components/blades/DiffBlade"` to `import type { DiffSource } from "../blades/diff"`.

    6. Update `src/lib/previewRegistry.ts`: Change `import type { DiffSource } from "../components/blades/DiffBlade"` to `import type { DiffSource } from "../blades/diff"`.

    7. Update `src/components/blades/registrations/diff.tsx`: Change `import type { DiffSource } from "../DiffBlade"` to `import type { DiffSource } from "../../../blades/diff"`.

    8. Add TypeScript path alias to `tsconfig.json`:
       ```json
       {
         "compilerOptions": {
           ...existing options...,
           "baseUrl": ".",
           "paths": {
             "@/*": ["src/*"]
           }
         }
       }
       ```
       This enables `@/` imports for IDE support. Use `@/` selectively for cross-module imports in migrated blades. Do NOT mass-convert existing relative imports.

    9. Update `biome.json` to enable `noPrivateImports` rule:
       ```json
       {
         "$schema": "https://biomejs.dev/schemas/1.9.0/schema.json",
         "organizeImports": { "enabled": true },
         "linter": {
           "enabled": true,
           "rules": {
             "recommended": true,
             "correctness": {
               "noPrivateImports": "error"
             }
           }
         },
         "formatter": { "enabled": true, "indentStyle": "space", "indentWidth": 2 }
       }
       ```
       NOTE: Verify the Biome version supports `noPrivateImports` (it's a Biome v2 feature). If the current Biome version (1.9.0 per schema) does not support it, skip this step and add a TODO comment in the discovery module instead. The CI boundary check script (Plan 06) serves as fallback.
  </action>
  <verify>
    - `tsc --noEmit` passes
    - `vitest run` passes
    - `grep -r "DiffSource" src/stores/bladeTypes.ts` shows import from `blades/diff`
    - `grep -r "DiffSource" src/lib/previewRegistry.ts` shows import from `blades/diff`
    - `cat src/blades/diff/types.ts` shows the DiffSource type
    - `cat tsconfig.json | grep baseUrl` confirms baseUrl is set
  </verify>
  <done>DiffSource type extracted to `src/blades/diff/types.ts` and re-exported via barrel. All 3 external consumers updated to import from the barrel. No circular dependency between bladeTypes.ts and DiffBlade.tsx. TypeScript path alias `@/*` configured. Biome `noPrivateImports` enabled (or documented as pending upgrade). TypeScript compiles, tests pass.</done>
</task>

</tasks>

<verification>
- `tsc --noEmit` passes (ignoring pre-existing TS2440)
- `vitest run` -- all existing tests pass
- `ls src/blades/_shared/` shows 14 infrastructure files + index.ts
- `ls src/blades/diff/` shows types.ts + index.ts
- `cat src/blades/_discovery.ts` shows dual-glob pattern
- `cat src/App.tsx` imports from `./blades/_discovery`
- `grep -r "from.*components/blades/Blade" src/` returns no stale imports of infrastructure components
- Application starts in dev mode (`npm run dev`) and all 15 blade types are discoverable
</verification>

<success_criteria>
1. Shared blade infrastructure lives in `src/blades/_shared/` with a barrel export
2. Dual-glob discovery module exists at `src/blades/_discovery.ts`
3. DiffSource type extracted and importable without circular dependency
4. TypeScript `@/*` path alias configured
5. All 15 blades still load (zero regressions)
6. TypeScript compiles, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/29-blade-centric-file-structure/29-01-SUMMARY.md`
</output>
