---
phase: 29-blade-centric-file-structure
plan: 05
type: execute
wave: 3
depends_on: ["29-02", "29-03", "29-04"]
files_modified:
  - src/blades/staging-changes/StagingChangesBlade.tsx
  - src/blades/staging-changes/StagingChangesBlade.test.tsx
  - src/blades/staging-changes/registration.ts
  - src/blades/staging-changes/index.ts
  - src/blades/staging-changes/hooks/useStagingKeyboard.ts
  - src/blades/staging-changes/components/StagingPanel.tsx
  - src/blades/staging-changes/components/StagingDiffPreview.tsx
  - src/blades/staging-changes/components/FileItem.tsx
  - src/blades/staging-changes/components/FileList.tsx
  - src/blades/staging-changes/components/FileTreeView.tsx
  - src/blades/staging-changes/components/FileTreeSearch.tsx
  - src/blades/staging-changes/components/InlineDiffViewer.tsx
  - src/blades/staging-changes/components/DiffPreviewHeader.tsx
  - src/blades/staging-changes/components/NonTextPlaceholder.tsx
  - src/blades/topology-graph/TopologyRootBlade.tsx
  - src/blades/topology-graph/TopologyRootBlade.test.tsx
  - src/blades/topology-graph/registration.ts
  - src/blades/topology-graph/index.ts
  - src/blades/topology-graph/components/TopologyPanel.tsx
  - src/blades/topology-graph/components/CommitBadge.tsx
  - src/blades/topology-graph/components/LaneBackground.tsx
  - src/blades/topology-graph/components/LaneHeader.tsx
  - src/blades/topology-graph/components/layoutUtils.ts
  - src/blades/diff/DiffBlade.tsx
  - src/blades/diff/DiffBlade.test.tsx
  - src/blades/diff/registration.tsx
  - src/blades/init-repo/InitRepoBlade.tsx
  - src/blades/init-repo/registration.ts
  - src/blades/init-repo/store.ts
  - src/blades/init-repo/index.ts
  - src/blades/init-repo/components/InitRepoForm.tsx
  - src/blades/init-repo/components/InitRepoPreview.tsx
  - src/blades/init-repo/components/TemplatePicker.tsx
  - src/blades/init-repo/components/TemplateChips.tsx
  - src/blades/init-repo/components/CategoryFilter.tsx
  - src/blades/init-repo/components/ProjectDetectionBanner.tsx
  - src/components/WelcomeView.tsx
autonomous: true

must_haves:
  truths:
    - "Staging-changes blade loads with two-column layout (file list + diff preview)"
    - "Topology-graph blade loads and renders the commit graph visualization"
    - "Diff blade loads and shows file diffs from staging or commit context"
    - "Init-repo blade loads from welcome screen AND navigates correctly via blade stack"
    - "Staging store remains shared (used by staging-changes and diff blades)"
    - "Topology store remains shared (used by blade and App.tsx)"
    - "useStagingKeyboard hook is co-located within staging-changes blade"
    - "Init-repo store is co-located within init-repo blade"
  artifacts:
    - path: "src/blades/staging-changes/registration.ts"
      provides: "Auto-discovered registration for staging-changes blade"
      contains: "registerBlade"
    - path: "src/blades/staging-changes/hooks/useStagingKeyboard.ts"
      provides: "Blade-exclusive keyboard hook (moved from hooks/)"
    - path: "src/blades/topology-graph/registration.ts"
      provides: "Auto-discovered registration for topology-graph blade"
      contains: "registerBlade"
    - path: "src/blades/diff/registration.tsx"
      provides: "Auto-discovered registration for diff blade"
      contains: "registerBlade"
    - path: "src/blades/init-repo/registration.ts"
      provides: "Auto-discovered registration for init-repo blade"
      contains: "registerBlade"
    - path: "src/blades/init-repo/store.ts"
      provides: "Blade-exclusive init-repo store (moved from stores/)"
      contains: "useInitRepoStore"
  key_links:
    - from: "src/blades/staging-changes/StagingChangesBlade.tsx"
      to: "src/stores/staging.ts"
      via: "shared staging store (stays shared -- also used by diff blade)"
      pattern: 'from.*stores/staging'
    - from: "src/blades/diff/DiffBlade.tsx"
      to: "src/stores/staging.ts"
      via: "shared staging store import"
      pattern: 'from.*stores/staging'
    - from: "src/components/WelcomeView.tsx"
      to: "src/blades/init-repo"
      via: "barrel import for standalone rendering"
      pattern: 'from.*blades/init-repo'
---

<objective>
Migrate the 4 most complex blades: staging-changes (9 sub-components + exclusive hook), topology-graph (5 sub-components), diff (DiffSource already extracted), and init-repo (6 sub-components + exclusive store).

Purpose: Complete the migration of all cross-dependent blades. This is the highest-risk plan due to shared staging store usage, the WelcomeView direct import of InitRepoBlade, and the topology/init-repo sub-component trees.

Output: 4 more blade directories (14/15 total). Only conventional-commit remains for Plan 06.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-blade-centric-file-structure/29-RESEARCH.md
@.planning/phases/29-blade-centric-file-structure/29-01-SUMMARY.md

@src/components/blades/StagingChangesBlade.tsx
@src/components/blades/TopologyRootBlade.tsx
@src/components/blades/DiffBlade.tsx
@src/components/blades/InitRepoBlade.tsx
@src/components/blades/registrations/staging-changes.ts
@src/components/blades/registrations/topology-graph.ts
@src/components/blades/registrations/diff.tsx
@src/components/blades/registrations/init-repo.ts
@src/hooks/useStagingKeyboard.ts
@src/stores/staging.ts
@src/stores/topology.ts
@src/stores/initRepo.ts
@src/components/staging/StagingPanel.tsx
@src/components/topology/TopologyPanel.tsx
@src/components/init-repo/InitRepoForm.tsx
@src/components/WelcomeView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate staging-changes and diff blades with shared staging store</name>
  <files>
    src/blades/staging-changes/StagingChangesBlade.tsx
    src/blades/staging-changes/StagingChangesBlade.test.tsx
    src/blades/staging-changes/registration.ts
    src/blades/staging-changes/index.ts
    src/blades/staging-changes/hooks/useStagingKeyboard.ts
    src/blades/staging-changes/components/StagingPanel.tsx
    src/blades/staging-changes/components/StagingDiffPreview.tsx
    src/blades/staging-changes/components/FileItem.tsx
    src/blades/staging-changes/components/FileList.tsx
    src/blades/staging-changes/components/FileTreeView.tsx
    src/blades/staging-changes/components/FileTreeSearch.tsx
    src/blades/staging-changes/components/InlineDiffViewer.tsx
    src/blades/staging-changes/components/DiffPreviewHeader.tsx
    src/blades/staging-changes/components/NonTextPlaceholder.tsx
    src/blades/diff/DiffBlade.tsx
    src/blades/diff/DiffBlade.test.tsx
    src/blades/diff/registration.tsx
  </files>
  <action>
    **A. Migrate staging-changes blade:**

    1. Create dirs: `src/blades/staging-changes/`, `src/blades/staging-changes/components/`, `src/blades/staging-changes/hooks/`

    2. `git mv` the main blade files:
       ```
       git mv src/components/blades/StagingChangesBlade.tsx src/blades/staging-changes/
       git mv src/components/blades/StagingChangesBlade.test.tsx src/blades/staging-changes/
       ```

    3. `git mv` all staging sub-components from `src/components/staging/`:
       ```
       git mv src/components/staging/StagingPanel.tsx src/blades/staging-changes/components/
       git mv src/components/staging/StagingDiffPreview.tsx src/blades/staging-changes/components/
       git mv src/components/staging/FileItem.tsx src/blades/staging-changes/components/
       git mv src/components/staging/FileList.tsx src/blades/staging-changes/components/
       git mv src/components/staging/FileTreeView.tsx src/blades/staging-changes/components/
       git mv src/components/staging/FileTreeSearch.tsx src/blades/staging-changes/components/
       git mv src/components/staging/InlineDiffViewer.tsx src/blades/staging-changes/components/
       git mv src/components/staging/DiffPreviewHeader.tsx src/blades/staging-changes/components/
       git mv src/components/staging/NonTextPlaceholder.tsx src/blades/staging-changes/components/
       ```

    4. `git mv` the blade-exclusive hook:
       ```
       git mv src/hooks/useStagingKeyboard.ts src/blades/staging-changes/hooks/
       ```

    5. Delete the now-empty `src/components/staging/` directory.

    6. Create `src/blades/staging-changes/registration.ts` -- staging-changes is a ROOT blade (not lazy, renders as primary process view):
       ```typescript
       import { registerBlade } from "@/lib/bladeRegistry";
       import { StagingChangesBlade } from "./StagingChangesBlade";

       registerBlade({
         type: "staging-changes",
         defaultTitle: "Staging",
         component: StagingChangesBlade,
       });
       ```

    7. Create `src/blades/staging-changes/index.ts`:
       ```typescript
       // Public API for staging-changes blade
       // No public types -- staging store lives in shared stores/staging.ts
       ```

    8. Update ALL imports in moved files:
       - `StagingChangesBlade.tsx`:
         - `useStagingKeyboard` -> `from "./hooks/useStagingKeyboard"`
         - `useStagingStore` -> `from "@/stores/staging"` or `from "../../stores/staging"` (SHARED)
         - Staging sub-components -> `from "./components/StagingPanel"` etc. (relative within blade)
         - BladeContent* -> `from "../_shared"`
       - All staging sub-components: update their imports to new relative paths
         - Shared stores (staging, repository) -> `from "@/stores/..."` or `from "../../../stores/..."`
         - Cross-component references within staging -> `from "./{sibling}"` (all in same components/ dir)
       - `useStagingKeyboard.ts`: update any imports to new relative paths

    9. Delete old registration: `git rm src/components/blades/registrations/staging-changes.ts`

    **B. Migrate diff blade:**

    10. The `src/blades/diff/` directory already exists (from Plan 01, has types.ts and index.ts).

    11. `git mv` blade files into the existing diff directory:
        ```
        git mv src/components/blades/DiffBlade.tsx src/blades/diff/
        git mv src/components/blades/DiffBlade.test.tsx src/blades/diff/
        ```

    12. `git mv` the registration file:
        ```
        git mv src/components/blades/registrations/diff.tsx src/blades/diff/registration.tsx
        ```

    13. Update `src/blades/diff/registration.tsx`:
        - Component import: `from "./DiffBlade"` (now local)
        - DiffSource type: `from "./types"` (already local)
        - `registerBlade` and `bladeUtils`: `from "@/lib/..."` or adjust relative

    14. Update `src/blades/diff/DiffBlade.tsx`:
        - `DiffSource` import: `from "./types"` (local, already set up in Plan 01 Task 2)
        - `useStagingStore`: `from "@/stores/staging"` (SHARED)
        - BladeContent* -> `from "../_shared"`
        - Remove the `DiffSource` type export from the component file (if not already done in Plan 01)

    15. Update `src/blades/diff/index.ts` -- ensure it also exports the component for potential external use:
        ```typescript
        export type { DiffSource } from "./types";
        ```

    16. Delete old diff registration: `git rm src/components/blades/registrations/diff.tsx` (if not already git mv'd above)

    CRITICAL: `stores/staging.ts` is SHARED between staging-changes and diff blades. Do NOT move it. Verify after migration that both blades import from the shared location.
  </action>
  <verify>
    - `ls -R src/blades/staging-changes/` shows blade, test, registration, index, hooks/useStagingKeyboard.ts, components/ with 9 files
    - `ls src/blades/diff/` shows DiffBlade.tsx, DiffBlade.test.tsx, registration.tsx, types.ts, index.ts
    - `tsc --noEmit` passes
    - `vitest run` passes
    - `ls src/stores/staging.ts` still exists (staging store NOT moved)
    - `ls src/components/staging/` fails (directory removed)
    - `grep -r "from.*stores/staging" src/blades/staging-changes/` shows shared store import
    - `grep -r "from.*stores/staging" src/blades/diff/` shows shared store import
    - Old registrations deleted for both blades
  </verify>
  <done>Staging-changes blade migrated with 9 sub-components and exclusive useStagingKeyboard hook. Diff blade migrated into existing directory. Both blades correctly share `stores/staging.ts`. Old files cleaned up.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate topology-graph and init-repo blades with sub-components and exclusive store</name>
  <files>
    src/blades/topology-graph/TopologyRootBlade.tsx
    src/blades/topology-graph/TopologyRootBlade.test.tsx
    src/blades/topology-graph/registration.ts
    src/blades/topology-graph/index.ts
    src/blades/topology-graph/components/TopologyPanel.tsx
    src/blades/topology-graph/components/CommitBadge.tsx
    src/blades/topology-graph/components/LaneBackground.tsx
    src/blades/topology-graph/components/LaneHeader.tsx
    src/blades/topology-graph/components/layoutUtils.ts
    src/blades/init-repo/InitRepoBlade.tsx
    src/blades/init-repo/registration.ts
    src/blades/init-repo/store.ts
    src/blades/init-repo/index.ts
    src/blades/init-repo/components/InitRepoForm.tsx
    src/blades/init-repo/components/InitRepoPreview.tsx
    src/blades/init-repo/components/TemplatePicker.tsx
    src/blades/init-repo/components/TemplateChips.tsx
    src/blades/init-repo/components/CategoryFilter.tsx
    src/blades/init-repo/components/ProjectDetectionBanner.tsx
    src/components/WelcomeView.tsx
  </files>
  <action>
    **A. Migrate topology-graph blade:**

    1. Create dirs: `src/blades/topology-graph/`, `src/blades/topology-graph/components/`

    2. `git mv` blade files:
       ```
       git mv src/components/blades/TopologyRootBlade.tsx src/blades/topology-graph/
       git mv src/components/blades/TopologyRootBlade.test.tsx src/blades/topology-graph/
       ```

    3. `git mv` all topology sub-components from `src/components/topology/`:
       ```
       git mv src/components/topology/TopologyPanel.tsx src/blades/topology-graph/components/
       git mv src/components/topology/CommitBadge.tsx src/blades/topology-graph/components/
       git mv src/components/topology/LaneBackground.tsx src/blades/topology-graph/components/
       git mv src/components/topology/LaneHeader.tsx src/blades/topology-graph/components/
       git mv src/components/topology/layoutUtils.ts src/blades/topology-graph/components/
       ```
       If `components/topology/index.ts` exists, check what it exports. If only topology sub-components, delete it after migration.

    4. Delete the now-empty `src/components/topology/` directory.

    5. Create `src/blades/topology-graph/registration.ts` -- topology-graph is a ROOT blade (not lazy):
       ```typescript
       import { registerBlade } from "@/lib/bladeRegistry";
       import { TopologyRootBlade } from "./TopologyRootBlade";

       registerBlade({
         type: "topology-graph",
         defaultTitle: "Topology",
         component: TopologyRootBlade,
       });
       ```

    6. Create `src/blades/topology-graph/index.ts`:
       ```typescript
       // Public API for topology-graph blade
       // No public types -- topology store lives in shared stores/topology.ts
       ```

    7. Update imports in moved files:
       - `TopologyRootBlade.tsx`: sub-component imports -> `./components/TopologyPanel` etc.
       - `TopologyRootBlade.tsx`: `useTopologyStore` -> `@/stores/topology` (SHARED)
       - `TopologyRootBlade.tsx`: `CommitHistory` -> `@/components/commit/CommitHistory` (SHARED commit component)
       - All sub-components: update relative paths for stores, shared components
       - BladeContent* -> `from "../_shared"`

    8. Delete old registration: `git rm src/components/blades/registrations/topology-graph.ts`

    **B. Migrate init-repo blade:**

    9. Create dirs: `src/blades/init-repo/`, `src/blades/init-repo/components/`

    10. `git mv` blade file:
        ```
        git mv src/components/blades/InitRepoBlade.tsx src/blades/init-repo/
        ```
        Note: InitRepoBlade may not have a test file. Check before attempting to move.

    11. `git mv` the blade-exclusive store:
        ```
        git mv src/stores/initRepo.ts src/blades/init-repo/store.ts
        ```

    12. `git mv` all init-repo sub-components from `src/components/init-repo/`:
        ```
        git mv src/components/init-repo/InitRepoForm.tsx src/blades/init-repo/components/
        git mv src/components/init-repo/InitRepoPreview.tsx src/blades/init-repo/components/
        git mv src/components/init-repo/components/TemplatePicker.tsx src/blades/init-repo/components/
        git mv src/components/init-repo/components/TemplateChips.tsx src/blades/init-repo/components/
        git mv src/components/init-repo/components/CategoryFilter.tsx src/blades/init-repo/components/
        git mv src/components/init-repo/components/ProjectDetectionBanner.tsx src/blades/init-repo/components/
        ```
        Note the init-repo sub-components have a NESTED `components/` directory. Flatten them: move all sub-components into `src/blades/init-repo/components/` at the same level.

    13. Delete the now-empty `src/components/init-repo/` directory tree.

    14. Create `src/blades/init-repo/registration.ts`:
        ```typescript
        import { lazy } from "react";
        import { registerBlade } from "@/lib/bladeRegistry";

        const InitRepoBlade = lazy(() =>
          import("./InitRepoBlade").then((m) => ({ default: m.InitRepoBlade }))
        );

        registerBlade({
          type: "init-repo",
          defaultTitle: "Initialize Repository",
          component: InitRepoBlade,
          lazy: true,
          singleton: true,
        });
        ```

    15. Create/update `src/blades/init-repo/index.ts` barrel -- MUST export InitRepoBlade because WelcomeView imports it directly:
        ```typescript
        // Public API for init-repo blade
        export { InitRepoBlade } from "./InitRepoBlade";
        ```

    16. Update imports in moved files:
        - `InitRepoBlade.tsx`: `useInitRepoStore` -> `from "./store"` (now local)
        - `InitRepoBlade.tsx`: sub-component imports -> `from "./components/..."`
        - All sub-components: `useInitRepoStore` -> `from "../store"` (relative within blade)
        - Sub-components from the nested `components/` subdir: flatten imports (no more `../../../stores/...`)
        - Adjust all React Query hook imports, shared utility imports

    17. **CRITICAL:** Update `src/components/WelcomeView.tsx`:
        Change `import { InitRepoBlade } from "./blades/InitRepoBlade"` to `import { InitRepoBlade } from "../blades/init-repo"` (barrel import).

    18. Delete old registration: `git rm src/components/blades/registrations/init-repo.ts`

    IMPORTANT: Topology store (`stores/topology.ts`) is SHARED. Init-repo store (`stores/initRepo.ts`) is EXCLUSIVE -- move it.
  </action>
  <verify>
    - `ls -R src/blades/topology-graph/` shows blade, test, registration, index, components/ with 5 files
    - `ls -R src/blades/init-repo/` shows blade, registration, store.ts, index, components/ with 6 files
    - `tsc --noEmit` passes
    - `vitest run` passes
    - `ls src/stores/topology.ts` still exists (topology store NOT moved)
    - `ls src/stores/initRepo.ts` fails (init-repo store MOVED)
    - `ls src/components/topology/` fails (directory removed)
    - `ls src/components/init-repo/` fails (directory removed)
    - `grep "InitRepoBlade" src/components/WelcomeView.tsx` shows import from `../blades/init-repo`
    - Old registrations deleted for both blades
  </verify>
  <done>Topology-graph and init-repo blades migrated with all sub-components. Init-repo store moved to blade directory. Topology store stays shared. WelcomeView updated to import InitRepoBlade from barrel. 14/15 blades migrated. TypeScript compiles, tests pass.</done>
</task>

</tasks>

<verification>
- `tsc --noEmit` passes
- `vitest run` -- all tests pass
- 4 new blade directories: staging-changes, topology-graph, diff (completed), init-repo
- staging-changes has 9 sub-components + useStagingKeyboard hook
- topology-graph has 5 sub-components
- init-repo has 6 sub-components + exclusive store
- Shared stores (staging, topology) remain in `stores/`
- Init-repo store moved to `blades/init-repo/store.ts`
- WelcomeView imports InitRepoBlade from barrel
- 14/15 blades in new structure
</verification>

<success_criteria>
1. staging-changes, topology-graph, diff, and init-repo blades fully migrated
2. All sub-components co-located in their blade directories
3. useStagingKeyboard hook co-located in staging-changes
4. initRepo store co-located in init-repo blade
5. Shared stores (staging, topology) remain shared
6. WelcomeView correctly imports InitRepoBlade from blade barrel
7. 14/15 blades in new structure
8. TypeScript compiles, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/29-blade-centric-file-structure/29-05-SUMMARY.md`
</output>
