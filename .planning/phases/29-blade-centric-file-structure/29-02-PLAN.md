---
phase: 29-blade-centric-file-structure
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/blades/viewer-image/ViewerImageBlade.tsx
  - src/blades/viewer-image/ViewerImageBlade.test.tsx
  - src/blades/viewer-image/registration.ts
  - src/blades/viewer-image/index.ts
  - src/blades/viewer-3d/Viewer3dBlade.tsx
  - src/blades/viewer-3d/Viewer3dBlade.test.tsx
  - src/blades/viewer-3d/registration.ts
  - src/blades/viewer-3d/index.ts
  - src/blades/commit-details/CommitDetailsBlade.tsx
  - src/blades/commit-details/CommitDetailsBlade.test.tsx
  - src/blades/commit-details/registration.ts
  - src/blades/commit-details/index.ts
  - src/blades/repo-browser/RepoBrowserBlade.tsx
  - src/blades/repo-browser/RepoBrowserBlade.test.tsx
  - src/blades/repo-browser/registration.tsx
  - src/blades/repo-browser/index.ts
autonomous: true

must_haves:
  truths:
    - "viewer-image blade loads and displays images when navigated to"
    - "viewer-3d blade loads and renders 3D content when navigated to"
    - "commit-details blade loads and shows commit information when navigated to"
    - "repo-browser blade loads and shows repository file tree when navigated to"
    - "All 4 migrated blades are discovered via the new per-blade registration.ts files"
  artifacts:
    - path: "src/blades/viewer-image/registration.ts"
      provides: "Auto-discovered registration for viewer-image blade"
      contains: "registerBlade"
    - path: "src/blades/viewer-3d/registration.ts"
      provides: "Auto-discovered registration for viewer-3d blade"
      contains: "registerBlade"
    - path: "src/blades/commit-details/registration.ts"
      provides: "Auto-discovered registration for commit-details blade"
      contains: "registerBlade"
    - path: "src/blades/repo-browser/registration.tsx"
      provides: "Auto-discovered registration for repo-browser blade"
      contains: "registerBlade"
  key_links:
    - from: "src/blades/_discovery.ts"
      to: "src/blades/*/registration.{ts,tsx}"
      via: "import.meta.glob new-location pattern"
      pattern: './\\*/registration'
---

<objective>
Migrate the 4 simplest self-contained blades to the new blade-centric directory structure.

Purpose: Establish the migration pattern with lowest-risk blades (no stores, no sub-components, zero or minimal shared dependencies). Each blade gets its own directory with component, test, registration, and barrel file.

Output: 4 blade directories under `src/blades/` with co-located files, discovered by the dual-glob mechanism. Old registration files deleted.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-blade-centric-file-structure/29-RESEARCH.md
@.planning/phases/29-blade-centric-file-structure/29-01-SUMMARY.md

@src/components/blades/registrations/viewer-image.ts
@src/components/blades/registrations/viewer-3d.ts
@src/components/blades/registrations/commit-details.ts
@src/components/blades/registrations/repo-browser.tsx
@src/components/blades/ViewerImageBlade.tsx
@src/components/blades/Viewer3dBlade.tsx
@src/components/blades/CommitDetailsBlade.tsx
@src/components/blades/RepoBrowserBlade.tsx
@src/blades/_shared/index.ts
@src/blades/_discovery.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate viewer-image and viewer-3d blades</name>
  <files>
    src/blades/viewer-image/ViewerImageBlade.tsx
    src/blades/viewer-image/ViewerImageBlade.test.tsx
    src/blades/viewer-image/registration.ts
    src/blades/viewer-image/index.ts
    src/blades/viewer-3d/Viewer3dBlade.tsx
    src/blades/viewer-3d/Viewer3dBlade.test.tsx
    src/blades/viewer-3d/registration.ts
    src/blades/viewer-3d/index.ts
  </files>
  <action>
    For EACH of viewer-image and viewer-3d, follow this per-blade migration checklist:

    1. Create `src/blades/{blade-name}/` directory
    2. `git mv src/components/blades/{BladeName}Blade.tsx src/blades/{blade-name}/`
    3. `git mv src/components/blades/{BladeName}Blade.test.tsx src/blades/{blade-name}/`
    4. Create `src/blades/{blade-name}/registration.ts` -- copy content from old `registrations/{blade-name}.ts`, update import paths:
       - `registerBlade` import: `from "../../lib/bladeRegistry"` (or `from "@/lib/bladeRegistry"`)
       - `bladeUtils` import (if used): `from "../../lib/bladeUtils"` (or `from "@/lib/bladeUtils"`)
       - Component import: `from "./{BladeName}Blade"` (relative within blade dir)
       - Use `React.lazy()` for the component import (all non-root blades should be lazy):
         ```typescript
         import { lazy } from "react";
         const ViewerImageBlade = lazy(() =>
           import("./ViewerImageBlade").then((m) => ({ default: m.ViewerImageBlade }))
         );
         ```
         Set `lazy: true` in the registerBlade config.
    5. Create `src/blades/{blade-name}/index.ts` barrel -- export only public types (if any). For simple blades with no public types, export nothing but include a comment:
       ```typescript
       // Public API for {blade-name} blade
       // No public types -- this blade is self-contained
       ```
    6. Update imports inside the moved blade component file:
       - BladeContentLoading, BladeContentError, BladeContentEmpty: `from "../_shared"` (barrel import)
       - Any other shared imports: adjust relative path depth
    7. Update imports inside the moved test file:
       - Adjust relative paths for test-utils/render helper
       - Adjust component import to `from "./{BladeName}Blade"`
    8. Delete old registration file: `git rm src/components/blades/registrations/{blade-name}.ts`
    9. Verify: `tsc --noEmit` passes, `vitest run` passes

    For viewer-image: The registration uses `renderPathBreadcrumb` from bladeUtils -- include that import.
    For viewer-3d: Check if registration uses any path rendering utilities.

    IMPORTANT: Always use `git mv` for moves. Fix ALL import paths in moved files.
  </action>
  <verify>
    - `ls src/blades/viewer-image/` shows ViewerImageBlade.tsx, ViewerImageBlade.test.tsx, registration.ts, index.ts
    - `ls src/blades/viewer-3d/` shows Viewer3dBlade.tsx, Viewer3dBlade.test.tsx, registration.ts, index.ts
    - `tsc --noEmit` passes
    - `vitest run` passes
    - Old files removed: `ls src/components/blades/registrations/viewer-image.ts` fails
    - Old files removed: `ls src/components/blades/registrations/viewer-3d.ts` fails
  </verify>
  <done>viewer-image and viewer-3d blades live in `src/blades/{name}/` with co-located component, test, registration, and barrel. Old registration files deleted. Discovered via dual-glob. TypeScript compiles, tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate commit-details and repo-browser blades</name>
  <files>
    src/blades/commit-details/CommitDetailsBlade.tsx
    src/blades/commit-details/CommitDetailsBlade.test.tsx
    src/blades/commit-details/registration.ts
    src/blades/commit-details/index.ts
    src/blades/repo-browser/RepoBrowserBlade.tsx
    src/blades/repo-browser/RepoBrowserBlade.test.tsx
    src/blades/repo-browser/registration.tsx
    src/blades/repo-browser/index.ts
  </files>
  <action>
    Apply the same per-blade migration checklist from Task 1 for commit-details and repo-browser.

    **commit-details special handling:**
    - CommitDetailsBlade imports `FileTreeBlade` -- update to import from `../_shared` (or `../_shared/FileTreeBlade`)
    - The test file may also reference FileTreeBlade

    **repo-browser special handling:**
    - Registration file is `.tsx` (not `.ts`) -- preserve the extension
    - repo-browser is a singleton blade (`singleton: true` in registration)
    - Check if RepoBrowserBlade imports any infrastructure components and update paths

    For each blade:
    1. Create directory, `git mv` component + test
    2. Create registration.ts/tsx with lazy import and updated paths
    3. Create index.ts barrel
    4. Fix all imports in moved files
    5. Delete old registration file
    6. Run `tsc --noEmit` and `vitest run`
  </action>
  <verify>
    - `ls src/blades/commit-details/` shows CommitDetailsBlade.tsx, CommitDetailsBlade.test.tsx, registration.ts, index.ts
    - `ls src/blades/repo-browser/` shows RepoBrowserBlade.tsx, RepoBrowserBlade.test.tsx, registration.tsx, index.ts
    - `tsc --noEmit` passes
    - `vitest run` passes
    - Old files removed: `ls src/components/blades/registrations/commit-details.ts` fails
    - Old files removed: `ls src/components/blades/registrations/repo-browser.tsx` fails
    - `grep -r "FileTreeBlade" src/blades/commit-details/` shows import from `../_shared`
  </verify>
  <done>commit-details and repo-browser blades live in `src/blades/{name}/` with co-located files. FileTreeBlade import updated to use _shared barrel. Old registration files deleted. 4 total simple blades migrated. TypeScript compiles, tests pass.</done>
</task>

</tasks>

<verification>
- `tsc --noEmit` passes
- `vitest run` -- all tests pass
- 4 blade directories exist under `src/blades/`: viewer-image, viewer-3d, commit-details, repo-browser
- Each has: component, test, registration, index.ts
- No old registration files remain for these 4 blades in `src/components/blades/registrations/`
- Application starts and all 15 blades still discoverable (4 via new location, 11 via old location)
</verification>

<success_criteria>
1. 4 simple blades migrated to `src/blades/{name}/` directories
2. Each blade has co-located component, test, registration, and barrel
3. Old registration files for these 4 blades are deleted
4. Dual-glob discovery finds all 15 blade types (4 new + 11 old)
5. TypeScript compiles, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/29-blade-centric-file-structure/29-02-SUMMARY.md`
</output>
