---
phase: 29-blade-centric-file-structure
plan: 06
type: execute
wave: 3
depends_on: ["29-02", "29-03", "29-04"]
files_modified:
  - src/blades/conventional-commit/ConventionalCommitBlade.tsx
  - src/blades/conventional-commit/ConventionalCommitBlade.test.tsx
  - src/blades/conventional-commit/registration.ts
  - src/blades/conventional-commit/index.ts
  - src/blades/conventional-commit/hooks/useBladeFormGuard.ts
  - src/blades/_discovery.ts
  - src/components/blades/index.ts
  - scripts/check-blade-boundaries.sh
autonomous: true

must_haves:
  truths:
    - "Conventional-commit blade loads with type selector, scope autocomplete, preview, and action bar"
    - "Shared commit components (CommitForm, CommitHistory) still work in sidebar and topology blade"
    - "All 15 blade types are discovered via new per-blade registration.ts files only"
    - "No blade imports from another blade (import boundary enforced)"
    - "Developer can add a new blade by creating files in one directory + one BladePropsMap line"
    - "Old registrations/ directory and stale blade files are completely removed"
  artifacts:
    - path: "src/blades/conventional-commit/registration.ts"
      provides: "Auto-discovered registration for conventional-commit blade"
      contains: "registerBlade"
    - path: "src/blades/conventional-commit/hooks/useBladeFormGuard.ts"
      provides: "Blade-exclusive form guard hook (moved from hooks/)"
    - path: "src/blades/_discovery.ts"
      provides: "Final single-glob discovery (old location removed)"
      contains: "import.meta.glob"
    - path: "scripts/check-blade-boundaries.sh"
      provides: "CI boundary check script"
      contains: "grep.*blades/"
  key_links:
    - from: "src/blades/conventional-commit/ConventionalCommitBlade.tsx"
      to: "src/components/commit/"
      via: "shared commit component imports"
      pattern: 'from.*components/commit'
    - from: "src/blades/_discovery.ts"
      to: "src/blades/*/registration.{ts,tsx}"
      via: "single-glob (old location removed)"
      pattern: './\\*/registration'
---

<objective>
Migrate the conventional-commit blade (most complex, 9+ shared component imports), clean up the old file structure, finalize discovery to single-glob, and add CI boundary enforcement.

Purpose: Complete the migration of all 15 blades, remove the old `components/blades/registrations/` directory, switch discovery from dual-glob to single-glob (new locations only), and add the CI boundary check script. This plan closes out Phase 29.

Output: All 15 blades in `src/blades/` directories. Old structure deleted. Import boundaries enforced via CI script. Zero-config blade extensibility achieved.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-blade-centric-file-structure/29-RESEARCH.md
@.planning/phases/29-blade-centric-file-structure/29-01-SUMMARY.md
@.planning/phases/29-blade-centric-file-structure/29-05-SUMMARY.md

@src/components/blades/ConventionalCommitBlade.tsx
@src/components/blades/registrations/conventional-commit.ts
@src/hooks/useBladeFormGuard.ts
@src/components/commit/TypeSelector.tsx
@src/components/commit/ScopeAutocomplete.tsx
@src/components/commit/CommitForm.tsx
@src/components/commit/CommitHistory.tsx
@src/components/commit/index.ts
@src/blades/_discovery.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate conventional-commit blade with shared commit components</name>
  <files>
    src/blades/conventional-commit/ConventionalCommitBlade.tsx
    src/blades/conventional-commit/ConventionalCommitBlade.test.tsx
    src/blades/conventional-commit/registration.ts
    src/blades/conventional-commit/hooks/useBladeFormGuard.ts
    src/blades/conventional-commit/index.ts
  </files>
  <action>
    1. Create dirs: `src/blades/conventional-commit/`, `src/blades/conventional-commit/hooks/`

    2. `git mv` blade files:
       ```
       git mv src/components/blades/ConventionalCommitBlade.tsx src/blades/conventional-commit/
       git mv src/components/blades/ConventionalCommitBlade.test.tsx src/blades/conventional-commit/
       ```
       Check if ConventionalCommitBlade.test.tsx exists first.

    3. `git mv` the blade-exclusive hook:
       ```
       git mv src/hooks/useBladeFormGuard.ts src/blades/conventional-commit/hooks/
       ```

    4. Create `src/blades/conventional-commit/registration.ts`:
       ```typescript
       import { lazy } from "react";
       import { registerBlade } from "@/lib/bladeRegistry";

       const ConventionalCommitBlade = lazy(() =>
         import("./ConventionalCommitBlade").then((m) => ({ default: m.ConventionalCommitBlade }))
       );

       registerBlade({
         type: "conventional-commit",
         defaultTitle: "Conventional Commit",
         component: ConventionalCommitBlade,
         lazy: true,
         singleton: true,
       });
       ```

    5. Create `src/blades/conventional-commit/index.ts`:
       ```typescript
       // Public API for conventional-commit blade
       // No public types -- commit components shared via components/commit/
       ```

    6. Update imports in `ConventionalCommitBlade.tsx`:
       - `useBladeFormGuard` -> `from "./hooks/useBladeFormGuard"`
       - `useConventionalCommit` -> `from "@/hooks/useConventionalCommit"` (SHARED hook used by sidebar too)
       - `useCommitExecution` -> `from "@/hooks/useCommitExecution"` (SHARED)
       - `useAmendPrefill` -> `from "@/hooks/useAmendPrefill"` (SHARED)
       - All commit sub-components stay in `components/commit/` because they're SHARED with sidebar CommitForm:
         - `TypeSelector` -> `from "@/components/commit/TypeSelector"`
         - `ScopeAutocomplete` -> `from "@/components/commit/ScopeAutocomplete"`
         - `BreakingChangeSection` -> `from "@/components/commit/BreakingChangeSection"`
         - `CharacterProgress` -> `from "@/components/commit/CharacterProgress"`
         - `ValidationErrors` -> `from "@/components/commit/ValidationErrors"`
         - `CommitPreview` -> `from "@/components/commit/CommitPreview"`
         - `CommitActionBar` -> `from "@/components/commit/CommitActionBar"`
         - `TemplateSelector` -> `from "@/components/commit/TemplateSelector"`
         - `ScopeFrequencyChart` -> `from "@/components/commit/ScopeFrequencyChart"`
       - BladeContent* -> `from "../_shared"`
       - `useConventionalStore` -> `from "@/stores/conventional"` (SHARED)

    7. Update `useBladeFormGuard.ts`: Adjust any imports to new relative paths (it references navigation machine, etc.).

    8. Delete old registration: `git rm src/components/blades/registrations/conventional-commit.ts`

    IMPORTANT: Do NOT move ANY files from `components/commit/` into the blade. The commit sub-components are SHARED between ConventionalCommitBlade and the sidebar CommitForm. Research confirms: CommitForm, CommitHistory, CommitDetails, CommitSearch are used by sidebar. TypeSelector, ScopeAutocomplete, BreakingChangeSection, etc. are also used by CommitForm which is in the sidebar. The research suggested splitting them, but the actual imports show CommitForm in the sidebar imports them individually. Since they are shared by design, keep all in `components/commit/`.
  </action>
  <verify>
    - `ls -R src/blades/conventional-commit/` shows blade, test (if exists), registration, index, hooks/useBladeFormGuard.ts
    - `tsc --noEmit` passes
    - `vitest run` passes
    - `ls src/components/commit/` still exists (shared commit components NOT moved)
    - `ls src/hooks/useBladeFormGuard.ts` fails (hook moved to blade)
    - Old registration deleted
    - `grep -r "components/commit" src/blades/conventional-commit/` shows shared imports
  </verify>
  <done>Conventional-commit blade migrated. Shared commit components correctly remain in `components/commit/`. useBladeFormGuard hook co-located. All 15 blades now in `src/blades/` directories.</done>
</task>

<task type="auto">
  <name>Task 2: Delete old structure, finalize discovery to single-glob, add CI boundary check</name>
  <files>
    src/blades/_discovery.ts
    src/components/blades/index.ts
    scripts/check-blade-boundaries.sh
  </files>
  <action>
    1. **Verify all 15 blades have registration files in new locations:**
       ```bash
       ls src/blades/*/registration.{ts,tsx}
       ```
       Should list exactly 15 files (one per blade type).

    2. **Delete the old registrations directory:**
       ```
       git rm -r src/components/blades/registrations/
       ```
       This removes the entire old registrations/ directory including the index.ts barrel.

    3. **Delete remaining old blade files from `src/components/blades/`:**
       After all blades have been migrated, `src/components/blades/` should only contain `index.ts` (the barrel). Check what remains:
       ```bash
       ls src/components/blades/
       ```
       - If only `index.ts` remains: update it to be an empty barrel or delete it entirely (check if anything still imports from it)
       - If any blade component files remain (shouldn't): these are bugs -- they should have been migrated
       - Grep for any imports from `components/blades/` and update them

    4. **Update `src/blades/_discovery.ts` to single-glob (remove old location):**
       ```typescript
       import { clearRegistry, getAllBladeTypes } from "@/lib/bladeRegistry";

       // Auto-discover all blade registration modules
       const modules = import.meta.glob(
         ["./*/registration.{ts,tsx}", "!./_shared/**"],
         { eager: true }
       );

       // Guard against misconfigured paths
       if (import.meta.env.DEV && Object.keys(modules).length === 0) {
         console.error("[BladeRegistry] No registration modules found -- check src/blades/*/registration.{ts,tsx}");
       }

       // Dev-mode exhaustiveness check
       if (import.meta.env.DEV && !import.meta.hot?.data?.isUpdate) {
         const registered = new Set(getAllBladeTypes());
         const EXPECTED_TYPES: string[] = [
           "staging-changes", "topology-graph", "commit-details", "diff",
           "viewer-nupkg", "viewer-image", "viewer-markdown", "viewer-3d",
           "viewer-code", "repo-browser", "settings", "changelog",
           "gitflow-cheatsheet", "init-repo", "conventional-commit",
         ];
         const missing = EXPECTED_TYPES.filter(t => !registered.has(t as any));
         if (missing.length > 0) {
           console.warn(
             `[BladeRegistry] Missing registrations: ${missing.join(", ")}. ` +
             `Create a registration.ts in src/blades/{blade-name}/ for each.`
           );
         }
       }

       // HMR: clear registry before re-execution so re-registration is clean
       if (import.meta.hot) {
         import.meta.hot.accept();
         import.meta.hot.dispose((data) => {
           data.isUpdate = true;
           clearRegistry();
         });
       }
       ```

    5. **Create CI boundary check script** at `scripts/check-blade-boundaries.sh`:
       ```bash
       #!/bin/bash
       # Check that no blade imports from another blade's internal files.
       # Blades may only import from:
       #   - Their own directory
       #   - blades/_shared/ (infrastructure barrel)
       #   - Shared directories (stores/, hooks/, lib/, components/)
       #   - Third-party packages

       EXIT=0
       for blade_dir in src/blades/*/; do
         blade_name=$(basename "$blade_dir")
         [[ "$blade_name" == _* ]] && continue  # Skip _shared

         # Check if this blade imports from any other blade's internals
         for other_dir in src/blades/*/; do
           other_name=$(basename "$other_dir")
           [[ "$other_name" == _* ]] && continue
           [[ "$other_name" == "$blade_name" ]] && continue

           # Check for imports from other blade's internal files (not barrel)
           if grep -r "from.*blades/$other_name/" "$blade_dir" --include="*.ts" --include="*.tsx" -l 2>/dev/null; then
             echo "ERROR: $blade_name imports from blades/$other_name/"
             EXIT=1
           fi
         done
       done

       if [ $EXIT -eq 0 ]; then
         echo "OK: No cross-blade imports found"
       fi
       exit $EXIT
       ```
       Make it executable: `chmod +x scripts/check-blade-boundaries.sh`

    6. **Final cleanup pass:**
       - Run `grep -r "components/blades/" src/ --include="*.ts" --include="*.tsx"` to find any remaining imports of the old location
       - Update any stale imports found
       - Check `src/components/blades/index.ts` -- if it still exists and exports blade components, update or remove it
       - Verify `src/components/blades/` can be deleted entirely or only contains the index.ts barrel (which can be deleted if nothing imports it)

    7. **Run final verification:**
       ```bash
       tsc --noEmit
       vitest run
       bash scripts/check-blade-boundaries.sh
       ```
  </action>
  <verify>
    - `ls src/components/blades/registrations/` fails (directory deleted)
    - `grep -r "components/blades/registrations" src/` returns nothing
    - `bash scripts/check-blade-boundaries.sh` exits 0 (no cross-blade imports)
    - `tsc --noEmit` passes
    - `vitest run` passes
    - `ls src/blades/*/registration.{ts,tsx} | wc -l` returns 15
    - `cat src/blades/_discovery.ts` shows single-glob pattern (no old location reference)
    - `grep -r "from.*components/blades/[A-Z]" src/` returns nothing (no stale blade component imports)
  </verify>
  <done>Old registrations directory deleted. Discovery switched to single-glob. CI boundary check script created and passing. All 15 blades in new structure. No cross-blade imports. No stale references to old file locations. Phase 29 migration complete.</done>
</task>

</tasks>

<verification>
- `tsc --noEmit` passes
- `vitest run` -- all tests pass
- All 15 blade types have `registration.{ts,tsx}` in `src/blades/{name}/`
- `src/components/blades/registrations/` directory no longer exists
- `src/blades/_discovery.ts` uses single-glob pattern
- `bash scripts/check-blade-boundaries.sh` passes (no cross-blade imports)
- `grep -r "from.*components/blades/[A-Z]" src/` returns nothing
- Application starts and all 15 blade types render correctly
</verification>

<success_criteria>
1. All 15 blades live in `src/blades/{name}/` directories with co-located files
2. Old `components/blades/registrations/` directory deleted
3. Discovery uses single-glob (new locations only)
4. CI boundary check script exists and passes
5. No cross-blade imports anywhere in the codebase
6. Developer can add a new blade by creating files in one directory + one BladePropsMap line
7. TypeScript compiles, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/29-blade-centric-file-structure/29-06-SUMMARY.md`
</output>
