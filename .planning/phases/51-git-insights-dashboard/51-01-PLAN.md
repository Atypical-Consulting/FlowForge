---
phase: 51-git-insights-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/git/insights.rs
  - src-tauri/src/git/mod.rs
  - src-tauri/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Rust backend can aggregate daily commit counts within a configurable time range"
    - "Rust backend can compute contributor statistics with commit counts and percentages"
    - "Rust backend can produce branch health info with last commit timestamp, ahead/behind, and staleness"
    - "Rust backend returns repo-level summary stats (total commits, active branches, contributors, repo age)"
  artifacts:
    - path: "src-tauri/src/git/insights.rs"
      provides: "Analytics aggregation commands"
      exports: ["get_repo_insights", "get_branch_health"]
    - path: "src-tauri/src/git/mod.rs"
      provides: "Module registration for insights"
      contains: "pub mod insights"
    - path: "src-tauri/src/lib.rs"
      provides: "Tauri command registration for insights commands"
      contains: "get_repo_insights"
  key_links:
    - from: "src-tauri/src/git/insights.rs"
      to: "src-tauri/src/git/repository.rs"
      via: "RepositoryState for repo path access"
      pattern: "State<'_, RepositoryState>"
    - from: "src-tauri/src/git/insights.rs"
      to: "src-tauri/src/git/error.rs"
      via: "GitError for error handling"
      pattern: "Result<.*, GitError>"
    - from: "src-tauri/src/lib.rs"
      to: "src-tauri/src/git/insights.rs"
      via: "Command imports and collect_commands registration"
      pattern: "insights::\\{get_repo_insights, get_branch_health\\}"
---

<objective>
Create Rust backend analytics commands that aggregate repository data server-side.

Purpose: Avoid transferring thousands of raw commits over IPC. The Rust backend performs single-pass revwalk aggregation and returns pre-computed summaries (daily commit counts, contributor stats, branch health, repo-level metrics). This is the data foundation for the entire insights dashboard.

Output: Two new Tauri commands (`get_repo_insights` and `get_branch_health`) in a new `insights.rs` module, wired into lib.rs and generating TypeScript bindings via tauri-specta.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-git-insights-dashboard/51-RESEARCH.md

@src-tauri/src/git/repository.rs
@src-tauri/src/git/error.rs
@src-tauri/src/git/branch.rs
@src-tauri/src/git/mod.rs
@src-tauri/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create insights.rs with analytics structs and get_repo_insights command</name>
  <files>src-tauri/src/git/insights.rs</files>
  <action>
Create `src-tauri/src/git/insights.rs` with the following:

**Types (all derive Debug, Clone, Serialize, Deserialize, Type with `#[serde(rename_all = "camelCase")]`):**

1. `DailyCommitCount` — `{ date: String (YYYY-MM-DD), count: u32 }`
2. `ContributorStats` — `{ name: String, email: String, commit_count: u32, percentage: f64, first_commit_ms: f64, last_commit_ms: f64 }`
3. `RepoInsights` — `{ total_commits: u32, active_branches: u32, contributor_count: u32, first_commit_ms: f64, daily_commits: Vec<DailyCommitCount>, contributors: Vec<ContributorStats> }`
4. `BranchHealthInfo` — `{ name: String, is_head: bool, is_remote: bool, last_commit_date: String (YYYY-MM-DD), last_commit_timestamp_ms: f64, last_commit_message: String, ahead: u32, behind: u32, is_stale: bool, is_merged: Option<bool> }`

**Command 1: `get_repo_insights(days: u32, state: State<'_, RepositoryState>) -> Result<RepoInsights, GitError>`**

Implementation:
- Use `tokio::task::spawn_blocking` (project standard for all git2 operations)
- Open repo from `state.get_path().await`
- Single-pass revwalk from HEAD, sorted by TIME
- Compute cutoff timestamp: `Utc::now().timestamp() - (days as i64 * 86400)`
- Use two `HashMap`s: `daily: HashMap<String, u32>` for date bucketing, `authors: HashMap<String, (String, u32, i64, i64)>` for contributor aggregation (email -> (name, count, first_ts, last_ts))
- For each commit in revwalk:
  - If timestamp >= cutoff: bucket into daily and authors maps, increment total
  - If timestamp < cutoff: break early (commits are time-sorted)
- Count active branches by iterating `repo.branches(None)` (both local and remote)
- Compute `first_commit_ms` from the earliest timestamp seen
- Convert `daily` HashMap to sorted `Vec<DailyCommitCount>` (sort by date ascending)
- Convert `authors` HashMap to `Vec<ContributorStats>` sorted by commit_count descending
- Calculate each contributor's `percentage` as `(commit_count as f64 / total as f64) * 100.0`
- Convert timestamps to milliseconds for JS compatibility (`ts * 1000` as f64)

**Command 2: `get_branch_health(stale_days: u32, state: State<'_, RepositoryState>) -> Result<Vec<BranchHealthInfo>, GitError>`**

Implementation:
- Use `tokio::task::spawn_blocking`
- Open repo, get HEAD commit for merge base checks
- Iterate `repo.branches(None)` for all branches (local + remote)
- For each branch:
  - Get tip commit, extract timestamp, format date as YYYY-MM-DD
  - Compute ahead/behind vs HEAD using `repo.graph_ahead_behind(branch_oid, head_oid)`
  - Compute `is_stale`: last commit timestamp < `Utc::now().timestamp() - (stale_days as i64 * 86400)`
  - Compute `is_merged` same as existing `branch.rs` pattern (merge_base == branch oid)
- Sort results: HEAD branch first, then by last_commit_timestamp_ms descending
- Use `chrono::Utc` for timestamp operations (already in Cargo.toml)

Import `use chrono::Utc;` and `use std::collections::HashMap;`. Reuse `GitError` from `crate::git::error` and `RepositoryState` from `crate::git::repository`.

Note: The pre-existing TS2440 error in bindings.ts is a known issue -- ignore it when type-checking.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge/src-tauri && cargo check 2>&1 | grep -E "^error" | head -5` — should show no new errors (the pre-existing TS2440 is in the frontend, not Rust).
  </verify>
  <done>
insights.rs exists with DailyCommitCount, ContributorStats, RepoInsights, BranchHealthInfo types and two Tauri commands (get_repo_insights, get_branch_health) that compile successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire insights commands into mod.rs and lib.rs for Tauri registration</name>
  <files>src-tauri/src/git/mod.rs, src-tauri/src/lib.rs</files>
  <action>
**In `src-tauri/src/git/mod.rs`:**
Add `pub mod insights;` to the module list (alphabetically, between `history` and `init`).

**In `src-tauri/src/lib.rs`:**

1. Add import in the `use crate::git::{ ... }` block:
   ```rust
   insights::{get_repo_insights, get_branch_health},
   ```
   Place it alphabetically between the `init` and `merge` imports.

2. Add to the `collect_commands![ ... ]` macro invocation:
   ```rust
   // Insights commands
   get_repo_insights,
   get_branch_health,
   ```
   Place after the Browse commands section and before the Config commands section.

After this, running `cargo build` in debug mode will regenerate `src/bindings.ts` with the new command types via tauri-specta. The new TypeScript bindings will include `getRepoInsights` and `getBranchHealth` functions in the `commands` object, plus `DailyCommitCount`, `ContributorStats`, `RepoInsights`, and `BranchHealthInfo` types.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge/src-tauri && cargo build 2>&1 | tail -5` — should compile successfully. Then verify bindings: `grep -c "getRepoInsights\|getBranchHealth" ../src/bindings.ts` should return 2 or more matches.
  </verify>
  <done>
The two insight commands are registered in Tauri's invoke handler. Running `cargo build` regenerates bindings.ts with getRepoInsights, getBranchHealth, and all associated types (DailyCommitCount, ContributorStats, RepoInsights, BranchHealthInfo).
  </done>
</task>

</tasks>

<verification>
1. `cargo check` in src-tauri passes with no new errors
2. `cargo build` succeeds and regenerates bindings.ts
3. `grep "getRepoInsights" src/bindings.ts` finds the generated TypeScript function
4. `grep "getBranchHealth" src/bindings.ts` finds the generated TypeScript function
5. `grep "DailyCommitCount" src/bindings.ts` finds the generated type
6. `grep "BranchHealthInfo" src/bindings.ts` finds the generated type
</verification>

<success_criteria>
Two new Tauri commands (get_repo_insights, get_branch_health) compile, are registered in the Tauri invoke handler, and generate TypeScript bindings. The commands perform server-side aggregation using single-pass revwalk with HashMap accumulation and early timestamp cutoff.
</success_criteria>

<output>
After completion, create `.planning/phases/51-git-insights-dashboard/51-01-SUMMARY.md`
</output>
