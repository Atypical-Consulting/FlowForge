---
phase: 51-git-insights-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["51-01", "51-02"]
files_modified:
  - src/extensions/git-insights/manifest.json
  - src/extensions/git-insights/index.ts
  - src/extensions/git-insights/insightsStore.ts
  - src/extensions/git-insights/hooks/useInsightsData.ts
  - src/extensions/git-insights/blades/InsightsDashboardBlade.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Git Insights extension appears in Extension Manager and can be enabled/disabled"
    - "Clicking 'Insights' toolbar button opens the insights dashboard blade"
    - "Insights store loads data from Rust backend and manages time range and contributor selection"
    - "Dashboard blade renders four dashboard sections in a responsive layout"
    - "Data auto-refreshes on repository-changed events"
  artifacts:
    - path: "src/extensions/git-insights/manifest.json"
      provides: "Extension manifest declaring blade, command, toolbar"
      contains: "git-insights"
    - path: "src/extensions/git-insights/index.ts"
      provides: "Extension lifecycle with blade, command, toolbar, repo-changed listener"
      exports: ["onActivate", "onDeactivate"]
    - path: "src/extensions/git-insights/insightsStore.ts"
      provides: "Zustand store for insights data, time range, contributor selection"
      exports: ["useInsightsStore"]
    - path: "src/extensions/git-insights/hooks/useInsightsData.ts"
      provides: "React hook that triggers data loading on mount and time range change"
      exports: ["useInsightsData"]
    - path: "src/extensions/git-insights/blades/InsightsDashboardBlade.tsx"
      provides: "Main dashboard blade with responsive grid layout"
      exports: ["InsightsDashboardBlade"]
    - path: "src/App.tsx"
      provides: "registerBuiltIn call for git-insights extension"
      contains: "git-insights"
  key_links:
    - from: "src/extensions/git-insights/insightsStore.ts"
      to: "src/bindings.ts"
      via: "commands.getRepoInsights and commands.getBranchHealth"
      pattern: "commands\\.(getRepoInsights|getBranchHealth)"
    - from: "src/extensions/git-insights/index.ts"
      to: "src/extensions/ExtensionAPI.ts"
      via: "registerBlade, registerCommand, contributeToolbar"
      pattern: "api\\.register"
    - from: "src/App.tsx"
      to: "src/extensions/git-insights/index.ts"
      via: "registerBuiltIn with activate/deactivate"
      pattern: "registerBuiltIn.*git-insights"
    - from: "src/extensions/git-insights/index.ts"
      to: "@tauri-apps/api/event"
      via: "listen('repository-changed') for auto-refresh"
      pattern: "listen.*repository-changed"
---

<objective>
Create the Git Insights extension scaffold: manifest, lifecycle, Zustand store, data-loading hook, and the main dashboard blade shell.

Purpose: Wire the Rust backend (Plan 01) to a fully functional extension that appears in the Extension Manager, contributes a toolbar button, opens a dashboard blade, and manages analytics data via a dedicated Zustand store. The dashboard blade will lay out sections that Plan 04 populates with rich chart components.

Output: A complete, activatable `git-insights` built-in extension with manifest, lifecycle, store, hook, and dashboard blade registered in App.tsx.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-git-insights-dashboard/51-RESEARCH.md
@.planning/phases/51-git-insights-dashboard/51-01-SUMMARY.md
@.planning/phases/51-git-insights-dashboard/51-02-SUMMARY.md

@src/extensions/topology/index.ts
@src/extensions/topology/manifest.json
@src/extensions/github/githubStore.ts
@src/extensions/ExtensionAPI.ts
@src/App.tsx
@src/bindings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extension manifest, store, and data hook</name>
  <files>src/extensions/git-insights/manifest.json, src/extensions/git-insights/insightsStore.ts, src/extensions/git-insights/hooks/useInsightsData.ts</files>
  <action>
**Create `src/extensions/git-insights/manifest.json`:**

```json
{
  "id": "git-insights",
  "name": "Git Insights Dashboard",
  "version": "1.0.0",
  "description": "Data-driven repository analytics with commit activity charts, contributor breakdown, branch health, and author avatars.",
  "apiVersion": "1",
  "main": "index.ts",
  "contributes": {
    "blades": [{ "type": "insights-dashboard", "title": "Insights" }],
    "commands": [{ "id": "show-insights", "title": "Show Insights", "category": "Navigation" }],
    "toolbar": [{ "id": "insights", "label": "Insights", "group": "views", "priority": 40 }]
  },
  "trustLevel": "built-in"
}
```

**Create `src/extensions/git-insights/insightsStore.ts`:**

Follow the githubStore pattern (standalone Zustand store, NOT a git-ops slice). Use `devtools` middleware with `enabled: import.meta.env.DEV`.

```typescript
import { create } from "zustand";
import { devtools } from "zustand/middleware";
import { commands } from "../../bindings";
import type { TimeRange, RepoInsights, BranchHealthInfo } from "./types";

interface InsightsState {
  // Data
  insights: RepoInsights | null;
  branchHealth: BranchHealthInfo[];
  isLoading: boolean;
  error: string | null;

  // Filters
  timeRange: TimeRange;
  selectedContributor: string | null;  // email or null

  // Actions
  loadInsights: () => Promise<void>;
  loadBranchHealth: () => Promise<void>;
  setTimeRange: (range: TimeRange) => void;
  selectContributor: (email: string | null) => void;
  reset: () => void;
}

const STALE_DAYS = 30;  // Branches older than 30 days are flagged stale

export const useInsightsStore = create<InsightsState>()(
  devtools(
    (set, get) => ({
      insights: null,
      branchHealth: [],
      isLoading: false,
      error: null,
      timeRange: 30,
      selectedContributor: null,

      loadInsights: async () => {
        set({ isLoading: true, error: null }, false, "insights/load-start");
        try {
          const result = await commands.getRepoInsights(get().timeRange);
          if (result.status === "error") {
            const errMsg = "message" in result.error ? result.error.message : result.error.type;
            set({ error: errMsg, isLoading: false }, false, "insights/load-error");
            return;
          }
          set({ insights: result.data, isLoading: false }, false, "insights/load-success");
        } catch (e) {
          set({
            error: e instanceof Error ? e.message : String(e),
            isLoading: false,
          }, false, "insights/load-error");
        }
      },

      loadBranchHealth: async () => {
        try {
          const result = await commands.getBranchHealth(STALE_DAYS);
          if (result.status === "error") return;
          set({ branchHealth: result.data }, false, "insights/branch-health-loaded");
        } catch {
          // Silent fail -- branch health is supplementary
        }
      },

      setTimeRange: (range) => {
        set({ timeRange: range }, false, "insights/set-time-range");
        get().loadInsights();
      },

      selectContributor: (email) => {
        set({ selectedContributor: email }, false, "insights/select-contributor");
      },

      reset: () => {
        set({
          insights: null,
          branchHealth: [],
          isLoading: false,
          error: null,
          timeRange: 30,
          selectedContributor: null,
        }, false, "insights/reset");
      },
    }),
    { name: "git-insights", enabled: import.meta.env.DEV },
  ),
);
```

Key: Handle the tauri-specta result pattern (`result.status === "error"`) consistently with other stores. The `reset()` action is called from `onDeactivate` for clean state.

**Create `src/extensions/git-insights/hooks/useInsightsData.ts`:**

```typescript
import { useEffect } from "react";
import { useInsightsStore } from "../insightsStore";

/**
 * Triggers insights data loading on mount and when time range changes.
 * Call this in the dashboard blade component.
 */
export function useInsightsData() {
  const loadInsights = useInsightsStore((s) => s.loadInsights);
  const loadBranchHealth = useInsightsStore((s) => s.loadBranchHealth);
  const timeRange = useInsightsStore((s) => s.timeRange);

  useEffect(() => {
    loadInsights();
    loadBranchHealth();
  }, [loadInsights, loadBranchHealth, timeRange]);

  return useInsightsStore();
}
```

This hook triggers both data loads on mount. When `setTimeRange` is called, it already calls `loadInsights()` internally, but the effect also re-runs due to `timeRange` changing (handles the case of remounting with a different range).
  </action>
  <verify>
Run `npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "git-insights/(insightsStore|hooks)" | head -5` — no type errors.
  </verify>
  <done>
Extension manifest defines blade, command, and toolbar contributions. Zustand store manages insights data, branch health, time range, and contributor selection with proper error handling. Data hook triggers loading on mount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create extension index.ts, dashboard blade, and register in App.tsx</name>
  <files>src/extensions/git-insights/index.ts, src/extensions/git-insights/blades/InsightsDashboardBlade.tsx, src/App.tsx</files>
  <action>
**Create `src/extensions/git-insights/index.ts`:**

Follow the topology extension pattern exactly. Register blade (lazy-loaded), command, toolbar, and repository-changed listener.

```typescript
import { lazy } from "react";
import { BarChart3 } from "lucide-react";
import { listen } from "@tauri-apps/api/event";
import type { ExtensionAPI } from "../ExtensionAPI";
import { openBlade } from "../../core/lib/bladeOpener";
import { useGitOpsStore } from "../../core/stores/domain/git-ops";
import { useInsightsStore } from "./insightsStore";

export async function onActivate(api: ExtensionAPI): Promise<void> {
  // 1. Register lazy-loaded dashboard blade
  const InsightsDashboardBlade = lazy(() =>
    import("./blades/InsightsDashboardBlade").then((m) => ({
      default: m.InsightsDashboardBlade,
    }))
  );

  api.registerBlade({
    type: "insights-dashboard",
    title: "Insights",
    component: InsightsDashboardBlade,
    singleton: true,
    lazy: true,
    wrapInPanel: true,
    showBack: true,
  });

  // 2. Register "Show Insights" command
  api.registerCommand({
    id: "show-insights",
    title: "Show Insights Dashboard",
    description: "View repository analytics and activity charts",
    category: "Navigation",
    icon: BarChart3,
    keywords: ["insights", "analytics", "activity", "contributors", "stats", "dashboard"],
    action: () => openBlade("ext:git-insights:insights-dashboard", {}),
    enabled: () => !!useGitOpsStore.getState().repoStatus,
  });

  // 3. Contribute toolbar button
  api.contributeToolbar({
    id: "insights",
    label: "Insights",
    icon: BarChart3,
    group: "views",
    priority: 40,
    when: () => !!useGitOpsStore.getState().repoStatus,
    execute: () => openBlade("ext:git-insights:insights-dashboard", {}),
  });

  // 4. Auto-refresh on repository changes (same pattern as topology)
  const unlisten = await listen<{ paths: string[] }>("repository-changed", () => {
    if (useInsightsStore.getState().insights) {
      useInsightsStore.getState().loadInsights();
      useInsightsStore.getState().loadBranchHealth();
    }
  });
  api.onDispose(() => unlisten());
}

export function onDeactivate(): void {
  // Reset store state on deactivation
  useInsightsStore.getState().reset();
}
```

**Create `src/extensions/git-insights/blades/InsightsDashboardBlade.tsx`:**

The main dashboard blade. Uses a responsive grid layout with glass-morphism cards. Imports actual chart/stat components from Plan 04 via lazy loading, but for now renders section placeholders that Plan 04 will replace with real components.

```tsx
import { motion } from "framer-motion";
import { BarChart3, GitBranch, Users, Activity } from "lucide-react";
import { useInsightsData } from "../hooks/useInsightsData";
import { TimeRangeSelector } from "../components/TimeRangeSelector";
import { useInsightsStore } from "../insightsStore";
import { CommitActivityChart } from "../components/CommitActivityChart";
import { ContributorBreakdown } from "../components/ContributorBreakdown";
import { BranchHealthOverview } from "../components/BranchHealthOverview";
import { RepoStatsCards } from "../components/RepoStatsCards";

export function InsightsDashboardBlade() {
  const { insights, branchHealth, isLoading, error } = useInsightsData();
  const timeRange = useInsightsStore((s) => s.timeRange);
  const setTimeRange = useInsightsStore((s) => s.setTimeRange);

  if (error) {
    return (
      <div className="flex h-full items-center justify-center text-ctp-red">
        <div className="text-center">
          <BarChart3 className="mx-auto mb-2 h-8 w-8 opacity-50" />
          <p className="text-sm">{error}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex h-full flex-col overflow-hidden">
      {/* Header with title and time range */}
      <div className="flex items-center justify-between border-b border-ctp-surface0/50 px-5 py-3">
        <div className="flex items-center gap-2.5">
          <BarChart3 className="h-4.5 w-4.5 text-ctp-blue" />
          <h2 className="text-sm font-semibold text-ctp-text">Repository Insights</h2>
        </div>
        <TimeRangeSelector value={timeRange} onChange={setTimeRange} />
      </div>

      {/* Dashboard content */}
      <div className="flex-1 overflow-y-auto p-5">
        <motion.div
          className="flex flex-col gap-5"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.2 }}
        >
          {/* Row 1: Stats cards */}
          <RepoStatsCards insights={insights} branchCount={branchHealth.length} isLoading={isLoading} />

          {/* Row 2: Commit activity chart (full width) */}
          <DashboardCard title="Commit Activity" icon={Activity} isLoading={isLoading}>
            {insights && <CommitActivityChart data={insights.dailyCommits} />}
          </DashboardCard>

          {/* Row 3: Contributors + Branch Health (two columns on wide, stacked on narrow) */}
          <div className="grid grid-cols-1 gap-5 xl:grid-cols-2">
            <DashboardCard title="Contributors" icon={Users} isLoading={isLoading}>
              {insights && (
                <ContributorBreakdown
                  contributors={insights.contributors}
                  totalCommits={insights.totalCommits}
                />
              )}
            </DashboardCard>

            <DashboardCard title="Branch Health" icon={GitBranch} isLoading={isLoading}>
              <BranchHealthOverview branches={branchHealth} />
            </DashboardCard>
          </div>
        </motion.div>
      </div>
    </div>
  );
}

/** Reusable glass-morphism card wrapper for dashboard sections */
function DashboardCard({
  title,
  icon: Icon,
  isLoading,
  children,
}: {
  title: string;
  icon: React.ComponentType<{ className?: string }>;
  isLoading: boolean;
  children: React.ReactNode;
}) {
  return (
    <div className="rounded-xl border border-ctp-surface0/50 bg-ctp-mantle/60 backdrop-blur-sm">
      <div className="flex items-center gap-2 border-b border-ctp-surface0/30 px-4 py-2.5">
        <Icon className="h-3.5 w-3.5 text-ctp-subtext0" />
        <span className="text-xs font-medium text-ctp-subtext1">{title}</span>
      </div>
      <div className="p-4">
        {isLoading ? (
          <div className="flex items-center justify-center py-8">
            <div className="h-5 w-5 animate-spin rounded-full border-2 border-ctp-surface2 border-t-ctp-blue" />
          </div>
        ) : (
          children
        )}
      </div>
    </div>
  );
}
```

Key design decisions:
- Glass-morphism cards: `bg-ctp-mantle/60 backdrop-blur-sm` with subtle borders
- Consistent visual hierarchy: card headers use `text-xs font-medium text-ctp-subtext1`
- Loading spinner: CSS-only spin animation with Catppuccin blue accent
- Error state: centered with dimmed icon
- Responsive: Contributors and Branch Health stack on narrow, side-by-side on xl
- `motion.div` with opacity fade on initial render

**Update `src/App.tsx`:**

Add the git-insights extension registration alongside the existing built-in extensions.

1. Add imports near the other extension imports (around the topology/github/gitflow imports):
```typescript
import { onActivate as insightsActivate, onDeactivate as insightsDeactivate } from "./extensions/git-insights";
```

2. Add `registerBuiltIn` call after the existing extensions (e.g., after the topology registration):
```typescript
registerBuiltIn({
  id: "git-insights",
  name: "Git Insights Dashboard",
  version: "1.0.0",
  activate: insightsActivate,
  deactivate: insightsDeactivate,
});
```

Place it logically near the topology and github registrations since they're all "views" group extensions.
  </action>
  <verify>
Run `npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "git-insights" | head -10` — no type errors. Note: This plan creates imports of CommitActivityChart, ContributorBreakdown, BranchHealthOverview, and RepoStatsCards which don't exist yet -- if type-checking fails due to missing modules, create minimal stub exports for each (just `export function ComponentName() { return null; }`) to unblock compilation. Plan 04 will replace the stubs with real implementations.
  </verify>
  <done>
Git Insights extension is fully wired: manifest declares contributions, index.ts registers blade/command/toolbar with repository-changed auto-refresh, store manages all data and filters, dashboard blade renders a responsive grid layout with glass-morphism cards, and App.tsx registers it as a built-in extension.
  </done>
</task>

</tasks>

<verification>
1. `grep "git-insights" src/App.tsx` — extension registered in App.tsx
2. `grep "registerBlade" src/extensions/git-insights/index.ts` — blade registered
3. `grep "registerCommand" src/extensions/git-insights/index.ts` — command registered
4. `grep "contributeToolbar" src/extensions/git-insights/index.ts` — toolbar contributed
5. `grep "repository-changed" src/extensions/git-insights/index.ts` — auto-refresh subscribed
6. `grep "getRepoInsights" src/extensions/git-insights/insightsStore.ts` — store calls backend
7. Dashboard blade imports all four section components and TimeRangeSelector
</verification>

<success_criteria>
Git Insights extension can be activated and deactivated from the Extension Manager. When activated with a repo open, the toolbar shows an Insights button. Clicking it opens the dashboard blade which loads data via the store and renders four sections in a responsive layout with glass-morphism cards and loading states.
</success_criteria>

<output>
After completion, create `.planning/phases/51-git-insights-dashboard/51-03-SUMMARY.md`
</output>
