---
phase: 51-git-insights-dashboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/extensions/git-insights/types.ts
  - src/extensions/git-insights/lib/gravatar.ts
  - src/extensions/git-insights/lib/chartTheme.ts
  - src/extensions/git-insights/components/GravatarAvatar.tsx
  - src/extensions/git-insights/components/TimeRangeSelector.tsx
autonomous: true

must_haves:
  truths:
    - "visx packages are installed and importable"
    - "Gravatar URL generation uses SHA-256 with in-memory hash caching"
    - "GravatarAvatar component renders Gravatar images with initials fallback on error"
    - "Chart theme uses Catppuccin Mocha color tokens"
    - "TimeRangeSelector renders clickable 7/30/90 day options"
  artifacts:
    - path: "src/extensions/git-insights/types.ts"
      provides: "TypeScript type aliases for insights data"
      contains: "TimeRange"
    - path: "src/extensions/git-insights/lib/gravatar.ts"
      provides: "SHA-256 Gravatar URL generation with cache"
      exports: ["getGravatarUrl"]
    - path: "src/extensions/git-insights/lib/chartTheme.ts"
      provides: "Catppuccin-based visx chart theme"
      exports: ["insightsChartTheme", "CATPPUCCIN_CHART_COLORS"]
    - path: "src/extensions/git-insights/components/GravatarAvatar.tsx"
      provides: "Email-based avatar with Gravatar + initials fallback"
      exports: ["GravatarAvatar"]
    - path: "src/extensions/git-insights/components/TimeRangeSelector.tsx"
      provides: "7/30/90 day range picker"
      exports: ["TimeRangeSelector"]
  key_links:
    - from: "src/extensions/git-insights/lib/gravatar.ts"
      to: "crypto.subtle.digest"
      via: "Web Crypto API for SHA-256"
      pattern: "crypto\\.subtle\\.digest"
    - from: "src/extensions/git-insights/lib/chartTheme.ts"
      to: "@visx/xychart"
      via: "buildChartTheme import"
      pattern: "buildChartTheme"
---

<objective>
Install visx dependencies and create the shared foundation utilities for the Git Insights extension: types, Gravatar URL generation, chart theme, avatar component, and time range selector.

Purpose: These are reusable building blocks that Plan 03 (store + extension scaffold) and Plan 04 (dashboard components) both depend on. Creating them independently from the Rust backend (Plan 01) allows parallel execution in Wave 1.

Output: Installed visx packages, TypeScript types, Gravatar library with SHA-256 hashing, Catppuccin chart theme, GravatarAvatar component, and TimeRangeSelector component.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-git-insights-dashboard/51-RESEARCH.md

@src/extensions/github/components/UserAvatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install visx packages and create types + utility libraries</name>
  <files>package.json, src/extensions/git-insights/types.ts, src/extensions/git-insights/lib/gravatar.ts, src/extensions/git-insights/lib/chartTheme.ts</files>
  <action>
**Step 1: Install visx packages.**
Run: `npm install @visx/xychart @visx/responsive @visx/text`

Only these three packages. Do NOT install the `@visx/visx` umbrella package (bundle bloat). The xychart package pulls its internal deps automatically.

**Step 2: Create `src/extensions/git-insights/types.ts`.**

Define TypeScript type aliases that mirror the Rust structs. These types will be generated by tauri-specta in bindings.ts after Plan 01 builds, but we define local aliases here for explicit extension-scoped typing:

```typescript
// Re-export from bindings once available, or define locally for development
export type TimeRange = 7 | 30 | 90;

// These types match the Rust structs in insights.rs (camelCase via serde)
export interface DailyCommitCount {
  date: string;    // "YYYY-MM-DD"
  count: number;
}

export interface ContributorStats {
  name: string;
  email: string;
  commitCount: number;
  percentage: number;
  firstCommitMs: number;
  lastCommitMs: number;
}

export interface RepoInsights {
  totalCommits: number;
  activeBranches: number;
  contributorCount: number;
  firstCommitMs: number;
  dailyCommits: DailyCommitCount[];
  contributors: ContributorStats[];
}

export interface BranchHealthInfo {
  name: string;
  isHead: boolean;
  isRemote: boolean;
  lastCommitDate: string;       // "YYYY-MM-DD"
  lastCommitTimestampMs: number;
  lastCommitMessage: string;
  ahead: number;
  behind: number;
  isStale: boolean;
  isMerged: boolean | null;
}
```

**Step 3: Create `src/extensions/git-insights/lib/gravatar.ts`.**

Implement Gravatar URL generation using Web Crypto SHA-256:

```typescript
const hashCache = new Map<string, string>();

export async function getGravatarUrl(email: string, size = 40): Promise<string> {
  const normalized = email.trim().toLowerCase();
  const cached = hashCache.get(normalized);
  if (cached) return `https://gravatar.com/avatar/${cached}?s=${size}&d=retro`;

  const encoder = new TextEncoder();
  const data = encoder.encode(normalized);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");

  hashCache.set(normalized, hashHex);
  return `https://gravatar.com/avatar/${hashHex}?s=${size}&d=retro`;
}

/** Clear the hash cache (useful for testing). */
export function clearGravatarCache(): void {
  hashCache.clear();
}
```

Use `d=retro` default -- always returns a deterministic identicon (no 404s). Use `loading="lazy"` on the img element side (in GravatarAvatar component).

**Step 4: Create `src/extensions/git-insights/lib/chartTheme.ts`.**

Build a Catppuccin Mocha-themed visx chart theme:

```typescript
import { buildChartTheme } from "@visx/xychart";

// Catppuccin Mocha palette for chart series (8 distinct colors)
export const CATPPUCCIN_CHART_COLORS = [
  "#89b4fa", // blue
  "#a6e3a1", // green
  "#f9e2af", // yellow
  "#fab387", // peach
  "#cba6f7", // mauve
  "#f38ba8", // red
  "#94e2d5", // teal
  "#f5c2e7", // pink
];

export const insightsChartTheme = buildChartTheme({
  backgroundColor: "transparent",          // let parent card bg show through
  colors: CATPPUCCIN_CHART_COLORS,
  gridColor: "rgba(49, 50, 68, 0.5)",      // ctp-surface0 with opacity
  gridColorDark: "rgba(69, 71, 90, 0.3)",  // ctp-surface1 with opacity
  svgLabelSmall: { fill: "#a6adc8", fontSize: 11, fontFamily: "inherit" }, // ctp-subtext0
  svgLabelBig: { fill: "#cdd6f4", fontSize: 13, fontFamily: "inherit" },   // ctp-text
  tickLength: 4,
});
```

Use `backgroundColor: "transparent"` so the theme doesn't fight with the glass-morphism card backgrounds we'll use in the dashboard.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "git-insights" | head -10` — should show no errors from the new files (ignore pre-existing TS2440 in bindings.ts). Also verify: `ls node_modules/@visx/xychart/package.json` exists.
  </verify>
  <done>
visx packages installed. types.ts defines all insight data types. gravatar.ts provides SHA-256 URL generation with Map cache. chartTheme.ts provides Catppuccin Mocha-themed visx chart configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GravatarAvatar and TimeRangeSelector components</name>
  <files>src/extensions/git-insights/components/GravatarAvatar.tsx, src/extensions/git-insights/components/TimeRangeSelector.tsx</files>
  <action>
**Create `src/extensions/git-insights/components/GravatarAvatar.tsx`.**

A reusable avatar component that shows a Gravatar image with initials fallback. Follow the UserAvatar pattern from the GitHub extension.

```tsx
import { useState, useEffect } from "react";
import { getGravatarUrl } from "../lib/gravatar";

interface GravatarAvatarProps {
  email: string;
  name: string;
  size?: "sm" | "md";
  className?: string;
}

const SIZE_CLASSES = {
  sm: "h-6 w-6 text-[10px]",
  md: "h-8 w-8 text-xs",
} as const;

const SIZE_PX = { sm: 24, md: 32 } as const;

export function GravatarAvatar({ email, name, size = "sm", className = "" }: GravatarAvatarProps) {
  const [url, setUrl] = useState<string | null>(null);
  const [hasError, setHasError] = useState(false);

  useEffect(() => {
    let cancelled = false;
    getGravatarUrl(email, SIZE_PX[size] * 2).then((u) => {
      if (!cancelled) setUrl(u);
    });
    return () => { cancelled = true; };
  }, [email, size]);

  const sizeClass = SIZE_CLASSES[size];
  const initials = name.charAt(0).toUpperCase();

  if (!url || hasError) {
    return (
      <div
        className={`${sizeClass} shrink-0 rounded-full bg-ctp-surface1 flex items-center justify-center font-medium text-ctp-subtext0 select-none ${className}`}
        title={name}
        aria-label={`Avatar for ${name}`}
      >
        {initials}
      </div>
    );
  }

  return (
    <img
      src={url}
      alt={`${name}'s avatar`}
      title={name}
      className={`${sizeClass} shrink-0 rounded-full object-cover ${className}`}
      loading="lazy"
      onError={() => setHasError(true)}
    />
  );
}
```

Key design decisions:
- Use `SIZE_PX * 2` for retina displays (request 2x resolution)
- `shrink-0` prevents flexbox from squishing avatars
- `loading="lazy"` for native lazy loading (Pitfall 4 from research)
- Cleanup function in useEffect prevents state update on unmounted component
- `select-none` on initials fallback prevents text selection
- Catppuccin tokens: `bg-ctp-surface1` for fallback bg, `text-ctp-subtext0` for initials

**Create `src/extensions/git-insights/components/TimeRangeSelector.tsx`.**

A segmented button group for selecting time range. Uses distinctive pill-style design with glass effect.

```tsx
import { motion } from "framer-motion";
import type { TimeRange } from "../types";

interface TimeRangeSelectorProps {
  value: TimeRange;
  onChange: (range: TimeRange) => void;
}

const OPTIONS: { value: TimeRange; label: string }[] = [
  { value: 7, label: "7d" },
  { value: 30, label: "30d" },
  { value: 90, label: "90d" },
];

export function TimeRangeSelector({ value, onChange }: TimeRangeSelectorProps) {
  return (
    <div
      className="inline-flex items-center gap-0.5 rounded-lg bg-ctp-surface0/50 p-0.5"
      role="radiogroup"
      aria-label="Time range"
    >
      {OPTIONS.map((opt) => {
        const isActive = opt.value === value;
        return (
          <button
            key={opt.value}
            role="radio"
            aria-checked={isActive}
            onClick={() => onChange(opt.value)}
            className={`relative px-3 py-1 text-xs font-medium rounded-md transition-colors ${
              isActive
                ? "text-ctp-base"
                : "text-ctp-subtext0 hover:text-ctp-text"
            }`}
          >
            {isActive && (
              <motion.div
                layoutId="time-range-indicator"
                className="absolute inset-0 rounded-md bg-ctp-blue"
                transition={{ type: "spring", stiffness: 400, damping: 30 }}
              />
            )}
            <span className="relative z-10">{opt.label}</span>
          </button>
        );
      })}
    </div>
  );
}
```

Key design decisions:
- `motion.div` with `layoutId` for smooth animated indicator sliding between options
- `role="radiogroup"` + `role="radio"` + `aria-checked` for accessibility
- Glass-morphism container: `bg-ctp-surface0/50` (50% opacity surface)
- Active state: `bg-ctp-blue` pill with `text-ctp-base` (dark text on blue)
- Hover state: `text-ctp-subtext0` -> `text-ctp-text` on inactive items
- Spring animation feels tactile (stiffness: 400, damping: 30)
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "git-insights" | head -10` — no errors from the new component files.
  </verify>
  <done>
GravatarAvatar renders email-based avatars with Gravatar (SHA-256 hash, retro fallback) and initials fallback on error. TimeRangeSelector provides an accessible segmented control with framer-motion animated indicator for 7/30/90 day range selection.
  </done>
</task>

</tasks>

<verification>
1. `ls node_modules/@visx/xychart/package.json` — visx installed
2. `npx tsc --noEmit --skipLibCheck` — no new type errors from git-insights files
3. `src/extensions/git-insights/types.ts` exports TimeRange and all data interfaces
4. `src/extensions/git-insights/lib/gravatar.ts` uses `crypto.subtle.digest("SHA-256",...)`
5. `src/extensions/git-insights/lib/chartTheme.ts` exports `insightsChartTheme` using `buildChartTheme`
6. `src/extensions/git-insights/components/GravatarAvatar.tsx` has img with `loading="lazy"` and initials fallback
7. `src/extensions/git-insights/components/TimeRangeSelector.tsx` has `role="radiogroup"` and motion indicator
</verification>

<success_criteria>
visx dependencies installed. All shared utilities (types, gravatar, chart theme) and reusable components (GravatarAvatar, TimeRangeSelector) are created, type-check cleanly, and are ready for consumption by the store, dashboard blade, and chart components in subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/51-git-insights-dashboard/51-02-SUMMARY.md`
</output>
