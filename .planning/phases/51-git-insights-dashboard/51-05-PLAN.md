---
phase: 51-git-insights-dashboard
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/components/commit/CommitHistory.tsx
  - src/extensions/git-insights/insightsStore.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User clicks a contributor in the insights dashboard and the commit history filters to show only that person's commits"
    - "User sees author avatars (Gravatar with initials fallback) next to each commit in the commit history panel"
    - "User clicks the same contributor again to deselect and see all commits"
  artifacts:
    - path: "src/core/components/commit/CommitHistory.tsx"
      provides: "GravatarAvatar rendering per commit row + insightsStore subscriber for author filter sync"
      contains: "GravatarAvatar"
  key_links:
    - from: "src/core/components/commit/CommitHistory.tsx"
      to: "src/extensions/git-insights/insightsStore.ts"
      via: "useInsightsStore subscribe to selectedContributor"
      pattern: "useInsightsStore"
    - from: "src/core/components/commit/CommitHistory.tsx"
      to: "src/extensions/git-insights/components/GravatarAvatar.tsx"
      via: "import GravatarAvatar"
      pattern: "GravatarAvatar"
---

<objective>
Close 2 verification gaps from Phase 51 by wiring GravatarAvatar into commit history rows and bridging the contributor filter from insightsStore to CommitHistory.

Purpose: Phase 51 verification found that (1) GravatarAvatar exists but is only used in ContributorBreakdown, not in CommitHistory, and (2) selectContributor stores the selected email but nothing applies it to the commit history view. Both are cross-extension integration gaps.

Output: Updated CommitHistory.tsx with avatar rendering and contributor filter sync.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-git-insights-dashboard/51-VERIFICATION.md

@src/core/components/commit/CommitHistory.tsx
@src/core/components/commit/AuthorFilter.tsx
@src/extensions/git-insights/insightsStore.ts
@src/extensions/git-insights/components/GravatarAvatar.tsx
@src/extensions/git-insights/lib/gravatar.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GravatarAvatar to commit history rows</name>
  <files>src/core/components/commit/CommitHistory.tsx</files>
  <action>
    Import GravatarAvatar from the git-insights extension:
    ```
    import { GravatarAvatar } from "../../../extensions/git-insights/components/GravatarAvatar";
    ```

    In the Virtuoso `itemContent` render function, replace the current commit row layout:

    **Current** (lines 188-201):
    - `CommitTypeIcon` + message + metadata row (shortOid, authorName, timestamp)

    **Updated:**
    - `GravatarAvatar` (size="sm", using commit.authorEmail and commit.authorName) placed before the text content
    - REMOVE CommitTypeIcon from the commit row — the avatar replaces it as the visual anchor
    - Keep the existing layout structure: flex items-start gap-2
    - The metadata row stays: shortOid, authorName, timestamp

    The updated row markup should be:
    ```tsx
    <div className="flex items-start gap-2">
      <GravatarAvatar
        email={commit.authorEmail}
        name={commit.authorName}
        size="sm"
        className="mt-0.5"
      />
      <div className="flex-1 min-w-0">
        <p className="text-sm text-ctp-subtext1 truncate">
          {commit.messageSubject}
        </p>
        <div className="flex items-center gap-2 mt-1 text-xs text-ctp-overlay0">
          <span className="font-mono">{commit.shortOid}</span>
          <span>{commit.authorName}</span>
          <span>{formatTimestamp(commit.timestampMs)}</span>
        </div>
      </div>
    </div>
    ```

    Also remove the CommitTypeIcon import if it is no longer used in this file.

    NOTE: The CommitTypeIcon import may still be used elsewhere in the codebase — only remove the import from THIS file, not the component itself.
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — no new TypeScript errors.
    Visually confirm: commit rows show round avatar (Gravatar or initials fallback) instead of commit type icon.
  </verify>
  <done>Each commit row in CommitHistory displays a GravatarAvatar with the author's email and name, with initials fallback for missing Gravatar images.</done>
</task>

<task type="auto">
  <name>Task 2: Wire insightsStore selectedContributor to CommitHistory author filter</name>
  <files>src/core/components/commit/CommitHistory.tsx, src/extensions/git-insights/insightsStore.ts</files>
  <action>
    In CommitHistory.tsx:

    1. Import the insights store:
    ```
    import { useInsightsStore } from "../../../extensions/git-insights/insightsStore";
    ```

    2. Subscribe to `selectedContributor` at the top of the component:
    ```tsx
    const externalContributor = useInsightsStore((s) => s.selectedContributor);
    ```

    3. Add a `useEffect` that syncs `externalContributor` to the local `authorFilter` state. When the insights store sets a selectedContributor (email), find the matching author in the loaded commits and set the authorFilter to the "Name <email>" format that the existing filter logic expects:
    ```tsx
    useEffect(() => {
      if (externalContributor) {
        // Find matching author in loaded commits to get the "Name <email>" format
        const match = allCommits.find(
          (c) => c.authorEmail === externalContributor
        );
        if (match) {
          setAuthorFilter(`${match.authorName} <${match.authorEmail}>`);
        } else {
          // Fallback: construct filter from email alone
          setAuthorFilter(externalContributor);
        }
      } else {
        // Clear filter when deselected (only if it was set by external)
        setAuthorFilter("");
      }
    }, [externalContributor, allCommits]);
    ```

    Important: Place this useEffect AFTER the `allCommits` memo and BEFORE the existing `authorFilter` useMemo that filters commits.

    4. Update the author filter application logic (the existing `useMemo` at line 79-84) to ALSO match by email-only, so the fallback case works:
    ```tsx
    const commits = useMemo(() => {
      if (!authorFilter) return allCommits;
      return allCommits.filter(
        (c) =>
          `${c.authorName} <${c.authorEmail}>` === authorFilter ||
          c.authorEmail === authorFilter
      );
    }, [allCommits, authorFilter]);
    ```

    This ensures the filter works whether the value is in "Name <email>" format (from dropdown) or email-only format (from insights store fallback).

    No changes needed to insightsStore.ts — the `selectContributor` action and `selectedContributor` state already exist and work correctly. The ContributorBreakdown already calls `selectContributor(email)` on click.
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — no new TypeScript errors.
    Test flow: Open insights dashboard, click a contributor → commit history should filter to that author. Click again → filter clears.
  </verify>
  <done>
    Clicking a contributor in the insights dashboard's ContributorBreakdown sets selectedContributor in insightsStore, which syncs to CommitHistory's authorFilter, showing only that contributor's commits. Clicking again deselects and shows all commits.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes (excluding pre-existing bindings.ts error)
2. CommitHistory rows show GravatarAvatar (round avatar or initials) instead of CommitTypeIcon
3. Clicking a contributor in ContributorBreakdown filters CommitHistory to that author
4. Clicking the same contributor again deselects and shows all commits
5. The AuthorFilter dropdown in CommitHistory still works independently
6. Gravatar images load with `loading="lazy"` and fall back to initials on error
</verification>

<success_criteria>
- GravatarAvatar component renders in every commit row in CommitHistory
- selectedContributor from insightsStore syncs to CommitHistory's authorFilter
- Both filter mechanisms (dropdown and insights click) work independently and together
- No TypeScript compilation errors introduced
- No visual regressions in commit history layout
</success_criteria>

<output>
After completion, create `.planning/phases/51-git-insights-dashboard/51-05-SUMMARY.md`
</output>
