---
phase: 49-inline-conflict-resolution
plan: 03
type: execute
wave: 3
depends_on: ["49-01", "49-02"]
files_modified:
  - src/extensions/conflict-resolution/blades/ConflictResolutionBlade.tsx
  - src/extensions/conflict-resolution/blades/components/ConflictFileList.tsx
  - src/extensions/conflict-resolution/blades/components/ConflictDiffView.tsx
  - src/extensions/conflict-resolution/blades/components/ConflictResultEditor.tsx
  - src/extensions/conflict-resolution/blades/components/ConflictHunkActions.tsx
  - src/extensions/conflict-resolution/hooks/useConflictQuery.ts
autonomous: true

must_haves:
  truths:
    - "User can open a conflicted file and see ours vs theirs in two read-only Monaco DiffEditor panes"
    - "User can see an editable Monaco Editor result panel below the diff view"
    - "User can click Accept Ours, Accept Theirs, or Accept Both per conflict hunk and the result updates"
    - "User can undo any hunk resolution action"
    - "User can manually edit the merged result with syntax highlighting"
    - "User can reset a file to its original conflicted state"
    - "User can mark a file as resolved which stages it, removes the indicator, and shows a toast"
    - "User sees conflicted files in a file list with resolution progress indicators"
  artifacts:
    - path: "src/extensions/conflict-resolution/blades/ConflictResolutionBlade.tsx"
      provides: "Main blade component with file list + diff + result layout"
      min_lines: 80
    - path: "src/extensions/conflict-resolution/blades/components/ConflictDiffView.tsx"
      provides: "Two-pane read-only Monaco DiffEditor showing ours vs theirs"
      contains: "DiffEditor"
    - path: "src/extensions/conflict-resolution/blades/components/ConflictResultEditor.tsx"
      provides: "Editable Monaco Editor for the merged result"
      contains: "Editor"
    - path: "src/extensions/conflict-resolution/blades/components/ConflictHunkActions.tsx"
      provides: "Per-hunk action buttons (Accept Ours/Theirs/Both/Undo)"
      contains: "Accept Ours"
    - path: "src/extensions/conflict-resolution/blades/components/ConflictFileList.tsx"
      provides: "Sidebar file list with conflict resolution status"
      contains: "FileResolutionStatus"
  key_links:
    - from: "src/extensions/conflict-resolution/blades/ConflictResolutionBlade.tsx"
      to: "src/extensions/conflict-resolution/store.ts"
      via: "useConflictStore hook"
      pattern: "useConflictStore"
    - from: "src/extensions/conflict-resolution/blades/components/ConflictDiffView.tsx"
      to: "@monaco-editor/react"
      via: "DiffEditor component import"
      pattern: "import.*DiffEditor.*@monaco-editor"
    - from: "src/extensions/conflict-resolution/blades/components/ConflictResultEditor.tsx"
      to: "@monaco-editor/react"
      via: "Editor component import"
      pattern: "import.*Editor.*@monaco-editor"
    - from: "src/extensions/conflict-resolution/blades/components/ConflictHunkActions.tsx"
      to: "src/extensions/conflict-resolution/store.ts"
      via: "resolveHunk and undoHunkResolution actions"
      pattern: "resolveHunk|undoHunkResolution"
---

<objective>
Build the ConflictResolutionBlade UI with two-pane diff view (ours vs theirs), editable result editor, per-hunk action buttons, file list sidebar, and resolve/reset controls.

Purpose: This is the user-facing heart of conflict resolution. Users open this blade to see all conflicted files, view ours-vs-theirs diffs, click to accept resolutions per hunk, manually edit the result, and mark files as resolved. All five CONF requirements are delivered through this UI.

Output: Complete blade UI at `src/extensions/conflict-resolution/blades/` with all sub-components and hooks.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-inline-conflict-resolution/49-RESEARCH.md
@.planning/phases/49-inline-conflict-resolution/49-01-SUMMARY.md
@.planning/phases/49-inline-conflict-resolution/49-02-SUMMARY.md

# Key source references
@src/core/blades/diff/DiffBlade.tsx                 # Blade layout pattern
@src/core/blades/diff/components/DiffContent.tsx     # Monaco DiffEditor wrapper with disposal
@src/core/blades/diff/components/DiffToolbar.tsx     # Toolbar pattern
@src/core/lib/monacoConfig.ts                        # MONACO_COMMON_OPTIONS, MONACO_THEME
@src/extensions/conflict-resolution/store.ts         # Store with all actions
@src/extensions/conflict-resolution/types.ts         # Types (ConflictHunk, ConflictFile, etc.)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConflictDiffView, ConflictResultEditor, and ConflictHunkActions components</name>
  <files>
    src/extensions/conflict-resolution/blades/components/ConflictDiffView.tsx
    src/extensions/conflict-resolution/blades/components/ConflictResultEditor.tsx
    src/extensions/conflict-resolution/blades/components/ConflictHunkActions.tsx
    src/extensions/conflict-resolution/hooks/useConflictQuery.ts
  </files>
  <action>
**hooks/useConflictQuery.ts** — React Query hook for loading conflict file content:
- Export `useConflictFiles()` hook that calls `useConflictStore.getState().loadConflictFiles()` via useQuery with key `["conflictFiles"]` and `refetchInterval: 3000`.
- Export `useConflictFileContent(path: string)` hook that calls `useConflictStore.getState().openConflictFile(path)` via useQuery with key `["conflictContent", path]`, enabled only when path is truthy.

**ConflictDiffView.tsx** — Two-pane read-only diff view showing ours vs theirs:

```typescript
interface ConflictDiffViewProps {
  oursContent: string;
  theirsContent: string;
  language: string;
  oursName: string;
  theirsName: string;
}
```

Implementation:
- Use `DiffEditor` from `@monaco-editor/react` (same import as DiffContent.tsx)
- Set `original={oursContent}` and `modified={theirsContent}` (ours = original/left, theirs = modified/right)
- Options: spread `MONACO_COMMON_OPTIONS`, set `readOnly: true`, `originalEditable: false`, `renderSideBySide: true`, `diffAlgorithm: "advanced"`, `diffWordWrap: "on"`, `hideUnchangedRegions: { enabled: true, contextLineCount: 3, minimumLineCount: 3, revealLineCount: 20 }`
- Add header labels above the editor: left shows oursName (e.g., "HEAD (Ours)"), right shows theirsName (e.g., "feature/xyz (Theirs)") — use Catppuccin colors: blue for ours (`text-ctp-blue`), mauve for theirs (`text-ctp-mauve`)
- Proper editor disposal on unmount (follow DiffContent.tsx pattern exactly: useRef + useEffect cleanup + onMount handler)
- Use `MONACO_THEME` from monacoConfig.ts

**ConflictResultEditor.tsx** — Editable Monaco editor for the merged result:

```typescript
interface ConflictResultEditorProps {
  content: string;
  language: string;
  onChange: (value: string) => void;
}
```

Implementation:
- Use `Editor` (not DiffEditor) from `@monaco-editor/react`
- Set `value={content}`, `onChange` fires `onChange` prop
- Options: spread `MONACO_COMMON_OPTIONS` plus `readOnly: false`, `wordWrap: "on"`, `minimap: { enabled: true }`
- Header label: "Result (Editable)" in green (`text-ctp-green`)
- Proper editor disposal on unmount (same useRef pattern)
- Use `MONACO_THEME`
- Language detection: infer from file extension (use existing pattern or pass as prop)

**ConflictHunkActions.tsx** — Per-hunk action buttons:

```typescript
interface ConflictHunkActionsProps {
  hunks: ConflictHunk[];
  filePath: string;
  onResolveHunk: (hunkId: string, choice: ResolutionChoice) => void;
  onUndo: () => void;
  undoAvailable: boolean;
}
```

Implementation:
- Render a card/section for each hunk showing:
  - Hunk number and line range: "Conflict #1 (lines 10-25)"
  - Resolution status: unresolved (red dot), resolved (green checkmark with choice label)
  - Three action buttons in a row:
    - "Accept Ours" — `bg-ctp-blue/20 hover:bg-ctp-blue/30 text-ctp-blue border border-ctp-blue/30` — calls `onResolveHunk(hunkId, "ours")`
    - "Accept Theirs" — `bg-ctp-mauve/20 hover:bg-ctp-mauve/30 text-ctp-mauve border border-ctp-mauve/30` — calls `onResolveHunk(hunkId, "theirs")`
    - "Accept Both" — `bg-ctp-green/20 hover:bg-ctp-green/30 text-ctp-green border border-ctp-green/30` — calls `onResolveHunk(hunkId, "both")`
  - Each button shows its current selection with a filled background when that choice is active
- Global undo button: "Undo Last" with `Undo` icon from lucide-react, disabled when `!undoAvailable`
- Keyboard shortcuts: document but don't implement hotkeys in this plan (keep scope tight)
- Accessible: each button has `aria-label`, button group has `role="group"` with `aria-label="Resolution actions for conflict N"`
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | grep -v "bindings.ts" | head -20` — should show no new TypeScript errors.
  </verify>
  <done>
Three sub-components render the conflict resolution UI: DiffView shows ours-vs-theirs, ResultEditor shows the editable merge result, HunkActions provides per-hunk accept/undo buttons with Catppuccin-themed styling and accessibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConflictFileList and ConflictResolutionBlade</name>
  <files>
    src/extensions/conflict-resolution/blades/components/ConflictFileList.tsx
    src/extensions/conflict-resolution/blades/ConflictResolutionBlade.tsx
  </files>
  <action>
**ConflictFileList.tsx** — Sidebar file list showing all conflicted files:

```typescript
interface ConflictFileListProps {
  files: Map<string, ConflictFile>;
  activeFilePath: string | null;
  onSelectFile: (path: string) => void;
  onMarkResolved: (path: string) => void;
}
```

Implementation:
- Render a scrollable list of conflicted files
- Each item shows:
  - File name (basename) in bold, relative directory path below in muted text
  - Status indicator:
    - "unresolved" → red `AlertTriangle` icon from lucide-react
    - "partially-resolved" → yellow `AlertTriangle` icon
    - "resolved" → green `CheckCircle` icon with "Mark as Resolved" button
  - Hunk progress: "2/3 resolved" text
- Active file highlighted with `bg-ctp-surface0` background
- "Mark as Resolved" button per file (only enabled when all hunks resolved):
  - `bg-ctp-green text-ctp-base` styling
  - Calls `onMarkResolved(path)` which triggers store's `markFileResolved`
- If no files: show empty state "No merge conflicts" with `GitMerge` icon

**ConflictResolutionBlade.tsx** — Main blade orchestrator:

```typescript
interface ConflictResolutionBladeProps {
  filePath?: string;  // Optional: open specific file directly
}

export function ConflictResolutionBlade({ filePath }: ConflictResolutionBladeProps)
```

Layout (vertical split with horizontal sub-split):
```
+--------------------------------------------------+
| [File List Sidebar] | [Ours (read-only) | Theirs (read-only)] |
|                     |                              |
|   file1.ts  ✓       |   Monaco DiffEditor           |
|   file2.ts  ⚠       |                              |
|   file3.ts  ✗       +------------------------------+
|                     | [Hunk Actions Bar]           |
|                     | Accept Ours | Theirs | Both | Undo |
|                     +------------------------------+
|                     | [Result Editor (editable)]    |
|                     |                              |
|                     |   Monaco Editor               |
|                     |                              |
+--------------------------------------------------+
| [Reset File] [Mark as Resolved]                  |
+--------------------------------------------------+
```

Implementation:
1. On mount, call `useConflictStore.getState().loadConflictFiles()` to populate the file list.
2. If `filePath` prop is provided, auto-select that file on mount.
3. Use `react-resizable-panels` for the horizontal split (file list | editor area) — import `Panel`, `PanelGroup`, `PanelResizeHandle` from `react-resizable-panels`.
4. Use another `PanelGroup` (direction="vertical") for the editor area split (diff view | hunk actions | result editor).
5. File list sidebar: ~25% default width, min 200px. Render `ConflictFileList`.
6. Diff view panel: ~50% of editor area. Render `ConflictDiffView` with active file's ours/theirs content.
7. Hunk actions bar: fixed-height strip between diff and result. Render `ConflictHunkActions`.
8. Result editor panel: ~50% of editor area. Render `ConflictResultEditor`.
9. Bottom toolbar with two buttons:
   - "Reset File" (`RotateCcw` icon) — calls `useConflictStore.getState().resetFile(path)`, confirms with toast
   - "Mark as Resolved" (`Check` icon) — calls `useConflictStore.getState().markFileResolved(path)`, disabled unless all hunks resolved
10. Connect to store:
    - `const { files, activeFilePath, openConflictFile, resolveHunk, undoHunkResolution, updateResultContent, resetFile, markFileResolved } = useConflictStore();`
    - `const activeFile = activeFilePath ? files.get(activeFilePath) : undefined;`
11. Loading state: show `Loader2` spinner while conflict content is loading.
12. Empty state: if no conflict files, show "No merge conflicts detected" with a `GitMerge` icon and suggestion text.
13. Language detection for Monaco: infer from file extension using a simple mapping (ts -> typescript, js -> javascript, rs -> rust, py -> python, etc.), default to "plaintext".
14. All Monaco editors must be properly disposed on unmount.

Wire up the `onChange` for ConflictResultEditor to call `updateResultContent(path, newValue)` which marks any manually-edited hunks as "custom" resolution.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | grep -v "bindings.ts" | head -20` — should show no new TypeScript errors.
Verify blade structure: `ls src/extensions/conflict-resolution/blades/` should show ConflictResolutionBlade.tsx and components/ directory.
  </verify>
  <done>
ConflictResolutionBlade renders the complete conflict resolution UI with file list sidebar, two-pane diff view, per-hunk action buttons, editable result editor, reset and resolve controls. All five CONF requirements are addressed: CONF-01 (file list with indicators), CONF-02 (two-pane diff + result), CONF-03 (per-hunk accept with undo), CONF-04 (manual editing with reset), CONF-05 (mark as resolved stages file and shows toast).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles with no new errors
2. ConflictResolutionBlade renders file list, diff view, hunk actions, and result editor
3. Monaco editors (DiffEditor + Editor) mount and dispose correctly
4. Hunk action buttons are visually distinct with Catppuccin colors
5. File list shows resolution progress per file
6. Reset and Mark as Resolved buttons are wired to store actions
7. All components have appropriate ARIA labels
</verification>

<success_criteria>
- Users can open a conflicted file and see ours vs theirs in a two-pane Monaco DiffEditor
- Users can click Accept Ours/Theirs/Both per conflict hunk and see the result update
- Users can undo hunk resolutions
- Users can manually edit the merged result
- Users can reset a file to its original conflicted state
- Users can mark a file as resolved (stages, removes indicator, toast)
- File list shows all conflicted files with resolution progress
</success_criteria>

<output>
After completion, create `.planning/phases/49-inline-conflict-resolution/49-03-SUMMARY.md`
</output>
