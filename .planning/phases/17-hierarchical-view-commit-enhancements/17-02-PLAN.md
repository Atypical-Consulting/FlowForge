---
phase: 17-hierarchical-view-commit-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/git/staging.rs
  - src-tauri/src/lib.rs
  - src/bindings.ts
  - src/components/staging/FileTreeView.tsx
  - src/components/staging/FileItem.tsx
  - src/components/staging/StagingPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a stage button on a folder in hierarchical view stages all files within that folder"
    - "Clicking an unstage button on a folder in hierarchical view unstages all files within that folder"
    - "All items in the hierarchical file tree have uniform icon widths and consistent icon-to-text spacing regardless of nesting depth"
    - "Folder and file rows align cleanly at every nesting depth with consistent indentation"
  artifacts:
    - path: "src-tauri/src/git/staging.rs"
      provides: "Batch stage_files and unstage_files Tauri commands"
      contains: "pub async fn stage_files"
    - path: "src/components/staging/FileTreeView.tsx"
      provides: "Folder stage/unstage buttons on directory nodes, uniform icon spacing"
      contains: "onStageFolder"
    - path: "src/components/staging/StagingPanel.tsx"
      provides: "Wiring of folder staging callbacks to batch commands"
      contains: "stageFiles"
  key_links:
    - from: "src-tauri/src/git/staging.rs"
      to: "src-tauri/src/lib.rs"
      via: "Command registration in collect_commands![]"
      pattern: "stage_files"
    - from: "src/components/staging/FileTreeView.tsx"
      to: "src/components/staging/StagingPanel.tsx"
      via: "onStageFolder callback prop"
      pattern: "onStageFolder"
    - from: "src/components/staging/StagingPanel.tsx"
      to: "src/bindings.ts"
      via: "commands.stageFiles / commands.unstageFiles"
      pattern: "commands\\.stageFiles\\|commands\\.unstageFiles"
---

<objective>
Add batch staging Rust commands, folder-level stage/unstage buttons in the hierarchical file tree, and fix icon spacing for consistent alignment.

Purpose: Users currently can only stage files one at a time or all at once. This plan adds the ability to stage/unstage entire folders in the tree view, backed by efficient batch Rust commands. It also fixes the icon spacing inconsistency between folder rows and file rows in the tree view (UIPX-03 and UIPX-04).

Output: Two new Rust commands (`stage_files`, `unstage_files`), folder stage/unstage buttons in `FileTreeView`, and uniform icon spacing across all tree elements.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-hierarchical-view-commit-enhancements/17-RESEARCH.md

@src-tauri/src/git/staging.rs
@src-tauri/src/lib.rs
@src/components/staging/FileTreeView.tsx
@src/components/staging/FileItem.tsx
@src/components/staging/StagingPanel.tsx
@src/components/icons/FileTypeIcon.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch stage_files and unstage_files Rust commands</name>
  <files>src-tauri/src/git/staging.rs, src-tauri/src/lib.rs</files>
  <action>
**Add `stage_files` command to `src-tauri/src/git/staging.rs`:**

Add a new Tauri command after the existing `stage_file` function. This stages multiple files in a single index operation:

```rust
/// Stage multiple files for commit in a single operation.
///
/// More efficient than calling stage_file repeatedly -- performs a single index write.
/// Paths must be relative to the repository root.
#[tauri::command]
#[specta::specta]
pub async fn stage_files(paths: Vec<String>, state: State<'_, RepositoryState>) -> Result<(), GitError> {
    let repo_path = state
        .get_path()
        .await
        .ok_or_else(|| GitError::NotFound("No repository open".to_string()))?;

    tokio::task::spawn_blocking(move || {
        let repo = git2::Repository::open(&repo_path)?;
        let mut index = repo.index()?;

        for path in &paths {
            let file_path = Path::new(path);
            let full_path = repo_path.join(file_path);
            if full_path.exists() {
                index.add_path(file_path)?;
            } else {
                index.remove_path(file_path)?;
            }
        }

        index.write()?;
        Ok(())
    })
    .await
    .map_err(|e| GitError::Internal(format!("Task join error: {}", e)))?
}
```

**Add `unstage_files` command to `src-tauri/src/git/staging.rs`:**

Add after `unstage_file`. This unstages multiple files in a single operation:

```rust
/// Unstage multiple files (remove from index, keep workdir changes).
///
/// More efficient than calling unstage_file repeatedly -- performs a single reset.
/// Paths must be relative to the repository root.
#[tauri::command]
#[specta::specta]
pub async fn unstage_files(paths: Vec<String>, state: State<'_, RepositoryState>) -> Result<(), GitError> {
    let repo_path = state
        .get_path()
        .await
        .ok_or_else(|| GitError::NotFound("No repository open".to_string()))?;

    tokio::task::spawn_blocking(move || {
        let repo = git2::Repository::open(&repo_path)?;

        match repo.head() {
            Ok(head_ref) => {
                let head_commit = head_ref.peel_to_commit()?;
                let path_refs: Vec<&Path> = paths.iter().map(|p| Path::new(p.as_str())).collect();
                repo.reset_default(Some(&head_commit.into_object()), path_refs)?;
            }
            Err(e) if e.code() == git2::ErrorCode::UnbornBranch => {
                let mut index = repo.index()?;
                for path in &paths {
                    index.remove_path(Path::new(path))?;
                }
                index.write()?;
            }
            Err(e) => return Err(GitError::from(e)),
        }

        Ok(())
    })
    .await
    .map_err(|e| GitError::Internal(format!("Task join error: {}", e)))?
}
```

**Register commands in `src-tauri/src/lib.rs`:**

1. In the `use git::staging::` import block, add `stage_files` and `unstage_files` to the existing imports
2. In the `collect_commands![]` macro, add `stage_files` and `unstage_files` after the existing staging commands (after `unstage_all`)

**Regenerate bindings:**

Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && cargo build --manifest-path src-tauri/Cargo.toml` in debug mode to trigger specta binding regeneration. This updates `src/bindings.ts` with the new `stageFiles` and `unstageFiles` command functions.

Note: The pre-existing TS2440 error in `bindings.ts` should be ignored -- it's a known issue documented in project memory.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && cargo build --manifest-path src-tauri/Cargo.toml 2>&1 | tail -5` -- should compile without errors. Run `grep "stageFiles\|unstageFiles" src/bindings.ts` to confirm the new commands appear in the generated bindings.
  </verify>
  <done>
`stage_files` and `unstage_files` Rust commands exist in staging.rs, are registered in lib.rs, and appear in the auto-generated TypeScript bindings as `commands.stageFiles()` and `commands.unstageFiles()`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add folder stage/unstage buttons and fix icon spacing in tree view</name>
  <files>src/components/staging/FileTreeView.tsx, src/components/staging/FileItem.tsx, src/components/staging/StagingPanel.tsx</files>
  <action>
**Refactor `src/components/staging/FileTreeView.tsx`:**

This is the most significant change. Enhance TreeNode for directories and fix icon spacing for all rows.

1. **Add new imports:** `Check`, `X` from "lucide-react" (for stage/unstage buttons on folders)

2. **Update `FileTreeViewProps` interface:** Add an optional callback:
   ```
   onStageFolder?: (paths: string[]) => void;
   ```

3. **Update `TreeNodeProps` interface:** Add:
   ```
   onStageFolder?: (paths: string[]) => void;
   ```

4. **Add helper function `collectAllFiles`** to recursively collect all leaf FileChange objects from a tree node:
   ```typescript
   function collectAllFiles(node: FileTreeNode): FileChange[] {
     const files: FileChange[] = [];
     if (node.file) files.push(node.file);
     for (const child of node.children.values()) {
       files.push(...collectAllFiles(child));
     }
     return files;
   }
   ```

5. **Fix icon spacing in directory TreeNode** -- Replace the current folder button with a structure that has fixed-width containers for consistent alignment:

   The directory row should use this layout:
   ```
   [paddingLeft: depth * 16 + 8][w-4 chevron container][gap-1][w-4 icon container][gap-1.5][text flex-1][stage button]
   ```

   Replace the current directory `<button>` with a `<div>` wrapper that contains:
   - The expand/collapse toggle is on the chevron container (clicking the whole row toggles)
   - A `w-4 flex items-center justify-center shrink-0` container for the chevron icon
   - A `w-4 flex items-center justify-center shrink-0` container for the FileTypeIcon (with `ml-1` gap)
   - A `<span>` for the folder name with `ml-1.5 flex-1 truncate`
   - A stage/unstage button that appears on hover (using `group` + `opacity-0 group-hover:opacity-100`):
     - If `section === "staged"`: show `X` icon with `hover:bg-ctp-red/20 text-ctp-red`, title "Unstage folder"
     - Otherwise: show `Check` icon with `hover:bg-ctp-green/20 text-ctp-green`, title "Stage folder"
     - The button's onClick should call `onStageFolder?.(collectAllFiles(node).map(f => f.path))` with `e.stopPropagation()` to avoid toggling expand

   Use `paddingLeft: ${depth * 16 + 8}px` for indent (change from 12px step to 16px for clearer nesting visual).

6. **Fix icon spacing in file TreeNode** -- When rendering FileItem for leaf nodes, pass the same depth-based indentation. The FileItem component receives `depth` and uses `paddingLeft: ${depth * 12 + 12}px`. Update this to use `depth * 16 + 8` to match the directory row indentation. Since FileItem handles its own indent, we need to coordinate:
   - Actually, don't change FileItem's `depth` prop behavior yet. Instead, pass `depth` to FileItem as before. We'll fix FileItem's indent in the next step.

7. **Update IndentGuides** to use `depth * 16 + 14` for guide positioning (was `depth * 12 + 14`), matching the new 16px step.

8. **Pass `onStageFolder` through the component chain**: `FileTreeView` receives `onStageFolder` in its props and passes it down to each `TreeNode`.

**Refactor `src/components/staging/FileItem.tsx`:**

Fix the indent calculation to match the tree's 16px step:

1. Change the `indentStyle` calculation from `paddingLeft: ${depth * 12 + 12}px` to `paddingLeft: ${depth * 16 + 8}px`. This aligns file rows with their parent folder rows.

2. Update the icon area to use fixed-width containers matching the tree:
   - The current layout is: `<div className="relative shrink-0"><FileTypeIcon .../><statusDot/></div>`
   - Add a spacer for the missing chevron column: Insert a `w-4 shrink-0` invisible spacer div before the icon container (to account for the chevron column width that directories have but files don't). This keeps the icon column aligned.
   - Actually, a simpler approach: since FileItem is rendered inside TreeNode which handles the indent guides, just ensure the gap and icon sizing match. The FileItem already uses `gap-2` between elements. Change to `gap-1` to match TreeNode's tighter spacing, and ensure the FileTypeIcon wrapper is exactly `w-4 h-4`.

   On reflection, the cleanest approach: add a `w-4 shrink-0` empty div before the file icon div when `depth > 0 || showFilenameOnly` (i.e., when rendered in tree mode). This accounts for the chevron column that directories have. This aligns file icons with directory icons.

   But even simpler: since FileItem is rendered at the same depth as its sibling folders, and folders have [chevron][icon][text], files should have [empty-chevron-space][icon][text]. The padding already handles horizontal position, but we need the icon to start at the same X as folder icons.

   Best approach: In FileItem, when `showFilenameOnly` is true (tree mode), render:
   ```
   <div className="w-4 shrink-0" /> {/* Chevron spacer */}
   <div className="relative shrink-0 w-4 flex items-center justify-center">
     <FileTypeIcon path={file.path} className="w-4 h-4" />
     <statusDot />
   </div>
   ```
   And change the outer flex from `gap-2` to `gap-1` when `showFilenameOnly` is true. Keep `gap-2` for flat list mode.

**Refactor `src/components/staging/StagingPanel.tsx`:**

Wire the folder staging callbacks from FileTreeView to the batch commands.

1. Add imports for the new batch commands: The `commands` import already exists. The new functions will be `commands.stageFiles()` and `commands.unstageFiles()`.

2. Create two mutation hooks:
   ```typescript
   const stageFolderMutation = useMutation({
     mutationFn: (paths: string[]) => commands.stageFiles(paths),
     onSuccess: () => queryClient.invalidateQueries({ queryKey: ["stagingStatus"] }),
   });

   const unstageFolderMutation = useMutation({
     mutationFn: (paths: string[]) => commands.unstageFiles(paths),
     onSuccess: () => queryClient.invalidateQueries({ queryKey: ["stagingStatus"] }),
   });
   ```

3. Pass `onStageFolder` callbacks to each `<FileTreeView>` instance:
   - For the "staged" section: `onStageFolder={(paths) => unstageFolderMutation.mutate(paths)}` (clicking in staged section unstages)
   - For the "unstaged" section: `onStageFolder={(paths) => stageFolderMutation.mutate(paths)}` (clicking in unstaged section stages)
   - For the "untracked" section: `onStageFolder={(paths) => stageFolderMutation.mutate(paths)}` (clicking in untracked section stages)
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new TypeScript errors. Run `npm run build` to verify the app builds. Visually: open a repo with multiple files in a folder, switch to tree view, and verify:
1. Hovering over a folder shows a stage/unstage button
2. Clicking it stages/unstages all files in that folder
3. Icon widths and icon-to-text spacing are consistent between folder rows and file rows at all nesting depths
  </verify>
  <done>
Folder stage/unstage buttons appear on hover for directory nodes in the tree view. Clicking stages/unstages all files in that folder via a single batch command. Icon widths are uniform (w-4 containers for chevron and icon) and icon-to-text spacing is consistent across all nesting depths. Indent step is 16px for clear visual hierarchy.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --manifest-path src-tauri/Cargo.toml` compiles without errors
2. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` reports no errors
3. `npm run build` succeeds
4. `grep "stage_files\|unstage_files" src-tauri/src/git/staging.rs` finds both new functions
5. `grep "stage_files\|unstage_files" src-tauri/src/lib.rs` confirms registration
6. `grep "stageFiles\|unstageFiles" src/bindings.ts` confirms generated bindings
7. `grep "onStageFolder" src/components/staging/FileTreeView.tsx` confirms callback prop
8. `grep "stageFolderMutation\|unstageFolderMutation" src/components/staging/StagingPanel.tsx` confirms wiring
</verification>

<success_criteria>
- Clicking a stage button on a folder in the "Changes" section stages all files within that folder
- Clicking an unstage button on a folder in the "Staged Changes" section unstages all files within that folder
- Clicking stage on a folder in the "Untracked Files" section stages all untracked files within that folder
- Batch operations trigger a single query invalidation (no N-refetch storm)
- Icon widths are uniform (w-4 fixed containers) at every nesting depth
- Icon-to-text spacing is consistent between folder rows and file rows
- Indent guides align properly with the 16px step
- TypeScript compilation passes with no new errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-hierarchical-view-commit-enhancements/17-02-SUMMARY.md`
</output>
