---
phase: 17-hierarchical-view-commit-enhancements
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/staging/TreeIndentGuides.tsx
  - src/components/staging/FileTreeView.tsx
  - src/components/staging/FileItem.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Vertical indent guide lines form continuous, coherent columns from parent folder through all nested children at every depth level"
    - "Folder icons and file icons align vertically at the same depth — no horizontal offset between folder rows and file rows"
    - "Indent guides at depth N align with the chevron column of the ancestor at depth N"
  artifacts:
    - path: "src/components/staging/TreeIndentGuides.tsx"
      provides: "Shared inline indent guide component used by both folder rows and file items"
      exports: ["TreeIndentGuides"]
    - path: "src/components/staging/FileTreeView.tsx"
      provides: "Folder rows using inline indent guides instead of absolute positioning"
      contains: "TreeIndentGuides"
    - path: "src/components/staging/FileItem.tsx"
      provides: "File rows using inline indent guides in tree mode"
      contains: "TreeIndentGuides"
  key_links:
    - from: "src/components/staging/FileTreeView.tsx"
      to: "src/components/staging/TreeIndentGuides.tsx"
      via: "import and render as first flex child in folder rows"
      pattern: "TreeIndentGuides"
    - from: "src/components/staging/FileItem.tsx"
      to: "src/components/staging/TreeIndentGuides.tsx"
      via: "import and render as first flex child when showFilenameOnly"
      pattern: "TreeIndentGuides"
---

<objective>
Fix broken vertical indent guide lines in the hierarchical file tree (UAT gap from test 6).

The current `IndentGuides` component uses absolute positioning (`left: ${i * 16 + 16}px`) inside per-row `position: relative` wrappers. This creates disconnected line segments that don't form coherent vertical columns across rows. Additionally, folder rows use `paddingLeft` for indentation while the absolute guides are positioned independently, causing misalignment.

The fix replaces absolute-positioned guides with inline flex-based indent spacers. Each row renders a single fixed-width flex child containing centered vertical line segments — one per ancestor depth level. Since these spacers are part of the normal document flow and identical across all rows at the same depth, the vertical lines align perfectly and form continuous columns.

Purpose: Close the last UAT gap so Phase 17 can be marked fully complete.
Output: Coherent, continuous vertical indent guide lines in the hierarchical staging tree at all nesting depths.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-hierarchical-view-commit-enhancements/17-02-SUMMARY.md
@.planning/phases/17-hierarchical-view-commit-enhancements/17-UAT.md
@src/components/staging/FileTreeView.tsx
@src/components/staging/FileItem.tsx
@src/components/staging/FileList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace absolute indent guides with inline flex spacers</name>
  <files>
    src/components/staging/TreeIndentGuides.tsx
    src/components/staging/FileTreeView.tsx
    src/components/staging/FileItem.tsx
  </files>
  <action>
**Create `src/components/staging/TreeIndentGuides.tsx`:**

A small shared component that renders inline indent guide spacers as a single flex child. This is used by both folder rows in FileTreeView and file rows in FileItem.

```tsx
interface TreeIndentGuidesProps {
  depth: number;
}

export function TreeIndentGuides({ depth }: TreeIndentGuidesProps) {
  if (depth === 0) return null;
  return (
    <div
      className="flex self-stretch shrink-0"
      style={{ width: `${depth * 16}px` }}
      aria-hidden="true"
    >
      {Array.from({ length: depth }).map((_, i) => (
        <div
          key={i}
          className="w-4 flex items-center justify-center shrink-0"
        >
          <div className="w-px self-stretch bg-ctp-surface1" />
        </div>
      ))}
    </div>
  );
}
```

Key design decisions:
- Single flex child with explicit `width: depth * 16px` — contributes only 1 gap slot regardless of depth, so folder and file rows align identically.
- Uses `self-stretch` on both the outer container and inner line divs so the vertical lines stretch to the full row height without needing `h-full` (which requires a height-defined parent).
- Each 16px-wide sub-container centers a 1px vertical line, matching the 16px indent step established in Plan 17-02.
- `aria-hidden="true"` because the guides are purely decorative.

**Modify `src/components/staging/FileTreeView.tsx`:**

1. **Delete the `IndentGuides` component entirely** (lines 120-133). It is fully replaced by `TreeIndentGuides`.

2. **Add import:** `import { TreeIndentGuides } from "./TreeIndentGuides";`

3. **File TreeNode case (lines 144-156):** Remove the `<div className="relative">` wrapper. The structure becomes:
   ```tsx
   if (!node.isDirectory && node.file) {
     return (
       <FileItem
         file={node.file}
         section={section}
         depth={depth}
         showFilenameOnly
         onFileSelect={onFileSelect}
       />
     );
   }
   ```
   (FileItem will handle its own indent guides internally.)

4. **Folder TreeNode row (lines 167-232):**
   - Change `<div className="relative group">` to `<div className="group">` (remove `relative` — no longer needed for absolute positioning).
   - **Remove** the `<IndentGuides depth={depth} />` line.
   - **Remove** the inline `style={{ paddingLeft: \`${depth * 16 + 8}px\` }}` from the row div.
   - **Add** `<TreeIndentGuides depth={depth} />` as the FIRST child inside the flex row div, before the chevron `<span>`.

   The folder row structure becomes:
   ```tsx
   <div className="group">
     <div
       role="button"
       tabIndex={0}
       className={cn(
         "flex items-center gap-1 px-2 py-1 cursor-pointer",
         "hover:bg-ctp-surface0/50 text-sm text-ctp-subtext0 w-full text-left",
       )}
       onClick={() => setExpanded(!expanded)}
       onKeyDown={...}
     >
       <TreeIndentGuides depth={depth} />
       <span className="w-4 flex items-center justify-center shrink-0">
         {expanded ? <ChevronDown .../> : <ChevronRight .../>}
       </span>
       <span className="w-4 flex items-center justify-center shrink-0">
         <FileTypeIcon .../>
       </span>
       <span className="ml-0.5 flex-1 truncate">{node.name}</span>
       {onStageFolder && (
         <button ...>
           ...
         </button>
       )}
     </div>
   </div>
   ```

**Modify `src/components/staging/FileItem.tsx`:**

1. **Add import:** `import { TreeIndentGuides } from "./TreeIndentGuides";`

2. **Remove the `indentStyle` variable** (lines 60-61): Delete `const indentStyle = depth > 0 ? { paddingLeft: \`${depth * 16 + 8}px\` } : undefined;`

3. **Remove `style={indentStyle}`** from the outer div (line 86).

4. **Conditionally adjust layout classes for tree mode** (when `showFilenameOnly` is true): The outer div needs to use `gap-1` instead of `gap-2`, and `px-2` instead of `px-3`, to match folder row alignment. Change the className to:
   ```tsx
   className={cn(
     "flex items-center cursor-pointer group",
     "hover:bg-ctp-surface0/50 transition-colors",
     showFilenameOnly ? "gap-1 px-2 py-1" : "gap-2 px-3 py-1.5",
     isSelected && "bg-ctp-blue/20 border-l-2 border-ctp-blue",
   )}
   ```
   This ensures tree-mode file rows use identical gap and padding as folder rows. The flat-list mode (FileList) retains its original `gap-2 px-3 py-1.5` appearance since `showFilenameOnly` defaults to `false`.

5. **Add `<TreeIndentGuides depth={depth} />` as the first child** inside the flex container, BEFORE the existing chevron spacer. Only render when in tree mode:
   ```tsx
   <div className={cn(...)}>
     {showFilenameOnly && <TreeIndentGuides depth={depth} />}
     {showFilenameOnly && <span className="w-4 shrink-0" aria-hidden="true" />}
     <div className="relative shrink-0">
       <FileTypeIcon path={file.path} className="w-4 h-4" />
       ...
     </div>
     ...
   </div>
   ```

**Alignment verification math:**
At depth=2, both folder and file rows in tree mode:
- `px-2` = 8px left padding
- `TreeIndentGuides` width = 2 * 16 = 32px (1 flex child)
- `gap-1` after guides = 4px
- Chevron/spacer `w-4` = 16px
- `gap-1` after chevron = 4px
- Icon `w-4` = 16px
- `gap-1` after icon = 4px
- Text starts at: 8 + 32 + 4 + 16 + 4 + 16 + 4 = 84px

Both folder rows and file rows produce identical x-offsets. The vertical guide lines at each depth level are centered at: `8 + (i * 16) + 8 = 16 + i * 16` px from the row's left edge (where i is 0-indexed ancestor level). These positions are identical across all rows, creating coherent continuous columns.

**What NOT to change:**
- `FileList.tsx` — flat list view, unaffected (uses FileItem with default depth=0 and showFilenameOnly=false)
- `FileTreeBlade.tsx` — uses a structurally different tree (`<details>` elements), not part of this system (per 17-02 SUMMARY decision)
- The root `<div className="pl-2">` in FileTreeView — keep as is, it provides the base left margin for the entire tree
  </action>
  <verify>
1. `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` — no new type errors
2. `npm run build` — builds successfully
3. Visual check: Open app with a repo that has nested directories (2+ levels deep). In the hierarchical staging view, verify:
   - Vertical indent guide lines form continuous, unbroken columns from parent to deepest child
   - Lines are thin (1px), subtle (ctp-surface1 color), and consistently spaced at 16px intervals
   - Folder icons at depth N align horizontally with file icons at depth N
   - Chevrons at depth N align horizontally with the empty chevron-spacer on files at depth N
   - Text labels start at the same horizontal position for all items at the same depth
4. Toggle between "Staged Changes", "Changes", and "Untracked Files" sections — guides render correctly in all three
5. Flat file list view (toggle from hierarchical to flat if possible, or check FileList sections) still looks normal — no visual regression from FileItem className changes
  </verify>
  <done>
Vertical indent guide lines in the hierarchical file tree form continuous, coherent columns at every nesting depth. Folder rows and file rows at the same depth are perfectly aligned (icons, text, and guides). No regressions in the flat list view. The absolute positioning + paddingLeft mismatch is eliminated.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Fixed vertical indent guide lines in the hierarchical staging file tree. Replaced the broken absolute-positioned IndentGuides with inline flex-based TreeIndentGuides that form continuous vertical columns. Normalized gap and padding between folder rows and file rows for perfect alignment.
  </what-built>
  <how-to-verify>
**Recheck UAT Test 6 — Uniform icon spacing and indent guides in file tree:**
1. Open a repository with nested directories (at least 3 levels deep) and some modified/untracked files
2. Switch to the hierarchical staging view
3. Look at the vertical indent guide lines:
   - Lines should form continuous, unbroken vertical columns from parent folders through all children
   - Lines should be consistent, thin, and evenly spaced
   - No broken segments, no horizontal misalignment between rows
4. Compare folder rows and file rows at the same depth:
   - Chevron/spacer, icon, and text should all align horizontally
   - No offset between folder names and file names at the same nesting level
5. Expand and collapse folders — guides should appear/disappear cleanly
6. Check that the flat file list (non-hierarchical view) still looks normal with no regressions
  </how-to-verify>
  <resume-signal>Type "approved" if indent guides look coherent and aligned, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without new errors: `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'`
2. Frontend builds successfully: `npm run build`
3. Vertical indent guide lines form continuous columns across all rows at every depth
4. Folder and file rows at the same depth are perfectly horizontally aligned
5. Flat file list view (FileList component) has no visual regressions
6. All 7 previously passing UAT tests still pass (folder stage/unstage, colored icons, changelog, etc.)
</verification>

<success_criteria>
- UAT Test 6 passes: Vertical indent guide lines are continuous and coherent at all nesting depths
- Folder icons and file icons at the same depth align vertically
- Indent guides, chevrons, icons, and text all use consistent positioning across folder and file rows
- No regressions in flat list view or other staging functionality
- All 8 UAT tests pass (7 existing + 1 gap fix)
</success_criteria>

<output>
After completion, create `.planning/phases/17-hierarchical-view-commit-enhancements/17-04-SUMMARY.md`
</output>
