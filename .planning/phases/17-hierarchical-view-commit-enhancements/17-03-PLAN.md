---
phase: 17-hierarchical-view-commit-enhancements
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src-tauri/src/git/changelog.rs
  - src/components/changelog/ChangelogPreview.tsx
autonomous: true

must_haves:
  truths:
    - "Generated changelog markdown includes a commit type emoji next to each group heading"
    - "ChangelogPreview component shows colored commit type icons in the breakdown section"
    - "ChangelogPreview commit entries show a subtle colored icon next to each commit description"
  artifacts:
    - path: "src-tauri/src/git/changelog.rs"
      provides: "Changelog templates with emoji markers per commit type group"
      contains: "get_type_emoji"
    - path: "src/components/changelog/ChangelogPreview.tsx"
      provides: "Rich changelog preview with colored commit type icons"
      contains: "CommitTypeIcon"
  key_links:
    - from: "src/lib/commit-type-theme.ts"
      to: "src/components/changelog/ChangelogPreview.tsx"
      via: "Import COMMIT_TYPE_COLORS and COMMIT_TYPE_ICONS"
      pattern: "import.*commit-type-theme"
    - from: "src/components/icons/CommitTypeIcon.tsx"
      to: "src/components/changelog/ChangelogPreview.tsx"
      via: "CommitTypeIcon component usage in group breakdown"
      pattern: "<CommitTypeIcon"
---

<objective>
Add emoji markers to generated changelog markdown and enhance the ChangelogPreview component with colored commit type icons.

Purpose: The generated changelog currently has plain text group headings (`## Features`, `## Bug Fixes`) with no visual type indicator. This plan adds emoji prefixes to the Rust Tera templates for exported markdown, and adds colored commit type icons to the frontend ChangelogPreview component's group breakdown section. This satisfies requirement CCMT-02.

Output: Enhanced Tera templates with emoji per commit type group, and a ChangelogPreview component that displays colored icons for each group and commit entry.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-hierarchical-view-commit-enhancements/17-RESEARCH.md

@src-tauri/src/git/changelog.rs
@src/components/changelog/ChangelogPreview.tsx
@src/stores/changelogStore.ts

Depends on Plan 17-01 for:
- src/lib/commit-type-theme.ts (COMMIT_TYPE_ICONS, COMMIT_TYPE_COLORS, ConventionalCommitType)
- src/components/icons/CommitTypeIcon.tsx (CommitTypeIcon component)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add emoji markers to Rust changelog templates</name>
  <files>src-tauri/src/git/changelog.rs</files>
  <action>
**Add `get_type_emoji` helper function** in `src-tauri/src/git/changelog.rs`, place it near `get_type_title`:

```rust
/// Get the emoji for a commit type.
fn get_type_emoji(commit_type: &str) -> &'static str {
    match commit_type {
        "feat" => "\u{2728}",          // sparkles
        "fix" => "\u{1F41B}",          // bug
        "perf" => "\u{26A1}",          // zap
        "refactor" => "\u{1F528}",     // hammer
        "docs" => "\u{1F4DD}",         // memo
        "style" => "\u{1F3A8}",        // artist palette
        "test" => "\u{1F9EA}",         // test tube
        "chore" => "\u{2699}\u{FE0F}", // gear
        "ci" => "\u{1F680}",           // rocket
        "build" => "\u{1F4E6}",        // package
        "revert" => "\u{21A9}\u{FE0F}", // reverse arrow
        _ => "\u{1F4CB}",              // clipboard
    }
}
```

**Add `emoji` field to `CommitGroup` struct:**

Add a new field to the `CommitGroup` struct:
```rust
pub struct CommitGroup {
    pub commit_type: String,
    pub title: String,
    /// Emoji for the commit type (e.g., sparkles for feat).
    pub emoji: String,
    pub commits: Vec<ChangelogCommit>,
}
```

**Update `generate_changelog` function** to populate the emoji field:

In the `groups_map.into_iter().map(...)` closure where CommitGroup instances are created, add the emoji:
```rust
.map(|(commit_type, commits)| CommitGroup {
    title: get_type_title(&commit_type).to_string(),
    emoji: get_type_emoji(&commit_type).to_string(),
    commit_type,
    commits,
})
```

**Update both Tera templates** to include emoji in headings:

Update `DEFAULT_TEMPLATE`:
```
# Changelog

{% for group in groups %}
## {{ group.emoji }} {{ group.title }}

{% for commit in group.commits %}
- {% if commit.scope %}**{{ commit.scope }}:** {% endif %}{{ commit.description }}{% if commit.breaking %} **BREAKING**{% endif %} ([{{ commit.hash }}])
{% endfor %}

{% endfor %}
```

Update `VERSIONED_TEMPLATE`:
```
# Changelog

## {% if version %}{{ version }}{% else %}Unreleased{% endif %}{% if date %} ({{ date }}){% endif %}

{% for group in groups %}
### {{ group.emoji }} {{ group.title }}

{% for commit in group.commits %}
- {% if commit.scope %}**{{ commit.scope }}:** {% endif %}{{ commit.description }}{% if commit.breaking %} **BREAKING**{% endif %}
{% endfor %}

{% endfor %}
```

**Update tests** that assert on template output:

- `test_template_rendering`: Update the assertion to match `"## \u{2728} Features"` instead of `"## Features"`. Or use `assert!(result.contains("Features"))` which still works since the emoji is just prepended.
- `test_versioned_template_rendering`: Update to match `"### \u{1F41B} Bug Fixes"` or use `assert!(result.contains("Bug Fixes"))`.
- `test_group_sorting`: Add `emoji` field to the manually created CommitGroup instances: `emoji: get_type_emoji("chore").to_string()`, etc.

**Build to regenerate bindings:**

Run `cargo build --manifest-path src-tauri/Cargo.toml` to regenerate `src/bindings.ts` with the new `emoji` field on `CommitGroup`.
  </action>
  <verify>
Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && cargo test --manifest-path src-tauri/Cargo.toml -- changelog 2>&1 | tail -20` -- all changelog tests pass. Run `cargo build --manifest-path src-tauri/Cargo.toml` -- compiles without errors. Run `grep "emoji" src/bindings.ts` to confirm the emoji field appears in the generated CommitGroup type.
  </verify>
  <done>
Changelog Tera templates include emoji markers in group headings (e.g., "## sparkles Features"). CommitGroup struct has an `emoji` field populated from `get_type_emoji`. All existing tests pass with updated assertions. TypeScript bindings regenerated with the new field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance ChangelogPreview with colored commit type icons</name>
  <files>src/components/changelog/ChangelogPreview.tsx</files>
  <action>
**Enhance `src/components/changelog/ChangelogPreview.tsx`:**

1. Add imports:
   ```typescript
   import { CommitTypeIcon } from "../icons/CommitTypeIcon";
   import type { ConventionalCommitType } from "../../lib/commit-type-theme";
   ```

2. **Enhance the "Breakdown" section** to show colored icons next to each group:

   Replace the current breakdown grid:
   ```tsx
   <div className="grid grid-cols-2 gap-2 text-sm">
     {changelog.groups.map((group) => (
       <div key={group.commitType} className="flex justify-between p-2 bg-ctp-surface0/50 rounded">
         <span className="text-ctp-subtext1">{group.title}</span>
         <span className="text-ctp-overlay0">{group.commits.length}</span>
       </div>
     ))}
   </div>
   ```

   With an enhanced version that includes the commit type icon:
   ```tsx
   <div className="grid grid-cols-2 gap-2 text-sm">
     {changelog.groups.map((group) => (
       <div
         key={group.commitType}
         className="flex items-center gap-2 p-2 bg-ctp-surface0/50 rounded"
       >
         <CommitTypeIcon
           commitType={group.commitType as ConventionalCommitType}
           className="w-4 h-4 shrink-0"
         />
         <span className="flex-1 text-ctp-subtext1">{group.title}</span>
         <span className="text-ctp-overlay0">{group.commits.length}</span>
       </div>
     ))}
   </div>
   ```

   Key changes: added `items-center gap-2` to the flex container, inserted `CommitTypeIcon` before the title, made the title `flex-1`.

3. **Add a detailed commit list below each group** (optional enhancement for richer preview):

   After the breakdown grid, add an expandable commit list showing individual commits with their icons. This keeps it subtle -- just icon + text:

   ```tsx
   {changelog.groups.length > 0 && (
     <div className="space-y-3">
       <h4 className="text-sm font-medium text-ctp-subtext1">Breakdown</h4>
       {/* Summary grid */}
       <div className="grid grid-cols-2 gap-2 text-sm">
         {/* ... grid as above ... */}
       </div>
       {/* Detailed commit list */}
       <div className="space-y-2 text-sm">
         {changelog.groups.map((group) => (
           <div key={group.commitType}>
             <div className="flex items-center gap-1.5 text-ctp-subtext0 mb-1">
               <CommitTypeIcon
                 commitType={group.commitType as ConventionalCommitType}
                 className="w-3.5 h-3.5"
               />
               <span className="font-medium">{group.title}</span>
             </div>
             <div className="pl-5 space-y-0.5">
               {group.commits.map((commit) => (
                 <div key={commit.hash} className="flex items-start gap-1.5 text-ctp-overlay1">
                   <span className="text-ctp-overlay0 font-mono text-xs mt-0.5">{commit.hash}</span>
                   <span>
                     {commit.scope && (
                       <strong className="text-ctp-subtext1">{commit.scope}: </strong>
                     )}
                     {commit.description}
                   </span>
                 </div>
               ))}
             </div>
           </div>
         ))}
       </div>
     </div>
   )}
   ```

   This replaces the existing breakdown section entirely. The summary grid and detailed list are combined into a single `space-y-3` container. The subtle approach: group header has the colored icon, individual commits just have hash + description (no per-commit icon to keep it minimal per user guidance of "subtle -- icon + text, not badges").

4. Keep the existing markdown preview section (`<pre>` block) unchanged -- it already shows the raw markdown which now includes emoji from the Tera template.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new TypeScript errors. Run `npm run build` to verify the app builds. Visually: generate a changelog and verify that:
1. The markdown preview shows emoji in group headings
2. The breakdown section shows colored commit type icons per group
3. The detailed commit list shows commits organized under their type groups
  </verify>
  <done>
ChangelogPreview shows colored commit type icons in the breakdown section with each group. The detailed commit list under the breakdown shows individual commits organized by type. The raw markdown preview includes emoji markers from the Tera template. The presentation is subtle -- colored group header icons without excessive visual weight.
  </done>
</task>

</tasks>

<verification>
1. `cargo test --manifest-path src-tauri/Cargo.toml -- changelog` -- all tests pass
2. `cargo build --manifest-path src-tauri/Cargo.toml` -- compiles without errors
3. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no errors
4. `npm run build` succeeds
5. `grep "get_type_emoji" src-tauri/src/git/changelog.rs` -- function exists
6. `grep "emoji" src-tauri/src/git/changelog.rs` -- field exists in CommitGroup
7. `grep "CommitTypeIcon" src/components/changelog/ChangelogPreview.tsx` -- component is used
</verification>

<success_criteria>
- Generated changelog markdown includes emoji prefix in each group heading (e.g., "## sparkles Features")
- ChangelogPreview breakdown section shows a colored commit type icon next to each group name
- ChangelogPreview detailed commit list shows commits organized by type with group header icons
- All Rust changelog tests pass
- TypeScript compilation passes with no new errors
- The emoji field is present in the generated TypeScript bindings for CommitGroup
</success_criteria>

<output>
After completion, create `.planning/phases/17-hierarchical-view-commit-enhancements/17-03-SUMMARY.md`
</output>
