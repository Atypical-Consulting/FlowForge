---
phase: 44-worktree-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/worktrees/index.ts
  - src/extensions/worktrees/components/WorktreeSidebarPanel.tsx
  - src/extensions/worktrees/components/WorktreePanel.tsx
  - src/extensions/worktrees/components/WorktreeItem.tsx
  - src/extensions/worktrees/components/CreateWorktreeDialog.tsx
  - src/extensions/worktrees/components/DeleteWorktreeDialog.tsx
  - src/extensions/worktrees/components/index.ts
  - src/extensions/ExtensionAPI.ts
autonomous: true

must_haves:
  truths:
    - "Worktrees extension entry point exports onActivate and onDeactivate following Gitflow pattern"
    - "WorktreeSidebarPanel wraps WorktreePanel + both dialogs with self-contained state"
    - "All 4 moved component files have correct relative import paths to stores, bindings, and UI components"
    - "ExtensionSidebarPanelConfig includes optional badge property"
  artifacts:
    - path: "src/extensions/worktrees/index.ts"
      provides: "Extension entry point with onActivate/onDeactivate"
      exports: ["onActivate", "onDeactivate"]
    - path: "src/extensions/worktrees/components/WorktreeSidebarPanel.tsx"
      provides: "Self-contained panel with dialog state and CustomEvent listener"
      exports: ["WorktreeSidebarPanel"]
    - path: "src/extensions/worktrees/components/WorktreePanel.tsx"
      provides: "Worktree list panel (moved from src/components/worktree/)"
      exports: ["WorktreePanel"]
    - path: "src/extensions/worktrees/components/WorktreeItem.tsx"
      provides: "Single worktree row component (moved from src/components/worktree/)"
      exports: ["WorktreeItem"]
    - path: "src/extensions/worktrees/components/CreateWorktreeDialog.tsx"
      provides: "Create worktree dialog (moved from src/components/worktree/)"
      exports: ["CreateWorktreeDialog"]
    - path: "src/extensions/worktrees/components/DeleteWorktreeDialog.tsx"
      provides: "Delete worktree dialog (moved from src/components/worktree/)"
      exports: ["DeleteWorktreeDialog"]
    - path: "src/extensions/worktrees/components/index.ts"
      provides: "Barrel export for extension components"
    - path: "src/extensions/ExtensionAPI.ts"
      provides: "ExtensionSidebarPanelConfig with badge property"
      contains: "badge"
  key_links:
    - from: "src/extensions/worktrees/index.ts"
      to: "src/extensions/ExtensionAPI.ts"
      via: "import type { ExtensionAPI }"
      pattern: "import.*ExtensionAPI"
    - from: "src/extensions/worktrees/index.ts"
      to: "src/lib/sidebarPanelRegistry.ts"
      via: "api.contributeSidebarPanel()"
      pattern: "contributeSidebarPanel"
    - from: "src/extensions/worktrees/components/WorktreeSidebarPanel.tsx"
      to: "src/extensions/worktrees/components/WorktreePanel.tsx"
      via: "import { WorktreePanel }"
      pattern: "import.*WorktreePanel"
    - from: "src/extensions/worktrees/components/WorktreePanel.tsx"
      to: "src/stores/domain/git-ops"
      via: "useGitOpsStore"
      pattern: "useGitOpsStore"
---

<objective>
Create the Worktrees extension package with entry point, self-contained sidebar panel wrapper, and relocated component files.

Purpose: Establish the extension structure so Plan 02 can wire it into the app and remove hardcoded RepositoryView code.
Output: Complete `src/extensions/worktrees/` directory with all components and entry point, plus badge support on ExtensionSidebarPanelConfig.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference pattern -- Gitflow extension entry point
@src/extensions/gitflow/index.ts
@src/extensions/gitflow/components/GitflowPanel.tsx

# Components being moved (read for content + import paths)
@src/components/worktree/WorktreePanel.tsx
@src/components/worktree/WorktreeItem.tsx
@src/components/worktree/CreateWorktreeDialog.tsx
@src/components/worktree/DeleteWorktreeDialog.tsx
@src/components/worktree/index.ts

# Extension API (adding badge to ExtensionSidebarPanelConfig)
@src/extensions/ExtensionAPI.ts

# Sidebar panel registry (badge already supported here)
@src/lib/sidebarPanelRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create worktrees extension components and entry point</name>
  <files>
    src/extensions/worktrees/components/WorktreePanel.tsx
    src/extensions/worktrees/components/WorktreeItem.tsx
    src/extensions/worktrees/components/CreateWorktreeDialog.tsx
    src/extensions/worktrees/components/DeleteWorktreeDialog.tsx
    src/extensions/worktrees/components/WorktreeSidebarPanel.tsx
    src/extensions/worktrees/components/index.ts
    src/extensions/worktrees/index.ts
  </files>
  <action>
    **Step 1: Move 4 component files** from `src/components/worktree/` to `src/extensions/worktrees/components/`.

    For each moved file, update ONLY the relative import paths (the content/logic stays identical):

    - `WorktreePanel.tsx`: Change `../../stores/domain/git-ops` to `../../../stores/domain/git-ops`. Change `./WorktreeItem` stays the same (sibling).
    - `WorktreeItem.tsx`: Change `../../bindings` to `../../../bindings`. Change `../../lib/utils` to `../../../lib/utils`.
    - `CreateWorktreeDialog.tsx`: Change `../../stores/domain/git-ops` to `../../../stores/domain/git-ops`. Change `../ui/button` to `../../../components/ui/button`. Change `../ui/dialog` to `../../../components/ui/dialog`. Change `../ui/input` to `../../../components/ui/input`.
    - `DeleteWorktreeDialog.tsx`: Change `../../stores/domain/git-ops` to `../../../stores/domain/git-ops`. Change `../ui/button` to `../../../components/ui/button`. Change `../ui/dialog` to `../../../components/ui/dialog`.

    **Step 2: Create `WorktreeSidebarPanel.tsx`** -- a new wrapper component following the GitflowPanel pattern for self-contained dialog state.

    ```tsx
    import { useEffect, useState } from "react";
    import { WorktreePanel } from "./WorktreePanel";
    import { CreateWorktreeDialog } from "./CreateWorktreeDialog";
    import { DeleteWorktreeDialog } from "./DeleteWorktreeDialog";

    export function WorktreeSidebarPanel() {
      const [showCreate, setShowCreate] = useState(false);
      const [deleteTarget, setDeleteTarget] = useState<string | null>(null);

      // Listen for CustomEvent from renderAction "+" button
      useEffect(() => {
        const handler = () => setShowCreate(true);
        document.addEventListener("worktree:open-create-dialog", handler);
        return () => document.removeEventListener("worktree:open-create-dialog", handler);
      }, []);

      return (
        <>
          <WorktreePanel onOpenDeleteDialog={setDeleteTarget} />
          <CreateWorktreeDialog
            open={showCreate}
            onOpenChange={setShowCreate}
          />
          <DeleteWorktreeDialog
            worktreeName={deleteTarget}
            onOpenChange={(open) => !open && setDeleteTarget(null)}
          />
        </>
      );
    }
    ```

    **Step 3: Create barrel export** `src/extensions/worktrees/components/index.ts`:
    ```ts
    export { WorktreeSidebarPanel } from "./WorktreeSidebarPanel";
    ```

    **Step 4: Create extension entry point** `src/extensions/worktrees/index.ts` following the Gitflow pattern:

    ```typescript
    import { FolderGit2, Plus, RefreshCw } from "lucide-react";
    import type { ExtensionAPI } from "../ExtensionAPI";
    import { useGitOpsStore } from "../../stores/domain/git-ops";
    import { WorktreeSidebarPanel } from "./components";

    export async function onActivate(api: ExtensionAPI): Promise<void> {
      // Contribute sidebar panel (replaces hardcoded RepositoryView section)
      api.contributeSidebarPanel({
        id: "worktree-panel",
        title: "Worktrees",
        icon: FolderGit2,
        component: WorktreeSidebarPanel,
        priority: 69,
        defaultOpen: false,
        renderAction: () => {
          // "+" button that dispatches CustomEvent to open create dialog
          const handleClick = (e: React.MouseEvent) => {
            e.preventDefault();
            document.dispatchEvent(new CustomEvent("worktree:open-create-dialog"));
          };
          return (
            <button
              type="button"
              onClick={handleClick}
              className="p-1 hover:bg-ctp-surface1 rounded text-ctp-subtext0 hover:text-ctp-text"
              title="Create new worktree"
            >
              <Plus className="w-3.5 h-3.5" />
            </button>
          );
        },
        badge: () => {
          const count = useGitOpsStore.getState().worktreeList.length;
          return count > 1 ? count : null;
        },
      });

      // Register "Create Worktree" command in palette
      api.registerCommand({
        id: "create-worktree",
        title: "Create Worktree",
        description: "Create a new git worktree",
        category: "Worktrees",
        icon: FolderGit2,
        keywords: ["worktree", "create", "new", "folder"],
        action: () => {
          document.dispatchEvent(new CustomEvent("worktree:open-create-dialog"));
        },
        enabled: () => !!useGitOpsStore.getState().repoStatus,
      });

      // Register "Refresh Worktrees" command in palette
      api.registerCommand({
        id: "refresh-worktrees",
        title: "Refresh Worktrees",
        description: "Reload the worktree list",
        category: "Worktrees",
        icon: RefreshCw,
        keywords: ["worktree", "refresh", "reload", "list"],
        action: () => {
          useGitOpsStore.getState().loadWorktrees();
        },
        enabled: () => !!useGitOpsStore.getState().repoStatus,
      });
    }

    export function onDeactivate(): void {
      // No custom cleanup needed -- api.cleanup() handles all registrations
    }
    ```

    Note: The `renderAction` uses JSX inside the entry point. Since this is a `.ts` file, either:
    - Rename to `index.tsx` (preferred -- matches the JSX usage), OR
    - Use `React.createElement` instead of JSX

    Use `.tsx` extension for the entry point file since it contains JSX in the renderAction callback. This matches the pattern used by other extensions that need inline JSX.
  </action>
  <verify>
    - All 7 files exist under `src/extensions/worktrees/`
    - `WorktreeSidebarPanel.tsx` imports all three sub-components and manages dialog state
    - Entry point exports `onActivate` and `onDeactivate`
    - `onActivate` calls `api.contributeSidebarPanel()` with priority 69, badge function, and renderAction
    - `onActivate` registers 2 commands (create-worktree, refresh-worktrees) in "Worktrees" category
    - No import path errors in moved files (relative paths updated from 2-deep to 3-deep)
  </verify>
  <done>
    Complete worktrees extension directory exists with entry point, wrapper panel, and 4 relocated components, all with correct import paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add badge property to ExtensionSidebarPanelConfig</name>
  <files>
    src/extensions/ExtensionAPI.ts
  </files>
  <action>
    Add optional `badge` property to the `ExtensionSidebarPanelConfig` interface in `src/extensions/ExtensionAPI.ts`.

    In the `ExtensionSidebarPanelConfig` interface (around line 100-109), add after the `renderAction` field:

    ```typescript
    /** Optional badge function returning a count/label to display on the panel header. */
    badge?: () => number | string | null;
    ```

    This matches the existing `badge` property on `SidebarPanelConfig` in `src/lib/sidebarPanelRegistry.ts` (line 18). The `contributeSidebarPanel` method already passes `...config` through, so the badge value will flow through to the registry automatically without any changes to the method.

    Verify the type signature matches: `() => number | string | null` (same as SidebarPanelConfig.badge).
  </action>
  <verify>
    - `ExtensionSidebarPanelConfig` interface includes `badge?: () => number | string | null`
    - TypeScript compiles without errors on `src/extensions/ExtensionAPI.ts`
    - The worktrees extension entry point (Task 1) can use `badge` in its `contributeSidebarPanel` call without type errors
  </verify>
  <done>
    `ExtensionSidebarPanelConfig` exposes `badge` property, enabling extensions (including worktrees) to show dynamic badges on sidebar panels.
  </done>
</task>

</tasks>

<verification>
1. `ls src/extensions/worktrees/` shows: `index.tsx`, `components/`
2. `ls src/extensions/worktrees/components/` shows: `WorktreeSidebarPanel.tsx`, `WorktreePanel.tsx`, `WorktreeItem.tsx`, `CreateWorktreeDialog.tsx`, `DeleteWorktreeDialog.tsx`, `index.ts`
3. `grep -r "contributeSidebarPanel" src/extensions/worktrees/index.tsx` returns a match
4. `grep -r "registerCommand" src/extensions/worktrees/index.tsx` returns 2 matches (create + refresh)
5. `grep "badge" src/extensions/ExtensionAPI.ts` shows the new property in ExtensionSidebarPanelConfig
</verification>

<success_criteria>
- All 7 new files exist with correct content
- Extension entry point follows Gitflow pattern (onActivate/onDeactivate)
- WorktreeSidebarPanel is self-contained with dialog state and CustomEvent listener
- Moved components have updated relative import paths (3-level depth to stores/bindings/ui)
- ExtensionSidebarPanelConfig includes badge property
- No references to old `src/components/worktree/` paths in new files
</success_criteria>

<output>
After completion, create `.planning/phases/44-worktree-extraction/44-01-SUMMARY.md`
</output>
