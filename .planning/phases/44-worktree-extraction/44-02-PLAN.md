---
phase: 44-worktree-extraction
plan: 02
type: execute
wave: 2
depends_on: ["44-01"]
files_modified:
  - src/components/RepositoryView.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "RepositoryView contains zero worktree imports, state variables, JSX sections, or dialog renders"
    - "Worktrees extension is registered as built-in in App.tsx and activates on repository open"
    - "Old src/components/worktree/ directory is deleted (components live in extension now)"
    - "Disabling the Worktrees extension removes the sidebar panel and command palette entries without errors"
    - "Worktree data operations (list, create, delete, switch) still work via GitOpsStore"
    - "TypeScript build succeeds with zero worktree-related errors"
  artifacts:
    - path: "src/components/RepositoryView.tsx"
      provides: "RepositoryView with no hardcoded worktree references"
    - path: "src/App.tsx"
      provides: "App with worktrees registerBuiltIn call"
      contains: "worktrees"
  key_links:
    - from: "src/App.tsx"
      to: "src/extensions/worktrees/index.ts"
      via: "import { onActivate as worktreesActivate }"
      pattern: "worktreesActivate"
    - from: "src/App.tsx"
      to: "src/extensions/index.ts"
      via: "registerBuiltIn({ id: 'worktrees' })"
      pattern: "registerBuiltIn.*worktrees"
    - from: "src/extensions/worktrees/components/WorktreeSidebarPanel.tsx"
      to: "src/components/RepositoryView.tsx"
      via: "DynamicSidebarPanels renders extension-contributed panel"
      pattern: "DynamicSidebarPanels"
---

<objective>
Wire the Worktrees extension into the app, remove all hardcoded worktree code from RepositoryView, and delete the old component directory.

Purpose: Complete the extraction by replacing hardcoded RepositoryView worktree JSX with the dynamic extension-contributed sidebar panel, achieving WKTR-01 through WKTR-06.
Output: Clean RepositoryView with no worktree references, worktrees extension registered and activating, old files deleted.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan output (extension files created)
@.planning/phases/44-worktree-extraction/44-01-SUMMARY.md

# Files being modified
@src/components/RepositoryView.tsx
@src/App.tsx

# Reference: how Gitflow is registered in App.tsx (lines 28-29, 79-85)
@src/extensions/gitflow/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove all worktree code from RepositoryView</name>
  <files>
    src/components/RepositoryView.tsx
  </files>
  <action>
    Remove ALL worktree-related code from `src/components/RepositoryView.tsx`. This is a deletion-only task on this file.

    **Remove from imports (top of file):**
    - Remove `FolderGit2` from the lucide-react import (line 3). Keep `Archive`, `GitBranch`, `Plus`, `Tag`.
    - Remove the entire worktree component import block (lines 18-22):
      ```
      import {
        CreateWorktreeDialog,
        DeleteWorktreeDialog,
        WorktreePanel,
      } from "./worktree";
      ```

    **Remove from state variables (inside RepositoryView function):**
    - Remove line 98: `const [showWorktreeDialog, setShowWorktreeDialog] = useState(false);`
    - Remove line 99: `const [worktreeToDelete, setWorktreeToDelete] = useState<string | null>(null);`

    **Remove from JSX -- the entire Worktrees sidebar section (lines 188-210):**
    ```jsx
    {/* Worktrees section */}
    <details className="border-b border-ctp-surface0">
      <summary ...>
        <FolderGit2 ... />
        <span ...>Worktrees</span>
        <button ... onClick={() => setShowWorktreeDialog(true)} ...>
          <Plus ... />
        </button>
      </summary>
      <WorktreePanel onOpenDeleteDialog={(name) => setWorktreeToDelete(name)} />
    </details>
    ```

    **Remove from JSX -- the worktree dialog renders (lines 231-239):**
    ```jsx
    {/* Worktree Dialogs */}
    <CreateWorktreeDialog
      open={showWorktreeDialog}
      onOpenChange={setShowWorktreeDialog}
    />
    <DeleteWorktreeDialog
      worktreeName={worktreeToDelete}
      onOpenChange={(open) => !open && setWorktreeToDelete(null)}
    />
    ```

    After removal, the `DynamicSidebarPanels` component (already present in RepositoryView) will render the extension-contributed worktree panel in its place.

    **Important:** Do NOT remove or modify any other sidebar sections (Branches, Stash, Tags) or the DynamicSidebarPanels component. Only worktree-related code is removed.
  </action>
  <verify>
    - `grep -i "worktree\|FolderGit2" src/components/RepositoryView.tsx` returns NO matches
    - `grep "showWorktreeDialog\|worktreeToDelete" src/components/RepositoryView.tsx` returns NO matches
    - `grep "CreateWorktreeDialog\|DeleteWorktreeDialog\|WorktreePanel" src/components/RepositoryView.tsx` returns NO matches
    - `grep "DynamicSidebarPanels" src/components/RepositoryView.tsx` still returns a match (this component is kept)
    - File still has Branches, Stash, Tags sections intact
  </verify>
  <done>
    RepositoryView.tsx contains zero worktree references. Worktree sidebar panel is now exclusively provided by the extension via DynamicSidebarPanels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register worktrees extension in App.tsx and clean up old directory</name>
  <files>
    src/App.tsx
    src/components/worktree/ (DELETE)
  </files>
  <action>
    **Step 1: Add worktrees import to App.tsx.**

    Add after the existing gitflow import (line 28):
    ```typescript
    import { onActivate as worktreesActivate, onDeactivate as worktreesDeactivate } from "./extensions/worktrees";
    ```

    **Step 2: Add worktrees registerBuiltIn call.**

    Inside the `useEffect` block that registers built-in extensions (after the gitflow registerBuiltIn block, around line 85), add:

    ```typescript
    registerBuiltIn({
      id: "worktrees",
      name: "Worktrees",
      version: "1.0.0",
      activate: worktreesActivate,
      deactivate: worktreesDeactivate,
    });
    ```

    Place it after the gitflow block and before the github block to maintain alphabetical-ish ordering by feature area (content-viewers, conventional-commits, gitflow, worktrees, github).

    **Step 3: Delete old component directory.**

    Delete the entire `src/components/worktree/` directory (5 files):
    - `src/components/worktree/index.ts`
    - `src/components/worktree/WorktreePanel.tsx`
    - `src/components/worktree/WorktreeItem.tsx`
    - `src/components/worktree/CreateWorktreeDialog.tsx`
    - `src/components/worktree/DeleteWorktreeDialog.tsx`

    Use: `rm -rf src/components/worktree/`

    **Step 4: Verify no stale imports exist anywhere.**

    Run: `grep -r "components/worktree" src/` -- should return NO matches.
    Run: `grep -r "from.*\./worktree" src/components/` -- should return NO matches.

    **Step 5: Verify TypeScript compiles.**

    Run: `npx tsc --noEmit 2>&1 | grep -v "bindings.ts(1493"` (exclude pre-existing bindings error).
    Should show zero errors.
  </action>
  <verify>
    - `grep "worktreesActivate" src/App.tsx` returns import and registerBuiltIn matches
    - `grep "id: .worktrees." src/App.tsx` returns the registerBuiltIn call
    - `ls src/components/worktree/ 2>/dev/null` returns error (directory deleted)
    - `grep -r "components/worktree" src/` returns NO matches
    - `npx tsc --noEmit 2>&1 | grep -v "bindings.ts(1493" | grep "error"` returns NO errors
  </verify>
  <done>
    Worktrees extension is registered in App.tsx, old component directory is deleted, TypeScript builds cleanly, and no stale imports remain anywhere in the codebase.
  </done>
</task>

</tasks>

<verification>
1. **WKTR-01:** `grep "registerBuiltIn" src/App.tsx | grep "worktrees"` -- extension is registered as toggleable built-in
2. **WKTR-02:** `grep "contributeSidebarPanel" src/extensions/worktrees/index.tsx` -- panel contributed via API
3. **WKTR-03:** `grep -ic "worktree\|FolderGit2" src/components/RepositoryView.tsx` -- returns 0 (no hardcoded JSX)
4. **WKTR-04:** `grep "registerCommand" src/extensions/worktrees/index.tsx` -- 2 commands registered (create + refresh)
5. **WKTR-05:** Extension uses `api.contributeSidebarPanel()` + `api.registerCommand()` which are auto-cleaned by `api.cleanup()` on disable
6. **WKTR-06:** `cat src/stores/domain/git-ops/worktrees.slice.ts` -- file unchanged, data stays in core
7. **Build:** `npx tsc --noEmit 2>&1 | grep -v "bindings.ts(1493" | grep "error" | wc -l` returns 0
8. **Tests:** `npx vitest run --reporter=verbose 2>&1 | tail -5` -- all 233+ tests pass
</verification>

<success_criteria>
- RepositoryView.tsx has zero worktree/FolderGit2 references (WKTR-03)
- App.tsx registers worktrees as 5th built-in extension (WKTR-01)
- `src/components/worktree/` directory no longer exists
- No stale imports to old worktree component path anywhere in codebase
- TypeScript compiles cleanly (excluding pre-existing bindings.ts error)
- All existing tests pass
- Worktree data slice remains in `src/stores/domain/git-ops/worktrees.slice.ts` untouched (WKTR-06)
</success_criteria>

<output>
After completion, create `.planning/phases/44-worktree-extraction/44-02-SUMMARY.md`
</output>
