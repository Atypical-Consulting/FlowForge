# Phase 44: Worktree Extraction - Implementation Research

## 1. Current Worktree Implementation Map

### 1.1 React Components (Frontend UI)

| File | Purpose | Lines |
|------|---------|-------|
| `src/components/worktree/WorktreePanel.tsx` | Sidebar panel listing all worktrees with select/switch/delete actions | 69 |
| `src/components/worktree/WorktreeItem.tsx` | Single worktree row with status indicator, branch info, and hover action buttons | 139 |
| `src/components/worktree/CreateWorktreeDialog.tsx` | Modal dialog for creating worktrees with name, path, branch selection | 193 |
| `src/components/worktree/DeleteWorktreeDialog.tsx` | Confirmation dialog with force-delete and branch-delete options | 152 |
| `src/components/worktree/index.ts` | Barrel export for all 4 worktree components | 5 |

### 1.2 Hardcoded Worktree JSX in RepositoryView

File: `src/components/RepositoryView.tsx` (lines 188-210, 232-239)

The worktree section is currently hardcoded directly inside the sidebar:

```tsx
{/* Worktrees section */}
<details className="border-b border-ctp-surface0">
  <summary className="p-3 cursor-pointer hover:bg-ctp-surface0/50 ...">
    <FolderGit2 className="w-4 h-4" />
    <span className="font-semibold text-sm flex-1">Worktrees</span>
    <button ... title="Create new worktree">
      <Plus className="w-3.5 h-3.5" />
    </button>
  </summary>
  <WorktreePanel onOpenDeleteDialog={(name) => setWorktreeToDelete(name)} />
</details>
```

And the dialogs are rendered at the bottom of RepositoryView:

```tsx
<CreateWorktreeDialog open={showWorktreeDialog} onOpenChange={setShowWorktreeDialog} />
<DeleteWorktreeDialog worktreeName={worktreeToDelete} onOpenChange={(open) => !open && setWorktreeToDelete(null)} />
```

RepositoryView also manages two state variables for this:
- `showWorktreeDialog` (boolean) - controls CreateWorktreeDialog visibility
- `worktreeToDelete` (string | null) - controls DeleteWorktreeDialog visibility

### 1.3 Zustand Store Slice

File: `src/stores/domain/git-ops/worktrees.slice.ts`

The `WorktreeSlice` interface exposes:

| Property/Method | Type | Description |
|----------------|------|-------------|
| `worktreeList` | `WorktreeInfo[]` | Cached list of all worktrees |
| `worktreeIsLoading` | `boolean` | Loading state for any worktree operation |
| `worktreeError` | `string \| null` | Last error message |
| `worktreeSelected` | `string \| null` | Currently selected worktree name |
| `loadWorktrees()` | `Promise<void>` | Fetches from Tauri backend |
| `createWorktree(opts)` | `Promise<WorktreeInfo \| null>` | Creates worktree via Tauri |
| `deleteWorktree(name, force, deleteBranch)` | `Promise<boolean>` | Deletes worktree via Tauri |
| `selectWorktree(name)` | `void` | Sets selected worktree |
| `openInExplorer(path)` | `Promise<void>` | Opens path in OS file explorer |
| `switchToWorktree(path)` | `Promise<boolean>` | Opens repo at worktree path |
| `clearWorktreeError()` | `void` | Clears error state |

**Critical decision**: The `WorktreeSlice` remains in `GitOpsStore` (core). The extension only contributes UI and commands -- it does not own the data layer. This matches the Phase 44 requirements: "Worktree data operations (list, create, delete, switch) continue working because the data slice remains in core GitOpsStore."

### 1.4 Tauri/Rust Backend Commands

File: `src-tauri/src/git/worktree.rs`

Three Tauri commands, all using `#[tauri::command]` and `#[specta::specta]`:

| Command | Signature | Behavior |
|---------|-----------|----------|
| `list_worktrees` | `(state) -> Vec<WorktreeInfo>` | Returns main worktree + all linked worktrees |
| `create_worktree` | `(options, state) -> WorktreeInfo` | Creates linked worktree, optionally creates branch |
| `delete_worktree` | `(name, force, delete_branch, state) -> ()` | Prunes worktree, optionally deletes branch |

Registered in `src-tauri/src/lib.rs` lines 138-140 within `collect_commands![]`.

### 1.5 TypeScript Bindings

File: `src/bindings.ts`

Auto-generated by `tauri-specta`. Key types:

- `WorktreeInfo` (line 2265): `{ name, path, branch?, status, isMain, isLocked }`
- `CreateWorktreeOptions` (line 1507): `{ name, path, branch?, createBranch }`
- `WorktreeStatus`: `"clean" | "dirty" | "conflicts" | "invalid"`
- `commands.listWorktrees()`, `commands.createWorktree()`, `commands.deleteWorktree()`

### 1.6 Command Registry

File: `src/lib/commandRegistry.ts`

The `"Worktrees"` category is defined as a `CoreCommandCategory` (line 12) with a canonical ordering position (line 41). However, **no worktree commands are currently registered** in the command system. There are no files in `src/commands/` that register worktree commands. The worktree UI is entirely driven by direct component rendering, not the command palette.

### 1.7 Test Utilities

File: `src/test-utils/mocks/tauri-commands.ts`

- `createWorktreeInfo()` factory function (line 207) for test data
- Mock implementations for `listWorktrees`, `createWorktree`, `deleteWorktree` (lines 391-395)

File: `src/stores/domain/git-ops/git-ops.test.ts` - Contains worktree slice tests.

---

## 2. Reference Extension Anatomy: Gitflow Extension

The Gitflow extension is the closest reference for the Worktree extraction because it:
- Contributes a sidebar panel with interactive UI (dialogs inside the panel component)
- Uses core store data (`GitflowSlice` in `GitOpsStore`)
- Registers commands and toolbar actions
- Has a clean `onDeactivate` with no custom cleanup

### 2.1 File Structure

```
src/extensions/gitflow/
  index.ts                        # Extension entry point (onActivate, onDeactivate)
  components/
    index.ts                      # Barrel export
    GitflowPanel.tsx              # Main sidebar panel component (230 lines)
    GitflowActionCards.tsx         # Sub-component
    GitflowBranchReference.tsx     # Sub-component
    GitflowDiagram.tsx             # Sub-component
    InitGitflowDialog.tsx          # Dialog component
    StartFlowDialog.tsx            # Dialog component
    FinishFlowDialog.tsx           # Dialog component
    ReviewChecklist.tsx            # Sub-component
  blades/
    GitflowCheatsheetBlade.tsx     # Blade (lazy-loaded)
    GitflowCheatsheetBlade.test.tsx
```

### 2.2 Entry Point Pattern (`index.ts`)

```typescript
import { lazy } from "react";
import { GitBranch, GitMerge } from "lucide-react";
import type { ExtensionAPI } from "../ExtensionAPI";
import { openBlade } from "../../lib/bladeOpener";
import { useGitOpsStore as useRepositoryStore } from "../../stores/domain/git-ops";
import { GitflowPanel } from "./components";

export async function onActivate(api: ExtensionAPI): Promise<void> {
  // 1. Lazy blade imports
  const GitflowCheatsheetBlade = lazy(() => import("./blades/GitflowCheatsheetBlade")...);

  // 2. Register blade types
  api.registerBlade({ type: "gitflow-cheatsheet", ... , coreOverride: true });

  // 3. Contribute sidebar panel
  api.contributeSidebarPanel({
    id: "gitflow-panel",
    title: "Gitflow",
    icon: GitMerge,
    component: GitflowPanel,
    priority: 65,
    defaultOpen: false,
  });

  // 4. Contribute toolbar actions
  api.contributeToolbar({ ... });

  // 5. Register command palette entries
  api.registerCommand({ ... });
}

export function onDeactivate(): void {
  // No custom cleanup needed -- api.cleanup() handles all registrations
}
```

### 2.3 Registration in `App.tsx`

```typescript
import { onActivate as gitflowActivate, onDeactivate as gitflowDeactivate } from "./extensions/gitflow";

// Inside useEffect:
registerBuiltIn({
  id: "gitflow",
  name: "Gitflow",
  version: "1.0.0",
  activate: gitflowActivate,
  deactivate: gitflowDeactivate,
});
```

### 2.4 How GitflowPanel Handles Dialogs

The `GitflowPanel` component (230 lines) manages dialog state internally:

```typescript
export function GitflowPanel() {
  const [showStartDialog, setShowStartDialog] = useState<FlowType | null>(null);
  const [showFinishDialog, setShowFinishDialog] = useState<FlowType | null>(null);
  const [showInitDialog, setShowInitDialog] = useState(false);
  // ...
  return (
    <div className="p-3 space-y-3">
      {/* Panel content */}
      {showStartDialog && <StartFlowDialog ... />}
      {showFinishDialog && <FinishFlowDialog ... />}
    </div>
  );
}
```

**Key insight**: Dialogs are rendered inside the panel component itself, not in RepositoryView. This is the pattern the Worktree extension must follow.

### 2.5 How DynamicSidebarPanels Renders Extension Panels

In `RepositoryView.tsx` (lines 51-91), the `DynamicSidebarPanels` component:
1. Reads panels from `useSidebarPanelRegistry`
2. Filters visible panels via `getVisiblePanels()`
3. Renders each in a `<details>` accordion with error boundary
4. Supports `renderAction` for header buttons (like the "+" button)

```tsx
<details key={panel.id} open={panel.defaultOpen} className="border-b border-ctp-surface0">
  <summary className="p-3 cursor-pointer ...">
    <panel.icon className="w-4 h-4" />
    <span className="font-semibold text-sm flex-1">{panel.title}</span>
    {panel.badge && ...}
    {panel.renderAction?.()}
  </summary>
  <ExtensionPanelErrorBoundary>
    <panel.component />
  </ExtensionPanelErrorBoundary>
</details>
```

---

## 3. Extension API Surface Analysis

### 3.1 Available APIs for Sidebar Panels

The `ExtensionAPI.contributeSidebarPanel()` method accepts:

```typescript
interface ExtensionSidebarPanelConfig {
  id: string;                        // Namespaced as ext:{extensionId}:{id}
  title: string;                     // Displayed in accordion header
  icon: LucideIcon;                  // 16x16 icon in header
  component: ComponentType<any>;     // The panel React component
  priority?: number;                 // 1-69 (clamped; 70-100 reserved for core)
  when?: () => boolean;              // Visibility predicate
  defaultOpen?: boolean;             // Initial accordion state
  renderAction?: () => ReactNode;    // Extra header content (e.g. "+" button)
}
```

The `SidebarPanelConfig` in the registry also supports:
- `badge?: () => number | string | null` -- badge count in header
- `source?: string` -- auto-set by ExtensionAPI

### 3.2 What's Missing? Nothing Critical

The existing API surface is **sufficient** for the worktree extraction:

1. `contributeSidebarPanel` -- contributes the WorktreePanel to the sidebar
2. `renderAction` -- renders the "+" create button in the accordion header
3. `registerCommand` -- registers command palette entries for worktree operations
4. `when` -- can hide panel when no repo is open (optional, since DynamicSidebarPanels already only renders in RepositoryView)

The `badge` property on `SidebarPanelConfig` is available but not currently exposed in `ExtensionSidebarPanelConfig`. This could be useful for showing worktree count, but is **not required** for MVP.

### 3.3 Cleanup Guarantees

When the extension is deactivated via `ExtensionHost.deactivateExtension()`:
1. `ExtensionAPI.cleanup()` is called
2. Sidebar panels are unregistered via `useSidebarPanelRegistry.getState().unregisterBySource("ext:worktrees")`
3. Commands are unregistered via `unregisterCommand()`
4. Toolbar actions are unregistered via `useToolbarRegistry.getState().unregisterBySource()`
5. Any `onDispose` callbacks fire in reverse order

This means: disabling the worktree extension will automatically remove its sidebar panel and command palette entries, satisfying requirement WKTR-02.

---

## 4. File Change Plan

### 4.1 Files to CREATE

```
src/extensions/worktrees/
  index.ts                           # Extension entry point (onActivate, onDeactivate)
  components/
    index.ts                         # Barrel export
    WorktreePanel.tsx                 # Main panel (moved + adapted from src/components/worktree/WorktreePanel.tsx)
    WorktreeItem.tsx                  # Row component (moved from src/components/worktree/WorktreeItem.tsx)
    CreateWorktreeDialog.tsx          # Dialog (moved from src/components/worktree/CreateWorktreeDialog.tsx)
    DeleteWorktreeDialog.tsx          # Dialog (moved from src/components/worktree/DeleteWorktreeDialog.tsx)

src/extensions/__tests__/
  worktrees.test.ts                  # Extension activation/deactivation tests
```

### 4.2 Files to MODIFY

| File | Change |
|------|--------|
| `src/components/RepositoryView.tsx` | Remove hardcoded Worktrees `<details>` section (lines 188-210), remove `CreateWorktreeDialog` and `DeleteWorktreeDialog` (lines 232-239), remove `showWorktreeDialog` and `worktreeToDelete` state variables, remove `FolderGit2`/`Plus` icon imports if no longer needed, remove `import { CreateWorktreeDialog, DeleteWorktreeDialog, WorktreePanel } from "./worktree"` |
| `src/App.tsx` | Add `registerBuiltIn` call for the worktrees extension (similar to gitflow) |
| `src/lib/commandRegistry.ts` | **No change needed** -- `"Worktrees"` category already exists in `CoreCommandCategory` and `CORE_ORDER` |

### 4.3 Files to DELETE

```
src/components/worktree/
  WorktreePanel.tsx                  # Moved to extension
  WorktreeItem.tsx                   # Moved to extension
  CreateWorktreeDialog.tsx           # Moved to extension
  DeleteWorktreeDialog.tsx           # Moved to extension
  index.ts                           # Moved to extension
```

The entire `src/components/worktree/` directory should be removed.

### 4.4 Files that STAY UNCHANGED

| File | Reason |
|------|--------|
| `src/stores/domain/git-ops/worktrees.slice.ts` | Data layer stays in core |
| `src/stores/domain/git-ops/index.ts` | WorktreeSlice stays composed into GitOpsStore |
| `src-tauri/src/git/worktree.rs` | Rust backend unchanged |
| `src-tauri/src/lib.rs` | Worktree commands stay registered |
| `src/bindings.ts` | Auto-generated, no manual changes |
| `src/test-utils/mocks/tauri-commands.ts` | Test factories stay available |

---

## 5. Detailed Implementation Spec

### 5.1 Extension Entry Point: `src/extensions/worktrees/index.ts`

```typescript
import { createElement, useState } from "react";
import { FolderGit2, Plus } from "lucide-react";
import type { ExtensionAPI } from "../ExtensionAPI";
import { useGitOpsStore as useRepositoryStore } from "../../stores/domain/git-ops";

// Forward-declare component references (loaded eagerly since built-in)
import { WorktreePanel } from "./components";

export async function onActivate(api: ExtensionAPI): Promise<void> {
  // 1. Contribute sidebar panel (replaces hardcoded RepositoryView section)
  api.contributeSidebarPanel({
    id: "worktree-panel",
    title: "Worktrees",
    icon: FolderGit2,
    component: WorktreePanel,
    priority: 60,       // Below Gitflow (65), above dynamic panels
    defaultOpen: false,
    renderAction: () =>
      createElement(WorktreePanelAction),
    badge: () => {
      const count = useRepositoryStore.getState().worktreeList.length;
      return count > 1 ? count : null;  // Only show badge if >1 (main + linked)
    },
  });

  // 2. Register command palette entries
  api.registerCommand({
    id: "list-worktrees",
    title: "List Worktrees",
    description: "Refresh and list all git worktrees",
    category: "Worktrees",
    icon: FolderGit2,
    keywords: ["worktree", "list", "refresh"],
    action: () => {
      useRepositoryStore.getState().loadWorktrees();
    },
    enabled: () => !!useRepositoryStore.getState().repoStatus,
  });

  api.registerCommand({
    id: "create-worktree",
    title: "Create Worktree",
    description: "Create a new git worktree",
    category: "Worktrees",
    icon: Plus,
    keywords: ["worktree", "new", "add", "create"],
    action: () => {
      // Dispatch custom event to open create dialog
      document.dispatchEvent(new CustomEvent("worktree:open-create-dialog"));
    },
    enabled: () => !!useRepositoryStore.getState().repoStatus,
  });
}

export function onDeactivate(): void {
  // No custom cleanup needed -- api.cleanup() handles all registrations
}
```

### 5.2 Adapted WorktreePanel: `src/extensions/worktrees/components/WorktreePanel.tsx`

The key adaptation is that dialogs (CreateWorktreeDialog and DeleteWorktreeDialog) are rendered **inside** the WorktreePanel component, not in RepositoryView. This follows the GitflowPanel pattern.

```typescript
import { useEffect, useState } from "react";
import { Plus } from "lucide-react";
import { useGitOpsStore as useWorktreeStore } from "../../../stores/domain/git-ops";
import { WorktreeItem } from "./WorktreeItem";
import { CreateWorktreeDialog } from "./CreateWorktreeDialog";
import { DeleteWorktreeDialog } from "./DeleteWorktreeDialog";

export function WorktreePanel() {
  const { worktreeList, worktreeIsLoading, worktreeError, worktreeSelected,
    loadWorktrees, selectWorktree, openInExplorer, switchToWorktree, clearWorktreeError
  } = useWorktreeStore();

  const [showCreateDialog, setShowCreateDialog] = useState(false);
  const [worktreeToDelete, setWorktreeToDelete] = useState<string | null>(null);

  useEffect(() => { loadWorktrees(); }, [loadWorktrees]);

  // Listen for command palette "create worktree" event
  useEffect(() => {
    const handler = () => setShowCreateDialog(true);
    document.addEventListener("worktree:open-create-dialog", handler);
    return () => document.removeEventListener("worktree:open-create-dialog", handler);
  }, []);

  // ... render worktree list, then dialogs at the end:
  return (
    <>
      <div className="divide-y divide-ctp-surface0">
        {/* worktree items */}
      </div>
      <CreateWorktreeDialog open={showCreateDialog} onOpenChange={setShowCreateDialog} />
      <DeleteWorktreeDialog worktreeName={worktreeToDelete}
        onOpenChange={(open) => !open && setWorktreeToDelete(null)} />
    </>
  );
}
```

The `renderAction` for the "+" button in the sidebar header is provided via a separate small component:

```typescript
// WorktreePanelAction component (inline in index.ts or separate file)
function WorktreePanelAction() {
  return (
    <button type="button"
      onClick={(e) => {
        e.preventDefault();
        document.dispatchEvent(new CustomEvent("worktree:open-create-dialog"));
      }}
      className="p-1 hover:bg-ctp-surface1 rounded text-ctp-subtext0 hover:text-ctp-text"
      title="Create new worktree"
    >
      <Plus className="w-3.5 h-3.5" />
    </button>
  );
}
```

### 5.3 Registration in App.tsx

Add alongside existing built-in extensions:

```typescript
import { onActivate as worktreesActivate, onDeactivate as worktreesDeactivate } from "./extensions/worktrees";

// Inside the useEffect:
registerBuiltIn({
  id: "worktrees",
  name: "Worktree Management",
  version: "1.0.0",
  activate: worktreesActivate,
  deactivate: worktreesDeactivate,
});
```

### 5.4 RepositoryView.tsx Changes (Detailed)

Lines to remove:

1. **Import removals** (line 6): Remove `FolderGit2` from lucide-react imports (keep `Plus` if still used by Branches/Stash/Tags), remove line 22 worktree imports
2. **State variable removals** (lines 98-99): Remove `showWorktreeDialog` and `worktreeToDelete`
3. **Worktree `<details>` section** (lines 188-210): Remove entire block
4. **Dialog renders** (lines 232-239): Remove `CreateWorktreeDialog` and `DeleteWorktreeDialog`

The `DynamicSidebarPanels` component at line 213 stays -- it will now render the worktree panel when the extension is active.

---

## 6. Rust/Tauri Layer Considerations

### 6.1 Backend: No Changes Required

The Rust backend is completely decoupled from the UI layer:

- `src-tauri/src/git/worktree.rs` -- Pure Rust functions with Tauri command wrappers
- `src-tauri/src/lib.rs` -- Commands registered in `collect_commands![]`
- `src/bindings.ts` -- Auto-generated TypeScript bindings

All worktree operations are invoked through `commands.listWorktrees()`, `commands.createWorktree()`, `commands.deleteWorktree()` in the Zustand store slice. The store slice remains in core. Nothing in the Rust layer knows about extensions.

### 6.2 Data Flow (Unchanged)

```
Extension UI component
  -> useGitOpsStore() (Zustand)
  -> commands.listWorktrees() (auto-generated binding)
  -> TAURI_INVOKE("list_worktrees")
  -> Rust list_worktrees command
  -> git2::Repository worktree operations
```

The extension only contributes the UI layer. The data layer (store slice + Tauri commands) stays in core.

---

## 7. Tailwind v4 / Catppuccin Styling

### 7.1 How Extension Panels Inherit Theme

Extension-contributed sidebar panels are rendered inside `RepositoryView.tsx`'s `DynamicSidebarPanels` component. They are regular React components in the same document, so they have full access to:

- **Catppuccin CSS variables**: All `--ctp-*` tokens from the `@theme {}` block
- **Tailwind v4 utilities**: `text-ctp-text`, `bg-ctp-surface0`, `border-ctp-surface1`, etc.
- **Custom animations**: `animate-*` classes registered in the theme block

### 7.2 Existing Worktree Styles to Preserve

All worktree components already use Catppuccin tokens exclusively:

| Component | Key classes |
|-----------|------------|
| `WorktreePanel` | `text-ctp-subtext0`, `text-ctp-red`, `divide-y divide-ctp-surface0` |
| `WorktreeItem` | `hover:bg-ctp-surface0/50`, `bg-ctp-surface0`, `text-ctp-green/yellow/red/overlay0`, `bg-ctp-surface1`, `hover:bg-ctp-red/20` |
| `CreateWorktreeDialog` | `text-ctp-subtext0`, `bg-ctp-surface0`, `border-ctp-surface1`, `focus:border-ctp-blue` |
| `DeleteWorktreeDialog` | `bg-ctp-yellow/10`, `border-ctp-yellow/30`, `text-ctp-yellow`, `text-ctp-red` |

### 7.3 No Style Isolation Needed

Since built-in extensions render in the main document (not in iframes or shadow DOM), they naturally inherit the global Tailwind/Catppuccin theme. No special style handling is required. Moving the components from `src/components/worktree/` to `src/extensions/worktrees/components/` requires zero CSS changes.

### 7.4 Accordion Wrapper Styling

The accordion header (`<summary>`) styling is provided by `DynamicSidebarPanels` in RepositoryView, not by the extension panel itself. The extension only provides:
- `icon` (rendered as `<panel.icon className="w-4 h-4" />`)
- `title` (rendered as `<span className="font-semibold text-sm flex-1">`)
- `renderAction()` (rendered after the title)
- `component` (rendered inside `<ExtensionPanelErrorBoundary>`)

This means the worktree panel will automatically get the same sticky header, backdrop blur, and border styling as core panels.

---

## 8. Implementation Risks and Edge Cases

### 8.1 Dialog Communication Pattern

**Risk**: The current CreateWorktreeDialog is triggered by a `useState` in RepositoryView. After extraction, the panel needs to open the dialog from both:
- The "+" button in the accordion header (`renderAction`)
- The command palette command

**Mitigation**: Use `CustomEvent` dispatch on `document`, matching the existing pattern used for `"create-branch-dialog"` (RepositoryView line 103). The WorktreePanel listens for `"worktree:open-create-dialog"` events.

### 8.2 Priority Ordering

**Risk**: The worktree panel currently renders at a fixed position (after Tags, before DynamicSidebarPanels). As an extension-contributed panel, it will render among other extension panels sorted by priority.

**Mitigation**: Set priority to 60 (below Gitflow at 65 but above typical extension panels at 50). The sidebar priority range for extensions is 1-69 (clamped by `ExtensionAPI.contributeSidebarPanel`). Core panels (Branches, Stash, Tags) are hardcoded and always render first -- extension panels render after them in the `DynamicSidebarPanels` area.

**Note**: This means the worktree panel will move from being between Tags and Gitflow to being in the DynamicSidebarPanels section. The visual position change is acceptable since:
1. Both Gitflow and Worktrees will be in the dynamic section
2. Priority ordering ensures consistent relative positioning

### 8.3 Re-activation State

**Risk**: After disable/re-enable, the worktree panel needs to correctly reload data.

**Mitigation**: The `WorktreePanel` component calls `loadWorktrees()` in a `useEffect` on mount. When the extension is re-activated, the component remounts and data is refreshed. The underlying store data may still be populated from before (Zustand state persists), which is fine -- the `useEffect` refresh ensures it's current.

### 8.4 Error Boundary Wrapping

**Benefit**: Extension panels already get wrapped in `ExtensionPanelErrorBoundary` by `DynamicSidebarPanels`. If the WorktreePanel throws, it shows "Panel error: ..." instead of crashing the app.

### 8.5 Disabled Extension Persistence

The `ExtensionHost` persists disabled extension IDs to `tauri-plugin-store`. If a user disables the worktree extension, it stays disabled across app restarts. The `activateAll()` method checks the disabled list before activating.

### 8.6 Test Migration

The worktree component tests (if any exist in `src/components/worktree/`) need to move. The extension test should follow the `gitflow.test.ts` pattern:

```typescript
describe("worktrees extension", () => {
  it("registers worktree-panel sidebar panel on activation", async () => {
    await onActivate(api);
    const panels = useSidebarPanelRegistry.getState().panels;
    expect(panels.has("ext:worktrees:worktree-panel")).toBe(true);
  });

  it("unregisters all registrations on cleanup", async () => {
    await onActivate(api);
    api.cleanup();
    expect(useSidebarPanelRegistry.getState().panels.has("ext:worktrees:worktree-panel")).toBe(false);
  });
});
```

### 8.7 Badge API Gap (Non-Blocking)

The `ExtensionSidebarPanelConfig` interface in `ExtensionAPI.ts` does not currently expose `badge`. The underlying `SidebarPanelConfig` in the registry supports it. If we want a worktree count badge, we would need to either:
1. Add `badge` to `ExtensionSidebarPanelConfig` (small API addition)
2. Skip the badge for now (simpler, badge is optional)

Recommendation: Add the `badge` property to `ExtensionSidebarPanelConfig` in this phase since it's a one-line addition and useful for other extensions too.

### 8.8 `FolderGit2` Import in RepositoryView

After removing the worktree section, check whether `FolderGit2` is still imported by anything else in RepositoryView. If not, remove it from the import statement. Same check for `Plus` -- it's still used by Branches, Stash, and Tags sections.

### 8.9 No Toolbar Action for Worktrees (Yet)

The current implementation has no toolbar button for worktrees. The extension can optionally add one via `api.contributeToolbar()`. This is not required for Phase 44 but is a natural follow-up.

---

## 9. Summary: Minimal Change Set

| # | Action | File(s) | Complexity |
|---|--------|---------|------------|
| 1 | Create extension entry point | `src/extensions/worktrees/index.ts` | Medium |
| 2 | Move and adapt WorktreePanel | `src/extensions/worktrees/components/WorktreePanel.tsx` | Medium |
| 3 | Move WorktreeItem (no changes) | `src/extensions/worktrees/components/WorktreeItem.tsx` | Low |
| 4 | Move CreateWorktreeDialog (no changes) | `src/extensions/worktrees/components/CreateWorktreeDialog.tsx` | Low |
| 5 | Move DeleteWorktreeDialog (no changes) | `src/extensions/worktrees/components/DeleteWorktreeDialog.tsx` | Low |
| 6 | Create barrel export | `src/extensions/worktrees/components/index.ts` | Low |
| 7 | Remove hardcoded worktree from RepositoryView | `src/components/RepositoryView.tsx` | Medium |
| 8 | Register built-in extension | `src/App.tsx` | Low |
| 9 | Delete old component directory | `src/components/worktree/` | Low |
| 10 | Add extension tests | `src/extensions/__tests__/worktrees.test.ts` | Medium |
| 11 | (Optional) Add `badge` to ExtensionSidebarPanelConfig | `src/extensions/ExtensionAPI.ts` | Low |

**Total new/moved files**: 6 (extension) + 1 (test)
**Total modified files**: 2 (RepositoryView.tsx, App.tsx) + optional 1 (ExtensionAPI.ts)
**Total deleted files**: 5 (old worktree component directory)
**Rust changes**: 0
**Store changes**: 0
