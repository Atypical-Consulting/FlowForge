---
phase: 14-ui-polish
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/ui/button.tsx
  - src/components/Header.tsx
  - src/components/sync/SyncButtons.tsx
  - src/components/stash/StashItem.tsx
  - src/components/tags/TagItem.tsx
  - src/components/branches/BranchItem.tsx
  - src/components/navigation/BranchSwitcher.tsx
  - src/components/commit/CommitForm.tsx
autonomous: true

must_haves:
  truths:
    - "Button component accepts loading and loadingText props"
    - "Loading buttons show spinner icon, become disabled, and optionally change text"
    - "StashItem Apply/Pop/Drop buttons show individual loading spinners during operations"
    - "TagItem Delete button shows loading spinner during operation"
    - "BranchItem Checkout/Merge/Delete buttons show individual loading spinners"
    - "Settings, Open, Fetch, Pull, Push, Amend buttons show keyboard shortcut tooltips"
    - "Shortcut tooltips display OS-appropriate styled key badges after 500ms hover delay"
    - "Dirty state indicator dot on BranchSwitcher has gentle glow pulse animation"
  artifacts:
    - path: "src/components/ui/button.tsx"
      provides: "Enhanced Button with loading/loadingText props"
      exports: ["Button", "ButtonProps", "buttonVariants"]
    - path: "src/components/sync/SyncButtons.tsx"
      provides: "Sync buttons wrapped in ShortcutTooltip"
      contains: "ShortcutTooltip"
    - path: "src/components/Header.tsx"
      provides: "Settings and Open buttons wrapped in ShortcutTooltip"
      contains: "ShortcutTooltip"
    - path: "src/components/navigation/BranchSwitcher.tsx"
      provides: "Dirty indicator with pulse animation class"
      contains: "animate-dirty-pulse"
  key_links:
    - from: "src/components/ui/button.tsx"
      to: "lucide-react"
      via: "Loader2 import for spinner"
      pattern: "Loader2"
    - from: "src/components/sync/SyncButtons.tsx"
      to: "src/components/ui/ShortcutTooltip.tsx"
      via: "ShortcutTooltip wrapping buttons"
      pattern: "import.*ShortcutTooltip"
    - from: "src/components/Header.tsx"
      to: "src/components/ui/ShortcutTooltip.tsx"
      via: "ShortcutTooltip wrapping Settings/Open buttons"
      pattern: "import.*ShortcutTooltip"
---

<objective>
Extend Button with loading states, wrap keyboard-shortcut buttons with tooltip key badges, add per-operation loading to sidebar item action buttons, and apply dirty pulse animation to the branch indicator.

Purpose: Buttons that trigger async operations should provide clear loading feedback (UI-06). Keyboard shortcuts should be discoverable via styled tooltips (UI-07). The dirty state indicator should draw subtle attention with a glow pulse (UI-09).
Output: Enhanced Button component, loading states on sidebar action buttons, ShortcutTooltip on 6 keyboard-shortcut buttons, pulse animation on dirty indicator dot.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-ui-polish/14-CONTEXT.md
@.planning/phases/14-ui-polish/14-RESEARCH.md
@src/components/ui/button.tsx
@src/components/ui/ShortcutTooltip.tsx
@src/components/Header.tsx
@src/components/sync/SyncButtons.tsx
@src/components/stash/StashItem.tsx
@src/components/tags/TagItem.tsx
@src/components/branches/BranchItem.tsx
@src/components/navigation/BranchSwitcher.tsx
@src/components/commit/CommitForm.tsx
@src/hooks/useKeyboardShortcuts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Button with loading props and add loading states to sidebar items</name>
  <files>
    src/components/ui/button.tsx
    src/components/stash/StashItem.tsx
    src/components/tags/TagItem.tsx
    src/components/branches/BranchItem.tsx
  </files>
  <action>
**button.tsx** -- Add loading/loadingText props to the Button component:

Add import: `import { Loader2 } from "lucide-react";`

Update ButtonProps interface to include optional loading props:
```tsx
export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  loading?: boolean;
  loadingText?: string;
}
```

Update the Button forwardRef component to destructure and handle loading:
```tsx
const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, loading, loadingText, children, disabled, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        disabled={disabled || loading}
        {...props}
      >
        {loading ? (
          <>
            <Loader2 className="w-4 h-4 animate-spin shrink-0" />
            {loadingText && <span className="ml-2">{loadingText}</span>}
          </>
        ) : (
          children
        )}
      </button>
    );
  },
);
```

When `loading` is true: button is auto-disabled, shows Loader2 spinner, optionally shows loadingText. When false: renders children normally. This is backward-compatible -- existing Button usage is unaffected.

**StashItem.tsx** -- Add per-action loading states for Apply, Pop, Drop:

Add imports: `import { useState } from "react";` and `import { Loader2 } from "lucide-react";`

Update callback prop types to support async:
```tsx
interface StashItemProps {
  stash: StashEntry;
  onApply: () => Promise<void> | void;
  onPop: () => Promise<void> | void;
  onDrop: () => Promise<void> | void;
  disabled?: boolean;
}
```

Add loading state tracking inside the component:
```tsx
const [loadingAction, setLoadingAction] = useState<"apply" | "pop" | "drop" | null>(null);
const isAnyLoading = loadingAction !== null;

const handleAction = async (action: "apply" | "pop" | "drop", fn: () => Promise<void> | void) => {
  setLoadingAction(action);
  try { await fn(); } finally { setLoadingAction(null); }
};
```

Update each button to use handleAction and show spinner:
- Apply button: `onClick={() => handleAction("apply", onApply)}`, `disabled={disabled || isAnyLoading}`, icon becomes `{loadingAction === "apply" ? <Loader2 className="w-3.5 h-3.5 animate-spin" /> : <Download className="w-3.5 h-3.5" />}`
- Pop button: same pattern with `"pop"` and its current icon
- Drop button: same pattern with `"drop"` and `Trash2` icon

All three buttons disabled when any action is in progress to prevent concurrent operations.

**TagItem.tsx** -- Add loading state for Delete:

Add imports: `import { useState } from "react";` and `import { Loader2 } from "lucide-react";`

Update onDelete type: `onDelete: () => Promise<void> | void;`

Add loading state:
```tsx
const [isDeleting, setIsDeleting] = useState(false);

const handleDelete = async () => {
  setIsDeleting(true);
  try { await onDelete(); } finally { setIsDeleting(false); }
};
```

Update the delete button: `onClick={handleDelete}`, `disabled={disabled || isDeleting}`, icon becomes `{isDeleting ? <Loader2 className="w-3.5 h-3.5 animate-spin" /> : <Trash2 className="w-3.5 h-3.5" />}`

**BranchItem.tsx** -- Add per-action loading states for Checkout, Merge, Delete:

Add imports: `import { useState } from "react";` and `import { Loader2 } from "lucide-react";`

Update callback prop types:
```tsx
onCheckout: () => Promise<void> | void;
onDelete: () => Promise<void> | void;
onMerge: () => Promise<void> | void;
```

Add loading state tracking (same pattern as StashItem):
```tsx
const [loadingAction, setLoadingAction] = useState<"checkout" | "merge" | "delete" | null>(null);
const isAnyLoading = loadingAction !== null;

const handleAction = async (action: typeof loadingAction, fn: () => Promise<void> | void) => {
  if (!action) return;
  setLoadingAction(action);
  try { await fn(); } finally { setLoadingAction(null); }
};
```

Update each button:
- Checkout: `onClick={() => handleAction("checkout", onCheckout)}`, show `Loader2` when `loadingAction === "checkout"` instead of the normal icon
- Merge: `onClick={() => handleAction("merge", onMerge)}`, show `Loader2` when `loadingAction === "merge"` instead of the normal icon
- Delete: `onClick={() => handleAction("delete", onDelete)}`, show `Loader2` when `loadingAction === "delete"` instead of the normal icon
- All three disabled when `disabled || isAnyLoading`
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify Button accepts `loading` and `loadingText` props. Verify StashItem, TagItem, BranchItem all import useState and Loader2, and have action-specific loading states.
  </verify>
  <done>
Button component supports loading/loadingText props (backward-compatible). StashItem shows per-action spinners for Apply/Pop/Drop. TagItem shows spinner for Delete. BranchItem shows per-action spinners for Checkout/Merge/Delete. All buttons auto-disable during loading.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply ShortcutTooltip to header/sync buttons and dirty pulse to BranchSwitcher</name>
  <files>
    src/components/Header.tsx
    src/components/sync/SyncButtons.tsx
    src/components/navigation/BranchSwitcher.tsx
    src/components/commit/CommitForm.tsx
  </files>
  <action>
**SyncButtons.tsx** -- Wrap Fetch, Pull, Push buttons with ShortcutTooltip:

Add import: `import { ShortcutTooltip } from "../ui/ShortcutTooltip";`

Wrap each of the three buttons in ShortcutTooltip, removing the `title` prop from each Button:

Fetch button:
```tsx
<ShortcutTooltip shortcut="mod+shift+F" label="Fetch">
  <Button variant="ghost" size="sm" onClick={() => fetchMutation.mutate()} disabled={isLoading}>
    {fetchMutation.isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <CloudDownload className="w-4 h-4" />}
  </Button>
</ShortcutTooltip>
```

Pull button: same pattern with shortcut "mod+shift+L" and label "Pull".
Push button: same pattern with shortcut "mod+shift+P" and label "Push".

**Header.tsx** -- Wrap Settings and Open buttons with ShortcutTooltip:

Add import: `import { ShortcutTooltip } from "./ui/ShortcutTooltip";`

Settings button:
```tsx
<ShortcutTooltip shortcut="mod+," label="Settings">
  <Button variant="ghost" size="sm" onClick={openSettings}>
    <Settings className="w-4 h-4" />
  </Button>
</ShortcutTooltip>
```
Remove the `title` prop from the Button.

Open button:
```tsx
<ShortcutTooltip shortcut="mod+o" label="Open Repository">
  <Button variant="ghost" size="sm" onClick={handleOpenRepo} disabled={isLoading} className="text-ctp-subtext1 hover:text-ctp-text">
    <FolderOpen className="w-4 h-4 mr-2" />
    Open
  </Button>
</ShortcutTooltip>
```
Remove the `title` prop from the Button.

**CommitForm.tsx** -- Wrap Amend checkbox with ShortcutTooltip:

Add import: `import { ShortcutTooltip } from "../ui/ShortcutTooltip";`

Wrap the amend label:
```tsx
<ShortcutTooltip shortcut="mod+shift+M" label="Toggle Amend" side="top">
  <label className="flex items-center gap-1.5 text-ctp-overlay1 cursor-pointer">
    <input type="checkbox" checked={amend} onChange={(e) => handleAmendChange(e.target.checked)} className="rounded border-ctp-surface2" />
    <span className="text-xs">Amend last commit</span>
  </label>
</ShortcutTooltip>
```
Use `side="top"` because the commit form sits at the bottom of the screen.

**BranchSwitcher.tsx** -- Add dirty pulse animation to indicator dot:

Find the Circle element used as the dirty state indicator (line ~175):
```tsx
<Circle className="w-2 h-2 fill-ctp-yellow text-ctp-yellow shrink-0" />
```

Add the pulse animation class:
```tsx
<Circle className="w-2 h-2 fill-ctp-yellow text-ctp-yellow shrink-0 motion-safe:animate-dirty-pulse" />
```

The `motion-safe:` prefix ensures the animation respects the OS `prefers-reduced-motion` setting. The `animate-dirty-pulse` class references the CSS keyframe defined in Plan 01's index.css update, creating a gentle yellow glow pulse.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Run `npm run dev` and verify:
1. Hover over Settings button for 500ms -- tooltip appears with styled key badges showing the shortcut
2. Hover over Fetch/Pull/Push -- tooltips with key badges appear
3. Hover over Amend checkbox -- tooltip appears above with key badges
4. Open a repo with uncommitted changes -- yellow dot next to branch name gently pulses
5. Click a stash Apply button -- spinner replaces icon during operation
  </verify>
  <done>
6 buttons have ShortcutTooltip (Settings, Open, Fetch, Pull, Push, Amend toggle) with styled key badges and 500ms delay. StashItem/TagItem/BranchItem action buttons show per-operation loading spinners. BranchSwitcher dirty indicator dot has gentle glow pulse animation. All animations respect prefers-reduced-motion.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- Button component's `loading` prop shows Loader2 spinner and auto-disables
- Button component's `loadingText` prop displays text next to spinner
- 6 buttons have ShortcutTooltip: Settings (mod+,), Open (mod+o), Fetch (mod+shift+F), Pull (mod+shift+L), Push (mod+shift+P), Amend (mod+shift+M)
- Tooltips show OS-appropriate styled key badges with 500ms hover delay
- StashItem Apply/Pop/Drop show individual spinners during async operations
- TagItem Delete shows spinner during async operation
- BranchItem Checkout/Merge/Delete show individual spinners during async operations
- BranchSwitcher dirty dot pulses with gentle yellow glow
- Pulse stops when `prefers-reduced-motion: reduce` is set in OS
</verification>

<success_criteria>
- All async action buttons in sidebar items show loading feedback during operations
- Keyboard shortcut tooltips appear with VS Code-style key cap badges
- Tooltips auto-detect OS and show correct modifier keys
- Dirty state indicator pulses subtly without being distracting
- All new animations respect OS prefers-reduced-motion setting
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-polish/14-03-SUMMARY.md`
</output>
