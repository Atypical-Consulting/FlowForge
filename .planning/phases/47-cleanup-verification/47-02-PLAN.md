---
phase: 47-cleanup-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/__tests__/topology.test.ts
  - src/extensions/__tests__/worktrees.test.ts
  - src/extensions/__tests__/init-repo.test.ts
autonomous: true

must_haves:
  truths:
    - "Topology extension toggle test covers activation, blade registration with coreOverride, command registration, cleanup, and re-activation"
    - "Worktrees extension toggle test covers activation, sidebar panel registration, command registration, cleanup, and re-activation"
    - "Init-repo extension toggle test covers activation, blade registration with coreOverride, command registration, store cleanup on dispose, and re-activation"
  artifacts:
    - path: "src/extensions/__tests__/topology.test.ts"
      provides: "Toggle tests for topology extension lifecycle"
      contains: "onActivate"
    - path: "src/extensions/__tests__/worktrees.test.ts"
      provides: "Toggle tests for worktrees extension lifecycle"
      contains: "onActivate"
    - path: "src/extensions/__tests__/init-repo.test.ts"
      provides: "Toggle tests for init-repo extension lifecycle"
      contains: "onActivate"
  key_links:
    - from: "src/extensions/__tests__/topology.test.ts"
      to: "src/extensions/topology/index.ts"
      via: "import onActivate, onDeactivate"
      pattern: 'from.*topology'
    - from: "src/extensions/__tests__/worktrees.test.ts"
      to: "src/extensions/worktrees/index.tsx"
      via: "import onActivate, onDeactivate"
      pattern: 'from.*worktrees'
    - from: "src/extensions/__tests__/init-repo.test.ts"
      to: "src/extensions/init-repo/index.ts"
      via: "import onActivate, onDeactivate"
      pattern: 'from.*init-repo'
---

<objective>
Create toggle tests for the 3 newly extracted extensions (topology, worktrees, init-repo) covering enable/disable lifecycle, registration, cleanup, and re-activation.

Purpose: Ensure no regressions when users toggle these extensions on/off via Extension Manager. This is the CLEAN-03 requirement.
Output: Three test files with comprehensive enable/disable cycle coverage.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/extensions/__tests__/gitflow.test.ts
@src/extensions/__tests__/github.test.ts
@src/extensions/__tests__/viewer-code.test.ts
@src/extensions/topology/index.ts
@src/extensions/worktrees/index.tsx
@src/extensions/init-repo/index.ts
@src/extensions/ExtensionAPI.ts
@src/core/lib/bladeRegistry.ts
@src/core/lib/commandRegistry.ts
@src/core/lib/sidebarPanelRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create topology extension toggle tests</name>
  <files>src/extensions/__tests__/topology.test.ts</files>
  <action>
Create `src/extensions/__tests__/topology.test.ts` following the gitflow.test.ts pattern but adapted for topology's specific registrations.

**Mocks required** (at top of file, before imports):
```typescript
// Mock @tauri-apps/api/event (listen returns an unlisten function)
vi.mock("@tauri-apps/api/event", () => ({
  listen: vi.fn(() => Promise.resolve(vi.fn())),
}));

// Mock @tauri-apps/plugin-store (used for settings/defaultTab)
vi.mock("@tauri-apps/plugin-store", () => ({
  Store: {
    load: vi.fn(() => Promise.resolve({
      get: vi.fn(() => Promise.resolve(null)),
    })),
  },
}));

// Mock navigation actor
vi.mock("../../core/machines/navigation/context", () => ({
  getNavigationActor: vi.fn(() => ({
    send: vi.fn(),
  })),
}));

// Mock git-ops store
vi.mock("../../core/stores/domain/git-ops", () => ({
  useGitOpsStore: {
    getState: () => ({
      repoStatus: null,
      nodes: [],
      loadGraph: vi.fn(),
    }),
  },
}));
```

**Test cases** (each test should call `api.cleanup()` in afterEach or at end):
1. `"registers topology-graph blade type on activation"` -- `getBladeRegistration("topology-graph")` is defined
2. `"registers blade type without ext: namespace (coreOverride)"` -- `getBladeRegistration("ext:topology:topology-graph")` is undefined
3. `"marks topology blade as lazy and singleton"` -- check `lazy: true`, `singleton: true`
4. `"tracks blade source as ext:topology for cleanup"` -- check `source === "ext:topology"`
5. `"registers show-topology command on activation"` -- `getCommandById("ext:topology:show-topology")` is defined
6. `"show-topology command has category Navigation"` -- check command category
7. `"unregisters all registrations on cleanup"` -- call `api.cleanup()`, then blade and command should be undefined/removed
8. `"re-activation after cleanup restores registrations"` -- cleanup, then `onActivate(api2)` with fresh API, verify blade re-registered
9. `"onDeactivate is a no-op (cleanup handled by ExtensionAPI)"` -- `expect(() => onDeactivate()).not.toThrow()`

Use `import { getBladeRegistration } from "../../core/lib/bladeRegistry"` and `import { getCommandById } from "../../core/lib/commandRegistry"`.
  </action>
  <verify>Run `npx vitest run src/extensions/__tests__/topology.test.ts --reporter=verbose` -- all 9 tests pass.</verify>
  <done>Topology toggle test file exists with 9+ tests covering registration, coreOverride namespace, cleanup, re-activation, and onDeactivate no-op.</done>
</task>

<task type="auto">
  <name>Task 2: Create worktrees and init-repo extension toggle tests</name>
  <files>
    src/extensions/__tests__/worktrees.test.ts
    src/extensions/__tests__/init-repo.test.ts
  </files>
  <action>
**worktrees.test.ts:**

Mocks required:
```typescript
// Mock git-ops store
vi.mock("../../core/stores/domain/git-ops", () => ({
  useGitOpsStore: {
    getState: () => ({
      repoStatus: null,
      worktreeList: [],
      loadWorktrees: vi.fn(),
    }),
  },
}));
```

Test cases:
1. `"registers worktree sidebar panel on activation"` -- `useSidebarPanelRegistry.getState().panels.has("ext:worktrees:worktree-panel")` is true
2. `"sidebar panel has priority 69 and defaultOpen false"` -- check panel properties
3. `"registers create-worktree command on activation"` -- `getCommandById("ext:worktrees:create-worktree")` is defined
4. `"registers refresh-worktrees command on activation"` -- `getCommandById("ext:worktrees:refresh-worktrees")` is defined
5. `"unregisters all registrations on cleanup"` -- panels and commands removed
6. `"re-activation after cleanup restores registrations"` -- cleanup, fresh API, verify panel and commands re-registered
7. `"onDeactivate is a no-op"` -- does not throw

Import `useSidebarPanelRegistry` from `"../../core/lib/sidebarPanelRegistry"` and `getCommandById` from `"../../core/lib/commandRegistry"`.

**init-repo.test.ts:**

Mocks required:
```typescript
// Mock bladeOpener
vi.mock("../../core/lib/bladeOpener", () => ({
  openBlade: vi.fn(),
}));

// Mock the init-repo store
vi.mock("../init-repo/store", () => ({
  useInitRepoStore: {
    getState: () => ({
      reset: vi.fn(),
    }),
  },
}));
```

Test cases:
1. `"registers init-repo blade type on activation"` -- `getBladeRegistration("init-repo")` is defined
2. `"registers blade type without ext: namespace (coreOverride)"` -- `getBladeRegistration("ext:init-repo:init-repo")` is undefined
3. `"marks blade as lazy and singleton"` -- check properties
4. `"tracks blade source as ext:init-repo for cleanup"` -- check `source`
5. `"registers init-repository command on activation"` -- `getCommandById("ext:init-repo:init-repository")` is defined
6. `"init-repository command has category Repository"` -- check command category
7. `"unregisters all registrations on cleanup"` -- blade and command removed
8. `"re-activation after cleanup restores registrations"` -- cleanup, fresh API, verify re-registered
9. `"onDeactivate is a no-op"` -- does not throw

Import `getBladeRegistration` from `"../../core/lib/bladeRegistry"` and `getCommandById` from `"../../core/lib/commandRegistry"`.
  </action>
  <verify>
Run `npx vitest run src/extensions/__tests__/worktrees.test.ts --reporter=verbose` -- all 7 tests pass.
Run `npx vitest run src/extensions/__tests__/init-repo.test.ts --reporter=verbose` -- all 9 tests pass.
  </verify>
  <done>Both test files exist with comprehensive toggle coverage. All tests pass. Combined with Task 1, this provides 25+ tests across 3 extensions.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/extensions/__tests__/topology.test.ts` -- all pass
2. `npx vitest run src/extensions/__tests__/worktrees.test.ts` -- all pass
3. `npx vitest run src/extensions/__tests__/init-repo.test.ts` -- all pass
4. `npx vitest run src/extensions/__tests__/` -- all existing + new tests pass (no regressions)
5. Each test file covers: activation, registration (blade/command/panel), coreOverride namespace, cleanup, re-activation, onDeactivate no-op
</verification>

<success_criteria>
- 3 new test files exist in src/extensions/__tests__/
- Total of 25+ new tests across the 3 files
- All tests pass with `npx vitest run`
- Tests cover enable, disable, and re-enable cycles
- No existing test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/47-cleanup-verification/47-02-SUMMARY.md`
</output>
