---
phase: 47-cleanup-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/blades/_discovery.ts
  - src/core/components/ui/ToggleSwitch.tsx
  - src/core/components/ui/PermissionBadge.tsx
  - src/core/blades/extension-manager/components/ExtensionCard.tsx
  - src/core/blades/extension-manager/components/InstallExtensionDialog.tsx
  - src/core/blades/extension-detail/ExtensionDetailBlade.tsx
  - src/extensions/github/components/ToggleSwitch.tsx
  - src/extensions/github/components/PermissionBadge.tsx
  - src/extensions/init-repo/components/index.ts
autonomous: true

must_haves:
  truths:
    - "_discovery.ts distinguishes between core blade types and extension-contributed blade types"
    - "No core/ file imports from any extensions/ directory for ToggleSwitch or PermissionBadge"
    - "No stale comments reference old file locations in init-repo extension"
  artifacts:
    - path: "src/core/blades/_discovery.ts"
      provides: "Split CORE_BLADE_TYPES and EXTENSION_BLADE_TYPES lists with extension-aware warning"
      contains: "CORE_BLADE_TYPES"
    - path: "src/core/components/ui/ToggleSwitch.tsx"
      provides: "ToggleSwitch component moved from github extension to core"
      exports: ["ToggleSwitch"]
    - path: "src/core/components/ui/PermissionBadge.tsx"
      provides: "PermissionBadge component moved from github extension to core"
      exports: ["PermissionBadge"]
  key_links:
    - from: "src/core/blades/extension-manager/components/ExtensionCard.tsx"
      to: "src/core/components/ui/ToggleSwitch.tsx"
      via: "import"
      pattern: 'from.*core/components/ui/ToggleSwitch'
    - from: "src/core/blades/extension-detail/ExtensionDetailBlade.tsx"
      to: "src/core/components/ui/ToggleSwitch.tsx"
      via: "import"
      pattern: 'from.*core/components/ui/ToggleSwitch'
---

<objective>
Clean up extraction scaffolding: split discovery types into CORE and EXTENSION lists, fix core->extension import violations (ToggleSwitch, PermissionBadge), and remove stale comments.

Purpose: Enforce the architectural boundary that core/ never imports from extensions/, and make blade discovery aware of which types come from core vs extensions.
Output: Clean _discovery.ts with split types, two UI components relocated to core, updated imports in 4 core files, stale comment removed.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/blades/_discovery.ts
@src/extensions/github/components/ToggleSwitch.tsx
@src/extensions/github/components/PermissionBadge.tsx
@src/core/blades/extension-manager/components/ExtensionCard.tsx
@src/core/blades/extension-manager/components/InstallExtensionDialog.tsx
@src/core/blades/extension-detail/ExtensionDetailBlade.tsx
@src/extensions/init-repo/components/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split _discovery.ts EXPECTED_TYPES into CORE and EXTENSION lists</name>
  <files>src/core/blades/_discovery.ts</files>
  <action>
In `src/core/blades/_discovery.ts`, replace the single `EXPECTED_TYPES` array with two arrays:

```typescript
const CORE_BLADE_TYPES: string[] = [
  "staging-changes", "commit-list-fallback", "commit-details", "diff",
  "branch-manager", "repo-browser", "settings",
  "extension-manager", "extension-detail",
];

const EXTENSION_BLADE_TYPES: string[] = [
  "topology-graph", "init-repo",
  "conventional-commit", "changelog",
  "gitflow-cheatsheet",
  "viewer-code", "viewer-markdown", "viewer-3d",
  "viewer-image", "viewer-nupkg", "viewer-plaintext",
  "welcome-screen",
];
```

Update the missing-types check:
- For `CORE_BLADE_TYPES`: keep the existing `console.warn` behavior (these must always be registered).
- For `EXTENSION_BLADE_TYPES`: use `console.debug` instead of `console.warn`, because these are only present when their extension is enabled. Change the message to: `"[BladeRegistry] Extension blade types not registered (extensions may be disabled): ${missing.join(", ")}"`.

Also update the warning message for core types from `"Create a registration.ts in src/blades/{blade-name}/"` to `"Check src/core/blades/{blade-name}/registration.ts"` since the path changed.
  </action>
  <verify>Run `npx vitest run --reporter=verbose 2>&1 | tail -30` to confirm no test regressions. Grep for "EXPECTED_TYPES" in _discovery.ts to confirm it no longer exists (replaced by CORE_ and EXTENSION_ variants).</verify>
  <done>_discovery.ts has CORE_BLADE_TYPES (9 items) and EXTENSION_BLADE_TYPES (12 items) with appropriate warning levels for each.</done>
</task>

<task type="auto">
  <name>Task 2: Move ToggleSwitch and PermissionBadge to core, fix imports, clean stale comment</name>
  <files>
    src/core/components/ui/ToggleSwitch.tsx
    src/core/components/ui/PermissionBadge.tsx
    src/extensions/github/components/ToggleSwitch.tsx
    src/extensions/github/components/PermissionBadge.tsx
    src/core/blades/extension-manager/components/ExtensionCard.tsx
    src/core/blades/extension-manager/components/InstallExtensionDialog.tsx
    src/core/blades/extension-detail/ExtensionDetailBlade.tsx
    src/extensions/init-repo/components/index.ts
  </files>
  <action>
1. **Copy** `src/extensions/github/components/ToggleSwitch.tsx` to `src/core/components/ui/ToggleSwitch.tsx`. Adjust the `cn` import from `"../../../core/lib/utils"` to `"../../lib/utils"` (since it's now in core/components/ui/).

2. **Copy** `src/extensions/github/components/PermissionBadge.tsx` to `src/core/components/ui/PermissionBadge.tsx`. Adjust the `cn` import from `"../../../core/lib/utils"` to `"../../lib/utils"`.

3. **Replace the originals** in `src/extensions/github/components/`:
   - `ToggleSwitch.tsx`: Replace with a re-export: `export { ToggleSwitch } from "../../../core/components/ui/ToggleSwitch";`
   - `PermissionBadge.tsx`: Replace with a re-export: `export { PermissionBadge } from "../../../core/components/ui/PermissionBadge";`
   This preserves backward compatibility if any extension (including github) still imports from the old path.

4. **Update core imports** (4 files):
   - `src/core/blades/extension-manager/components/ExtensionCard.tsx`: Change ToggleSwitch import to `from "../../../../core/components/ui/ToggleSwitch"` and PermissionBadge import to `from "../../../../core/components/ui/PermissionBadge"`. IMPORTANT: The relative path from this file to `src/core/components/ui/` is `"../../../components/ui/ToggleSwitch"` (3 levels up from extension-manager/components/ to core/, then down into components/ui/).
   - `src/core/blades/extension-manager/components/InstallExtensionDialog.tsx`: Change PermissionBadge import to `from "../../../components/ui/PermissionBadge"`.
   - `src/core/blades/extension-detail/ExtensionDetailBlade.tsx`: Change ToggleSwitch import to `from "../../components/ui/ToggleSwitch"` (2 levels up from extension-detail/ to core/, then down).

5. **Remove stale comment** in `src/extensions/init-repo/components/index.ts`: Delete the line `// InitRepoBlade moved to ../blades/InitRepoBlade.tsx`. If this is the ONLY line in the file and the file has no exports, delete the entire file. If it has real exports, just remove the stale comment line.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts' | head -20` to confirm no new TypeScript errors (ignore pre-existing TS2440 in bindings.ts).
Run `grep -rn "from.*extensions/github/components/" src/core/ --include="*.tsx" --include="*.ts"` to confirm ZERO results (no core->extension imports for ToggleSwitch/PermissionBadge).
  </verify>
  <done>ToggleSwitch and PermissionBadge live in src/core/components/ui/, all 4 core files import from core paths, github extension re-exports for backward compat, stale init-repo comment removed.</done>
</task>

</tasks>

<verification>
1. `grep -c "CORE_BLADE_TYPES" src/core/blades/_discovery.ts` returns 1+
2. `grep -c "EXTENSION_BLADE_TYPES" src/core/blades/_discovery.ts` returns 1+
3. `grep -c "EXPECTED_TYPES" src/core/blades/_discovery.ts` returns 0
4. `grep -rn "from.*extensions/github/components/" src/core/` returns ZERO matches
5. `cat src/core/components/ui/ToggleSwitch.tsx` file exists with ToggleSwitch export
6. `cat src/core/components/ui/PermissionBadge.tsx` file exists with PermissionBadge export
7. `grep "moved to" src/extensions/init-repo/components/index.ts` returns nothing or file does not exist
8. `npx vitest run` passes
</verification>

<success_criteria>
- _discovery.ts has split CORE_BLADE_TYPES and EXTENSION_BLADE_TYPES
- No core/ file imports ToggleSwitch or PermissionBadge from extensions/
- Both components exist at src/core/components/ui/ with correct exports
- No stale "moved to" comment in init-repo extension
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/47-cleanup-verification/47-01-SUMMARY.md`
</output>
