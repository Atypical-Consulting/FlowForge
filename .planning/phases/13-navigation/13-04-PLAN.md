---
phase: 13-navigation
plan: 04
type: execute
wave: 3
depends_on: ["13-02", "13-03"]
files_modified:
  - src/components/Header.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Header displays repo and branch as distinct pill/block elements on the left side"
    - "Switching repos opens the new repository and shows a toast notification"
    - "Switching branches with a dirty working tree prompts to stash changes"
    - "App remembers last active branch per repo and restores it when switching back"
    - "Only one panel can be open at a time (mutual exclusion)"
    - "Toast shows after branch switch for consistency"
  artifacts:
    - path: "src/components/Header.tsx"
      provides: "Redesigned header with RepoSwitcher and BranchSwitcher integration"
      contains: "RepoSwitcher"
    - path: "src/App.tsx"
      provides: "Navigation store initialization on app mount"
      contains: "initNavigation"
  key_links:
    - from: "src/components/Header.tsx"
      to: "src/components/navigation/RepoSwitcher.tsx"
      via: "Component composition"
      pattern: "RepoSwitcher"
    - from: "src/components/Header.tsx"
      to: "src/components/navigation/BranchSwitcher.tsx"
      via: "Component composition"
      pattern: "BranchSwitcher"
    - from: "src/components/Header.tsx"
      to: "src/stores/stash.ts"
      via: "Stash-and-switch flow"
      pattern: "saveStash"
    - from: "src/components/Header.tsx"
      to: "src/stores/toast.ts"
      via: "Toast notifications after switching"
      pattern: "toast\\.(success|info)"
---

<objective>
Integrate RepoSwitcher and BranchSwitcher into the Header, implement the repo/branch switching orchestration logic including stash-and-switch confirmation, toasts, and last-active-branch restoration. Initialize the navigation store on app mount.

Purpose: This plan wires everything together -- the switcher components from Plans 02/03, the navigation store, and the existing repository/branch/stash stores. It also handles the dirty working tree flow and persistence of the last active branch.

Output: A fully redesigned header with working repo and branch switching, stash confirmation dialog, toast notifications, and navigation store initialization.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-navigation/13-CONTEXT.md
@.planning/phases/13-navigation/13-RESEARCH.md
@.planning/phases/13-navigation/13-02-SUMMARY.md
@.planning/phases/13-navigation/13-03-SUMMARY.md

@src/components/Header.tsx
@src/App.tsx
@src/stores/repository.ts
@src/stores/branches.ts
@src/stores/stash.ts
@src/stores/navigation.ts
@src/stores/toast.ts
@src/hooks/useRecentRepos.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign Header with switcher integration and switching logic</name>
  <files>src/components/Header.tsx</files>
  <action>
  Redesign the Header component to integrate both switchers and implement the switching orchestration logic.

  **Layout changes:**
  Replace the current left side of the header:
  ```
  BEFORE: "FlowForge / repoName" + branch badge
  AFTER: "FlowForge" divider | RepoSwitcher pill | BranchSwitcher pill
  ```

  - Keep the `h-14 px-4 border-b border-ctp-surface0 bg-ctp-mantle/80 backdrop-blur-md select-none sticky top-0 z-50` classes
  - Left side: `flex items-center gap-2`
    - "FlowForge" text (keep as-is, `text-lg font-semibold text-ctp-text`)
    - Subtle vertical divider: `<div className="w-px h-6 bg-ctp-surface1" />`
    - `<RepoSwitcher onSelectRepo={handleRepoSwitch} />` (only when `status` exists)
    - `<BranchSwitcher onSelectBranch={handleBranchSwitch} />` (only when `status` exists)
  - Right side: keep all existing buttons (Settings, ThemeToggle, Undo, Refresh, SyncButtons, Changelog, Close, Clone, Open)

  **Remove from left side:**
  - The old `<span className="text-ctp-overlay0">/</span>` and `<span ... repoName>` display
  - The old branch badge `<div className="flex items-center gap-2 px-3 py-1 rounded-md bg-ctp-surface0">...</div>`
  - These are now handled by the switcher pills

  **Repo switching logic (`handleRepoSwitch`):**
  ```typescript
  const handleRepoSwitch = async (path: string) => {
    try {
      // Save current branch as last active for current repo
      if (status) {
        await navigationStore.setLastActiveBranch(status.repoPath, status.branchName);
      }

      // Open new repository (atomic -- replaces current state, no closeRepository first!)
      await openRepository(path);
      await addRecentRepo(path);

      // Check if there's a last active branch for this repo
      const lastBranch = navigationStore.getLastActiveBranch(path);
      if (lastBranch) {
        // Try to restore it, but don't fail if branch no longer exists
        try {
          await branchStore.checkoutBranch(lastBranch);
        } catch {
          // Branch may have been deleted -- that's fine, stay on current
        }
      }

      // Refresh all data for new repo
      await Promise.all([
        loadBranches(),
        loadStashes(),
        loadTags(),
        loadUndoInfo(),
      ]);

      // Get the repo name for the toast
      const repoName = path.split(/[/\\]/).filter(Boolean).pop() || path;
      toast.success(`Switched to ${repoName}`);
    } catch (e) {
      toast.error(`Failed to switch repository: ${e instanceof Error ? e.message : String(e)}`);
    }
  };
  ```

  **CRITICAL pitfall:** Do NOT call `closeRepository()` before `openRepository()`. The research explicitly warns about this causing a flash of WelcomeView. Call `openRepository(newPath)` directly -- it replaces the repo state atomically.

  **Branch switching logic (`handleBranchSwitch`):**
  ```typescript
  const handleBranchSwitch = async (branchName: string, isRemote: boolean) => {
    // Check for dirty working tree
    if (status?.isDirty) {
      setStashConfirmTarget({ branchName, isRemote });
      return; // Show stash confirmation dialog instead
    }

    await performBranchSwitch(branchName, isRemote);
  };

  const performBranchSwitch = async (branchName: string, isRemote: boolean) => {
    try {
      let success: boolean;
      if (isRemote) {
        success = await branchStore.checkoutRemoteBranch(branchName);
      } else {
        success = await branchStore.checkoutBranch(branchName);
      }

      if (success) {
        // Track in recent branches
        const localName = isRemote ? branchName.replace(/^[^/]+\//, "") : branchName;
        await navigationStore.addRecentBranch(status!.repoPath, localName);

        // Refresh status to update header
        await refreshStatus();

        toast.info(`Switched to ${localName}`);
      }
    } catch (e) {
      toast.error(`Failed to switch branch: ${e instanceof Error ? e.message : String(e)}`);
    }
  };
  ```

  **Stash-and-switch confirmation dialog:**
  Add a local state `stashConfirmTarget` (type: `{ branchName: string; isRemote: boolean } | null`).

  When `stashConfirmTarget` is set, render a simple confirmation dialog/overlay:
  ```
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div className="bg-ctp-base rounded-lg p-6 max-w-md shadow-xl border border-ctp-surface0">
      <h3 className="text-lg font-semibold text-ctp-text">Uncommitted Changes</h3>
      <p className="text-sm text-ctp-subtext0 mt-2">
        You have uncommitted changes. Would you like to stash them before switching?
      </p>
      <div className="flex justify-end gap-2 mt-4">
        <Button variant="ghost" onClick={() => setStashConfirmTarget(null)}>Cancel</Button>
        <Button onClick={handleStashAndSwitch}>Stash and Switch</Button>
      </div>
    </div>
  </div>
  ```

  `handleStashAndSwitch`:
  ```typescript
  const handleStashAndSwitch = async () => {
    if (!stashConfirmTarget) return;
    const { branchName, isRemote } = stashConfirmTarget;
    setStashConfirmTarget(null);

    const stashed = await stashStore.saveStash(
      `Auto-stash before switching to ${branchName}`,
      true // include untracked
    );

    if (stashed) {
      await performBranchSwitch(branchName, isRemote);
    } else {
      toast.error("Failed to stash changes");
    }
  };
  ```

  **Panel mutual exclusion:**
  The navigation store already handles this (toggleRepoDropdown closes branch, and vice versa). No extra work needed in Header.
  </action>
  <verify>
  Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | head -30` and confirm no type errors.
  </verify>
  <done>
  - Header shows RepoSwitcher and BranchSwitcher pills on the left side
  - Old repo name display and branch badge are removed
  - Repo switching works: opens new repo atomically, restores last branch, shows toast
  - Branch switching works: checkout local or remote, tracks recent, shows toast
  - Dirty working tree triggers stash-and-switch confirmation dialog
  - No flash of WelcomeView during repo switch
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize navigation store on app mount</name>
  <files>src/App.tsx</files>
  <action>
  Read `src/App.tsx` first to understand the current structure.

  Add navigation store initialization on app mount:

  1. Import `useNavigationStore` from `./stores/navigation`
  2. In the main App component (or at the top-level where other store initializations happen), call `initNavigation()` on mount:
     ```typescript
     const initNavigation = useNavigationStore((s) => s.initNavigation);

     useEffect(() => {
       initNavigation();
     }, [initNavigation]);
     ```

  This loads pinned repos, recent branches, and last active branches from Tauri Store on app startup.

  Place this alongside any existing initialization logic in the app. Do NOT create a new provider or wrapper -- just a useEffect in the existing component.
  </action>
  <verify>
  Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | head -30` and confirm no type errors in App.tsx.
  </verify>
  <done>
  - Navigation store loads persisted state (pinned repos, recent branches, last active branches) on app mount
  - No new providers or wrappers introduced
  - App.tsx has a clean useEffect for navigation init
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Header displays RepoSwitcher and BranchSwitcher pills when a repo is open
3. Repo switching calls `openRepository` directly (not close+open)
4. Branch switching checks dirty state and offers stash confirmation
5. Toast notifications fire after successful repo and branch switches
6. Navigation store initializes from Tauri Store on app mount
7. Last active branch is restored when switching back to a previously-opened repo
</verification>

<success_criteria>
- Header redesigned with switcher pills replacing old repo/branch display
- Repo switching is atomic (no close+open), restores last branch, shows toast
- Branch switching handles dirty tree with stash-and-switch dialog
- Navigation store initialized on app mount with persisted data
- All requirements NAV-01 through NAV-05 are functionally complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-navigation/13-04-SUMMARY.md`
</output>
