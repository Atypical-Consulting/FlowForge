---
phase: 13-navigation
plan: 03
type: execute
wave: 2
depends_on: ["13-01", "13-02"]
files_modified:
  - src/components/navigation/BranchSwitcher.tsx
  - src/components/navigation/BranchSwitcherItem.tsx
  - src/components/navigation/SwitcherSearch.tsx
  - src/stores/branches.ts
autonomous: true

must_haves:
  truths:
    - "Branch pill shows current branch name with GitBranch icon and dirty indicator"
    - "Clicking branch pill opens slide-down panel with search, recent branches, and full list"
    - "Search field filters branches as the user types (live filtering)"
    - "Toggle shows/hides remote branches in the list"
    - "Selecting a remote branch creates a local tracking branch"
  artifacts:
    - path: "src/components/navigation/BranchSwitcher.tsx"
      provides: "Branch switcher pill and slide-down dropdown panel"
      contains: "BranchSwitcher"
    - path: "src/components/navigation/BranchSwitcherItem.tsx"
      provides: "Individual branch entry in dropdown"
      contains: "BranchSwitcherItem"
    - path: "src/components/navigation/SwitcherSearch.tsx"
      provides: "Reusable search input for dropdowns"
      contains: "SwitcherSearch"
    - path: "src/stores/branches.ts"
      provides: "Extended branch store with loadAllBranches and checkoutRemoteBranch"
      contains: "loadAllBranches"
  key_links:
    - from: "src/components/navigation/BranchSwitcher.tsx"
      to: "src/stores/branches.ts"
      via: "useBranchStore hook"
      pattern: "useBranchStore"
    - from: "src/components/navigation/BranchSwitcher.tsx"
      to: "src/stores/navigation.ts"
      via: "useNavigationStore for recent branches"
      pattern: "useNavigationStore"
    - from: "src/stores/branches.ts"
      to: "src/bindings.ts"
      via: "commands.listAllBranches"
      pattern: "commands\\.listAllBranches"
---

<objective>
Build the BranchSwitcher component (pill button + slide-down panel) with search, recent branches section, full branch list, and remote branch toggle. Also extend the branch store to use the new backend commands from Plan 01.

Purpose: Users need to quickly find and switch branches. The branch switcher provides recent branches at the top, live search filtering, and optional remote branch visibility with one-click checkout that creates local tracking branches.

Output: A fully functional BranchSwitcher component with search, recent branches, local/remote toggle, and an extended branch store.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-navigation/13-CONTEXT.md
@.planning/phases/13-navigation/13-RESEARCH.md
@.planning/phases/13-navigation/13-01-SUMMARY.md
@.planning/phases/13-navigation/13-02-SUMMARY.md

@src/stores/branches.ts
@src/stores/navigation.ts
@src/bindings.ts
@src/components/staging/FileTreeSearch.tsx
@src/components/commit/ScopeAutocomplete.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend branch store with remote branch support</name>
  <files>src/stores/branches.ts</files>
  <action>
  Add two new actions to the existing `useBranchStore`:

  1. `loadAllBranches: (includeRemote: boolean) => Promise<void>`:
     - Calls `commands.listAllBranches(includeRemote)`
     - Sets `branches` state with the result (same as `loadBranches` but uses new command)
     - Handles errors the same way as `loadBranches`

  2. `checkoutRemoteBranch: (remoteBranch: string) => Promise<boolean>`:
     - Sets loading state
     - Calls `commands.checkoutRemoteBranch(remoteBranch)`
     - On success: calls `get().loadBranches()` to refresh, returns true
     - On error: sets error message, returns false

  Add these to the `BranchState` interface and the store implementation. Keep all existing actions unchanged.

  Also add a state field:
  - `allBranches: BranchInfo[]` -- stores the result of `loadAllBranches` (includes remote when toggled)

  This way `branches` stays as the local-only list (used elsewhere in the app), while `allBranches` is used by the BranchSwitcher for display. `loadAllBranches` sets `allBranches`.
  </action>
  <verify>
  Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | head -30` and confirm no type errors.
  </verify>
  <done>
  - `loadAllBranches(includeRemote)` action exists and calls `commands.listAllBranches`
  - `checkoutRemoteBranch(remoteBranch)` action exists and calls `commands.checkoutRemoteBranch`
  - `allBranches` state field stores the combined result
  - Existing `branches` and `loadBranches` are untouched
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SwitcherSearch and BranchSwitcher components</name>
  <files>src/components/navigation/SwitcherSearch.tsx, src/components/navigation/BranchSwitcher.tsx, src/components/navigation/BranchSwitcherItem.tsx</files>
  <action>
  **SwitcherSearch.tsx** -- Reusable search input for dropdown panels.

  Follow the FileTreeSearch.tsx pattern but simplified:
  ```typescript
  interface SwitcherSearchProps {
    value: string;
    onChange: (value: string) => void;
    placeholder?: string;
    inputRef?: React.RefObject<HTMLInputElement>;
  }
  ```
  - Search icon on left, X clear button on right (when value is non-empty)
  - Styling: `w-full pl-8 pr-8 py-2 text-sm bg-ctp-surface0 border-b border-ctp-surface1`
  - No rounded corners (sits at top of panel, flush edges)
  - Auto-focus when rendered (via inputRef or autoFocus)
  - Placeholder default: "Filter branches..."

  **BranchSwitcher.tsx** -- The branch pill button + slide-down panel.

  Structure:
  ```
  <div ref={containerRef} className="relative">
    {/* Pill trigger button */}
    <button>
      GitBranch icon + branchName + dirty indicator (Circle) + ChevronDown (hover)
    </button>

    {/* Slide-down panel */}
    <AnimatePresence>
      {isOpen && (
        <motion.div variants={slideDown} ...>
          {/* Search field */}
          <SwitcherSearch ... />

          {/* Remote toggle */}
          <div className="flex items-center justify-between px-3 py-1.5 border-b border-ctp-surface0">
            <span className="text-xs text-ctp-overlay0">Show remote branches</span>
            <toggle/checkbox for includeRemote>
          </div>

          {/* Recent branches section (only if no search query and recent branches exist) */}
          {!searchQuery && recentBranches.length > 0 && (
            <div>
              <div className="section header text-xs text-ctp-overlay0 px-3 py-1">Recent</div>
              {recentBranches.map(b => <BranchSwitcherItem ... />)}
              <div className="border-b border-ctp-surface0" />
            </div>
          )}

          {/* Full branch list (filtered by search) */}
          <div className="section header text-xs text-ctp-overlay0 px-3 py-1">
            {includeRemote ? "All branches" : "Local branches"}
          </div>
          {filteredBranches.map(b => <BranchSwitcherItem ... />)}

          {/* No results state */}
          {filteredBranches.length === 0 && (
            <div className="text-center text-sm text-ctp-overlay0 py-4">No branches match "{searchQuery}"</div>
          )}
        </motion.div>
      )}
    </AnimatePresence>
  </div>
  ```

  **Pill button:**
  - Same styling as RepoSwitcher pill (GitHub Desktop style, subtle until hovered)
  - `GitBranch` icon from lucide-react
  - Branch name in `font-mono text-sm font-medium`
  - Dirty indicator: `Circle` icon (w-2 h-2 fill-ctp-yellow text-ctp-yellow) if `status.isDirty`
  - ChevronDown: opacity-0 on default, visible on hover, rotate-180 when open

  **Panel:**
  - Same animation, z-index, and background as RepoSwitcher
  - `min-w-[320px] max-w-[400px] max-h-[450px] overflow-y-auto`

  **Data flow:**
  - On panel open: call `loadAllBranches(includeRemote)` to populate `allBranches`
  - `recentBranches` from `useNavigationStore().getRecentBranches(repoPath)`
  - Filter `allBranches` by search query (case-insensitive match on branch name)
  - Recent branches section: show the 3 most recent, only if they still exist in allBranches

  **Remote toggle:**
  - Simple toggle/checkbox with `includeRemote` local state (default false)
  - When toggled, call `loadAllBranches(newValue)` to refresh the list

  **Branch selection (onSelect prop):**
  Accept `onSelectBranch: (name: string, isRemote: boolean) => void` prop. The caller (Header integration, Plan 04) will handle stash-and-switch logic. Close panel after calling.

  **Click-outside + keyboard:**
  Same patterns as RepoSwitcher (click-outside with containerRef, Escape/Arrow/Enter keyboard nav).

  **BranchSwitcherItem.tsx:**

  Props: `{ branch: BranchInfo, isCurrent: boolean, isRecent: boolean, isHighlighted: boolean, onSelect: () => void }`

  Layout:
  ```
  <button className="w-full flex items-center gap-3 px-3 py-2 hover:bg-ctp-surface0 rounded transition-colors">
    <GitBranch className="w-4 h-4 text-ctp-subtext0 shrink-0" />
    <div className="flex-1 min-w-0 text-left">
      <span className="text-sm text-ctp-text truncate">{branch.name}</span>
      {branch.isRemote && (
        <span className="ml-1.5 text-xs text-ctp-overlay0 bg-ctp-surface1 px-1.5 py-0.5 rounded">remote</span>
      )}
    </div>
    <span className="text-xs text-ctp-overlay0 font-mono shrink-0">{branch.lastCommitOid}</span>
    {isCurrent && <Check className="w-4 h-4 text-ctp-green shrink-0" />}
  </button>
  ```

  - Remote branches get a small "remote" badge
  - Current branch gets a green Check icon
  - Show short commit OID on the right
  - Highlighted state: `bg-ctp-surface0`
  </action>
  <verify>
  Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | head -30` and confirm no type errors in navigation components.
  </verify>
  <done>
  - SwitcherSearch renders a search input with icon and clear button
  - BranchSwitcher renders a pill with branch name, dirty indicator, and slide-down panel
  - Panel has search field, remote toggle, recent branches section, and full filtered list
  - BranchSwitcherItem shows branch name, remote badge, commit OID, current indicator
  - Search filters branches live as user types
  - Remote toggle fetches remote branches when enabled
  - Click-outside and keyboard navigation work
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Branch store has `loadAllBranches` and `checkoutRemoteBranch` actions
3. BranchSwitcher renders pill and dropdown with search, recent, and full list sections
4. SwitcherSearch is reusable and works with live filtering
5. Remote toggle calls `loadAllBranches(true)` and shows remote branches
</verification>

<success_criteria>
- Branch store extended with remote branch support (new commands, allBranches state)
- BranchSwitcher component built with search, recent branches, local/remote toggle
- SwitcherSearch is a reusable search input used by the branch panel
- All components type-check cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-navigation/13-03-SUMMARY.md`
</output>
