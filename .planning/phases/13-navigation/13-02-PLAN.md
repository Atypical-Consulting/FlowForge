---
phase: 13-navigation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/navigation.ts
  - src/components/navigation/RepoSwitcher.tsx
  - src/components/navigation/RepoSwitcherItem.tsx
autonomous: true

must_haves:
  truths:
    - "Navigation store persists pinned repos and recent branches across app restarts"
    - "RepoSwitcher pill shows current repo name in the header"
    - "Clicking repo pill opens a slide-down panel with pinned repos at top and recent repos below"
    - "Selecting a repo from the panel switches to it"
    - "User can pin/unpin repos with a pin icon"
  artifacts:
    - path: "src/stores/navigation.ts"
      provides: "Zustand store for navigation state with Tauri Store persistence"
      contains: "useNavigationStore"
    - path: "src/components/navigation/RepoSwitcher.tsx"
      provides: "Repository switcher pill and slide-down dropdown panel"
      contains: "RepoSwitcher"
    - path: "src/components/navigation/RepoSwitcherItem.tsx"
      provides: "Individual repo item with pin toggle"
      contains: "RepoSwitcherItem"
  key_links:
    - from: "src/components/navigation/RepoSwitcher.tsx"
      to: "src/stores/navigation.ts"
      via: "useNavigationStore hook"
      pattern: "useNavigationStore"
    - from: "src/stores/navigation.ts"
      to: "src/lib/store.ts"
      via: "getStore() for Tauri Store persistence"
      pattern: "getStore"
---

<objective>
Create the navigation Zustand store with Tauri Store persistence for pinned repos, recent branches, and panel state. Build the RepoSwitcher component (pill button + slide-down panel).

Purpose: The navigation store is the shared data layer for both switchers. The RepoSwitcher lets users quickly switch between known repositories without leaving the main view.

Output: A fully functional RepoSwitcher component with persistent pinned/recent repos and a navigation store that will also serve the BranchSwitcher in Plan 03.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-navigation/13-CONTEXT.md
@.planning/phases/13-navigation/13-RESEARCH.md

@src/stores/repository.ts
@src/stores/toast.ts
@src/hooks/useRecentRepos.ts
@src/lib/store.ts
@src/components/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create navigation Zustand store with Tauri persistence</name>
  <files>src/stores/navigation.ts</files>
  <action>
  Create `src/stores/navigation.ts` as a Zustand store following the existing codebase pattern (direct Tauri Store API calls, NOT zustand persist middleware).

  **State shape:**
  ```typescript
  interface NavigationState {
    // Panel state (NOT persisted -- ephemeral UI state)
    repoDropdownOpen: boolean;
    branchDropdownOpen: boolean;

    // Persisted state
    pinnedRepoPaths: string[];              // paths of pinned repos
    recentBranchesPerRepo: Record<string, string[]>;  // repoPath -> last 3 branch names
    lastActiveBranchPerRepo: Record<string, string>;  // repoPath -> last checked out branch name

    // Actions -- panel
    toggleRepoDropdown: () => void;
    toggleBranchDropdown: () => void;
    closePanels: () => void;

    // Actions -- pinned repos
    pinRepo: (path: string) => Promise<void>;
    unpinRepo: (path: string) => Promise<void>;
    isPinned: (path: string) => boolean;

    // Actions -- recent branches
    addRecentBranch: (repoPath: string, branchName: string) => Promise<void>;
    getRecentBranches: (repoPath: string) => string[];

    // Actions -- last active branch
    setLastActiveBranch: (repoPath: string, branchName: string) => Promise<void>;
    getLastActiveBranch: (repoPath: string) => string | undefined;

    // Initialization
    initNavigation: () => Promise<void>;
  }
  ```

  **Persistence keys (Tauri Store):**
  - `"nav-pinned-repos"` -> string[]
  - `"nav-recent-branches"` -> Record<string, string[]>
  - `"nav-last-active-branch"` -> Record<string, string>

  **Key behaviors:**
  - `toggleRepoDropdown`: Opens repo dropdown, closes branch dropdown (mutual exclusion)
  - `toggleBranchDropdown`: Opens branch dropdown, closes repo dropdown
  - `closePanels`: Closes both dropdowns
  - `pinRepo`: Adds path to pinnedRepoPaths, saves to Tauri Store
  - `unpinRepo`: Removes path from pinnedRepoPaths, saves to Tauri Store
  - `isPinned`: Returns whether a path is in pinnedRepoPaths
  - `addRecentBranch`: Pushes branch to front of per-repo recent list, keeps max 3, saves to Tauri Store
  - `getRecentBranches`: Returns the 3 most recent branches for a given repo
  - `setLastActiveBranch`: Stores the last checked out branch for a repo, saves to Tauri Store
  - `initNavigation`: Loads all three persisted keys from Tauri Store and sets state

  **Persistence pattern** (follow `useRecentRepos.ts` and `settings.ts`):
  ```typescript
  const store = await getStore();
  await store.set("nav-pinned-repos", updatedPaths);
  await store.save();
  ```

  Import `getStore` from `"../lib/store"`. Import `create` from `"zustand"`.
  </action>
  <verify>
  Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | head -30` and confirm no type errors in `stores/navigation.ts`.
  </verify>
  <done>
  - `useNavigationStore` is exported from `src/stores/navigation.ts`
  - Store has panel toggle actions with mutual exclusion
  - Store has pinned repos CRUD with Tauri Store persistence
  - Store has recent branches tracking (max 3 per repo) with persistence
  - Store has last active branch per repo with persistence
  - `initNavigation()` loads all persisted state on app startup
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RepoSwitcher component with slide-down panel</name>
  <files>src/components/navigation/RepoSwitcher.tsx, src/components/navigation/RepoSwitcherItem.tsx</files>
  <action>
  Create `src/components/navigation/` directory and two files.

  **RepoSwitcher.tsx:**

  A pill-shaped button that shows the current repo name, with a slide-down dropdown panel.

  Structure:
  ```
  <div ref={containerRef} className="relative">
    {/* Pill trigger button */}
    <button> FolderGit icon + repoName + ChevronDown (visible on hover) </button>

    {/* Slide-down panel */}
    <AnimatePresence>
      {isOpen && (
        <motion.div variants={slideDown} ...>
          {/* Pinned repos section */}
          {pinnedRepos.length > 0 && (
            <div>
              <div className="section header">Pinned</div>
              {pinnedRepos.map(repo => <RepoSwitcherItem ... />)}
            </div>
          )}

          {/* Separator if both sections exist */}

          {/* Recent repos section */}
          {recentRepos.length > 0 && (
            <div>
              <div className="section header">Recent</div>
              {recentRepos.map(repo => <RepoSwitcherItem ... />)}
            </div>
          )}

          {/* Empty state if no repos */}
        </motion.div>
      )}
    </AnimatePresence>
  </div>
  ```

  **Pill button styling (LOCKED decisions):**
  - GitHub Desktop style: subtle, looks like a label until hovered
  - `group flex items-center gap-2 px-3 py-1.5 rounded-md transition-colors`
  - `hover:bg-ctp-surface0` and `isOpen && "bg-ctp-surface0"`
  - Use `FolderGit` icon from lucide-react (w-4 h-4 text-ctp-subtext0)
  - Chevron: `opacity-0 group-hover:opacity-100`, `rotate-180` when open
  - Show abbreviated path as sublabel (e.g., "~/repos/..." or first/last segments)

  **Slide-down animation** (framer-motion):
  ```typescript
  const slideDown = {
    hidden: { opacity: 0, height: 0, overflow: "hidden" },
    show: { opacity: 1, height: "auto", overflow: "hidden", transition: { duration: 0.2, ease: "easeOut" } },
    exit: { opacity: 0, height: 0, overflow: "hidden", transition: { duration: 0.15, ease: "easeIn" } },
  };
  ```

  **Panel styling:**
  - `absolute top-full left-0 z-40 mt-1 w-full min-w-[320px] max-w-[400px]`
  - `bg-ctp-mantle border border-ctp-surface0 rounded-lg shadow-lg`
  - `max-h-[400px] overflow-y-auto`

  **Data sources:**
  - `useNavigationStore` for pinnedRepoPaths, panel state, toggle
  - `useRecentRepos` hook for recent repos list (already exists, returns up to 10)
  - `useRepositoryStore` for current status (repoName, repoPath)
  - Filter: Remove current repo from the list. Show pinned at top (up to all), recent below (up to 5, excluding pinned ones).

  **Click-outside dismissal:**
  Use the same pattern from ScopeAutocomplete.tsx -- `useEffect` with `document.addEventListener("mousedown", handler)` that checks `containerRef.current?.contains(e.target)`.

  **Keyboard navigation:**
  - `Escape` closes the panel
  - `ArrowDown`/`ArrowUp` moves highlighted index
  - `Enter` selects highlighted item

  **Switching action (on item click):**
  The `onSelect` callback will be wired in Plan 04 (Header integration). For now, accept an `onSelectRepo: (path: string) => void` prop and call it when a repo item is clicked. Close the panel after calling.

  **RepoSwitcherItem.tsx:**

  A single row in the repo dropdown.

  Props: `{ repo: { path: string; name: string }, isPinned: boolean, isCurrent: boolean, isHighlighted: boolean, onSelect: () => void, onTogglePin: () => void }`

  Layout:
  ```
  <button className="w-full flex items-center gap-3 px-3 py-2 hover:bg-ctp-surface0 rounded transition-colors">
    <FolderGit className="w-4 h-4 text-ctp-subtext0 shrink-0" />
    <div className="flex-1 min-w-0 text-left">
      <div className="text-sm font-medium text-ctp-text truncate">{repo.name}</div>
      <div className="text-xs text-ctp-overlay0 truncate">{abbreviatedPath}</div>
    </div>
    {isCurrent && <Check className="w-4 h-4 text-ctp-green shrink-0" />}
    <button onClick={onTogglePin} className="...">
      <Pin className="w-3.5 h-3.5" filled={isPinned} />
    </button>
  </button>
  ```

  - Abbreviated path: show last 2 path segments (e.g., "~/repos/my-project" becomes "repos/my-project"), or use `~` substitution for home directory
  - Pin button: `Pin` icon from lucide-react, filled/highlighted when pinned, `onClick` stops propagation and toggles pin
  - Current repo indicator: green `Check` icon
  - Highlighted state: `bg-ctp-surface0` when navigated to via keyboard
  </action>
  <verify>
  Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | head -30` and confirm no type errors in the navigation directory.
  </verify>
  <done>
  - RepoSwitcher renders a pill button with repo name and slide-down panel
  - Panel shows pinned repos at top and recent repos below
  - RepoSwitcherItem shows repo name, abbreviated path, pin toggle, and current indicator
  - Click-outside closes the panel
  - Keyboard navigation (Escape, ArrowDown, ArrowUp, Enter) works
  - Animation uses framer-motion AnimatePresence with slide-down variant
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `src/stores/navigation.ts` exports `useNavigationStore` with all actions
3. `src/components/navigation/RepoSwitcher.tsx` renders pill button and animated dropdown
4. `src/components/navigation/RepoSwitcherItem.tsx` renders individual repo entries
5. Navigation store initializes from Tauri Store and persists changes
</verification>

<success_criteria>
- Navigation store created with Tauri Store persistence for pinned repos, recent branches, and last active branch
- RepoSwitcher component built with pill trigger, slide-down panel, pinned/recent sections
- RepoSwitcherItem shows repo name, path, pin toggle, current indicator
- Click-outside dismissal and keyboard navigation work
</success_criteria>

<output>
After completion, create `.planning/phases/13-navigation/13-02-SUMMARY.md`
</output>
