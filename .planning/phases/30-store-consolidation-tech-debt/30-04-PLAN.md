---
phase: 30-store-consolidation-tech-debt
plan: 04
type: execute
wave: 3
depends_on: ["30-03"]
files_modified:
  - src/stores/domain/ui-state/index.ts
  - src/stores/domain/ui-state/types.ts
  - src/stores/domain/ui-state/staging.slice.ts
  - src/stores/domain/ui-state/command-palette.slice.ts
  - src/stores/domain/preferences/index.ts
  - src/stores/domain/preferences/types.ts
  - src/stores/domain/preferences/settings.slice.ts
  - src/stores/domain/preferences/theme.slice.ts
  - src/stores/domain/preferences/navigation.slice.ts
  - src/stores/domain/preferences/branch-metadata.slice.ts
  - src/stores/domain/preferences/review-checklist.slice.ts
  - src/stores/staging.ts
  - src/stores/commandPalette.ts
  - src/stores/settings.ts
  - src/stores/theme.ts
  - src/stores/navigation.ts
  - src/stores/branchMetadata.ts
  - src/stores/reviewChecklist.ts
  - src/stores/conventional.ts
  - src/blades/changelog/store.ts
  - src/blades/init-repo/store.ts
  - src/stores/domain/git-ops/repository.slice.ts
  - src/stores/index.ts
autonomous: true

must_haves:
  truths:
    - "Developer finds UI state stores (staging, commandPalette) consolidated into useUIStore"
    - "Developer finds preferences stores (settings, theme, navigation, branchMetadata, reviewChecklist) consolidated into usePreferencesStore"
    - "Toast store remains standalone (infrastructure, no reset needed)"
    - "Blade-local stores (changelog, init-repo) use createBladeStore factory and auto-register for reset"
    - "Conventional store is moved to blade-local using createBladeStore"
    - "closeRepository() calls resetAllStores() to atomically reset all registered stores"
    - "Preferences store does NOT reset on closeRepository (survives repo switches)"
    - "All existing consumers still work via re-export shims"
    - "Store count reduced from 21 to approximately 5 domain stores"
  artifacts:
    - path: "src/stores/domain/ui-state/index.ts"
      provides: "Consolidated UI state store"
      exports: ["useUIStore"]
    - path: "src/stores/domain/preferences/index.ts"
      provides: "Consolidated preferences store"
      exports: ["usePreferencesStore"]
    - path: "src/stores/index.ts"
      provides: "Barrel re-export of all domain stores and utilities"
      exports: ["useGitOpsStore", "useUIStore", "usePreferencesStore", "resetAllStores"]
  key_links:
    - from: "src/stores/domain/git-ops/repository.slice.ts"
      to: "src/stores/registry.ts"
      via: "closeRepository calls resetAllStores()"
      pattern: "resetAllStores"
    - from: "src/stores/domain/ui-state/index.ts"
      to: "src/stores/registry.ts"
      via: "registerStoreForReset(useUIStore)"
      pattern: "registerStoreForReset"
    - from: "src/stores/domain/preferences/index.ts"
      to: "NOT registered for reset"
      via: "Preferences survive repo switches"
      pattern: "no registerStoreForReset call"
---

<objective>
Complete store consolidation by creating the UI State and Preferences domain stores, migrating blade-local stores to createBladeStore factory, wiring closeRepository to the reset registry, and creating the store barrel export.

Purpose: Finalize ARCH-05 (store consolidation from 21 to ~5) and ARCH-07 (full reset integration). This plan also establishes the extensibility pattern: any new blade or domain store uses the factory/registry infrastructure.
Output: All stores consolidated into domain groups. closeRepository() atomically resets all repo-scoped state. Barrel export at src/stores/index.ts.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-store-consolidation-tech-debt/30-RESEARCH-ARCHITECTURE.md
@.planning/phases/30-store-consolidation-tech-debt/30-03-SUMMARY.md
@src/stores/staging.ts
@src/stores/commandPalette.ts
@src/stores/settings.ts
@src/stores/theme.ts
@src/stores/navigation.ts
@src/stores/branchMetadata.ts
@src/stores/reviewChecklist.ts
@src/stores/conventional.ts
@src/stores/toast.ts
@src/stores/registry.ts
@src/stores/createBladeStore.ts
@src/stores/domain/git-ops/index.ts
@src/blades/changelog/store.ts
@src/blades/init-repo/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UI State and Preferences domain stores with re-export shims</name>
  <files>
    src/stores/domain/ui-state/index.ts
    src/stores/domain/ui-state/types.ts
    src/stores/domain/ui-state/staging.slice.ts
    src/stores/domain/ui-state/command-palette.slice.ts
    src/stores/domain/preferences/index.ts
    src/stores/domain/preferences/types.ts
    src/stores/domain/preferences/settings.slice.ts
    src/stores/domain/preferences/theme.slice.ts
    src/stores/domain/preferences/navigation.slice.ts
    src/stores/domain/preferences/branch-metadata.slice.ts
    src/stores/domain/preferences/review-checklist.slice.ts
    src/stores/staging.ts
    src/stores/commandPalette.ts
    src/stores/settings.ts
    src/stores/theme.ts
    src/stores/navigation.ts
    src/stores/branchMetadata.ts
    src/stores/reviewChecklist.ts
  </files>
  <action>
    **UI State Store (`useUIStore`) -- 2 slices:**

    The UI State store consolidates ephemeral UI state that resets on repo close. These slices are small enough that naming collisions are minimal -- still use prefixes for consistency.

    1. Create `src/stores/domain/ui-state/types.ts` with `UIStateMiddleware` type alias and `UIStore` union type
    2. Create `src/stores/domain/ui-state/staging.slice.ts`:
       - Migrate from `src/stores/staging.ts`
       - State: `stagingSelectedFile`, `stagingViewMode`, `stagingScrollPosition` (prefix with `staging`)
       - No persistence, no Tauri commands
    3. Create `src/stores/domain/ui-state/command-palette.slice.ts`:
       - Migrate from `src/stores/commandPalette.ts`
       - State: `paletteIsOpen`, `paletteQuery`, `paletteSelectedIndex` (prefix with `palette`)
    4. Create `src/stores/domain/ui-state/index.ts`:
       - Compose with `create<UIStore>()(devtools(...))` pattern
       - Call `registerStoreForReset(useUIStore)` -- UI state MUST reset on close
    5. Convert `src/stores/staging.ts` and `src/stores/commandPalette.ts` to re-export shims

    **Preferences Store (`usePreferencesStore`) -- 5 slices:**

    The Preferences store consolidates user preferences that persist across repo switches. These all use Tauri `plugin-store` for disk persistence.

    1. Create `src/stores/domain/preferences/types.ts` with `PreferencesMiddleware` and `PreferencesStore` types
    2. Create each slice file:
       - `settings.slice.ts` -- from `src/stores/settings.ts`. Prefix: `settings*`. Keep `initSettings()`, `updateSetting()`.
       - `theme.slice.ts` -- from `src/stores/theme.ts`. Prefix: `theme*`. Keep `initTheme()`, `setTheme()`.
       - `navigation.slice.ts` -- from `src/stores/navigation.ts`. Prefix: `nav*`. Keep `initNavigation()`, pin/unpin/recent.
       - `branch-metadata.slice.ts` -- from `src/stores/branchMetadata.ts`. Prefix: `meta*`. Keep `initMetadata()`, pin/unpin/visit.
       - `review-checklist.slice.ts` -- from `src/stores/reviewChecklist.ts`. Prefix: `checklist*`. Keep `initChecklist()`.

    3. Create `src/stores/domain/preferences/index.ts`:
       - Compose with `create<PreferencesStore>()(devtools(...))` pattern
       - Do NOT call `registerStoreForReset()` -- preferences survive repo switches
       - Export a convenience `initAllPreferences()` function that calls each slice's init in sequence

    4. Convert all 5 original store files to re-export shims

    **IMPORTANT for Preferences:** Each slice's `init*()` method loads from Tauri plugin-store using `getStore()`. These calls are async and independent. The consolidated store should call them in the same order as the current app initialization. Verify that `getStore()` works correctly from within a slice creator (it should, since `getStore()` is a standalone utility in `src/lib/store.ts`).

    **Toast store stays standalone:**
    Do NOT consolidate `toast.ts`. It is infrastructure used by non-React code (command registry, XState machine). Keep it at `src/stores/toast.ts` exactly as-is. Do NOT register it for reset.
  </action>
  <verify>
    - `ls src/stores/domain/ui-state/*.ts` -- shows index.ts, types.ts, 2 slice files
    - `ls src/stores/domain/preferences/*.ts` -- shows index.ts, types.ts, 5 slice files
    - `npm run type-check` passes
    - `npm test` passes all existing tests
    - `grep "registerStoreForReset" src/stores/domain/ui-state/index.ts` -- UI store registered for reset
    - `grep -L "registerStoreForReset" src/stores/domain/preferences/index.ts` -- Preferences NOT registered (the grep -L should show the file)
    - `ls src/stores/toast.ts` -- still exists unchanged
  </verify>
  <done>UI State store consolidates staging + commandPalette. Preferences store consolidates settings + theme + navigation + branchMetadata + reviewChecklist. Both use slices pattern. UI resets on close, preferences do not. Toast remains standalone.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate blade stores to factory, wire closeRepository reset, and create barrel export</name>
  <files>
    src/stores/conventional.ts
    src/blades/changelog/store.ts
    src/blades/init-repo/store.ts
    src/stores/domain/git-ops/repository.slice.ts
    src/stores/index.ts
  </files>
  <action>
    **Migrate blade-local stores to createBladeStore factory:**

    1. Move `src/stores/conventional.ts` to `src/blades/conventional-commit/store.ts`:
       - Rewrite to use `createBladeStore("conventional-commit", (set, get) => ({ ... }))` from `../../stores/createBladeStore`
       - This auto-registers for global reset
       - Replace `src/stores/conventional.ts` with a re-export shim pointing to the blade directory
       - Check what types/constants from conventional.ts are used elsewhere (e.g., `COMMIT_TYPES`, `COMMIT_TYPE_LABELS`). If any are used outside the conventional-commit blade, keep them in a shared location or re-export from the shim.

    2. Update `src/blades/changelog/store.ts`:
       - Rewrite to use `createBladeStore("changelog", (set, get) => ({ ... }))`
       - This auto-registers for global reset
       - Currently it uses `create()` directly -- switch to the factory

    3. Update `src/blades/init-repo/store.ts`:
       - Rewrite to use `createBladeStore("init-repo", (set, get) => ({ ... }))`
       - This auto-registers for global reset

    **Wire closeRepository to resetAllStores:**

    4. In `src/stores/domain/git-ops/repository.slice.ts`, update the `closeRepository` action:
       ```typescript
       closeRepository: async () => {
         try {
           await commands.closeRepository();
         } catch (e) {
           console.error("Failed to close repository:", e);
           toast.error("Failed to close repository");
         }
         // Atomically reset all registered stores (gitOps, uiState, blade stores)
         resetAllStores();
         // Reset XState navigation FSM
         getNavigationActor().send({ type: "RESET_STACK" });
         // Note: repoStatus is now null via the resetAllStores call (initial state)
       },
       ```
       Import `resetAllStores` from `../../registry`, `getNavigationActor` from `../../../machines/navigation/context`, and `toast` from `../../../stores/toast`.

       CRITICAL: After this change, the `handleClose` in Header.tsx (from plan 30-02) should still work because `closeRepository()` now handles the RESET_STACK internally. Remove the duplicate RESET_STACK call from `handleClose` to avoid double-sending. Update Header.tsx's `handleClose` back to just `await closeRepository()` since the reset is now in the store.

    **Create barrel export:**

    5. Create `src/stores/index.ts`:
       ```typescript
       // Domain stores
       export { useGitOpsStore } from "./domain/git-ops";
       export type { GitOpsStore } from "./domain/git-ops";
       export { useUIStore } from "./domain/ui-state";
       export type { UIStore } from "./domain/ui-state";
       export { usePreferencesStore } from "./domain/preferences";
       export type { PreferencesStore } from "./domain/preferences";

       // Infrastructure (standalone)
       export { useToastStore, toast } from "./toast";
       export type { Toast, ToastType } from "./toast";

       // Store utilities
       export { resetAllStores, registerStoreForReset } from "./registry";
       export { createBladeStore } from "./createBladeStore";

       // Type definitions
       export type { BladeType, BladePropsMap, TypedBlade } from "./bladeTypes";
       ```

    6. Run the full test suite and type check to confirm everything works end-to-end.
  </action>
  <verify>
    - `grep "createBladeStore" src/blades/changelog/store.ts src/blades/init-repo/store.ts` -- both use factory
    - `grep "resetAllStores" src/stores/domain/git-ops/repository.slice.ts` -- closeRepository calls reset
    - `grep "RESET_STACK" src/stores/domain/git-ops/repository.slice.ts` -- closeRepository sends RESET_STACK
    - `ls src/stores/index.ts` -- barrel export exists
    - `npm run type-check` passes
    - `npm test` passes all existing tests
    - `npm run build` -- production build succeeds
  </verify>
  <done>
    Blade-local stores use createBladeStore factory (extensible pattern for future blades). closeRepository() atomically resets all registered stores + navigation FSM. Barrel export at src/stores/index.ts provides clean imports. Store consolidation complete: ~5 domain stores (GitOps, UIState, Preferences, Toast standalone) + blade-local stores.
  </done>
</task>

</tasks>

<verification>
1. **Store count:** `ls src/stores/domain/*/index.ts` shows 3 domain stores (git-ops, ui-state, preferences). Toast standalone. 3 blade-local stores use factory.
2. **Reset registry:** In a test or Node REPL, `resetAllStores()` resets gitOps, uiState, and blade stores but NOT preferences
3. **closeRepository integration:** `grep "resetAllStores" src/stores/domain/git-ops/repository.slice.ts` confirms wiring
4. **Factory usage:** `grep -r "createBladeStore" src/blades/` shows changelog, init-repo, conventional-commit all use it
5. **Barrel export:** `grep "useGitOpsStore\|useUIStore\|usePreferencesStore\|resetAllStores" src/stores/index.ts` confirms all exports
6. `npm test` -- all tests pass
7. `npm run build` -- production build succeeds
</verification>

<success_criteria>
- Store count reduced from 21 to ~5 domain stores (ARCH-05 complete)
- closeRepository() resets blade stack + all repo-scoped stores atomically (ARCH-07 fully integrated)
- Preferences survive repo switches (not registered for reset)
- createBladeStore factory provides extensible pattern for future blades
- All existing consumers work via re-export shims (zero breaking changes)
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/30-store-consolidation-tech-debt/30-04-SUMMARY.md`
</output>
