---
phase: 30-store-consolidation-tech-debt
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Header.tsx
  - src/blades/topology-graph/components/TopologyEmptyState.tsx
  - src/blades/topology-graph/components/TopologyPanel.tsx
  - src/commands/navigation.ts
  - src/stores/reviewChecklist.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Closing a repository resets the blade stack so no stale blades remain"
    - "Topology shows an illustrated empty state with CTA when repository has zero commits"
    - "Gitflow cheatsheet is accessible from the command palette search"
    - "Review store errors surface as user-facing toasts"
    - "Opening a repository respects the defaultTab setting"
  artifacts:
    - path: "src/blades/topology-graph/components/TopologyEmptyState.tsx"
      provides: "Empty state illustration component for topology"
      exports: ["TopologyEmptyState"]
    - path: "src/commands/navigation.ts"
      provides: "Gitflow cheatsheet command registration"
      contains: "open-gitflow-cheatsheet"
    - path: "src/stores/reviewChecklist.ts"
      provides: "Toast error surfacing for review store"
      contains: "toast.error"
  key_links:
    - from: "src/components/Header.tsx"
      to: "getNavigationActor"
      via: "RESET_STACK event on handleClose"
      pattern: "RESET_STACK"
    - from: "src/blades/topology-graph/components/TopologyPanel.tsx"
      to: "TopologyEmptyState"
      via: "conditional render when nodes.length === 0"
      pattern: "TopologyEmptyState"
    - from: "src/commands/navigation.ts"
      to: "openBlade"
      via: "command palette action for gitflow-cheatsheet"
      pattern: "gitflow-cheatsheet"
---

<objective>
Fix five targeted bugs and feature gaps: stale blade stack on close, topology empty state, command palette gitflow entry, review store toast errors, and defaultTab wiring.

Purpose: Resolve ARCH-07, ARCH-08, ARCH-09, ARCH-12, ARCH-13 as independently verifiable fixes before the risky store consolidation.
Output: Five UX-visible improvements that can each be tested in isolation.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-store-consolidation-tech-debt/30-RESEARCH-UX.md
@.planning/phases/30-store-consolidation-tech-debt/30-RESEARCH-IMPLEMENTATION.md
@src/components/Header.tsx
@src/blades/topology-graph/components/TopologyPanel.tsx
@src/stores/reviewChecklist.ts
@src/stores/settings.ts
@src/commands/navigation.ts
@src/App.tsx
@src/lib/bladeOpener.ts
@src/machines/navigation/context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix stale blade stack on close and wire defaultTab setting</name>
  <files>
    src/components/Header.tsx
    src/App.tsx
  </files>
  <action>
    **Fix ARCH-07: Stale blade stack on close**

    In `src/components/Header.tsx`, find the `handleClose` function (around line 97):
    ```typescript
    const handleClose = async () => {
      await closeRepository();
    };
    ```

    Add the RESET_STACK event after closeRepository:
    ```typescript
    const handleClose = async () => {
      await closeRepository();
      getNavigationActor().send({ type: "RESET_STACK" });
    };
    ```

    Ensure `getNavigationActor` is already imported (it should be -- check existing imports from `../machines/navigation/context`). If not, add the import.

    **Fix ARCH-08: Wire defaultTab setting**

    In `src/App.tsx`, locate the existing `useEffect` that runs on app startup (the one that calls `initSettings()` or similar initialization). After settings initialization completes, add logic to read the defaultTab setting and configure the navigation FSM:

    ```typescript
    // After initSettings() completes:
    const { settings } = useSettingsStore.getState();
    const defaultTab = settings.general.defaultTab;
    if (defaultTab === "topology" || defaultTab === "history") {
      getNavigationActor().send({ type: "SWITCH_PROCESS", process: "topology" });
    }
    // "changes" maps to "staging" which is already the default -- no action needed
    ```

    Import `useSettingsStore` and `getNavigationActor` if not already imported. The defaultTab check should only run once on app start, NOT on every repo open.

    IMPORTANT: Do NOT apply defaultTab on every render. Only apply it once during initialization, gated by a ref or by placing it inside the existing init useEffect.
  </action>
  <verify>
    - `grep "RESET_STACK" src/components/Header.tsx` shows the reset in handleClose
    - `grep "defaultTab" src/App.tsx` shows the setting is read and used
    - `npm run type-check` passes
  </verify>
  <done>Closing a repository resets the blade stack via RESET_STACK event. The defaultTab preference is read on app startup and the initial process is set accordingly.</done>
</task>

<task type="auto">
  <name>Task 2: Add topology empty state, command palette entry, and review store toasts</name>
  <files>
    src/blades/topology-graph/components/TopologyEmptyState.tsx
    src/blades/topology-graph/components/TopologyPanel.tsx
    src/commands/navigation.ts
    src/stores/reviewChecklist.ts
  </files>
  <action>
    **Fix ARCH-09: Topology empty state**

    1. Create `src/blades/topology-graph/components/TopologyEmptyState.tsx`:
       - Build a component that displays an inline SVG illustration (bare branch tree with empty circle nodes, using `currentColor` for Catppuccin theming)
       - Include heading "No commits yet" (`text-sm font-medium text-ctp-subtext1`)
       - Include description text (`text-xs text-ctp-overlay0`)
       - Include a "Go to Changes" CTA button that sends `SWITCH_PROCESS` event to the navigation actor with `process: "staging"`
       - Button styling: `bg-ctp-blue text-ctp-base rounded-md hover:bg-ctp-blue/90 focus-visible:ring-2 focus-visible:ring-ctp-blue`
       - SVG should be `aria-hidden="true"` (decorative)
       - Import `GitCommitHorizontal` from `lucide-react` for the button icon
       - Use `getNavigationActor` from `../../../machines/navigation/context`

    2. Update `src/blades/topology-graph/components/TopologyPanel.tsx`:
       - Replace the existing bare-text empty state block (lines 92-98 where `nodes.length === 0` renders `<p>No commits to display</p>`)
       - Import and render `<TopologyEmptyState />` instead
       - Ensure the empty state only shows when loading is complete AND nodes.length === 0 (not during initial load)

    **Fix ARCH-12: Command palette gitflow cheatsheet**

    3. In `src/commands/navigation.ts`, add a new command registration:
       ```typescript
       import { GitBranch } from "lucide-react";
       import { openBlade } from "../lib/bladeOpener";
       import { useRepositoryStore } from "../stores/repository";

       registerCommand({
         id: "open-gitflow-cheatsheet",
         title: "Gitflow Cheatsheet",
         description: "Open the Gitflow workflow guide",
         category: "Navigation",
         icon: GitBranch,
         keywords: ["gitflow", "workflow", "guide", "branching", "reference", "cheatsheet"],
         action: () => {
           openBlade("gitflow-cheatsheet", {} as Record<string, never>);
         },
         enabled: () => !!useRepositoryStore.getState().status,
       });
       ```
       Check if `registerCommand` is already imported at the top. Add the `openBlade`, `GitBranch`, and `useRepositoryStore` imports. Verify the `Command` interface supports `keywords` and `enabled` fields. If `keywords` is not in the interface, check `src/lib/commandRegistry.ts` and add it if needed.

    **Fix ARCH-13: Review store errors as toasts**

    4. In `src/stores/reviewChecklist.ts`:
       - Import `toast` from `./toast`
       - In `initChecklist` catch block (line 66): Add `toast.warning("Could not load review checklist. Using defaults.");` before the existing `console.error`
       - In `updateItems` catch block (line 85): Add `toast.error("Failed to save checklist changes");` before the existing `console.error`
       - In `resetToDefaults` catch block (line 98): Add `toast.error("Failed to reset checklist to defaults");` before the existing `console.error`
       - Keep the `console.error` calls for debugging -- add toast BEFORE them, not instead of them
  </action>
  <verify>
    - `ls src/blades/topology-graph/components/TopologyEmptyState.tsx` -- file exists
    - `grep "TopologyEmptyState" src/blades/topology-graph/components/TopologyPanel.tsx` -- component is used
    - `grep "gitflow-cheatsheet" src/commands/navigation.ts` -- command registered
    - `grep "toast.error\|toast.warning" src/stores/reviewChecklist.ts` -- toast calls present (should be 3)
    - `npm run type-check` passes
    - `npm test` passes
  </verify>
  <done>Topology shows illustrated empty state with "Go to Changes" CTA (ARCH-09). Gitflow cheatsheet searchable in command palette (ARCH-12). Review store errors surface as toasts (ARCH-13).</done>
</task>

</tasks>

<verification>
1. In Header.tsx, `handleClose` includes `RESET_STACK` event dispatch (ARCH-07)
2. In App.tsx, defaultTab setting is read and applied on startup (ARCH-08)
3. TopologyEmptyState.tsx exists with SVG illustration, heading, description, and CTA button (ARCH-09)
4. `grep "open-gitflow-cheatsheet" src/commands/navigation.ts` returns a match (ARCH-12)
5. `grep -c "toast\." src/stores/reviewChecklist.ts` returns 3 (ARCH-13)
6. `npm test` -- all tests pass
7. `npm run type-check` -- no TypeScript errors
</verification>

<success_criteria>
- Closing a repository sends RESET_STACK to clear the blade stack (ARCH-07)
- defaultTab setting is wired to the navigation FSM on app startup (ARCH-08)
- Topology shows an empty state illustration for repos with zero commits (ARCH-09)
- Gitflow cheatsheet is discoverable via command palette (ARCH-12)
- Review store persistence errors surface as user-facing toasts (ARCH-13)
</success_criteria>

<output>
After completion, create `.planning/phases/30-store-consolidation-tech-debt/30-02-SUMMARY.md`
</output>
