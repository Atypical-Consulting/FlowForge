---
phase: 30-store-consolidation-tech-debt
plan: 03
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - src/stores/registry.ts
  - src/stores/createBladeStore.ts
  - src/stores/domain/git-ops/index.ts
  - src/stores/domain/git-ops/types.ts
  - src/stores/domain/git-ops/repository.slice.ts
  - src/stores/domain/git-ops/branches.slice.ts
  - src/stores/domain/git-ops/tags.slice.ts
  - src/stores/domain/git-ops/stash.slice.ts
  - src/stores/domain/git-ops/worktrees.slice.ts
  - src/stores/domain/git-ops/gitflow.slice.ts
  - src/stores/domain/git-ops/undo.slice.ts
  - src/stores/domain/git-ops/topology.slice.ts
  - src/stores/domain/git-ops/clone.slice.ts
  - src/stores/repository.ts
  - src/stores/branches.ts
  - src/stores/tags.ts
  - src/stores/stash.ts
  - src/stores/worktrees.ts
  - src/stores/gitflow.ts
  - src/stores/topology.ts
  - src/stores/undo.ts
  - src/stores/clone.ts
autonomous: true

must_haves:
  truths:
    - "Developer finds all git operation stores (repository, branches, tags, stash, worktrees, gitflow, topology, undo, clone) consolidated into a single useGitOpsStore"
    - "Existing imports from src/stores/repository.ts, branches.ts, etc. still work via re-export shims"
    - "Gitflow slice can call branch reload and repo refresh via get() instead of cross-store getState()"
    - "All existing tests pass without modification to test files"
    - "Store registry exists with resetAllStores() and registerStoreForReset() functions"
    - "createBladeStore factory exists for blade-local stores with auto-reset registration"
  artifacts:
    - path: "src/stores/registry.ts"
      provides: "Store reset registry with resetAllStores and registerStoreForReset"
      exports: ["resetAllStores", "registerStoreForReset"]
    - path: "src/stores/createBladeStore.ts"
      provides: "Factory for blade-local stores with auto-reset"
      exports: ["createBladeStore"]
    - path: "src/stores/domain/git-ops/index.ts"
      provides: "Consolidated GitOps store composed from 9 slices"
      exports: ["useGitOpsStore", "GitOpsStore"]
    - path: "src/stores/domain/git-ops/types.ts"
      provides: "Type definitions for GitOps store and middleware"
      exports: ["GitOpsStore", "GitOpsMiddleware"]
    - path: "src/stores/domain/git-ops/repository.slice.ts"
      provides: "Repository slice with prefixed state keys"
      exports: ["createRepositorySlice", "RepositorySlice"]
    - path: "src/stores/domain/git-ops/branches.slice.ts"
      provides: "Branch slice with prefixed state keys"
      exports: ["createBranchSlice", "BranchSlice"]
  key_links:
    - from: "src/stores/domain/git-ops/index.ts"
      to: "src/stores/registry.ts"
      via: "registerStoreForReset(useGitOpsStore)"
      pattern: "registerStoreForReset"
    - from: "src/stores/repository.ts"
      to: "src/stores/domain/git-ops/index.ts"
      via: "Re-export shim for backward compatibility"
      pattern: "useGitOpsStore"
    - from: "src/stores/domain/git-ops/gitflow.slice.ts"
      to: "branches.slice + repository.slice"
      via: "get().loadBranches() and get().refreshRepoStatus()"
      pattern: "get\\(\\)\\.load"
---

<objective>
Create the store reset registry, blade store factory, and consolidate all 9 git operation stores into a single GitOps domain store using the Zustand slices pattern.

Purpose: Establish the foundation for store consolidation (ARCH-05) with the highest-value domain store (GitOps). This plan creates reusable infrastructure (registry, factory) that subsequent plans and future blades will use. The re-export shim strategy ensures zero breaking changes to existing consumers.
Output: Store registry, blade store factory, consolidated GitOps store with 9 slices, re-export shims for all 9 original store files.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-store-consolidation-tech-debt/30-RESEARCH-ARCHITECTURE.md
@.planning/phases/30-store-consolidation-tech-debt/30-RESEARCH-IMPLEMENTATION.md
@.planning/phases/30-store-consolidation-tech-debt/30-01-SUMMARY.md
@src/stores/repository.ts
@src/stores/branches.ts
@src/stores/tags.ts
@src/stores/stash.ts
@src/stores/worktrees.ts
@src/stores/gitflow.ts
@src/stores/topology.ts
@src/stores/undo.ts
@src/stores/clone.ts
@src/stores/toast.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create store registry and blade store factory</name>
  <files>
    src/stores/registry.ts
    src/stores/createBladeStore.ts
  </files>
  <action>
    **Create `src/stores/registry.ts`:**

    Implement the official Zustand store reset registry pattern:
    ```typescript
    const storeResetFns = new Set<() => void>();

    export function resetAllStores(): void {
      storeResetFns.forEach((resetFn) => resetFn());
    }

    export function registerStoreForReset(
      store: { setState: (state: any, replace?: boolean) => void; getInitialState: () => any }
    ): void {
      storeResetFns.add(() => {
        store.setState(store.getInitialState(), true);
      });
    }
    ```

    This is the foundation for ARCH-07's full reset sequence. Any store that should clear on `closeRepository()` calls `registerStoreForReset()`. Preferences and toast do NOT register (they survive repo switches).

    **Create `src/stores/createBladeStore.ts`:**

    Implement a factory function for blade-local stores that auto-register for global reset:
    ```typescript
    import { create, type StateCreator } from "zustand";
    import { devtools } from "zustand/middleware";
    import { registerStoreForReset } from "./registry";

    export function createBladeStore<T>(
      name: string,
      stateCreator: StateCreator<T, [["zustand/devtools", never]]>,
    ) {
      const store = create<T>()(
        devtools(stateCreator, { name, enabled: import.meta.env.DEV }),
      );
      registerStoreForReset(store);
      return store;
    }
    ```

    This factory ensures:
    - Auto-registration for reset (extensibility: new blades just call the factory)
    - DevTools integration with the store name
    - Consistent creation pattern across all blade stores
  </action>
  <verify>
    - `ls src/stores/registry.ts src/stores/createBladeStore.ts` -- both files exist
    - `grep "resetAllStores" src/stores/registry.ts` -- function exported
    - `grep "registerStoreForReset" src/stores/registry.ts` -- function exported
    - `grep "createBladeStore" src/stores/createBladeStore.ts` -- function exported
    - `npm run type-check` passes
  </verify>
  <done>Store registry with resetAllStores() and registerStoreForReset() functions exists. createBladeStore factory exists for blade-local stores. Both are type-safe and tested via type-check.</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate 9 git stores into GitOps domain store with re-export shims</name>
  <files>
    src/stores/domain/git-ops/types.ts
    src/stores/domain/git-ops/repository.slice.ts
    src/stores/domain/git-ops/branches.slice.ts
    src/stores/domain/git-ops/tags.slice.ts
    src/stores/domain/git-ops/stash.slice.ts
    src/stores/domain/git-ops/worktrees.slice.ts
    src/stores/domain/git-ops/gitflow.slice.ts
    src/stores/domain/git-ops/undo.slice.ts
    src/stores/domain/git-ops/topology.slice.ts
    src/stores/domain/git-ops/clone.slice.ts
    src/stores/domain/git-ops/index.ts
    src/stores/repository.ts
    src/stores/branches.ts
    src/stores/tags.ts
    src/stores/stash.ts
    src/stores/worktrees.ts
    src/stores/gitflow.ts
    src/stores/topology.ts
    src/stores/undo.ts
    src/stores/clone.ts
  </files>
  <action>
    **Create `src/stores/domain/git-ops/types.ts`:**

    Define the middleware type alias and the full store type as a union of all slice interfaces:
    ```typescript
    export type GitOpsMiddleware = [["zustand/devtools", never]];
    // Import and re-export all slice types here after they are created
    ```

    **Create each slice file** (`repository.slice.ts`, `branches.slice.ts`, `tags.slice.ts`, `stash.slice.ts`, `worktrees.slice.ts`, `gitflow.slice.ts`, `undo.slice.ts`, `topology.slice.ts`, `clone.slice.ts`):

    For each slice:
    1. Read the existing store file (e.g., `src/stores/tags.ts`)
    2. Extract the interface and implementation
    3. **Prefix all state keys** to avoid collisions:
       - `tags` -> `tagList`, `isLoading` -> `tagIsLoading`, `error` -> `tagError`, `clearError` -> `clearTagError`
       - `branches` -> `branchList`, `allBranches` -> `branchAllList`, `isLoading` -> `branchIsLoading`
       - `status` (repository) -> `repoStatus`, `isLoading` -> `repoIsLoading`, `error` -> `repoError`
       - `stashes` -> `stashList`, `isLoading` -> `stashIsLoading`
       - `worktrees` -> `worktreeList`, `isLoading` -> `worktreeIsLoading`
       - `topology` -> Keep `nodes`, `edges` (unique enough). Prefix: `topologyIsLoading`, `topologyError`
       - `undo` -> `undoInfo`, `undoIsLoading`
       - `clone` -> `cloneIsCloning`, `cloneProgress`, `cloneError`
       - `gitflow` -> `gitflowStatus`, `gitflowIsLoading`, `gitflowError`
    4. Use the `StateCreator<GitOpsStore, GitOpsMiddleware, [], SliceInterface>` generic signature
    5. Add DevTools action names: `set({ ... }, undefined, "gitOps:slice/action")`
    6. For gitflow slice: Replace cross-store `useBranchStore.getState().loadBranches()` with `get().loadBranches()` and `useRepositoryStore.getState().refreshStatus()` with `get().refreshRepoStatus()`. This naturally resolves the anti-pattern.
    7. For worktrees slice: Replace the lazy import of `useRepositoryStore` with `get().openRepository()`.

    **Action name prefixes** MUST be unique per slice. The naming convention is: `gitOps:{slice}/{action}`. Examples:
    - `"gitOps:repo/open"`, `"gitOps:repo/openSuccess"`, `"gitOps:repo/close"`
    - `"gitOps:branch/load"`, `"gitOps:branch/create"`
    - `"gitOps:tag/load"`, `"gitOps:tag/delete"`

    **Create `src/stores/domain/git-ops/index.ts`:**

    Compose all slices into a single store:
    ```typescript
    import { create } from "zustand";
    import { devtools } from "zustand/middleware";
    import { registerStoreForReset } from "../../registry";
    // Import all slice creators

    export type GitOpsStore = RepositorySlice & BranchSlice & TagSlice & StashSlice
      & WorktreeSlice & GitflowSlice & UndoSlice & TopologySlice & CloneSlice;

    export const useGitOpsStore = create<GitOpsStore>()(
      devtools(
        (...args) => ({
          ...createRepositorySlice(...args),
          ...createBranchSlice(...args),
          ...createTagSlice(...args),
          ...createStashSlice(...args),
          ...createWorktreeSlice(...args),
          ...createGitflowSlice(...args),
          ...createUndoSlice(...args),
          ...createTopologySlice(...args),
          ...createCloneSlice(...args),
        }),
        { name: "git-ops", enabled: import.meta.env.DEV },
      ),
    );

    // Auto-register for global reset (clears on closeRepository)
    registerStoreForReset(useGitOpsStore);
    ```

    Re-export all slice types for consumers.

    **Convert original store files to re-export shims:**

    For each of the 9 original files (e.g., `src/stores/tags.ts`), replace the entire content with a backward-compatible re-export shim. The shim:
    1. Imports `useGitOpsStore` from the new domain store
    2. Exports a function/hook with the original name that selects from the consolidated store
    3. Maps new prefixed keys back to old names for backward compatibility

    Example shim for `src/stores/tags.ts`:
    ```typescript
    // @deprecated - Import from "../stores/domain/git-ops" directly.
    // This shim exists for backward compatibility during Phase 30 migration.
    import { useGitOpsStore } from "./domain/git-ops";

    // Re-export the consolidated store as the old store name
    // Consumers using useTagStore((s) => s.tags) will need to update selectors to s.tagList
    // But consumers using useTagStore.getState().loadTags() will work unchanged
    export const useTagStore = useGitOpsStore;
    ```

    For stores where consumers use destructured state (e.g., `const { tags, isLoading } = useTagStore()`), the shim should be a simple alias since consumers MUST update selectors anyway when keys are renamed. The shim prevents import path breakage while consumers update their selectors.

    CRITICAL: Run `npm run type-check` after creating each slice to catch TypeScript issues early. The `StateCreator` generics are complex and easy to get wrong.

    CRITICAL: After all slices are wired, verify `useGitOpsStore.getInitialState()` returns all expected initial state from all 9 slices. This is essential for the reset registry to work correctly.
  </action>
  <verify>
    - `ls src/stores/domain/git-ops/*.ts` -- shows index.ts, types.ts, and 9 slice files
    - `npm run type-check` passes with zero errors
    - `npm test` passes all existing tests (re-export shims preserve backward compatibility)
    - `grep "registerStoreForReset" src/stores/domain/git-ops/index.ts` -- store is registered
    - Verify no naming collisions: in a Node REPL or test, check that `useGitOpsStore.getInitialState()` has all expected keys (repoStatus, branchList, tagList, stashList, etc.)
  </verify>
  <done>9 git stores consolidated into useGitOpsStore with prefixed state keys. Re-export shims maintain backward compatibility. Store is registered for reset. All tests pass. Cross-store getState() anti-patterns in gitflow and worktrees resolved via get().</done>
</task>

</tasks>

<verification>
1. `ls src/stores/registry.ts` -- exists with resetAllStores + registerStoreForReset
2. `ls src/stores/createBladeStore.ts` -- exists with factory function
3. `ls src/stores/domain/git-ops/` -- shows index.ts, types.ts, 9 slice files
4. `grep "useGitOpsStore" src/stores/domain/git-ops/index.ts` -- store exported
5. `grep -l "deprecated\|shim\|domain/git-ops" src/stores/repository.ts src/stores/branches.ts src/stores/tags.ts` -- all are shims
6. `npm run type-check` -- zero TypeScript errors
7. `npm test` -- all tests pass
</verification>

<success_criteria>
- Store registry infrastructure exists with resetAllStores() and registerStoreForReset() (ARCH-05 foundation)
- createBladeStore factory supports extensible blade store creation (extensibility focus)
- 9 git stores consolidated into useGitOpsStore with slices pattern (ARCH-05 partial)
- Re-export shims prevent any breaking import changes (ARCH-06 partially addressed -- duplicate opener is a separate concern)
- All existing tests pass without test file modifications
- Cross-store getState() anti-pattern eliminated in gitflow and worktrees
</success_criteria>

<output>
After completion, create `.planning/phases/30-store-consolidation-tech-debt/30-03-SUMMARY.md`
</output>
