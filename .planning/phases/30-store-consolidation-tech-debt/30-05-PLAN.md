---
phase: 30-store-consolidation-tech-debt
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useKeyboardShortcuts.ts
  - src/commands/navigation.ts
  - src/machines/navigation/navigationMachine.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can press Cmd+K (or Ctrl+K) to open the command palette"
    - "User receives feedback when attempting to open a singleton blade that is already in the stack"
    - "Gitflow Cheatsheet command in the palette opens the blade when a repo is open"
  artifacts:
    - path: "src/hooks/useKeyboardShortcuts.ts"
      provides: "mod+k hotkey binding for command palette"
      contains: "mod+k"
    - path: "src/commands/navigation.ts"
      provides: "mod+k shortcut declared on command-palette command"
      contains: "mod+k"
    - path: "src/machines/navigation/navigationMachine.ts"
      provides: "Fallback transition for singleton-already-exists PUSH_BLADE"
      contains: "notifySingletonExists"
  key_links:
    - from: "src/hooks/useKeyboardShortcuts.ts"
      to: "useCommandPaletteStore.getState().togglePalette()"
      via: "useHotkeys mod+k callback"
      pattern: 'useHotkeys.*mod\+k'
    - from: "src/machines/navigation/navigationMachine.ts"
      to: "toast"
      via: "notifySingletonExists action"
      pattern: "notifySingletonExists"
---

<objective>
Fix Cmd+K command palette shortcut and singleton blade feedback.

Purpose: UAT Test 4 failed because (A) Cmd+K shortcut was never implemented (only Cmd+Shift+P exists), and (B) the XState navigation machine silently swallows PUSH_BLADE events for singleton blades that are already in the stack, giving no user feedback.

Output: Cmd+K opens command palette, singleton blade pushes show a toast when blade already exists.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-store-consolidation-tech-debt/30-02-SUMMARY.md
@.planning/debug/cmd-k-command-palette.md

@src/hooks/useKeyboardShortcuts.ts
@src/commands/navigation.ts
@src/machines/navigation/navigationMachine.ts
@src/lib/bladeOpener.ts
@src/stores/commandPalette.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Cmd+K hotkey binding and update command shortcut display</name>
  <files>src/hooks/useKeyboardShortcuts.ts, src/commands/navigation.ts</files>
  <action>
    In `src/hooks/useKeyboardShortcuts.ts`:
    - Add a new `useHotkeys("mod+k", ...)` call right AFTER the existing `mod+shift+p` block (line 185).
    - The callback should be identical: `e.preventDefault(); useCommandPaletteStore.getState().togglePalette();`
    - Use `{ preventDefault: true }` as options.
    - Update the JSDoc comment at the top to include `Cmd/Ctrl+K: Open command palette` alongside the existing `Cmd/Ctrl+Shift+P` entry.

    In `src/commands/navigation.ts`:
    - Change the `shortcut` field on the `command-palette` command registration (line 12) from `"mod+shift+p"` to `"mod+k"` so the palette UI displays the more discoverable shortcut.
    - Both shortcuts (mod+k and mod+shift+p) remain functional via useKeyboardShortcuts.ts; the command registration only affects the displayed shortcut text.
  </action>
  <verify>
    - `grep -n "mod+k" src/hooks/useKeyboardShortcuts.ts` shows the new hotkey binding
    - `grep -n "mod+k" src/commands/navigation.ts` shows the updated shortcut display
    - `npx tsc --noEmit` passes (excluding pre-existing bindings error)
  </verify>
  <done>Cmd+K and Cmd+Shift+P both toggle the command palette. Command palette command displays "mod+k" as its shortcut.</done>
</task>

<task type="auto">
  <name>Task 2: Add singleton-already-exists feedback in navigation machine</name>
  <files>src/machines/navigation/navigationMachine.ts</files>
  <action>
    In `src/machines/navigation/navigationMachine.ts`, the PUSH_BLADE transitions (lines 216-225) currently have two cases:
    1. `not("isUnderMaxDepth")` -> notifyMaxDepth
    2. `and(["isNotSingleton", "isUnderMaxDepth"])` -> pushBlade

    When a singleton blade IS already in the stack AND we're under max depth, neither guard matches, so the event is silently dropped.

    Fix by adding a third transition case AFTER the pushBlade case (order matters -- XState evaluates top to bottom):

    ```
    PUSH_BLADE: [
      {
        guard: not("isUnderMaxDepth"),
        actions: "notifyMaxDepth",
      },
      {
        guard: and(["isNotSingleton", "isUnderMaxDepth"]),
        actions: "pushBlade",
      },
      {
        // Fallback: singleton already in stack
        actions: "notifySingletonExists",
      },
    ],
    ```

    Add the `notifySingletonExists` action in the `actions` section of `setup({})`:
    ```typescript
    notifySingletonExists: ({ event }) => {
      if (event.type === "PUSH_BLADE") {
        toast.info(`${event.title ?? event.bladeType} is already open`);
      }
    },
    ```

    Also update the existing navigation machine test file `src/machines/navigation/navigationMachine.test.ts` to add a test case verifying the new behavior:
    - Create a machine with notifySingletonExists overridden via `machine.provide({ actions: { notifySingletonExists: () => {} } })`
    - Push a singleton blade (e.g., "settings"), then push it again.
    - Assert the stack length remains 2 (root + settings) after the second push.
    - This confirms the event is handled (not dropped) but doesn't add a duplicate.
  </action>
  <verify>
    - `npm test -- --run` passes, including the new singleton feedback test
    - `npx tsc --noEmit` passes
  </verify>
  <done>Navigation machine shows toast when user tries to push a singleton blade that already exists. Event is handled (not silently dropped). New test confirms behavior.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` produces zero new errors
- `npm test -- --run` passes all tests (82+ existing + new singleton test)
- `grep -n "mod+k" src/hooks/useKeyboardShortcuts.ts` returns a match
- `grep -n "notifySingletonExists" src/machines/navigation/navigationMachine.ts` returns a match
</verification>

<success_criteria>
- Cmd+K opens the command palette (alongside existing Cmd+Shift+P)
- Attempting to push a singleton blade already in the stack shows a toast notification
- All existing tests continue to pass
- UAT Test 4 gap is resolved
</success_criteria>

<output>
After completion, create `.planning/phases/30-store-consolidation-tech-debt/30-05-SUMMARY.md`
</output>
