---
phase: 48-diff-viewer-foundations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/blades/diff/DiffBlade.tsx
  - src/core/blades/diff/components/DiffContent.tsx
  - src/core/blades/diff/components/DiffToolbar.tsx
  - src/core/blades/diff/components/DiffMarkdownPreview.tsx
  - src/core/blades/diff/components/StagingDiffNavigation.tsx
  - src/core/blades/diff/hooks/useDiffQuery.ts
  - src/core/blades/diff/hooks/useDiffPreferences.ts
  - src/core/stores/domain/preferences/diff.slice.ts
  - src/core/stores/domain/preferences/index.ts
autonomous: true

must_haves:
  truths:
    - "DiffBlade renders identical UI to current behavior (no visual regression)"
    - "Monaco editor is properly disposed on unmount (no memory leak)"
    - "Diff preferences (viewMode, collapseUnchanged) persist to Tauri store"
    - "Preferences load from storage on app init with safe defaults"
  artifacts:
    - path: "src/core/blades/diff/components/DiffContent.tsx"
      provides: "Monaco DiffEditor wrapper with lifecycle management"
      min_lines: 40
    - path: "src/core/blades/diff/components/DiffToolbar.tsx"
      provides: "Toolbar with view mode toggle and extensible trailing slot"
      min_lines: 30
    - path: "src/core/blades/diff/hooks/useDiffQuery.ts"
      provides: "Shared react-query hook for staging and commit diff fetching"
      exports: ["useDiffQuery"]
    - path: "src/core/blades/diff/hooks/useDiffPreferences.ts"
      provides: "Hook wrapping diff preferences store slice"
      exports: ["useDiffPreferences"]
    - path: "src/core/stores/domain/preferences/diff.slice.ts"
      provides: "Zustand slice for diff viewer preferences with Tauri persistence"
      exports: ["createDiffSlice", "DiffSlice"]
  key_links:
    - from: "src/core/blades/diff/DiffBlade.tsx"
      to: "src/core/blades/diff/components/DiffContent.tsx"
      via: "import and render"
      pattern: "import.*DiffContent"
    - from: "src/core/blades/diff/hooks/useDiffPreferences.ts"
      to: "src/core/stores/domain/preferences/index.ts"
      via: "usePreferencesStore selector"
      pattern: "usePreferencesStore"
    - from: "src/core/stores/domain/preferences/index.ts"
      to: "src/core/stores/domain/preferences/diff.slice.ts"
      via: "slice composition"
      pattern: "createDiffSlice"
---

<objective>
Refactor the monolithic DiffBlade.tsx into composable components and create the diff preferences persistence layer.

Purpose: Establish clean architecture for Phase 48 features (collapsible regions, word-level highlighting) and future phases (49-50 hunk staging, conflict resolution). Fix existing memory leak from undisposed Monaco editors. Create preference storage so view mode persists across sessions.

Output: Decomposed diff components (DiffContent, DiffToolbar, DiffMarkdownPreview, StagingDiffNavigation), shared hooks (useDiffQuery, useDiffPreferences), and diff preferences Zustand slice wired into the preferences store.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-diff-viewer-foundations/48-RESEARCH.md

@src/core/blades/diff/DiffBlade.tsx
@src/core/blades/diff/types.ts
@src/core/blades/diff/registration.tsx
@src/core/blades/staging-changes/components/InlineDiffViewer.tsx
@src/core/lib/monacoConfig.ts
@src/core/lib/monacoTheme.ts
@src/core/stores/domain/preferences/index.ts
@src/core/stores/domain/preferences/settings.slice.ts
@src/core/stores/domain/preferences/types.ts
@src/core/lib/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create diff preferences slice and wire into preferences store</name>
  <files>
    src/core/stores/domain/preferences/diff.slice.ts
    src/core/stores/domain/preferences/index.ts
  </files>
  <action>
Create `src/core/stores/domain/preferences/diff.slice.ts` following the exact pattern from `settings.slice.ts`:

1. Define the `DiffPreferences` interface:
```typescript
interface DiffPreferences {
  viewMode: "inline" | "side-by-side";
  collapseUnchanged: boolean;
  contextLines: number;
}
```

2. Define `defaultDiffPreferences`:
```typescript
const defaultDiffPreferences: DiffPreferences = {
  viewMode: "inline",
  collapseUnchanged: true,
  contextLines: 3,
};
```

3. Create a `mergeDiffPreferences` function (same pattern as `mergeSettings`): spread merge `{ ...defaultDiffPreferences, ...saved }` for forward compatibility.

4. Define `DiffSlice` interface with:
   - `diffPreferences: DiffPreferences`
   - `setDiffViewMode: (mode: "inline" | "side-by-side") => Promise<void>`
   - `setDiffCollapseUnchanged: (collapse: boolean) => Promise<void>`
   - `initDiffPreferences: () => Promise<void>`

5. Implement `createDiffSlice` as `StateCreator<PreferencesStore, PreferencesMiddleware, [], DiffSlice>`:
   - `setDiffViewMode`: Updates state, persists via `store.set("diff-preferences", ...)` then `store.save()`. Use devtools action name `"preferences:diff/setViewMode"`.
   - `setDiffCollapseUnchanged`: Same pattern, action name `"preferences:diff/setCollapseUnchanged"`.
   - `initDiffPreferences`: Loads from store key `"diff-preferences"`, merges with defaults, sets state. Action name `"preferences:diff/init"`.

6. Update `src/core/stores/domain/preferences/index.ts`:
   - Import `createDiffSlice` and `DiffSlice`
   - Add `DiffSlice` to the `PreferencesStore` intersection type
   - Spread `createDiffSlice(...args)` into the store creator
   - Add `state.initDiffPreferences()` to the `initAllPreferences()` Promise.all array
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors. Verify `diff.slice.ts` exports `DiffSlice` and `createDiffSlice`. Verify `initAllPreferences` calls `initDiffPreferences`.
  </verify>
  <done>
DiffSlice exists with viewMode/collapseUnchanged/contextLines persistence. Preferences store composes it. Init function loads saved preferences on startup with safe defaults for missing keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract DiffBlade into composable components and hooks</name>
  <files>
    src/core/blades/diff/components/DiffContent.tsx
    src/core/blades/diff/components/DiffToolbar.tsx
    src/core/blades/diff/components/DiffMarkdownPreview.tsx
    src/core/blades/diff/components/StagingDiffNavigation.tsx
    src/core/blades/diff/hooks/useDiffQuery.ts
    src/core/blades/diff/hooks/useDiffPreferences.ts
    src/core/blades/diff/DiffBlade.tsx
  </files>
  <action>
Extract the monolithic DiffBlade.tsx (283 lines) into focused components. The refactored DiffBlade should be a thin orchestrator (~50-70 lines).

**A. Create `hooks/useDiffQuery.ts`:**
```typescript
export function useDiffQuery(source: DiffSource, contextLines = 3) {
  // staging mode -> commands.getFileDiff(path, staged, contextLines)
  // commit mode -> commands.getCommitFileDiff(oid, path, contextLines)
  // staleTime: 60000 for commits (immutable), undefined for working tree
  // Returns { data, isLoading, error } from useQuery
}
```
Query keys: `["fileDiff", path, staged, contextLines]` for staging, `["commitFileDiff", oid, path, contextLines]` for commit. Import from `@tanstack/react-query` and `../../../bindings`.

**B. Create `hooks/useDiffPreferences.ts`:**
```typescript
export function useDiffPreferences() {
  // Selector into usePreferencesStore for diff-specific state
  // Returns: { viewMode, collapseUnchanged, contextLines, setDiffViewMode, setDiffCollapseUnchanged }
}
```
Use `usePreferencesStore` with a shallow selector to avoid unnecessary re-renders.

**C. Create `components/DiffContent.tsx`:**
Props: `{ original: string; modified: string; language: string; inline: boolean; collapseUnchanged?: boolean; contextLines?: number }`.

Key implementation details:
- Wraps Monaco `DiffEditor` with proper lifecycle: use `onMount` callback to capture editor ref, `useEffect` cleanup to call `editor.dispose()` on unmount (fixes the existing memory leak).
- Container div: `className="flex-1 min-h-0 h-full overflow-hidden"`.
- Memoize the options object with `useMemo` to prevent Monaco reconfiguration on every render. Options include `...MONACO_COMMON_OPTIONS`, `renderSideBySide: !inline`, `originalEditable: false`, `glyphMargin: true` (reserves gutter space for Phase 50).
- Do NOT add hideUnchangedRegions or diffAlgorithm yet -- that is Plan 48-02's scope.

**D. Create `components/DiffToolbar.tsx`:**
Props interface:
```typescript
interface DiffToolbarProps {
  inline: boolean;
  onToggleInline: () => void;
  isMarkdown?: boolean;
  showPreview?: boolean;
  onTogglePreview?: () => void;
  trailing?: React.ReactNode;
}
```
- Reuse the exact same toolbar JSX from current DiffBlade lines 191-253.
- The inline/side-by-side toggle button uses `Columns`/`AlignJustify` Lucide icons (same as current).
- The markdown Diff/Preview toggle uses `Code`/`Eye` icons (same as current).
- `trailing` slot renders after `<div className="flex-1" />` for navigation or future actions.
- Add `role="toolbar"` and `aria-label="Diff viewer controls"` on the outer div.

**E. Create `components/DiffMarkdownPreview.tsx`:**
Props: `{ content: string; filePath: string }`.
- Extracts lines 255-265 from current DiffBlade.
- Uses lazy-loaded `MarkdownRenderer` with `Suspense` and `BladeLoadingFallback`.
- Container: `flex-1 min-h-0 overflow-y-auto bg-ctp-base` with `p-6 mx-auto w-full` inner wrapper.

**F. Move `StagingDiffNavigation` to `components/StagingDiffNavigation.tsx`:**
- Extract lines 34-125 from current DiffBlade (the `StagingDiffNavigation` function component).
- No logic changes, just move to its own file.
- Import `useBladeNavigation`, `useUIStore`, `useQuery`, `commands`, `useHotkeys`, `ChevronLeft`, `ChevronRight`.

**G. Slim down `DiffBlade.tsx`:**
The new DiffBlade becomes an orchestrator:
```typescript
import { useDiffQuery } from "./hooks/useDiffQuery";
import { useDiffPreferences } from "./hooks/useDiffPreferences";
import { DiffContent } from "./components/DiffContent";
import { DiffToolbar } from "./components/DiffToolbar";
import { DiffMarkdownPreview } from "./components/DiffMarkdownPreview";
import { StagingDiffNavigation } from "./components/StagingDiffNavigation";

export function DiffBlade({ source }: DiffBladeProps) {
  const { viewMode, setDiffViewMode } = useDiffPreferences();
  const inline = viewMode === "inline";
  // Markdown preview state (local, not persisted)
  const [showPreview, setShowPreview] = useState(false);
  const isMarkdown = source.filePath.toLowerCase().endsWith(".md") || source.filePath.toLowerCase().endsWith(".mdx");

  const { data: result, isLoading, error } = useDiffQuery(source);

  // Toggle handler that persists preference
  const handleToggleInline = useCallback(() => {
    setDiffViewMode(inline ? "side-by-side" : "inline");
  }, [inline, setDiffViewMode]);

  // Loading, error, binary states (same as current)
  // ...

  return (
    <div className="flex-1 flex flex-col overflow-hidden h-full">
      <DiffToolbar
        inline={inline}
        onToggleInline={handleToggleInline}
        isMarkdown={isMarkdown}
        showPreview={showPreview}
        onTogglePreview={() => setShowPreview(v => !v)}
        trailing={source.mode === "staging" ? <StagingDiffNavigation currentFilePath={source.filePath} /> : undefined}
      />
      {showPreview && isMarkdown ? (
        <DiffMarkdownPreview content={diff.newContent} filePath={source.filePath} />
      ) : (
        <DiffContent original={diff.oldContent} modified={diff.newContent} language={diff.language} inline={inline} />
      )}
    </div>
  );
}
```

Keep loading/error/binary early returns identical to current behavior.

IMPORTANT: Do NOT change `InlineDiffViewer.tsx` in this plan. That file is modified in Plan 48-02.
  </action>
  <verify>
1. Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors.
2. Verify the refactored DiffBlade.tsx is under 80 lines (orchestrator only).
3. Verify DiffContent.tsx has `editor.dispose()` in a useEffect cleanup.
4. Verify DiffToolbar has `role="toolbar"` and `aria-label`.
5. Run `npx vitest run --reporter=verbose 2>&1 | tail -20` -- existing tests pass.
  </verify>
  <done>
DiffBlade decomposed into DiffContent (Monaco wrapper with disposal), DiffToolbar (accessible, slot-based), DiffMarkdownPreview, StagingDiffNavigation, useDiffQuery hook, and useDiffPreferences hook. View mode reads from persisted preferences. No visual regression from current behavior.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` passes with no new errors
2. `npx vitest run --reporter=verbose` -- all existing tests pass
3. Refactored DiffBlade.tsx is a thin orchestrator (<80 lines)
4. DiffContent.tsx properly disposes Monaco editor on unmount
5. DiffToolbar has accessibility attributes (role, aria-label)
6. diff.slice.ts persists to store key "diff-preferences"
7. initAllPreferences() includes initDiffPreferences()
8. No changes to InlineDiffViewer.tsx (that is Plan 48-02)
</verification>

<success_criteria>
- DiffBlade renders identically to before the refactor (no visual regression)
- Monaco editor memory leak fixed (dispose on unmount)
- View mode preference saved to Tauri store and restored on init
- All components have clear interfaces ready for Phase 48-02 feature additions
- Existing test suite passes without modification
</success_criteria>

<output>
After completion, create `.planning/phases/48-diff-viewer-foundations/48-01-SUMMARY.md`
</output>
