---
phase: 48-diff-viewer-foundations
plan: 02
type: execute
wave: 2
depends_on: ["48-01"]
files_modified:
  - src/core/blades/diff/components/DiffContent.tsx
  - src/core/blades/diff/components/DiffToolbar.tsx
  - src/core/blades/staging-changes/components/InlineDiffViewer.tsx
  - src/core/lib/monacoTheme.ts
autonomous: true

must_haves:
  truths:
    - "User opens a diff and sees unchanged code regions collapsed by default with 'Show N lines' expander"
    - "User clicks the expander and hidden lines are revealed without losing scroll position"
    - "User can see word-level diff highlighting with distinct colors for additions (green) and deletions (red)"
    - "Word-level highlights are visually prominent against subtle line-level background wash"
    - "User toggles collapse on/off via toolbar button and preference persists"
    - "InlineDiffViewer in staging panel also shows collapsed regions and word-level highlighting"
    - "Narrow panels auto-switch to inline mode below 600px"
  artifacts:
    - path: "src/core/blades/diff/components/DiffContent.tsx"
      provides: "Monaco DiffEditor with hideUnchangedRegions and diffAlgorithm: advanced"
      contains: "hideUnchangedRegions"
    - path: "src/core/blades/diff/components/DiffToolbar.tsx"
      provides: "Collapse unchanged toggle button"
      contains: "collapseUnchanged"
    - path: "src/core/lib/monacoTheme.ts"
      provides: "Tuned diff colors with layered opacity strategy"
      contains: "diffEditor.unchangedRegionBackground"
    - path: "src/core/blades/staging-changes/components/InlineDiffViewer.tsx"
      provides: "Inline diff viewer with collapsible regions and advanced algorithm"
      contains: "hideUnchangedRegions"
  key_links:
    - from: "src/core/blades/diff/components/DiffContent.tsx"
      to: "src/core/blades/diff/hooks/useDiffPreferences.ts"
      via: "collapseUnchanged prop from preferences"
      pattern: "collapseUnchanged"
    - from: "src/core/blades/diff/components/DiffToolbar.tsx"
      to: "src/core/blades/diff/DiffBlade.tsx"
      via: "onToggleCollapse callback"
      pattern: "onToggleCollapse"
    - from: "src/core/lib/monacoTheme.ts"
      to: "src/core/blades/diff/components/DiffContent.tsx"
      via: "Monaco theme used by DiffEditor"
      pattern: "flowforge-dark"
---

<objective>
Enable collapsible unchanged regions, word-level diff highlighting, and refined theme colors across all diff viewers.

Purpose: Deliver the three Phase 48 requirements (DIFF-01 collapsible regions, DIFF-04 word-level highlighting, DIFF-05 preference persistence). Users see a professional-grade diff viewer where unchanged code is collapsed by default, word-level changes are clearly highlighted, and their view preferences persist.

Output: Updated DiffContent with Monaco hideUnchangedRegions and diffAlgorithm: "advanced", DiffToolbar with collapse toggle, tuned flowforge-dark theme, and InlineDiffViewer with matching features.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-diff-viewer-foundations/48-RESEARCH.md
@.planning/phases/48-diff-viewer-foundations/48-01-SUMMARY.md

@src/core/blades/diff/DiffBlade.tsx
@src/core/blades/diff/components/DiffContent.tsx
@src/core/blades/diff/components/DiffToolbar.tsx
@src/core/blades/diff/hooks/useDiffPreferences.ts
@src/core/blades/staging-changes/components/InlineDiffViewer.tsx
@src/core/lib/monacoTheme.ts
@src/core/lib/monacoConfig.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tune Monaco theme colors and add collapsed region styles</name>
  <files>
    src/core/lib/monacoTheme.ts
  </files>
  <action>
Update the `FLOWFORGE_THEME.colors` in `monacoTheme.ts` with the research-recommended layered opacity strategy. The current colors are too subtle (12.5% opacity for word-level, 8% for line-level).

**Replace these existing entries:**
```typescript
// BEFORE (too subtle)
"diffEditor.insertedTextBackground": "#a6e3a120",  // 12.5%
"diffEditor.removedTextBackground": "#f38ba820",    // 12.5%
"diffEditor.insertedLineBackground": "#a6e3a115",  // 8%
"diffEditor.removedLineBackground": "#f38ba815",    // 8%
```

**With the layered opacity strategy (word-level prominent, line-level subtle):**
```typescript
// Word-level: HIGHER opacity (25%) for clear boundaries
"diffEditor.insertedTextBackground": "#a6e3a140",   // ctp-green 25% -- word-level additions
"diffEditor.removedTextBackground": "#f38ba840",     // ctp-red 25% -- word-level deletions

// Line-level: LOWER opacity (6%) as subtle background wash
"diffEditor.insertedLineBackground": "#a6e3a110",   // ctp-green 6%
"diffEditor.removedLineBackground": "#f38ba810",     // ctp-red 6%
```

**Keep existing gutter colors unchanged** (they're already at 18% which is fine):
```typescript
"diffEditorGutter.insertedLineBackground": "#a6e3a130",  // keep
"diffEditorGutter.removedLineBackground": "#f38ba830",    // keep
```

**Add new entries for collapsed unchanged regions:**
```typescript
"diffEditor.unchangedRegionBackground": "#181825",  // ctp-mantle
"diffEditor.unchangedRegionForeground": "#6c7086",  // ctp-overlay0
"diffEditor.unchangedCodeBackground": "#181825",     // ctp-mantle
```

Design rationale: The eye sees which LINES changed (subtle 6% wash), then focuses on which WORDS changed (prominent 25% highlight). Background highlighting preserves syntax coloring. Collapsed region colors match the app's mantle background for a seamless look.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no errors. Manually verify the color hex codes match Catppuccin Mocha palette: green=#a6e3a1, red=#f38ba8, mantle=#181825, overlay0=#6c7086.
  </verify>
  <done>
Theme has layered diff colors (word=25%, line=6%, gutter=18%) and collapsed region styling. Word-level changes are visually distinct from line-level wash. Collapsed regions blend with mantle background.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable collapsible regions, word-level highlighting, and collapse toggle in diff viewers</name>
  <files>
    src/core/blades/diff/components/DiffContent.tsx
    src/core/blades/diff/components/DiffToolbar.tsx
    src/core/blades/diff/DiffBlade.tsx
    src/core/blades/staging-changes/components/InlineDiffViewer.tsx
  </files>
  <action>
**A. Update DiffContent.tsx -- add Monaco diff features:**

Add `collapseUnchanged` and `contextLines` to the props interface:
```typescript
interface DiffContentProps {
  original: string;
  modified: string;
  language: string;
  inline: boolean;
  collapseUnchanged?: boolean;  // NEW
  contextLines?: number;         // NEW
}
```

In the memoized options object, add these Monaco diff options:
```typescript
const options = useMemo(() => ({
  ...MONACO_COMMON_OPTIONS,
  renderSideBySide: !inline,
  originalEditable: false,
  glyphMargin: true,
  // Phase 48 additions:
  diffAlgorithm: "advanced" as const,
  diffWordWrap: "on" as const,
  renderIndicators: true,
  renderMarginRevertIcon: false,
  useInlineViewWhenSpaceIsLimited: true,
  renderSideBySideInlineBreakpoint: 600,
  hideUnchangedRegions: {
    enabled: collapseUnchanged ?? true,
    contextLineCount: contextLines ?? 3,
    minimumLineCount: 3,
    revealLineCount: 20,
  },
}), [inline, collapseUnchanged, contextLines]);
```

Include `collapseUnchanged` and `contextLines` in the useMemo dependency array.

**B. Update DiffToolbar.tsx -- add collapse toggle:**

Add to props interface:
```typescript
interface DiffToolbarProps {
  inline: boolean;
  onToggleInline: () => void;
  collapseUnchanged: boolean;       // NEW
  onToggleCollapse: () => void;     // NEW
  isMarkdown?: boolean;
  showPreview?: boolean;
  onTogglePreview?: () => void;
  trailing?: React.ReactNode;
}
```

Add a collapse toggle button after the inline/side-by-side button (inside the `!showPreview &&` block). Import `FoldVertical` and `UnfoldVertical` from `lucide-react`:

```tsx
{!showPreview && (
  <>
    <Button
      variant="ghost"
      size="sm"
      onClick={onToggleInline}
      title={inline ? "Switch to side-by-side" : "Switch to inline"}
      className="h-7 px-2"
    >
      {inline ? <Columns className="w-4 h-4" /> : <AlignJustify className="w-4 h-4" />}
      <span className="text-xs ml-1.5">{inline ? "Side-by-side" : "Inline"}</span>
    </Button>
    <div className="w-px h-4 bg-ctp-surface1" />
    <Button
      variant="ghost"
      size="sm"
      onClick={onToggleCollapse}
      title={collapseUnchanged ? "Show all lines" : "Collapse unchanged regions"}
      className="h-7 px-2"
    >
      {collapseUnchanged ? <UnfoldVertical className="w-4 h-4" /> : <FoldVertical className="w-4 h-4" />}
      <span className="text-xs ml-1.5">{collapseUnchanged ? "Show all" : "Collapse"}</span>
    </Button>
  </>
)}
```

**C. Update DiffBlade.tsx -- wire collapse preference:**

Add `collapseUnchanged` and `setDiffCollapseUnchanged` to the useDiffPreferences destructure. Create a `handleToggleCollapse` callback:

```typescript
const { viewMode, collapseUnchanged, setDiffViewMode, setDiffCollapseUnchanged } = useDiffPreferences();

const handleToggleCollapse = useCallback(() => {
  setDiffCollapseUnchanged(!collapseUnchanged);
}, [collapseUnchanged, setDiffCollapseUnchanged]);
```

Pass to DiffToolbar:
```tsx
<DiffToolbar
  inline={inline}
  onToggleInline={handleToggleInline}
  collapseUnchanged={collapseUnchanged}
  onToggleCollapse={handleToggleCollapse}
  // ...rest
/>
```

Pass to DiffContent:
```tsx
<DiffContent
  original={diff.oldContent}
  modified={diff.newContent}
  language={diff.language}
  inline={inline}
  collapseUnchanged={collapseUnchanged}
/>
```

**D. Update InlineDiffViewer.tsx -- add collapsible regions and advanced algorithm:**

Update the `INLINE_DIFF_OPTIONS` constant to include the new diff features:

```typescript
const INLINE_DIFF_OPTIONS = {
  readOnly: true,
  originalEditable: false,
  renderSideBySide: false,
  automaticLayout: true,
  scrollBeyondLastLine: false,
  minimap: { enabled: false },
  fontSize: 12,
  lineNumbers: "on" as const,
  folding: false,
  wordWrap: "on" as const,
  renderLineHighlight: "none" as const,
  scrollbar: { verticalScrollbarSize: 8, horizontalScrollbarSize: 8 },
  overviewRulerBorder: false,
  renderOverviewRuler: false,
  glyphMargin: false,
  lineDecorationsWidth: 0,
  lineNumbersMinChars: 3,
  // Phase 48 additions:
  diffAlgorithm: "advanced" as const,
  renderIndicators: true,
  renderMarginRevertIcon: false,
  hideUnchangedRegions: {
    enabled: true,
    contextLineCount: 3,
    minimumLineCount: 3,
    revealLineCount: 20,
  },
};
```

The InlineDiffViewer always has collapse enabled (it's a compact preview in the staging panel, so collapsed is always the right default). No toolbar toggle needed here.
  </action>
  <verify>
1. Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors.
2. Run `npx vitest run --reporter=verbose 2>&1 | tail -20` -- all tests pass.
3. Verify DiffContent.tsx contains `hideUnchangedRegions` and `diffAlgorithm: "advanced"`.
4. Verify DiffToolbar.tsx has the collapse toggle button with FoldVertical/UnfoldVertical icons.
5. Verify InlineDiffViewer.tsx contains `hideUnchangedRegions` and `diffAlgorithm: "advanced"`.
6. Verify monacoTheme.ts has `diffEditor.unchangedRegionBackground`.
  </verify>
  <done>
All diff viewers show collapsible unchanged regions (default: collapsed with 3 context lines). Word-level highlighting uses advanced diff algorithm with layered opacity colors. Collapse toggle persists via diff preferences. InlineDiffViewer matches DiffContent features. Narrow panels auto-switch to inline below 600px.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` passes
2. `npx vitest run` -- all tests pass
3. Theme colors: word-level at 25% opacity, line-level at 6%, collapsed regions at ctp-mantle
4. DiffContent uses `hideUnchangedRegions: { enabled: collapseUnchanged }` with `diffAlgorithm: "advanced"`
5. DiffToolbar shows collapse toggle with FoldVertical/UnfoldVertical Lucide icons
6. InlineDiffViewer has matching hideUnchangedRegions and diffAlgorithm settings
7. Collapse preference persists via diff.slice.ts store key "diff-preferences"
8. Narrow panels (<600px) auto-switch to inline mode

**Phase 48 Success Criteria Validation:**
- SC1: "User opens a diff and sees unchanged code regions collapsed by default, with a 'Show N unchanged lines' expander" -- Delivered via hideUnchangedRegions with contextLineCount=3, revealLineCount=20
- SC2: "User can see word-level diff highlighting with distinct colors for additions and deletions in both split and unified view modes" -- Delivered via diffAlgorithm: "advanced" with 25% opacity word-level colors
- SC3: "User switches between split and unified diff view modes and that preference persists across app restarts" -- Delivered via diff.slice.ts with Tauri store persistence
</verification>

<success_criteria>
- Unchanged regions collapsed by default with "Show N lines" expander (Monaco built-in UI)
- Word-level changes highlighted at 25% opacity; line-level at 6% (distinct layering)
- Collapse toggle in toolbar persists preference across sessions
- InlineDiffViewer in staging panel has matching features
- All three Phase 48 success criteria met (DIFF-01, DIFF-04, DIFF-05)
</success_criteria>

<output>
After completion, create `.planning/phases/48-diff-viewer-foundations/48-02-SUMMARY.md`
</output>
