---
phase: 22
plan: 22-02
title: Shared Utilities — useRepoFile, BladeContent Components, BladeToolbar, renderPathTitle, Monaco Config
wave: 1
depends_on: []
files_modified:
  - src/hooks/useRepoFile.ts (new)
  - src/components/blades/BladeContentLoading.tsx (new)
  - src/components/blades/BladeContentError.tsx (new)
  - src/components/blades/BladeContentEmpty.tsx (new)
  - src/components/blades/BladeToolbar.tsx (new)
  - src/lib/bladeUtils.ts (new)
  - src/lib/monacoConfig.ts (new)
  - src/lib/resolveRelativePath.ts (new)
  - src/lib/branchClassifier.ts (new)
  - src/components/blades/BladeContainer.tsx
autonomous: true
---

# Shared Utilities — useRepoFile, BladeContent Components, BladeToolbar, renderPathTitle, Monaco Config

## Goal

Extract shared patterns used across multiple Phase 22 blades into reusable utilities and components. This avoids code duplication and ensures consistent UX (loading states, error states, empty states, toolbars, path rendering) across all content blades. Also adds an ARIA live region to BladeContainer for screen reader announcements of blade transitions.

## must_haves

- `useRepoFile(filePath)` hook exists and wraps `commands.readRepoFile` with `@tanstack/react-query`
- `BladeContentLoading` component renders the standardized centered spinner on `bg-ctp-mantle`
- `BladeContentError` component renders a centered error message with optional retry button
- `BladeContentEmpty` component renders a centered icon + message for empty states
- `BladeToolbar` component renders the sub-header toolbar strip (matching DiffBlade's existing pattern)
- `renderPathTitle(filePath)` utility returns the path/filename split ReactNode for blade headers
- `MONACO_COMMON_OPTIONS` and `MONACO_THEME` constants are exported from a shared config module
- `resolveRelativePath(currentFile, relativePath)` correctly resolves `..`, `.`, and nested relative paths
- `classifyBranch(branchName)` returns the gitflow branch type classification
- `BladeContainer` has an ARIA live region that announces blade title changes

## Tasks

<task id="1" title="Create useRepoFile hook">

**File**: Create `src/hooks/useRepoFile.ts`

```ts
import { useQuery } from "@tanstack/react-query";
import { commands } from "../bindings";

/**
 * Hook to load a file's content from the repository at HEAD.
 *
 * Returns { content, isBinary, size } on success.
 * Uses react-query for caching with 60s stale time.
 */
export function useRepoFile(filePath: string) {
  return useQuery({
    queryKey: ["repoFile", filePath],
    queryFn: async () => {
      const result = await commands.readRepoFile(filePath);
      if (result.status === "ok") {
        return result.data;
      }
      throw new Error(
        result.error.type === "EmptyRepository"
          ? "Repository has no commits"
          : `Failed to read file: ${filePath}`
      );
    },
    staleTime: 60_000,
    retry: 1,
  });
}
```

</task>

<task id="2" title="Create BladeContentLoading component">

**File**: Create `src/components/blades/BladeContentLoading.tsx`

```tsx
import { Loader2 } from "lucide-react";

/**
 * Standardized loading state for data-fetching within blades.
 * Matches the pattern used by DiffBlade and CommitDetailsBlade.
 */
export function BladeContentLoading() {
  return (
    <div className="flex-1 flex items-center justify-center bg-ctp-mantle">
      <Loader2 className="w-5 h-5 animate-spin text-ctp-overlay1" />
    </div>
  );
}
```

</task>

<task id="3" title="Create BladeContentError component">

**File**: Create `src/components/blades/BladeContentError.tsx`

```tsx
import { AlertTriangle, RotateCcw } from "lucide-react";

interface BladeContentErrorProps {
  /** Primary error message (e.g., "Failed to load markdown") */
  message: string;
  /** Optional secondary detail (e.g., the file path or error message) */
  detail?: string;
  /** If provided, shows a retry button */
  onRetry?: () => void;
}

/**
 * Standardized error state for data-fetch failures within blades.
 * Shows a centered error message with an optional retry button.
 */
export function BladeContentError({ message, detail, onRetry }: BladeContentErrorProps) {
  return (
    <div className="flex-1 flex flex-col items-center justify-center bg-ctp-mantle gap-3">
      <AlertTriangle className="w-8 h-8 text-ctp-red" />
      <p className="text-sm text-ctp-red">{message}</p>
      {detail && (
        <p className="text-xs text-ctp-overlay0 max-w-md text-center">{detail}</p>
      )}
      {onRetry && (
        <button
          type="button"
          onClick={onRetry}
          className="flex items-center gap-1.5 px-3 py-1.5 text-xs text-ctp-subtext1 bg-ctp-surface0 hover:bg-ctp-surface1 rounded transition-colors mt-1"
        >
          <RotateCcw className="w-3.5 h-3.5" />
          Retry
        </button>
      )}
    </div>
  );
}
```

</task>

<task id="4" title="Create BladeContentEmpty component">

**File**: Create `src/components/blades/BladeContentEmpty.tsx`

```tsx
import type { LucideIcon } from "lucide-react";

interface BladeContentEmptyProps {
  /** Icon to display (e.g., FileText, FolderOpen) */
  icon: LucideIcon;
  /** Primary message */
  message: string;
  /** Optional secondary detail */
  detail?: string;
}

/**
 * Standardized empty state for blades with no content to display.
 * Matches the placeholder blade layout pattern.
 */
export function BladeContentEmpty({ icon: Icon, message, detail }: BladeContentEmptyProps) {
  return (
    <div className="flex-1 flex flex-col items-center justify-center gap-3 text-ctp-subtext0">
      <Icon className="w-10 h-10 text-ctp-overlay0" />
      <p className="text-sm">{message}</p>
      {detail && (
        <p className="text-xs text-ctp-overlay0">{detail}</p>
      )}
    </div>
  );
}
```

</task>

<task id="5" title="Create BladeToolbar component">

**File**: Create `src/components/blades/BladeToolbar.tsx`

```tsx
import type { ReactNode } from "react";
import { cn } from "../../lib/utils";

interface BladeToolbarProps {
  children: ReactNode;
  className?: string;
}

/**
 * Sub-header toolbar strip for blades that need controls below the BladePanel header.
 * Matches the existing DiffBlade toolbar pattern (border-b, bg-ctp-crust).
 *
 * Used by: DiffBlade (inline/side-by-side toggle), RepoBrowserBlade (breadcrumbs).
 */
export function BladeToolbar({ children, className }: BladeToolbarProps) {
  return (
    <div
      className={cn(
        "flex items-center gap-2 px-3 py-1 border-b border-ctp-surface0 bg-ctp-crust shrink-0",
        className,
      )}
    >
      {children}
    </div>
  );
}
```

</task>

<task id="6" title="Create bladeUtils with renderPathTitle">

**File**: Create `src/lib/bladeUtils.tsx`

```tsx
import type { ReactNode } from "react";

/**
 * Renders a file path as a split path/filename display for blade headers.
 *
 * Example: "src/components/App.tsx" renders as:
 *   <span class="text-ctp-overlay1">src/components/</span>
 *   <span class="font-semibold text-ctp-text">App.tsx</span>
 *
 * Extracted from registrations/diff.tsx for reuse across viewer blade registrations.
 */
export function renderPathTitle(filePath: string): ReactNode {
  const lastSlash = filePath.lastIndexOf("/");
  if (lastSlash === -1) {
    return (
      <span className="text-sm font-semibold text-ctp-text truncate">
        {filePath}
      </span>
    );
  }
  return (
    <span className="text-sm truncate">
      <span className="text-ctp-overlay1">
        {filePath.slice(0, lastSlash + 1)}
      </span>
      <span className="font-semibold text-ctp-text">
        {filePath.slice(lastSlash + 1)}
      </span>
    </span>
  );
}
```

</task>

<task id="7" title="Create shared Monaco config">

**File**: Create `src/lib/monacoConfig.ts`

```ts
/**
 * Shared Monaco Editor configuration constants.
 *
 * Used by DiffBlade (DiffEditor) and ViewerCodeBlade (Editor).
 * Theme is registered in monacoTheme.ts (imported as a side effect).
 */
export const MONACO_THEME = "flowforge-dark" as const;

export const MONACO_COMMON_OPTIONS = {
  readOnly: true,
  automaticLayout: true,
  scrollBeyondLastLine: false,
  minimap: { enabled: false },
  fontSize: 13,
  lineNumbers: "on" as const,
  folding: true,
  wordWrap: "off" as const,
  renderLineHighlight: "all" as const,
  scrollbar: {
    verticalScrollbarSize: 10,
    horizontalScrollbarSize: 10,
  },
} as const;
```

</task>

<task id="8" title="Create resolveRelativePath utility">

**File**: Create `src/lib/resolveRelativePath.ts`

```ts
/**
 * Resolve a relative path against a file's directory.
 *
 * Examples:
 *   resolveRelativePath("docs/guide.md", "./API.md") => "docs/API.md"
 *   resolveRelativePath("docs/guide.md", "../README.md") => "README.md"
 *   resolveRelativePath("guide.md", "./images/logo.png") => "images/logo.png"
 *   resolveRelativePath("a/b/c.md", "../../d.md") => "d.md"
 *
 * Used by MarkdownRenderer to resolve relative links and image paths.
 */
export function resolveRelativePath(
  currentFile: string,
  relativePath: string,
): string {
  // Strip any leading ./ from the relative path
  let rel = relativePath;

  // Get the directory of the current file
  const dir = currentFile.includes("/")
    ? currentFile.substring(0, currentFile.lastIndexOf("/"))
    : "";

  // Combine directory and relative path
  const combined = dir ? `${dir}/${rel}` : rel;

  // Normalize: resolve . and .. segments
  const parts = combined.split("/");
  const resolved: string[] = [];
  for (const part of parts) {
    if (part === "..") {
      resolved.pop();
    } else if (part !== "." && part !== "") {
      resolved.push(part);
    }
  }

  return resolved.join("/");
}
```

</task>

<task id="9" title="Create branchClassifier utility">

**File**: Create `src/lib/branchClassifier.ts`

```ts
/**
 * Branch type classification for Gitflow cheatsheet.
 */
export type GitflowBranchType =
  | "main"
  | "develop"
  | "feature"
  | "release"
  | "hotfix"
  | "other";

/**
 * Classify a branch name into its Gitflow type.
 *
 * @param branchName - The full branch name (e.g., "feature/add-login", "main")
 * @returns The Gitflow branch type classification
 */
export function classifyBranch(branchName: string): GitflowBranchType {
  if (branchName === "main" || branchName === "master") return "main";
  if (branchName === "develop" || branchName === "development") return "develop";
  if (branchName.startsWith("feature/")) return "feature";
  if (branchName.startsWith("release/")) return "release";
  if (branchName.startsWith("hotfix/")) return "hotfix";
  return "other";
}

/**
 * Catppuccin accent color for each Gitflow branch type.
 * Used for SVG lane highlighting and badge colors.
 */
export const BRANCH_TYPE_COLORS: Record<GitflowBranchType, string> = {
  main: "var(--ctp-red)",
  develop: "var(--ctp-blue)",
  feature: "var(--ctp-green)",
  release: "var(--ctp-peach)",
  hotfix: "var(--ctp-mauve)",
  other: "var(--ctp-overlay1)",
};

/**
 * Tailwind color class (without prefix) for each Gitflow branch type.
 */
export const BRANCH_TYPE_TW: Record<GitflowBranchType, string> = {
  main: "ctp-red",
  develop: "ctp-blue",
  feature: "ctp-green",
  release: "ctp-peach",
  hotfix: "ctp-mauve",
  other: "ctp-overlay1",
};
```

</task>

<task id="10" title="Add ARIA live region to BladeContainer">

**File**: `src/components/blades/BladeContainer.tsx`

Add an ARIA live region that announces the active blade title for screen reader users.

1. Import `useMemo` or derive the active blade title inline.

2. After the existing `<div className="flex h-full overflow-hidden">`, add a visually-hidden live region:

Replace the component's return block:

```tsx
export function BladeContainer() {
  const { bladeStack, popToIndex, popBlade } = useBladeStore();
  const activeBlade = bladeStack[bladeStack.length - 1];

  return (
    <div className="flex h-full overflow-hidden">
      {/* Screen reader announcement for blade transitions */}
      <div aria-live="polite" className="sr-only">
        {activeBlade.title}
      </div>

      {bladeStack.slice(0, -1).map((blade, index) => (
        <BladeStrip
          key={blade.id}
          title={blade.title}
          onExpand={() => popToIndex(index)}
        />
      ))}
      <AnimatePresence mode="popLayout">
        <motion.div
          key={activeBlade.id}
          initial={{ x: 40, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          exit={{ x: 40, opacity: 0 }}
          transition={{ type: "tween", ease: "easeOut", duration: 0.2 }}
          className="flex-1 min-w-0"
        >
          <BladeRenderer blade={activeBlade} goBack={popBlade} />
        </motion.div>
      </AnimatePresence>
    </div>
  );
}
```

The `aria-live="polite"` region will announce the blade title whenever it changes (when `activeBlade` changes). The `sr-only` class makes it visually hidden but accessible to screen readers.

</task>

## Verification

- [ ] `useRepoFile("README.md")` returns query result with `{ content, isBinary, size }` shape
- [ ] `BladeContentLoading` renders a centered spinner matching the DiffBlade pattern
- [ ] `BladeContentError` renders an error message with retry button when `onRetry` is provided
- [ ] `BladeContentEmpty` renders an icon and message in the centered placeholder pattern
- [ ] `BladeToolbar` renders children inside the standard sub-header toolbar strip
- [ ] `renderPathTitle("src/App.tsx")` returns a ReactNode with dimmed path and bold filename
- [ ] `renderPathTitle("App.tsx")` returns just the bold filename (no path prefix)
- [ ] `MONACO_COMMON_OPTIONS` includes readOnly, automaticLayout, fontSize 13, minimap disabled
- [ ] `resolveRelativePath("docs/guide.md", "../README.md")` returns `"README.md"`
- [ ] `resolveRelativePath("a/b/c.md", "./d.md")` returns `"a/b/d.md"`
- [ ] `classifyBranch("feature/add-login")` returns `"feature"`
- [ ] `classifyBranch("main")` returns `"main"`
- [ ] `classifyBranch("some-random-branch")` returns `"other"`
- [ ] Screen reader (VoiceOver) announces blade title when switching between blades
- [ ] `npx tsc --noEmit` completes with no new errors
