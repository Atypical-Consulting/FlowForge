---
phase: 22
plan: 22-10
title: Integration & Polish — Cross-Blade Navigation, Header Entry Points, Accessibility Audit, Final Verification
wave: 4
depends_on: [22-04, 22-05, 22-06, 22-07, 22-08, 22-09]
files_modified:
  - src/components/blades/registrations/diff.tsx
  - src/components/blades/DiffBlade.tsx
  - src/components/blades/registrations/viewer-image.ts
  - src/components/layout/Header.tsx (or equivalent toolbar)
autonomous: true
---

# Integration & Polish — Cross-Blade Navigation, Header Entry Points, Accessibility Audit, Final Verification

## Goal

Wire up all cross-blade navigation flows, add the repo browser entry point to the header toolbar, update existing registrations to use shared utilities (renderPathTitle, MONACO_COMMON_OPTIONS), verify accessibility across all new blades, and run a final integration check ensuring all 6 CONTENT requirements are met. This is the polish and integration plan that ties all Phase 22 work together.

## must_haves

- Header toolbar has a "Browse Files" button that opens the repo browser blade
- DiffBlade registration uses the shared `renderPathTitle` utility
- Viewer-image registration uses the shared `renderPathTitle` utility
- DiffBlade uses `MONACO_COMMON_OPTIONS` from the shared config (dedup options)
- All blade types pass the dev-mode exhaustiveness check (0 missing registrations)
- Cross-blade navigation works: repo browser -> any viewer blade, markdown link -> markdown viewer, markdown link -> repo browser
- All 6 CONTENT requirements are verified as met
- No TypeScript errors (except pre-existing TS2440 in bindings.ts)

## Tasks

<task id="1" title="Add repo browser entry point to header">

Find the header toolbar component (likely `src/components/layout/Header.tsx` or `src/components/layout/RepositoryHeader.tsx`).

Search for the file that contains the header toolbar with action buttons. It may be in:
- `src/components/layout/Header.tsx`
- `src/components/layout/TopBar.tsx`
- `src/components/layout/AppHeader.tsx`

Add a "Browse Files" button that opens the repo browser:

```tsx
import { FolderTree } from "lucide-react";
import { useBladeNavigation } from "../../hooks/useBladeNavigation";

// Inside the header component, alongside other action buttons:
const { openBlade } = useBladeNavigation();

<button
  type="button"
  onClick={() => openBlade("repo-browser", {})}
  className="p-1.5 rounded hover:bg-ctp-surface0 text-ctp-overlay1 hover:text-ctp-text transition-colors"
  title="Browse repository files"
  aria-label="Browse repository files"
>
  <FolderTree className="w-4 h-4" />
</button>
```

Place this button in the header's action area, near existing buttons like settings or gitflow.

Note: The `openBlade("repo-browser", {})` call works because `path` is optional in `BladePropsMap["repo-browser"]` — an empty object defaults to the repository root.

</task>

<task id="2" title="Update diff registration to use renderPathTitle">

**File**: `src/components/blades/registrations/diff.tsx`

Replace the inline `renderTitleContent` implementation with the shared utility:

```tsx
import { lazy } from "react";
import { registerBlade } from "../../../lib/bladeRegistry";
import { renderPathTitle } from "../../../lib/bladeUtils";
import type { DiffSource } from "../DiffBlade";

const DiffBlade = lazy(() =>
  import("../DiffBlade").then((m) => ({ default: m.DiffBlade })),
);

registerBlade<{ source: DiffSource }>({
  type: "diff",
  defaultTitle: "Diff",
  component: DiffBlade,
  lazy: true,
  renderTitleContent: (props) => {
    const filePath =
      "filePath" in props.source ? props.source.filePath : "Diff";
    return renderPathTitle(filePath);
  },
});
```

This replaces the 20-line inline implementation with a one-liner using the shared utility.

</task>

<task id="3" title="Update viewer-image registration to use renderPathTitle">

**File**: `src/components/blades/registrations/viewer-image.ts`

Check the current registration and update it to use `renderPathTitle`:

```ts
import { lazy } from "react";
import { registerBlade } from "../../../lib/bladeRegistry";
import { renderPathTitle } from "../../../lib/bladeUtils";

const ViewerImageBlade = lazy(() =>
  import("../ViewerImageBlade").then((m) => ({
    default: m.ViewerImageBlade,
  })),
);

registerBlade<{ filePath: string; oid?: string }>({
  type: "viewer-image",
  defaultTitle: (props) => props.filePath.split("/").pop() || "Image",
  component: ViewerImageBlade,
  lazy: true,
  renderTitleContent: (props) => renderPathTitle(props.filePath),
});
```

</task>

<task id="4" title="Deduplicate Monaco options in DiffBlade">

**File**: `src/components/blades/DiffBlade.tsx`

Replace the inline Monaco options object with the shared constant:

1. Add import:
   ```ts
   import { MONACO_COMMON_OPTIONS, MONACO_THEME } from "../../lib/monacoConfig";
   ```

2. In the `<DiffEditor>` component, replace the `options` prop:

   ```tsx
   <DiffEditor
     original={diff.oldContent}
     modified={diff.newContent}
     language={diff.language}
     theme={MONACO_THEME}
     options={{
       ...MONACO_COMMON_OPTIONS,
       renderSideBySide: !inline,
       originalEditable: false,
     }}
   />
   ```

   Note: `MONACO_COMMON_OPTIONS` already includes `readOnly: true`, `automaticLayout: true`, `minimap: { enabled: false }`, etc. The DiffEditor-specific options (`renderSideBySide`, `originalEditable`) are spread on top.

3. Remove the `"../../lib/monacoTheme"` import if it was only used for side effects and the theme constant is now imported from `monacoConfig`. Actually, keep the monacoTheme import — it's a side-effect import that triggers Monaco CDN loading and theme registration. The `monacoConfig.ts` just exports constants, it doesn't trigger the side effect.

   So the imports should be:
   ```ts
   import "../../lib/monacoTheme"; // Side-effect: registers theme
   import { MONACO_COMMON_OPTIONS, MONACO_THEME } from "../../lib/monacoConfig";
   ```

</task>

<task id="5" title="Verify cross-blade navigation flows">

Test the following navigation flows manually (or document them for UAT):

**Flow 1: Repo browser -> Markdown viewer -> Relative link navigation**
1. Open repo browser (header button)
2. Navigate to a directory containing .md files
3. Click a .md file -> ViewerMarkdownBlade opens (pushed)
4. Click a relative .md link -> blade replaces (same type, new content)
5. Back button returns to previous blade in stack

**Flow 2: Repo browser -> Code viewer -> Back**
1. Open repo browser
2. Click a .ts file -> ViewerCodeBlade opens (pushed)
3. Back button returns to repo browser at the same directory

**Flow 3: Repo browser -> 3D viewer -> Back**
1. Open repo browser
2. Navigate to directory with .glb file
3. Click .glb file -> Viewer3dBlade opens (pushed)
4. Back button returns to repo browser

**Flow 4: DiffBlade -> Markdown toggle**
1. Stage a .md file change
2. Click the file to open diff
3. Toggle to Preview mode
4. Verify rendered markdown appears
5. Toggle back to Diff mode
6. Verify Monaco diff editor appears

**Flow 5: Markdown viewer -> External link -> System browser**
1. Open a .md file containing an external link (https://...)
2. Click the external link
3. Verify system browser opens

**Flow 6: Gitflow cheatsheet from header**
1. Open gitflow cheatsheet from the existing entry point
2. Verify current branch is highlighted
3. Verify action cards are contextual
4. Verify reference cards are all displayed

</task>

<task id="6" title="Accessibility audit">

Verify the following accessibility requirements:

1. **ARIA live region**: Switch between blades and verify screen reader announces the blade title (VoiceOver on macOS: enable via Cmd+F5, listen for announcements during blade transitions).

2. **Repo browser keyboard nav**:
   - Tab to breadcrumbs, Enter to navigate
   - Tab to file list, Arrow Up/Down to move, Enter to activate
   - Home/End jump to first/last item
   - Breadcrumbs have `role="navigation"` and `aria-current="page"`
   - File list has `role="listbox"` with `role="option"` items

3. **Markdown accessibility**:
   - Heading hierarchy preserved
   - Links are focusable and clickable via keyboard
   - Code blocks are focusable (`tabIndex={0}`) for keyboard scrolling
   - Images have alt text from markdown source
   - Copy button has appropriate `aria-label`

4. **3D viewer accessibility**:
   - `alt` attribute on model-viewer
   - `aria-busy` during loading
   - `role="alert"` on WebGL failure state
   - Arrow keys work for orbit (model-viewer built-in)
   - Info button has `aria-label`

5. **Color contrast**:
   - Verify `text-ctp-overlay1` (not overlay0) is used for meaningful text
   - Verify `text-ctp-subtext0` meets AA contrast against `bg-ctp-base`

Fix any issues found during the audit.

</task>

<task id="7" title="Final exhaustiveness and type check">

1. Run `npx tsc --noEmit` and verify no new errors (pre-existing TS2440 in bindings.ts is expected).

2. Start the app in dev mode (`npm run dev`) and check the browser console for:
   - `[BladeRegistry] All 13 blade types registered.` (no missing registrations)
   - No errors or warnings

3. Verify the CONTENT requirements traceability:
   - **CONTENT-01**: Open a .md file -> rendered with GFM (tables, task lists, code highlighting)
   - **CONTENT-02**: Open a .md diff -> toggle between diff and rendered preview
   - **CONTENT-03**: Open a .glb file -> 3D model with orbit controls and auto-lighting
   - **CONTENT-04**: Open repo browser -> navigate directories, open files in appropriate blades
   - **CONTENT-05**: Open gitflow cheatsheet -> SVG diagram, branch types, current state highlighting
   - **CONTENT-06**: Gitflow cheatsheet shows "You are here" + contextual action cards

4. Update the dev-mode exhaustiveness check list in `registrations/index.ts` if the type count has changed.

</task>

## Verification

- [ ] Header toolbar has a "Browse Files" button that opens repo browser at repository root
- [ ] Diff registration uses `renderPathTitle` (no inline path/filename split code)
- [ ] Viewer-image registration uses `renderPathTitle`
- [ ] DiffBlade uses `MONACO_COMMON_OPTIONS` from shared config (not inline options)
- [ ] Dev console shows `All 13 blade types registered` with no missing registrations
- [ ] Repo browser -> markdown viewer navigation works (push)
- [ ] Markdown relative .md link -> replace blade navigation works
- [ ] Markdown relative non-.md link -> push repo browser works
- [ ] Markdown external link -> system browser works
- [ ] Repo browser -> code viewer -> back navigation works
- [ ] Repo browser -> 3D viewer -> back navigation works
- [ ] DiffBlade markdown toggle works for .md files
- [ ] Gitflow cheatsheet shows correct branch type highlighting
- [ ] Screen reader announces blade transitions (ARIA live region)
- [ ] Repo browser supports full keyboard navigation (arrows, Enter, Home/End)
- [ ] All accessibility attributes are present (aria-label, aria-current, role, aria-busy)
- [ ] `npx tsc --noEmit` passes with no new errors
- [ ] All 6 CONTENT requirements (CONTENT-01 through CONTENT-06) are met
