---
phase: 22
plan: 22-07
title: DiffBlade Markdown Toggle — Segmented Control for Diff/Preview Switching
wave: 3
depends_on: [22-04]
files_modified:
  - src/components/blades/DiffBlade.tsx
autonomous: true
---

# DiffBlade Markdown Toggle — Segmented Control for Diff/Preview Switching

## Goal

Add a toggle to DiffBlade that lets users switch between the raw Monaco diff view and a rendered markdown preview for `.md` and `.mdx` files. The toggle appears as a segmented control in the existing internal toolbar, alongside the inline/side-by-side toggle. The markdown preview shows the new version only (working tree or staged content). This fulfills requirement CONTENT-02.

## must_haves

- A segmented control (`Code` / `Eye` icons) appears in DiffBlade's toolbar only for `.md` and `.mdx` files
- Default state is always "diff view" (not persisted across blade instances)
- Toggling to preview mode shows the rendered markdown using `MarkdownRenderer` (lazy-loaded)
- The inline/side-by-side toggle is hidden when in preview mode (it only applies to diff view)
- The rendered preview shows `diff.newContent` (the new version)
- `MarkdownRenderer` is lazy-loaded inside DiffBlade to avoid pulling react-markdown into the diff chunk unconditionally
- A visual divider separates the diff/preview toggle from the inline/side-by-side toggle

## Tasks

<task id="1" title="Add markdown toggle to DiffBlade">

**File**: `src/components/blades/DiffBlade.tsx`

1. Add the following imports at the top of the file:

```ts
import { Code, Eye } from "lucide-react";
import { lazy, Suspense } from "react";
import { BladeLoadingFallback } from "./BladeLoadingFallback";
```

Note: `lazy` and `Suspense` may already be imported. Adjust as needed. The existing imports are `{ useCallback, useMemo, useState }` from "react" — add `lazy` and `Suspense` to that import.

2. Add the lazy-loaded MarkdownRenderer import below the other imports (outside the component):

```ts
const MarkdownRenderer = lazy(() =>
  import("../markdown/MarkdownRenderer").then((m) => ({
    default: m.MarkdownRenderer,
  })),
);
```

3. Inside the `DiffBlade` component function, after the existing `const [inline, setInline] = useState(true);`:

```ts
// Markdown preview toggle — only for .md/.mdx files
const isMarkdown =
  source.filePath?.toLowerCase().endsWith(".md") ||
  source.filePath?.toLowerCase().endsWith(".mdx");
const [showPreview, setShowPreview] = useState(false);
```

Wait — `source.filePath` is not always available. The `DiffSource` type is:
```ts
type DiffSource =
  | { mode: "commit"; oid: string; filePath: string }
  | { mode: "staging"; filePath: string; staged: boolean };
```

Both variants have `filePath`, so `source.filePath` is always available. The check is safe.

4. In the toolbar section (the `<div className="flex items-center gap-2 px-3 py-1 ...">` block at line 182), modify the content:

Replace the existing toolbar block with:

```tsx
{/* Toolbar: diff view toggles + staging navigation */}
<div className="flex items-center gap-2 px-3 py-1 border-b border-ctp-surface0 bg-ctp-crust shrink-0">
  {/* Inline/side-by-side toggle (hidden in preview mode) */}
  {!showPreview && (
    <Button
      variant="ghost"
      size="sm"
      onClick={() => setInline((v) => !v)}
      title={inline ? "Switch to side-by-side" : "Switch to inline"}
      className="h-7 px-2"
    >
      {inline ? (
        <Columns className="w-4 h-4" />
      ) : (
        <AlignJustify className="w-4 h-4" />
      )}
      <span className="text-xs ml-1.5">
        {inline ? "Side-by-side" : "Inline"}
      </span>
    </Button>
  )}

  {/* Markdown preview toggle (only for .md/.mdx files) */}
  {isMarkdown && (
    <>
      {!showPreview && (
        <div className="w-px h-4 bg-ctp-surface1" />
      )}
      <div className="flex bg-ctp-surface0 rounded p-0.5">
        <button
          type="button"
          onClick={() => setShowPreview(false)}
          className={`flex items-center gap-1 px-2 py-0.5 rounded text-xs transition-colors ${
            !showPreview
              ? "bg-ctp-surface1 text-ctp-text"
              : "text-ctp-overlay0 hover:text-ctp-subtext1"
          }`}
          title="Show diff"
        >
          <Code className="w-3.5 h-3.5" />
          Diff
        </button>
        <button
          type="button"
          onClick={() => setShowPreview(true)}
          className={`flex items-center gap-1 px-2 py-0.5 rounded text-xs transition-colors ${
            showPreview
              ? "bg-ctp-surface1 text-ctp-text"
              : "text-ctp-overlay0 hover:text-ctp-subtext1"
          }`}
          title="Show rendered preview"
        >
          <Eye className="w-3.5 h-3.5" />
          Preview
        </button>
      </div>
    </>
  )}

  <div className="flex-1" />
  {source.mode === "staging" && (
    <StagingDiffNavigation currentFilePath={source.filePath} />
  )}
</div>
```

5. In the content area below the toolbar, replace the `<DiffEditor>` section with a conditional render:

Replace:
```tsx
{/* Monaco DiffEditor */}
<div className="flex-1 min-h-0">
  <DiffEditor
    original={diff.oldContent}
    modified={diff.newContent}
    language={diff.language}
    theme="flowforge-dark"
    options={{...}}
  />
</div>
```

With:
```tsx
{/* Content: diff editor or markdown preview */}
{showPreview && isMarkdown ? (
  <div className="flex-1 min-h-0 overflow-y-auto bg-ctp-base">
    <div className="p-6 max-w-3xl mx-auto">
      <Suspense fallback={<BladeLoadingFallback />}>
        <MarkdownRenderer
          content={diff.newContent}
          currentFilePath={source.filePath}
        />
      </Suspense>
    </div>
  </div>
) : (
  <div className="flex-1 min-h-0">
    <DiffEditor
      original={diff.oldContent}
      modified={diff.newContent}
      language={diff.language}
      theme="flowforge-dark"
      options={{
        readOnly: true,
        renderSideBySide: !inline,
        originalEditable: false,
        automaticLayout: true,
        scrollBeyondLastLine: false,
        minimap: { enabled: false },
        fontSize: 13,
        lineNumbers: "on",
        folding: true,
        wordWrap: "off",
        renderLineHighlight: "all",
        scrollbar: {
          verticalScrollbarSize: 10,
          horizontalScrollbarSize: 10,
        },
      }}
    />
  </div>
)}
```

**Key detail**: The `MarkdownRenderer` is wrapped in `<Suspense>` with `BladeLoadingFallback` because it is lazy-loaded. The first time a user toggles preview on, there will be a brief loading state while `react-markdown` and its plugins are fetched. Subsequent toggles will be instant.

**Note**: The `currentFilePath` prop is passed to `MarkdownRenderer` so that relative links in the preview work correctly (resolving against the diff file's directory).

</task>

<task id="2" title="Add BladeLoadingFallback import if missing" depends_on="1">

Verify that `BladeLoadingFallback` is imported. If not already imported:

```ts
import { BladeLoadingFallback } from "./BladeLoadingFallback";
```

Check the existing imports in `DiffBlade.tsx` and add this import if it is not present.

</task>

## Verification

- [ ] Opening a diff for a `.md` file shows the segmented Diff/Preview toggle in the toolbar
- [ ] Opening a diff for a `.tsx` file does NOT show the Diff/Preview toggle
- [ ] Default view is always "Diff" (Monaco diff editor)
- [ ] Clicking "Preview" shows the rendered markdown with proper styling
- [ ] The inline/side-by-side toggle is hidden when in preview mode
- [ ] The visual divider only appears between the inline/side-by-side toggle and the diff/preview toggle
- [ ] Switching back to "Diff" shows the Monaco diff editor again
- [ ] The preview shows the new version content (not the old version or a diff)
- [ ] The rendered markdown has proper GFM support (tables, code highlighting, etc.)
- [ ] Links in the preview work (external -> system browser, relative .md -> replace blade)
- [ ] Toggle state resets to "Diff" when navigating to a different file via prev/next arrows
- [ ] First toggle to preview shows a brief loading state (lazy load), subsequent toggles are instant
- [ ] `npx tsc --noEmit` completes with no new errors
