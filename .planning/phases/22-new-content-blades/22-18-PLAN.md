---
phase: 22-new-content-blades
plan: 18
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useBladeNavigation.ts
  - src/lib/fileDispatch.ts
  - src/components/blades/Viewer3dBlade.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Staging a .md file and opening its diff routes to DiffBlade with preview toggle (not viewer-markdown)"
    - "Opening a .md file diff from commit history routes to DiffBlade with oid prop"
    - "3D model (.glb) loads and renders without fetch() data URI errors in Tauri WKWebView"
  artifacts:
    - path: "src/lib/fileDispatch.ts"
      provides: "Context-aware dispatch that routes .md to diff in diff context"
    - path: "src/hooks/useBladeNavigation.ts"
      provides: "openDiff and openStagingDiff handle viewer-markdown by routing to diff"
    - path: "src/components/blades/Viewer3dBlade.tsx"
      provides: "atob-based base64 decoding for binary GLB files with WebGL detection"
  key_links:
    - from: "src/hooks/useBladeNavigation.ts"
      to: "src/lib/fileDispatch.ts"
      via: "bladeTypeForFile() import"
      pattern: "bladeTypeForFile"
    - from: "src/hooks/useBladeNavigation.ts"
      to: "src/components/blades/DiffBlade.tsx"
      via: "openBlade('diff', ...) with source props"
      pattern: "openBlade.*diff"
---

<objective>
Fix DiffBlade markdown routing and 3D model loading.

Purpose: Two independent bugs share no files but are both major severity gaps from retest UAT.

(1) DiffBlade markdown routing: When a .md file is changed and user opens its diff, `fileDispatch.ts` maps it to `viewer-markdown` unconditionally. `openDiff()` and `openStagingDiff()` only handle `diff` and `viewer-image` types explicitly -- `viewer-markdown` falls through to the generic `pushBlade` which loses the `oid`/`staged` props needed for diff rendering. The fix: in diff context, .md/.mdx files should route to the `diff` blade type so DiffBlade's preview toggle can show the rendered markdown.

(2) 3D model loading: Plan 22-13 switched from atob() to fetch('data:...') for base64 decode. The UAT retest still shows "Failed to load 3D model". The fetch('data:...') approach fails in Tauri's WKWebView custom protocol scheme. Revert to atob()/Uint8Array approach with proper chunk handling for large files. Also add WebGL capability detection and diagnostic console.error logging.

Output: .md diffs open in DiffBlade with working preview toggle. GLB models load via atob approach.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-new-content-blades/22-retest-UAT.md
@.planning/debug/diffblade-md-preview.md
@.planning/debug/3d-model-load-failure.md
@.planning/phases/22-new-content-blades/22-13-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route .md/.mdx to DiffBlade in diff contexts</name>
  <files>
    src/lib/fileDispatch.ts
    src/hooks/useBladeNavigation.ts
  </files>
  <action>
    **Option A (preferred -- simpler):** Fix `openDiff()` and `openStagingDiff()` in `useBladeNavigation.ts` to handle `viewer-markdown` the same way as `diff` -- route it to the diff blade type so DiffBlade's preview toggle works.

    In `openDiff()` (around line 42):
    - Change the condition from `if (type === "diff")` to `if (type === "diff" || type === "viewer-markdown")`
    - This ensures .md files get routed to DiffBlade with the proper `{ source: { mode: "commit", oid, filePath } }` props
    - DiffBlade already has the preview toggle that renders markdown

    In `openStagingDiff()` (around line 59):
    - Change the condition from `if (type === "diff")` to `if (type === "diff" || type === "viewer-markdown")`
    - This ensures staged .md files get routed to DiffBlade with `{ source: { mode: "staging", filePath, staged } }` props

    Do NOT change fileDispatch.ts -- the mapping of .md to viewer-markdown is correct for the browse context (repo browser should still open .md files in the markdown viewer). The fix is in the navigation hooks which should override viewer-markdown to diff when in diff/staging context.
  </action>
  <verify>
    Read the updated `openDiff()` and `openStagingDiff()` functions and confirm both now route `viewer-markdown` type to the `diff` blade with proper source props. Run `npx tsc --noEmit` to confirm type safety.
  </verify>
  <done>
    Staging a .md file change and clicking to view diff opens DiffBlade (with preview toggle), not viewer-markdown blade. Same for commit history .md diffs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Revert 3D model loading to atob approach with WebGL detection</name>
  <files>src/components/blades/Viewer3dBlade.tsx</files>
  <action>
    In the `loadModel` callback inside Viewer3dBlade.tsx, replace the fetch-based base64 decode with an atob/Uint8Array approach that handles large files. The fetch('data:...') approach fails in Tauri's WKWebView.

    Replace the binary branch (the `else` block starting around line 53) with:
    ```typescript
    // Binary (.glb) — decode base64 via atob + Uint8Array (avoids fetch('data:...') which fails in Tauri WKWebView)
    const ext = filePath.split(".").pop()?.toLowerCase();
    const mime = ext === "gltf" ? "model/gltf+json" : "model/gltf-binary";
    try {
      const binaryString = atob(content);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      const blob = new Blob([bytes], { type: mime });
      const url = URL.createObjectURL(blob);
      setBlobUrl(url);
    } catch (decodeErr) {
      console.error("[Viewer3dBlade] Base64 decode failed:", decodeErr);
      setFetchError(decodeErr instanceof Error ? decodeErr.message : "Base64 decode failed");
      setLoading(false);
      return;
    }
    ```

    Also add diagnostic console.error logging in the outer catch block:
    ```typescript
    } catch (err) {
      console.error("[Viewer3dBlade] Model load failed:", err);
      setFetchError(err instanceof Error ? err.message : "Failed to load model");
      setLoading(false);
    }
    ```

    Also add WebGL capability detection BEFORE attempting to render. At the top of the `loadModel` callback (after setLoading(true)), add:
    ```typescript
    // WebGL capability check
    try {
      const testCanvas = document.createElement("canvas");
      const gl = testCanvas.getContext("webgl2") || testCanvas.getContext("webgl");
      if (!gl) {
        setFetchError("WebGL is not supported by your browser or GPU");
        setLoading(false);
        return;
      }
    } catch {
      // WebGL detection itself failed — continue anyway, model-viewer will handle it
      console.warn("[Viewer3dBlade] WebGL detection failed, proceeding anyway");
    }
    ```

    NOTE: The CSS variable fix for `var(--ctp-base)` and `var(--ctp-mantle)` in this file is handled by Plan 22-17. This task only changes the JavaScript logic.
  </action>
  <verify>
    Read the updated `loadModel` function and confirm:
    1. Binary branch uses atob() + Uint8Array, NOT fetch('data:...')
    2. WebGL detection exists before model loading
    3. Console.error diagnostic logging exists in both catch blocks
    Run `npx tsc --noEmit` to confirm no type errors.
  </verify>
  <done>
    GLB model loading uses atob/Uint8Array approach (no fetch('data:...')). WebGL is detected before rendering. Diagnostic logging captures actual error details.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (ignoring pre-existing TS2440)
- openDiff() routes .md files to DiffBlade (type === "diff" || type === "viewer-markdown")
- openStagingDiff() routes .md files to DiffBlade (same condition)
- Viewer3dBlade uses atob() not fetch('data:...') for binary base64 decode
- WebGL detection present before model render attempt
</verification>

<success_criteria>
Markdown files in diff/staging context open in DiffBlade with preview toggle. GLB models load via atob() without fetch restrictions. WebGL detection prevents silent failures.
</success_criteria>

<output>
After completion, create `.planning/phases/22-new-content-blades/22-18-SUMMARY.md`
</output>
