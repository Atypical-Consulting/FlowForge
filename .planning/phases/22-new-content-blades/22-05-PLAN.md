---
phase: 22
plan: 22-05
title: Viewer-Code Blade — Monaco Read-Only File Viewer with Language Auto-Detection
wave: 2
depends_on: [22-01, 22-02]
files_modified:
  - src/components/blades/ViewerCodeBlade.tsx (new)
  - src/components/blades/registrations/viewer-code.ts (new)
autonomous: true
---

# Viewer-Code Blade — Monaco Read-Only File Viewer with Language Auto-Detection

## Goal

Create the new `viewer-code` blade type that provides a read-only Monaco Editor for viewing any text file from the repository browser. This blade uses Monaco's built-in language detection from the file path, the shared `flowforge-dark` theme, and the `useRepoFile` hook for data loading. Binary files show an informational "binary file" message instead of garbled content. This blade is the default fallback for text files opened from the repo browser.

## must_haves

- `ViewerCodeBlade` component renders a read-only Monaco Editor with the file content
- Language is auto-detected from the file extension via Monaco's `path` prop
- Theme matches the existing DiffBlade (`flowforge-dark`)
- Binary files show a "Binary file - preview not available" info card (not garbled content)
- Loading state uses `BladeContentLoading`, error state uses `BladeContentError`
- Registration file uses `renderPathTitle` for the blade header
- Registration uses `lazy: true` for code splitting
- The blade is discoverable by the dev-mode exhaustiveness check (no more `viewer-code` warning)

## Tasks

<task id="1" title="Create ViewerCodeBlade component">

**File**: Create `src/components/blades/ViewerCodeBlade.tsx`

```tsx
import { Editor } from "@monaco-editor/react";
import { FileCode } from "lucide-react";
import { useRepoFile } from "../../hooks/useRepoFile";
import { MONACO_COMMON_OPTIONS, MONACO_THEME } from "../../lib/monacoConfig";
import "../../lib/monacoTheme"; // Ensure theme is registered
import { BladeContentLoading } from "./BladeContentLoading";
import { BladeContentError } from "./BladeContentError";
import { BladeContentEmpty } from "./BladeContentEmpty";

interface ViewerCodeBladeProps {
  filePath: string;
}

export function ViewerCodeBlade({ filePath }: ViewerCodeBladeProps) {
  const { data, isLoading, error, refetch } = useRepoFile(filePath);

  if (isLoading) {
    return <BladeContentLoading />;
  }

  if (error) {
    return (
      <BladeContentError
        message="Failed to load file"
        detail={error.message}
        onRetry={() => refetch()}
      />
    );
  }

  if (!data) {
    return (
      <BladeContentEmpty
        icon={FileCode}
        message="File not found at HEAD"
        detail={filePath}
      />
    );
  }

  // Binary file — show info card instead of garbled content
  if (data.isBinary) {
    const sizeLabel = formatFileSize(data.size);
    return (
      <div className="flex-1 flex flex-col items-center justify-center bg-ctp-mantle gap-3">
        <FileCode className="w-10 h-10 text-ctp-overlay0" />
        <p className="text-sm text-ctp-subtext0">Binary file — preview not available</p>
        <p className="text-xs text-ctp-overlay0">{filePath}</p>
        <p className="text-xs text-ctp-overlay0">{sizeLabel}</p>
      </div>
    );
  }

  return (
    <div className="flex-1 min-h-0">
      <Editor
        value={data.content}
        path={filePath}
        theme={MONACO_THEME}
        options={MONACO_COMMON_OPTIONS}
      />
    </div>
  );
}

/**
 * Format a file size in bytes to a human-readable string.
 */
function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}
```

**Key implementation details**:

1. The `path` prop on `<Editor>` tells Monaco to auto-detect the language from the file extension. This is simpler and more comprehensive than maintaining a manual extension-to-language mapping.

2. `MONACO_COMMON_OPTIONS` from `monacoConfig.ts` includes `readOnly: true`, `automaticLayout: true`, `minimap: { enabled: false }`, and the standard scrollbar config.

3. The `"../../lib/monacoTheme"` import is a side-effect import that triggers Monaco CDN loading and theme registration. It is the same import used by `DiffBlade.tsx`.

4. Binary file detection uses the `isBinary` flag from the Rust `readRepoFile` command (which checks for null bytes in the first 8000 bytes).

</task>

<task id="2" title="Create viewer-code registration" depends_on="1">

**File**: Create `src/components/blades/registrations/viewer-code.ts`

```ts
import { lazy } from "react";
import { registerBlade } from "../../../lib/bladeRegistry";
import { renderPathTitle } from "../../../lib/bladeUtils";

const ViewerCodeBlade = lazy(() =>
  import("../ViewerCodeBlade").then((m) => ({
    default: m.ViewerCodeBlade,
  })),
);

registerBlade<{ filePath: string }>({
  type: "viewer-code",
  defaultTitle: (props) => props.filePath.split("/").pop() || "Code",
  component: ViewerCodeBlade,
  lazy: true,
  renderTitleContent: (props) => renderPathTitle(props.filePath),
});
```

**Note**: Since Plan 22-01 switches `registrations/index.ts` to use `import.meta.glob`, this file will be auto-discovered without needing to add a manual import. The dev-mode exhaustiveness check will no longer warn about `viewer-code` being missing.

</task>

## Verification

- [ ] Opening a `.tsx` file from the repo browser shows it in Monaco with TypeScript React syntax highlighting
- [ ] Opening a `.rs` file shows Rust syntax highlighting
- [ ] Opening a `.json` file shows JSON syntax highlighting with proper folding
- [ ] Opening a binary file (e.g., `.png` from repo browser fallback) shows "Binary file - preview not available" with file size
- [ ] The editor is read-only (typing does nothing, no cursor blinking)
- [ ] The theme matches the existing DiffBlade (Catppuccin Mocha colors)
- [ ] The blade header shows the path/filename split (dimmed path, bold filename)
- [ ] Loading state shows centered spinner while file is being fetched
- [ ] Error state shows error message with retry button if fetch fails
- [ ] The dev-mode console no longer warns about missing `viewer-code` registration
- [ ] `npx tsc --noEmit` completes with no new errors
