---
phase: 22-new-content-blades
plan: 19
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/blades/BladeBreadcrumb.tsx
  - src/hooks/useKeyboardShortcuts.ts
  - src/lib/bladeRegistry.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking a breadcrumb parent segment from a diff blade navigates without duplicating repo-browser on the stack"
    - "Pressing Backspace from any blade (including diff blades) navigates back"
    - "HMR re-registration of blade types does not produce console warnings"
  artifacts:
    - path: "src/components/blades/BladeBreadcrumb.tsx"
      provides: "Breadcrumb navigation that deduplicates repo-browser blades on stack"
    - path: "src/hooks/useKeyboardShortcuts.ts"
      provides: "Global Backspace hotkey for blade back navigation"
    - path: "src/lib/bladeRegistry.ts"
      provides: "HMR-aware registration that suppresses duplicate warnings"
  key_links:
    - from: "src/components/blades/BladeBreadcrumb.tsx"
      to: "src/stores/blades.ts"
      via: "useBladeStore popToIndex + replaceBlade"
      pattern: "(popToIndex|replaceBlade|popBlade)"
    - from: "src/hooks/useKeyboardShortcuts.ts"
      to: "src/stores/blades.ts"
      via: "popBlade on Backspace key"
      pattern: "popBlade"
---

<objective>
Fix breadcrumb stack duplication, add global Backspace navigation, and suppress HMR blade registration warnings.

Purpose: Three minor/cosmetic issues that share the blade navigation subsystem. Breadcrumb navigation from diff blade creates duplicate repo-browser entries because replaceBlade() only replaces the top blade without checking if a repo-browser already exists below. Backspace key only works inside RepoBrowserBlade (component-local handler) but not from diff or other blades. HMR re-executes registration modules causing noisy console warnings.

Output: Clean breadcrumb navigation without stack duplicates, global Backspace back-navigation, quiet HMR console.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-new-content-blades/22-retest-UAT.md
@.planning/debug/breadcrumb-nav-issues.md
@.planning/debug/duplicate-blade-registration.md
@.planning/phases/22-new-content-blades/22-16-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix breadcrumb navigation to prevent duplicate repo-browser blades</name>
  <files>src/components/blades/BladeBreadcrumb.tsx</files>
  <action>
    The current `navigateTo()` and `navigateToRoot()` functions call `store.replaceBlade()` which replaces only the top blade. When navigating from a diff blade, the stack looks like:
    `[root, repo-browser, diff]`
    After replaceBlade: `[root, repo-browser, repo-browser]` -- duplicate!

    Fix the `navigateTo` function to find and pop to the nearest repo-browser ancestor, then replace it. If no repo-browser ancestor exists, pop the current blade and push a new repo-browser.

    Replace the `navigateTo` function body:
    ```typescript
    const navigateTo = (dirPath: string) => {
      if (!navigable) return;
      const stack = store.bladeStack;
      // Find the last repo-browser in the stack (excluding current top)
      const repoBrowserIndex = stack.findLastIndex(
        (b, i) => i < stack.length - 1 && b.type === "repo-browser"
      );
      if (repoBrowserIndex >= 0) {
        // Pop to the repo-browser ancestor, then replace it
        store.popToIndex(repoBrowserIndex);
        // Use setTimeout to let state settle, then replace
        setTimeout(() => {
          store.replaceBlade({
            type: "repo-browser",
            title: dirPath.split("/").pop() || "Repository Browser",
            props: { path: dirPath },
          });
        }, 0);
      } else {
        // No repo-browser ancestor â€” just replace current blade
        store.replaceBlade({
          type: "repo-browser",
          title: dirPath.split("/").pop() || "Repository Browser",
          props: { path: dirPath },
        });
      }
    };
    ```

    Apply the same pattern to `navigateToRoot`:
    ```typescript
    const navigateToRoot = () => {
      if (!navigable) return;
      const stack = store.bladeStack;
      const repoBrowserIndex = stack.findLastIndex(
        (b, i) => i < stack.length - 1 && b.type === "repo-browser"
      );
      if (repoBrowserIndex >= 0) {
        store.popToIndex(repoBrowserIndex);
        setTimeout(() => {
          store.replaceBlade({
            type: "repo-browser",
            title: "Repository Browser",
            props: { path: "" },
          });
        }, 0);
      } else {
        store.replaceBlade({
          type: "repo-browser",
          title: "Repository Browser",
          props: { path: "" },
        });
      }
    };
    ```

    NOTE: `findLastIndex` is available in ES2023 and supported in all modern browsers and Node 18+. TypeScript should recognize it with ES2023 or ESNext lib target.
  </action>
  <verify>
    Read the updated BladeBreadcrumb.tsx and confirm navigateTo/navigateToRoot check for existing repo-browser ancestors before replacing. Run `npx tsc --noEmit` to confirm no type errors.
  </verify>
  <done>
    Clicking a breadcrumb parent from a diff blade pops to the nearest repo-browser ancestor and replaces it, preventing duplicate repo-browser entries on the stack.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add global Backspace hotkey and suppress HMR blade registration warnings</name>
  <files>
    src/hooks/useKeyboardShortcuts.ts
    src/lib/bladeRegistry.ts
  </files>
  <action>
    **useKeyboardShortcuts.ts -- Add global Backspace hotkey:**

    Add a new `useHotkeys` call after the existing Escape handler (around line 198). This mirrors the Escape behavior but uses Backspace:

    ```typescript
    // Backspace - navigate back (pop blade stack)
    useHotkeys(
      "backspace",
      () => {
        // Don't pop if command palette is open
        if (useCommandPaletteStore.getState().isOpen) return;
        const bladeStore = useBladeStore.getState();
        if (bladeStore.bladeStack.length > 1) {
          bladeStore.popBlade();
        }
      },
      { enableOnFormTags: false },
    );
    ```

    The `enableOnFormTags: false` option ensures Backspace does NOT trigger when the user is typing in an input, textarea, or contenteditable element. This prevents interfering with normal text editing.

    Update the doc comment at the top of the function to include:
    `* - Backspace: Pop blade (navigate back)`

    **bladeRegistry.ts -- Suppress HMR re-registration warning:**

    Change the `registerBlade` function to silently overwrite during HMR instead of warning:

    ```typescript
    export function registerBlade<TProps>(config: BladeRegistration<TProps>): void {
      if (import.meta.env.DEV && registry.has(config.type) && !import.meta.hot) {
        console.warn(`[BladeRegistry] Duplicate registration for "${config.type}"`);
      }
      registry.set(config.type, config);
    }
    ```

    The key change: add `&& !import.meta.hot` to the warning condition. When Vite HMR is active (`import.meta.hot` is truthy), re-registration is expected and the warning is suppressed. Only warn about genuine duplicates (two different files registering the same type in the same cold load).
  </action>
  <verify>
    1. Read updated useKeyboardShortcuts.ts and confirm Backspace hotkey exists with enableOnFormTags: false
    2. Read updated bladeRegistry.ts and confirm warning is gated behind `!import.meta.hot`
    3. Run `npx tsc --noEmit` to confirm no type errors
  </verify>
  <done>
    Backspace key pops the blade stack from any blade (not just repo browser). HMR re-registration does not produce console warnings. Backspace does not interfere with text input fields.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (ignoring pre-existing TS2440)
- BladeBreadcrumb navigateTo checks for existing repo-browser ancestors before replacing
- useKeyboardShortcuts has Backspace hotkey with enableOnFormTags: false
- bladeRegistry warning gated behind !import.meta.hot
</verification>

<success_criteria>
Breadcrumb navigation from diff blade does not duplicate repo-browser on stack. Backspace works globally for blade back-navigation (except in text inputs). HMR console is clean of duplicate registration warnings.
</success_criteria>

<output>
After completion, create `.planning/phases/22-new-content-blades/22-19-SUMMARY.md`
</output>
