---
phase: 22-new-content-blades
plan: 13
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/blades/Viewer3dBlade.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "3D model loads and renders with orbit controls from repo browser"
    - "Error messages show actual failure details for debugging"
  artifacts:
    - path: "src/components/blades/Viewer3dBlade.tsx"
      provides: "Viewer3dBlade with robust error handling and simplified loading"
      modified_lines: "53-65, 109-111, 286"
  key_links:
    - from: "model-viewer error event"
      to: "setFetchError"
      via: "CustomEvent detail extraction"
      pattern: "detail\\.sourceError"
---

<objective>
Fix 3D model loading failure and improve error diagnostics

Purpose: Resolve UAT Test 16 (major blocker) — models should load and render; error messages should expose root cause instead of swallowing diagnostics
Output: Viewer3dBlade.tsx with improved error handling and simplified blob URL generation
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/3d-model-load-failure.md
@src/components/blades/Viewer3dBlade.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Capture model-viewer error details</name>
  <files>src/components/blades/Viewer3dBlade.tsx</files>
  <action>
Update error event handler (lines 109-111) to capture actual error details from model-viewer CustomEvent:

Replace:
```tsx
const onError = () => {
  setFetchError("Failed to render 3D model");
};
```

With:
```tsx
const onError = (e: Event) => {
  const detail = (e as CustomEvent).detail;
  const sourceError = detail?.sourceError;
  const msg = sourceError?.message || detail?.type || "Failed to render 3D model";
  setFetchError(msg);
};
```

Root cause: model-viewer dispatches error events with `{ detail: { type: 'loadfailure', sourceError: <Error> } }` (confirmed in model-viewer-base.js line 501). Current handler discards ALL diagnostic information. This change exposes the actual error message for debugging.
  </action>
  <verify>
Intentionally break the model (e.g., corrupt the blob URL) → verify error message shows actual failure reason instead of generic "Failed to render 3D model"
  </verify>
  <done>
Error handler extracts and displays sourceError.message when available; falls back to detail.type, then generic message
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify base64 decoding and remove fragile environment attribute</name>
  <files>src/components/blades/Viewer3dBlade.tsx</files>
  <action>
Replace the atob()/charCodeAt()/Uint8Array blob generation (lines 53-65) with fetch-based approach matching MarkdownImage.tsx proven pattern:

Replace:
```tsx
const binary = atob(content);
const bytes = new Uint8Array(binary.length);
for (let i = 0; i < binary.length; i++) {
  bytes[i] = binary.charCodeAt(i);
}
const blob = new Blob([bytes], { type: "model/gltf-binary" });
const url = URL.createObjectURL(blob);
```

With:
```tsx
const dataUri = `data:model/gltf-binary;base64,${content}`;
const response = await fetch(dataUri);
const blob = await response.blob();
const url = URL.createObjectURL(blob);
```

Additionally, remove `environment-image="neutral"` attribute from the model-viewer element (line 286) to eliminate the environment initialization failure mode. Per debug session, Promise.all([srcUpdated, envUpdated]) means ANY environment failure triggers the same error as model load failure. The neutral environment is not essential for basic model viewing.

Root cause: Large GLB files may cause atob() to throw DOMException due to string size limits. The fetch-based approach leverages browser-native base64 decoding which handles large data correctly. Removing environment-image eliminates a non-critical failure path.
  </action>
  <verify>
Open a .glb file from repo browser → model should load and render with orbit controls. Verify with both small (<1MB) and larger (>5MB if available in test repo) GLB files.
  </verify>
  <done>
3D models load successfully using simplified fetch-based decoding; environment-image attribute removed; model-viewer renders with orbit controls
  </done>
</task>

</tasks>

<verification>
Open repo browser → navigate to a .glb file → click to open → model renders with orbit controls, auto-rotation, and zoom functionality
</verification>

<success_criteria>
- UAT Test 16 passes: 3D models load and render correctly
- UAT Tests 17-20 unblocked: Orbit controls, zoom, metadata panel, interaction hint all testable
- Error messages expose actual failure details when debugging is needed
- No regressions in model-viewer functionality
</success_criteria>

<output>
After completion, create `.planning/phases/22-new-content-blades/22-13-SUMMARY.md`
</output>
