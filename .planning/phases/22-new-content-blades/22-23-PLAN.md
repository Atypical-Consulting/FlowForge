---
phase: 22-new-content-blades
plan: 23
type: execute
wave: 9
depends_on: []
files_modified:
  - src/components/blades/DiffBlade.tsx
  - src/components/blades/Viewer3dBlade.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Diff/Preview toggle appears left of Side-by-side button in DiffBlade toolbar"
    - "3D model loads and renders without silent failure"
    - "StrictMode double-invocation does not cause racing parse operations"
  artifacts:
    - path: "src/components/blades/DiffBlade.tsx"
      provides: "Reordered toolbar controls"
      contains: "Markdown preview toggle.*Side-by-side"
    - path: "src/components/blades/Viewer3dBlade.tsx"
      provides: "Robust GLTFLoader.parse with error handling and cancellation"
      contains: "try.*loader\\.parse"
  key_links:
    - from: "src/components/blades/Viewer3dBlade.tsx"
      to: "GLTFLoader.parse"
      via: "try/catch wrapper around synchronous exceptions"
      pattern: "try\\s*\\{[\\s\\S]*loader\\.parse"
---

<objective>
Fix DiffBlade toolbar control ordering (cosmetic) and Viewer3dBlade silent model loading failure (major).

Purpose: Close UAT gaps 1 and 2 — the DiffBlade toggle order is a quick cosmetic fix, while the 3D viewer has five interacting bugs that cause silent failure when loading GLB/GLTF models.
Output: Two fixed blade components passing UAT re-test.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/viewer3d-silent-fail.md
@src/components/blades/DiffBlade.tsx
@src/components/blades/Viewer3dBlade.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Swap DiffBlade toolbar control order</name>
  <files>src/components/blades/DiffBlade.tsx</files>
  <action>
In DiffBlade.tsx, swap the order of the two toolbar control blocks inside the toolbar div (lines 199-255 region):

CURRENT ORDER (wrong):
1. Inline/side-by-side toggle (lines 200-218)
2. Markdown preview toggle with divider (lines 220-255)

REQUIRED ORDER:
1. Markdown preview toggle (Diff/Preview segmented control) — render FIRST (left side)
2. Divider (the `w-px h-4 bg-ctp-surface1` element) — between the two controls
3. Inline/side-by-side toggle — render SECOND (right side)

The divider logic also needs adjustment: currently the divider is inside the markdown preview block and only shows when `!showPreview`. After reordering, the divider should appear between the Diff/Preview toggle and the Side-by-side button, visible only when both controls are present (i.e., `isMarkdown && !showPreview`).

Specifically:
- Move the markdown preview toggle block (the `<div className="flex bg-ctp-surface0 rounded p-0.5">` with Diff/Preview buttons) to render BEFORE the side-by-side button
- Place the divider BETWEEN the two blocks, conditional on `isMarkdown && !showPreview`
- The side-by-side button remains conditional on `!showPreview`

Do NOT change any styling, class names, icons, or functionality — only the JSX render order.
  </action>
  <verify>
Open a .md file diff in the app. Visually confirm: Diff/Preview toggle appears on the LEFT, then a divider, then Side-by-side button on the RIGHT. Toggle to Preview mode — Side-by-side button and divider disappear. Toggle back to Diff — all three reappear in correct order.

Alternatively, inspect the JSX structure: inside the toolbar div, the markdown toggle block should precede the side-by-side button block.
  </verify>
  <done>Diff/Preview segmented toggle renders to the left of the Side-by-side/Inline button in DiffBlade toolbar for all .md/.mdx files.</done>
</task>

<task type="auto">
  <name>Task 2: Fix Viewer3dBlade silent failure — 5 bugs</name>
  <files>src/components/blades/Viewer3dBlade.tsx</files>
  <action>
Fix five interacting bugs diagnosed in `.planning/debug/viewer3d-silent-fail.md`:

**Bug 1: Move bufferRef declaration before loadModel callback.**
Currently `bufferRef` is declared at line 112, AFTER the `loadModel` useCallback (line 39). While this works due to hoisting of `useRef`, it is confusing and fragile. Move `const bufferRef = useRef<ArrayBuffer | null>(null);` to be declared alongside the other refs (after line 36, near `sceneRef`).

**Bug 2: Add cancellation flag to loadModel effect.**
The first `useEffect` (line 115-117) calls `loadModel()` but has no cleanup. Under React StrictMode, this fires twice causing racing async operations. Fix:
- Change the `useEffect` at line 115 to use an `aborted` flag pattern:
```
useEffect(() => {
  let aborted = false;
  const load = async () => {
    await loadModel();
    // If aborted during async load, clear the buffer
    if (aborted) {
      bufferRef.current = null;
    }
  };
  load();
  return () => {
    aborted = true;
  };
}, [loadModel]);
```

**Bug 3: Remove fetchError from Three.js effect dependency array.**
The second `useEffect` (the Three.js scene setup, line 120) has deps `[loading, fetchError]`. The `fetchError` dependency causes unnecessary cleanup/re-setup cycles when parse errors occur. Change to `[loading]` only. The guard at line 121 (`if (loading || fetchError || !bufferRef.current) return;`) still checks fetchError — that's fine as a guard, it just shouldn't be a dep.

**Bug 4: Wrap loader.parse() in try/catch.**
GLTFLoader.parse() can throw synchronous exceptions (e.g., from JSON.parse on corrupted data) that bypass the onError callback. Wrap the entire `loader.parse(...)` call (lines 207-241) in a try/catch:
```
try {
  loader.parse(
    arrayBuffer,
    "",
    (gltf) => {
      if (disposed) return; // Bug 5 guard
      // ... existing success callback ...
    },
    (error) => {
      if (disposed) return; // Bug 5 guard
      console.error("[Viewer3dBlade] GLTF parse error:", error);
      setFetchError(
        error instanceof Error ? error.message : "Failed to parse 3D model",
      );
    },
  );
} catch (syncError) {
  console.error("[Viewer3dBlade] GLTF parse sync error:", syncError);
  setFetchError(
    syncError instanceof Error ? syncError.message : "Failed to parse 3D model",
  );
}
```

**Bug 5: Add disposed flag to prevent stale callbacks.**
At the top of the Three.js `useEffect` body, add `let disposed = false;`. In the cleanup return, set `disposed = true;`. Guard both the success and error callbacks of `loader.parse()` with `if (disposed) return;` to prevent state updates after the effect has been cleaned up.

All five fixes target the same file. Apply them together. Do NOT change any UI, styling, or other functionality.
  </action>
  <verify>
1. `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — no new type errors
2. Open a .glb file in the repo browser — model should load and render (no "Failed to load 3D model" error)
3. Check browser console — no uncaught errors, no "GLTF parse error" messages for valid models
4. Navigate away from 3D blade and back — no stale state or double renders
  </verify>
  <done>GLB/GLTF models load and render in Viewer3dBlade. Silent failures are eliminated: synchronous parse exceptions are caught, StrictMode double-invocation is handled via cancellation, and stale callbacks are guarded.</done>
</task>

</tasks>

<verification>
- DiffBlade toolbar shows Diff/Preview toggle LEFT of Side-by-side button for .md files
- Viewer3dBlade successfully loads and renders .glb models without silent failure
- No TypeScript errors (excluding pre-existing bindings.ts TS2440)
- No console errors during normal 3D model viewing
</verification>

<success_criteria>
- UAT Test 1 re-passes: Diff/Preview toggle is left of Side-by-side option
- UAT Test 3 re-passes: 3D model loads and renders (no "Failed to load 3D model")
- UAT Test 4 unblocked: Orbit and zoom work on loaded model
</success_criteria>

<output>
After completion, create `.planning/phases/22-new-content-blades/22-23-SUMMARY.md`
</output>
