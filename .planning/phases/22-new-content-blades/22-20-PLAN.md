---
phase: 22-new-content-blades
plan: 20
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/blades/ViewerCodeBlade.tsx
  - src/lib/bladeRegistry.ts
  - src/components/blades/registrations/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Monaco editor fills the full blade content area for .txt and all text file types"
    - "No duplicate blade registration warnings appear in browser console during HMR"
  artifacts:
    - path: "src/components/blades/ViewerCodeBlade.tsx"
      provides: "Monaco wrapper with correct height"
      contains: "h-full overflow-hidden"
    - path: "src/lib/bladeRegistry.ts"
      provides: "clearRegistry export for HMR"
      exports: ["registerBlade", "clearRegistry", "getBladeRegistration", "getAllBladeTypes"]
    - path: "src/components/blades/registrations/index.ts"
      provides: "HMR self-accept with dispose handler"
      contains: "import.meta.hot.accept"
  key_links:
    - from: "src/components/blades/registrations/index.ts"
      to: "src/lib/bladeRegistry.ts"
      via: "clearRegistry() in dispose handler"
      pattern: "clearRegistry"
---

<objective>
Fix two targeted CSS/HMR issues from wave 7 UAT: Monaco editor 0px height in ViewerCodeBlade and persistent HMR duplicate registration warnings.

Purpose: Close gaps 3 (Monaco height) and 4 (HMR warnings) from 22-wave7-UAT.md.
Output: Working Monaco height for all file types, clean console during HMR.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/monaco-0px-viewer-code.md
@.planning/debug/hmr-registration-wave7.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Monaco 0px height in ViewerCodeBlade</name>
  <files>src/components/blades/ViewerCodeBlade.tsx</files>
  <action>
    In ViewerCodeBlade.tsx line 55, change the Monaco wrapper div's className from `"flex-1 min-h-0"` to `"h-full overflow-hidden"`.

    Root cause: The parent (BladePanel content area at BladePanel.tsx:42) has `flex-1 min-h-0 overflow-hidden` but is NOT a flex container (no `flex` or `flex-col` class). Therefore `flex-1` on the child is inert -- flex-grow/shrink/basis only apply to children of flex containers. The div collapses to 0px intrinsic height, and Monaco measures 0px.

    The fix matches DiffBlade's pattern (DiffBlade.tsx:275 uses `h-full overflow-hidden`) which works because `h-full` resolves to `height:100%` against the parent's explicit height from the flex layout chain above.

    Do NOT modify BladePanel.tsx -- the issue is in ViewerCodeBlade's assumptions about its parent, not in BladePanel itself.
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new TypeScript errors.
    Visually: Open a .txt file from repo browser, Monaco fills the blade content area.
  </verify>
  <done>Monaco editor renders at full height for .txt and all text file types opened via ViewerCodeBlade.</done>
</task>

<task type="auto">
  <name>Task 2: Fix HMR duplicate registration warnings</name>
  <files>src/lib/bladeRegistry.ts, src/components/blades/registrations/index.ts</files>
  <action>
    **Verify bladeRegistry.ts** already has the correct state from plan 22-19:
    - `registerBlade()` does a clean `registry.set()` without the old broken `!import.meta.hot` guard
    - `clearRegistry()` export exists
    If these are already correct (they should be based on the debug report's fix section), no changes needed to this file.

    **Verify registrations/index.ts** already has:
    - `import { clearRegistry, getAllBladeTypes } from "../../../lib/bladeRegistry"`
    - `import.meta.hot.accept()` for self-accepting HMR
    - `import.meta.hot.dispose((data) => { data.isUpdate = true; clearRegistry(); })` handler
    - Exhaustiveness check guarded by `!import.meta.hot?.data?.isUpdate` to skip during HMR re-evaluation
    - No `console.debug` "All N blade types registered" message that fires every HMR cycle

    If the code already matches the resolved fix from the debug report, confirm it is correct. If any piece is missing or differs, apply the fix as described in `.planning/debug/hmr-registration-wave7.md` Resolution section.

    The key insight: `import.meta.hot` is always truthy in Vite dev mode (it's the HMR API object, not an "in update" flag). The correct pattern is: clear registry on dispose, re-register cleanly from fresh module execution, skip exhaustiveness noise via data flag.
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new TypeScript errors.
    During dev: Edit any file that triggers HMR (e.g., bladeUtils.tsx), no "[BladeRegistry] Duplicate registration" warnings in console.
  </verify>
  <done>HMR re-evaluation clears the registry before re-registration. No duplicate warnings or noisy console.debug messages during hot reload.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` produces no new errors
2. Open a .txt file from repo browser -- Monaco fills the blade
3. Open a .ts file -- Monaco fills the blade
4. Resize the window -- Monaco resizes (automaticLayout is already true)
5. During dev: trigger HMR by editing a component -- no duplicate registration warnings in console
</verification>

<success_criteria>
- Monaco editor renders at full height in ViewerCodeBlade for all text file types
- Browser console shows zero "[BladeRegistry] Duplicate registration" warnings during HMR
- No TypeScript compilation errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/22-new-content-blades/22-20-SUMMARY.md`
</output>
