---
phase: 35-github-read-operations
plan: 03
type: execute
wave: 2
depends_on: ["35-01", "35-02"]
files_modified:
  - src/extensions/github/blades/PullRequestListBlade.tsx
  - src/extensions/github/blades/PullRequestDetailBlade.tsx
  - src/extensions/github/blades/IssueListBlade.tsx
  - src/extensions/github/blades/IssueDetailBlade.tsx
  - src/extensions/github/index.ts
autonomous: false

must_haves:
  truths:
    - "User can view a list of pull requests showing title, author, status, and open any PR into a detail blade"
    - "PR detail blade shows description rendered as markdown, comments timeline, and PR stats (additions/deletions/files)"
    - "User can view a list of issues showing title, labels, and assignee with state filter tabs"
    - "Issue detail blade shows description rendered as markdown and comments timeline"
    - "PR and Issue toolbar buttons appear only when authenticated and a GitHub remote is detected"
    - "GitHub query cache is cleaned up on extension deactivation and repo switch"
    - "State filter tabs (Open/Closed/All) switch between issue/PR states with stale-while-revalidate"
  artifacts:
    - path: "src/extensions/github/blades/PullRequestListBlade.tsx"
      provides: "PR list blade with state filter tabs and Virtuoso infinite scroll"
      contains: "PullRequestListBlade"
    - path: "src/extensions/github/blades/PullRequestDetailBlade.tsx"
      provides: "PR detail blade with markdown description, stats, and comments"
      contains: "PullRequestDetailBlade"
    - path: "src/extensions/github/blades/IssueListBlade.tsx"
      provides: "Issue list blade with state filter tabs and Virtuoso infinite scroll"
      contains: "IssueListBlade"
    - path: "src/extensions/github/blades/IssueDetailBlade.tsx"
      provides: "Issue detail blade with markdown description and comments"
      contains: "IssueDetailBlade"
    - path: "src/extensions/github/index.ts"
      provides: "Extension registration for 4 new blades, 2 toolbar actions, 2 commands, cache cleanup"
      contains: "pull-requests"
  key_links:
    - from: "src/extensions/github/blades/PullRequestListBlade.tsx"
      to: "src/extensions/github/hooks/useGitHubQuery.ts"
      via: "usePullRequestList hook for data fetching"
      pattern: "usePullRequestList"
    - from: "src/extensions/github/blades/PullRequestListBlade.tsx"
      to: "src/extensions/github/blades/PullRequestDetailBlade.tsx"
      via: "openBlade navigation from list item click"
      pattern: "ext:github:pull-request"
    - from: "src/extensions/github/index.ts"
      to: "src/lib/toolbarRegistry.ts"
      via: "api.contributeToolbar for PR and Issues toolbar buttons"
      pattern: "contributeToolbar"
    - from: "src/extensions/github/index.ts"
      to: "src/lib/queryClient.ts"
      via: "queryClient.removeQueries for cache cleanup on deactivation"
      pattern: "removeQueries"
---

<objective>
Build the 4 GitHub blade components (PR list, PR detail, issue list, issue detail) and register everything through the extension system with toolbar contributions and cache cleanup.

Purpose: Delivers the user-facing features: browsing PRs and issues in dedicated blades. Completes all Phase 35 requirements (GH-05 through GH-08, TB-07). Includes a visual checkpoint for UX verification.

Output: 4 new blade components, updated extension index.ts with 4 blade registrations, 2 toolbar contributions, 2 command registrations, and cache cleanup on deactivation.
</objective>

<execution_context>
@C:/Users/matrayp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matrayp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-github-read-operations/35-RESEARCH.md
@.planning/phases/35-github-read-operations/35-RESEARCH-UX.md
@.planning/phases/35-github-read-operations/35-01-SUMMARY.md
@.planning/phases/35-github-read-operations/35-02-SUMMARY.md

# Key existing files to reference
@src/extensions/github/index.ts
@src/extensions/github/githubStore.ts
@src/extensions/github/hooks/useGitHubQuery.ts
@src/extensions/github/components/StatusBadge.tsx
@src/extensions/github/components/LabelPill.tsx
@src/extensions/github/components/UserAvatar.tsx
@src/extensions/github/components/TimeAgo.tsx
@src/extensions/github/components/CommentCard.tsx
@src/blades/_shared/BladeContentEmpty.tsx
@src/blades/_shared/BladeContentError.tsx
@src/blades/_shared/BladeContentLoading.tsx
@src/components/commit/CommitHistory.tsx
@src/components/markdown/MarkdownRenderer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PR and Issue list/detail blade components</name>
  <files>
    src/extensions/github/blades/PullRequestListBlade.tsx
    src/extensions/github/blades/PullRequestDetailBlade.tsx
    src/extensions/github/blades/IssueListBlade.tsx
    src/extensions/github/blades/IssueDetailBlade.tsx
  </files>
  <action>
**1. Create `PullRequestListBlade.tsx`:**

Component: `export function PullRequestListBlade()`

State: `const [stateFilter, setStateFilter] = useState<"open" | "closed" | "all">("open")`

Data: Use `usePullRequestList(remote.owner, remote.repo, stateFilter)` from `../hooks/useGitHubQuery`. Flatten pages: `const prs = query.data?.pages.flatMap(p => p.items) ?? []`.

Get remote from store: `const { detectedRemotes, selectedRemoteIndex } = useGitHubStore()`, `const remote = detectedRemotes[selectedRemoteIndex]`. If no remote, render `BladeContentEmpty` with icon=GitPullRequest, message="No GitHub remote detected".

Get `openBlade` from `useBladeNavigation()` hook (import from `../../../hooks/useBladeNavigation`).

Layout structure (top to bottom):
1. **Remote selector** (only if `detectedRemotes.length > 1`): A small dropdown in the header showing `{owner}/{repo}` with options for each detected remote. Calls `useGitHubStore.getState().setSelectedRemote(index)`.
2. **Filter tabs**: Horizontal pill tabs for Open / Closed / All. Use `role="tablist"` with `role="tab"` buttons. Active tab: `bg-ctp-surface1 text-ctp-text font-medium`. Inactive: `text-ctp-overlay0 hover:text-ctp-subtext1 hover:bg-ctp-surface0`. Each button calls `setStateFilter(filter)`.
3. **List area**: `flex-1 min-h-0` div containing either:
   - `BladeContentLoading` if `query.isLoading`
   - `BladeContentError` with retry if `query.error`
   - `BladeContentEmpty` if `prs.length === 0`
   - `Virtuoso` list (from `react-virtuoso`) with:
     - `data={prs}`
     - `endReached` callback that calls `query.fetchNextPage()` if `query.hasNextPage && !query.isFetchingNextPage`
     - `itemContent` renders each PR as a clickable row:
       - `<button type="button" onClick={() => openBlade("ext:github:pull-request", { owner: remote.owner, repo: remote.repo, number: pr.number }, `#${pr.number} ${pr.title}`)}>`
       - Two-line layout: StatusBadge on left, title + metadata on right
       - Line 1: `<StatusBadge state={pr.state} merged={pr.merged} draft={pr.draft} />` + title (truncated)
       - Line 2: `#{number}` + author + TimeAgo + label pills (max 3, using LabelPill)
       - Styling: `w-full text-left px-3 py-2.5 border-b border-ctp-surface0 hover:bg-ctp-surface0/50 transition-colors`
     - Footer component showing Loader2 spinner when `isFetchingNextPage`

**2. Create `PullRequestDetailBlade.tsx`:**

Props: `{ owner: string; repo: string; number: number }`

Data: Use `usePullRequestDetail(owner, repo, number)` from `../hooks/useGitHubQuery`.

Layout (scrollable column `h-full overflow-y-auto`):
1. **Header section** (`px-4 py-4 border-b border-ctp-surface0`):
   - Title: `<h2 className="text-base font-semibold text-ctp-text">{data.title}</h2>`
   - Status row: StatusBadge + `#{number}` + author + TimeAgo
   - Branch info: `{data.headRef} -> {data.baseRef}` in `text-xs text-ctp-overlay0`
   - Stats row: `+{additions}` in green, `-{deletions}` in red, `{changedFiles} files` in gray, `{commits} commits`
   - Labels row: All labels rendered as LabelPill

2. **Description section** (`px-4 py-4 border-b border-ctp-surface0`):
   - If `data.body` is non-empty: `<MarkdownRenderer content={data.body} />`
   - If empty: `<p className="text-sm text-ctp-overlay0 italic">No description provided.</p>`

3. **Comments section** (`px-4 py-4`):
   - Header: `<h3 className="text-sm font-medium text-ctp-subtext1 mb-3">Comments ({data.comments.length})</h3>`
   - For each comment: `<CommentCard key={comment.id} {...comment} />`
   - If no comments: `<p className="text-sm text-ctp-overlay0">No comments yet.</p>`

4. **Open on GitHub link** at the bottom:
   - `<a href={data.htmlUrl} target="_blank" rel="noopener noreferrer">` styled as a subtle link
   - Opens in external browser (Tauri handles `target="_blank"` links via the opener plugin)

Loading/error states: Use `BladeContentLoading` and `BladeContentError` with retry.

**3. Create `IssueListBlade.tsx`:**

Same structure as PullRequestListBlade but:
- Uses `useIssueList(remote.owner, remote.repo, stateFilter)` hook
- Filter tabs: Open / Closed / All (no "Merged" -- issues don't merge)
- Each row shows: StatusBadge (type="issue"), title, `#{number}`, author, TimeAgo, labels (LabelPill), assignee logins (text list)
- Click opens: `openBlade("ext:github:issue", { owner: remote.owner, repo: remote.repo, number: issue.number }, `#${issue.number} ${issue.title}`)`
- Icon for empty state: `CircleDot` (not GitPullRequest)

**4. Create `IssueDetailBlade.tsx`:**

Same structure as PullRequestDetailBlade but:
- Uses `useIssueDetail(owner, repo, number)` hook
- No branch info, no stats row (additions/deletions/commits/changedFiles)
- Shows: StatusBadge (type="issue"), title, author, TimeAgo
- Metadata section: labels, assignees (with UserAvatar + login), milestone if present
- Description + comments sections same as PR detail

For both detail blades, ensure proper handling of empty body (`data.body === ""` -> show italic placeholder) and zero comments.
  </action>
  <verify>Run `npx tsc --noEmit`. All 4 blade components compile. Verify import paths are correct for hooks, shared components, blade _shared components, and MarkdownRenderer.</verify>
  <done>4 blade components created: PullRequestListBlade (infinite scroll, state filter, Virtuoso), PullRequestDetailBlade (header, markdown body, comments), IssueListBlade (same pattern), IssueDetailBlade (same pattern). All compose from shared components built in Plan 02.</done>
</task>

<task type="auto">
  <name>Task 2: Register blades, toolbar actions, commands, and cache cleanup in extension index</name>
  <files>
    src/extensions/github/index.ts
  </files>
  <action>
**Update `src/extensions/github/index.ts`:**

**1. Add lazy imports for new components at module level:**

Add alongside existing lazy imports:
```typescript
let PullRequestListBlade: React.ComponentType<any> | null = null;
let PullRequestDetailBlade: React.ComponentType<any> | null = null;
let IssueListBlade: React.ComponentType<any> | null = null;
let IssueDetailBlade: React.ComponentType<any> | null = null;
```

**2. Extend `ensureComponents()` to load new blade components:**

Add dynamic imports:
```typescript
if (!PullRequestListBlade) {
  const mod = await import("./blades/PullRequestListBlade");
  PullRequestListBlade = mod.PullRequestListBlade;
}
if (!PullRequestDetailBlade) {
  const mod = await import("./blades/PullRequestDetailBlade");
  PullRequestDetailBlade = mod.PullRequestDetailBlade;
}
if (!IssueListBlade) {
  const mod = await import("./blades/IssueListBlade");
  IssueListBlade = mod.IssueListBlade;
}
if (!IssueDetailBlade) {
  const mod = await import("./blades/IssueDetailBlade");
  IssueDetailBlade = mod.IssueDetailBlade;
}
```

**3. Register 4 new blades in `onActivate()`:**

Add after the existing blade registrations:
```typescript
api.registerBlade({
  type: "pull-requests",
  title: "Pull Requests",
  component: PullRequestListBlade!,
  singleton: true,
  wrapInPanel: true,
  showBack: true,
});

api.registerBlade({
  type: "pull-request",
  title: "Pull Request",
  component: PullRequestDetailBlade!,
  singleton: false,  // Multiple PR details can be open
  wrapInPanel: true,
  showBack: true,
});

api.registerBlade({
  type: "issues",
  title: "Issues",
  component: IssueListBlade!,
  singleton: true,
  wrapInPanel: true,
  showBack: true,
});

api.registerBlade({
  type: "issue",
  title: "Issue",
  component: IssueDetailBlade!,
  singleton: false,  // Multiple issue details can be open
  wrapInPanel: true,
  showBack: true,
});
```

**4. Register 2 new commands in `onActivate()`:**

Add after existing commands:
```typescript
api.registerCommand({
  id: "open-pull-requests",
  title: "View Pull Requests",
  category: "GitHub",
  icon: GitPullRequest,
  action: () => {
    const remote = getSelectedRemote();
    if (remote) openBlade("ext:github:pull-requests", { owner: remote.owner, repo: remote.repo });
  },
  enabled: () => useGitHubStore.getState().isAuthenticated && useGitHubStore.getState().detectedRemotes.length > 0,
});

api.registerCommand({
  id: "open-issues",
  title: "View Issues",
  category: "GitHub",
  icon: CircleDot,
  action: () => {
    const remote = getSelectedRemote();
    if (remote) openBlade("ext:github:issues", { owner: remote.owner, repo: remote.repo });
  },
  enabled: () => useGitHubStore.getState().isAuthenticated && useGitHubStore.getState().detectedRemotes.length > 0,
});
```

Import `GitPullRequest` and `CircleDot` from `lucide-react`. Import `getSelectedRemote` from `./githubStore`.

**5. Contribute 2 toolbar actions in `onActivate()` (TB-07):**

Add after existing toolbar contribution:
```typescript
api.contributeToolbar({
  id: "open-pull-requests",
  label: "Pull Requests",
  icon: GitPullRequest,
  group: "views",
  priority: 50,
  when: () => {
    const { isAuthenticated, detectedRemotes } = useGitHubStore.getState();
    return isAuthenticated && detectedRemotes.length > 0;
  },
  execute: () => {
    const remote = getSelectedRemote();
    if (remote) openBlade("ext:github:pull-requests", { owner: remote.owner, repo: remote.repo });
  },
});

api.contributeToolbar({
  id: "open-issues",
  label: "Issues",
  icon: CircleDot,
  group: "views",
  priority: 45,
  when: () => {
    const { isAuthenticated, detectedRemotes } = useGitHubStore.getState();
    return isAuthenticated && detectedRemotes.length > 0;
  },
  execute: () => {
    const remote = getSelectedRemote();
    if (remote) openBlade("ext:github:issues", { owner: remote.owner, repo: remote.repo });
  },
});
```

**6. Add cache cleanup to `onDeactivate()`:**

Add import at top of file: `import { queryClient } from "../../lib/queryClient";`

In `onDeactivate()`, after `cancelGitHubPolling()`:
```typescript
// Clean up ALL cached GitHub API data
queryClient.removeQueries({ queryKey: ["ext:github"] });
```

**7. Add cache cleanup on repo switch:**

In the existing repo change subscriber (the `useRepositoryStore.subscribe` callback), when `currentPath !== prevRepoPath` and switching to a new repo or closing, add before the `detectRemotes()` call:
```typescript
// Clear cached GitHub data from previous repo
queryClient.removeQueries({ queryKey: ["ext:github"] });
```
  </action>
  <verify>Run `npx tsc --noEmit`. Extension index compiles. Verify: 6 total blade registrations (2 existing + 4 new), 4 total commands (2 existing + 2 new), 3 total toolbar contributions (1 existing + 2 new). Verify cache cleanup in onDeactivate and repo switch.</verify>
  <done>Extension index updated: 4 new blade registrations, 2 new command registrations, 2 new toolbar contributions (in "views" group with auth+remote visibility conditions). Cache cleanup via queryClient.removeQueries on deactivation and repo switch. All registrations use lazy-loaded components via dynamic imports.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify PR and Issue blades visually</name>
  <files>src/extensions/github/</files>
  <action>
    Human verification of the complete GitHub PR and issue browsing feature.
    What was built:
    - 4 new blade types: PR list, PR detail, issue list, issue detail
    - 2 toolbar buttons (Pull Requests, Issues) in views group with auth+remote visibility
    - 2 command palette entries under GitHub category
    - 5 shared UI components (StatusBadge, LabelPill, UserAvatar, TimeAgo, CommentCard)
    - TanStack Query hooks with ext:github cache isolation
    - Cache cleanup on extension deactivation and repo switch
  </action>
  <verify>
    1. Run `npm run tauri dev` to start the app
    2. Open a repository that has a GitHub remote (e.g., FlowForge itself)
    3. Sign in to GitHub if not already authenticated (click GitHub icon in toolbar)
    4. After authentication, verify two new toolbar buttons appear: "Pull Requests" (GitPullRequest icon) and "Issues" (CircleDot icon) in the views group
    5. Click "Pull Requests" toolbar button:
       - PR list blade opens with state filter tabs (Open/Closed/All)
       - Each PR shows: status badge (open/closed/merged/draft), title, #number, author, relative time, label pills
       - Switch between Open/Closed/All tabs -- data loads with stale-while-revalidate
       - Scroll down -- infinite scroll loads more PRs if available
    6. Click any PR row:
       - PR detail blade opens with header (title, status, branch info, stats)
       - Description rendered as markdown (verify code blocks, links, formatting work)
       - Comments section shows each comment with avatar, author, time, and markdown body
    7. Navigate back (blade strip or back button) -- returns to PR list
    8. Click "Issues" toolbar button:
       - Issue list blade opens with state filter tabs (Open/Closed/All)
       - Issues show: status badge, title, #number, labels, assignees
       - PRs are NOT shown in the issues list (they are filtered out)
    9. Click any issue row:
       - Issue detail blade opens with header, labels, assignees
       - Description and comments rendered correctly
    10. Open command palette (Cmd/Ctrl+K): verify "View Pull Requests" and "View Issues" commands appear under GitHub category
    11. Close repository -- toolbar buttons should disappear. Re-open -- they reappear after remote detection
  </verify>
  <done>All 5 Phase 35 requirements verified: GH-05 (PR list), GH-06 (PR detail with description/comments), GH-07 (issue list with filters), GH-08 (issue detail with description/comments), TB-07 (extension toolbar actions in views group). Visual appearance matches Catppuccin theming. Cache lifecycle works correctly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `cargo check` passes (no Rust regressions)
3. PR list shows correct data from GitHub API
4. PR detail renders markdown description and comments
5. Issue list correctly filters out PRs
6. Issue detail renders markdown description and comments
7. Toolbar buttons appear only when authenticated + GitHub remote detected
8. Command palette shows "View Pull Requests" and "View Issues" under GitHub category
9. Cache cleanup works: close repo -> reopen -> no stale data from previous repo
10. Filter tabs switch between Open/Closed/All without full page reload
</verification>

<success_criteria>
- GH-05: User can view PR list with title, author, status (open/closed/merged/draft)
- GH-06: User can open PR detail blade with description (markdown), comments, and stats
- GH-07: User can view issue list with title, labels, assignee, and filter tabs
- GH-08: User can open issue detail blade with description (markdown) and comments
- TB-07: Extensions contribute toolbar actions through the same registry as core actions (2 buttons in views group)
- Toolbar actions visible only when authenticated and GitHub remote detected
- Query cache cleaned up on extension deactivation and repo switch
</success_criteria>

<output>
After completion, create `.planning/phases/35-github-read-operations/35-03-SUMMARY.md`
</output>
