---
phase: 35-github-read-operations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/github/components/StatusBadge.tsx
  - src/extensions/github/components/LabelPill.tsx
  - src/extensions/github/components/UserAvatar.tsx
  - src/extensions/github/components/TimeAgo.tsx
  - src/extensions/github/components/CommentCard.tsx
  - src/extensions/github/hooks/useGitHubQuery.ts
  - src/extensions/github/githubStore.ts
autonomous: true

must_haves:
  truths:
    - "StatusBadge renders open/closed/merged/draft states with correct icons and semantic colors"
    - "LabelPill renders GitHub labels with dynamic hex colors via inline styles"
    - "UserAvatar displays GitHub avatar images with fallback initials"
    - "TimeAgo computes and displays human-readable relative timestamps"
    - "CommentCard renders a comment with avatar, author, timestamp, and markdown body"
    - "TanStack Query hooks provide type-safe data fetching with cache isolation via ext:github prefix"
    - "GitHub store has selectedRemoteIndex for multi-remote support"
  artifacts:
    - path: "src/extensions/github/components/StatusBadge.tsx"
      provides: "Open/closed/merged/draft badge with icon and color"
      contains: "StatusBadge"
    - path: "src/extensions/github/components/LabelPill.tsx"
      provides: "Colored label pill with dynamic GitHub hex colors"
      contains: "LabelPill"
    - path: "src/extensions/github/components/CommentCard.tsx"
      provides: "Comment display with avatar, markdown body, timestamp"
      contains: "CommentCard"
    - path: "src/extensions/github/hooks/useGitHubQuery.ts"
      provides: "TanStack Query hooks for PR list, PR detail, issue list, issue detail"
      exports: ["usePullRequestList", "usePullRequestDetail", "useIssueList", "useIssueDetail"]
  key_links:
    - from: "src/extensions/github/hooks/useGitHubQuery.ts"
      to: "src/bindings.ts"
      via: "commands import for Tauri IPC calls"
      pattern: "commands\\.github"
    - from: "src/extensions/github/components/CommentCard.tsx"
      to: "src/components/markdown/MarkdownRenderer.tsx"
      via: "MarkdownRenderer for comment body rendering"
      pattern: "MarkdownRenderer"
---

<objective>
Build the shared frontend components and TanStack Query hooks for GitHub PR/issue display.

Purpose: Creates reusable, composable UI primitives (StatusBadge, LabelPill, UserAvatar, TimeAgo, CommentCard) that are used by both PR and issue blades, and could be reused by future extensions. Also creates the TanStack Query hooks that wire up to the Rust commands with proper cache key namespacing.

Output: 5 new shared components, 1 hooks file with 4 query hooks, extended githubStore with selectedRemoteIndex.
</objective>

<execution_context>
@C:/Users/matrayp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matrayp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-github-read-operations/35-RESEARCH.md
@.planning/phases/35-github-read-operations/35-RESEARCH-UX.md
@.planning/phases/35-github-read-operations/35-RESEARCH-DEVELOPER.md

# Key existing files to reference
@src/extensions/github/githubStore.ts
@src/extensions/github/components/GitHubStatusButton.tsx
@src/components/markdown/MarkdownRenderer.tsx
@src/blades/_shared/BladeContentEmpty.tsx
@src/blades/_shared/BladeContentError.tsx
@src/blades/_shared/BladeContentLoading.tsx
@src/components/commit/CommitHistory.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared GitHub UI components (StatusBadge, LabelPill, UserAvatar, TimeAgo, CommentCard)</name>
  <files>
    src/extensions/github/components/StatusBadge.tsx
    src/extensions/github/components/LabelPill.tsx
    src/extensions/github/components/UserAvatar.tsx
    src/extensions/github/components/TimeAgo.tsx
    src/extensions/github/components/CommentCard.tsx
  </files>
  <action>
**1. Create `StatusBadge.tsx`:**

Props: `{ state: string; merged?: boolean; draft?: boolean; type?: "pr" | "issue" }` (type defaults to "pr").

Renders a pill-shaped badge with icon + text. Uses Catppuccin colors with 15% opacity backgrounds:
- If PR:
  - merged: icon=`GitMerge`, text="Merged", color=`ctp-mauve` (bg-ctp-mauve/15 text-ctp-mauve)
  - draft: icon=`GitPullRequestDraft`, text="Draft", color=`ctp-overlay0` (bg-ctp-overlay0/15 text-ctp-overlay0)
  - open: icon=`GitPullRequest`, text="Open", color=`ctp-green` (bg-ctp-green/15 text-ctp-green)
  - closed (not merged): icon=`GitPullRequestClosed`, text="Closed", color=`ctp-red` (bg-ctp-red/15 text-ctp-red)
- If issue:
  - open: icon=`CircleDot`, text="Open", color=`ctp-green`
  - closed: icon=`CheckCircle2`, text="Closed", color=`ctp-mauve`

Badge structure: `<span className="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium rounded-full {bg} {text}"><Icon className="w-3 h-3" />{label}</span>`

Include `aria-label` with the status text.

Import icons from `lucide-react`: `GitPullRequest`, `GitPullRequestClosed`, `GitPullRequestDraft`, `GitMerge`, `CircleDot`, `CheckCircle2`.

**2. Create `LabelPill.tsx`:**

Props: `{ name: string; color: string }` -- color is 6-char hex WITHOUT the `#` prefix (GitHub API format).

Calculate background color: `#${color}20` (12.5% opacity). Text color: `#${color}`. Border: `1px solid #${color}40`.

For very light colors, compute luminance: `(0.299 * r + 0.587 * g + 0.114 * b) / 255`. If luminance > 0.7, darken the text slightly by using `color-mix` or just accept GitHub's color.

Use INLINE `style` attribute for colors (Tailwind cannot generate arbitrary dynamic hex colors at build time). Use Tailwind only for structural classes: `inline-flex items-center px-1.5 py-0.5 text-[10px] font-medium rounded-full whitespace-nowrap`.

**3. Create `UserAvatar.tsx`:**

Props: `{ login: string; avatarUrl: string; size?: "sm" | "md" }`.

Sizes: sm=`w-5 h-5`, md=`w-7 h-7`. Default: `sm`.

Render an `<img>` with `src={avatarUrl}`, `alt={login}`, `className="rounded-full"` and the size class. Add `loading="lazy"` for performance.

Include an `onError` handler that replaces the image with a fallback: a colored circle with the first letter of the login name, centered. Use `bg-ctp-surface1 text-ctp-subtext0` for the fallback.

**4. Create `TimeAgo.tsx`:**

Props: `{ date: string; className?: string }` -- date is an ISO 8601 string from the GitHub API.

Compute relative time from `new Date(date)`:
- < 1 min: "just now"
- < 60 min: "{n}m ago"
- < 24 hours: "{n}h ago"
- < 7 days: "{n}d ago"
- < 30 days: "{n}w ago"
- < 365 days: "{n}mo ago"
- else: "{n}y ago"

Render as `<time dateTime={date} title={new Date(date).toLocaleString()} className={cn("text-xs text-ctp-overlay0", className)}>{relativeText}</time>`.

Do NOT use `setInterval` for updates -- the timestamp is re-rendered when the parent re-renders (from query refetch). This avoids unnecessary timers.

**5. Create `CommentCard.tsx`:**

Props: `{ authorLogin: string; authorAvatarUrl: string; body: string; createdAt: string; htmlUrl: string }`.

Structure:
```
<div className="bg-ctp-surface0/30 rounded-lg p-3">
  <div className="flex items-center gap-2 mb-2">
    <UserAvatar login={authorLogin} avatarUrl={authorAvatarUrl} size="sm" />
    <span className="text-sm font-medium text-ctp-text">{authorLogin}</span>
    <TimeAgo date={createdAt} />
  </div>
  <div className="prose-sm">
    <MarkdownRenderer content={body} />
  </div>
</div>
```

Import `MarkdownRenderer` from `../../../components/markdown/MarkdownRenderer`. Import `UserAvatar` and `TimeAgo` from the same components directory.
  </action>
  <verify>Run `npx tsc --noEmit` (or `npm run type-check` if available). All 5 components compile without type errors. Visually inspect that imports resolve correctly.</verify>
  <done>5 shared components created: StatusBadge (4 PR states + 2 issue states), LabelPill (dynamic GitHub colors), UserAvatar (image + fallback), TimeAgo (relative timestamps), CommentCard (avatar + markdown body). All follow existing Catppuccin theming conventions.</done>
</task>

<task type="auto">
  <name>Task 2: Create TanStack Query hooks and extend githubStore with selectedRemoteIndex</name>
  <files>
    src/extensions/github/hooks/useGitHubQuery.ts
    src/extensions/github/githubStore.ts
  </files>
  <action>
**1. Create `src/extensions/github/hooks/useGitHubQuery.ts`:**

Create a module with 4 exported hooks. All query keys use the `"ext:github"` prefix for cache isolation (matches convention from research).

Import `useQuery` and `useInfiniteQuery` from `@tanstack/react-query`. Import `commands` from `../../../bindings`.

**IMPORTANT: Tauri command results use the `{ status: "ok", data } | { status: "error", error }` discriminated union pattern.** All hooks must check `result.status` and throw on error for TanStack Query to handle it correctly. Extract error messages with: `"message" in result.error ? result.error.message : result.error.type`.

`export function usePullRequestList(owner: string, repo: string, state: "open" | "closed" | "all" = "open")`:
- Uses `useInfiniteQuery`
- queryKey: `["ext:github", "pullRequests", owner, repo, state]`
- queryFn receives `{ pageParam }`, calls `commands.githubListPullRequests(owner, repo, state, pageParam, 30)`, checks result.status, returns result.data
- getNextPageParam: `(lastPage) => lastPage.hasNextPage ? lastPage.nextPage : undefined`
- initialPageParam: `1`
- staleTime: `2 * 60 * 1000` (2 minutes)
- enabled: `!!owner && !!repo`

`export function usePullRequestDetail(owner: string, repo: string, number: number)`:
- Uses `useQuery`
- queryKey: `["ext:github", "pullRequest", owner, repo, number]`
- queryFn calls `commands.githubGetPullRequest(owner, repo, number)`, checks result.status, returns result.data
- staleTime: `60 * 1000` (1 minute)
- enabled: `!!owner && !!repo && number > 0`

`export function useIssueList(owner: string, repo: string, state: "open" | "closed" | "all" = "open")`:
- Uses `useInfiniteQuery`
- queryKey: `["ext:github", "issues", owner, repo, state]`
- queryFn calls `commands.githubListIssues(owner, repo, state, pageParam, 30)`, checks result.status, returns result.data
- Same pagination pattern as PR list
- staleTime: `2 * 60 * 1000`
- enabled: `!!owner && !!repo`

`export function useIssueDetail(owner: string, repo: string, number: number)`:
- Uses `useQuery`
- queryKey: `["ext:github", "issue", owner, repo, number]`
- queryFn calls `commands.githubGetIssue(owner, repo, number)`, checks result.status, returns result.data
- staleTime: `60 * 1000`
- enabled: `!!owner && !!repo && number > 0`

**2. Extend `src/extensions/github/githubStore.ts`:**

Add to `GitHubState` interface:
```typescript
selectedRemoteIndex: number;
setSelectedRemote: (index: number) => void;
```

Add to initial state in create():
```typescript
selectedRemoteIndex: 0,
```

Add action:
```typescript
setSelectedRemote: (index: number) => {
  set({ selectedRemoteIndex: index }, false, "github/set-selected-remote");
},
```

Reset `selectedRemoteIndex` to 0 in `resetRemotes`:
```typescript
resetRemotes: () => {
  set({ detectedRemotes: [], selectedRemoteIndex: 0 }, false, "github/reset-remotes");
},
```

Add a convenience function export (outside the store):
```typescript
export function getSelectedRemote(): GitHubRemote | null {
  const state = useGitHubStore.getState();
  return state.detectedRemotes[state.selectedRemoteIndex] ?? null;
}
```
  </action>
  <verify>Run `npx tsc --noEmit`. All hooks compile. The query key convention uses "ext:github" prefix. Verify githubStore extends cleanly with selectedRemoteIndex.</verify>
  <done>4 TanStack Query hooks created with ext:github query key prefix for cache isolation. githubStore extended with selectedRemoteIndex for multi-remote support. All hooks follow the existing Tauri command result pattern (status check + error extraction).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (or `npm run type-check`)
2. All 5 components export named components (not default exports)
3. All 4 hooks export named hooks
4. Query keys all start with "ext:github" prefix
5. githubStore has selectedRemoteIndex with getter helper
6. No new npm dependencies added
</verification>

<success_criteria>
- StatusBadge handles all 4 PR states (open, closed, merged, draft) and 2 issue states (open, closed)
- LabelPill uses inline style for dynamic GitHub hex colors (not Tailwind classes)
- CommentCard correctly imports and uses MarkdownRenderer for markdown body rendering
- All TanStack Query hooks check result.status and throw on error
- Query staleTime: 2 minutes for lists, 1 minute for details
- useInfiniteQuery hooks have proper getNextPageParam and initialPageParam
- githubStore.selectedRemoteIndex resets to 0 when remotes are cleared
</success_criteria>

<output>
After completion, create `.planning/phases/35-github-read-operations/35-02-SUMMARY.md`
</output>
