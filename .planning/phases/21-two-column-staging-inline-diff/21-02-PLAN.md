---
phase: 21-two-column-staging-inline-diff
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/components/staging/InlineDiffViewer.tsx
  - src/components/staging/DiffPreviewHeader.tsx
  - src/components/staging/NonTextPlaceholder.tsx
  - src/components/staging/StagingDiffPreview.tsx
autonomous: true

must_haves:
  truths:
    - "InlineDiffViewer renders a Monaco DiffEditor in compact inline mode for text files"
    - "DiffPreviewHeader shows file path with expand button and optional prev/next navigation"
    - "NonTextPlaceholder shows file type icon with descriptive message and expand button for binary/image files"
    - "StagingDiffPreview orchestrates correct renderer based on file type via preview registry"
  artifacts:
    - path: "src/components/staging/InlineDiffViewer.tsx"
      provides: "Monaco DiffEditor in compact inline mode with debounced source switching"
      exports: ["InlineDiffViewer"]
    - path: "src/components/staging/DiffPreviewHeader.tsx"
      provides: "Header bar with file path, expand button, and optional prev/next navigation"
      exports: ["DiffPreviewHeader"]
    - path: "src/components/staging/NonTextPlaceholder.tsx"
      provides: "Placeholder for non-text files with icon, message, and expand button"
      exports: ["NonTextPlaceholder"]
    - path: "src/components/staging/StagingDiffPreview.tsx"
      provides: "Orchestrator that routes to correct preview based on file type"
      exports: ["StagingDiffPreview"]
  key_links:
    - from: "src/components/staging/StagingDiffPreview.tsx"
      to: "src/lib/previewRegistry.ts"
      via: "getPreviewForFile() determines rendering mode"
      pattern: "getPreviewForFile"
    - from: "src/components/staging/InlineDiffViewer.tsx"
      to: "commands.getFileDiff"
      via: "useQuery fetches diff data from Tauri backend"
      pattern: "getFileDiff"
    - from: "src/components/staging/StagingDiffPreview.tsx"
      to: "src/components/staging/InlineDiffViewer.tsx"
      via: "renders InlineDiffViewer for text files"
      pattern: "InlineDiffViewer"
---

<objective>
Create the four diff preview components that will populate the right panel of the two-column staging layout: InlineDiffViewer (Monaco DiffEditor in compact mode), DiffPreviewHeader (file path + expand button), NonTextPlaceholder (binary/image placeholder), and StagingDiffPreview (orchestrator).

Purpose: These components render the file diff preview. They read from the staging store's selected file and render the appropriate preview. The orchestrator uses the preview registry from Plan 01.

Output: 4 new files. These components are self-contained and not yet wired into the staging blade (that happens in Plan 03).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-two-column-staging-inline-diff/21-01-SUMMARY.md
@src/components/blades/DiffBlade.tsx
@src/lib/monacoTheme.ts
@src/lib/previewRegistry.ts
@src/lib/fileTypeUtils.ts
@src/bindings.ts
@.planning/phases/21-two-column-staging-inline-diff/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InlineDiffViewer with Monaco DiffEditor in compact inline mode</name>
  <files>
    src/components/staging/InlineDiffViewer.tsx
  </files>
  <action>
Create `src/components/staging/InlineDiffViewer.tsx` -- a compact Monaco DiffEditor for the inline diff preview panel.

**Props interface:**
```typescript
interface InlineDiffViewerProps {
  filePath: string;
  staged: boolean;
  onScrollPositionChange?: (scrollTop: number) => void;
  initialScrollTop?: number;
}
```

**Implementation:**

1. **Debounced source:** Use a local `useState` + `useEffect` with 150ms timeout to debounce the `filePath`/`staged` pair. This prevents firing diff queries during rapid keyboard navigation. Store the debounced values as `debouncedFilePath` and `debouncedStaged`.

2. **Query:** Use `useQuery` with:
   - queryKey: `["fileDiff", debouncedFilePath, debouncedStaged, 3]`
   - queryFn: `() => commands.getFileDiff(debouncedFilePath, debouncedStaged, 3)`
   - staleTime: 5000 (avoid refetch flicker during rapid navigation)
   - enabled: `!!debouncedFilePath`

3. **Monaco options (INLINE_DIFF_OPTIONS):**
   ```typescript
   {
     readOnly: true,
     originalEditable: false,
     renderSideBySide: false,     // Always inline in preview
     automaticLayout: true,       // Auto-resize on panel drag
     scrollBeyondLastLine: false,
     minimap: { enabled: false },
     fontSize: 12,
     lineNumbers: "on",
     folding: false,
     wordWrap: "on",              // Prevent horizontal scroll in narrow panel
     renderLineHighlight: "none",
     scrollbar: { verticalScrollbarSize: 8, horizontalScrollbarSize: 8 },
     overviewRulerBorder: false,
     renderOverviewRuler: false,
     glyphMargin: false,
     lineDecorationsWidth: 0,
     lineNumbersMinChars: 3,
   }
   ```

4. **Loading state:** Show a centered `Loader2` spinner with `animate-spin text-ctp-overlay1` in a `bg-ctp-mantle` container. Do NOT wrap Monaco in AnimatePresence (causes mount/unmount which destroys the editor). Instead, show the loading overlay absolutely positioned over the editor area.

5. **Error state:** Show centered `text-ctp-red text-sm` "Failed to load diff".

6. **Editor mount callback:** Capture the modified editor ref via `onMount`. Use it to restore `initialScrollTop` if provided (via `editor.setScrollTop()`). Track scroll position changes to call `onScrollPositionChange`.

7. **Binary detection:** If `diff.isBinary` is true, render nothing (the parent StagingDiffPreview handles binary detection). But as a safety net, show "Binary file" text.

Import `DiffEditor` from `@monaco-editor/react`, `useQuery` from `@tanstack/react-query`, `commands` from `../../bindings`, and `../../lib/monacoTheme` for side-effect (theme registration). Use `Loader2` from `lucide-react`.
  </action>
  <verify>
`npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors.
  </verify>
  <done>
InlineDiffViewer component renders a Monaco DiffEditor with compact options, debounced source switching, loading overlay, and scroll position tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DiffPreviewHeader, NonTextPlaceholder, and StagingDiffPreview orchestrator</name>
  <files>
    src/components/staging/DiffPreviewHeader.tsx
    src/components/staging/NonTextPlaceholder.tsx
    src/components/staging/StagingDiffPreview.tsx
  </files>
  <action>
**1. Create `src/components/staging/DiffPreviewHeader.tsx`:**

Props:
```typescript
interface DiffPreviewHeaderProps {
  filePath: string;
  onExpand: () => void;
  onPrev?: () => void;
  onNext?: () => void;
  hasPrev?: boolean;
  hasNext?: boolean;
}
```

Render a header bar: `flex items-center gap-2 px-3 py-1.5 border-b border-ctp-surface0 bg-ctp-crust shrink-0`

Content:
- Left: `FileTypeIcon` (from `../icons/FileTypeIcon`) for the file, `w-4 h-4 shrink-0`
- Center: File path with directory in `text-ctp-overlay1` and filename in `font-semibold text-ctp-text`. Truncate with `truncate flex-1 text-sm`. Split on last `/` to separate dir from filename.
- Right: Expand button using `Maximize2` icon from lucide-react. Style: `p-1 rounded hover:bg-ctp-surface0 text-ctp-overlay1 hover:text-ctp-text transition-colors`. Add `title="Expand to full view"` and `aria-label="Expand diff to full view"`.
- Optional prev/next: If `onPrev`/`onNext` provided, render `ChevronLeft`/`ChevronRight` buttons before the expand button. Disable when `!hasPrev`/`!hasNext` with `disabled:opacity-30`.

**2. Create `src/components/staging/NonTextPlaceholder.tsx`:**

Props:
```typescript
interface NonTextPlaceholderProps {
  icon: ComponentType<{ className?: string }>;
  message: string;
  onExpand: () => void;
}
```

Render a centered placeholder: `flex-1 flex flex-col items-center justify-center gap-3 bg-ctp-mantle`
- Icon: render the passed `icon` component with `w-10 h-10 text-ctp-overlay1`
- Message: `text-sm text-ctp-overlay1`
- Button: "Open in Full View" using `Maximize2` icon, styled with `px-3 py-1.5 text-sm rounded bg-ctp-surface0 hover:bg-ctp-surface1 text-ctp-text transition-colors flex items-center gap-1.5`

**3. Create `src/components/staging/StagingDiffPreview.tsx`:**

Props:
```typescript
interface StagingDiffPreviewProps {
  file: FileChange | null;
  section: "staged" | "unstaged" | "untracked" | null;
  onExpand: () => void;
  onNavigateFile?: (direction: "next" | "prev") => void;
  hasPrev?: boolean;
  hasNext?: boolean;
}
```

Implementation:
1. Import `getPreviewForFile` from `../../lib/previewRegistry` and ensure `../../components/staging/previewRegistrations` is imported for side-effects (registers default previews).
2. Import `InlineDiffViewer`, `DiffPreviewHeader`, `NonTextPlaceholder`.
3. Import `useStagingStore` to read/write scroll positions.

Rendering logic:
- If `!file`: render an empty state -- centered text "Select a file to preview diff" in `text-ctp-overlay0 text-sm` on `bg-ctp-mantle`. (This should not happen with auto-select but is defensive.)
- Get preview registration: `const preview = getPreviewForFile(file.path)`
- If `preview?.mode === "placeholder"` and `preview.placeholder`: render `DiffPreviewHeader` + `NonTextPlaceholder` with the registration's icon and message.
- Otherwise (mode is "inline-diff" or unmatched): render `DiffPreviewHeader` + `InlineDiffViewer` with `filePath={file.path}` and `staged={section === "staged"}`.

Pass scroll position props to InlineDiffViewer:
- `initialScrollTop={scrollPositions[file.path] ?? 0}` from staging store
- `onScrollPositionChange={(top) => saveScrollPosition(file.path, top)}` to staging store

Pass navigation to DiffPreviewHeader:
- `onPrev={() => onNavigateFile?.("prev")}` if `onNavigateFile` provided
- `onNext={() => onNavigateFile?.("next")}` if provided
- `hasPrev`, `hasNext` from props

Wrap the entire component in `flex flex-col h-full`.
  </action>
  <verify>
`npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors.
  </verify>
  <done>
All four diff preview components exist and compile. StagingDiffPreview orchestrates rendering based on file type via the preview registry. InlineDiffViewer shows Monaco DiffEditor for text files. NonTextPlaceholder shows icon+message for binary/image files. DiffPreviewHeader shows file path with expand button.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` passes with no new errors
2. All 4 components export correctly from their files
3. StagingDiffPreview routes to InlineDiffViewer for .ts files and NonTextPlaceholder for .png files
4. InlineDiffViewer uses debounced source to prevent rapid-fire queries
5. DiffPreviewHeader renders file path with expand button
</verification>

<success_criteria>
All diff preview components compile, follow the established patterns (Catppuccin theme, Tailwind v4, existing Monaco config), and are ready for integration into the staging blade in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/21-two-column-staging-inline-diff/21-02-SUMMARY.md`
</output>
