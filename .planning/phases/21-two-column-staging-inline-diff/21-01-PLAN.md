---
phase: 21-two-column-staging-inline-diff
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/layout/SplitPaneLayout.tsx
  - src/components/layout/index.ts
  - src/stores/staging.ts
  - src/lib/previewRegistry.ts
  - src/components/staging/previewRegistrations.ts
  - src/lib/fileTypeUtils.ts
autonomous: true

must_haves:
  truths:
    - "SplitPaneLayout renders a resizable two-column layout with persistent sizing"
    - "Staging store tracks scroll positions and file list scroll for state preservation"
    - "Preview registry maps file types to preview modes (inline-diff, placeholder)"
    - "File type utilities correctly detect text vs binary vs image files"
  artifacts:
    - path: "src/components/layout/SplitPaneLayout.tsx"
      provides: "Generic reusable two-column list+detail layout"
      exports: ["SplitPaneLayout"]
    - path: "src/stores/staging.ts"
      provides: "Extended staging store with scroll preservation"
      contains: "scrollPositions"
    - path: "src/lib/previewRegistry.ts"
      provides: "Preview type registry with register/get pattern"
      exports: ["registerPreview", "getPreviewForFile"]
    - path: "src/lib/fileTypeUtils.ts"
      provides: "Shared file-type detection utilities"
      exports: ["bladeTypeForFile", "isTextDiffable", "isBinaryFile"]
    - path: "src/components/staging/previewRegistrations.ts"
      provides: "Default preview registrations for text, binary, image files"
  key_links:
    - from: "src/components/layout/SplitPaneLayout.tsx"
      to: "src/components/layout/ResizablePanelLayout.tsx"
      via: "imports ResizablePanelLayout, ResizablePanel, ResizeHandle"
      pattern: "import.*ResizablePanelLayout"
    - from: "src/components/staging/previewRegistrations.ts"
      to: "src/lib/previewRegistry.ts"
      via: "calls registerPreview()"
      pattern: "registerPreview"
---

<objective>
Create the foundation components for the two-column staging layout: a reusable SplitPaneLayout component, extended staging store with scroll preservation, a preview registry for file-type-based rendering, and shared file-type detection utilities.

Purpose: These foundational pieces are required by all downstream plans. The SplitPaneLayout is reusable by future blades (repo-browser, commit-details). The preview registry follows the same extensibility pattern as the blade registry.

Output: 4 new files, 2 modified files. No visual changes yet -- this is infrastructure.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/layout/ResizablePanelLayout.tsx
@src/components/layout/index.ts
@src/stores/staging.ts
@src/hooks/useBladeNavigation.ts
@.planning/phases/21-two-column-staging-inline-diff/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SplitPaneLayout generic component and extend layout barrel export</name>
  <files>
    src/components/layout/SplitPaneLayout.tsx
    src/components/layout/index.ts
  </files>
  <action>
Create `src/components/layout/SplitPaneLayout.tsx` -- a generic two-column list+detail layout component that wraps the existing `ResizablePanelLayout`, `ResizablePanel`, and `ResizeHandle` components.

Interface:
```typescript
interface SplitPaneLayoutProps {
  autoSaveId: string;
  primaryDefaultSize?: number;  // default: 40
  primaryMinSize?: number;      // default: 20
  primaryMaxSize?: number;      // default: 60
  detailMinSize?: number;       // default: 30
  primary: ReactNode;
  detail: ReactNode;
  className?: string;
}
```

Implementation:
- Import `ResizablePanelLayout`, `ResizablePanel`, `ResizeHandle` from `./ResizablePanelLayout`
- Render a `ResizablePanelLayout` with `autoSaveId` and `direction="horizontal"`
- Primary panel: id=`${autoSaveId}-primary`, defaultSize/minSize/maxSize from props
- ResizeHandle between panels
- Detail panel: id=`${autoSaveId}-detail`, defaultSize=`100 - primaryDefaultSize`, minSize=detailMinSize
- Wrap in `cn("h-full w-full", className)`
- Both panels use `overflow-clip` (inherited from ResizablePanel)

Add `SplitPaneLayout` to the barrel export in `src/components/layout/index.ts`.

Do NOT use `Group`, `Panel`, `Separator` directly -- use the existing wrapper components from `ResizablePanelLayout.tsx` for consistency. The existing wrappers handle percentage conversion and Catppuccin-themed ResizeHandle styling.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors.
Import `SplitPaneLayout` from `../layout` in a test file to confirm the export works.
  </verify>
  <done>
SplitPaneLayout component exists, exports from layout barrel, compiles without errors, and wraps the existing resizable panel components with sensible defaults for a 40/60 split.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend staging store and create preview registry with file type utilities</name>
  <files>
    src/stores/staging.ts
    src/lib/previewRegistry.ts
    src/components/staging/previewRegistrations.ts
    src/lib/fileTypeUtils.ts
  </files>
  <action>
**1. Extend `src/stores/staging.ts`:**

Add to the `StagingState` interface:
- `scrollPositions: Record<string, number>` -- map of filePath to Monaco scrollTop
- `fileListScrollTop: number` -- file list container scroll position
- `saveScrollPosition: (filePath: string, scrollTop: number) => void`
- `setFileListScrollTop: (top: number) => void`
- `clearScrollPositions: () => void`

Add default values and action implementations to the `create()` call:
- `scrollPositions: {}`
- `fileListScrollTop: 0`
- `saveScrollPosition`: merges new entry into scrollPositions via spread
- `setFileListScrollTop`: sets the value
- `clearScrollPositions`: resets to `{}` and `0`

Keep all existing fields and actions unchanged.

**2. Create `src/lib/fileTypeUtils.ts`:**

Extract `bladeTypeForFile` from `src/hooks/useBladeNavigation.ts` into a shared utility. The function currently lives as a module-level function in useBladeNavigation.ts -- move it here and re-export it.

Add two new utility functions:
- `isTextDiffable(filePath: string): boolean` -- returns true when `bladeTypeForFile(filePath) === "diff"` (i.e., the file gets a text diff, not a specialized viewer)
- `isBinaryFile(filePath: string): boolean` -- checks against known binary extensions: png, jpg, jpeg, gif, webp, svg, ico, bmp, exe, dll, so, dylib, bin, dat, wasm, nupkg, zip, tar, gz, 7z, rar, pdf, doc, docx, xls, xlsx, mp3, wav, ogg, mp4, avi, mov, woff, woff2, ttf, otf, eot, glb, gltf, obj, fbx

Update `src/hooks/useBladeNavigation.ts` to import `bladeTypeForFile` from `../lib/fileTypeUtils` instead of defining it inline. Remove the local function definition.

**3. Create `src/lib/previewRegistry.ts`:**

```typescript
export type PreviewMode = "inline-diff" | "placeholder" | "custom";

export interface PreviewRegistration {
  key: string;
  matches: (filePath: string) => boolean;
  mode: PreviewMode;
  placeholder?: {
    icon: ComponentType<{ className?: string }>;
    message: string;
  };
  component?: ComponentType<{ file: FileChange; source: DiffSource }>;
  priority?: number;
}

const registry: PreviewRegistration[] = [];

export function registerPreview(config: PreviewRegistration): void
export function getPreviewForFile(filePath: string): PreviewRegistration | undefined
```

- `registerPreview` pushes to array and sorts by priority descending
- `getPreviewForFile` returns first matching registration

Import types from `../bindings` for FileChange and from `../components/blades/DiffBlade` for DiffSource.

**4. Create `src/components/staging/previewRegistrations.ts`:**

Register default preview types using `registerPreview`:
- `binary` (priority 10): matches exe, dll, so, dylib, bin, dat, wasm -- placeholder with `File` icon and "Binary file -- click to expand"
- `image` (priority 10): matches png, jpg, jpeg, gif, webp, svg, ico, bmp -- placeholder with `FileImage` icon and "Image file -- click to expand for preview"
- `archive` (priority 10): matches nupkg, zip, tar, gz, 7z, rar -- placeholder with `FileArchive` icon and "Archive file -- click to expand"
- `3d` (priority 10): matches glb, gltf -- placeholder with `Box` icon and "3D model -- click to expand for viewer"
- `text-diff` (priority -100): matches everything (catch-all) -- mode "inline-diff"

Import icons from `lucide-react`: `File`, `FileImage`, `FileArchive`, `Box`.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors.
Verify `useBladeNavigation.ts` still compiles after extracting `bladeTypeForFile`.
  </verify>
  <done>
Staging store has scroll position preservation fields. Preview registry exists with register/get API. Default registrations cover binary, image, archive, 3D, and text files. File type utilities are shared between useBladeNavigation and future preview components.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` passes with no new errors
2. `SplitPaneLayout` is importable from `../layout`
3. `bladeTypeForFile` is importable from `../lib/fileTypeUtils`
4. `registerPreview` and `getPreviewForFile` are importable from `../lib/previewRegistry`
5. `useStagingStore` has `scrollPositions`, `saveScrollPosition`, `fileListScrollTop`, `setFileListScrollTop`, `clearScrollPositions`
6. Existing staging behavior unchanged (no visual regression)
</verification>

<success_criteria>
All foundation components compile, export correctly, and are ready for use by Plan 02 (diff preview components) and Plan 03 (integration).
</success_criteria>

<output>
After completion, create `.planning/phases/21-two-column-staging-inline-diff/21-01-SUMMARY.md`
</output>
