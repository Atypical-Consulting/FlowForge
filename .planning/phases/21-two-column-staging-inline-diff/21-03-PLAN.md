---
phase: 21-two-column-staging-inline-diff
plan: 03
type: execute
wave: 3
depends_on: ["21-01", "21-02"]
files_modified:
  - src/components/blades/StagingChangesBlade.tsx
  - src/components/staging/StagingPanel.tsx
  - src/components/staging/FileItem.tsx
  - src/hooks/useStagingKeyboard.ts
autonomous: true

must_haves:
  truths:
    - "User sees two-column staging layout with file list (40%) and diff preview (60%)"
    - "User clicks a file and immediately sees its diff in the adjacent panel without pushing a new blade"
    - "First file is auto-selected on load with diff shown immediately"
    - "Arrow keys navigate through file list and diff updates immediately"
    - "Space toggles stage/unstage for the selected file"
    - "Stage/unstage keeps showing the same file -- it moves between sections in the list"
    - "File list scroll position is preserved across blade push/pop"
  artifacts:
    - path: "src/components/blades/StagingChangesBlade.tsx"
      provides: "Two-column staging layout using SplitPaneLayout"
      contains: "SplitPaneLayout"
    - path: "src/hooks/useStagingKeyboard.ts"
      provides: "Arrow-key file navigation, Space stage/unstage, Enter expand"
      exports: ["useStagingKeyboard"]
  key_links:
    - from: "src/components/blades/StagingChangesBlade.tsx"
      to: "src/components/layout/SplitPaneLayout.tsx"
      via: "renders SplitPaneLayout with StagingPanel and StagingDiffPreview"
      pattern: "SplitPaneLayout"
    - from: "src/components/blades/StagingChangesBlade.tsx"
      to: "src/components/staging/StagingDiffPreview.tsx"
      via: "renders StagingDiffPreview in the detail panel"
      pattern: "StagingDiffPreview"
    - from: "src/components/staging/StagingPanel.tsx"
      to: "src/stores/staging.ts"
      via: "reconciles selectedFile after staging status refetch"
      pattern: "selectFile.*staged"
    - from: "src/hooks/useStagingKeyboard.ts"
      to: "src/stores/staging.ts"
      via: "reads selectedFile, calls selectFile on arrow key"
      pattern: "useStagingStore"
---

<objective>
Wire the two-column staging layout together: refactor StagingChangesBlade to use SplitPaneLayout with StagingPanel (left) and StagingDiffPreview (right), modify StagingPanel and FileItem to use store-driven selection instead of pushing blades, add keyboard navigation, and implement file selection reconciliation after stage/unstage.

Purpose: This is the core integration plan that delivers the visible two-column UX. After this plan, the user sees files on the left and diffs on the right, can click files for instant diff preview, navigate with arrow keys, and stage/unstage without losing context.

Output: 1 new file (useStagingKeyboard), 3 modified files. The staging blade transforms from single-column to two-column.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-two-column-staging-inline-diff/21-01-SUMMARY.md
@.planning/phases/21-two-column-staging-inline-diff/21-02-SUMMARY.md
@src/components/blades/StagingChangesBlade.tsx
@src/components/staging/StagingPanel.tsx
@src/components/staging/FileItem.tsx
@src/stores/staging.ts
@src/hooks/useBladeNavigation.ts
@src/components/layout/SplitPaneLayout.tsx
@src/components/staging/StagingDiffPreview.tsx
@.planning/phases/21-two-column-staging-inline-diff/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor StagingChangesBlade to two-column layout and modify StagingPanel/FileItem</name>
  <files>
    src/components/blades/StagingChangesBlade.tsx
    src/components/staging/StagingPanel.tsx
    src/components/staging/FileItem.tsx
  </files>
  <action>
**1. Refactor `src/components/blades/StagingChangesBlade.tsx`:**

Replace the current 7-line implementation with a two-column layout:

```tsx
import { useCallback, useMemo, useRef, useState } from "react";
import type { FileChange } from "../../bindings";
import { useBladeNavigation } from "../../hooks/useBladeNavigation";
import { useStagingKeyboard } from "../../hooks/useStagingKeyboard";
import { useStagingStore } from "../../stores/staging";
import { SplitPaneLayout } from "../layout";
import { StagingDiffPreview } from "../staging/StagingDiffPreview";
import { StagingPanel } from "../staging/StagingPanel";
```

Implementation:
- Read `selectedFile`, `selectedSection` from `useStagingStore()`
- Get `openStagingDiff` from `useBladeNavigation()`
- Build a flat ordered file list from the staging query data for keyboard navigation. Use a `useFileList()` helper or inline it -- read from the `["stagingStatus"]` react-query cache via `useQuery` (same query StagingPanel uses, shares the cache).
- Track file list panel focus with a `useState<boolean>(false)` and `onFocus`/`onBlur` on the file list panel wrapper. Give the file list wrapper `tabIndex={0}` and `role="region" aria-label="Changed files"`.
- Call `useStagingKeyboard({ allFiles, enabled: fileListFocused, onExpand, onToggleStage })`.
- `onExpand` callback: call `openStagingDiff(selectedFile, selectedSection)` to push a full diff blade.
- `onToggleStage` callback: call `commands.stageFile(file.path)` or `commands.unstageFile(file.path)` based on section, then invalidate `["stagingStatus"]` query.
- `onNavigateFile` callback for prev/next: find current index in allFiles, select the prev/next entry.
- Compute `hasPrev`/`hasNext` from current index.

Render:
```tsx
<SplitPaneLayout
  autoSaveId="staging-split"
  primaryDefaultSize={40}
  primaryMinSize={20}
  primaryMaxSize={60}
  detailMinSize={30}
  primary={
    <div
      tabIndex={0}
      role="region"
      aria-label="Changed files"
      onFocus={() => setFileListFocused(true)}
      onBlur={() => setFileListFocused(false)}
      className="h-full outline-none"
    >
      <StagingPanel />
    </div>
  }
  detail={
    <div role="region" aria-label="Diff preview" className="h-full">
      <StagingDiffPreview
        file={selectedFile}
        section={selectedSection}
        onExpand={handleExpand}
        onNavigateFile={handleNavigateFile}
        hasPrev={hasPrev}
        hasNext={hasNext}
      />
    </div>
  }
/>
```

**2. Modify `src/components/staging/StagingPanel.tsx`:**

Changes:
- Remove the `onFileSelect` prop from the interface entirely.
- Remove all `onFileSelect` prop passing to `FileTreeView` and `FileList` children.
- The component now relies entirely on store-driven selection. Clicking a file updates `useStagingStore.selectFile()` via `FileItem` -- no blade push happens.
- Add file selection reconciliation: After staging status data changes, reconcile the selected file to find it in the correct section:

```tsx
// Add this useEffect after the existing auto-select useEffect:
useEffect(() => {
  if (!selectedFile || !result || result.status !== "ok") return;
  const status = result.data;
  const filePath = selectedFile.path;

  // Find which section the file is in now
  const inStaged = status.staged.find(f => f.path === filePath);
  const inUnstaged = status.unstaged.find(f => f.path === filePath);
  const inUntracked = status.untracked.find(f => f.path === filePath);

  if (inStaged) {
    selectFile(inStaged, "staged");
  } else if (inUnstaged) {
    selectFile(inUnstaged, "unstaged");
  } else if (inUntracked) {
    selectFile(inUntracked, "untracked");
  }
  // If file is no longer in any section (discarded), keep current selection
  // The diff will show an empty/error state naturally
}, [result?.data?.staged?.length, result?.data?.unstaged?.length, result?.data?.untracked?.length]);
```

Important: Use the lengths as deps (not the full arrays) to avoid infinite re-renders. The reconciliation only needs to run when files actually move between sections.

- Add scroll position preservation:
  - Add a `ref` to the scrollable container (`flex-1 overflow-y-auto` div).
  - On mount, restore `fileListScrollTop` from staging store via `useEffect`.
  - On unmount, save current `scrollTop` to staging store via cleanup function in `useEffect`.

**3. Modify `src/components/staging/FileItem.tsx`:**

Changes:
- Remove the `onFileSelect` prop from the interface.
- Remove the `onFileSelect?.(file, section)` call from `handleSelect()`. Now `handleSelect()` only calls `selectFile(file, section)`.
- Keep all other behavior (stage/unstage button, status dot, selection highlight) unchanged.
- Ensure `scrollIntoView({ block: "nearest" })` is called when the file becomes selected programmatically (from keyboard navigation). Add a `useEffect` that checks `isSelected` and calls `ref.current?.scrollIntoView({ block: "nearest" })` when it becomes true. Add a ref to the outer div.

Also update `FileTreeView` and `FileList` components to stop passing `onFileSelect` down to `FileItem` if they currently do. Check these components and remove the prop forwarding.
  </action>
  <verify>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors
2. Open the app, navigate to staging -- the two-column layout should render
3. Click a file in the list -- diff appears in the right panel without pushing a blade
4. Stage/unstage a file -- the file moves between sections but stays selected and diff stays visible
  </verify>
  <done>
StagingChangesBlade renders a two-column layout with file list (40%) and diff preview (60%). Clicking a file shows its diff inline. Stage/unstage keeps the same file selected. First file is auto-selected on load.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create keyboard navigation hook for staging file list</name>
  <files>
    src/hooks/useStagingKeyboard.ts
  </files>
  <action>
Create `src/hooks/useStagingKeyboard.ts` -- a keyboard navigation hook for the staging file list.

**Interface:**
```typescript
interface UseStagingKeyboardOptions {
  allFiles: Array<{ file: FileChange; section: "staged" | "unstaged" | "untracked" }>;
  enabled: boolean;
  onExpand?: () => void;
  onToggleStage?: () => void;
}

export function useStagingKeyboard(options: UseStagingKeyboardOptions): void
```

**Implementation:**

Import `useHotkeys` from `react-hotkeys-hook` and `useStagingStore` from `../stores/staging`.

Read `selectedFile` and `selectFile` from the staging store.

Compute `currentIndex` by finding the selected file in `allFiles` by path.

Register hotkeys (all with `{ enabled, enableOnFormTags: false }`):

1. **`"down"` / `"j"`**: Select next file. If at end, stay at end (no wrap). Call `selectFile(next.file, next.section)`. Prevent default to avoid page scroll.

2. **`"up"` / `"k"`**: Select previous file. If at start, stay at start. Call `selectFile(prev.file, prev.section)`. Prevent default.

3. **`"enter"`**: Call `onExpand?.()` if a file is selected. This pushes the full diff blade.

4. **`"space"`**: Call `onToggleStage?.()` if a file is selected. Prevent default to avoid page scroll.

Pass `[currentIndex, allFiles]` as the dependency array to `useHotkeys` so it re-registers when the file list changes.

**Important considerations:**
- The `enabled` flag should be `true` only when the file list panel has focus. This prevents arrow key conflicts with Monaco (which handles its own keyboard events when focused).
- `enableOnFormTags: false` ensures the shortcuts don't fire when the search input is focused.
- `preventDefault` on all handlers to prevent the browser's default scroll behavior.
  </action>
  <verify>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors
2. Open the app, click in the file list area, press arrow keys -- files should highlight sequentially
3. Press Space -- the selected file should stage/unstage
4. Press Enter -- the full diff blade should open
  </verify>
  <done>
Keyboard navigation works: arrow keys move file selection, Space toggles stage/unstage, Enter expands to full diff blade. All shortcuts respect focus context (only active when file list is focused).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` passes with no new errors
2. The staging blade shows a resizable two-column layout (40/60 default split)
3. Clicking a file shows its diff instantly in the right panel
4. Arrow keys navigate files when the file list is focused
5. Space stages/unstages the selected file, which moves sections but stays selected
6. Enter expands to the full diff blade
7. Resize handle works and persists size to localStorage
8. First file auto-selects on load (no empty state)
9. File list scroll position is preserved when returning from full diff blade
</verification>

<success_criteria>
The core two-column staging experience is fully functional: file list on the left, inline diff on the right, keyboard navigation, and store-driven selection with reconciliation after stage/unstage. Requirements UX-01 is complete.
</success_criteria>

<output>
After completion, create `.planning/phases/21-two-column-staging-inline-diff/21-03-SUMMARY.md`
</output>
