---
phase: 21-two-column-staging-inline-diff
plan: 04
type: execute
wave: 4
depends_on: ["21-03"]
files_modified:
  - src/components/blades/DiffBlade.tsx
  - src/components/blades/registrations/diff.ts
autonomous: true

must_haves:
  truths:
    - "User can click expand button on inline diff to open full-screen diff blade"
    - "User can navigate between files in full-screen diff blade via next/prev arrows"
    - "Back from full-screen diff returns to two-column view with same file selected"
    - "File position indicator shows 'N of M' in full-screen diff blade header"
  artifacts:
    - path: "src/components/blades/DiffBlade.tsx"
      provides: "DiffBlade with optional next/prev file navigation for staging mode"
      contains: "ChevronLeft"
  key_links:
    - from: "src/components/blades/DiffBlade.tsx"
      to: "src/stores/staging.ts"
      via: "reads selectedFile from staging store for navigation context"
      pattern: "useStagingStore"
    - from: "src/components/blades/DiffBlade.tsx"
      to: "src/stores/blades.ts"
      via: "uses replaceBlade for file navigation without growing stack"
      pattern: "replaceBlade"
---

<objective>
Add next/prev file navigation to the full-screen DiffBlade when opened from staging context. The user can navigate between files using arrow buttons or Alt+Up/Alt+Down without going back to the two-column view. This completes requirement UX-02.

Purpose: The full-screen diff blade gets file navigation capabilities when opened from staging. This lets users review files sequentially in full-screen mode. When they press Back, they return to the two-column view with the same file selected.

Output: 2 modified files. DiffBlade gains a navigation bar for staging mode.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-two-column-staging-inline-diff/21-03-SUMMARY.md
@src/components/blades/DiffBlade.tsx
@src/components/blades/registrations/diff.ts
@src/stores/blades.ts
@src/stores/staging.ts
@src/hooks/useBladeNavigation.ts
@.planning/phases/21-two-column-staging-inline-diff/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add next/prev file navigation to DiffBlade for staging mode</name>
  <files>
    src/components/blades/DiffBlade.tsx
  </files>
  <action>
Modify `src/components/blades/DiffBlade.tsx` to add file navigation when opened from staging context.

**Strategy:** When `source.mode === "staging"`, the DiffBlade reads the staging file list from the same `["stagingStatus"]` react-query cache and renders prev/next navigation buttons. Navigation uses `replaceBlade` (not pushBlade) to swap the current blade for the next file's diff without growing the stack.

**Changes:**

1. **Add imports:**
   - `ChevronLeft`, `ChevronRight` from `lucide-react`
   - `useQuery` is already imported
   - `commands` is already imported
   - `useStagingStore` from `../../stores/staging`
   - `useBladeStore` from `../../stores/blades`
   - `useHotkeys` from `react-hotkeys-hook`
   - `useMemo` from `react`

2. **Add a `StagingDiffNavigation` component** (inline in the same file or as a separate function):

```tsx
function StagingDiffNavigation({ currentFilePath }: { currentFilePath: string }) {
  const { selectFile } = useStagingStore();
  const store = useBladeStore();

  // Read the staging file list from the existing react-query cache
  const { data: statusResult } = useQuery({
    queryKey: ["stagingStatus"],
    queryFn: () => commands.getStagingStatus(),
    // No refetchInterval here -- just reads the existing cache
  });

  const allFiles = useMemo(() => {
    if (!statusResult || statusResult.status !== "ok") return [];
    const s = statusResult.data;
    return [
      ...s.staged.map(f => ({ file: f, section: "staged" as const })),
      ...s.unstaged.map(f => ({ file: f, section: "unstaged" as const })),
      ...s.untracked.map(f => ({ file: f, section: "untracked" as const })),
    ];
  }, [statusResult]);

  const currentIndex = allFiles.findIndex(f => f.file.path === currentFilePath);
  const hasPrev = currentIndex > 0;
  const hasNext = currentIndex < allFiles.length - 1;

  const navigateTo = (index: number) => {
    const entry = allFiles[index];
    if (!entry) return;
    // Update staging store selection
    selectFile(entry.file, entry.section);
    // Replace current blade with the new file's diff
    store.replaceBlade({
      type: "diff",
      title: entry.file.path.split("/").pop() || entry.file.path,
      props: {
        source: {
          mode: "staging",
          filePath: entry.file.path,
          staged: entry.section === "staged",
        },
      },
    });
  };

  // Keyboard shortcuts for file navigation in full-screen diff
  useHotkeys("alt+up", () => hasPrev && navigateTo(currentIndex - 1), {
    enabled: hasPrev,
    enableOnFormTags: false,
    preventDefault: true,
  }, [currentIndex, allFiles]);

  useHotkeys("alt+down", () => hasNext && navigateTo(currentIndex + 1), {
    enabled: hasNext,
    enableOnFormTags: false,
    preventDefault: true,
  }, [currentIndex, allFiles]);

  if (allFiles.length <= 1) return null;

  return (
    <div className="flex items-center gap-1">
      <button
        type="button"
        disabled={!hasPrev}
        onClick={() => navigateTo(currentIndex - 1)}
        className="p-1 rounded hover:bg-ctp-surface0 disabled:opacity-30 disabled:cursor-default text-ctp-overlay1 hover:text-ctp-text transition-colors"
        aria-label="Previous file"
      >
        <ChevronLeft className="w-4 h-4" />
      </button>
      <span className="text-xs text-ctp-overlay0 tabular-nums">
        {currentIndex + 1} / {allFiles.length}
      </span>
      <button
        type="button"
        disabled={!hasNext}
        onClick={() => navigateTo(currentIndex + 1)}
        className="p-1 rounded hover:bg-ctp-surface0 disabled:opacity-30 disabled:cursor-default text-ctp-overlay1 hover:text-ctp-text transition-colors"
        aria-label="Next file"
      >
        <ChevronRight className="w-4 h-4" />
      </button>
    </div>
  );
}
```

3. **Modify the DiffBlade toolbar:** Add the `StagingDiffNavigation` component to the existing toolbar bar (the `flex items-center gap-2 px-3 py-1` div with the inline/side-by-side toggle). Place it on the right side of the toolbar, after the toggle button:

```tsx
<div className="flex items-center gap-2 px-3 py-1 border-b border-ctp-surface0 bg-ctp-crust shrink-0">
  <Button variant="ghost" size="sm" ... >
    {/* existing inline/side-by-side toggle */}
  </Button>
  <div className="flex-1" /> {/* spacer */}
  {source.mode === "staging" && (
    <StagingDiffNavigation currentFilePath={source.filePath} />
  )}
</div>
```

4. **State preservation on back:** No changes needed. When the user presses Back/Escape:
   - `popBlade()` removes the DiffBlade
   - The staging-changes blade re-renders
   - `useStagingStore` still has `selectedFile` and `selectedSection` set (the `navigateTo` function updates these)
   - The two-column layout immediately shows the correct file selected
  </action>
  <verify>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- no new type errors
2. Open staging, click a file, click expand -- the full diff blade opens
3. In the full diff blade toolbar, prev/next arrows are visible with "N / M" counter
4. Click next -- the diff changes to the next file without growing the blade stack
5. Press Alt+Down -- same navigation via keyboard
6. Press Back/Escape -- returns to two-column with the last-navigated file selected
7. Commit diffs (non-staging mode) should NOT show the navigation bar
  </verify>
  <done>
DiffBlade shows prev/next file navigation when opened from staging context. Navigation uses replaceBlade to avoid stack growth. Alt+Up/Down keyboard shortcuts work. State is preserved on back navigation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update diff blade registration if renderTrailing slot is needed</name>
  <files>
    src/components/blades/registrations/diff.ts
  </files>
  <action>
Check the diff blade registration at `src/components/blades/registrations/diff.ts`. The navigation is now embedded directly in the DiffBlade component (not in `renderTrailing`), so the registration likely needs no changes.

However, verify the registration is compatible with the enhanced DiffBlade:
- `wrapInPanel: true` -- the DiffBlade should still be wrapped in BladePanel (which provides the back button and title bar)
- `showBack: true` -- the back button should be visible

If the registration already has these correct settings, no changes are needed. If `renderTrailing` could improve the UX (e.g., moving navigation to the title bar), consider it but prefer the simpler approach of embedding navigation in the DiffBlade's own toolbar.

Also verify that `replaceBlade` works correctly with the blade type system. The `replaceBlade` function in `blades.ts` should accept the same shape as `pushBlade`. Test that navigating between files doesn't cause the blade ID to collide or animations to break.

If no changes are needed to the registration file, document this in the summary and note that DiffBlade handles its own navigation inline.
  </action>
  <verify>
1. The diff blade registration is compatible with the enhanced DiffBlade
2. `replaceBlade` correctly swaps the blade without animation glitches
3. The title bar updates when navigating between files
  </verify>
  <done>
The diff blade registration is verified compatible. The navigation is embedded in DiffBlade's toolbar, keeping the registration simple. replaceBlade correctly handles blade swapping.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` passes with no new errors
2. Full-screen diff blade shows prev/next navigation for staging mode only
3. File navigation uses replaceBlade -- blade stack depth stays at 2 (staging + diff)
4. Alt+Up/Alt+Down keyboard shortcuts navigate files in full-screen diff
5. Back navigation returns to two-column view with correct file selected
6. "N / M" counter updates correctly
7. Commit diffs (opened from topology) do NOT show navigation bar
</verification>

<success_criteria>
Requirement UX-02 is complete: the user can expand inline diff to a full-screen diff blade, navigate between files without going back, and return to the two-column view with state preserved.
</success_criteria>

<output>
After completion, create `.planning/phases/21-two-column-staging-inline-diff/21-04-SUMMARY.md`
</output>
