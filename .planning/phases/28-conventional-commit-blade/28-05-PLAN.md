---
phase: 28-conventional-commit-blade
plan: 05
type: execute
wave: 4
depends_on: ["28-04"]
files_modified:
  - src/lib/commit-templates.ts
  - src/components/commit/TemplateSelector.tsx
  - src/components/commit/ScopeFrequencyChart.tsx
  - src/components/blades/ConventionalCommitBlade.tsx
  - src/stores/conventional.ts
autonomous: true

must_haves:
  truths:
    - "User sees horizontal template chips when the CC blade form is empty"
    - "Clicking a template fills all form fields and focuses the first empty required field"
    - "Template chips collapse when user starts typing"
    - "User sees a horizontal bar chart of scope frequencies in the right panel below preview"
    - "Clicking a scope bar fills the scope input"
    - "Scope frequency section is collapsible"
  artifacts:
    - path: "src/lib/commit-templates.ts"
      provides: "CommitTemplate interface and BUILTIN_TEMPLATES constant"
      exports: ["CommitTemplate", "BUILTIN_TEMPLATES"]
    - path: "src/components/commit/TemplateSelector.tsx"
      provides: "Horizontal chip bar for template selection"
      exports: ["TemplateSelector"]
    - path: "src/components/commit/ScopeFrequencyChart.tsx"
      provides: "Horizontal bar chart of scope usage"
      exports: ["ScopeFrequencyChart"]
  key_links:
    - from: "src/components/commit/TemplateSelector.tsx"
      to: "src/lib/commit-templates.ts"
      via: "import BUILTIN_TEMPLATES"
      pattern: "BUILTIN_TEMPLATES"
    - from: "src/components/commit/ScopeFrequencyChart.tsx"
      to: "src/stores/conventional.ts"
      via: "scopeFrequencies from store"
      pattern: "scopeFrequencies"
    - from: "src/components/blades/ConventionalCommitBlade.tsx"
      to: "src/components/commit/TemplateSelector.tsx"
      via: "component composition in TOOLBAR slot"
      pattern: "TemplateSelector"
---

<objective>
Build the commit template system and scope frequency visualization, and integrate them into the CC blade layout.

Purpose: Deliver CC-08 (scope frequency visualization) and CC-09 (pre-defined commit templates) -- the productivity features that help users compose commits faster by learning from history and applying patterns.

Output: `commit-templates.ts` data, `TemplateSelector.tsx` chip bar, `ScopeFrequencyChart.tsx` bar chart, integrated into the blade layout.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-conventional-commit-blade/28-RESEARCH.md
@.planning/phases/28-conventional-commit-blade/28-03-SUMMARY.md
@.planning/phases/28-conventional-commit-blade/28-04-SUMMARY.md

@src/components/blades/ConventionalCommitBlade.tsx
@src/stores/conventional.ts
@src/lib/commit-type-theme.ts
@src/hooks/useConventionalCommit.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create commit templates data and TemplateSelector component</name>
  <files>src/lib/commit-templates.ts, src/components/commit/TemplateSelector.tsx</files>
  <action>
**Create `src/lib/commit-templates.ts`:**

Define the `CommitTemplate` interface (as decided in research synthesis) and 7 built-in templates:

```typescript
import type { CommitType } from "../stores/conventional";

export interface CommitTemplate {
  id: string;
  label: string;
  description: string;
  icon?: string; // Lucide icon name for visual identification
  fields: {
    commitType: CommitType;
    scope?: string;
    description: string;
    body?: string;
    isBreaking?: boolean;
    breakingDescription?: string;
  };
}

export const BUILTIN_TEMPLATES: CommitTemplate[] = [
  {
    id: "new-feature",
    label: "New Feature",
    description: "Add a new feature or capability",
    icon: "Sparkles",
    fields: { commitType: "feat", description: "add " },
  },
  {
    id: "bug-fix",
    label: "Bug Fix",
    description: "Fix a bug or defect",
    icon: "Bug",
    fields: { commitType: "fix", description: "fix " },
  },
  {
    id: "breaking-change",
    label: "Breaking Change",
    description: "Introduce a breaking API change",
    icon: "AlertTriangle",
    fields: { commitType: "feat", description: "", isBreaking: true, breakingDescription: "" },
  },
  {
    id: "dependency-update",
    label: "Dependency Update",
    description: "Update project dependencies",
    icon: "Package",
    fields: { commitType: "build", scope: "deps", description: "update " },
  },
  {
    id: "documentation",
    label: "Documentation",
    description: "Add or update documentation",
    icon: "FileText",
    fields: { commitType: "docs", description: "" },
  },
  {
    id: "refactor",
    label: "Refactor",
    description: "Restructure code without changing behavior",
    icon: "RefreshCw",
    fields: { commitType: "refactor", description: "" },
  },
  {
    id: "ci-cd",
    label: "CI/CD",
    description: "Update continuous integration or deployment",
    icon: "Workflow",
    fields: { commitType: "ci", description: "" },
  },
];
```

**Create `src/components/commit/TemplateSelector.tsx`:**

Horizontal chip bar that shows templates when the form is empty, collapses when user starts typing.

```typescript
import { motion, AnimatePresence } from "framer-motion";
import { Sparkles, Bug, AlertTriangle, Package, FileText, RefreshCw, Workflow } from "lucide-react";
import type { CommitTemplate } from "../../lib/commit-templates";
import { BUILTIN_TEMPLATES } from "../../lib/commit-templates";
import { cn } from "../../lib/utils";

// Map icon names to Lucide components
const ICON_MAP: Record<string, React.ComponentType<{ className?: string }>> = {
  Sparkles, Bug, AlertTriangle, Package, FileText, RefreshCw, Workflow,
};

interface TemplateSelectorProps {
  onApply: (template: CommitTemplate) => void;
  isFormEmpty: boolean;
  activeTemplateId?: string | null;
}

export function TemplateSelector({ onApply, isFormEmpty, activeTemplateId }: TemplateSelectorProps) {
  // Show chips when form is empty, hide when user is typing
  // If a template is active, show a small badge instead

  return (
    <AnimatePresence mode="wait">
      {isFormEmpty ? (
        <motion.div
          key="chips"
          initial={{ opacity: 0, height: 0 }}
          animate={{ opacity: 1, height: "auto" }}
          exit={{ opacity: 0, height: 0 }}
          className="space-y-2"
        >
          <label className="text-sm font-medium text-ctp-overlay1">Quick Start</label>
          <div className="flex flex-wrap gap-2">
            {BUILTIN_TEMPLATES.map((template) => {
              const Icon = template.icon ? ICON_MAP[template.icon] : null;
              return (
                <button
                  key={template.id}
                  type="button"
                  onClick={() => onApply(template)}
                  className={cn(
                    "flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-full border transition-colors",
                    "border-ctp-surface1 text-ctp-subtext0 hover:border-ctp-blue hover:text-ctp-blue",
                    "focus:outline-none focus:ring-1 focus:ring-ctp-blue",
                  )}
                  title={template.description}
                >
                  {Icon && <Icon className="w-3.5 h-3.5" />}
                  {template.label}
                </button>
              );
            })}
          </div>
        </motion.div>
      ) : activeTemplateId ? (
        <motion.div
          key="badge"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="flex items-center gap-1.5 text-xs text-ctp-overlay1"
        >
          <span className="px-2 py-0.5 rounded-full bg-ctp-surface1 text-ctp-subtext0">
            Template: {BUILTIN_TEMPLATES.find(t => t.id === activeTemplateId)?.label}
          </span>
        </motion.div>
      ) : null}
    </AnimatePresence>
  );
}
```

The component:
- Shows all template chips in a flex-wrap layout when `isFormEmpty` is true.
- Each chip has the template's icon (mapped from Lucide) and label.
- Clicking a chip calls `onApply(template)`.
- When the form has content, chips hide. If a template is active, a small badge shows "Template: X".
- Uses AnimatePresence for smooth transitions.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. The TemplateSelector renders chips and responds to clicks.</verify>
  <done>CommitTemplate interface and 7 built-in templates defined. TemplateSelector shows chips when form is empty, badge when template active, hidden when typing manually.</done>
</task>

<task type="auto">
  <name>Task 2: Create ScopeFrequencyChart and integrate into blade</name>
  <files>src/components/commit/ScopeFrequencyChart.tsx, src/components/blades/ConventionalCommitBlade.tsx, src/stores/conventional.ts</files>
  <action>
**Create `src/components/commit/ScopeFrequencyChart.tsx`:**

A horizontal bar chart showing scope usage frequency. Pure CSS with Tailwind, no charting library.

```typescript
import { useState } from "react";
import { ChevronDown, ChevronRight } from "lucide-react";
import type { ScopeSuggestion } from "../../bindings";
import { cn } from "../../lib/utils";

// Catppuccin accent colors for bars, cycling through palette
const BAR_COLORS = [
  "bg-ctp-blue", "bg-ctp-mauve", "bg-ctp-green", "bg-ctp-peach",
  "bg-ctp-pink", "bg-ctp-teal", "bg-ctp-yellow", "bg-ctp-lavender",
  "bg-ctp-sapphire", "bg-ctp-red",
];

interface ScopeFrequencyChartProps {
  frequencies: ScopeSuggestion[];
  onScopeClick: (scope: string) => void;
  loading?: boolean;
}

export function ScopeFrequencyChart({ frequencies, onScopeClick, loading }: ScopeFrequencyChartProps) {
  const [expanded, setExpanded] = useState(false);
  const [showAll, setShowAll] = useState(false);

  if (loading) {
    return (
      <div className="space-y-2">
        <div className="h-4 w-24 bg-ctp-surface1 rounded animate-pulse" />
        <div className="space-y-1.5">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="h-6 bg-ctp-surface1 rounded animate-pulse" style={{ width: `${100 - i * 15}%` }} />
          ))}
        </div>
      </div>
    );
  }

  if (frequencies.length === 0) return null;

  const maxCount = frequencies[0]?.count ?? 1;
  const displayLimit = showAll ? frequencies.length : 8;
  const displayed = frequencies.slice(0, displayLimit);

  return (
    <div className="space-y-2">
      {/* Collapsible header */}
      <button
        type="button"
        onClick={() => setExpanded(!expanded)}
        className="flex items-center gap-1.5 text-sm font-medium text-ctp-overlay1 hover:text-ctp-subtext1 transition-colors w-full"
      >
        {expanded ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
        Scope History
        <span className="text-xs text-ctp-overlay0 ml-1">({frequencies.length})</span>
      </button>

      {expanded && (
        <div className="space-y-1.5">
          {displayed.map((item, index) => {
            const barWidth = Math.max((item.count / maxCount) * 100, 8); // min 8% for visibility
            const color = BAR_COLORS[index % BAR_COLORS.length];

            return (
              <button
                key={item.scope}
                type="button"
                onClick={() => onScopeClick(item.scope)}
                className="flex items-center gap-2 w-full group text-left"
                title={`${item.scope}: ${item.count} commits â€” click to use`}
              >
                <span className="text-xs text-ctp-subtext0 w-20 truncate group-hover:text-ctp-blue transition-colors">
                  {item.scope}
                </span>
                <div className="flex-1 h-5 bg-ctp-surface0 rounded overflow-hidden">
                  <div
                    className={cn(color, "h-full rounded transition-all group-hover:opacity-80")}
                    style={{ width: `${barWidth}%` }}
                  />
                </div>
                <span className="text-xs text-ctp-overlay0 w-8 text-right font-mono">
                  {item.count}
                </span>
              </button>
            );
          })}

          {frequencies.length > 8 && (
            <button
              type="button"
              onClick={() => setShowAll(!showAll)}
              className="text-xs text-ctp-blue hover:text-ctp-sapphire mt-1"
            >
              {showAll ? "Show less" : `Show all (${frequencies.length})`}
            </button>
          )}
        </div>
      )}
    </div>
  );
}
```

**Integrate into `src/components/blades/ConventionalCommitBlade.tsx`:**

1. **Add TemplateSelector to the TOOLBAR slot (above the form, in the left panel):**
   - Import `TemplateSelector` from `../commit/TemplateSelector`.
   - Place it above the TypeSelector in the form panel.
   - Determine `isFormEmpty`: `!commitType && !description`.
   - On apply: call `store.applyTemplate(template)` from the conventional store.
   - Pass `activeTemplateId={store.activeTemplate?.id}`.
   - When template is applied, clear the `activeTemplate` when user manually edits any field (detect via `useEffect` on commitType/description changes, if they diverge from the template).

2. **Add ScopeFrequencyChart to the right panel (below preview):**
   - Import `ScopeFrequencyChart` from `../commit/ScopeFrequencyChart`.
   - Place it below the `CommitPreview` in the right panel section.
   - Pass `frequencies={scopeFrequencies}` from `useConventionalStore`.
   - Pass `onScopeClick={setScope}` from `useConventionalCommit`.
   - Pass `loading={scopeFrequencies.length === 0 && /* still fetching */}` or simply pass a loading boolean.
   - Trigger `fetchScopeFrequencies()` on blade mount (in the same `useEffect` as `initializeSuggestions`).

3. **Ensure `fetchScopeFrequencies` is called:**
   - In the blade's mount effect, call `useConventionalStore.getState().fetchScopeFrequencies()`.
   - Or add it to the `initializeSuggestions` callback in `useConventionalCommit`.

**Modify `src/stores/conventional.ts` (if not already done in Plan 01):**
Verify the `applyTemplate` function correctly populates all fields. When `applyTemplate` is called, it should set `activeTemplate` and all form fields from `template.fields`. The `setActiveTemplate(null)` should be called when the user manually changes a field after applying a template. This clearing logic lives in the blade component, not the store. The store just provides `setActiveTemplate`.
  </action>
  <verify>Run `npx tsc --noEmit` and `npx vite build` -- both pass. Open CC blade: template chips show when form is empty, clicking one fills fields. Scope chart shows in right panel below preview with horizontal bars. Clicking a bar fills the scope input.</verify>
  <done>TemplateSelector shows 7 template chips, clicking fills form fields, chips hide when typing. ScopeFrequencyChart shows horizontal bars with Catppuccin colors, collapsible, clickable bars fill scope. Both integrated into the blade layout.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no new type errors
2. `npx vite build` -- successful build
3. Open CC blade with empty form: 7 template chips visible in "Quick Start" section
4. Click "Bug Fix" template: type set to "fix", description pre-filled, chips collapse, badge shows
5. Clear form: chips reappear
6. Scope frequency chart in right panel: shows top scopes as horizontal bars
7. Click a scope bar: scope input fills with that value
8. Collapse/expand scope chart: toggle works
9. "Show all" link appears when > 8 scopes, toggles between 8 and all
</verification>

<success_criteria>
- 7 built-in templates with icons: New Feature, Bug Fix, Breaking Change, Dependency Update, Documentation, Refactor, CI/CD
- TemplateSelector: chips when empty, badge when active, hidden when manually typing
- ScopeFrequencyChart: horizontal bars, Catppuccin colors, collapsible, clickable, show-all toggle
- Both components integrated into the blade's slot architecture (TOOLBAR and RIGHT_MIDDLE)
- Template application fills all form fields from template.fields
- Scope click fills the scope input
</success_criteria>

<output>
After completion, create `.planning/phases/28-conventional-commit-blade/28-05-SUMMARY.md`
</output>
