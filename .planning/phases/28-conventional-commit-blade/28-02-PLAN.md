---
phase: 28-conventional-commit-blade
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useCommitExecution.ts
  - src/hooks/useAmendPrefill.ts
  - src/components/commit/CommitPreview.tsx
  - src/components/commit/CommitActionBar.tsx
  - src/components/commit/ConventionalCommitForm.tsx
  - src/components/commit/CommitForm.tsx
  - src/components/commit/TypeSelector.tsx
autonomous: true

must_haves:
  truths:
    - "Commit and push mutation logic is in a reusable hook, not duplicated in CommitForm.tsx"
    - "Amend pre-fill logic is in a reusable hook, not duplicated in CommitForm.tsx"
    - "CommitPreview is a standalone component with compact and full variants"
    - "CommitActionBar is a standalone component with commit/push/amend button states"
    - "ConventionalCommitForm uses the extracted CommitPreview and CommitActionBar"
    - "CommitForm uses useCommitExecution and useAmendPrefill instead of inline mutations"
    - "TypeSelector accepts an optional columns prop for wider layouts"
    - "Sidebar commit flow works identically after extraction"
  artifacts:
    - path: "src/hooks/useCommitExecution.ts"
      provides: "Commit and push mutation hooks with React Query invalidation"
      exports: ["useCommitExecution"]
    - path: "src/hooks/useAmendPrefill.ts"
      provides: "Amend toggle with last commit message pre-fill"
      exports: ["useAmendPrefill"]
    - path: "src/components/commit/CommitPreview.tsx"
      provides: "Commit message preview with compact/full variants"
      exports: ["CommitPreview"]
    - path: "src/components/commit/CommitActionBar.tsx"
      provides: "Action buttons for commit/push/amend workflows"
      exports: ["CommitActionBar"]
  key_links:
    - from: "src/components/commit/CommitForm.tsx"
      to: "src/hooks/useCommitExecution.ts"
      via: "hook import"
      pattern: "useCommitExecution"
    - from: "src/components/commit/CommitForm.tsx"
      to: "src/hooks/useAmendPrefill.ts"
      via: "hook import"
      pattern: "useAmendPrefill"
    - from: "src/components/commit/ConventionalCommitForm.tsx"
      to: "src/components/commit/CommitPreview.tsx"
      via: "component import"
      pattern: "CommitPreview"
---

<objective>
Extract commit execution logic, amend pre-fill logic, and UI primitives (preview + action bar) from inline implementations into reusable hooks and components.

Purpose: Enable both the existing sidebar form and the new full-width blade to share the same commit/push/amend logic and UI primitives without duplication. This is the second half of the refactoring prerequisite for the blade.

Output: Four new files (`useCommitExecution.ts`, `useAmendPrefill.ts`, `CommitPreview.tsx`, `CommitActionBar.tsx`) and updated sidebar forms that consume them.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-conventional-commit-blade/28-RESEARCH.md

@src/components/commit/CommitForm.tsx
@src/components/commit/ConventionalCommitForm.tsx
@src/hooks/useConventionalCommit.ts
@src/stores/conventional.ts
@src/bindings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract useCommitExecution and useAmendPrefill hooks</name>
  <files>src/hooks/useCommitExecution.ts, src/hooks/useAmendPrefill.ts</files>
  <action>
**Create `src/hooks/useCommitExecution.ts`:**

Extract the commit and push mutation logic from `CommitForm.tsx` lines 80-119 into a reusable hook:

```typescript
interface UseCommitExecutionOptions {
  onCommitSuccess?: (message: string) => void;
  onPushSuccess?: () => void;
  onPushError?: (error: unknown) => void;
}

export function useCommitExecution(options?: UseCommitExecutionOptions) {
  const queryClient = useQueryClient();

  const pushMutation = useMutation({
    mutationFn: () => {
      const channel = new Channel<SyncProgress>();
      return commands.pushToRemote("origin", channel);
    },
    onSuccess: () => {
      toast.success("Pushed to origin");
      queryClient.invalidateQueries({ queryKey: ["commitHistory"] });
      options?.onPushSuccess?.();
    },
    onError: (error) => {
      toast.error(`Push failed: ${String(error)}`, {
        label: "Retry",
        onClick: () => pushMutation.mutate(),
      });
      options?.onPushError?.(error);
    },
  });

  const commitMutation = useMutation({
    mutationFn: ({ message, amend }: { message: string; amend: boolean }) =>
      commands.createCommit(message, amend),
    onSuccess: (_data, { message: commitMessage }) => {
      queryClient.invalidateQueries({ queryKey: ["stagingStatus"] });
      queryClient.invalidateQueries({ queryKey: ["commitHistory"] });
      queryClient.invalidateQueries({ queryKey: ["repositoryStatus"] });

      const shortMessage =
        commitMessage.length > 50 ? `${commitMessage.slice(0, 50)}...` : commitMessage;
      toast.success(`Committed: ${shortMessage}`, {
        label: "Push now",
        onClick: () => pushMutation.mutate(),
      });
      options?.onCommitSuccess?.(commitMessage);
    },
    onError: (error) => {
      toast.error(`Commit failed: ${String(error)}`);
    },
  });

  const commit = (message: string, amend = false) =>
    commitMutation.mutateAsync({ message, amend });

  const commitAndPush = async (message: string, amend = false) => {
    await commitMutation.mutateAsync({ message, amend });
    await pushMutation.mutateAsync();
  };

  const push = () => pushMutation.mutateAsync();

  return {
    commit,
    commitAndPush,
    push,
    isCommitting: commitMutation.isPending,
    isPushing: pushMutation.isPending,
    isBusy: commitMutation.isPending || pushMutation.isPending,
    commitError: commitMutation.error,
    pushError: pushMutation.error,
  };
}
```

Import `Channel` from `@tauri-apps/api/core`, `useMutation`/`useQueryClient` from `@tanstack/react-query`, `commands`/`SyncProgress` from bindings, `toast` from stores.

**Create `src/hooks/useAmendPrefill.ts`:**

Extract the amend pre-fill logic from `CommitForm.tsx` lines 19-73:

```typescript
interface UseAmendPrefillOptions {
  mode: "simple" | "conventional";
}

export function useAmendPrefill({ mode }: UseAmendPrefillOptions) {
  const [amend, setAmend] = useState(false);

  const { data: lastMessageResult, refetch: refetchLastMessage } = useQuery({
    queryKey: ["lastCommitMessage"],
    queryFn: () => commands.getLastCommitMessage(),
    enabled: false,
  });

  const lastMessage =
    lastMessageResult?.status === "ok" ? lastMessageResult.data : null;

  const toggleAmend = useCallback(
    async (
      checked: boolean,
      callbacks: {
        onPrefill?: (fullMessage: string) => void;
        onClear?: () => void;
        hasContent?: boolean;
      },
    ) => {
      if (checked) {
        const result = await refetchLastMessage();
        const fetchedMessage =
          result.data?.status === "ok" ? result.data.data : null;

        if (fetchedMessage) {
          if (!callbacks.hasContent) {
            callbacks.onPrefill?.(fetchedMessage.fullMessage);
            setAmend(true);
          } else {
            const shouldReplace = window.confirm(
              "You have unsaved text. Replace with previous commit message?",
            );
            if (shouldReplace) {
              callbacks.onPrefill?.(fetchedMessage.fullMessage);
            }
            setAmend(true);
          }
        } else {
          setAmend(true);
        }
      } else {
        setAmend(false);
        callbacks.onClear?.();
      }
    },
    [refetchLastMessage],
  );

  return { amend, setAmend, toggleAmend, lastMessage, refetchLastMessage };
}
```

Import `useState`/`useCallback` from React, `useQuery` from `@tanstack/react-query`, `commands` from bindings.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors in the new hook files.</verify>
  <done>Two reusable hooks exist: `useCommitExecution` for commit/push mutations, `useAmendPrefill` for amend toggle and pre-fill. Both are framework-agnostic enough for sidebar and blade use.</done>
</task>

<task type="auto">
  <name>Task 2: Extract CommitPreview and CommitActionBar UI primitives</name>
  <files>src/components/commit/CommitPreview.tsx, src/components/commit/CommitActionBar.tsx, src/components/commit/TypeSelector.tsx</files>
  <action>
**Create `src/components/commit/CommitPreview.tsx`:**

Extract the inline preview from `ConventionalCommitForm.tsx` lines 153-168 into a standalone component with two layout variants:

```typescript
interface CommitPreviewProps {
  message: string;
  variant?: "compact" | "full";
}

export function CommitPreview({ message, variant = "compact" }: CommitPreviewProps) {
  if (!message) return null;

  return (
    <div className="space-y-2">
      <label className="text-sm font-medium text-ctp-subtext1">Preview</label>
      <pre
        className={cn(
          "p-3 text-sm bg-ctp-mantle border border-ctp-surface0 rounded",
          "text-ctp-subtext1 font-mono whitespace-pre-wrap wrap-break-words",
          variant === "compact"
            ? "max-h-32 overflow-y-auto"
            : "min-h-[300px] flex-1 overflow-y-auto",
        )}
        aria-live="polite"
      >
        {message}
      </pre>
    </div>
  );
}
```

The `compact` variant matches the current sidebar behavior (max-h-32). The `full` variant is for the blade (min-h-[300px], flex-1). Syntax highlighting and the column-72 ruler will be added in Plan 04.

**Create `src/components/commit/CommitActionBar.tsx`:**

Extract the action buttons from `ConventionalCommitForm.tsx` lines 171-199 into a standalone component:

```typescript
interface CommitActionBarProps {
  canCommit: boolean;
  disabled?: boolean;
  isCommitting?: boolean;
  isPushing?: boolean;
  amend?: boolean;
  showPush?: boolean;
  onCommit: () => void;
  onCommitAndPush?: () => void;
  onCancel?: () => void;
}

export function CommitActionBar({
  canCommit,
  disabled = false,
  isCommitting = false,
  isPushing = false,
  amend = false,
  showPush = false,
  onCommit,
  onCommitAndPush,
  onCancel,
}: CommitActionBarProps) {
  const isBusy = isCommitting || isPushing;

  return (
    <div className="flex justify-end gap-2 pt-2">
      {onCancel && (
        <button type="button" onClick={onCancel}
          disabled={disabled || isBusy}
          className={cn(
            "px-4 py-2 text-sm font-medium rounded",
            "text-ctp-subtext1 bg-ctp-surface1 hover:bg-ctp-surface0",
            "focus:outline-none focus:ring-2 focus:ring-ctp-overlay0",
            "disabled:opacity-50 disabled:cursor-not-allowed",
          )}
        >
          Cancel
        </button>
      )}
      {showPush && onCommitAndPush && (
        <button type="button" onClick={onCommitAndPush}
          disabled={!canCommit || disabled || isBusy}
          className={cn(
            "px-4 py-2 text-sm font-medium rounded flex items-center gap-2",
            amend
              ? "text-ctp-base bg-ctp-peach hover:bg-ctp-yellow"
              : "text-ctp-base bg-ctp-green hover:bg-ctp-teal",
            "focus:outline-none focus:ring-2 focus:ring-ctp-green",
            "disabled:opacity-50 disabled:cursor-not-allowed",
          )}
        >
          {isBusy ? (
            <><Loader2 className="w-4 h-4 animate-spin" />{isPushing ? "Pushing..." : "Committing..."}</>
          ) : amend ? (
            <><RotateCcw className="w-4 h-4" />Amend & Force Push</>
          ) : (
            "Commit & Push"
          )}
        </button>
      )}
      <button type="submit" onClick={onCommit}
        disabled={!canCommit || disabled || isBusy}
        className={cn(
          "px-4 py-2 text-sm font-medium rounded flex items-center gap-2",
          "text-ctp-base bg-ctp-blue hover:bg-ctp-sapphire",
          "focus:outline-none focus:ring-2 focus:ring-ctp-blue",
          "disabled:opacity-50 disabled:cursor-not-allowed",
        )}
      >
        {isCommitting ? (
          <><Loader2 className="w-4 h-4 animate-spin" />Committing...</>
        ) : amend ? (
          <><RotateCcw className="w-4 h-4" />Amend Commit</>
        ) : (
          "Commit"
        )}
      </button>
    </div>
  );
}
```

Import `Loader2` and `RotateCcw` from `lucide-react`, `cn` from `../../lib/utils`.

**Modify `src/components/commit/TypeSelector.tsx`:**

Add an optional `columns` prop that controls the grid layout:

- Add to interface: `columns?: 4 | 6;` (default 4)
- Change the grid class from `"grid grid-cols-4 gap-2"` to `cn("grid gap-2", columns === 6 ? "grid-cols-6" : "grid-cols-4")`
- Default is 4 (sidebar layout), 6 for the blade layout (renders 11 types in 2 rows instead of 3)
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. The new components export correctly.</verify>
  <done>CommitPreview and CommitActionBar exist as standalone components. TypeSelector accepts `columns` prop. All are ready for consumption by both sidebar and blade.</done>
</task>

<task type="auto">
  <name>Task 3: Migrate sidebar forms to use extracted hooks and primitives</name>
  <files>src/components/commit/ConventionalCommitForm.tsx, src/components/commit/CommitForm.tsx</files>
  <action>
**Modify `src/components/commit/ConventionalCommitForm.tsx`:**

1. Replace the inline preview (lines 153-168) with: `<CommitPreview message={currentMessage} variant="compact" />`
2. Replace the inline action buttons (lines 171-199) with: `<CommitActionBar canCommit={canCommit} disabled={disabled} onCommit={handleSubmit} onCancel={onCancel ? handleCancel : undefined} />`
3. Add imports: `import { CommitPreview } from "./CommitPreview";` and `import { CommitActionBar } from "./CommitActionBar";`
4. Remove the `handleSubmit` wrapping in the form `onSubmit` -- instead pass it directly to `CommitActionBar`'s `onCommit`. Keep the `<form>` element for keyboard Enter support, but the submit button is now inside `CommitActionBar`.
5. The form still wraps everything in `<form onSubmit={handleSubmit}>`, and `CommitActionBar`'s commit button has `type="submit"` which triggers form submission.

**Modify `src/components/commit/CommitForm.tsx`:**

1. Replace inline `commitMutation` and `pushMutation` (lines 80-119) with:
   ```typescript
   const { commit, isCommitting, commitError } = useCommitExecution({
     onCommitSuccess: () => {
       setMessage("");
       setAmend(false);
     },
   });
   ```
   Import `useCommitExecution` from `../../hooks/useCommitExecution`.

2. Replace inline amend logic (lines 19-73) with:
   ```typescript
   const { amend, toggleAmend } = useAmendPrefill({ mode: "simple" });
   ```
   Import `useAmendPrefill` from `../../hooks/useAmendPrefill`.

3. Update the amend checkbox `onChange` to use `toggleAmend`:
   ```typescript
   onChange={(e) => toggleAmend(e.target.checked, {
     onPrefill: (msg) => setMessage(msg),
     onClear: () => setMessage(""),
     hasContent: message.trim().length > 0,
   })}
   ```

4. Update the commit button `onClick` to use the new `commit` function:
   ```typescript
   onClick={() => {
     if (amend) {
       const confirmed = window.confirm("Amend will rewrite the last commit...");
       if (!confirmed) return;
     }
     commit(message, amend);
   }}
   ```

5. Update the conventional commit handler:
   ```typescript
   const handleConventionalCommit = (commitMessage: string) => {
     commit(commitMessage, false);
   };
   ```

6. Replace `commitMutation.isPending` with `isCommitting`, `commitMutation.isError` with `!!commitError`, `commitMutation.error` with `commitError`.

7. Remove the now-unused imports: `Channel`, `SyncProgress`, direct `useMutation`, `useQuery` for lastCommitMessage (if fully extracted).

8. Keep the `useEffect` for `toggle-amend` event listener, but update it to use `toggleAmend` from the hook.

**CRITICAL: The sidebar must look and behave identically after this refactoring.** The visual output must not change -- only the internal structure changes. Specifically:
- Same button styles, same toast messages, same confirmation dialogs
- Same amend pre-fill behavior
- Same character count display
- Same error display
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Run `npx vite build` -- builds successfully. Visual inspection: sidebar commit form looks identical.</verify>
  <done>CommitForm.tsx uses useCommitExecution and useAmendPrefill hooks. ConventionalCommitForm.tsx uses CommitPreview and CommitActionBar components. Sidebar behavior is identical. No duplicate mutation or amend logic remains in the form components.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no new type errors
2. `npx vite build` -- successful build
3. Sidebar simple commit form: type message, commit works, amend works, push toast appears
4. Sidebar CC form: select type, add scope, description, commit works, preview shows
5. No duplicate commit/push mutation logic in CommitForm.tsx
6. No inline preview or action buttons in ConventionalCommitForm.tsx
</verification>

<success_criteria>
- useCommitExecution hook provides commit, commitAndPush, push methods
- useAmendPrefill hook provides amend toggle with pre-fill
- CommitPreview has compact/full variants
- CommitActionBar has commit/push/amend button states
- TypeSelector has columns prop (4 or 6)
- Both sidebar forms consume the new hooks/components
- Sidebar behavior is visually and functionally identical
</success_criteria>

<output>
After completion, create `.planning/phases/28-conventional-commit-blade/28-02-SUMMARY.md`
</output>
