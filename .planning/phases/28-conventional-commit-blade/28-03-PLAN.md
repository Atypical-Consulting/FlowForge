---
phase: 28-conventional-commit-blade
plan: 03
type: execute
wave: 2
depends_on: ["28-01", "28-02"]
files_modified:
  - src/stores/bladeTypes.ts
  - src/components/blades/registrations/index.ts
  - src/components/blades/registrations/conventional-commit.ts
  - src/machines/navigation/navigationMachine.ts
  - src/components/blades/ConventionalCommitBlade.tsx
  - src/components/commit/CommitForm.tsx
autonomous: true

must_haves:
  truths:
    - "User can open a full-width Conventional Commit blade from the sidebar Expand button"
    - "Blade renders a two-column SplitPaneLayout with form on the left and preview on the right"
    - "Blade is a singleton (cannot be opened twice)"
    - "Sidebar shows a placeholder when the blade is open"
    - "Form state persists when switching between sidebar and blade"
    - "Dirty form guard prevents accidental navigation away"
  artifacts:
    - path: "src/components/blades/ConventionalCommitBlade.tsx"
      provides: "Full-width CC blade with SplitPaneLayout"
      exports: ["ConventionalCommitBlade"]
      min_lines: 80
    - path: "src/components/blades/registrations/conventional-commit.ts"
      provides: "Blade registration with singleton enforcement"
      contains: "registerBlade"
    - path: "src/stores/bladeTypes.ts"
      provides: "conventional-commit type in BladePropsMap"
      contains: "conventional-commit"
  key_links:
    - from: "src/components/blades/ConventionalCommitBlade.tsx"
      to: "src/hooks/useConventionalCommit.ts"
      via: "hook import"
      pattern: "useConventionalCommit"
    - from: "src/components/blades/ConventionalCommitBlade.tsx"
      to: "src/components/commit/CommitPreview.tsx"
      via: "component import"
      pattern: "CommitPreview"
    - from: "src/components/commit/CommitForm.tsx"
      to: "src/hooks/useBladeNavigation.ts"
      via: "Expand button opens blade"
      pattern: "openBlade.*conventional-commit"
---

<objective>
Create the Conventional Commit blade shell with SplitPaneLayout, register it in the blade system, and wire up sidebar coexistence with an Expand button.

Purpose: Deliver the core blade workspace (CC-01, CC-02) and sidebar coexistence (CC-07) so users can compose commits in both compact sidebar and full-width blade modes.

Output: Working `ConventionalCommitBlade.tsx` with form and preview panels, blade registration, and sidebar Expand button.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-conventional-commit-blade/28-RESEARCH.md
@.planning/phases/28-conventional-commit-blade/28-01-SUMMARY.md
@.planning/phases/28-conventional-commit-blade/28-02-SUMMARY.md

@src/stores/bladeTypes.ts
@src/components/blades/registrations/index.ts
@src/components/blades/registrations/init-repo.ts
@src/machines/navigation/navigationMachine.ts
@src/components/blades/InitRepoBlade.tsx
@src/hooks/useBladeNavigation.ts
@src/hooks/useBladeFormGuard.ts
@src/hooks/useConventionalCommit.ts
@src/components/commit/CommitForm.tsx
@src/components/commit/CommitPreview.tsx
@src/components/commit/CommitActionBar.tsx
@src/components/commit/TypeSelector.tsx
@src/components/commit/ScopeAutocomplete.tsx
@src/components/commit/BreakingChangeSection.tsx
@src/components/commit/CharacterProgress.tsx
@src/components/commit/ValidationErrors.tsx
@src/components/layout/SplitPaneLayout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register conventional-commit blade type and infrastructure</name>
  <files>src/stores/bladeTypes.ts, src/components/blades/registrations/conventional-commit.ts, src/components/blades/registrations/index.ts, src/machines/navigation/navigationMachine.ts</files>
  <action>
1. **Modify `src/stores/bladeTypes.ts`:**
   Add `"conventional-commit"` to the `BladePropsMap` interface:
   ```typescript
   "conventional-commit": { amend?: boolean };
   ```
   Place it after `"init-repo"`.

2. **Create `src/components/blades/registrations/conventional-commit.ts`:**
   Follow the exact pattern from `init-repo.ts`:
   ```typescript
   import { registerBlade } from "../../../lib/bladeRegistry";
   import { ConventionalCommitBlade } from "../ConventionalCommitBlade";

   registerBlade<{ amend?: boolean }>({
     type: "conventional-commit",
     defaultTitle: "Conventional Commit",
     component: ConventionalCommitBlade,
     singleton: true,
   });
   ```

3. **Modify `src/components/blades/registrations/index.ts`:**
   Add `"conventional-commit"` to the `EXPECTED_TYPES` array (line 18, after `"init-repo"`).

4. **Modify `src/machines/navigation/navigationMachine.ts`:**
   Add `"conventional-commit"` to the `SINGLETON_TYPES` Set (line 13):
   ```typescript
   const SINGLETON_TYPES = new Set(["settings", "changelog", "gitflow-cheatsheet", "conventional-commit"]);
   ```
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. The registration file will be auto-discovered by the glob import in `index.ts`.</verify>
  <done>Blade type `"conventional-commit"` is in BladePropsMap, registration file exists with singleton enforcement, EXPECTED_TYPES and SINGLETON_TYPES both include the new type.</done>
</task>

<task type="auto">
  <name>Task 2: Build ConventionalCommitBlade and wire sidebar coexistence</name>
  <files>src/components/blades/ConventionalCommitBlade.tsx, src/components/commit/CommitForm.tsx</files>
  <action>
**Create `src/components/blades/ConventionalCommitBlade.tsx`:**

Build the blade using the slot-based architecture from the research. Use `SplitPaneLayout` with `autoSaveId="cc-blade-split"` for persistent user-adjusted split ratio.

```typescript
import { useEffect, useRef } from "react";
import { useConventionalCommit } from "../../hooks/useConventionalCommit";
import { useCommitExecution } from "../../hooks/useCommitExecution";
import { useBladeFormGuard } from "../../hooks/useBladeFormGuard";
import { useConventionalStore } from "../../stores/conventional";
import { SplitPaneLayout } from "../layout/SplitPaneLayout";
import { TypeSelector } from "../commit/TypeSelector";
import { ScopeAutocomplete } from "../commit/ScopeAutocomplete";
import { BreakingChangeSection } from "../commit/BreakingChangeSection";
import { CharacterProgress } from "../commit/CharacterProgress";
import { ValidationErrors } from "../commit/ValidationErrors";
import { CommitPreview } from "../commit/CommitPreview";
import { CommitActionBar } from "../commit/CommitActionBar";
import { cn } from "../../lib/utils";

const MAX_DESCRIPTION_LENGTH = 72;

interface ConventionalCommitBladeProps {
  amend?: boolean;
}

export function ConventionalCommitBlade({ amend: initialAmend }: ConventionalCommitBladeProps) {
  // [Implementation details below]
}
```

**Left panel (form):**
- Reuse the same components as `ConventionalCommitForm`: `TypeSelector` (with `columns={6}`), `ScopeAutocomplete`, description input, body textarea (with `rows={8}` for more space), `BreakingChangeSection`, `CharacterProgress`, `ValidationErrors`.
- All connected through `useConventionalCommit()` hook (shares state with sidebar via Zustand).
- Initialize suggestions on mount via `initializeSuggestions()`.

**Right panel (preview):**
- `CommitPreview` with `variant="full"`.
- A section header "Message Preview" above it.
- For now, just the preview. Scope frequency chart and templates will be added in Plan 05.

**Footer area (below SplitPaneLayout):**
- `CommitActionBar` with `showPush={true}`, connected to `useCommitExecution`.
- `canCommit` from `useConventionalCommit`.
- `onCommit` calls `commit(currentMessage)`, `onCommitAndPush` calls `commitAndPush(currentMessage)`.

**Dirty form guard:**
- Use `useBladeFormGuard` with the blade's ID.
- Mark dirty when `description` or `commitType` has content: `useEffect` watches `description` and `commitType`, calls `markDirty()` if either is non-empty, `markClean()` if both are empty.
- The blade ID should be derived from props or a stable identifier. Use `"conventional-commit-blade"` as a stable ID since it's a singleton.

**On mount with `initialAmend`:**
- If `amend` prop is true, set `useConventionalStore.getState().setIsAmend(true)` on mount. Full amend pre-fill logic will be wired in Plan 04.

**Layout structure:**
```tsx
<div className="flex flex-col h-full">
  {/* Main content with split pane */}
  <div className="flex-1 min-h-0">
    <SplitPaneLayout
      autoSaveId="cc-blade-split"
      primary={<CommitBladeForm />}
      detail={<CommitBladePreview />}
    />
  </div>
  {/* Footer with action buttons */}
  <div className="border-t border-ctp-surface0 p-4 bg-ctp-crust">
    <CommitActionBar ... />
  </div>
</div>
```

The `CommitBladeForm` and `CommitBladePreview` can be inline sub-components (not separate files) to keep the blade self-contained while maintaining the slot-based architecture. They can be extracted to separate files later during Phase 29 (file restructuring).

**Modify `src/components/commit/CommitForm.tsx`:**

Add an "Expand" button to the sidebar commit area:

1. Import `useBladeNavigation` from `../../hooks/useBladeNavigation` and `Maximize2` from `lucide-react`.
2. Add a state check: detect if the CC blade is already open by checking `bladeStack.some(b => b.type === "conventional-commit")`.
3. When the CC blade is open AND `useConventional` is true, show a placeholder instead of the `ConventionalCommitForm`:
   ```tsx
   <div className="flex flex-col items-center gap-2 py-6 text-ctp-overlay1">
     <span className="text-sm">Editing in blade view</span>
     <button
       onClick={() => /* focus the blade - no-op for now, blade is already visible */}
       className="text-xs text-ctp-blue hover:text-ctp-sapphire"
     >
       Return to blade
     </button>
   </div>
   ```
4. When `useConventional` is true AND the blade is NOT open, add an "Expand" button next to the "Conventional Commits" checkbox:
   ```tsx
   <button
     type="button"
     onClick={() => openBlade("conventional-commit", {}, "Conventional Commit")}
     className="p-1 text-ctp-overlay1 hover:text-ctp-blue rounded"
     title="Open in full-width blade"
   >
     <Maximize2 className="w-4 h-4" />
   </button>
   ```
   Place it to the right of the "Conventional Commits" label/checkbox.
5. The Expand button only appears when `useConventional` is checked.
  </action>
  <verify>Run `npx tsc --noEmit` and `npx vite build` -- both pass. The blade opens when clicking Expand. The sidebar shows placeholder when blade is open. Form state persists between sidebar and blade.</verify>
  <done>ConventionalCommitBlade renders with two-column SplitPaneLayout. Sidebar has Expand button. Placeholder shows when blade is open. Form state shared via Zustand store. Dirty form guard active.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no new type errors
2. `npx vite build` -- successful build
3. Click "Conventional Commits" in sidebar, then click Expand icon -- blade opens
4. Blade shows two-column layout: form left, preview right
5. Type in blade form -- preview updates in real time
6. Sidebar shows "Editing in blade view" while blade is open
7. Press Back/Escape -- blade closes, sidebar CC form reappears with same state
8. Cannot open a second CC blade (singleton guard)
9. With content in form, navigating away triggers dirty form confirmation
</verification>

<success_criteria>
- CC blade opens as a full-width singleton blade
- Two-column SplitPaneLayout with persistent split ratio
- TypeSelector uses 6 columns in blade, body textarea has 8 rows
- CommitPreview shows in full variant in right panel
- CommitActionBar shows commit + push buttons in footer
- Sidebar Expand button opens the blade
- Sidebar shows placeholder when blade is open
- State persists bidirectionally via shared Zustand store
- Dirty form guard works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/28-conventional-commit-blade/28-03-SUMMARY.md`
</output>
