---
phase: 28-conventional-commit-blade
plan: 04
type: execute
wave: 3
depends_on: ["28-03"]
files_modified:
  - src/components/commit/CommitPreview.tsx
  - src/components/blades/ConventionalCommitBlade.tsx
  - src/hooks/useAmendPrefill.ts
  - src/components/commit/CommitActionBar.tsx
autonomous: true

must_haves:
  truths:
    - "User can see syntax-highlighted preview with type in its CC theme color, scope in teal, breaking indicator in red"
    - "User can see a column-72 ruler in the full preview variant"
    - "User can copy the formatted commit message to clipboard from the preview"
    - "User can commit and push in a single action from the blade"
    - "User is auto-navigated back to staging 1.5 seconds after successful commit"
    - "User can cancel auto-navigation by clicking Stay here"
    - "User can toggle amend mode and see fields pre-filled from the last commit"
    - "User sees a warning banner when amend mode is active"
    - "Amend commit shows confirmation dialog before executing"
  artifacts:
    - path: "src/components/commit/CommitPreview.tsx"
      provides: "Syntax-highlighted preview with ruler and copy button"
      exports: ["CommitPreview"]
    - path: "src/components/blades/ConventionalCommitBlade.tsx"
      provides: "Blade with amend toggle, success state, auto-navigate timer"
      contains: "AmendBanner"
  key_links:
    - from: "src/components/blades/ConventionalCommitBlade.tsx"
      to: "src/hooks/useBladeNavigation.ts"
      via: "goBack() for auto-navigate"
      pattern: "goBack"
    - from: "src/components/blades/ConventionalCommitBlade.tsx"
      to: "src/hooks/useAmendPrefill.ts"
      via: "amend pre-fill with CC parsing"
      pattern: "useAmendPrefill"
    - from: "src/components/blades/ConventionalCommitBlade.tsx"
      to: "src/hooks/useCommitExecution.ts"
      via: "commitAndPush pipeline"
      pattern: "commitAndPush"
---

<objective>
Enhance the CommitPreview with syntax highlighting and ruler, wire the commit+push pipeline with auto-navigation, and implement full amend mode with pre-filled fields and warning banner.

Purpose: Deliver CC-03 (enhanced preview), CC-04 (commit+push), CC-05 (auto-navigate back), and CC-06 (amend with pre-fill) -- the workflow and interaction features that make the blade a complete commit workspace.

Output: Enhanced `CommitPreview.tsx` with syntax coloring, `ConventionalCommitBlade.tsx` with amend toggle, success animation, and auto-navigate timer.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-conventional-commit-blade/28-RESEARCH.md
@.planning/phases/28-conventional-commit-blade/28-01-SUMMARY.md
@.planning/phases/28-conventional-commit-blade/28-02-SUMMARY.md
@.planning/phases/28-conventional-commit-blade/28-03-SUMMARY.md

@src/components/commit/CommitPreview.tsx
@src/components/blades/ConventionalCommitBlade.tsx
@src/hooks/useAmendPrefill.ts
@src/hooks/useCommitExecution.ts
@src/hooks/useBladeNavigation.ts
@src/hooks/useConventionalCommit.ts
@src/lib/conventional-utils.ts
@src/lib/commit-type-theme.ts
@src/stores/conventional.ts
@src/components/commit/CommitActionBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance CommitPreview with syntax highlighting, ruler, and copy button</name>
  <files>src/components/commit/CommitPreview.tsx</files>
  <action>
Upgrade the `CommitPreview` component (created in Plan 02) to support syntax-highlighted rendering in the `full` variant.

**Syntax highlighting approach:**
Instead of rendering the message as a plain `<pre>` text, parse the subject line and render each segment as a `<span>` with the appropriate color class:

1. Parse the first line (subject) using `parseConventionalMessage` from `../../lib/conventional-utils`.
2. If it parses successfully, render the subject as:
   - **Type** (`feat`, `fix`, etc.): Use the Catppuccin color from `COMMIT_TYPE_THEME[type].color` (the CSS variable). Apply it as `style={{ color: "var(--catppuccin-color-TYPE_COLOR)" }}` or use the appropriate `text-ctp-*` class. Import `COMMIT_TYPE_THEME` from `../../lib/commit-type-theme` and get the color for the parsed type.
   - **Scope** (if present, including parentheses): `text-ctp-teal`
   - **Breaking indicator** (`!`): `text-ctp-red font-bold`
   - **Colon separator** (`: `): `text-ctp-overlay1`
   - **Description text**: `text-ctp-text`
3. If it does not parse (not CC format), render the entire subject in `text-ctp-text`.
4. Body and footer lines: render in `text-ctp-subtext1`. If a line starts with `BREAKING CHANGE:`, render the label in `text-ctp-red font-bold` and the content in `text-ctp-subtext1`.

**Column-72 ruler (full variant only):**
Add a subtle vertical line at column 72. Implementation:
- Use a `::before` pseudo-element on the `<pre>` container, or an absolutely positioned `<div>` inside a `relative` wrapper.
- Position: `left: calc(72ch + padding)` (account for the `p-3` padding = 0.75rem).
- Style: `border-left: 1px dashed` with `border-ctp-surface2` (very subtle).
- Only render in `full` variant.
- Add a small label at the top: `"72"` in `text-ctp-surface2 text-[10px]`.

**Copy-to-clipboard button (full variant only):**
- Add a button in the top-right corner of the preview header area.
- Use `Copy` icon from lucide-react. On click, copy `message` to clipboard via `navigator.clipboard.writeText(message)`.
- Show `Check` icon for 2 seconds after copying, then revert to `Copy`.
- Position: absolute top-right of the preview container, or in the label row next to "Preview".

**Character count for subject line (full variant only):**
- Below the preview, show: `Subject: {length}/72 characters` with color coding (green <= 50, yellow 51-72, red > 72).

The `compact` variant remains unchanged (plain text, max-h-32, no ruler, no copy, no highlighting).
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Open the CC blade, type a commit message -- preview shows colored segments, ruler at column 72, copy button works.</verify>
  <done>CommitPreview full variant has syntax-highlighted segments (type in CC color, scope in teal, breaking in red), column-72 ruler, copy button, and subject character count. Compact variant unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Wire commit+push pipeline and auto-navigate with success state</name>
  <files>src/components/blades/ConventionalCommitBlade.tsx</files>
  <action>
Add the commit+push pipeline workflow and post-commit auto-navigation to the blade.

**Success state management:**
Add local state to the blade:
```typescript
const [commitSuccess, setCommitSuccess] = useState(false);
const [stayHere, setStayHere] = useState(false);
const timerRef = useRef<ReturnType<typeof setTimeout> | null>(null);
```

**Wire useCommitExecution with callbacks:**
```typescript
const { commit, commitAndPush, isCommitting, isPushing, isBusy } = useCommitExecution({
  onCommitSuccess: () => {
    setCommitSuccess(true);
    store.reset(); // Clear form state
    markClean(); // Remove dirty flag

    if (!stayHere) {
      timerRef.current = setTimeout(() => {
        goBack(); // Auto-navigate back
      }, 1500);
    }
  },
});
```

Where `goBack` comes from `useBladeNavigation()`, `store` is `useConventionalStore`, and `markClean` from `useBladeFormGuard`.

**Commit handlers:**
```typescript
const handleCommit = () => {
  if (store.isAmend) {
    const confirmed = window.confirm("Amend will rewrite the last commit. This cannot be undone. Continue?");
    if (!confirmed) return;
  }
  commit(currentMessage, store.isAmend);
};

const handleCommitAndPush = async () => {
  if (store.isAmend) {
    const confirmed = window.confirm("This will amend the last commit and force push. This cannot be undone. Continue?");
    if (!confirmed) return;
  }
  commitAndPush(currentMessage, store.isAmend);
};
```

**Success overlay:**
When `commitSuccess` is true, render an overlay inside the blade:
```tsx
{commitSuccess && (
  <motion.div
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    className="absolute inset-0 flex flex-col items-center justify-center bg-ctp-base/90 z-10"
  >
    <motion.div initial={{ scale: 0 }} animate={{ scale: 1 }} transition={{ type: "spring" }}>
      <Check className="w-16 h-16 text-ctp-green" />
    </motion.div>
    <p className="mt-4 text-lg text-ctp-text">Commit successful!</p>
    <button
      onClick={() => { setStayHere(true); setCommitSuccess(false); if (timerRef.current) clearTimeout(timerRef.current); }}
      className="mt-2 text-sm text-ctp-blue hover:text-ctp-sapphire underline"
    >
      Stay here
    </button>
  </motion.div>
)}
```

**Cleanup timer on unmount:**
```typescript
useEffect(() => {
  return () => {
    if (timerRef.current) clearTimeout(timerRef.current);
  };
}, []);
```

**Pass to CommitActionBar:**
Update the `CommitActionBar` in the blade footer:
```tsx
<CommitActionBar
  canCommit={canCommit}
  isCommitting={isCommitting}
  isPushing={isPushing}
  amend={store.isAmend}
  showPush={true}
  onCommit={handleCommit}
  onCommitAndPush={handleCommitAndPush}
/>
```

The blade's outer `<div>` needs `className="relative flex flex-col h-full"` so the success overlay positions correctly.
  </action>
  <verify>Run `npx tsc --noEmit`. In the app: open CC blade, fill form, click Commit -- success overlay shows with check icon for 1.5s then blade auto-pops. Click "Commit & Push" -- both operations execute. Click "Stay here" -- auto-navigate cancels.</verify>
  <done>Commit and commitAndPush work from the blade. Success overlay with checkmark animation shows for 1.5s. Auto-navigate pops blade after delay. "Stay here" cancels the timer. Amend mode shows confirmation dialog.</done>
</task>

<task type="auto">
  <name>Task 3: Implement amend mode with pre-fill, warning banner, and CC parsing</name>
  <files>src/components/blades/ConventionalCommitBlade.tsx, src/hooks/useAmendPrefill.ts</files>
  <action>
**Enhance `src/hooks/useAmendPrefill.ts`:**

Add a `prefillConventional` method specifically for the CC blade that parses the last commit message into CC fields:

```typescript
import { parseConventionalMessage } from "../lib/conventional-utils";

// Add to the hook's return:
const prefillConventional = useCallback(async (store: {
  setCommitType: (type: CommitType | "") => void;
  setScope: (scope: string) => void;
  setDescription: (desc: string) => void;
  setBody: (body: string) => void;
  setIsBreaking: (breaking: boolean) => void;
  setBreakingDescription: (desc: string) => void;
}) => {
  const result = await refetchLastMessage();
  const fetchedMessage = result.data?.status === "ok" ? result.data.data : null;

  if (fetchedMessage) {
    const parsed = parseConventionalMessage(fetchedMessage.fullMessage);
    if (parsed) {
      store.setCommitType(parsed.commitType as CommitType);
      store.setScope(parsed.scope);
      store.setDescription(parsed.description);
      store.setBody(parsed.body);
      store.setIsBreaking(parsed.isBreaking);
      store.setBreakingDescription(parsed.breakingDescription);
    } else {
      // Non-CC commit: put entire subject as description
      const subject = fetchedMessage.fullMessage.split("\n")[0] || "";
      store.setCommitType("");
      store.setScope("");
      store.setDescription(subject);
      store.setBody("");
      store.setIsBreaking(false);
      store.setBreakingDescription("");
    }
  }
}, [refetchLastMessage]);
```

Also add the original commit message to the return for display:
```typescript
const originalMessage = lastMessage?.fullMessage ?? null;
return { amend, setAmend, toggleAmend, prefillConventional, lastMessage, originalMessage, refetchLastMessage };
```

**Modify `src/components/blades/ConventionalCommitBlade.tsx`:**

1. **Amend toggle in header area:**
   Add a toggle switch between the blade title and the SplitPaneLayout:
   ```tsx
   <div className="flex items-center gap-3 px-4 py-2 border-b border-ctp-surface0">
     <label className="flex items-center gap-2 text-sm cursor-pointer">
       <input
         type="checkbox"
         checked={isAmend}
         onChange={(e) => handleAmendToggle(e.target.checked)}
         className="rounded border-ctp-surface2 bg-ctp-surface0 text-ctp-peach focus:ring-ctp-peach"
       />
       <RotateCcw className="w-4 h-4 text-ctp-overlay1" />
       <span className="text-ctp-subtext1">Amend last commit</span>
     </label>
   </div>
   ```
   Where `isAmend` reads from `useConventionalStore(s => s.isAmend)` and `handleAmendToggle` calls `store.setIsAmend(checked)` and if checked, calls `prefillConventional(store)`.

2. **Warning banner when amend is active:**
   ```tsx
   {isAmend && (
     <div className="flex items-center gap-2 px-4 py-2 bg-ctp-peach/10 border-b border-ctp-peach/30 text-sm">
       <AlertTriangle className="w-4 h-4 text-ctp-peach shrink-0" />
       <span className="text-ctp-peach">
         Amending previous commit{originalMessage ? `: "${originalMessage.split("\n")[0]}"` : ""}
       </span>
     </div>
   )}
   ```
   Import `AlertTriangle` from lucide-react.

3. **Original message display in right panel (above preview):**
   When amend is active, show the original commit message above the preview for comparison:
   ```tsx
   {isAmend && originalMessage && (
     <div className="space-y-2 mb-4">
       <label className="text-sm font-medium text-ctp-overlay1">Original Message</label>
       <pre className="p-3 text-sm bg-ctp-surface0/50 border border-ctp-surface1 rounded text-ctp-overlay1 font-mono whitespace-pre-wrap line-through opacity-60">
         {originalMessage}
       </pre>
     </div>
   )}
   ```

4. **Handle `initialAmend` prop:**
   On mount, if `amend` prop is `true`, trigger amend mode:
   ```typescript
   useEffect(() => {
     if (initialAmend) {
       store.setIsAmend(true);
       prefillConventional(store);
     }
   }, [initialAmend]); // Run once on mount
   ```

5. **Update CommitActionBar amend prop:**
   The `CommitActionBar` already receives `amend={store.isAmend}` from Task 2. Verify the button labels change correctly: "Commit" -> "Amend Commit", "Commit & Push" -> "Amend & Force Push".
  </action>
  <verify>Run `npx tsc --noEmit`. In the app: open CC blade, toggle Amend -- fields pre-fill from last commit, warning banner shows, button labels change. When last commit is CC-formatted, type/scope/desc parse correctly. When not CC-formatted, description gets the full subject.</verify>
  <done>Amend toggle in blade header with warning banner. Pre-fill parses CC messages into individual fields. Original message displayed for comparison. Non-CC messages gracefully degrade. Confirmation dialog on amend submit.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no new type errors
2. `npx vite build` -- successful build
3. CC blade preview shows syntax highlighting: type colored, scope in teal, breaking in red
4. Column-72 ruler visible in full preview
5. Copy button copies message to clipboard
6. Commit button works, success overlay shows, auto-navigates back after 1.5s
7. "Stay here" link cancels auto-navigation
8. Commit & Push executes both operations
9. Amend toggle pre-fills fields from last CC commit
10. Warning banner shows when amend is active
11. Non-CC last commits put subject as description (graceful degradation)
12. Confirmation dialog appears before amend submit
</verification>

<success_criteria>
- CommitPreview full variant: syntax highlighting per segment, column-72 ruler, copy button, subject char count
- Commit+push pipeline: sequential execution, success state, auto-navigate with 1.5s delay
- "Stay here" cancels auto-navigation timer
- Push failure: commit stands, push error as persistent toast with retry
- Amend mode: toggle in header, warning banner, pre-fill from parsed CC message, original message comparison
- Non-CC commit amend: graceful degradation (subject as description)
- Button labels change for amend mode
</success_criteria>

<output>
After completion, create `.planning/phases/28-conventional-commit-blade/28-04-SUMMARY.md`
</output>
