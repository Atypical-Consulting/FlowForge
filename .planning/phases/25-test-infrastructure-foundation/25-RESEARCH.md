# Phase 25: Test Infrastructure Foundation - Synthesized Research

**Synthesized:** 2026-02-08
**Sources:** UX/DX research, Architecture research, Expert Developer research
**Confidence:** HIGH (all three perspectives converge on the same stack and patterns)

## Executive Summary

FlowForge has **zero existing test infrastructure** — no Vitest config, no test files, no testing dependencies. The codebase has 215 source files, 21 Zustand stores, 13 blade types, and ~50 Tauri IPC commands (auto-generated by tauri-specta). Two external boundaries need mocking: (1) Tauri IPC via `bindings.ts`, and (2) `@tauri-apps/plugin-store` used by 5 stores.

All three research perspectives converge on the same stack, patterns, and recommendations.

## Consensus Decisions

### Stack
| Library | Version | Purpose |
|---------|---------|---------|
| vitest | ^3.2 | Test runner (avoid v4 jsdom compat issues) |
| jsdom | ^26 | DOM environment |
| @testing-library/react | ^16 | Component rendering + queries |
| @testing-library/jest-dom | ^6 | DOM assertion matchers |
| @testing-library/user-event | ^14 | User interaction simulation |
| xstate + @xstate/react | ^5 | Install now for ARCH-02 test examples |

### Organization
- **Co-located tests** — `*.test.ts` / `*.test.tsx` next to source files (aligns with Phase 29 restructuring)
- **Naming** — `*.test.ts` (Vitest/React ecosystem convention, not `*.spec.ts`)
- **Test utilities** — `src/test-utils/` directory with barrel export

### Mock Strategy
- **Zustand** — Official `__mocks__/zustand.ts` auto-reset pattern (captures initial state, resets after each test)
- **Tauri IPC** — Module-level `vi.mock("../bindings")` with typed factory functions
- **Plugin-store** — Global mock in setup file (`vi.mock("@tauri-apps/plugin-store")`)
- **framer-motion** — `MotionGlobalConfig.skipAnimations = true` (official solution)

### Coverage & CI
- **No coverage thresholds** in Phase 25 (greenfield with ~0% baseline)
- Coverage reporting enabled but not gated
- `npm test` runs tests; `npm run test:coverage` produces report

### Smoke Tests
- **All 13 blade types** — render-only (set is small, full coverage is cheap)
- Import blade components directly (bypass lazy() wrappers)
- Mock Monaco Editor and Three.js modules for viewer blades

## File Structure

```
vitest.config.ts                    # Extends vite.config.ts
src/
├── __mocks__/
│   └── zustand.ts                  # Official Zustand auto-reset pattern
├── test-utils/
│   ├── index.ts                    # Barrel export
│   ├── setup.ts                    # Global setup (jest-dom, mocks, polyfills)
│   ├── render.tsx                  # Custom render with providers
│   └── mocks/
│       └── tauri-commands.ts       # Typed mock factories for bindings
├── stores/
│   ├── blades.test.ts              # Co-located store test
│   └── repository.test.ts
├── components/blades/
│   ├── SettingsBlade.test.tsx       # Co-located smoke test
│   └── ... (all 13 blade types)
└── lib/
    └── errors.test.ts              # Pure function tests
```

## Critical Pitfalls (All 3 Researchers Agree)

1. **crypto.randomUUID()** — jsdom lacks WebCrypto; polyfill in setup.ts (used by blade store, toast store)
2. **Zustand devtools middleware** — `useBladeStore` uses `create()(devtools(...))` curried form; official mock handles this but needs validation
3. **@tauri-apps/plugin-store** — 5 stores depend on it; must be mocked globally
4. **import.meta.glob** — Blade registration auto-discovery; import components directly in smoke tests
5. **React Query cache** — Create fresh QueryClient per render to avoid pollution
6. **Lazy-loaded blades** — Import components directly, bypass React.lazy wrapper

## Extensibility for Phases 26-30

| Phase | What Gets Added | Infrastructure Changes Needed |
|-------|-----------------|-------------------------------|
| 26: XState FSM | Machine unit tests | None (XState tests are pure TS logic) |
| 27-28: New Blades | Smoke tests + store tests | Add factories to tauri-commands.ts (additive) |
| 29: File Structure | Tests move with source files | None (co-located tests move naturally) |
| 30: Store Consolidation | Tests for consolidated stores | None (auto-reset handles any store count) |

## Sub-Project Modules

| Module | Independence | Extraction Potential |
|--------|-------------|---------------------|
| `__mocks__/zustand.ts` | Fully independent (official pattern) | Low priority (small, stable) |
| `test-utils/mocks/tauri-commands.ts` | Depends on bindings types only | Medium (reusable for any tauri-specta project) |
| `test-utils/render.tsx` | Depends on app provider tree | Low (project-specific) |
| `test-utils/setup.ts` | Depends on project dependencies | Low (project-specific) |

## Divergences Between Researchers

### Minor: Tauri Mock Approach
- **Architecture** recommends module-level `vi.mock("../bindings")` (type-safe, simple)
- **Expert** recommends `@tauri-apps/api/mocks` mockIPC in setup + module-level mock per file
- **Resolution:** Use module-level `vi.mock` for the `commands` object (type-safe) + `@tauri-apps/api/mocks` for event system and window mocks in setup.ts. Best of both approaches.

### Minor: Vitest Config Location
- **UX/Expert** prefer `vitest.config.ts` at project root
- **Architecture** also suggests `src/vitest.setup.ts` naming
- **Resolution:** `vitest.config.ts` at root, setup file at `src/test-utils/setup.ts`

### Minor: XState Installation
- **Expert** recommends installing XState as production dependency now
- **UX/Architecture** don't address this explicitly
- **Resolution:** Install as production dependency (Phase 26 will use it in source files)

---
*Synthesized: 2026-02-08*
*Individual research files: 25-RESEARCH-UX.md, 25-RESEARCH-ARCHITECTURE.md, 25-RESEARCH-EXPERT.md*
