---
phase: 18-command-palette-discoverability
plan: 04
type: execute
wave: 3
depends_on: ["18-03"]
files_modified:
  - src/components/command-palette/CommandPalette.tsx
  - src/components/command-palette/CommandPaletteItem.tsx
  - src/components/command-palette/index.ts
  - src/App.tsx
  - src/hooks/useKeyboardShortcuts.ts
  - src/components/Header.tsx
autonomous: true

must_haves:
  truths:
    - "Pressing Cmd+Shift+P (or Ctrl+Shift+P) opens a command palette overlay anchored to top-center of the viewport"
    - "Typing in the palette search input filters commands by title and description in real time"
    - "Arrow keys navigate results, Enter executes selected command and closes palette, Escape closes palette"
    - "All registered commands (Open Repo, Clone, Settings, Push, Pull, Fetch, etc.) appear in the palette when enabled"
    - "Hovering over toolbar buttons with shortcuts shows a tooltip with action name and keyboard shortcut"
    - "Commands requiring an open repository are hidden when no repo is open"
  artifacts:
    - path: "src/components/command-palette/CommandPalette.tsx"
      provides: "Main overlay component with search input, results list, keyboard navigation, backdrop"
      min_lines: 100
    - path: "src/components/command-palette/CommandPaletteItem.tsx"
      provides: "Single result row with icon, title, description, shortcut badge, match highlighting"
      min_lines: 30
    - path: "src/components/command-palette/index.ts"
      provides: "Barrel export for CommandPalette"
    - path: "src/App.tsx"
      provides: "CommandPalette rendered at app level, commands barrel imported"
      contains: "CommandPalette"
  key_links:
    - from: "src/components/command-palette/CommandPalette.tsx"
      to: "src/stores/commandPalette.ts"
      via: "useCommandPaletteStore for open/close state and query"
      pattern: "useCommandPaletteStore"
    - from: "src/components/command-palette/CommandPalette.tsx"
      to: "src/lib/commandRegistry.ts"
      via: "getEnabledCommands for command list"
      pattern: "getEnabledCommands"
    - from: "src/components/command-palette/CommandPalette.tsx"
      to: "src/lib/fuzzySearch.ts"
      via: "searchCommands for filtering and scoring"
      pattern: "searchCommands"
    - from: "src/App.tsx"
      to: "src/commands/index.ts"
      via: "Side-effect import to register all commands"
      pattern: 'import.*"./commands"'
    - from: "src/hooks/useKeyboardShortcuts.ts"
      to: "src/stores/commandPalette.ts"
      via: "Palette toggle shortcut and escape guard"
      pattern: "useCommandPaletteStore"
---

<objective>
Build the CommandPalette overlay UI component, integrate it into App.tsx, wire up the palette keyboard shortcut, add Escape guard to blade handler, and extend ShortcutTooltip coverage on toolbar buttons.

Purpose: This is the user-facing component that makes the command palette real. Users press Cmd+Shift+P, see a searchable list of all commands, and execute them. This plan also ensures toolbar buttons have proper shortcut tooltips for discoverability.

Output: A fully functional command palette overlay accessible via keyboard shortcut, plus improved tooltip coverage across the toolbar.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-command-palette-discoverability/18-01-SUMMARY.md
@.planning/phases/18-command-palette-discoverability/18-02-SUMMARY.md
@.planning/phases/18-command-palette-discoverability/18-03-SUMMARY.md
@src/lib/commandRegistry.ts
@src/lib/fuzzySearch.ts
@src/stores/commandPalette.ts
@src/commands/index.ts
@src/App.tsx
@src/hooks/useKeyboardShortcuts.ts
@src/components/ui/dialog.tsx
@src/components/ui/ShortcutTooltip.tsx
@src/components/Header.tsx
@src/lib/animations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build CommandPalette overlay and CommandPaletteItem components</name>
  <files>src/components/command-palette/CommandPalette.tsx, src/components/command-palette/CommandPaletteItem.tsx, src/components/command-palette/index.ts</files>
  <action>
**Create `src/components/command-palette/CommandPaletteItem.tsx`:**

A result row component that renders a single command:

Props: `{ command: Command; isSelected: boolean; matchedRanges: [number, number][]; onClick: () => void; index: number }`

Layout (horizontal, single line):
- Left: Command icon (if present) in `w-5 h-5 text-ctp-overlay0 shrink-0`
- Center: Title with match highlighting (wrap matched ranges in `<span className="text-ctp-blue font-medium">`), then description in `text-xs text-ctp-overlay0` on a second line if present
- Right: Shortcut badge (if command has shortcut). Use `formatShortcut()` from useKeyboardShortcuts.ts, then split into individual keys using the same `parseKeys` logic from ShortcutTooltip (extract or inline). Render each key in a `<kbd>` element with `inline-flex items-center justify-center min-w-4.5 h-4.5 px-1 text-[10px] font-mono font-medium rounded bg-ctp-surface0/80 text-ctp-subtext0`

Styling:
- Container: `flex items-center gap-3 px-3 py-2 cursor-pointer transition-colors duration-75`
- Normal: `text-ctp-subtext1 hover:bg-ctp-surface1/50`
- Selected (isSelected): `bg-ctp-blue/15 text-ctp-text`
- Add `data-command-index={index}` for scrollIntoView targeting
- Wrap the command icon render: `{command.icon && <command.icon className="w-5 h-5 text-ctp-overlay0 shrink-0" />}`

For match highlighting in title, implement inline: split the title string into segments using matchedRanges, wrapping matched segments in `<span className="text-ctp-blue font-medium">`.

**Create `src/components/command-palette/CommandPalette.tsx`:**

The main overlay component. Structure:

1. **State from store:** `useCommandPaletteStore` for isOpen, query, selectedIndex, close, setQuery, setSelectedIndex

2. **Commands:** Call `getEnabledCommands()` from commandRegistry, then `searchCommands(query, enabledCommands)` from fuzzySearch. Memoize with `useMemo`.

3. **Focus management:**
   - `previousFocusRef = useRef<HTMLElement | null>(null)` — save on open, restore on close
   - `inputRef = useRef<HTMLInputElement>(null)` — auto-focus on open
   - useEffect: when isOpen becomes true, save activeElement to previousFocusRef, focus inputRef
   - useEffect: when isOpen becomes false, restore focus from previousFocusRef

4. **Keyboard navigation** on the input's `onKeyDown`:
   - ArrowDown: `e.preventDefault()`, increment selectedIndex (wrap to 0 at end)
   - ArrowUp: `e.preventDefault()`, decrement selectedIndex (wrap to last at top)
   - Enter: `e.preventDefault()`, execute the selected command's action, then close palette
   - Escape: `e.preventDefault()`, `e.stopPropagation()`, close palette
   - Tab: `e.preventDefault()` (focus trap — do not let tab escape the palette)

5. **Scroll into view:** useEffect on selectedIndex changes, query `[data-command-index="${selectedIndex}"]` and call `scrollIntoView({ block: "nearest" })`

6. **Render structure** (only when isOpen, wrapped in AnimatePresence):
   ```
   <AnimatePresence>
     {isOpen && (
       <>
         {/* Backdrop */}
         <motion.div
           initial={{ opacity: 0 }}
           animate={{ opacity: 1 }}
           exit={{ opacity: 0 }}
           transition={{ duration: 0.15 }}
           className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm"
           onClick={close}
         />
         {/* Palette container */}
         <motion.div
           initial={{ opacity: 0, scale: 0.98, y: -8 }}
           animate={{ opacity: 1, scale: 1, y: 0 }}
           exit={{ opacity: 0, scale: 0.98, y: -8 }}
           transition={{ duration: 0.15, ease: "easeOut" }}
           className="fixed top-[15%] left-1/2 -translate-x-1/2 z-50 w-full max-w-[560px]"
         >
           <div className="bg-ctp-mantle border border-ctp-surface0 rounded-lg shadow-xl overflow-hidden">
             {/* Search input area */}
             <div className="flex items-center gap-3 px-4 py-3 border-b border-ctp-surface0">
               <Search className="w-4 h-4 text-ctp-overlay0 shrink-0" />
               <input
                 ref={inputRef}
                 role="combobox"
                 aria-expanded={true}
                 aria-controls="command-palette-list"
                 aria-activedescendant={results[selectedIndex] ? `cmd-${results[selectedIndex].command.id}` : undefined}
                 aria-autocomplete="list"
                 aria-label="Search commands"
                 className="w-full bg-transparent text-ctp-text placeholder:text-ctp-overlay0 outline-none text-sm"
                 placeholder="Type a command..."
                 value={query}
                 onChange={(e) => setQuery(e.target.value)}
                 onKeyDown={handleKeyDown}
               />
             </div>
             {/* Results list */}
             <ul
               id="command-palette-list"
               role="listbox"
               aria-label="Commands"
               className="max-h-[320px] overflow-y-auto py-1"
             >
               {results.length > 0 ? (
                 results.map((scored, i) => (
                   <li key={scored.command.id} role="option" id={`cmd-${scored.command.id}`} aria-selected={i === selectedIndex}>
                     <CommandPaletteItem
                       command={scored.command}
                       isSelected={i === selectedIndex}
                       matchedRanges={scored.matchedRanges}
                       onClick={() => { scored.command.action(); close(); }}
                       index={i}
                     />
                   </li>
                 ))
               ) : (
                 <li className="px-4 py-8 text-center text-sm text-ctp-overlay0">
                   No matching commands
                 </li>
               )}
             </ul>
             {/* Result count for screen readers */}
             <div aria-live="polite" className="sr-only">
               {results.length} {results.length === 1 ? "command" : "commands"} available
             </div>
           </div>
         </motion.div>
       </>
     )}
   </AnimatePresence>
   ```

7. **Reduced motion:** Use `useReducedMotion()` from framer-motion. If reduced motion preferred, replace the motion.div palette container with a plain div (instant appear/disappear, opacity only).

8. **Group headers (OPTIONAL, nice-to-have):** If query is empty, group results by category and show small category labels (`text-xs text-ctp-overlay0 uppercase tracking-wider px-3 pt-2 pb-1`). If query is non-empty, show flat sorted results without grouping (categories would break relevance order).

**Create `src/components/command-palette/index.ts`:**
```typescript
export { CommandPalette } from "./CommandPalette";
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes (ignore pre-existing TS2440)
2. All 3 files exist in src/components/command-palette/
3. CommandPalette.tsx imports from commandRegistry, fuzzySearch, and commandPalette store
4. ARIA attributes are present: role="combobox", role="listbox", role="option", aria-activedescendant
  </verify>
  <done>
CommandPalette overlay renders with search input, fuzzy-filtered results, keyboard navigation (Arrow/Enter/Escape), ARIA combobox semantics, focus management, scroll-into-view, and Catppuccin theming.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate palette into App.tsx and wire keyboard shortcut + tooltip expansion</name>
  <files>src/App.tsx, src/hooks/useKeyboardShortcuts.ts, src/components/Header.tsx</files>
  <action>
**Modify `src/App.tsx`:**

1. Add import at the top: `import "./commands";` (side-effect import to register all commands)
2. Add import: `import { CommandPalette } from "./components/command-palette";`
3. Add `<CommandPalette />` in the JSX, after `<ToastContainer />` (alongside other global overlays):
   ```jsx
   <ChangelogDialog />
   <SettingsWindow />
   <ToastContainer />
   <CommandPalette />
   ```

**Modify `src/hooks/useKeyboardShortcuts.ts`:**

1. Add import: `import { useCommandPaletteStore } from "../stores/commandPalette";`

2. Add a new useHotkeys call for the command palette shortcut:
   ```typescript
   // Command palette shortcut
   useHotkeys(
     "mod+shift+p",
     (e) => {
       e.preventDefault();
       useCommandPaletteStore.getState().toggle();
     },
     { preventDefault: true },
   );
   ```
   Place this AFTER the existing shortcut blocks, before the Escape handler.

3. Add an Escape guard for the blade-pop handler. Modify the existing Escape useHotkeys to check if the command palette is open first:
   ```typescript
   useHotkeys(
     "escape",
     () => {
       // Don't pop blade if command palette is open (palette handles its own Escape)
       if (useCommandPaletteStore.getState().isOpen) return;
       const bladeStore = useBladeStore.getState();
       if (bladeStore.bladeStack.length > 1) {
         bladeStore.popBlade();
       }
     },
     { enableOnFormTags: false },
   );
   ```

4. Update the JSDoc comment block to add: `- Cmd/Ctrl+Shift+P: Open command palette`

**Modify `src/components/Header.tsx`:**

Expand ShortcutTooltip coverage. Currently only Settings and Open Repository buttons have ShortcutTooltip wrappers. Buttons that could benefit from tooltips (using title attribute as label-only tooltip for buttons without shortcuts):

These buttons already use `title=` attribute for basic browser tooltips. No change needed there — the phase context says "Apply ShortcutTooltip to all toolbar buttons that have associated shortcuts" and "Buttons without shortcuts just show the action name (no shortcut portion)". Since ShortcutTooltip requires a `shortcut` prop (it's not optional), only wrap buttons that HAVE shortcuts.

The buttons WITH shortcuts that already have ShortcutTooltip:
- Settings (mod+,) — already wrapped
- Open Repository (mod+o) — already wrapped

The sync buttons in SyncButtons.tsx already have ShortcutTooltip:
- Fetch (mod+shift+F) — already wrapped
- Pull (mod+shift+L) — already wrapped
- Push (mod+shift+U) — already wrapped (updated in Plan 02)

No additional ShortcutTooltip wrapping needed since all buttons with shortcuts already have tooltips.

HOWEVER: For improved discoverability, add a small keyboard/search icon button in the header toolbar (near the right side) that opens the command palette on click, wrapped in a ShortcutTooltip:

```tsx
<ShortcutTooltip shortcut="mod+shift+P" label="Command Palette">
  <Button
    variant="ghost"
    size="sm"
    onClick={() => useCommandPaletteStore.getState().toggle()}
  >
    <Search className="w-4 h-4" />
  </Button>
</ShortcutTooltip>
```

Add this button in the header toolbar section, between ThemeToggle and the Undo button. Import Search from lucide-react and useCommandPaletteStore from the store.
  </action>
  <verify>
1. `npx tsc --noEmit` passes (ignore pre-existing TS2440)
2. `grep "CommandPalette" src/App.tsx` shows the component is rendered
3. `grep 'import.*commands' src/App.tsx` shows the commands barrel is imported
4. `grep "mod+shift+p" src/hooks/useKeyboardShortcuts.ts` shows the palette shortcut
5. `grep "isOpen" src/hooks/useKeyboardShortcuts.ts` shows the Escape guard
6. `grep "Command Palette" src/components/Header.tsx` shows the palette trigger button
7. Open the app and press Cmd+Shift+P — palette should open with search input focused
8. Type a query — results should filter in real time
9. Arrow keys navigate, Enter executes, Escape closes
10. Click the search icon in toolbar — palette opens
  </verify>
  <done>
CommandPalette integrated into App.tsx. Cmd+Shift+P opens/closes the palette. Escape in palette doesn't pop blades. Search icon in header provides mouse-accessible palette trigger with shortcut tooltip.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignore pre-existing TS2440)
2. Pressing Cmd+Shift+P opens a centered command palette overlay with search input
3. Typing filters commands by title and description in real time
4. Clone, Open Repository, Settings, Push, Pull, Fetch appear in palette
5. Selecting a command executes it and closes the palette
6. Arrow keys navigate results, Enter executes, Escape closes
7. Commands requiring open repo are hidden when no repo is open
8. Toolbar search icon button opens the palette
9. Hover over settings button shows "Settings" tooltip with shortcut
10. Hover over sync buttons shows their shortcuts
11. ARIA attributes present on input (combobox) and result list (listbox)
</verification>

<success_criteria>
- Pressing Ctrl+Shift+P (or Cmd+Shift+P on macOS) opens a centered command palette overlay with a search input
- Typing in the palette filters commands by title and description with results updating in real time
- Clone, Open Repository, Settings, and other core actions appear in the palette and execute when selected
- Hovering over common toolbar buttons shows a tooltip with the action name and its keyboard shortcut
- Commands requiring an open repository are hidden when no repo is open
- Keyboard navigation (Arrow/Enter/Escape) works correctly
- Escape in palette does not pop blades
- ARIA combobox pattern implemented for screen reader accessibility
</success_criteria>

<output>
After completion, create `.planning/phases/18-command-palette-discoverability/18-04-SUMMARY.md`
</output>
