---
phase: 52-visualization-welcome-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/topology/lib/heatMapUtils.ts
  - src/extensions/topology/components/CommitTooltip.tsx
  - src/extensions/topology/components/HeatMapLegend.tsx
  - src/extensions/topology/components/TopologyPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle a commit heat map that colors nodes by recency (green=recent, red=old)"
    - "Heat map legend is visible when heat map is enabled, showing the color gradient with labels"
    - "Heat map respects prefers-reduced-motion by disabling color transitions"
    - "User can hover over commit nodes to see a tooltip with short hash, author, date, and subject"
    - "Tooltip does not flicker when moving between adjacent nodes"
  artifacts:
    - path: "src/extensions/topology/lib/heatMapUtils.ts"
      provides: "Color interpolation and recency-to-color mapping"
      exports: ["getHeatColor", "HEAT_COLORS"]
    - path: "src/extensions/topology/components/CommitTooltip.tsx"
      provides: "Hover tooltip showing commit metadata"
      exports: ["CommitTooltip"]
    - path: "src/extensions/topology/components/HeatMapLegend.tsx"
      provides: "Gradient legend bar for heat map color scale"
      exports: ["HeatMapLegend"]
    - path: "src/extensions/topology/components/TopologyPanel.tsx"
      provides: "Integration of heat map toggle, tooltip hover, and legend"
  key_links:
    - from: "src/extensions/topology/components/TopologyPanel.tsx"
      to: "src/extensions/topology/lib/heatMapUtils.ts"
      via: "getHeatColor called per node when heatMap enabled"
      pattern: "getHeatColor\\("
    - from: "src/extensions/topology/components/TopologyPanel.tsx"
      to: "src/extensions/topology/components/CommitTooltip.tsx"
      via: "rendered when hoveredNode is set"
      pattern: "<CommitTooltip"
    - from: "src/extensions/topology/components/TopologyPanel.tsx"
      to: "src/extensions/topology/components/HeatMapLegend.tsx"
      via: "rendered when heatMapEnabled state is true"
      pattern: "<HeatMapLegend"
---

<objective>
Add commit heat map coloring and hover tooltips to the topology graph.

Purpose: Users gain visual insight into commit recency through color-coded nodes and can inspect commit metadata without leaving the graph view.
Output: Heat map toggle with color legend and node hover tooltips in TopologyPanel.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/extensions/topology/components/TopologyPanel.tsx
@src/extensions/topology/lib/layoutUtils.ts
@src/extensions/topology/components/CommitBadge.tsx
@src/core/components/ui/ShortcutTooltip.tsx
@src/core/lib/branchClassifier.ts
@src/bindings.ts (GraphNode type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create heat map utility and legend component</name>
  <files>
    src/extensions/topology/lib/heatMapUtils.ts
    src/extensions/topology/components/HeatMapLegend.tsx
  </files>
  <action>
Create `heatMapUtils.ts` with:
- `HEAT_COLORS` constant: `{ recent: "#a6e3a1" (ctp-green), mid: "#f9e2af" (ctp-yellow), old: "#f38ba8" (ctp-red) }`
- `interpolateColor(c1: string, c2: string, t: number): string` — linear RGB interpolation between two hex colors, returning a hex string
- `getHeatColor(timestampMs: number, minTs: number, maxTs: number): string` — maps a timestamp to a color on the green→yellow→red gradient. When `maxTs === minTs`, return `HEAT_COLORS.recent`. Normalize `t = (maxTs - timestampMs) / (maxTs - minTs)` where 0=recent, 1=old. Use two-segment interpolation: t<0.5 interpolates recent→mid, t>=0.5 interpolates mid→old.

Create `HeatMapLegend.tsx`:
- Accepts props `{ minDate: Date; maxDate: Date }`
- Renders a horizontal bar ~200px wide using CSS `linear-gradient(to right, #a6e3a1, #f9e2af, #f38ba8)` with rounded corners and height ~8px
- Below the bar, show "Recent" on the left and "Older" on the right using `text-xs text-ctp-overlay0`
- Above the bar, show the date range: `formatDate(minDate)` on left, `formatDate(maxDate)` on right, using `text-[10px] text-ctp-overlay0`
- Use `formatDate` helper: show "Today", "Yesterday", or `MMM DD` for dates within current year, `MMM DD, YYYY` otherwise
- Wrap in a div with `px-3 py-2 bg-ctp-surface0/50 rounded-lg` styling
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "TS2440"` — no new type errors.
Confirm both files export their named exports.
  </verify>
  <done>
heatMapUtils.ts exports getHeatColor and HEAT_COLORS with correct interpolation logic. HeatMapLegend.tsx renders a labeled gradient bar.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CommitTooltip and integrate heat map + tooltip into TopologyPanel</name>
  <files>
    src/extensions/topology/components/CommitTooltip.tsx
    src/extensions/topology/components/TopologyPanel.tsx
  </files>
  <action>
Create `CommitTooltip.tsx`:
- Props: `{ node: GraphNode; style?: React.CSSProperties }`
- Import `GraphNode` from `../../../bindings`
- Render a compact card with: short hash (`node.shortOid`) in `font-mono text-ctp-blue`, author name (`node.author`) in `text-ctp-subtext1`, relative date from `node.timestampMs` (use a `formatRelativeDate` helper: "X min ago", "X hours ago", "X days ago", or full date), and subject line (`node.message` truncated to 60 chars) in `text-ctp-text`
- Style: `bg-ctp-mantle/95 backdrop-blur-sm border border-ctp-surface0/30 rounded-lg shadow-lg px-3 py-2 min-w-[200px] max-w-[300px] pointer-events-none`
- Use `useReducedMotion` from framer-motion. Wrap in `AnimatePresence` with `motion.div` for fade animation when `shouldReduceMotion` is false; use a plain `div` when true (following ShortcutTooltip.tsx pattern exactly)

Modify `TopologyPanel.tsx`:
1. Add state: `const [heatMapEnabled, setHeatMapEnabled] = useState(false)`
2. Add state: `const [hoveredNode, setHoveredNode] = useState<PositionedNode | null>(null)` with a `hideTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null)` for anti-flicker
3. Compute timestamp range inside a `useMemo` that depends on `graphNodes`: `const { minTs, maxTs } = useMemo(() => { let min = Infinity, max = -Infinity; for (const n of graphNodes) { if (n.timestampMs < min) min = n.timestampMs; if (n.timestampMs > max) max = n.timestampMs; } return { minTs: min === Infinity ? 0 : min, maxTs: max === -Infinity ? 0 : max }; }, [graphNodes])`
4. In the SVG circle rendering, change `fill={pn.color}` to `fill={heatMapEnabled ? getHeatColor(pn.node.timestampMs, minTs, maxTs) : pn.color}`
5. Add `onMouseEnter` and `onMouseLeave` to each `<circle>`:
   - `onMouseEnter`: Clear any pending hide timer, then `setHoveredNode(pn)`
   - `onMouseLeave`: Set a 100ms timer to `setHoveredNode(null)` (anti-flicker delay)
   - Clean up timer in useEffect cleanup
6. After the SVG element (inside the relative container div), render the tooltip:
   ```
   {hoveredNode && (
     <div className="absolute z-50 pointer-events-none"
       style={{ left: hoveredNode.cx + hoveredNode.r + 16, top: hoveredNode.cy - 20 }}>
       <CommitTooltip node={hoveredNode.node} />
     </div>
   )}
   ```
7. Add a heat map toggle button in the top-right area of the panel (above the SVG, after `<LaneHeader>`). Use a small button with a `Flame` icon from lucide-react. When active, apply `bg-ctp-surface1 text-ctp-peach` styling; when inactive, `text-ctp-overlay0 hover:text-ctp-text`. Add `aria-label="Toggle heat map"` and `aria-pressed={heatMapEnabled}`.
8. When `heatMapEnabled`, render `<HeatMapLegend minDate={new Date(minTs)} maxDate={new Date(maxTs)} />` in the bottom-left of the panel as an absolute overlay with `bottom-3 left-3`.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "TS2440"` — no new type errors.
Visual check: The heat map toggle button appears in the topology toolbar area. Clicking it changes node colors. Hovering nodes shows a tooltip with commit metadata.
  </verify>
  <done>
TopologyPanel renders heat-map-colored nodes when toggle is active, shows a gradient legend, and displays hover tooltips with short hash, author, date, and subject. Tooltip uses anti-flicker delay and respects reduced motion.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "TS2440"` passes with no new errors
2. TopologyPanel renders the heat map toggle button with proper aria attributes
3. When heat map is enabled, commit node circles use recency-based colors (green→yellow→red)
4. HeatMapLegend appears at bottom-left showing the gradient with date range labels
5. Hovering a commit node shows CommitTooltip with short hash, author, relative date, and subject
6. Moving mouse between adjacent nodes does not cause tooltip flicker (100ms delay)
7. With prefers-reduced-motion enabled, tooltip appears/disappears without animation
</verification>

<success_criteria>
- Heat map toggle exists and colors nodes by commit recency when enabled
- Legend is visible when heat map is on, hidden when off
- Tooltip shows on hover with correct commit metadata
- No tooltip flicker between adjacent nodes
- Reduced motion is respected
- No TypeScript compilation errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/52-visualization-welcome-polish/52-01-SUMMARY.md`
</output>
