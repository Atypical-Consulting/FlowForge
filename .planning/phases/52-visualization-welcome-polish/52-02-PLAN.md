---
phase: 52-visualization-welcome-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/hooks/useRecentRepos.ts
  - src/extensions/welcome-screen/components/RepoCard.tsx
  - src/extensions/welcome-screen/components/RecentRepos.tsx
  - src/extensions/welcome-screen/components/WelcomeContent.tsx
autonomous: true

must_haves:
  truths:
    - "User can click a pin icon on a repo card to pin it to the top of the list"
    - "Pinned repos appear above unpinned repos, sorted by lastOpened within each group"
    - "Pin state persists across app restarts via @tauri-apps/plugin-store"
    - "Re-opening a pinned repo preserves its pinned status"
  artifacts:
    - path: "src/core/hooks/useRecentRepos.ts"
      provides: "togglePin method and isPinned field on RecentRepo"
      exports: ["useRecentRepos", "RecentRepo"]
    - path: "src/extensions/welcome-screen/components/RepoCard.tsx"
      provides: "Individual repo card with pin toggle"
      exports: ["RepoCard"]
    - path: "src/extensions/welcome-screen/components/RecentRepos.tsx"
      provides: "Sorted repo list with pinned-first ordering"
    - path: "src/extensions/welcome-screen/components/WelcomeContent.tsx"
      provides: "Updated to pass onRepoOpened to RecentRepos"
  key_links:
    - from: "src/extensions/welcome-screen/components/RepoCard.tsx"
      to: "src/core/hooks/useRecentRepos.ts"
      via: "calls togglePin on pin button click"
      pattern: "togglePin\\("
    - from: "src/extensions/welcome-screen/components/RecentRepos.tsx"
      to: "src/extensions/welcome-screen/components/RepoCard.tsx"
      via: "renders RepoCard for each repo"
      pattern: "<RepoCard"
    - from: "src/core/hooks/useRecentRepos.ts"
      to: "src/core/lib/store.ts"
      via: "persists isPinned via getStore"
      pattern: "store\\.set\\(RECENT_REPOS_KEY"
---

<objective>
Add pinned repositories to the welcome screen with persistent pin state and extracted repo card component.

Purpose: Users can pin frequently accessed repositories to the top of the welcome screen for quick access, with pin state surviving app restarts.
Output: RepoCard component with pin toggle, updated useRecentRepos hook with togglePin, pinned-first sorting.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/hooks/useRecentRepos.ts
@src/extensions/welcome-screen/components/RecentRepos.tsx
@src/extensions/welcome-screen/components/WelcomeContent.tsx
@src/core/lib/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useRecentRepos with pin support and preserve pin on re-add</name>
  <files>
    src/core/hooks/useRecentRepos.ts
  </files>
  <action>
Modify `useRecentRepos.ts`:

1. Add `isPinned?: boolean` to the `RecentRepo` interface (optional for backward compatibility with existing stored data).

2. Add a `togglePin` callback:
```typescript
const togglePin = useCallback(async (path: string) => {
  try {
    const store = await getStore();
    const existing = (await store.get<RecentRepo[]>(RECENT_REPOS_KEY)) || [];
    const updated = existing.map((r) =>
      r.path === path ? { ...r, isPinned: !r.isPinned } : r
    );
    await store.set(RECENT_REPOS_KEY, updated);
    setRecentRepos(updated);
  } catch (e) {
    console.error("Failed to toggle pin:", e);
  }
}, []);
```

3. Fix the `addRecentRepo` callback to preserve `isPinned` when re-adding an existing repo (Pitfall 4 from research). Change the current filter-and-prepend logic to:
```typescript
const existingEntry = existing.find((r) => r.path === path);
const filtered = existing.filter((r) => r.path !== path);
const updated: RecentRepo[] = [
  { path, name: repoName, lastOpened: Date.now(), isPinned: existingEntry?.isPinned },
  ...filtered,
].slice(0, MAX_RECENT_REPOS);
```

4. Add `togglePin` to the returned object.

5. Add a `sortedRepos` computed value that sorts repos: pinned first (isPinned === true), then by lastOpened descending within each group. Return `sortedRepos` as `recentRepos` instead of the raw array. Use `useMemo` with dependency on `recentRepos` internal state:
```typescript
const sortedRepos = useMemo(() => {
  return [...recentRepos].sort((a, b) => {
    if (a.isPinned && !b.isPinned) return -1;
    if (!a.isPinned && b.isPinned) return 1;
    return b.lastOpened - a.lastOpened;
  });
}, [recentRepos]);
```
Return `sortedRepos` as `recentRepos` in the hook return value. Keep the raw `recentRepos` state variable as internal state (rename to `_recentRepos` or keep as-is and use `sortedRepos` in return).
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "TS2440"` — no new type errors.
Check that `togglePin` is exported from the hook.
Check that `isPinned` is on the `RecentRepo` interface.
  </verify>
  <done>
useRecentRepos hook provides `togglePin(path)`, preserves `isPinned` on re-add, and returns repos sorted pinned-first. RecentRepo interface includes optional `isPinned` field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract RepoCard component and wire pin toggle in RecentRepos</name>
  <files>
    src/extensions/welcome-screen/components/RepoCard.tsx
    src/extensions/welcome-screen/components/RecentRepos.tsx
    src/extensions/welcome-screen/components/WelcomeContent.tsx
  </files>
  <action>
Create `RepoCard.tsx`:
- Props interface:
```typescript
interface RepoCardProps {
  repo: RecentRepo;
  onOpen: (repo: RecentRepo) => void;
  onRemove: (path: string) => void;
  onTogglePin: (path: string) => void;
}
```
- Import `Pin`, `Folder`, `X` from lucide-react, `Button` from ui/button, `RecentRepo` from useRecentRepos
- Render the existing card markup from RecentRepos.tsx (the `<div key={repo.path} ...>` block) but enhanced:
  - Keep existing: Folder icon, repo name, truncated path, relative time, remove button
  - Add a pin toggle button (visible on hover like the remove button): `Pin` icon from lucide-react, `opacity-0 group-hover:opacity-100` transition. When `repo.isPinned`, the pin button should always be visible (not just on hover) with `text-ctp-peach` color and `rotate-45` transform. When not pinned, standard ghost button on hover.
  - Pin button: `aria-label={repo.isPinned ? "Unpin repository" : "Pin repository"}`, onClick calls `onTogglePin(repo.path)` with `e.stopPropagation()`
  - Place the pin button BEFORE the remove button in the action area (right side)
  - When `repo.isPinned`, add a subtle left border: `border-l-2 border-ctp-peach` on the card container
- Move the `formatTime` and `truncatePath` helpers from RecentRepos.tsx into RepoCard.tsx (or a shared utils file — keeping them in RepoCard is simpler)

Modify `RecentRepos.tsx`:
- Import `RepoCard` component
- Get `togglePin` from `useRecentRepos()` hook (destructure it alongside existing)
- Replace the inline repo card rendering with `<RepoCard>` component:
```tsx
{recentRepos.map((repo) => (
  <RepoCard
    key={repo.path}
    repo={repo}
    onOpen={handleOpen}
    onRemove={removeRecentRepo}
    onTogglePin={togglePin}
  />
))}
```
- Add a visual separator between pinned and unpinned repos: if there are both pinned and unpinned repos, render a subtle `<hr className="border-ctp-surface0/50 my-1" />` between the last pinned and first unpinned repo. Use the sorted order from the hook.
- Update the section header: if any repos are pinned, show a `Pin` icon badge with count next to "Recent Repositories" title

Modify `WelcomeContent.tsx`:
- No structural changes needed since RecentRepos already manages its own state. Ensure `<RecentRepos />` component invocation is unchanged (it already works without onRepoOpened being required).
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "TS2440"` — no new type errors.
Visual check: Pin button appears on hover, pinned repos show at top with peach left border, separator between pinned and unpinned groups.
  </verify>
  <done>
RepoCard component renders individual repo cards with pin toggle. RecentRepos displays pinned repos first with visual separator. Pin state persists in store and survives re-opening repos.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v "TS2440"` passes with no new errors
2. useRecentRepos returns `togglePin` function and repos sorted pinned-first
3. RepoCard renders pin button on hover with correct aria-label
4. Pinned repos always show pin icon (not just on hover) with peach color
5. Pin state persists after closing and reopening the app (stored in plugin-store)
6. Re-opening a pinned repo does NOT lose the pinned status (isPinned preserved in addRecentRepo)
7. Visual separator appears between pinned and unpinned repo groups
</verification>

<success_criteria>
- Pin toggle button appears on repo cards
- Pinned repos sort to top of the list
- Pin state persists across app restarts
- Re-opening a pinned repo preserves pin status
- No TypeScript compilation errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/52-visualization-welcome-polish/52-02-SUMMARY.md`
</output>
