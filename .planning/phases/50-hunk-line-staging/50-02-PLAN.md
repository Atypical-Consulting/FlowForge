---
phase: 50-hunk-line-staging
plan: 02
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - src/core/blades/diff/components/DiffContent.tsx
  - src/core/blades/diff/components/DiffToolbar.tsx
  - src/core/blades/diff/DiffBlade.tsx
  - src/core/blades/diff/hooks/useHunkStaging.ts
  - src/core/blades/diff/components/StagingDiffEditor.tsx
  - src/core/blades/diff/lib/diffUtils.ts
  - src/core/blades/staging-changes/hooks/useStagingActions.ts
  - src/index.css
autonomous: true

must_haves:
  truths:
    - "User can see ViewZone hunk action bars above each hunk in the diff viewer when viewing staging-mode diffs"
    - "User can click Stage Hunk or Unstage Hunk buttons to stage/unstage individual hunks"
    - "After staging or unstaging a hunk, the staging panel immediately reflects the change without manual refresh"
    - "Hunk staging controls only appear when DiffSource.mode is staging (not for commit diffs)"
    - "Stage buttons are disabled during a pending staging mutation to prevent concurrent operations"
  artifacts:
    - path: "src/core/blades/diff/components/StagingDiffEditor.tsx"
      provides: "Monaco DiffEditor wrapper with ViewZone hunk action bars and glyph margin decorations"
      min_lines: 80
    - path: "src/core/blades/diff/hooks/useHunkStaging.ts"
      provides: "Hook wrapping hunk staging mutations with query invalidation"
      exports: ["useHunkStaging"]
    - path: "src/core/blades/diff/lib/diffUtils.ts"
      provides: "Utility functions for hunk-to-line mapping and line range conversion"
      exports: ["findHunkForLine", "linesToRanges"]
    - path: "src/core/blades/staging-changes/hooks/useStagingActions.ts"
      provides: "Shared hook extracting staging mutations from FileItem with consistent invalidation"
      exports: ["useStagingActions"]
    - path: "src/index.css"
      provides: "Gutter CSS classes for hunk stage/unstage glyphs and stage flash animation"
      contains: "hunk-stage-glyph"
  key_links:
    - from: "src/core/blades/diff/components/StagingDiffEditor.tsx"
      to: "src/core/blades/diff/hooks/useHunkStaging.ts"
      via: "hook provides staging mutations consumed by ViewZone buttons"
      pattern: "useHunkStaging"
    - from: "src/core/blades/diff/hooks/useHunkStaging.ts"
      to: "src/bindings.ts"
      via: "calls stageHunks/unstageHunks Tauri commands"
      pattern: "commands\\.stageHunks|commands\\.unstageHunks"
    - from: "src/core/blades/diff/DiffBlade.tsx"
      to: "src/core/blades/diff/components/StagingDiffEditor.tsx"
      via: "DiffContent conditionally renders StagingDiffEditor in staging mode"
      pattern: "StagingDiffEditor"
---

<objective>
Implement frontend hunk staging UI with Monaco ViewZone action bars, glyph margin decorations, staging mutations with query invalidation, and CSS theming for the hunk staging gutter.

Purpose: Enable users to stage and unstage individual hunks directly from the diff viewer via visual gutter controls, with immediate staging panel sync.
Output: StagingDiffEditor component, useHunkStaging hook, useStagingActions shared hook, diffUtils library, CSS gutter styles, and enhanced DiffBlade/DiffContent/DiffToolbar components.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-hunk-line-staging/50-RESEARCH.md
@.planning/phases/50-hunk-line-staging/50-01-SUMMARY.md

# Key source files
@src/core/blades/diff/DiffBlade.tsx
@src/core/blades/diff/components/DiffContent.tsx
@src/core/blades/diff/components/DiffToolbar.tsx
@src/core/blades/diff/hooks/useDiffQuery.ts
@src/core/blades/diff/types.ts
@src/core/blades/staging-changes/components/FileItem.tsx
@src/core/lib/monacoConfig.ts
@src/core/lib/monacoTheme.ts
@src/index.css
@src/bindings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared hooks, utilities, and CSS for hunk staging</name>
  <files>
    src/core/blades/diff/hooks/useHunkStaging.ts
    src/core/blades/diff/lib/diffUtils.ts
    src/core/blades/staging-changes/hooks/useStagingActions.ts
    src/index.css
  </files>
  <action>
**Create `src/core/blades/diff/lib/diffUtils.ts`:**
Pure utility functions for diff data manipulation:

```typescript
import type { DiffHunkDetail, DiffHunk } from "../../../bindings"; // adjust import path

/**
 * Find which hunk a given line number belongs to (in the modified/new editor).
 * Uses newStart and newLines from hunk data.
 */
export function findHunkForLine(
  hunks: DiffHunkDetail[] | DiffHunk[],
  lineNumber: number,
): number {
  return hunks.findIndex(h =>
    lineNumber >= h.newStart && lineNumber < h.newStart + h.newLines
  );
}

/**
 * Convert a Set of individual line numbers into consolidated contiguous LineRange objects.
 * Adjacent lines are merged into a single range.
 */
export function linesToRanges(lines: Set<number>): Array<{ start: number; end: number }> {
  const sorted = Array.from(lines).sort((a, b) => a - b);
  if (sorted.length === 0) return [];
  const ranges: Array<{ start: number; end: number }> = [];
  let start = sorted[0];
  let end = sorted[0];
  for (let i = 1; i < sorted.length; i++) {
    if (sorted[i] === end + 1) {
      end = sorted[i];
    } else {
      ranges.push({ start, end });
      start = sorted[i];
      end = sorted[i];
    }
  }
  ranges.push({ start, end });
  return ranges;
}

/**
 * Check if a line is a changed line (addition or deletion) vs context.
 */
export function isChangedLine(origin: string): boolean {
  return origin === "addition" || origin === "deletion";
}
```

**Create `src/core/blades/staging-changes/hooks/useStagingActions.ts`:**
Extract the duplicated staging mutation pattern from FileItem.tsx into a reusable hook:

```typescript
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { commands } from "../../../../bindings";

export function useStagingActions() {
  const queryClient = useQueryClient();

  const invalidateStaging = () => {
    queryClient.invalidateQueries({ queryKey: ["stagingStatus"] });
  };

  const invalidateStagingAndDiff = (filePath?: string) => {
    queryClient.invalidateQueries({ queryKey: ["stagingStatus"] });
    if (filePath) {
      queryClient.invalidateQueries({ queryKey: ["fileDiff", filePath] });
      queryClient.invalidateQueries({ queryKey: ["fileDiffHunks", filePath] });
    }
  };

  const stageFile = useMutation({
    mutationFn: (path: string) => commands.stageFile(path),
    onSuccess: () => invalidateStaging(),
  });

  const unstageFile = useMutation({
    mutationFn: (path: string) => commands.unstageFile(path),
    onSuccess: () => invalidateStaging(),
  });

  return {
    stageFile,
    unstageFile,
    invalidateStaging,
    invalidateStagingAndDiff,
  };
}
```

**Create `src/core/blades/diff/hooks/useHunkStaging.ts`:**
Hook for hunk staging operations with mutations and query invalidation:

```typescript
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { useCallback } from "react";
import { commands } from "../../../../bindings";
import type { DiffHunkDetail } from "../../../../bindings";

interface UseHunkStagingOptions {
  filePath: string;
  staged: boolean; // true = viewing staged diff, false = viewing unstaged diff
  enabled?: boolean; // only fetch hunk details when in staging mode
}

export function useHunkStaging({ filePath, staged, enabled = true }: UseHunkStagingOptions) {
  const queryClient = useQueryClient();

  // Fetch detailed hunk data with per-line info
  const hunkQuery = useQuery({
    queryKey: ["fileDiffHunks", filePath, staged],
    queryFn: () => commands.getFileDiffHunks(filePath, staged),
    enabled,
    staleTime: 2000,
  });

  const invalidateAll = useCallback(() => {
    queryClient.invalidateQueries({ queryKey: ["stagingStatus"] });
    queryClient.invalidateQueries({ queryKey: ["fileDiff", filePath] });
    queryClient.invalidateQueries({ queryKey: ["fileDiffHunks", filePath] });
  }, [queryClient, filePath]);

  // Stage hunks mutation (for unstaged diff view)
  const stageHunksMutation = useMutation({
    mutationFn: (hunkIndices: number[]) =>
      commands.stageHunks(filePath, hunkIndices),
    onSuccess: invalidateAll,
  });

  // Unstage hunks mutation (for staged diff view)
  const unstageHunksMutation = useMutation({
    mutationFn: (hunkIndices: number[]) =>
      commands.unstageHunks(filePath, hunkIndices),
    onSuccess: invalidateAll,
  });

  // Convenience: stage or unstage based on current view
  const toggleHunk = useCallback((hunkIndex: number) => {
    if (staged) {
      unstageHunksMutation.mutate([hunkIndex]);
    } else {
      stageHunksMutation.mutate([hunkIndex]);
    }
  }, [staged, stageHunksMutation, unstageHunksMutation]);

  const isOperationPending =
    stageHunksMutation.isPending || unstageHunksMutation.isPending;

  return {
    hunks: hunkQuery.data?.status === "ok" ? hunkQuery.data.data : [] as DiffHunkDetail[],
    isLoadingHunks: hunkQuery.isLoading,
    toggleHunk,
    stageHunks: stageHunksMutation.mutate,
    unstageHunks: unstageHunksMutation.mutate,
    isOperationPending,
    invalidateAll,
  };
}
```

Note on the `hunkQuery.data?.status === "ok"` pattern: Check the actual bindings return type -- the Tauri IPC wrapper may return `{ status: "ok", data: T }` or return `T` directly depending on the error handling pattern. Match the existing pattern in `useDiffQuery.ts`.

**Update `src/index.css`:**
Add the following CSS classes after the existing `@keyframes` blocks in the file. Add to the `@theme` block first:

```css
--animate-stage-flash: stage-flash 0.3s ease-out;
```

Then add the keyframes and gutter styles:

```css
@keyframes stage-flash {
  0% { background-color: rgb(166 227 161 / 0.3); }
  100% { background-color: transparent; }
}

/* Hunk staging gutter controls */
.hunk-stage-glyph {
  cursor: pointer;
}
.hunk-stage-glyph::before {
  content: '+';
  display: flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  border-radius: 3px;
  font-size: 12px;
  font-weight: bold;
  color: var(--ctp-green, #a6e3a1);
  background: rgb(166 227 161 / 0.15);
  transition: background 0.15s;
}
.hunk-stage-glyph:hover::before {
  background: rgb(166 227 161 / 0.3);
}

.hunk-unstage-glyph {
  cursor: pointer;
}
.hunk-unstage-glyph::before {
  content: 'âˆ’';
  display: flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  border-radius: 3px;
  font-size: 12px;
  font-weight: bold;
  color: var(--ctp-peach, #fab387);
  background: rgb(250 179 135 / 0.15);
  transition: background 0.15s;
}
.hunk-unstage-glyph:hover::before {
  background: rgb(250 179 135 / 0.3);
}
```

Check the Catppuccin CSS variable names used in the project (they may be `--ctp-green` or `--catppuccin-color-green` -- grep `index.css` and `monacoTheme.ts` to verify) and use the correct ones.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Verify that useStagingActions exports correctly and useHunkStaging types match the bindings. Verify CSS classes are syntactically valid.
  </verify>
  <done>
diffUtils.ts exports findHunkForLine, linesToRanges, and isChangedLine. useStagingActions.ts exports a shared hook replacing duplicated mutation logic. useHunkStaging.ts exports hook wrapping hunk staging mutations with query invalidation. index.css contains hunk gutter CSS classes and stage flash animation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StagingDiffEditor and integrate into DiffBlade</name>
  <files>
    src/core/blades/diff/components/StagingDiffEditor.tsx
    src/core/blades/diff/components/DiffContent.tsx
    src/core/blades/diff/components/DiffToolbar.tsx
    src/core/blades/diff/DiffBlade.tsx
  </files>
  <action>
**Create `src/core/blades/diff/components/StagingDiffEditor.tsx`:**
A wrapper around Monaco DiffEditor that adds interactive hunk staging controls via ViewZones and glyph margin decorations.

```tsx
import { DiffEditor, type DiffOnMount } from "@monaco-editor/react";
import { useCallback, useEffect, useMemo, useRef } from "react";
import type { DiffHunkDetail } from "../../../../bindings";
import { MONACO_COMMON_OPTIONS, MONACO_THEME } from "../../../lib/monacoConfig";
import "../../../lib/monacoTheme";

interface StagingDiffEditorProps {
  original: string;
  modified: string;
  language: string;
  inline: boolean;
  collapseUnchanged?: boolean;
  contextLines?: number;
  hunks: DiffHunkDetail[];
  staged: boolean;
  isOperationPending: boolean;
  onToggleHunk: (hunkIndex: number) => void;
}
```

Implementation requirements:
1. Render Monaco DiffEditor with all existing options from DiffContent (readOnly, glyphMargin, hideUnchangedRegions, etc.).
2. On `DiffOnMount`, get the modified editor via `editor.getModifiedEditor()`.
3. Create **ViewZones** for each hunk: inject a DOM node before each hunk's first line (`afterLineNumber: hunk.newStart - 1`) with `heightInPx: 28`. The DOM node is a div styled as a hunk action bar:
   - Background: `bg-ctp-surface0` with `border-b border-ctp-surface1`
   - Contains: hunk header text (e.g. "@@ -10,5 +10,7 @@") in `text-ctp-overlay1 font-mono text-xs`
   - Contains: a button labeled "Stage Hunk" (if `staged === false`) or "Unstage Hunk" (if `staged === true`)
   - Button styling: green text for stage (`text-ctp-green hover:bg-ctp-green/20`), peach for unstage (`text-ctp-peach hover:bg-ctp-peach/20`)
   - Button disabled when `isOperationPending` is true
   - Button `onclick` calls `onToggleHunk(hunk.index)`
   - Add `aria-label` to button: "Stage hunk containing lines X through Y" or "Unstage hunk..."
4. Create **glyph margin decorations** on the first line of each hunk using `createDecorationsCollection()`:
   - Class: `hunk-stage-glyph` (for unstaged view) or `hunk-unstage-glyph` (for staged view)
   - These are visual indicators in the margin alongside ViewZone buttons
5. Add a `mousedown` event listener on the modified editor to handle glyph margin clicks:
   - Check `e.target.type === monaco.editor.MouseTargetType.GUTTER_GLYPH_MARGIN`
   - Find which hunk the clicked line belongs to using `findHunkForLine(hunks, lineNumber)`
   - If a hunk is found and no operation is pending, call `onToggleHunk(hunkIndex)`
6. Clean up ViewZones and decorations on unmount and when hunks data changes.
7. Add an `aria-live="polite"` div for screen reader staging announcements.

Use `useRef` for the editor instance and `useEffect` with `[hunks, staged, isOperationPending]` deps to update ViewZones/decorations when data changes. Create ViewZone DOM nodes via `document.createElement` (Monaco ViewZones don't support React components -- use plain DOM). Style with inline styles or add CSS classes that map to Tailwind utilities.

**Enhance `src/core/blades/diff/components/DiffContent.tsx`:**
Add a new optional prop `stagingSource`:
```typescript
interface DiffContentProps {
  // ... existing props
  stagingSource?: {
    filePath: string;
    staged: boolean;
    hunks: DiffHunkDetail[];
    isOperationPending: boolean;
    onToggleHunk: (hunkIndex: number) => void;
  };
}
```

When `stagingSource` is provided, render `StagingDiffEditor` instead of the plain `DiffEditor`. Pass all relevant props through. When `stagingSource` is undefined, render the existing DiffEditor (no change).

**Enhance `src/core/blades/diff/DiffBlade.tsx`:**
When `source.mode === "staging"`:
1. Call `useHunkStaging({ filePath: source.filePath, staged: source.staged })` to get hunks and staging mutations.
2. Pass a `stagingSource` prop to DiffContent with the hunk data and callbacks.
3. The rest of the component stays the same.

When `source.mode === "commit"`, do NOT call useHunkStaging and do NOT pass stagingSource (existing behavior unchanged).

**Enhance `src/core/blades/diff/components/DiffToolbar.tsx`:**
Add an optional "Stage All Hunks" / "Unstage All Hunks" button that appears only in staging mode. Accept new optional props:
```typescript
stagingActions?: {
  staged: boolean;
  hunkCount: number;
  onStageAll: () => void;
  onUnstageAll: () => void;
  isPending: boolean;
};
```
When `stagingActions` is provided, render a button after the existing toolbar buttons:
- "Stage All Hunks" when `staged === false` (green icon, calls `onStageAll`)
- "Unstage All Hunks" when `staged === true` (peach icon, calls `onUnstageAll`)
- Disabled when `isPending`
- Use `ListPlus` or `Plus` icon from lucide-react

In DiffBlade, when staging mode is active, pass `stagingActions` to DiffToolbar. The "Stage All" action calls `stageHunks` with all hunk indices `[0, 1, ..., n-1]`. The "Unstage All" action calls `unstageHunks` with all hunk indices.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Run `npx vitest run --reporter=verbose` to verify existing tests still pass (the DiffBlade test should not break since staging mode rendering is additive).
  </verify>
  <done>
StagingDiffEditor renders Monaco DiffEditor with ViewZone hunk action bars above each hunk. Each ViewZone has a Stage/Unstage button that calls the backend. DiffContent conditionally renders StagingDiffEditor when in staging mode. DiffBlade passes hunk data and staging callbacks. DiffToolbar has a Stage All / Unstage All button in staging mode. Glyph margin decorations indicate hunk boundaries. All staging operations disable buttons during pending mutations. Query invalidation triggers immediate staging panel refresh.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignoring pre-existing TS2440)
2. `npx vitest run` passes (existing tests)
3. In staging mode, DiffBlade renders StagingDiffEditor with ViewZone hunk bars
4. In commit mode, DiffBlade renders the plain DiffEditor (unchanged behavior)
5. Clicking "Stage Hunk" calls stageHunks and invalidates staging queries
6. Clicking "Unstage Hunk" calls unstageHunks and invalidates staging queries
7. Buttons are disabled during pending mutation
8. DiffToolbar shows "Stage All Hunks" / "Unstage All Hunks" in staging mode
</verification>

<success_criteria>
- StagingDiffEditor renders ViewZone action bars for each hunk with Stage/Unstage buttons
- Hunk staging operations trigger Tauri commands and invalidate stagingStatus + fileDiff queries
- Staging panel refreshes immediately after hunk staging (no manual refresh needed)
- Commit-mode diffs are completely unaffected
- Glyph margin decorations mark hunk boundaries
- Stage All / Unstage All toolbar button works for bulk operations
- Screen reader aria-live announcements for staging status
- All buttons disabled during pending mutations
</success_criteria>

<output>
After completion, create `.planning/phases/50-hunk-line-staging/50-02-SUMMARY.md`
</output>
