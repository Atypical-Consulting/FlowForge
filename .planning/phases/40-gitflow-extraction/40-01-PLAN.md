---
phase: 40-gitflow-extraction
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/gitflow/index.ts
  - src/App.tsx
  - src/components/RepositoryView.tsx
  - src/blades/_discovery.ts
  - src/commands/toolbar-actions.ts
  - src/commands/navigation.ts
  - src/blades/gitflow-cheatsheet/registration.ts
autonomous: true

must_haves:
  truths:
    - "Gitflow cheatsheet blade is registered by the gitflow extension, not by core registration.ts"
    - "GitflowPanel sidebar section is contributed by the gitflow extension via SidebarPanelRegistry, not hardcoded in RepositoryView"
    - "Gitflow Guide toolbar button is contributed by the gitflow extension, not by core toolbar-actions.ts"
    - "Gitflow Cheatsheet command palette entry is contributed by the gitflow extension, not by core navigation.ts"
    - "No duplicate Gitflow sidebar panels render (hardcoded one removed, extension one contributes via DynamicSidebarPanels)"
  artifacts:
    - path: "src/extensions/gitflow/index.ts"
      provides: "Gitflow extension entry point"
      exports: ["onActivate", "onDeactivate"]
    - path: "src/App.tsx"
      provides: "registerBuiltIn for gitflow extension"
      contains: "registerBuiltIn.*gitflow"
  key_links:
    - from: "src/extensions/gitflow/index.ts"
      to: "src/blades/gitflow-cheatsheet/GitflowCheatsheetBlade"
      via: "React.lazy() import with coreOverride"
      pattern: "lazy.*GitflowCheatsheetBlade"
    - from: "src/extensions/gitflow/index.ts"
      to: "src/components/gitflow/GitflowPanel"
      via: "eager import for contributeSidebarPanel"
      pattern: "contributeSidebarPanel"
    - from: "src/App.tsx"
      to: "src/extensions/gitflow/index.ts"
      via: "registerBuiltIn with activate/deactivate callbacks"
      pattern: "gitflowActivate"
---

<objective>
Create the gitflow built-in extension entry point that takes ownership of all four Gitflow-specific registrations (cheatsheet blade, sidebar panel, toolbar button, command palette entry), register it in App.tsx, and remove the corresponding core registrations.

Purpose: Extract Gitflow from hardcoded core into a toggleable extension, following the Phase 38-39 proven pattern (registerBuiltIn + coreOverride + React.lazy + api.cleanup).

Output: A gitflow extension that, when active, provides the same Gitflow UI as before. When disabled, all Gitflow UI disappears and core Git operations remain functional.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-gitflow-extraction/40-RESEARCH.md
@.planning/phases/39-conventional-commits-extraction/39-01-SUMMARY.md
@.planning/phases/39-conventional-commits-extraction/39-02-SUMMARY.md

# Key reference files (read before implementing):
@src/extensions/conventional-commits/index.ts  — CC extension pattern to follow
@src/extensions/content-viewers/index.ts        — content-viewers extension pattern to follow
@src/extensions/ExtensionAPI.ts                 — API types for contributeSidebarPanel, contributeToolbar, registerCommand, registerBlade
@src/App.tsx                                    — where registerBuiltIn calls go
@src/components/RepositoryView.tsx              — hardcoded Gitflow section to remove (lines 181-188)
@src/blades/gitflow-cheatsheet/registration.ts  — old registration to delete
@src/commands/toolbar-actions.ts                — tb:gitflow-guide to remove
@src/commands/navigation.ts                     — open-gitflow-cheatsheet to remove
@src/blades/_discovery.ts                       — EXPECTED_TYPES to update
@src/components/gitflow/index.ts                — GitflowPanel barrel export
@src/lib/sidebarPanelRegistry.ts                — SidebarPanelConfig interface
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gitflow extension entry point with all four registrations</name>
  <files>src/extensions/gitflow/index.ts</files>
  <action>
Create `src/extensions/gitflow/index.ts` following the Phase 38-39 pattern. The extension provides four registrations:

1. **Blade registration** (from old registration.ts):
   - Use `React.lazy()` to import `GitflowCheatsheetBlade` from `../../blades/gitflow-cheatsheet/GitflowCheatsheetBlade`
   - Register via `api.registerBlade({ type: "gitflow-cheatsheet", title: "Gitflow Guide", component: GitflowCheatsheetBlade, lazy: true, singleton: true, coreOverride: true })`

2. **Sidebar panel** (from hardcoded RepositoryView):
   - Eagerly import `GitflowPanel` from `../../components/gitflow` (NOT lazy -- it's small and always visible when active)
   - Import `GitMerge` icon from `lucide-react`
   - Register via `api.contributeSidebarPanel({ id: "gitflow-panel", title: "Gitflow", icon: GitMerge, component: GitflowPanel, priority: 65, defaultOpen: false })`

3. **Toolbar action** (from toolbar-actions.ts `tb:gitflow-guide`):
   - Import `GitBranch` from `lucide-react`, `openBlade` from `../../lib/bladeOpener`, `useRepositoryStore` from `../../stores/repository`
   - Register via `api.contributeToolbar({ id: "gitflow-guide", label: "Gitflow Guide", icon: GitBranch, group: "views", priority: 50, when: () => !!useRepositoryStore.getState().repoStatus, execute: () => openBlade("gitflow-cheatsheet", {} as Record<string, never>) })`

4. **Command palette entry** (from navigation.ts `open-gitflow-cheatsheet`):
   - Register via `api.registerCommand({ id: "open-gitflow-cheatsheet", title: "Gitflow Cheatsheet", description: "Open the Gitflow workflow guide", category: "Navigation", icon: GitBranch, keywords: ["gitflow", "workflow", "guide", "branching", "reference", "cheatsheet"], action: () => openBlade("gitflow-cheatsheet", {} as Record<string, never>), enabled: () => !!useRepositoryStore.getState().repoStatus })`

The `onDeactivate` function should be a no-op (api.cleanup() handles everything).

**Important:** Follow the exact import structure from `src/extensions/conventional-commits/index.ts` as the pattern reference.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` to verify TypeScript compilation. The file should export `onActivate` and `onDeactivate` functions.

Run `grep -n "registerBlade\|contributeSidebarPanel\|contributeToolbar\|registerCommand" src/extensions/gitflow/index.ts` to confirm all 4 registrations are present.
  </verify>
  <done>
`src/extensions/gitflow/index.ts` exists with exactly 4 registrations: one blade (coreOverride), one sidebar panel (priority 65), one toolbar action, one command. Exports onActivate and onDeactivate.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register extension in App.tsx and remove all core Gitflow registrations</name>
  <files>
    src/App.tsx
    src/components/RepositoryView.tsx
    src/blades/_discovery.ts
    src/commands/toolbar-actions.ts
    src/commands/navigation.ts
    src/blades/gitflow-cheatsheet/registration.ts
  </files>
  <action>
**A. Register in App.tsx:**
- Add import: `import { onActivate as gitflowActivate, onDeactivate as gitflowDeactivate } from "./extensions/gitflow";`
- Add `registerBuiltIn` call between conventional-commits and github (order matters for Extension Manager display):

```ts
registerBuiltIn({
  id: "gitflow",
  name: "Gitflow",
  version: "1.0.0",
  activate: gitflowActivate,
  deactivate: gitflowDeactivate,
});
```

**B. Remove hardcoded Gitflow section from RepositoryView.tsx:**
- Delete lines 181-188 (the `<details>` block containing `<GitflowPanel />`):
```tsx
{/* Gitflow section */}
<details className="border-b border-ctp-surface0">
  <summary ...>
    <GitMerge className="w-4 h-4" />
    <span ...>Gitflow</span>
  </summary>
  <GitflowPanel />
</details>
```
- Remove `GitflowPanel` from the import at line 16: `import { GitflowPanel } from "./gitflow";`
- Remove `GitMerge` from the lucide-react import at line 5 (if no other usage)
- Keep the `DynamicSidebarPanels` component at the end of the sidebar -- this is where the extension-contributed panel will render

**C. Remove "gitflow-cheatsheet" from _discovery.ts EXPECTED_TYPES:**
- Edit the EXPECTED_TYPES array to remove `"gitflow-cheatsheet"` (it's now registered by the extension, not by core registration.ts)

**D. Remove tb:gitflow-guide from toolbar-actions.ts:**
- Delete the entire `tb:gitflow-guide` action object from the coreActions array (approximately lines 256-266)
- Remove the `GitBranch` import from lucide-react if it's no longer used by any remaining action

**E. Remove open-gitflow-cheatsheet from navigation.ts:**
- Delete the entire `registerCommand({ id: "open-gitflow-cheatsheet", ... })` block (approximately lines 19-30)
- Remove the `GitBranch` import from lucide-react if no longer needed
- Keep the `command-palette` registration (it's core, not gitflow)

**F. Delete the old registration file:**
- Delete `src/blades/gitflow-cheatsheet/registration.ts` entirely (registration moved to extension)
- Check if `src/blades/gitflow-cheatsheet/index.ts` is an empty barrel; if so, delete it too (verify first -- the barrel might re-export the blade component used elsewhere)

**Order matters:** Do all removals AND the extension creation atomically to avoid having zero Gitflow registrations.
  </action>
  <verify>
1. `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` -- TypeScript compiles cleanly
2. `npx vitest run 2>&1 | tail -20` -- all existing tests pass
3. `grep -r "GitflowPanel" src/components/RepositoryView.tsx` -- should return nothing (removed)
4. `grep -r "tb:gitflow-guide" src/commands/toolbar-actions.ts` -- should return nothing (removed)
5. `grep -r "open-gitflow-cheatsheet" src/commands/navigation.ts` -- should return nothing (removed)
6. `grep "gitflow-cheatsheet" src/blades/_discovery.ts` -- should return nothing (removed from EXPECTED_TYPES)
7. `grep "gitflowActivate" src/App.tsx` -- should match (registered)
8. `ls src/blades/gitflow-cheatsheet/registration.ts 2>&1` -- should say "No such file" (deleted)
  </verify>
  <done>
App.tsx has registerBuiltIn for gitflow. RepositoryView no longer contains hardcoded GitflowPanel. Core toolbar-actions.ts no longer has tb:gitflow-guide. Core navigation.ts no longer has open-gitflow-cheatsheet. _discovery.ts no longer expects gitflow-cheatsheet. Old registration.ts is deleted. TypeScript compiles and all tests pass.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` returns clean
2. Tests pass: `npx vitest run` -- all existing tests pass (no regressions)
3. Extension entry point exists: `cat src/extensions/gitflow/index.ts` shows onActivate with 4 registrations
4. No duplicate panel: `grep -r "GitflowPanel" src/components/RepositoryView.tsx` returns empty
5. Core cleaned: `grep -r "gitflow" src/commands/toolbar-actions.ts src/commands/navigation.ts src/blades/_discovery.ts` returns nothing gitflow-specific
6. App.tsx wired: `grep "gitflow" src/App.tsx` shows import + registerBuiltIn
</verification>

<success_criteria>
- Gitflow extension entry point created at `src/extensions/gitflow/index.ts` with all 4 registrations
- Extension registered in App.tsx via registerBuiltIn
- All 4 core Gitflow registrations removed (blade, sidebar, toolbar, command)
- Old registration.ts deleted
- TypeScript compiles cleanly
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/40-gitflow-extraction/40-01-SUMMARY.md`
</output>
