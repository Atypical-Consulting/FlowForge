---
phase: 40-gitflow-extraction
plan: "02"
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - src/extensions/__tests__/gitflow.test.ts
autonomous: true

must_haves:
  truths:
    - "Gitflow extension lifecycle is tested: activation registers blade + sidebar panel + toolbar + command, cleanup removes them all"
    - "Disabling gitflow removes the gitflow-cheatsheet blade registration"
    - "Disabling gitflow removes the sidebar panel from DynamicSidebarPanels"
    - "Extension Manager shows Gitflow as a toggleable extension alongside CC, Content Viewers, and GitHub"
  artifacts:
    - path: "src/extensions/__tests__/gitflow.test.ts"
      provides: "Gitflow extension lifecycle tests"
      contains: "describe.*gitflow extension"
  key_links:
    - from: "src/extensions/__tests__/gitflow.test.ts"
      to: "src/extensions/gitflow/index.ts"
      via: "import onActivate, onDeactivate"
      pattern: "import.*onActivate.*gitflow"
---

<objective>
Add comprehensive extension lifecycle tests for the gitflow extension, verifying that all four registrations (blade, sidebar panel, toolbar, command) are properly created during activation and cleaned up during deactivation.

Purpose: Ensure the gitflow extension follows the same tested pattern as content-viewers and conventional-commits, with full lifecycle coverage and degradation confidence.

Output: Test file with lifecycle coverage for all 4 registration types, plus cleanup verification.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-gitflow-extraction/40-RESEARCH.md
@.planning/phases/40-gitflow-extraction/40-01-SUMMARY.md

# Key reference files:
@src/extensions/__tests__/conventional-commits.test.ts — test pattern to follow
@src/extensions/__tests__/content-viewers.test.ts       — test pattern to follow
@src/extensions/gitflow/index.ts                        — the extension under test
@src/extensions/ExtensionAPI.ts                         — ExtensionAPI class
@src/lib/bladeRegistry.ts                              — getBladeRegistration for assertions
@src/lib/sidebarPanelRegistry.ts                       — useSidebarPanelRegistry for sidebar assertions
@src/lib/toolbarRegistry.ts                            — useToolbarRegistry for toolbar assertions
@src/lib/commandRegistry.ts                            — getCommand for command assertions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gitflow extension lifecycle tests</name>
  <files>src/extensions/__tests__/gitflow.test.ts</files>
  <action>
Create `src/extensions/__tests__/gitflow.test.ts` following the pattern from `conventional-commits.test.ts` and `content-viewers.test.ts`. The test file should cover ALL four registration types.

**Test structure:**

```ts
import { describe, it, expect, beforeEach } from "vitest";
import { ExtensionAPI } from "../ExtensionAPI";
import { getBladeRegistration } from "../../lib/bladeRegistry";
import { useSidebarPanelRegistry } from "../../lib/sidebarPanelRegistry";
import { useToolbarRegistry } from "../../lib/toolbarRegistry";
import { onActivate, onDeactivate } from "../gitflow";

describe("gitflow extension", () => {
  let api: ExtensionAPI;

  beforeEach(() => {
    api = new ExtensionAPI("gitflow");
  });
```

**Required tests (8-10 tests):**

1. **"registers gitflow-cheatsheet blade type on activation"** -- call `onActivate(api)`, assert `getBladeRegistration("gitflow-cheatsheet")` is defined. Cleanup with `api.cleanup()`.

2. **"registers blade type without ext: namespace (coreOverride)"** -- assert `getBladeRegistration("ext:gitflow:gitflow-cheatsheet")` is undefined. This confirms `coreOverride: true` works.

3. **"marks cheatsheet blade as lazy and singleton"** -- assert `reg.lazy === true` and `reg.singleton === true`.

4. **"tracks blade source as ext:gitflow for cleanup"** -- assert `reg.source === "ext:gitflow"`.

5. **"registers gitflow sidebar panel on activation"** -- after `onActivate`, check `useSidebarPanelRegistry.getState().panels.has("ext:gitflow:gitflow-panel")`.

6. **"sidebar panel has priority 65 and defaultOpen false"** -- get the panel from registry and assert `panel.priority === 65` and `panel.defaultOpen === false`.

7. **"registers toolbar action on activation"** -- check `useToolbarRegistry.getState().actions.has("ext:gitflow:gitflow-guide")`.

8. **"unregisters all registrations on cleanup"** -- call `onActivate(api)` then `api.cleanup()`, assert:
   - `getBladeRegistration("gitflow-cheatsheet")` is undefined
   - `useSidebarPanelRegistry.getState().panels.has("ext:gitflow:gitflow-panel")` is false
   - `useToolbarRegistry.getState().actions.has("ext:gitflow:gitflow-guide")` is false

9. **"onDeactivate is a no-op (cleanup handled by ExtensionAPI)"** -- assert `expect(() => onDeactivate()).not.toThrow()`.

**Important notes:**
- Use `api.cleanup()` in afterEach or at end of each test to prevent registry pollution between tests
- The toolbar registry uses `actions` (a Map), check with `.has()` or `.get()`
- The sidebar panel registry uses `panels` (a Map), check with `.has()` or `.get()`
- Command registration can be checked via `getCommand` if available, or via the command registry store
  </action>
  <verify>
1. `npx vitest run src/extensions/__tests__/gitflow.test.ts` -- all tests pass
2. `npx vitest run` -- full suite passes (no regressions)
3. `grep -c "it(" src/extensions/__tests__/gitflow.test.ts` -- should show 8-10 test cases
  </verify>
  <done>
`src/extensions/__tests__/gitflow.test.ts` exists with 8-10 test cases covering blade registration, coreOverride namespacing, lazy/singleton flags, source tracking, sidebar panel registration with priority/defaultOpen, toolbar registration, full cleanup, and onDeactivate no-op. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Extension Manager shows 4 extensions and graceful degradation</name>
  <files></files>
  <action>
This is a verification-only task (no files modified). Run a comprehensive set of grep and structural checks to confirm the entire Phase 40 extraction is correct:

**Extension Manager shows 4 extensions:**
```bash
grep -n "registerBuiltIn" src/App.tsx
```
Should show exactly 4 calls: content-viewers, conventional-commits, gitflow, github.

**Graceful degradation (no gitflow in core):**
```bash
# No gitflow blade in core registration files
ls src/blades/gitflow-cheatsheet/registration.ts 2>&1
# Should not exist

# No gitflow in discovery EXPECTED_TYPES
grep "gitflow" src/blades/_discovery.ts
# Should return nothing

# No gitflow toolbar in core
grep "gitflow" src/commands/toolbar-actions.ts
# Should return nothing

# No gitflow command in core navigation
grep "gitflow" src/commands/navigation.ts
# Should return nothing

# No hardcoded GitflowPanel in RepositoryView
grep "GitflowPanel" src/components/RepositoryView.tsx
# Should return nothing

# DynamicSidebarPanels still present (where extension panel renders)
grep "DynamicSidebarPanels" src/components/RepositoryView.tsx
# Should return a match
```

**All core Git functionality intact:**
```bash
# Repository operations still in core
grep -c "openBlade\|loadBranches\|loadStashes\|loadTags" src/components/RepositoryView.tsx
# Should return matches (core Git still works)
```

**Full test suite passes:**
```bash
npx vitest run
```
  </action>
  <verify>
All grep checks above return expected results. Full test suite passes.
  </verify>
  <done>
Extension Manager has 4 registerBuiltIn calls. No Gitflow-specific registrations remain in core. RepositoryView has no hardcoded GitflowPanel. DynamicSidebarPanels renders extension-contributed panels. Core Git operations remain functional. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run src/extensions/__tests__/gitflow.test.ts` -- all lifecycle tests pass
2. `npx vitest run` -- full test suite passes
3. `grep -c "registerBuiltIn" src/App.tsx` returns 4 (content-viewers, CC, gitflow, github)
4. `grep "GitflowPanel" src/components/RepositoryView.tsx` returns nothing
5. `ls src/blades/gitflow-cheatsheet/registration.ts 2>&1` shows "No such file"
6. Core command/toolbar files contain no gitflow registrations
</verification>

<success_criteria>
- 8-10 lifecycle tests covering all 4 registration types (blade, sidebar, toolbar, command) plus cleanup
- All tests pass (both new and existing)
- 4 extensions visible in registerBuiltIn calls
- No Gitflow-specific code remains in core registration files
- Graceful degradation confirmed: disabling gitflow extension would remove all Gitflow UI
</success_criteria>

<output>
After completion, create `.planning/phases/40-gitflow-extraction/40-02-SUMMARY.md`
</output>
