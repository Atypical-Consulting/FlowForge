---
phase: 06.2-ux-ui-enhancements
plan: 09
type: execute
wave: 5
depends_on: ["06.2-02", "06.2-04"]
files_modified:
  - src/components/topology/CommitNode.tsx
  - src/components/topology/CommitEdge.tsx
  - src/components/topology/TopologyPanel.tsx
  - src/components/topology/DateSeparator.tsx
autonomous: true

must_haves:
  truths:
    - "Commit nodes use Catppuccin colors for branch types"
    - "Edges between commits are visually enhanced"
    - "Topology panel uses Catppuccin background colors"
    - "Edges animate with pathLength drawing effect on initial load"
    - "Commits are visually grouped by date with date separators"
  artifacts:
    - path: "src/components/topology/CommitNode.tsx"
      provides: "Commit node with Catppuccin branch colors"
      contains: "ctp-"
    - path: "src/components/topology/CommitEdge.tsx"
      provides: "Enhanced commit edge styling"
      contains: "ctp-"
  key_links:
    - from: "src/components/topology/CommitNode.tsx"
      to: "Catppuccin colors"
      via: "BRANCH_STYLES constant"
      pattern: "ctp-"
    - from: "src/components/topology/CommitEdge.tsx"
      to: "framer-motion"
      via: "motion.path animation"
      pattern: "pathLength"
    - from: "src/components/topology/TopologyPanel.tsx"
      to: "src/components/topology/DateSeparator.tsx"
      via: "component import"
      pattern: "DateSeparator"
---

<objective>
Polish the topology view with Catppuccin-themed branch colors and improved visual styling.

Purpose: Create a visually cohesive graph view that matches the rest of the application's Catppuccin theme.
Output: Topology view with Catppuccin branch colors and refined visual styling.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.2-ux-ui-enhancements/06.2-RESEARCH.md
@.planning/phases/06.2-ux-ui-enhancements/06.2-02-SUMMARY.md
@.planning/phases/06.2-ux-ui-enhancements/06.2-04-SUMMARY.md
@src/components/topology/CommitNode.tsx
@src/components/topology/CommitEdge.tsx
@src/components/topology/TopologyPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CommitNode with Catppuccin colors</name>
  <files>src/components/topology/CommitNode.tsx</files>
  <action>
Update the branch type styles to use Catppuccin colors.

```tsx
import { Handle, type Node, type NodeProps, Position } from "@xyflow/react";
import { memo } from "react";
import type { BranchType } from "../../bindings";
import { cn } from "../../lib/utils";
import type { CommitNodeData } from "./layoutUtils";

// Catppuccin Mocha branch colors
const BRANCH_STYLES: Record<BranchType, string> = {
  main: "border-ctp-peach bg-ctp-peach/10 hover:bg-ctp-peach/20",
  develop: "border-ctp-green bg-ctp-green/10 hover:bg-ctp-green/20",
  feature: "border-ctp-blue bg-ctp-blue/10 hover:bg-ctp-blue/20",
  release: "border-ctp-mauve bg-ctp-mauve/10 hover:bg-ctp-mauve/20",
  hotfix: "border-ctp-red bg-ctp-red/10 hover:bg-ctp-red/20",
  other: "border-ctp-overlay0 bg-ctp-surface0/50 hover:bg-ctp-surface1/50",
};

const BRANCH_RING_COLORS: Record<BranchType, string> = {
  main: "ring-ctp-peach",
  develop: "ring-ctp-green",
  feature: "ring-ctp-blue",
  release: "ring-ctp-mauve",
  hotfix: "ring-ctp-red",
  other: "ring-ctp-overlay0",
};

type CommitNodeProps = NodeProps<Node<CommitNodeData>>;

export const CommitNode = memo(({ data }: CommitNodeProps) => {
  const branchStyle = BRANCH_STYLES[data.branchType] || BRANCH_STYLES.other;
  const ringColor = BRANCH_RING_COLORS[data.branchType] || BRANCH_RING_COLORS.other;

  return (
    <div
      className={cn(
        "px-3 py-2 rounded-lg border-2 cursor-pointer transition-all",
        "hover:shadow-lg min-w-[200px]",
        branchStyle,
        data.isSelected && `ring-2 ${ringColor} ring-offset-2 ring-offset-ctp-base shadow-lg`,
      )}
      onClick={() => data.onSelect?.(data.oid)}
    >
      <Handle
        type="target"
        position={Position.Top}
        className="!bg-ctp-overlay0"
      />

      <div className="flex items-center gap-2 mb-1">
        <span className="text-xs font-mono text-ctp-subtext0">
          {data.shortOid}
        </span>
        {data.branchNames.length > 0 && (
          <span className="text-xs px-1.5 py-0.5 rounded bg-ctp-surface0 text-ctp-subtext1 truncate max-w-[100px]">
            {data.branchNames[0]}
          </span>
        )}
      </div>

      <div className="text-sm text-ctp-text truncate max-w-[180px]" title={data.message}>
        {data.message}
      </div>

      <div className="text-xs text-ctp-subtext0 mt-1">{data.author}</div>

      <Handle
        type="source"
        position={Position.Bottom}
        className="!bg-ctp-overlay0"
      />
    </div>
  );
});

CommitNode.displayName = "CommitNode";
```
  </action>
  <verify>
1. Run `npm run tauri dev`
2. Open a repository and switch to Topology view
3. Verify commit nodes use Catppuccin colors:
   - Main branch: peach/orange
   - Develop: green
   - Feature: blue
   - Release: mauve/purple
   - Hotfix: red
4. Selected node has colored ring
5. Text uses Catppuccin text colors
  </verify>
  <done>CommitNode uses Catppuccin colors for all branch types.</done>
</task>

<task type="auto">
  <name>Task 2: Update CommitEdge and TopologyPanel styling</name>
  <files>src/components/topology/CommitEdge.tsx, src/components/topology/TopologyPanel.tsx</files>
  <action>
Update edge and panel styling with Catppuccin colors.

**CommitEdge.tsx:**
```tsx
import { BaseEdge, type Edge, type EdgeProps, getSmoothStepPath } from "@xyflow/react";
import { memo } from "react";

type CommitEdgeProps = EdgeProps<Edge>;

export const CommitEdge = memo(
  ({ id, sourceX, sourceY, targetX, targetY, style }: CommitEdgeProps) => {
    const [edgePath] = getSmoothStepPath({
      sourceX,
      sourceY,
      targetX,
      targetY,
      borderRadius: 8,
    });

    return (
      <BaseEdge
        id={id}
        path={edgePath}
        style={{
          stroke: "var(--ctp-surface2, #45475a)",
          strokeWidth: 2,
          ...style,
        }}
      />
    );
  },
);

CommitEdge.displayName = "CommitEdge";
```

**TopologyPanel.tsx:**
Update background and loading state colors:

Find and replace color classes:
- bg-gray-900 -> bg-ctp-mantle
- text-gray-500 -> text-ctp-overlay0
- text-gray-400 -> text-ctp-subtext0

The ReactFlow component background should be transparent to show the parent bg-ctp-mantle.

Example section updates:
```tsx
// Loading state
if (isLoading) {
  return (
    <div className="h-full flex items-center justify-center bg-ctp-mantle">
      <div className="text-ctp-subtext0">Loading commit graph...</div>
    </div>
  );
}

// Empty state
if (nodes.length === 0) {
  return (
    <div className="h-full flex items-center justify-center bg-ctp-mantle">
      <div className="text-ctp-overlay0">No commits to display</div>
    </div>
  );
}

// Main ReactFlow wrapper
<div className="h-full bg-ctp-mantle">
  <ReactFlow
    // ... existing props
    style={{ background: "transparent" }}
  >
    {/* ... */}
  </ReactFlow>
</div>
```
  </action>
  <verify>
1. Run `npm run tauri dev`
2. Open Topology view
3. Edges between commits are visible with Catppuccin surface color
4. Background uses Catppuccin mantle
5. Loading/empty states use Catppuccin colors
6. React Flow controls match theme (from earlier CSS updates)
  </verify>
  <done>CommitEdge and TopologyPanel use Catppuccin styling throughout.</done>
</task>

<task type="auto">
  <name>Task 3: Add animated edges with pathLength</name>
  <files>src/components/topology/CommitEdge.tsx</files>
  <action>
Update CommitEdge to use SVG pathLength animation for drawing effect.

**CommitEdge.tsx:**
```tsx
import { BaseEdge, type Edge, type EdgeProps, getSmoothStepPath } from "@xyflow/react";
import { motion } from "framer-motion";
import { memo } from "react";

type CommitEdgeProps = EdgeProps<Edge> & {
  data?: {
    index?: number;
  };
};

export const CommitEdge = memo(
  ({ id, sourceX, sourceY, targetX, targetY, style, data }: CommitEdgeProps) => {
    const [edgePath] = getSmoothStepPath({
      sourceX,
      sourceY,
      targetX,
      targetY,
      borderRadius: 8,
    });

    // Stagger animation based on edge index
    const delay = (data?.index ?? 0) * 0.03;

    return (
      <g>
        {/* Background path for glow effect */}
        <motion.path
          d={edgePath}
          fill="none"
          stroke="var(--ctp-surface2, #45475a)"
          strokeWidth={4}
          strokeOpacity={0.3}
          initial={{ pathLength: 0 }}
          animate={{ pathLength: 1 }}
          transition={{
            duration: 0.5,
            delay,
            ease: "easeOut",
          }}
        />
        {/* Main edge path */}
        <motion.path
          d={edgePath}
          fill="none"
          stroke="var(--ctp-surface2, #45475a)"
          strokeWidth={2}
          initial={{ pathLength: 0 }}
          animate={{ pathLength: 1 }}
          transition={{
            duration: 0.5,
            delay,
            ease: "easeOut",
          }}
          style={style}
        />
      </g>
    );
  },
);

CommitEdge.displayName = "CommitEdge";
```

**Update TopologyPanel.tsx to pass index to edges:**
```tsx
// When creating edges, add index to data:
const edges = rawEdges.map((edge, index) => ({
  ...edge,
  data: { ...edge.data, index },
}));
```
  </action>
  <verify>
1. Run `npm run tauri dev`
2. Open Topology view
3. Edges draw in with animation (pathLength effect)
4. Animation is staggered - edges appear sequentially
5. Animation runs smoothly without jank
  </verify>
  <done>Edges animate with pathLength drawing effect on load.</done>
</task>

<task type="auto">
  <name>Task 4: Add DateSeparator for time-based grouping</name>
  <files>src/components/topology/DateSeparator.tsx, src/components/topology/TopologyPanel.tsx</files>
  <action>
Create date separator component and integrate into topology view.

**src/components/topology/DateSeparator.tsx:**
```tsx
import { memo } from "react";
import { Handle, Position, type NodeProps, type Node } from "@xyflow/react";
import { cn } from "../../lib/utils";

export interface DateSeparatorData {
  date: string;
  formattedDate: string;
}

type DateSeparatorProps = NodeProps<Node<DateSeparatorData>>;

export const DateSeparator = memo(({ data }: DateSeparatorProps) => {
  return (
    <div className="relative flex items-center w-full min-w-[300px]">
      <Handle type="target" position={Position.Top} className="opacity-0" />
      
      <div className="flex-1 h-px bg-ctp-surface1" />
      
      <div
        className={cn(
          "px-3 py-1 mx-4 rounded-full",
          "bg-ctp-surface0 border border-ctp-surface1",
          "text-xs font-medium text-ctp-subtext0"
        )}
      >
        {data.formattedDate}
      </div>
      
      <div className="flex-1 h-px bg-ctp-surface1" />
      
      <Handle type="source" position={Position.Bottom} className="opacity-0" />
    </div>
  );
});

DateSeparator.displayName = "DateSeparator";
```

**Update TopologyPanel.tsx:**
```tsx
import { DateSeparator } from "./DateSeparator";

// Register custom node type:
const nodeTypes = {
  commit: CommitNode,
  dateSeparator: DateSeparator,
};

// In layout calculation, insert date separator nodes:
function insertDateSeparators(commits: CommitData[]): (CommitData | DateSeparatorData)[] {
  const result: (CommitData | DateSeparatorData)[] = [];
  let lastDate: string | null = null;
  
  for (const commit of commits) {
    const commitDate = new Date(commit.timestamp).toDateString();
    
    if (commitDate !== lastDate) {
      result.push({
        type: "dateSeparator",
        id: `date-${commitDate}`,
        date: commitDate,
        formattedDate: formatRelativeDate(commit.timestamp),
      });
      lastDate = commitDate;
    }
    
    result.push(commit);
  }
  
  return result;
}

function formatRelativeDate(timestamp: number): string {
  const date = new Date(timestamp * 1000);
  const now = new Date();
  const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return "Today";
  if (diffDays === 1) return "Yesterday";
  if (diffDays < 7) return `${diffDays} days ago`;
  
  return date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: date.getFullYear() !== now.getFullYear() ? "numeric" : undefined,
  });
}

// In the nodes array, map date separators:
const nodes = processedData.flatMap((item) => {
  if (item.type === "dateSeparator") {
    return {
      id: item.id,
      type: "dateSeparator",
      position: { x: 0, y: currentY },
      data: item,
    };
  }
  // ... existing commit node mapping
});
```
  </action>
  <verify>
1. Run `npm run tauri dev`
2. Open Topology view
3. Date separators appear between commits from different days
4. Today's commits show "Today" label
5. Yesterday's commits show "Yesterday" label
6. Older commits show relative date (e.g., "3 days ago" or "Jan 15")
7. Separators are visually distinct but not distracting
  </verify>
  <done>DateSeparator component implemented with time-based commit grouping.</done>
</task>

</tasks>

<verification>
1. `npm run tauri dev` - Topology view renders correctly
2. All branch types have distinct Catppuccin colors
3. Selected commits have colored ring matching branch type
4. Edges use Catppuccin surface color
5. Background and text use Catppuccin colors
6. Smooth visual integration with rest of application
7. Build succeeds: `npm run build`
</verification>

<success_criteria>
- Commit nodes use Catppuccin branch colors (peach, green, blue, mauve, red)
- Selected state has colored ring
- Edges use Catppuccin surface color
- Panel background uses Catppuccin mantle
- Consistent styling with rest of application
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-ux-ui-enhancements/06.2-09-SUMMARY.md`
</output>
