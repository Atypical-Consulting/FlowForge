---
phase: 06.2-ux-ui-enhancements
plan: 08
type: execute
wave: 4
depends_on: ["06.2-02"]
files_modified:
  - src/components/staging/FileTreeView.tsx
  - src/components/staging/FileTreeSearch.tsx
  - src/components/staging/StagingPanel.tsx
autonomous: true

must_haves:
  truths:
    - "File tree has visible indent guides showing hierarchy"
    - "Search/filter input available above file tree"
    - "Filtered files update in real-time as user types"
    - "Shift+click selects range of files"
    - "Ctrl+A selects all visible files in current section"
  artifacts:
    - path: "src/components/staging/FileTreeSearch.tsx"
      provides: "Search input component for file tree"
      exports: ["FileTreeSearch"]
    - path: "src/components/staging/FileTreeView.tsx"
      provides: "File tree with indent guides"
      contains: "indent-guide"
  key_links:
    - from: "src/components/staging/StagingPanel.tsx"
      to: "src/components/staging/FileTreeSearch.tsx"
      via: "component import and filter state"
      pattern: "FileTreeSearch"
---

<objective>
Enhance the file tree with indent guides for clearer hierarchy visualization and add search/filter functionality.

Purpose: Improve navigation in repositories with many changed files and deep directory structures.
Output: File tree with visual indent guides and search filtering capability.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.2-ux-ui-enhancements/06.2-RESEARCH.md
@.planning/phases/06.2-ux-ui-enhancements/06.2-02-SUMMARY.md
@src/components/staging/FileTreeView.tsx
@src/components/staging/StagingPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FileTreeSearch component</name>
  <files>src/components/staging/FileTreeSearch.tsx</files>
  <action>
Create a search input component for filtering files.

```tsx
import { Search, X } from "lucide-react";
import { cn } from "../../lib/utils";

interface FileTreeSearchProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
}

export function FileTreeSearch({
  value,
  onChange,
  placeholder = "Filter files...",
}: FileTreeSearchProps) {
  return (
    <div className="relative">
      <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-ctp-overlay0" />
      <input
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className={cn(
          "w-full pl-8 pr-8 py-1.5 text-sm bg-ctp-surface0 border border-ctp-surface1 rounded",
          "text-ctp-text placeholder:text-ctp-overlay0",
          "focus:outline-none focus:border-ctp-blue focus:ring-1 focus:ring-ctp-blue",
        )}
      />
      {value && (
        <button
          type="button"
          onClick={() => onChange("")}
          className="absolute right-2 top-1/2 -translate-y-1/2 p-0.5 text-ctp-overlay0 hover:text-ctp-subtext1 rounded"
        >
          <X className="w-4 h-4" />
        </button>
      )}
    </div>
  );
}
```
  </action>
  <verify>
File exists: src/components/staging/FileTreeSearch.tsx
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>FileTreeSearch component created with search icon and clear button.</done>
</task>

<task type="auto">
  <name>Task 2: Add indent guides and filtering to FileTreeView</name>
  <files>src/components/staging/FileTreeView.tsx, src/components/staging/StagingPanel.tsx</files>
  <action>
Update FileTreeView with indent guides and integrate search into StagingPanel.

**FileTreeView.tsx:**
Add indent guides and accept filter prop:

```tsx
import { ChevronDown, ChevronRight } from "lucide-react";
import { useMemo, useState } from "react";
import type { FileChange } from "../../bindings";
import { cn } from "../../lib/utils";
import { FileTypeIcon } from "../icons/FileTypeIcon";
import { FileItem } from "./FileItem";

interface FileTreeViewProps {
  files: FileChange[];
  section: "staged" | "unstaged" | "untracked";
  filter?: string;
}

export function FileTreeView({ files, section, filter = "" }: FileTreeViewProps) {
  // Filter files based on search
  const filteredFiles = useMemo(() => {
    if (!filter) return files;
    const lowerFilter = filter.toLowerCase();
    return files.filter(f => f.path.toLowerCase().includes(lowerFilter));
  }, [files, filter]);

  const tree = useMemo(() => {
    // ... existing tree building logic but using filteredFiles instead of files
    const root: FileTreeNode = {
      name: "",
      path: "",
      isDirectory: true,
      children: new Map(),
    };

    for (const file of filteredFiles) {
      // ... same as before
    }

    return root;
  }, [filteredFiles]);

  if (filteredFiles.length === 0 && filter) {
    return (
      <div className="px-4 py-2 text-sm text-ctp-overlay0">
        No files matching "{filter}"
      </div>
    );
  }

  return (
    <div className="pl-2">
      {Array.from(tree.children.values()).map((node) => (
        <TreeNode key={node.path} node={node} section={section} depth={0} />
      ))}
    </div>
  );
}

function TreeNode({ node, section, depth }: TreeNodeProps) {
  const [expanded, setExpanded] = useState(true);

  // Indent guide component
  const IndentGuides = () => (
    <>
      {Array.from({ length: depth }).map((_, i) => (
        <div
          key={i}
          className="absolute h-full w-px bg-ctp-surface1"
          style={{ left: `${i * 12 + 14}px` }}
        />
      ))}
    </>
  );

  if (!node.isDirectory && node.file) {
    return (
      <div className="relative">
        <IndentGuides />
        <FileItem
          file={node.file}
          section={section}
          depth={depth}
          showFilenameOnly
        />
      </div>
    );
  }

  const childNodes = Array.from(node.children.values());

  return (
    <div>
      <div className="relative">
        <IndentGuides />
        <button
          type="button"
          className={cn(
            "flex items-center gap-1 px-2 py-1 cursor-pointer",
            "hover:bg-ctp-surface0/50 text-sm text-ctp-subtext0 w-full text-left",
          )}
          onClick={() => setExpanded(!expanded)}
          style={{ paddingLeft: `${depth * 12 + 8}px` }}
        >
          {expanded ? (
            <ChevronDown className="w-3 h-3" />
          ) : (
            <ChevronRight className="w-3 h-3" />
          )}
          <FileTypeIcon path={node.path} isDirectory isOpen={expanded} />
          <span>{node.name}</span>
        </button>
      </div>
      {expanded && (
        <div>
          {childNodes.map((child) => (
            <TreeNode
              key={child.path}
              node={child}
              section={section}
              depth={depth + 1}
            />
          ))}
        </div>
      )}
    </div>
  );
}
```

**StagingPanel.tsx:**
Add search state and FileTreeSearch component:

```tsx
import { useState } from "react";
import { FileTreeSearch } from "./FileTreeSearch";

export function StagingPanel() {
  const [searchFilter, setSearchFilter] = useState("");
  // ... existing code ...

  return (
    <div className="h-full flex flex-col overflow-hidden">
      {/* Search input */}
      <div className="p-2 border-b border-ctp-surface0">
        <FileTreeSearch 
          value={searchFilter} 
          onChange={setSearchFilter} 
        />
      </div>
      
      {/* Existing sections with filter prop */}
      <div className="flex-1 overflow-y-auto">
        {/* Staged section */}
        {stagedFiles.length > 0 && (
          <details open className="border-b border-ctp-surface0">
            {/* ... */}
            <FileTreeView files={stagedFiles} section="staged" filter={searchFilter} />
          </details>
        )}
        {/* ... same for unstaged and untracked */}
      </div>
    </div>
  );
}
```
  </action>
  <verify>
1. Run `npm run tauri dev`
2. Open a repository with multiple changed files
3. Verify indent guides appear as vertical lines showing hierarchy
4. Type in search box - files filter in real-time
5. Clear button (X) clears the filter
6. "No files matching" message appears when filter has no matches
  </verify>
  <done>File tree has indent guides and search filtering functionality.</done>
</task>

<task type="auto">
  <name>Task 3: Add batch selection functionality</name>
  <files>src/components/staging/FileTreeView.tsx, src/components/staging/StagingPanel.tsx</files>
  <action>
Add Shift+click range selection and Ctrl+A select all functionality.

**Update FileTreeView.tsx:**
```tsx
import { useState, useCallback } from "react";

interface FileTreeViewProps {
  files: FileChange[];
  section: "staged" | "unstaged" | "untracked";
  filter?: string;
  selectedFiles: Set<string>;
  onSelectionChange: (files: Set<string>) => void;
  lastClickedFile: string | null;
  onLastClickedChange: (path: string) => void;
}

export function FileTreeView({
  files,
  section,
  filter = "",
  selectedFiles,
  onSelectionChange,
  lastClickedFile,
  onLastClickedChange,
}: FileTreeViewProps) {
  // ... existing filter logic

  const handleFileClick = useCallback(
    (filePath: string, event: React.MouseEvent) => {
      event.stopPropagation();
      
      const newSelection = new Set(selectedFiles);
      
      if (event.shiftKey && lastClickedFile) {
        // Range selection
        const fileList = filteredFiles.map(f => f.path);
        const startIdx = fileList.indexOf(lastClickedFile);
        const endIdx = fileList.indexOf(filePath);
        
        if (startIdx !== -1 && endIdx !== -1) {
          const [start, end] = startIdx < endIdx 
            ? [startIdx, endIdx] 
            : [endIdx, startIdx];
          
          for (let i = start; i <= end; i++) {
            newSelection.add(fileList[i]);
          }
        }
      } else if (event.ctrlKey || event.metaKey) {
        // Toggle single selection
        if (newSelection.has(filePath)) {
          newSelection.delete(filePath);
        } else {
          newSelection.add(filePath);
        }
      } else {
        // Single select (clear others)
        newSelection.clear();
        newSelection.add(filePath);
      }
      
      onSelectionChange(newSelection);
      onLastClickedChange(filePath);
    },
    [selectedFiles, lastClickedFile, filteredFiles, onSelectionChange, onLastClickedChange]
  );

  const handleSelectAll = useCallback(() => {
    const allPaths = new Set(filteredFiles.map(f => f.path));
    onSelectionChange(allPaths);
  }, [filteredFiles, onSelectionChange]);

  // Add keyboard event handler for Ctrl+A
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "a") {
        // Only handle if this section is focused
        e.preventDefault();
        handleSelectAll();
      }
    };
    
    // Add event listener to section container
    // ... implementation
  }, [handleSelectAll]);

  // Pass handleFileClick to FileItem
  return (
    <div className="pl-2" tabIndex={0}>
      {/* ... tree rendering with onClick={handleFileClick} */}
    </div>
  );
}
```

**Update StagingPanel.tsx:**
```tsx
const [selectedFiles, setSelectedFiles] = useState<Set<string>>(new Set());
const [lastClickedFile, setLastClickedFile] = useState<string | null>(null);

// Pass to FileTreeView:
<FileTreeView 
  files={stagedFiles} 
  section="staged" 
  filter={searchFilter}
  selectedFiles={selectedFiles}
  onSelectionChange={setSelectedFiles}
  lastClickedFile={lastClickedFile}
  onLastClickedChange={setLastClickedFile}
/>

// Update bulk actions to use selectedFiles:
const handleBulkStage = () => {
  if (selectedFiles.size > 0) {
    stageFiles(Array.from(selectedFiles));
    setSelectedFiles(new Set());
  }
};

const handleBulkUnstage = () => {
  if (selectedFiles.size > 0) {
    unstageFiles(Array.from(selectedFiles));
    setSelectedFiles(new Set());
  }
};
```

**Update FileItem.tsx to show selection state:**
```tsx
interface FileItemProps {
  // ... existing props
  isSelected?: boolean;
  onClick?: (path: string, event: React.MouseEvent) => void;
}

// In component:
<div
  className={cn(
    "flex items-center gap-2 px-2 py-1 cursor-pointer",
    "hover:bg-ctp-surface0/50 text-sm",
    isSelected && "bg-ctp-blue/20 ring-1 ring-ctp-blue/30"
  )}
  onClick={(e) => onClick?.(file.path, e)}
>
```
  </action>
  <verify>
1. Run `npm run tauri dev`
2. Open a repository with multiple changed files
3. Click a file - it becomes selected (highlighted)
4. Hold Shift and click another file - all files between are selected
5. Hold Ctrl/Cmd and click files - toggle individual selection
6. Focus the file list and press Ctrl+A - all visible files are selected
7. Selection state clears after staging/unstaging
  </verify>
  <done>Batch selection implemented with Shift+click range and Ctrl+A select all.</done>
</task>

</tasks>

<verification>
1. `npm run tauri dev` - app launches without errors
2. File tree shows vertical indent guides for nested items
3. Search input filters files across all sections (staged, unstaged, untracked)
4. Filter updates in real-time as user types
5. Clear button resets the filter
6. Empty state message shown when filter has no matches
7. Build succeeds: `npm run build`
</verification>

<success_criteria>
- Indent guides visible in file tree hierarchy
- Search/filter input above file tree
- Real-time filtering as user types
- Clear button to reset filter
- Proper empty state when no matches
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-ux-ui-enhancements/06.2-08-SUMMARY.md`
</output>
