---
phase: 36-github-write-operations-extension-manager
plan: 03
type: execute
wave: 3
depends_on: ["36-02"]
files_modified:
  - src/extensions/github/blades/PullRequestDetailBlade.tsx
  - src/extensions/github/index.ts
  - src/extensions/ExtensionHost.ts
  - src/extensions/extensionTypes.ts
autonomous: false

must_haves:
  truths:
    - "User can click Merge in PR detail blade header and see the merge confirmation dialog"
    - "User can open Create PR blade from toolbar or command palette"
    - "User can open Extension Manager blade from toolbar or command palette"
    - "Extension enable/disable state persists across app restarts via tauri-plugin-store"
    - "After merging a PR, the PR detail and list queries are invalidated and refresh"
    - "After creating a PR, the PR list query is invalidated and refreshes"
  artifacts:
    - path: "src/extensions/github/blades/PullRequestDetailBlade.tsx"
      provides: "Merge button in PR detail blade trailing section"
      contains: "MergeConfirmDialog"
    - path: "src/extensions/github/index.ts"
      provides: "Registration of CreatePR blade, Create PR command, Extension Manager toolbar action"
      contains: "create-pr"
    - path: "src/extensions/ExtensionHost.ts"
      provides: "Extension enable/disable with persistence"
      contains: "persistExtensionState"
  key_links:
    - from: "src/extensions/github/blades/PullRequestDetailBlade.tsx"
      to: "src/extensions/github/hooks/useGitHubMutation.ts"
      via: "useMergePullRequest hook"
      pattern: "useMergePullRequest"
    - from: "src/extensions/github/index.ts"
      to: "src/extensions/github/blades/CreatePullRequestBlade.tsx"
      via: "dynamic import for blade registration"
      pattern: "CreatePullRequestBlade"
    - from: "src/extensions/ExtensionHost.ts"
      to: "src/lib/store.ts"
      via: "getStore for extension state persistence"
      pattern: "getStore|extensionState"
---

<objective>
Wire all Phase 36 components into the existing UI: add merge button to PR detail blade, register CreatePR blade and commands in the GitHub extension entry point, add Extension Manager toolbar action, and implement extension enable/disable persistence in ExtensionHost.

Purpose: This is the integration wave that makes all the building blocks from Waves 1 and 2 accessible to the user through the existing navigation and toolbar systems.
Output: All 7 requirements (GH-09, GH-10, EXT-09, EXT-10, EXT-11, EXT-12, EXT-13) are wired end-to-end.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-github-write-operations-extension-manager/36-01-SUMMARY.md
@.planning/phases/36-github-write-operations-extension-manager/36-02-SUMMARY.md
@src/extensions/github/index.ts
@src/extensions/github/blades/PullRequestDetailBlade.tsx
@src/extensions/ExtensionHost.ts
@src/extensions/extensionTypes.ts
@src/lib/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add merge button to PR detail blade, register CreatePR blade and commands, add Extension Manager toolbar action, implement extension state persistence</name>
  <files>
    src/extensions/github/blades/PullRequestDetailBlade.tsx
    src/extensions/github/index.ts
    src/extensions/ExtensionHost.ts
    src/extensions/extensionTypes.ts
  </files>
  <action>
    **1. PullRequestDetailBlade.tsx -- Add merge action:**

    Import `useMergePullRequest` from `../hooks/useGitHubMutation`, `MergeConfirmDialog` from `../components/MergeConfirmDialog`, `GitMerge` from `lucide-react`, `Button` from `../../../components/ui/button`.

    Add state: `showMergeDialog` (boolean, default false).

    Instantiate the merge mutation: `const mergeMutation = useMergePullRequest(owner, repo)`.

    Add a merge button in the blade UI. There are two approaches based on how the blade is structured:

    **Option A (if blade uses renderTrailing in registration):** Add a "Merge" button in the trailing section of the blade header. This is the preferred approach per UX research. Check how the blade is registered in `index.ts` -- if it uses `renderTrailing`, add the button there. If not, add it inline.

    **Option B (inline in blade body):** Add a merge button section at the top of the PR detail content, visible only when `pr.state === "open"` and `!pr.draft`. Button: `<Button onClick={() => setShowMergeDialog(true)}>` with GitMerge icon + "Merge" text. Style: `bg-ctp-green text-ctp-base hover:bg-ctp-green/90`.

    Use whichever option matches the existing blade structure. The key requirement is:
    - Button visible only when PR is open and not draft
    - Clicking opens `<MergeConfirmDialog>`
    - Dialog receives `prNumber`, `prTitle`, `headRef` (from pr.head), `baseRef` (from pr.base), `isPending={mergeMutation.isPending}`
    - Dialog's `onMerge` callback calls `mergeMutation.mutate({ pullNumber: pr.number, mergeMethod, commitTitle, commitMessage, sha: pr.headSha })`. Pass the head SHA for conflict detection.
    - On merge success (handled by mutation hook), close the dialog

    Render `<MergeConfirmDialog>` at the bottom of the component, controlled by `showMergeDialog` state.

    Add effect: when `mergeMutation.isSuccess`, set `showMergeDialog(false)`.

    **2. index.ts -- Register CreatePR blade, commands, and Extension Manager toolbar action:**

    This file is the GitHub extension entry point. Add the following registrations in `onActivate`:

    **CreatePR blade registration:**
    Add a lazy-loaded blade variable and dynamic import in `ensureComponents()`:
    ```typescript
    let CreatePullRequestBlade: React.ComponentType<any> | null = null;
    // In ensureComponents:
    if (!CreatePullRequestBlade) {
      const mod = await import("./blades/CreatePullRequestBlade");
      CreatePullRequestBlade = mod.CreatePullRequestBlade;
    }
    ```

    Register the blade:
    ```typescript
    api.registerBlade({
      type: "create-pr",
      title: "Create Pull Request",
      component: CreatePullRequestBlade!,
      singleton: true,
      wrapInPanel: true,
      showBack: true,
    });
    ```

    **CreatePR command:**
    ```typescript
    api.registerCommand({
      id: "create-pull-request",
      title: "Create Pull Request",
      category: "GitHub",
      action: () => {
        const remote = getSelectedRemote();
        if (remote) {
          openBlade("ext:github:create-pr", { owner: remote.owner, repo: remote.repo });
        }
      },
    });
    ```

    Check `getSelectedRemote` function -- it should be available from the githubStore or as a helper. Use `useGitHubStore.getState()` to get the current selected remote if needed.

    **CreatePR toolbar action:**
    ```typescript
    api.registerToolbarAction({
      id: "create-pr",
      label: "Create Pull Request",
      icon: "GitPullRequestCreate", // or use createElement with the icon component
      group: "views",
      priority: 65, // After PR list and issue list actions
      action: () => {
        const remote = getSelectedRemote();
        if (remote) {
          openBlade("ext:github:create-pr", { owner: remote.owner, repo: remote.repo });
        }
      },
      when: () => {
        const gh = useGitHubStore.getState();
        const repo = useRepositoryStore.getState();
        // Only show when authenticated, remote detected, and not on default branch
        return gh.isAuthenticated && gh.detectedRemotes.length > 0 && !!repo.repoStatus?.branchName;
      },
    });
    ```

    **Extension Manager toolbar action:**
    Register a toolbar action for the extension manager (this is a core blade, not an extension blade, so register it through the GitHub extension's toolbar contributions or as a separate registration):

    Actually, the Extension Manager is a CORE blade, not an extension blade. It should be accessible from the command palette and optionally a toolbar action. The toolbar action should be registered outside the GitHub extension -- add it in the `ExtensionHost` or in the blade registration file. However, to keep changes minimal and avoid touching too many files, register it as a command through the extension system:

    Better approach: Add a command palette entry for "Extension Manager" in the core command registrations. Check `src/blades/_discovery.ts` or wherever core commands are registered. If core commands are registered in `bladeInit.ts` or similar, add there. Alternatively, add a direct toolbar action registration in the toolbar actions setup.

    The simplest approach: In the extension manager's `registration.ts` (created in Plan 02), also register a command and toolbar action for opening it. Update `src/blades/extension-manager/registration.ts` to include:
    ```typescript
    import { registerCommand } from "../../stores/domain/commands/commandStore";
    import { registerToolbarAction } from "../../stores/domain/toolbar/toolbarRegistry";

    export function registerExtensionManagerBlade() {
      // ... existing blade registration ...

      registerCommand({
        id: "open-extension-manager",
        label: "Extension Manager",
        category: "App",
        action: () => openBlade("extension-manager", {}),
      });

      // Optionally add toolbar action (Puzzle icon, app group)
    }
    ```

    Check the exact API for `registerCommand` and `registerToolbarAction` -- they may have different parameter shapes. Look at how existing core commands are registered and follow that pattern.

    **3. ExtensionHost.ts -- Add enable/disable persistence:**

    Import the store utility (`getStore` from `../../lib/store` or wherever the tauri-plugin-store singleton is).

    Add two new methods to the ExtensionHost Zustand store:

    **`persistExtensionState()`:** Reads the current extensions Map, builds a list of disabled extension IDs (where status !== "active"), and saves to tauri-plugin-store:
    ```typescript
    const store = await getStore();
    const disabledIds = Array.from(get().extensions.values())
      .filter(ext => ext.status !== "active" && ext.status !== "activating")
      .map(ext => ext.id);
    await store.set("disabledExtensions", disabledIds);
    await store.save();
    ```

    **`loadPersistedState()`:** Called during initialization (in `activateAll` or equivalent). Reads disabled IDs from store, skips activating extensions whose IDs are in the list:
    ```typescript
    const store = await getStore();
    const disabledIds: string[] = (await store.get("disabledExtensions")) ?? [];
    return disabledIds;
    ```

    Modify the `activateAll` (or `activateExtensions`) logic:
    - Before activating extensions, call `loadPersistedState()` to get disabled IDs
    - Skip activation for extensions whose ID is in the disabled list
    - Set their status to "discovered" or add a new status "disabled" to indicate they were intentionally disabled

    Modify `deactivateExtension` to also call `persistExtensionState()` after deactivating.
    Modify `activateExtension` to also call `persistExtensionState()` after activating.

    **4. extensionTypes.ts -- Add source field (optional):**

    If `ExtensionInfo` doesn't already have a `source` field, add:
    ```typescript
    source?: "built-in" | "local" | "github";
    ```
    This is used by the Extension Manager card to show provenance. Set `source: "built-in"` for built-in extensions (in `registerBuiltIn`), and `source: "local"` or `source: "github"` for discovered/installed extensions.
  </action>
  <verify>
    Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | grep -v "bindings.ts(1493" | head -30` -- must show no new TypeScript errors. Run `cargo check --manifest-path src-tauri/Cargo.toml` to verify Rust is still clean.
  </verify>
  <done>
    PR detail blade shows "Merge" button for open, non-draft PRs that opens MergeConfirmDialog. CreatePR blade and command are registered in the GitHub extension. Extension Manager blade is accessible from command palette. Extension enable/disable state persists via tauri-plugin-store.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual and functional verification of all Phase 36 features</name>
  <files>
    src/extensions/github/blades/PullRequestDetailBlade.tsx
    src/extensions/github/blades/CreatePullRequestBlade.tsx
    src/blades/extension-manager/ExtensionManagerBlade.tsx
  </files>
  <action>
    Phase 36 complete: GitHub write operations (merge PR with strategy selector, create PR from branch) and extension manager (list extensions with toggle/uninstall, install from URL with manifest review, permission badges). Human verification needed for visual and functional correctness.

    Verification steps:

    1. **Merge PR flow (GH-09):**
       - Open a pull request detail blade for an open, non-draft PR
       - Verify a green "Merge" button appears in the blade
       - Click "Merge" -- confirm the MergeConfirmDialog opens with PR title, branch indicator, three strategy radio options, warning, Cancel (focused first) and green Merge button
       - Select "Squash and merge" -- verify commit message textarea appears
       - Select "Rebase" -- verify commit message textarea disappears
       - Click Cancel -- dialog closes, no merge executed

    2. **Create PR flow (GH-10):**
       - Switch to a feature branch (not main)
       - Open command palette, search "Create Pull Request" -- should appear
       - Click it -- Create PR blade opens with title pre-filled from branch name, body pre-filled from commits, draft toggle, and base branch selector

    3. **Extension Manager (EXT-10, EXT-11):**
       - Open command palette, search "Extension Manager" -- should appear
       - Click it -- Extension Manager blade opens with search, built-in section showing GitHub extension with toggle/contribution counts, Install button at top

    4. **Extension Install Flow (EXT-09, EXT-12):**
       - Click "Install" button -- verify dialog opens with URL input and multi-step flow

    5. **Extension Toggle Persistence (EXT-13):**
       - Toggle extension off, reload app, verify it stays disabled. Toggle back on.

    6. **Overall visual consistency:**
       - All components use Catppuccin tokens, dialog animations match, buttons follow conventions
  </action>
  <verify>Visual inspection by human user confirms all 6 verification areas pass.</verify>
  <done>User types "approved" confirming Phase 36 features work correctly end-to-end.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` shows no new TypeScript errors
2. `cargo check` passes
3. PR detail blade has merge button for open PRs
4. Create PR blade is accessible from command palette
5. Extension Manager blade is accessible from command palette
6. Extension enable/disable persists across sessions
7. All 7 requirements (GH-09, GH-10, EXT-09, EXT-10, EXT-11, EXT-12, EXT-13) are covered
</verification>

<success_criteria>
All Phase 36 features are wired end-to-end. User can merge PRs with strategy selection, create PRs with auto-filled content, install extensions from URLs with manifest review, manage extensions with enable/disable toggles, and extension state persists. Visual checkpoint passes.
</success_criteria>

<output>
After completion, create `.planning/phases/36-github-write-operations-extension-manager/36-03-SUMMARY.md`
</output>
