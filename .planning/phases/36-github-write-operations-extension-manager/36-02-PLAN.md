---
phase: 36-github-write-operations-extension-manager
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - src/extensions/github/hooks/useGitHubMutation.ts
  - src/extensions/github/components/MergeStrategySelector.tsx
  - src/extensions/github/components/MergeConfirmDialog.tsx
  - src/extensions/github/components/ToggleSwitch.tsx
  - src/extensions/github/components/PermissionBadge.tsx
  - src/extensions/github/blades/CreatePullRequestBlade.tsx
  - src/extensions/github/blades/ExtensionManagerBlade.tsx
  - src/stores/bladeTypes.ts
  - src/blades/extension-manager/registration.ts
  - src/blades/extension-manager/ExtensionManagerBlade.tsx
autonomous: true

must_haves:
  truths:
    - "useMergePullRequest and useCreatePullRequest mutation hooks exist with proper cache invalidation"
    - "MergeStrategySelector renders three radio options (merge, squash, rebase) with accessible radiogroup role"
    - "MergeConfirmDialog shows PR title, branch info, warning, and cancel/confirm buttons"
    - "ToggleSwitch renders as role=switch with aria-checked and disabled states"
    - "PermissionBadge renders colored pills for network, filesystem, git-operations"
    - "CreatePullRequestBlade renders a form with title, body, base branch, and draft toggle"
    - "ExtensionManagerBlade lists extensions with toggle switches, contribution counts, and install section"
    - "Extension manager is registered as core blade type in BladePropsMap"
  artifacts:
    - path: "src/extensions/github/hooks/useGitHubMutation.ts"
      provides: "useMergePullRequest and useCreatePullRequest mutation hooks"
      exports: ["useMergePullRequest", "useCreatePullRequest"]
    - path: "src/extensions/github/components/MergeStrategySelector.tsx"
      provides: "Radio group for merge/squash/rebase strategy selection"
      exports: ["MergeStrategySelector"]
    - path: "src/extensions/github/components/MergeConfirmDialog.tsx"
      provides: "Confirmation dialog before PR merge"
      exports: ["MergeConfirmDialog"]
    - path: "src/extensions/github/components/ToggleSwitch.tsx"
      provides: "Reusable toggle switch with role=switch"
      exports: ["ToggleSwitch"]
    - path: "src/extensions/github/components/PermissionBadge.tsx"
      provides: "Colored permission indicator pills"
      exports: ["PermissionBadge"]
    - path: "src/extensions/github/blades/CreatePullRequestBlade.tsx"
      provides: "PR creation form blade with auto-fill"
      exports: ["CreatePullRequestBlade"]
    - path: "src/blades/extension-manager/ExtensionManagerBlade.tsx"
      provides: "Extension manager list with install/toggle/uninstall"
      exports: ["ExtensionManagerBlade"]
    - path: "src/stores/bladeTypes.ts"
      provides: "extension-manager type in BladePropsMap"
      contains: "extension-manager"
  key_links:
    - from: "src/extensions/github/hooks/useGitHubMutation.ts"
      to: "src/bindings.ts"
      via: "commands.githubMergePullRequest and commands.githubCreatePullRequest"
      pattern: "commands\\.github(Merge|Create)"
    - from: "src/extensions/github/blades/CreatePullRequestBlade.tsx"
      to: "src/extensions/github/hooks/useGitHubMutation.ts"
      via: "useCreatePullRequest hook"
      pattern: "useCreatePullRequest"
    - from: "src/blades/extension-manager/ExtensionManagerBlade.tsx"
      to: "src/extensions/ExtensionHost.ts"
      via: "useExtensionHost store selector"
      pattern: "useExtensionHost"
---

<objective>
Build all Phase 36 frontend components: mutation hooks for GitHub write operations, UI components (MergeStrategySelector, MergeConfirmDialog, ToggleSwitch, PermissionBadge), the CreatePullRequestBlade, and the ExtensionManagerBlade as a core blade.

Purpose: These components are the building blocks that Wave 3 wires into the existing UI (PR detail blade gets merge button, extension manager gets toolbar entry, Create PR gets command registration).
Output: All new React components and hooks created, extension manager registered as core blade type.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-github-write-operations-extension-manager/36-01-SUMMARY.md
@src/extensions/github/hooks/useGitHubQuery.ts
@src/extensions/github/blades/PullRequestDetailBlade.tsx
@src/extensions/github/components/LabelPill.tsx
@src/extensions/github/components/StatusBadge.tsx
@src/extensions/ExtensionHost.ts
@src/extensions/extensionTypes.ts
@src/components/ui/dialog.tsx
@src/components/ui/button.tsx
@src/stores/bladeTypes.ts
@src/blades/settings/registration.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mutation hooks, shared UI components, and CreatePullRequestBlade</name>
  <files>
    src/extensions/github/hooks/useGitHubMutation.ts
    src/extensions/github/components/MergeStrategySelector.tsx
    src/extensions/github/components/MergeConfirmDialog.tsx
    src/extensions/github/components/ToggleSwitch.tsx
    src/extensions/github/components/PermissionBadge.tsx
    src/extensions/github/blades/CreatePullRequestBlade.tsx
  </files>
  <action>
    **1. useGitHubMutation.ts -- NEW file with mutation hooks:**

    Create `src/extensions/github/hooks/useGitHubMutation.ts`:

    Import `useMutation, useQueryClient` from `@tanstack/react-query`, `commands` from `../../../bindings`, and the toast system.

    Helper function `extractGitHubErrorMessage(error: unknown): string` -- check for `error.message`, `error.type`, fallback to "Unknown GitHub error". Follow the existing `extractErrorMessage` pattern in `useGitHubQuery.ts`.

    **`useMergePullRequest(owner: string, repo: string)`:**
    - `mutationFn`: accepts `{ pullNumber: number; mergeMethod: "merge" | "squash" | "rebase"; commitTitle?: string; commitMessage?: string; sha?: string }`. Calls `commands.githubMergePullRequest(owner, repo, params.pullNumber, params.mergeMethod, params.commitTitle ?? null, params.commitMessage ?? null, params.sha ?? null)`. Check `result.status === "error"`, throw with extracted message. Return `result.data`.
    - `onSuccess`: toast.success with PR number. Invalidate `["ext:github", "pullRequest", owner, repo, variables.pullNumber]` and `["ext:github", "pullRequests", owner, repo]`.
    - `onError`: toast.error with error message.

    **`useCreatePullRequest(owner: string, repo: string)`:**
    - `mutationFn`: accepts `{ title: string; head: string; base: string; body?: string; draft?: boolean }`. Calls `commands.githubCreatePullRequest(owner, repo, params.title, params.head, params.base, params.body ?? null, params.draft ?? null)`. Same error handling pattern.
    - `onSuccess`: toast.success with PR number. Invalidate `["ext:github", "pullRequests", owner, repo]`.
    - `onError`: toast.error.

    **2. MergeStrategySelector.tsx -- NEW component:**

    Create `src/extensions/github/components/MergeStrategySelector.tsx`:

    Define `MergeMethod = "merge" | "squash" | "rebase"` type.

    Define strategies array with `{ value, label, description, icon }`:
    - `merge`: "Create a merge commit", "All commits preserved with a merge commit", `GitMerge` icon
    - `squash`: "Squash and merge", "All commits squashed into a single commit", `Layers` icon
    - `rebase`: "Rebase and merge", "Commits rebased onto base branch linearly", `GitBranch` icon

    Props: `{ value: MergeMethod; onChange: (method: MergeMethod) => void; disabled?: boolean }`.

    Render a `<fieldset>` with `<legend>` "Merge method". Map strategies to radio labels. Use these styles:
    - Selected: `border-ctp-blue bg-ctp-blue/5`
    - Unselected: `border-ctp-surface1 hover:border-ctp-surface2 hover:bg-ctp-surface0/30`
    - Use `role="radiogroup"` on the fieldset, `aria-label="Merge strategy"`
    - Use `sr-only` class on the actual radio inputs, visual selection shown via border/bg
    - Each label shows the icon (4x4, colored blue when selected, overlay0 when not), bold label, and description below

    Import `cn` from `../../../lib/utils`, icons from `lucide-react`.

    **3. MergeConfirmDialog.tsx -- NEW component:**

    Create `src/extensions/github/components/MergeConfirmDialog.tsx`:

    Props: `{ open: boolean; onOpenChange: (open: boolean) => void; prNumber: number; prTitle: string; headRef: string; baseRef: string; onMerge: (method: MergeMethod, commitTitle?: string, commitMessage?: string) => void; isPending: boolean; }`.

    Internal state: `mergeMethod` (useState, default "merge"), `commitMessage` (useState, default "").

    Layout (using existing Dialog/DialogContent/DialogHeader/DialogTitle/DialogFooter):
    - Header: GitMerge icon (green) + "Merge Pull Request" title
    - Body:
      - PR description: "Merge **#42 feat: add dark mode** into `main`?"
      - Branch indicator: `headRef -> baseRef` with `font-mono bg-ctp-surface0 px-1.5 py-0.5 rounded`
      - `<MergeStrategySelector>` component
      - Commit message textarea (shown only for merge/squash methods, NOT rebase): label "Commit message (optional)", placeholder "Merge pull request #42", 2 rows. Use existing Textarea if available, or a plain textarea with project styling.
      - Warning callout: AlertTriangle icon + yellow bg + "This action cannot be undone. The branch will be merged into {baseRef}."
    - Footer:
      - Cancel button (ghost variant, `autoFocus` for safety-first focus)
      - Merge button: green background (`bg-ctp-green text-ctp-base hover:bg-ctp-green/90`), `loading={isPending}`, `loadingText="Merging..."`, GitMerge icon + "Merge Pull Request" text. Calls `onMerge(mergeMethod, commitMessage || undefined)`.
      - Disable both buttons while `isPending`.

    **4. ToggleSwitch.tsx -- NEW component:**

    Create `src/extensions/github/components/ToggleSwitch.tsx`:

    Props: `{ checked: boolean; onChange: (checked: boolean) => void; loading?: boolean; disabled?: boolean; "aria-label"?: string; }`.

    Render a `<button>` with:
    - `type="button"`, `role="switch"`, `aria-checked={checked}`
    - `onClick={() => !disabled && onChange(!checked)}`
    - Outer: `h-5 w-9 rounded-full`, checked `bg-ctp-green`, unchecked `bg-ctp-surface2`
    - `focus-visible:ring-1 focus-visible:ring-ctp-overlay0`
    - `disabled:opacity-40 disabled:cursor-not-allowed`
    - Inner circle: `h-4 w-4 rounded-full bg-ctp-text shadow-sm`, checked `translate-x-4`, unchecked `translate-x-0.5`, `mt-0.5`, `transition-transform duration-150`
    - Loading: if `loading`, show `Loader2` spinner icon (3x3, animate-spin) inside the circle, absolute positioned center

    Import `cn` from `../../../lib/utils`, `Loader2` from `lucide-react`.

    **5. PermissionBadge.tsx -- NEW component:**

    Create `src/extensions/github/components/PermissionBadge.tsx`:

    Define permission style map:
    ```typescript
    const PERMISSION_STYLES: Record<string, { bg: string; text: string }> = {
      network: { bg: "bg-ctp-blue/15", text: "text-ctp-blue" },
      filesystem: { bg: "bg-ctp-yellow/15", text: "text-ctp-yellow" },
      "git-operations": { bg: "bg-ctp-green/15", text: "text-ctp-green" },
    };
    ```

    Props: `{ permission: string }`.
    Render `<span>` with `text-[10px] px-1.5 py-0.5 rounded-full font-medium`, colors from map (fallback `bg-ctp-surface1 text-ctp-subtext0`), text content is the permission string.

    **6. CreatePullRequestBlade.tsx -- NEW blade:**

    Create `src/extensions/github/blades/CreatePullRequestBlade.tsx`:

    Props: `{ owner: string; repo: string }`.

    State:
    - `title` (string, default: auto-filled from branch name -- strip prefixes `feature/`, `fix/`, `hotfix/`, `bugfix/`, `release/`, `chore/`, replace `-_` with spaces, capitalize first letter)
    - `base` (string, default "main")
    - `body` (string, default "")
    - `isDraft` (boolean, default false)
    - `isLoadingInfo` (boolean, for initial branch info loading)

    Get current branch from `useRepositoryStore((s) => s.repoStatus?.branchName)`.

    On mount (`useEffect`), call `commands.githubGetBranchInfoForPr()` (no args needed if backend uses RepositoryState). On success, set `title` from `result.data.suggestedTitle`, `base` from `result.data.defaultBase`, and `body` from `result.data.commitMessages.map(m => "- " + m).join("\n")`. If the branch info command doesn't exist yet in bindings or errors, fallback to branch name parsing.

    Use `useCreatePullRequest(owner, repo)` mutation hook.

    Form validation: `canSubmit = title.trim().length > 0 && currentBranch !== base && !mutation.isPending`.

    Form guard: use `useBladeFormGuard` if available in the codebase (check for it). Pass a dirty check: `isDirty = title !== defaultTitle || body !== defaultBody`.

    Layout (as a scrollable form):
    - Branch info bar: `currentBranch -> base` with a text input for base (so user can type a different base branch)
    - Title input: full width, labeled "Title", `autoFocus`, required
    - Body textarea: labeled "Description", 8 rows, monospace font, placeholder "Describe your changes..."
    - Draft toggle: `<ToggleSwitch>` + label "Create as draft"
    - Submit button: full width, `loading={mutation.isPending}`, `loadingText="Creating..."`, disabled when `!canSubmit`, text "Create Pull Request"
    - Same-branch warning: if `currentBranch === base`, show yellow text "Cannot create a PR from the same branch."
    - Success handling: on mutation success, the `onSuccess` callback in the hook shows toast. Additionally, could navigate back or show the new PR number. Keep it simple -- toast is sufficient for now.

    Style all inputs using the project's existing pattern: `bg-ctp-mantle border border-ctp-surface1 rounded focus:outline-none focus:border-ctp-blue text-ctp-text`.
  </action>
  <verify>
    Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | grep -v "bindings.ts(1493" | head -30` -- should show no NEW errors (the pre-existing bindings.ts TS2440 error is expected and ignored). Also check that all 6 new files exist with `ls src/extensions/github/hooks/useGitHubMutation.ts src/extensions/github/components/MergeStrategySelector.tsx src/extensions/github/components/MergeConfirmDialog.tsx src/extensions/github/components/ToggleSwitch.tsx src/extensions/github/components/PermissionBadge.tsx src/extensions/github/blades/CreatePullRequestBlade.tsx`.
  </verify>
  <done>
    All 6 files created and TypeScript-clean. Mutation hooks call the correct Tauri bindings. MergeStrategySelector has accessible radiogroup. MergeConfirmDialog uses existing Dialog primitives. ToggleSwitch uses role=switch. PermissionBadge shows colored pills. CreatePullRequestBlade auto-fills from branch info.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ExtensionManagerBlade as core blade with install dialog and registration</name>
  <files>
    src/blades/extension-manager/ExtensionManagerBlade.tsx
    src/blades/extension-manager/registration.ts
    src/blades/extension-manager/components/ExtensionCard.tsx
    src/blades/extension-manager/components/InstallExtensionDialog.tsx
    src/stores/bladeTypes.ts
    src/blades/_discovery.ts
  </files>
  <action>
    **1. bladeTypes.ts -- Add extension-manager to BladePropsMap:**

    Add `"extension-manager": Record<string, never>;` to the `BladePropsMap` interface, after the existing `"settings"` entry. This makes it a core blade type.

    **2. ExtensionCard.tsx -- NEW component:**

    Create `src/blades/extension-manager/components/ExtensionCard.tsx`:

    Import `ExtensionInfo` from `../../../extensions/extensionTypes`, `ToggleSwitch` from `../../../extensions/github/components/ToggleSwitch`, `PermissionBadge` from `../../../extensions/github/components/PermissionBadge`, `useExtensionHost` from `../../../extensions/ExtensionHost`.

    Props: `{ extension: ExtensionInfo }`.

    Internal state: `isToggling` (boolean).

    Extract from extension:
    - `isActive = extension.status === "active"`
    - `isBuiltIn = extension.builtIn === true`
    - `isError = extension.status === "error"`
    - `contributes = extension.manifest.contributes` -- count blades, commands, toolbar actions

    `handleToggle` function:
    - Set `isToggling = true`
    - If active: call `deactivateExtension(extension.id)`, toast "Extension disabled"
    - If not active: call `activateExtension(extension.id)`, toast "Extension enabled"
    - Catch errors and toast.error
    - Set `isToggling = false`

    `handleUninstall` function (for later -- just show a confirm dialog or skip for now):
    - Only available for non-built-in extensions
    - Call `commands.extensionUninstall(extension.id, extensionsDir)` then remove from store
    - For now, implement as a Button that triggers the uninstall flow

    Render layout:
    - Outer div: `p-4 rounded-lg border`, error state gets `border-ctp-red/30 bg-ctp-red/5`, normal gets `border-ctp-surface1 bg-ctp-surface0`
    - Left side (flex-1 min-w-0):
      - Row: name (sm font-medium), version (xs overlay0), "Built-in" badge if applicable
      - Description (xs overlay0, truncate, mt-0.5)
      - Error message (xs red, mt-0.5) if error
      - Contribution counts row (flex gap-3 mt-2, text [10px]): "Blades: N", "Commands: N", "Toolbar: N" -- only show non-zero counts
      - Permission badges (flex gap-1 mt-2) using `PermissionBadge` for each permission
    - Right side (flex shrink-0, items-center gap-2):
      - ToggleSwitch (hidden if error state, disabled if built-in and toggling would break things -- actually built-in CAN be toggled per research, but show warning)
      - Uninstall button (ghost variant, sm, red text, hidden for built-in extensions)

    **3. InstallExtensionDialog.tsx -- NEW component:**

    Create `src/blades/extension-manager/components/InstallExtensionDialog.tsx`:

    State machine via `useState<"input" | "fetching" | "review" | "installing" | "success" | "error">`:

    Props: `{ open: boolean; onOpenChange: (open: boolean) => void; onInstalled: () => void; }`.

    State: `step`, `url` (string), `manifestJson` (string), `tempPath` (string), `errorMessage` (string).

    Steps:
    1. **input**: URL input + "Fetch Manifest" button. Validate URL is non-empty. On submit, set step to "fetching", call `commands.extensionFetchManifest(url)`.
    2. **fetching**: Show spinner + "Fetching manifest...". On success, parse result to get `manifestJson` and `tempPath`, set step to "review". On error, set step to "error" with message.
    3. **review**: Parse manifestJson to display: name, version, description, contributes (blades/commands/toolbar list), permissions with PermissionBadge components. Warning callout about permissions. Two buttons: Cancel (calls `commands.extensionCancelInstall(tempPath)`, closes dialog) and "Install & Activate" (sets step to "installing", calls `commands.extensionInstall(tempPath, extensionsDir)`).
    4. **installing**: Show spinner + "Installing...".
    5. **success**: Green check icon + "installed successfully!" + Done button (closes dialog, calls `onInstalled`).
    6. **error**: Red X icon + error message + "Try Again" button (resets to "input") + Cancel.

    Use existing Dialog/DialogContent/DialogHeader/DialogTitle/DialogFooter. Each step renders different content inside DialogContent.

    For `extensionsDir`: determine from the repo path or use a fixed path relative to app data. The extensions directory pattern from the codebase is `.flowforge/extensions/` -- get it from `useExtensionHost` or construct from known paths. Check how `discover_extensions` is called to find the path pattern.

    **4. ExtensionManagerBlade.tsx -- NEW core blade:**

    Create `src/blades/extension-manager/ExtensionManagerBlade.tsx`:

    Import `useExtensionHost` from `../../extensions/ExtensionHost`, `ExtensionCard` from `./components/ExtensionCard`, `InstallExtensionDialog` from `./components/InstallExtensionDialog`.

    State: `installDialogOpen` (boolean), `searchQuery` (string).

    Get extensions from `useExtensionHost((s) => s.extensions)`.

    Convert Map to sorted array. Filter by search query (name/description match). Split into `builtInExts` and `installedExts`.

    Layout:
    - Top bar: Search input + Install button (Plus icon, opens install dialog)
    - Scrollable list:
      - Section "Installed" (if any) with count badge
      - Each extension as `<ExtensionCard>`
      - Section "Built-in" with count badge
      - Each built-in extension as `<ExtensionCard>`
    - `<InstallExtensionDialog>` rendered with open state

    **5. registration.ts -- Blade registration:**

    Create `src/blades/extension-manager/registration.ts` following the pattern from `src/blades/settings/registration.ts`:
    ```typescript
    import { registerBlade } from "../_shared/bladeRegistry";

    export function registerExtensionManagerBlade() {
      registerBlade({
        type: "extension-manager",
        defaultTitle: "Extension Manager",
        singleton: true,
        component: () => import("./ExtensionManagerBlade").then(m => m.ExtensionManagerBlade),
      });
    }
    ```

    **6. _discovery.ts -- Add registration call:**

    In `src/blades/_discovery.ts`, add the import and call `registerExtensionManagerBlade()` alongside the other blade registrations. Find where `registerSettingsBlade()` is called and add `registerExtensionManagerBlade()` nearby.
  </action>
  <verify>
    Run `cd /Users/phmatray/Repositories/github-phm/FlowForge && npx tsc --noEmit 2>&1 | grep -v "bindings.ts(1493" | head -30` -- should show no NEW TypeScript errors. Also verify the blade is registered: `grep "extension-manager" src/stores/bladeTypes.ts` should find the entry.
  </verify>
  <done>
    ExtensionManagerBlade is a core blade with list view, search, install dialog, extension cards with toggle/uninstall, contribution counts, and permission badges. Registered in BladePropsMap and blade discovery. InstallExtensionDialog handles the multi-step install flow (input -> fetch -> review -> install -> success/error).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` shows no new errors (ignore pre-existing bindings.ts TS2440)
2. All 10+ new files exist in the expected locations
3. `extension-manager` appears in BladePropsMap
4. MergeStrategySelector has `role="radiogroup"` attribute
5. ToggleSwitch has `role="switch"` attribute
6. MergeConfirmDialog uses existing Dialog component primitives
7. useGitHubMutation hooks call the correct Tauri commands
</verification>

<success_criteria>
All frontend components compile. Mutation hooks are wired to Tauri commands. Extension manager blade is registered as a core blade. All UI components follow existing patterns (Dialog, Button, cn, Catppuccin tokens). Accessible ARIA attributes are present on interactive elements.
</success_criteria>

<output>
After completion, create `.planning/phases/36-github-write-operations-extension-manager/36-02-SUMMARY.md`
</output>
