---
phase: 16-quick-fixes-visual-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/stash-utils.ts
  - src/components/stash/StashItem.tsx
  - src/components/blades/DiffBlade.tsx
  - src/components/Header.tsx
autonomous: true

must_haves:
  truths:
    - "Stash entries display a descriptive label instead of raw stash@{0} identifiers"
    - "Diff blade header shows path in gray + filename in bold as a single merged line"
    - "Switching to a different repository causes the blade view to reset"
    - "Main/master and dev/develop branch labels appear before feature branches in the topology graph"
  artifacts:
    - path: "src/lib/stash-utils.ts"
      provides: "parseStashMessage utility"
      exports: ["parseStashMessage"]
    - path: "src/components/stash/StashItem.tsx"
      provides: "Human-friendly stash display"
      contains: "parseStashMessage"
    - path: "src/components/blades/DiffBlade.tsx"
      provides: "Split path/filename display"
      contains: "font-semibold"
    - path: "src/components/Header.tsx"
      provides: "Blade reset on repo switch"
      contains: "resetStack"
  key_links:
    - from: "src/components/stash/StashItem.tsx"
      to: "src/lib/stash-utils.ts"
      via: "import parseStashMessage"
      pattern: "parseStashMessage"
    - from: "src/components/Header.tsx"
      to: "src/stores/blades.ts"
      via: "useBladeStore.getState().resetStack()"
      pattern: "resetStack"
---

<objective>
Fix four frontend issues: human-friendly stash labels (STSH-01), split diff header (UIPX-05), blade reset on repo switch (NAVG-01), and verify topology branch ordering (TOPO-01).

Purpose: These are small, independent React-only fixes that improve display quality and navigation correctness.

Output: Stash entries show parsed descriptions, diff header splits path/filename, blade resets on repo switch, topology ordering confirmed working.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/stash/StashItem.tsx
@src/components/blades/DiffBlade.tsx
@src/components/Header.tsx
@src/components/topology/LaneHeader.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Human-friendly stash labels with parseStashMessage utility</name>
  <files>src/lib/stash-utils.ts, src/components/stash/StashItem.tsx</files>
  <action>
Create a stash message parser and update StashItem to show parsed descriptions prominently.

1. Create new file `src/lib/stash-utils.ts`:
```ts
/**
 * Parse a git stash message into structured parts.
 *
 * Git stash messages follow patterns like:
 *   "On main: custom user message"
 *   "WIP on main: abc1234 commit message"
 */
export interface ParsedStashMessage {
  branch: string | null;
  description: string;
}

export function parseStashMessage(message: string): ParsedStashMessage {
  const match = message.match(/^(?:WIP )?[Oo]n\s+(.+?):\s*(.*)$/);

  if (!match) {
    return { branch: null, description: message || "Stashed changes" };
  }

  const branch = match[1];
  let description = match[2].trim();

  // Default WIP messages look like "abc1234 commit msg" — extract after hash
  const wipMatch = description.match(/^[0-9a-f]{7,40}\s+(.+)$/);
  if (wipMatch) {
    description = wipMatch[1];
  }

  if (!description) {
    description = "Stashed changes";
  }

  return { branch, description };
}
```

2. Update `src/components/stash/StashItem.tsx`:
   - Add import: `import { parseStashMessage } from "../../lib/stash-utils";`
   - Inside the component, compute: `const parsed = parseStashMessage(stash.message);`
   - Replace the display area (the div containing stash@{N} and message) with:
     ```tsx
     <div className="min-w-0">
       <p className="truncate text-sm text-ctp-text">{parsed.description}</p>
       <span className="text-xs text-ctp-overlay0">
         stash@{"{" + stash.index + "}"}
         {parsed.branch && (
           <span className="ml-1 text-ctp-overlay1">on {parsed.branch}</span>
         )}
       </span>
     </div>
     ```
     This makes parsed description the primary line and demotes stash@{N} + branch to secondary.
  </action>
  <verify>
Run `grep -n "parseStashMessage" src/lib/stash-utils.ts src/components/stash/StashItem.tsx` — should show export and import+usage.
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — no new TypeScript errors.
  </verify>
  <done>Stash entries show human-friendly parsed description as primary text, with stash@{N} and branch name as secondary metadata below.</done>
</task>

<task type="auto">
  <name>Task 2: Diff header split, blade reset on repo switch, and topology verification</name>
  <files>src/components/blades/DiffBlade.tsx, src/components/Header.tsx</files>
  <action>
Three small fixes in two files, plus topology verification.

**UIPX-05: Diff blade header path/filename split**

In `src/components/blades/DiffBlade.tsx`, replace the toolbar file path display from:
```tsx
<span className="text-sm text-ctp-subtext1 truncate flex-1">
  {source.filePath}
</span>
```
To:
```tsx
<span className="text-sm truncate flex-1">
  {(() => {
    const lastSlash = source.filePath.lastIndexOf("/");
    if (lastSlash === -1) {
      return <span className="font-semibold text-ctp-text">{source.filePath}</span>;
    }
    return (
      <>
        <span className="text-ctp-overlay1">{source.filePath.slice(0, lastSlash + 1)}</span>
        <span className="font-semibold text-ctp-text">{source.filePath.slice(lastSlash + 1)}</span>
      </>
    );
  })()}
</span>
```

**NAVG-01: Blade reset on repo switch**

In `src/components/Header.tsx`:
1. Add import: `import { useBladeStore } from "../stores/blades";`
2. Inside `handleRepoSwitch`, add `useBladeStore.getState().resetStack();` right after `await openRepository(path);` succeeds, BEFORE `await addRecentRepo(path);`.

**TOPO-01: Topology branch ordering verification**

The topology branch ordering is ALREADY correctly implemented:
- `LaneHeader.tsx` has `BRANCH_TYPE_ORDER` (main=0, develop=1, feature=4)
- `graph.rs` sorts refs by Gitflow priority before lane assignment

No code changes needed. Verify with:
```bash
grep -n "BRANCH_TYPE_ORDER" src/components/topology/LaneHeader.tsx
```
  </action>
  <verify>
Run `grep -n "font-semibold\|lastIndexOf" src/components/blades/DiffBlade.tsx` — should show split path/filename.
Run `grep -n "resetStack\|useBladeStore" src/components/Header.tsx` — should show import and resetStack call.
Run `grep -n "BRANCH_TYPE_ORDER" src/components/topology/LaneHeader.tsx` — should confirm ordering exists.
Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts"` — no new TypeScript errors.
  </verify>
  <done>
1. Diff header shows directory path in gray + filename in bold on one line (UIPX-05)
2. Blade stack resets when switching repositories (NAVG-01)
3. Topology branch labels confirmed to display main/develop before feature branches (TOPO-01 — already working)
  </done>
</task>

</tasks>

<verification>
- Stash entries show descriptive text instead of raw stash@{N} as primary label
- Diff blade toolbar shows directory path in gray and filename in bold
- Switching repos clears the blade stack, no stale content persists
- Topology lane header shows main/master labels before develop before feature branches
- No TypeScript compilation errors introduced
</verification>

<success_criteria>
1. Stash entries display a descriptive label instead of raw stash@{0} identifiers (STSH-01)
2. Diff blade header shows path in gray + filename in bold as a single merged line (UIPX-05)
3. Switching to a different repository causes the blade view to reset (NAVG-01)
4. Main/master and dev/develop branch labels appear before feature branches (TOPO-01 — verified existing)
5. No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/16-quick-fixes-visual-polish/16-03-SUMMARY.md`
</output>
