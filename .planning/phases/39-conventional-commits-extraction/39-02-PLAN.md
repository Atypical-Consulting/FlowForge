---
phase: 39-conventional-commits-extraction
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - src/hooks/useCommitExecution.ts
  - src/commands/toolbar-actions.ts
  - src/commands/repository.ts
  - src/extensions/conventional-commits/index.ts
autonomous: true

must_haves:
  truths:
    - "useCommitExecution calls emitWill('commit') before creating the commit, allowing pre-commit hooks to cancel"
    - "If a pre-commit hook cancels the commit, a warning toast is shown and no commit is created"
    - "The changelog toolbar button and command palette entry are contributed by the CC extension, not core"
    - "Disabling the CC extension removes the changelog toolbar button and command from the palette"
    - "The CC extension registers an open-conventional-commit command via ExtensionAPI"
  artifacts:
    - path: "src/hooks/useCommitExecution.ts"
      provides: "Pre-commit hook infrastructure via emitWill"
      contains: "emitWill"
    - path: "src/extensions/conventional-commits/index.ts"
      provides: "Toolbar and command contributions for changelog and CC blade"
      contains: "contributeToolbar"
    - path: "src/commands/toolbar-actions.ts"
      provides: "Core toolbar actions without changelog entry"
    - path: "src/commands/repository.ts"
      provides: "Core repository commands without generate-changelog entry"
  key_links:
    - from: "src/hooks/useCommitExecution.ts"
      to: "src/lib/gitHookBus.ts"
      via: "emitWill('commit') call before createCommit"
      pattern: "emitWill.*commit"
    - from: "src/extensions/conventional-commits/index.ts"
      to: "src/lib/bladeOpener.ts"
      via: "openBlade call in toolbar execute and command action"
      pattern: "openBlade.*changelog"
---

<objective>
Wire emitWill("commit") infrastructure into useCommitExecution, move changelog toolbar and command registrations to the CC extension, and clean up core.

Purpose: This plan adds pre-commit hook infrastructure so extensions can intercept commits via GitHookBus (satisfying success criteria #2), moves the changelog toolbar button and command palette entry from core to the CC extension (satisfying CCEX-04), and removes CC-specific registrations from core command files. The CC extension now owns all CC-related UI contributions.

Output: useCommitExecution with emitWill pre-commit hook, CC extension with toolbar and command contributions, core commands cleaned of CC-specific entries.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-conventional-commits-extraction/39-RESEARCH.md
@.planning/phases/39-conventional-commits-extraction/39-01-SUMMARY.md

@src/hooks/useCommitExecution.ts
@src/lib/gitHookBus.ts
@src/commands/toolbar-actions.ts
@src/commands/repository.ts
@src/extensions/conventional-commits/index.ts
@src/extensions/ExtensionAPI.ts
@src/extensions/github/index.ts
@src/lib/bladeOpener.ts
@src/stores/repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire emitWill("commit") into useCommitExecution</name>
  <files>
    src/hooks/useCommitExecution.ts
  </files>
  <action>
    **1. Add emitWill pre-commit hook to the commit flow in `src/hooks/useCommitExecution.ts`:**

    Currently `useCommitExecution` directly calls `commands.createCommit()` in the mutation function. We need to add a pre-commit hook check using `gitHookBus.emitWill("commit")` BEFORE the commit is created. This enables the CC extension (and any future extension) to validate or cancel commits.

    Modify the `commit` function to call `emitWill` before the mutation:

    ```typescript
    const commit = async (message: string, amend = false) => {
      // Pre-commit validation via GitHookBus
      const willResult = await gitHookBus.emitWill("commit", { commitMessage: message });
      if (willResult.cancel) {
        toast.warning(willResult.reason ?? "Commit cancelled by extension");
        return;
      }
      await commitMutation.mutateAsync({ message, amend });
    };
    ```

    Do the same for the `commitAndPush` function -- the emitWill check should happen before the commit mutation:

    ```typescript
    const commitAndPush = async (message: string, amend = false) => {
      // Pre-commit validation via GitHookBus
      const willResult = await gitHookBus.emitWill("commit", { commitMessage: message });
      if (willResult.cancel) {
        toast.warning(willResult.reason ?? "Commit cancelled by extension");
        return;
      }
      await commitMutation.mutateAsync({ message, amend });
      await pushMutation.mutateAsync();
    };
    ```

    **Important:** The `toast` import already exists from `../stores/toast`. The `gitHookBus` import already exists from `../lib/gitHookBus`. No new imports needed.

    **Note:** In this phase, no extension actually registers a `onWillGit("commit")` handler. This is infrastructure preparation -- the hook bus is wired but no handlers cancel commits. The CC form already validates via `canCommit` flag, so CC validation does not use onWillCommit. A future phase can add an optional "enforce CC format" handler.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no new TypeScript errors.
    Run `npx vitest run` -- all existing tests pass.
    Verify `grep "emitWill" src/hooks/useCommitExecution.ts` shows the pre-commit hook calls.
  </verify>
  <done>
    useCommitExecution calls `gitHookBus.emitWill("commit")` before creating commits in both `commit()` and `commitAndPush()`. If a pre-commit handler cancels, a warning toast is shown and no commit is created. This is infrastructure only -- no handler is registered yet.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move changelog toolbar and commands to CC extension, clean core</name>
  <files>
    src/extensions/conventional-commits/index.ts
    src/commands/toolbar-actions.ts
    src/commands/repository.ts
  </files>
  <action>
    **1. Add toolbar and command contributions to the CC extension `onActivate` in `src/extensions/conventional-commits/index.ts`:**

    Add the necessary imports at the top of the file:
    ```typescript
    import { FileText } from "lucide-react";
    import { openBlade } from "../../lib/bladeOpener";
    import { useRepositoryStore } from "../../stores/repository";
    ```

    After the two `api.registerBlade()` calls, add toolbar and command registrations:

    ```typescript
    // Contribute toolbar action for changelog
    api.contributeToolbar({
      id: "changelog",
      label: "Changelog",
      icon: FileText,
      group: "views",
      priority: 30,
      when: () => !!useRepositoryStore.getState().repoStatus,
      execute: () => {
        openBlade("changelog", {} as Record<string, never>);
      },
    });

    // Register command palette entries
    api.registerCommand({
      id: "generate-changelog",
      title: "Generate Changelog",
      description: "Generate a changelog from conventional commits",
      category: "Repository",
      icon: FileText,
      action: () => {
        openBlade("changelog", {} as Record<string, never>);
      },
      enabled: () => !!useRepositoryStore.getState().repoStatus,
    });

    api.registerCommand({
      id: "open-conventional-commit",
      title: "Open Conventional Commit Composer",
      category: "Repository",
      action: () => {
        openBlade("conventional-commit", {} as Record<string, never>);
      },
      enabled: () => !!useRepositoryStore.getState().repoStatus,
    });
    ```

    **2. Remove the `tb:changelog` toolbar action from `src/commands/toolbar-actions.ts`:**

    Remove the entire `tb:changelog` object from the `coreActions` array (the block starting with `id: "tb:changelog"` and ending with the closing `},`). This is around lines 282-293 in the current file.

    Also remove the `FileText` import from `lucide-react` at the top of the file IF it is no longer used by any other action. Check: `FileText` is only used by the `tb:changelog` action, so remove it from the import list.

    **3. Remove the `generate-changelog` command from `src/commands/repository.ts`:**

    Remove the entire `registerCommand` block for `generate-changelog` (lines 50-60 in the current file):
    ```typescript
    registerCommand({
      id: "generate-changelog",
      title: "Generate Changelog",
      description: "Generate a changelog from commits",
      category: "Repository",
      icon: FileText,
      action: () => {
        openBlade("changelog", {} as Record<string, never>);
      },
      enabled: () => !!useRepositoryStore.getState().repoStatus,
    });
    ```

    Also remove the `FileText` import from `lucide-react` at the top IF it is no longer used. Check: after removing the changelog command, `FileText` is only used by the changelog entry, so remove it from the import. Also remove the `openBlade` import IF no other command uses it. Check: no other commands in repository.ts use `openBlade`, so remove it.

    Update the import statement to only include the icons still used:
    ```typescript
    import {
      FolderOpen,
      GitFork,
      RefreshCw,
      X,
    } from "lucide-react";
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no new TypeScript errors.
    Run `npx vitest run` -- all existing tests pass.
    Verify `grep "tb:changelog" src/commands/toolbar-actions.ts` returns no results (removed).
    Verify `grep "generate-changelog" src/commands/repository.ts` returns no results (removed).
    Verify `grep "contributeToolbar" src/extensions/conventional-commits/index.ts` shows the changelog toolbar registration.
    Verify `grep "registerCommand" src/extensions/conventional-commits/index.ts` shows both command registrations.
  </verify>
  <done>
    The CC extension now registers the changelog toolbar action and both command palette entries (generate-changelog, open-conventional-commit). Core toolbar-actions.ts no longer has tb:changelog. Core repository.ts no longer has generate-changelog. Disabling the CC extension removes these contributions via api.cleanup().
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignore pre-existing TS2440 in bindings.ts)
2. `npx vitest run` -- full test suite passes
3. `grep "emitWill" src/hooks/useCommitExecution.ts` -- shows pre-commit hook calls
4. `grep "tb:changelog" src/commands/toolbar-actions.ts` -- returns no results (removed)
5. `grep "generate-changelog" src/commands/repository.ts` -- returns no results (removed)
6. `grep "contributeToolbar" src/extensions/conventional-commits/index.ts` -- shows changelog toolbar
7. `grep "registerCommand" src/extensions/conventional-commits/index.ts` -- shows command registrations
8. `grep "openBlade" src/extensions/conventional-commits/index.ts` -- shows blade-opening actions
9. `grep "FileText" src/commands/toolbar-actions.ts` -- returns no results (import removed)
</verification>

<success_criteria>
- useCommitExecution calls emitWill("commit") before creating commits
- Pre-commit hook cancellation shows warning toast and prevents commit
- commitAndPush also calls emitWill before commit step
- CC extension contributes changelog toolbar action via api.contributeToolbar()
- CC extension contributes generate-changelog command via api.registerCommand()
- CC extension contributes open-conventional-commit command via api.registerCommand()
- Core toolbar-actions.ts no longer contains tb:changelog
- Core repository.ts no longer contains generate-changelog
- Disabling the CC extension removes toolbar and command contributions
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/39-conventional-commits-extraction/39-02-SUMMARY.md`
</output>
