---
phase: 39-conventional-commits-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/conventional-commits/index.ts
  - src/App.tsx
  - src/blades/conventional-commit/registration.ts
  - src/blades/changelog/registration.ts
  - src/blades/_discovery.ts
  - src/components/commit/CommitForm.tsx
autonomous: true

must_haves:
  truths:
    - "The conventional-commits built-in extension registers blade types 'conventional-commit' and 'changelog' via coreOverride"
    - "CommitForm.tsx hides the 'Conventional Commits' toggle checkbox and expand button when the CC extension is disabled"
    - "CommitForm.tsx auto-resets useConventional to false when the CC extension becomes inactive"
    - "Disabling the CC extension leaves the simple textarea commit form fully functional"
    - "Re-enabling the CC extension restores the CC toggle checkbox in CommitForm"
    - "Old registration.ts files for conventional-commit and changelog blades are deleted"
  artifacts:
    - path: "src/extensions/conventional-commits/index.ts"
      provides: "Conventional commits built-in extension entry point"
      exports: ["onActivate", "onDeactivate"]
    - path: "src/App.tsx"
      provides: "registerBuiltIn call for conventional-commits extension"
      contains: "conventional-commits"
    - path: "src/components/commit/CommitForm.tsx"
      provides: "Conditional CC toggle gated by extension status"
      contains: "conventional-commits"
  key_links:
    - from: "src/extensions/conventional-commits/index.ts"
      to: "src/blades/conventional-commit/ConventionalCommitBlade.tsx"
      via: "React.lazy dynamic import"
      pattern: "import.*ConventionalCommitBlade"
    - from: "src/extensions/conventional-commits/index.ts"
      to: "src/blades/changelog/ChangelogBlade.tsx"
      via: "React.lazy dynamic import"
      pattern: "import.*ChangelogBlade"
    - from: "src/App.tsx"
      to: "src/extensions/conventional-commits/index.ts"
      via: "registerBuiltIn call in useEffect"
      pattern: "registerBuiltIn.*conventional-commits"
    - from: "src/components/commit/CommitForm.tsx"
      to: "src/extensions/index.ts"
      via: "useExtensionHost to check CC extension status"
      pattern: "useExtensionHost"
---

<objective>
Create the conventional-commits built-in extension, wire it into App.tsx, remove old blade registrations, and gate CommitForm CC toggle on extension status.

Purpose: This plan moves the conventional-commit and changelog blade registrations from core side-effect files into a single toggleable built-in extension. The CommitForm component becomes extension-aware: when the CC extension is active, it shows the CC toggle and inline form; when disabled, only the simple textarea remains. Component files stay in their current locations -- only registrations move.

Output: Working conventional-commits extension registered via registerBuiltIn(), old registration.ts files deleted, CommitForm conditionally renders CC toggle based on extension status.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-conventional-commits-extraction/39-RESEARCH.md

@src/extensions/ExtensionAPI.ts
@src/extensions/ExtensionHost.ts
@src/extensions/content-viewers/index.ts
@src/extensions/github/index.ts
@src/extensions/index.ts
@src/App.tsx
@src/lib/bladeRegistry.ts
@src/blades/conventional-commit/registration.ts
@src/blades/conventional-commit/ConventionalCommitBlade.tsx
@src/blades/changelog/registration.ts
@src/blades/changelog/ChangelogBlade.tsx
@src/blades/_discovery.ts
@src/components/commit/CommitForm.tsx
@src/components/commit/ConventionalCommitForm.tsx
@src/stores/bladeTypes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conventional-commits extension and register in App.tsx</name>
  <files>
    src/extensions/conventional-commits/index.ts
    src/App.tsx
    src/blades/conventional-commit/registration.ts
    src/blades/changelog/registration.ts
    src/blades/_discovery.ts
  </files>
  <action>
    **1. Create `src/extensions/conventional-commits/index.ts`:**

    Follow the content-viewers extension pattern exactly. Use `React.lazy()` for lazy component loading. Register both blade types with `coreOverride: true` to preserve existing blade type names.

    ```typescript
    import { lazy } from "react";
    import type { ExtensionAPI } from "../ExtensionAPI";

    export async function onActivate(api: ExtensionAPI): Promise<void> {
      // Lazy component imports -- loaded on first blade render, not during activation
      const ConventionalCommitBlade = lazy(() =>
        import("../../blades/conventional-commit/ConventionalCommitBlade").then((m) => ({
          default: m.ConventionalCommitBlade,
        }))
      );
      const ChangelogBlade = lazy(() =>
        import("../../blades/changelog/ChangelogBlade").then((m) => ({
          default: m.ChangelogBlade,
        }))
      );

      // Register blade types with coreOverride to preserve existing blade type names
      api.registerBlade({
        type: "conventional-commit",
        title: "Conventional Commit",
        component: ConventionalCommitBlade,
        lazy: true,
        singleton: true,
        coreOverride: true,
      });

      api.registerBlade({
        type: "changelog",
        title: "Generate Changelog",
        component: ChangelogBlade,
        lazy: true,
        singleton: true,
        coreOverride: true,
      });
    }

    export function onDeactivate(): void {
      // No custom cleanup needed -- api.cleanup() handles all blade unregistrations
    }
    ```

    Notes:
    - Use `coreOverride: true` on BOTH blades so types remain `conventional-commit` and `changelog` (no ext: prefix). This prevents cascading changes to CommitForm.tsx, navigation guards, and BladePropsMap.
    - Use `lazy: true` to tell BladeRenderer to wrap in Suspense for loading fallback.
    - Keep both `singleton: true` -- matching the original registrations.
    - Component files stay in `src/blades/conventional-commit/` and `src/blades/changelog/` -- the extension dynamically imports them.

    **2. Register in `src/App.tsx`:**

    Add import at top (near the content-viewers and GitHub imports):
    ```typescript
    import { onActivate as ccActivate, onDeactivate as ccDeactivate } from "./extensions/conventional-commits";
    ```

    In the `useEffect` that registers built-in extensions, add the conventional-commits registration AFTER content-viewers but BEFORE GitHub:

    ```typescript
    registerBuiltIn({
      id: "conventional-commits",
      name: "Conventional Commits",
      version: "1.0.0",
      activate: ccActivate,
      deactivate: ccDeactivate,
    });
    ```

    **3. Delete the old registration.ts files:**

    Delete the following files (they are now replaced by the extension's onActivate):
    - `src/blades/conventional-commit/registration.ts`
    - `src/blades/changelog/registration.ts`

    Keep the blade component files (ConventionalCommitBlade.tsx, ChangelogBlade.tsx) and their index.ts barrels in place. The extension dynamically imports them.

    **4. Update `src/blades/_discovery.ts` EXPECTED_TYPES:**

    Remove `"conventional-commit"` and `"changelog"` from the EXPECTED_TYPES array. These blade types are now registered by the extension (during activation), not by the eager import.meta.glob scan.

    The EXPECTED_TYPES array should become:
    ```typescript
    const EXPECTED_TYPES: string[] = [
      "staging-changes", "topology-graph", "commit-details", "diff",
      "viewer-nupkg", "viewer-image", "viewer-plaintext", "repo-browser", "settings",
      "gitflow-cheatsheet", "init-repo", "extension-manager",
    ];
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no new TypeScript errors (pre-existing TS2440 in bindings.ts is expected).
    Verify the two old registration.ts files are deleted: `ls src/blades/conventional-commit/registration.ts` and `ls src/blades/changelog/registration.ts` should fail.
    Verify `grep "conventional-commit" src/blades/_discovery.ts` returns no results (removed from EXPECTED_TYPES).
    Verify `grep "conventional-commits" src/App.tsx` shows the registerBuiltIn call.
  </verify>
  <done>
    Conventional-commits extension exists at `src/extensions/conventional-commits/index.ts`. It registers conventional-commit and changelog blade types with coreOverride. Old registration.ts files are deleted. Extension is registered in App.tsx. _discovery.ts no longer expects the two extracted types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Gate CommitForm CC toggle on extension status</name>
  <files>
    src/components/commit/CommitForm.tsx
  </files>
  <action>
    **1. Add extension status check to `CommitForm.tsx`:**

    Add import for `useExtensionHost` at the top of the file:
    ```typescript
    import { useExtensionHost } from "../../extensions";
    ```

    Inside the `CommitForm` function body, add a reactive check for the CC extension status:
    ```typescript
    const isCCActive = useExtensionHost(
      (s) => s.extensions.get("conventional-commits")?.status === "active"
    );
    ```

    **2. Add auto-reset effect:**

    Add a `useEffect` that resets `useConventional` to false when the extension is disabled:
    ```typescript
    useEffect(() => {
      if (!isCCActive && useConventional) {
        setUseConventional(false);
      }
    }, [isCCActive, useConventional]);
    ```

    Place this effect after the existing `useEffect` for the `toggle-amend` event listener.

    **3. Gate the CC toggle UI on extension status:**

    Wrap the CC toggle checkbox and expand button in a conditional on `isCCActive`. Replace the current mode toggle section:

    ```tsx
    {/* Mode toggle */}
    <div className="flex items-center justify-between mb-3">
      <span className="text-sm font-medium text-ctp-subtext1">Commit</span>
      {isCCActive && (
        <div className="flex items-center gap-2">
          <label className="flex items-center gap-2 text-xs text-ctp-overlay1 cursor-pointer">
            <input
              type="checkbox"
              checked={useConventional}
              onChange={(e) => setUseConventional(e.target.checked)}
              className="rounded border-ctp-surface2 bg-ctp-surface0 text-ctp-blue focus:ring-ctp-blue"
            />
            Conventional Commits
          </label>
          {useConventional && !isCCBladeOpen && (
            <button
              type="button"
              onClick={() =>
                openBlade("conventional-commit", {}, "Conventional Commit")
              }
              className="p-1 text-ctp-overlay1 hover:text-ctp-blue rounded"
              title="Open in full-width blade"
            >
              <Maximize2 className="w-4 h-4" />
            </button>
          )}
        </div>
      )}
    </div>
    ```

    The rest of the CommitForm rendering logic remains unchanged. When `isCCActive` is false, `useConventional` will be false (via the effect), so the simple textarea path will always render.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no new TypeScript errors.
    Run `npx vitest run` -- all existing tests pass.
    Verify `grep "useExtensionHost" src/components/commit/CommitForm.tsx` shows the import and usage.
    Verify `grep "isCCActive" src/components/commit/CommitForm.tsx` shows the conditional rendering.
  </verify>
  <done>
    CommitForm conditionally shows the CC toggle checkbox and expand button only when the conventional-commits extension is active. When the extension is disabled, useConventional auto-resets to false and only the simple textarea commit form is shown.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignore pre-existing TS2440 in bindings.ts)
2. `npx vitest run` -- full test suite passes
3. `ls src/blades/conventional-commit/registration.ts` -- file does NOT exist (deleted)
4. `ls src/blades/changelog/registration.ts` -- file does NOT exist (deleted)
5. `grep "conventional-commits" src/App.tsx` -- shows registerBuiltIn call
6. `grep "coreOverride" src/extensions/conventional-commits/index.ts` -- shows true on both registrations
7. `grep "conventional-commit" src/blades/_discovery.ts` -- returns nothing (removed from EXPECTED_TYPES)
8. `grep "changelog" src/blades/_discovery.ts` -- returns nothing (removed from EXPECTED_TYPES)
9. `grep "useExtensionHost" src/components/commit/CommitForm.tsx` -- shows extension status check
10. `grep "isCCActive" src/components/commit/CommitForm.tsx` -- shows conditional rendering
</verification>

<success_criteria>
- conventional-commits extension at src/extensions/conventional-commits/index.ts registers conventional-commit and changelog blade types
- Both registrations use coreOverride: true to preserve original blade type names
- Both registrations use React.lazy() and lazy: true for on-demand loading
- Old registration.ts files deleted from src/blades/conventional-commit/ and src/blades/changelog/
- Blade component files (.tsx) remain in their original locations (dynamic import)
- Extension registered in App.tsx alongside content-viewers and github
- _discovery.ts EXPECTED_TYPES no longer includes the two extracted types
- CommitForm shows CC toggle only when conventional-commits extension is active
- CommitForm auto-resets useConventional to false when extension is disabled
- Simple textarea commit form works regardless of extension state
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/39-conventional-commits-extraction/39-01-SUMMARY.md`
</output>
