---
phase: 04-gitflow-state-machine
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - src/components/gitflow/GitflowPanel.tsx
  - src/components/gitflow/StartFlowDialog.tsx
  - src/components/gitflow/FinishFlowDialog.tsx
  - src/components/gitflow/index.ts
  - src/components/RepositoryView.tsx
autonomous: false

must_haves:
  truths:
    - "User sees gitflow panel in repository view"
    - "Start Feature button is disabled when not on develop"
    - "Start Release button is disabled when not on develop or release in progress"
    - "Start Hotfix button is disabled when not on main"
    - "Finish buttons only enabled when on corresponding branch type"
    - "User can complete full feature flow via UI"
  artifacts:
    - path: "src/components/gitflow/GitflowPanel.tsx"
      provides: "Main gitflow control panel"
      min_lines: 50
    - path: "src/components/gitflow/StartFlowDialog.tsx"
      provides: "Dialog for starting feature/release/hotfix"
      min_lines: 40
    - path: "src/components/gitflow/FinishFlowDialog.tsx"
      provides: "Dialog for finishing release/hotfix with tag message"
      min_lines: 30
  key_links:
    - from: "src/components/gitflow/GitflowPanel.tsx"
      to: "src/stores/gitflow.ts"
      via: "useGitflowStore hook"
      pattern: "useGitflowStore"
    - from: "src/components/RepositoryView.tsx"
      to: "src/components/gitflow/GitflowPanel.tsx"
      via: "component import and render"
      pattern: "GitflowPanel"
---

<objective>
Create Gitflow UI components with context-aware button disabling.

Purpose: Enable users to perform Gitflow operations through the UI with clear feedback on what's allowed.
Output: GitflowPanel integrated into RepositoryView with disabled buttons for invalid operations.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-gitflow-state-machine/04-RESEARCH.md
@src/components/RepositoryView.tsx
@src/components/branches/CreateBranchDialog.tsx
@src/components/branches/BranchList.tsx
@src/stores/gitflow.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitflowPanel component</name>
  <files>src/components/gitflow/GitflowPanel.tsx, src/components/gitflow/index.ts</files>
  <action>
1. Create `src/components/gitflow/` directory.

2. Create `src/components/gitflow/GitflowPanel.tsx`:

```tsx
import { GitBranch, Play, Flag, AlertTriangle, X, RefreshCw } from "lucide-react";
import { useEffect, useState } from "react";
import { useGitflowStore } from "../../stores/gitflow";
import { StartFlowDialog } from "./StartFlowDialog";
import { FinishFlowDialog } from "./FinishFlowDialog";

type FlowType = "feature" | "release" | "hotfix";

export function GitflowPanel() {
  const { status, isLoading, error, refresh, abort, clearError } = useGitflowStore();
  const [showStartDialog, setShowStartDialog] = useState<FlowType | null>(null);
  const [showFinishDialog, setShowFinishDialog] = useState<FlowType | null>(null);

  useEffect(() => {
    refresh();
  }, [refresh]);

  if (!status) {
    return (
      <div className="p-4 text-gray-400 text-sm">
        {isLoading ? "Loading gitflow status..." : "No gitflow status available"}
      </div>
    );
  }

  if (!status.isGitflowReady) {
    return (
      <div className="p-4">
        <div className="flex items-center gap-2 text-yellow-500 text-sm mb-2">
          <AlertTriangle className="w-4 h-4" />
          <span>Gitflow not initialized</span>
        </div>
        <p className="text-gray-400 text-xs">
          Repository needs both <code>main</code> and <code>develop</code> branches for Gitflow workflows.
        </p>
      </div>
    );
  }

  return (
    <div className="p-4 space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <GitBranch className="w-4 h-4 text-purple-400" />
          <span className="font-medium">Gitflow</span>
        </div>
        <button
          onClick={() => refresh()}
          disabled={isLoading}
          className="p-1 hover:bg-gray-800 rounded"
          title="Refresh status"
        >
          <RefreshCw className={`w-4 h-4 ${isLoading ? "animate-spin" : ""}`} />
        </button>
      </div>

      {/* Active flow indicator */}
      {status.activeFlow && (
        <div className="bg-purple-900/30 border border-purple-700 rounded p-3">
          <div className="flex items-center justify-between">
            <div>
              <span className="text-purple-300 text-xs uppercase">{status.activeFlow.flowType}</span>
              <p className="font-medium">{status.activeFlow.name}</p>
            </div>
            {status.canAbort && (
              <button
                onClick={() => abort()}
                className="p-1 hover:bg-red-900/50 rounded text-red-400"
                title="Abort current flow"
              >
                <X className="w-4 h-4" />
              </button>
            )}
          </div>
        </div>
      )}

      {/* Error display */}
      {error && (
        <div className="bg-red-900/30 border border-red-700 rounded p-3 text-sm">
          <div className="flex items-center justify-between">
            <span className="text-red-300">{error}</span>
            <button onClick={clearError} className="text-red-400 hover:text-red-300">
              <X className="w-4 h-4" />
            </button>
          </div>
        </div>
      )}

      {/* Start buttons */}
      <div className="space-y-2">
        <h4 className="text-xs text-gray-500 uppercase tracking-wider">Start</h4>
        
        <button
          onClick={() => setShowStartDialog("feature")}
          disabled={!status.canStartFeature || isLoading}
          className="w-full flex items-center gap-2 px-3 py-2 text-left rounded hover:bg-gray-800 disabled:opacity-40 disabled:cursor-not-allowed"
          title={!status.canStartFeature ? "Switch to develop branch to start a feature" : undefined}
        >
          <Play className="w-4 h-4 text-green-400" />
          <span>Feature</span>
        </button>

        <button
          onClick={() => setShowStartDialog("release")}
          disabled={!status.canStartRelease || isLoading}
          className="w-full flex items-center gap-2 px-3 py-2 text-left rounded hover:bg-gray-800 disabled:opacity-40 disabled:cursor-not-allowed"
          title={!status.canStartRelease ? "Switch to develop branch (no active release)" : undefined}
        >
          <Flag className="w-4 h-4 text-blue-400" />
          <span>Release</span>
        </button>

        <button
          onClick={() => setShowStartDialog("hotfix")}
          disabled={!status.canStartHotfix || isLoading}
          className="w-full flex items-center gap-2 px-3 py-2 text-left rounded hover:bg-gray-800 disabled:opacity-40 disabled:cursor-not-allowed"
          title={!status.canStartHotfix ? "Switch to main branch to start a hotfix" : undefined}
        >
          <AlertTriangle className="w-4 h-4 text-orange-400" />
          <span>Hotfix</span>
        </button>
      </div>

      {/* Finish buttons */}
      <div className="space-y-2">
        <h4 className="text-xs text-gray-500 uppercase tracking-wider">Finish</h4>
        
        <button
          onClick={() => setShowFinishDialog("feature")}
          disabled={!status.canFinishFeature || isLoading}
          className="w-full flex items-center gap-2 px-3 py-2 text-left rounded hover:bg-gray-800 disabled:opacity-40 disabled:cursor-not-allowed"
        >
          <Play className="w-4 h-4 text-green-400" />
          <span>Finish Feature</span>
        </button>

        <button
          onClick={() => setShowFinishDialog("release")}
          disabled={!status.canFinishRelease || isLoading}
          className="w-full flex items-center gap-2 px-3 py-2 text-left rounded hover:bg-gray-800 disabled:opacity-40 disabled:cursor-not-allowed"
        >
          <Flag className="w-4 h-4 text-blue-400" />
          <span>Finish Release</span>
        </button>

        <button
          onClick={() => setShowFinishDialog("hotfix")}
          disabled={!status.canFinishHotfix || isLoading}
          className="w-full flex items-center gap-2 px-3 py-2 text-left rounded hover:bg-gray-800 disabled:opacity-40 disabled:cursor-not-allowed"
        >
          <AlertTriangle className="w-4 h-4 text-orange-400" />
          <span>Finish Hotfix</span>
        </button>
      </div>

      {/* Dialogs */}
      {showStartDialog && (
        <StartFlowDialog
          flowType={showStartDialog}
          onClose={() => setShowStartDialog(null)}
        />
      )}
      {showFinishDialog && (
        <FinishFlowDialog
          flowType={showFinishDialog}
          onClose={() => setShowFinishDialog(null)}
        />
      )}
    </div>
  );
}
```

3. Create `src/components/gitflow/index.ts`:
```typescript
export { GitflowPanel } from "./GitflowPanel";
export { StartFlowDialog } from "./StartFlowDialog";
export { FinishFlowDialog } from "./FinishFlowDialog";
```
  </action>
  <verify>
   - File exists at src/components/gitflow/GitflowPanel.tsx
   - `npx tsc --noEmit` passes (ignoring missing dialog components for now)
  </verify>
  <done>GitflowPanel component created with context-aware disabled buttons</done>
</task>

<task type="auto">
  <name>Task 2: Create Start and Finish dialog components</name>
  <files>src/components/gitflow/StartFlowDialog.tsx, src/components/gitflow/FinishFlowDialog.tsx</files>
  <action>
1. Create `src/components/gitflow/StartFlowDialog.tsx`:

```tsx
import { X } from "lucide-react";
import { useState } from "react";
import { useGitflowStore } from "../../stores/gitflow";
import { useBranchStore } from "../../stores/branches";

interface StartFlowDialogProps {
  flowType: "feature" | "release" | "hotfix";
  onClose: () => void;
}

const titles = {
  feature: "Start Feature",
  release: "Start Release",
  hotfix: "Start Hotfix",
};

const placeholders = {
  feature: "my-feature-name",
  release: "1.0.0",
  hotfix: "fix-critical-bug",
};

const labels = {
  feature: "Feature name",
  release: "Version",
  hotfix: "Hotfix name",
};

export function StartFlowDialog({ flowType, onClose }: StartFlowDialogProps) {
  const { startFeature, startRelease, startHotfix, isLoading, error } = useGitflowStore();
  const { loadBranches } = useBranchStore();
  const [name, setName] = useState("");

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!name.trim()) return;

    let result: string | null = null;
    switch (flowType) {
      case "feature":
        result = await startFeature(name.trim());
        break;
      case "release":
        result = await startRelease(name.trim());
        break;
      case "hotfix":
        result = await startHotfix(name.trim());
        break;
    }

    if (result) {
      await loadBranches(); // Refresh branch list
      onClose();
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-gray-900 border border-gray-700 rounded-lg p-6 w-96">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold">{titles[flowType]}</h3>
          <button
            type="button"
            onClick={onClose}
            className="p-1 hover:bg-gray-800 rounded"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label
              htmlFor="flow-name"
              className="block text-sm text-gray-400 mb-1"
            >
              {labels[flowType]}
            </label>
            <input
              id="flow-name"
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder={placeholders[flowType]}
              className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:outline-none focus:border-blue-500"
              autoFocus
            />
            <p className="text-xs text-gray-500 mt-1">
              {flowType === "feature" && "Branch will be created as feature/" + (name || "...")}
              {flowType === "release" && "Branch will be created as release/" + (name || "...")}
              {flowType === "hotfix" && "Branch will be created as hotfix/" + (name || "...")}
            </p>
          </div>

          {error && <p className="text-red-400 text-sm">{error}</p>}

          <div className="flex justify-end gap-2">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 text-sm text-gray-400 hover:text-white"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={!name.trim() || isLoading}
              className="px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 rounded disabled:opacity-50"
            >
              {isLoading ? "Starting..." : "Start"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```

2. Create `src/components/gitflow/FinishFlowDialog.tsx`:

```tsx
import { X } from "lucide-react";
import { useState } from "react";
import { useGitflowStore } from "../../stores/gitflow";
import { useBranchStore } from "../../stores/branches";

interface FinishFlowDialogProps {
  flowType: "feature" | "release" | "hotfix";
  onClose: () => void;
}

export function FinishFlowDialog({ flowType, onClose }: FinishFlowDialogProps) {
  const { status, finishFeature, finishRelease, finishHotfix, isLoading, error } = useGitflowStore();
  const { loadBranches } = useBranchStore();
  const [tagMessage, setTagMessage] = useState("");

  const needsTagMessage = flowType === "release" || flowType === "hotfix";
  const flowName = status?.activeFlow?.name || "";

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    let success = false;
    switch (flowType) {
      case "feature":
        success = await finishFeature();
        break;
      case "release":
        success = !!(await finishRelease(tagMessage || undefined));
        break;
      case "hotfix":
        success = !!(await finishHotfix(tagMessage || undefined));
        break;
    }

    if (success) {
      await loadBranches();
      onClose();
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-gray-900 border border-gray-700 rounded-lg p-6 w-96">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold">
            Finish {flowType.charAt(0).toUpperCase() + flowType.slice(1)}
          </h3>
          <button
            type="button"
            onClick={onClose}
            className="p-1 hover:bg-gray-800 rounded"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <p className="text-sm text-gray-400">
            {flowType === "feature" && (
              <>Merge <code className="text-blue-400">feature/{flowName}</code> into develop</>
            )}
            {flowType === "release" && (
              <>Merge <code className="text-blue-400">release/{flowName}</code> into main and develop, create tag</>
            )}
            {flowType === "hotfix" && (
              <>Merge <code className="text-blue-400">hotfix/{flowName}</code> into main and develop, create tag</>
            )}
          </p>

          {needsTagMessage && (
            <div>
              <label
                htmlFor="tag-message"
                className="block text-sm text-gray-400 mb-1"
              >
                Tag message (optional)
              </label>
              <input
                id="tag-message"
                type="text"
                value={tagMessage}
                onChange={(e) => setTagMessage(e.target.value)}
                placeholder={flowType === "release" ? `Release ${flowName}` : `Hotfix ${flowName}`}
                className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:outline-none focus:border-blue-500"
              />
            </div>
          )}

          {error && <p className="text-red-400 text-sm">{error}</p>}

          <div className="flex justify-end gap-2">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 text-sm text-gray-400 hover:text-white"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={isLoading}
              className="px-4 py-2 text-sm bg-green-600 hover:bg-green-700 rounded disabled:opacity-50"
            >
              {isLoading ? "Finishing..." : "Finish"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
   - Both dialog files exist
   - `npx tsc --noEmit` passes
  </verify>
  <done>StartFlowDialog and FinishFlowDialog components created</done>
</task>

<task type="auto">
  <name>Task 3: Integrate GitflowPanel into RepositoryView</name>
  <files>src/components/RepositoryView.tsx</files>
  <action>
1. Add import at top of RepositoryView.tsx:
   ```tsx
   import { GitflowPanel } from "./gitflow";
   ```

2. Add GitflowPanel to the sidebar, after BranchList section. Look for the existing collapsible section pattern and add:

   ```tsx
   {/* Gitflow section */}
   <div className="border-t border-gray-800">
     <GitflowPanel />
   </div>
   ```

   Place this after the Tags or Stash section, as a new collapsible panel in the sidebar.

3. Ensure the gitflow status refreshes when repository changes:
   - If there's a useEffect that runs on repo change, add gitflow refresh
   - Or rely on GitflowPanel's own useEffect for initial load
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - GitflowPanel is rendered in RepositoryView
  </verify>
  <done>GitflowPanel integrated into RepositoryView sidebar</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Gitflow UI with context-aware button disabling</what-built>
  <how-to-verify>
1. Open a Git repository that has both `main` and `develop` branches
2. Switch to `develop` branch
3. Verify "Start Feature" button is enabled, "Start Hotfix" is disabled
4. Click "Start Feature", enter name "test-feature", click Start
5. Verify you're now on `feature/test-feature` branch
6. Verify "Finish Feature" button is now enabled
7. Click "Finish Feature", confirm
8. Verify merged to develop, feature branch deleted
9. Switch to `main` branch
10. Verify "Start Hotfix" is enabled, "Start Feature" is disabled
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] GitflowPanel renders in RepositoryView
- [ ] Buttons disabled/enabled based on current branch context
- [ ] Start dialogs create correct branch names
- [ ] Finish dialogs complete merge and cleanup
- [ ] Branch list refreshes after gitflow operations
</verification>

<success_criteria>
- User sees Gitflow panel in repository view
- Start Feature only enabled on develop
- Start Release only enabled on develop with no active release
- Start Hotfix only enabled on main
- Finish buttons only enabled when on corresponding branch type
- Complete feature flow works: start -> work -> finish
- Release/hotfix flows create tags
</success_criteria>

<output>
After completion, create `.planning/phases/04-gitflow-state-machine/04-05-SUMMARY.md`
</output>
