# Plan: React Flow Components

## Frontmatter

```yaml
phase: 05
plan: 04
type: frontend
wave: 3
depends_on: [05-02]
files_modified:
  - src/components/topology/TopologyPanel.tsx
  - src/components/topology/CommitNode.tsx
  - src/components/topology/CommitEdge.tsx
  - src/components/topology/layoutUtils.ts
  - src/components/topology/index.ts
autonomous: true
must_haves:
  - TopologyPanel renders React Flow graph
  - CommitNode displays commit info with Gitflow colors
  - CommitEdge connects nodes with colored lines
  - Dagre layout positions nodes correctly
  - Pan and zoom controls work
```

## Objective

Build the React Flow components that render the commit graph with custom nodes and edges styled according to Gitflow branch types.

## Tasks

<task id="1">
<title>Create layout utilities</title>
<instructions>
Create `src/components/topology/layoutUtils.ts` with dagre layout helpers:

```typescript
import dagre from '@dagrejs/dagre';
import type { Node, Edge } from '@xyflow/react';
import type { GraphNode, GraphEdge, BranchType } from '@/bindings';

const NODE_WIDTH = 220;
const NODE_HEIGHT = 60;

export function layoutGraph(
  graphNodes: GraphNode[],
  graphEdges: GraphEdge[]
): { nodes: Node[]; edges: Edge[] } {
  const g = new dagre.graphlib.Graph();
  g.setDefaultEdgeLabel(() => ({}));
  g.setGraph({ rankdir: 'TB', nodesep: 50, ranksep: 80 });

  // Add nodes to dagre
  graphNodes.forEach((node) => {
    g.setNode(node.oid, { width: NODE_WIDTH, height: NODE_HEIGHT });
  });

  // Add edges to dagre
  graphEdges.forEach((edge) => {
    g.setEdge(edge.from, edge.to);
  });

  // Run layout
  dagre.layout(g);

  // Convert to React Flow format
  const nodes: Node[] = graphNodes.map((node) => {
    const dagreNode = g.node(node.oid);
    return {
      id: node.oid,
      type: 'commit',
      position: {
        x: dagreNode.x - NODE_WIDTH / 2,
        y: dagreNode.y - NODE_HEIGHT / 2,
      },
      data: {
        ...node,
      },
    };
  });

  const edges: Edge[] = graphEdges.map((edge, i) => {
    // Find source node to get branch type for coloring
    const sourceNode = graphNodes.find((n) => n.oid === edge.from);
    return {
      id: `e-${i}`,
      source: edge.from,
      target: edge.to,
      type: 'gitflow',
      data: {
        branchType: sourceNode?.branch_type || 'Other',
      },
    };
  });

  return { nodes, edges };
}

// Gitflow color mapping (per success criteria)
export const GITFLOW_COLORS: Record<BranchType, string> = {
  Main: '#f97316',      // orange-500 (red/orange per success criteria)
  Develop: '#22c55e',   // green-500 (blue/green per success criteria)
  Feature: '#3b82f6',   // blue-500
  Release: '#a855f7',   // purple-500
  Hotfix: '#ef4444',    // red-500
  Other: '#6b7280',     // gray-500
};

export function getBranchColor(branchType: BranchType): string {
  return GITFLOW_COLORS[branchType] || GITFLOW_COLORS.Other;
}
```
</instructions>
</task>

<task id="2">
<title>Create CommitNode component</title>
<instructions>
Create `src/components/topology/CommitNode.tsx`:

```typescript
import { memo } from 'react';
import { Handle, Position, type NodeProps } from '@xyflow/react';
import { cn } from '@/lib/utils';
import type { GraphNode, BranchType } from '@/bindings';
import { getBranchColor } from './layoutUtils';

const BRANCH_STYLES: Record<BranchType, string> = {
  Main: 'border-orange-500 bg-orange-500/10',
  Develop: 'border-green-500 bg-green-500/10',
  Feature: 'border-blue-500 bg-blue-500/10',
  Release: 'border-purple-500 bg-purple-500/10',
  Hotfix: 'border-red-500 bg-red-500/10',
  Other: 'border-gray-500 bg-gray-500/10',
};

interface CommitNodeData extends GraphNode {
  isSelected?: boolean;
  onSelect?: (oid: string) => void;
}

export const CommitNode = memo(({ data }: NodeProps<CommitNodeData>) => {
  const branchStyle = BRANCH_STYLES[data.branch_type] || BRANCH_STYLES.Other;

  return (
    <div
      className={cn(
        'px-3 py-2 rounded-lg border-2 cursor-pointer transition-all',
        'hover:shadow-lg',
        branchStyle,
        data.isSelected && 'ring-2 ring-offset-2 ring-offset-background'
      )}
      onClick={() => data.onSelect?.(data.oid)}
    >
      <Handle type="target" position={Position.Top} className="!bg-muted-foreground" />
      
      <div className="flex items-center gap-2 mb-1">
        <span className="text-xs font-mono text-muted-foreground">
          {data.short_oid}
        </span>
        {data.branch_names.length > 0 && (
          <span className="text-xs px-1.5 py-0.5 rounded bg-muted">
            {data.branch_names[0]}
          </span>
        )}
      </div>
      
      <div className="text-sm truncate max-w-[180px]" title={data.message}>
        {data.message}
      </div>
      
      <div className="text-xs text-muted-foreground mt-1">
        {data.author}
      </div>
      
      <Handle type="source" position={Position.Bottom} className="!bg-muted-foreground" />
    </div>
  );
});

CommitNode.displayName = 'CommitNode';
```
</instructions>
</task>

<task id="3">
<title>Create CommitEdge component</title>
<instructions>
Create `src/components/topology/CommitEdge.tsx`:

```typescript
import { memo } from 'react';
import { BaseEdge, getSmoothStepPath, type EdgeProps } from '@xyflow/react';
import type { BranchType } from '@/bindings';
import { getBranchColor } from './layoutUtils';

interface CommitEdgeData {
  branchType: BranchType;
}

export const CommitEdge = memo(({
  id,
  sourceX,
  sourceY,
  targetX,
  targetY,
  sourcePosition,
  targetPosition,
  data,
}: EdgeProps<CommitEdgeData>) => {
  const [edgePath] = getSmoothStepPath({
    sourceX,
    sourceY,
    sourcePosition,
    targetX,
    targetY,
    targetPosition,
  });

  const color = getBranchColor(data?.branchType || 'Other');

  return (
    <BaseEdge
      id={id}
      path={edgePath}
      style={{
        stroke: color,
        strokeWidth: 2,
      }}
    />
  );
});

CommitEdge.displayName = 'CommitEdge';
```
</instructions>
</task>

<task id="4">
<title>Create TopologyPanel component</title>
<instructions>
Create `src/components/topology/TopologyPanel.tsx`:

```typescript
import { useMemo, useCallback } from 'react';
import {
  ReactFlow,
  Controls,
  Background,
  BackgroundVariant,
  useNodesState,
  useEdgesState,
  type Node,
  type Edge,
} from '@xyflow/react';
import '@xyflow/react/dist/style.css';

import { useCommitGraph } from '@/hooks/useCommitGraph';
import { layoutGraph } from './layoutUtils';
import { CommitNode } from './CommitNode';
import { CommitEdge } from './CommitEdge';
import { Loader2 } from 'lucide-react';

const nodeTypes = { commit: CommitNode };
const edgeTypes = { gitflow: CommitEdge };

export function TopologyPanel() {
  const {
    nodes: graphNodes,
    edges: graphEdges,
    isLoading,
    error,
    hasMore,
    selectedCommit,
    selectCommit,
    loadMore,
  } = useCommitGraph();

  // Layout nodes using dagre
  const { nodes: layoutedNodes, edges: layoutedEdges } = useMemo(() => {
    if (graphNodes.length === 0) {
      return { nodes: [], edges: [] };
    }
    return layoutGraph(graphNodes, graphEdges);
  }, [graphNodes, graphEdges]);

  // Add selection state and handlers to nodes
  const nodesWithHandlers = useMemo(() => {
    return layoutedNodes.map((node) => ({
      ...node,
      data: {
        ...node.data,
        isSelected: node.id === selectedCommit,
        onSelect: selectCommit,
      },
    }));
  }, [layoutedNodes, selectedCommit, selectCommit]);

  const [nodes, setNodes, onNodesChange] = useNodesState(nodesWithHandlers);
  const [edges, setEdges, onEdgesChange] = useEdgesState(layoutedEdges);

  // Update nodes when data changes
  useMemo(() => {
    setNodes(nodesWithHandlers);
    setEdges(layoutedEdges);
  }, [nodesWithHandlers, layoutedEdges, setNodes, setEdges]);

  if (error) {
    return (
      <div className="flex items-center justify-center h-full text-destructive">
        Error loading commit graph: {error}
      </div>
    );
  }

  if (isLoading && nodes.length === 0) {
    return (
      <div className="flex items-center justify-center h-full">
        <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
      </div>
    );
  }

  return (
    <div className="h-full w-full">
      <ReactFlow
        nodes={nodes}
        edges={edges}
        onNodesChange={onNodesChange}
        onEdgesChange={onEdgesChange}
        nodeTypes={nodeTypes}
        edgeTypes={edgeTypes}
        fitView
        fitViewOptions={{ padding: 0.2 }}
        minZoom={0.1}
        maxZoom={2}
        nodesDraggable={false}
        nodesConnectable={false}
        elementsSelectable={false}
        panOnScroll
        zoomOnScroll
      >
        <Background variant={BackgroundVariant.Dots} gap={20} size={1} />
        <Controls showInteractive={false} />
      </ReactFlow>
      
      {hasMore && (
        <div className="absolute bottom-4 left-1/2 -translate-x-1/2">
          <button
            onClick={loadMore}
            disabled={isLoading}
            className="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 disabled:opacity-50"
          >
            {isLoading ? 'Loading...' : 'Load More'}
          </button>
        </div>
      )}
    </div>
  );
}
```
</instructions>
</task>

<task id="5">
<title>Create index.ts barrel export</title>
<instructions>
Create `src/components/topology/index.ts`:

```typescript
export { TopologyPanel } from './TopologyPanel';
export { CommitNode } from './CommitNode';
export { CommitEdge } from './CommitEdge';
export { layoutGraph, getBranchColor, GITFLOW_COLORS } from './layoutUtils';
```
</instructions>
</task>

## Verification

```bash
# Check directory structure
ls -la src/components/topology/

# TypeScript check
npx tsc --noEmit 2>&1 | grep -i "topology" || echo "No type errors in topology"

# Check React Flow import
grep "@xyflow/react" src/components/topology/TopologyPanel.tsx
```

## Success Criteria

- [ ] topology/ directory created with all components
- [ ] CommitNode renders with Gitflow colors
- [ ] CommitEdge draws colored lines
- [ ] TopologyPanel integrates React Flow
- [ ] Dagre layout positions nodes correctly
- [ ] TypeScript compiles without errors
