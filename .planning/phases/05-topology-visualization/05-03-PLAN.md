# Plan: Topology Store and Data Fetching

## Frontmatter

```yaml
phase: 05
plan: 03
type: frontend
wave: 3
depends_on: [05-02]
files_modified:
  - src/stores/topologyStore.ts
  - src/hooks/useCommitGraph.ts
  - package.json
autonomous: true
must_haves:
  - Zustand store for topology state
  - React hook for fetching commit graph
  - Pagination support (load more)
  - Selected commit tracking
  - Loading and error states
```

## Objective

Create the frontend state management and data fetching layer for the topology visualization. Install required dependencies and build the Zustand store and custom hook.

## Tasks

<task id="1">
<title>Install dependencies</title>
<instructions>
Install the required npm packages for graph visualization:

```bash
npm install @xyflow/react @dagrejs/dagre
npm install -D @types/dagre
```

Verify packages are added to package.json dependencies.
</instructions>
</task>

<task id="2">
<title>Create topology Zustand store</title>
<instructions>
Create `src/stores/topologyStore.ts` following existing store patterns in the codebase.

```typescript
import { create } from 'zustand';
import { commands } from '@/bindings';
import type { CommitGraph, GraphNode, GraphEdge } from '@/bindings';

interface TopologyState {
  // Data
  nodes: GraphNode[];
  edges: GraphEdge[];
  
  // UI State
  selectedCommit: string | null;
  isLoading: boolean;
  error: string | null;
  hasMore: boolean;
  
  // Pagination
  currentLimit: number;
  currentOffset: number;
  
  // Actions
  loadGraph: (path: string) => Promise<void>;
  loadMore: (path: string) => Promise<void>;
  selectCommit: (oid: string | null) => void;
  reset: () => void;
}

const INITIAL_LIMIT = 100;
const LOAD_MORE_AMOUNT = 50;

export const useTopologyStore = create<TopologyState>((set, get) => ({
  nodes: [],
  edges: [],
  selectedCommit: null,
  isLoading: false,
  error: null,
  hasMore: true,
  currentLimit: INITIAL_LIMIT,
  currentOffset: 0,

  loadGraph: async (path: string) => {
    set({ isLoading: true, error: null });
    try {
      const result = await commands.getCommitGraph(path, INITIAL_LIMIT, 0);
      set({
        nodes: result.nodes,
        edges: result.edges,
        isLoading: false,
        hasMore: result.nodes.length === INITIAL_LIMIT,
        currentOffset: result.nodes.length,
      });
    } catch (error) {
      set({ error: String(error), isLoading: false });
    }
  },

  loadMore: async (path: string) => {
    const { currentOffset, nodes, edges, isLoading } = get();
    if (isLoading) return;
    
    set({ isLoading: true });
    try {
      const result = await commands.getCommitGraph(path, LOAD_MORE_AMOUNT, currentOffset);
      set({
        nodes: [...nodes, ...result.nodes],
        edges: [...edges, ...result.edges],
        isLoading: false,
        hasMore: result.nodes.length === LOAD_MORE_AMOUNT,
        currentOffset: currentOffset + result.nodes.length,
      });
    } catch (error) {
      set({ error: String(error), isLoading: false });
    }
  },

  selectCommit: (oid) => set({ selectedCommit: oid }),
  
  reset: () => set({
    nodes: [],
    edges: [],
    selectedCommit: null,
    isLoading: false,
    error: null,
    hasMore: true,
    currentOffset: 0,
  }),
}));
```
</instructions>
</task>

<task id="3">
<title>Create useCommitGraph hook</title>
<instructions>
Create `src/hooks/useCommitGraph.ts` that provides a convenient interface for components:

```typescript
import { useEffect } from 'react';
import { useTopologyStore } from '@/stores/topologyStore';
import { useRepositoryStore } from '@/stores/repositoryStore';

export function useCommitGraph() {
  const repoPath = useRepositoryStore((s) => s.currentPath);
  const { 
    nodes, 
    edges, 
    isLoading, 
    error, 
    hasMore,
    selectedCommit,
    loadGraph, 
    loadMore,
    selectCommit,
    reset,
  } = useTopologyStore();

  // Load graph when repo path changes
  useEffect(() => {
    if (repoPath) {
      loadGraph(repoPath);
    }
    return () => reset();
  }, [repoPath, loadGraph, reset]);

  const handleLoadMore = () => {
    if (repoPath && hasMore && !isLoading) {
      loadMore(repoPath);
    }
  };

  return {
    nodes,
    edges,
    isLoading,
    error,
    hasMore,
    selectedCommit,
    selectCommit,
    loadMore: handleLoadMore,
  };
}
```

Verify the repositoryStore path matches the actual store implementation in the codebase.
</instructions>
</task>

## Verification

```bash
# Check dependencies installed
grep "@xyflow/react" package.json
grep "@dagrejs/dagre" package.json

# Verify store compiles (TypeScript check)
npx tsc --noEmit 2>&1 | grep -i "topologyStore\|useCommitGraph" || echo "No type errors"

# Check files exist
ls -la src/stores/topologyStore.ts
ls -la src/hooks/useCommitGraph.ts
```

## Success Criteria

- [ ] @xyflow/react and @dagrejs/dagre installed
- [ ] topologyStore.ts created with all state and actions
- [ ] useCommitGraph.ts hook created
- [ ] TypeScript compiles without errors
- [ ] Store follows existing patterns in codebase
