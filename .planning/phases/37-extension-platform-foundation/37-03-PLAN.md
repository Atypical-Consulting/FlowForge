---
phase: 37-extension-platform-foundation
plan: 03
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - src/extensions/ExtensionAPI.ts
  - src/extensions/__tests__/ExtensionAPI.test.ts
autonomous: true

must_haves:
  truths:
    - "ExtensionAPI has contributeContextMenu, contributeSidebarPanel, contributeStatusBar methods that namespace IDs and track registrations"
    - "ExtensionAPI has registerGitHook method that subscribes to GitHookBus and tracks unsubscribe functions"
    - "ExtensionAPI has onDispose method that collects cleanup callbacks"
    - "cleanup() removes all contributions from all 7 registries, calls hook unsubscribers, and executes disposables in reverse order"
    - "cleanup() continues executing remaining disposables even when one throws an error"
  artifacts:
    - path: "src/extensions/ExtensionAPI.ts"
      provides: "Extended per-extension API facade with 6 new methods + onDispose"
      exports: ["ExtensionAPI", "ExtensionContextMenuConfig", "ExtensionSidebarPanelConfig", "ExtensionStatusBarConfig", "ExtensionGitHookConfig", "Disposable"]
    - path: "src/extensions/__tests__/ExtensionAPI.test.ts"
      provides: "Tests for new ExtensionAPI methods and onDispose lifecycle"
      min_lines: 100
  key_links:
    - from: "src/extensions/ExtensionAPI.ts"
      to: "src/lib/contextMenuRegistry.ts"
      via: "contributeContextMenu delegates to useContextMenuRegistry.getState().register()"
      pattern: "useContextMenuRegistry\\.getState\\(\\)\\.register"
    - from: "src/extensions/ExtensionAPI.ts"
      to: "src/lib/sidebarPanelRegistry.ts"
      via: "contributeSidebarPanel delegates to useSidebarPanelRegistry.getState().register()"
      pattern: "useSidebarPanelRegistry\\.getState\\(\\)\\.register"
    - from: "src/extensions/ExtensionAPI.ts"
      to: "src/lib/statusBarRegistry.ts"
      via: "contributeStatusBar delegates to useStatusBarRegistry.getState().register()"
      pattern: "useStatusBarRegistry\\.getState\\(\\)\\.register"
    - from: "src/extensions/ExtensionAPI.ts"
      to: "src/lib/gitHookBus.ts"
      via: "registerGitHook calls gitHookBus.onDid/onWill and stores unsubscribe function"
      pattern: "gitHookBus\\.onDid|gitHookBus\\.onWill"
---

<objective>
Expand ExtensionAPI with six new registration methods (contributeContextMenu, contributeSidebarPanel, contributeStatusBar, registerGitHook, onDidGit, onWillGit) and the onDispose lifecycle pattern, completing the extension platform's public API surface.

Purpose: Without these API methods, extensions have no way to contribute to the new registries or register git hooks. This plan bridges the gap between the raw registries (Plan 37-01) and the extension developer experience, providing automatic namespacing, tracking, and cleanup.

Output: Expanded ExtensionAPI class with 6 new methods + onDispose(), updated cleanup() covering all 7 registry types + custom disposables, config type interfaces for extension authors, and comprehensive test coverage.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-extension-platform-foundation/37-01-SUMMARY.md
@src/extensions/ExtensionAPI.ts
@src/lib/toolbarRegistry.ts
@src/lib/contextMenuRegistry.ts
@src/lib/sidebarPanelRegistry.ts
@src/lib/statusBarRegistry.ts
@src/lib/gitHookBus.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand ExtensionAPI with 6 new methods, onDispose, and updated cleanup</name>
  <files>
    src/extensions/ExtensionAPI.ts
  </files>
  <action>
Modify the existing `ExtensionAPI` class to add new registration methods and the dispose pattern. Follow the exact same pattern used by existing methods (registerBlade, registerCommand, contributeToolbar).

**New imports** (add at top):
```
import { useContextMenuRegistry, type ContextMenuLocation, type ContextMenuContext } from "../lib/contextMenuRegistry";
import { useSidebarPanelRegistry } from "../lib/sidebarPanelRegistry";
import { useStatusBarRegistry, type StatusBarAlignment } from "../lib/statusBarRegistry";
import { gitHookBus, type GitOperation, type GitHookContext } from "../lib/gitHookBus";
import type { ComponentType, ReactNode } from "react";
```

**New config type interfaces** (add after existing config interfaces):

`ExtensionContextMenuConfig`: id: string, label: string, icon?: LucideIcon, location: ContextMenuLocation, group?: string, priority?: number, when?: (context: ContextMenuContext) => boolean, execute: (context: ContextMenuContext) => void | Promise<void>.

`ExtensionSidebarPanelConfig`: id: string, title: string, icon: LucideIcon, component: ComponentType<any>, priority?: number (default 50, clamped to 1-69), when?: () => boolean, defaultOpen?: boolean, renderAction?: () => ReactNode.

`ExtensionStatusBarConfig`: id: string, alignment: StatusBarAlignment, priority?: number (default 50, clamped to 1-89), renderCustom: () => ReactNode, when?: () => boolean, execute?: () => void | Promise<void>, tooltip?: string.

`ExtensionGitHookConfig`: operation: GitOperation, handler: (context: GitHookContext) => void | Promise<void>.

`Disposable` type: `(() => void | Promise<void>) | { dispose: () => void | Promise<void> }`.

**New private tracking arrays** (add to class):
```
private registeredContextMenuItems: string[] = [];
private registeredSidebarPanels: string[] = [];
private registeredStatusBarItems: string[] = [];
private gitHookUnsubscribes: (() => void)[] = [];
private disposables: (Disposable)[] = [];
```

**New methods** (follow the exact contributeToolbar pattern: namespace ID, spread config, set source, track):

`contributeContextMenu(config: ExtensionContextMenuConfig): void` — namespace ID to `ext:{extensionId}:{config.id}`, call `useContextMenuRegistry.getState().register({ ...config, id: namespacedId, source: \`ext:${this.extensionId}\` })`, push to tracking array.

`contributeSidebarPanel(config: ExtensionSidebarPanelConfig): void` — namespace ID, clamp priority to range 1-69 using `Math.max(1, Math.min(69, config.priority ?? 50))`, call `useSidebarPanelRegistry.getState().register({ ...config, id: namespacedId, priority: clampedPriority, source: \`ext:${this.extensionId}\` })`, push to tracking array.

`contributeStatusBar(config: ExtensionStatusBarConfig): void` — namespace ID, clamp priority to range 1-89 using `Math.max(1, Math.min(89, config.priority ?? 50))`, call `useStatusBarRegistry.getState().register({ ...config, id: namespacedId, priority: clampedPriority, source: \`ext:${this.extensionId}\` })`, push to tracking array.

`onDidGit(operation: GitOperation, handler: (ctx: GitHookContext) => void | Promise<void>): void` — call `gitHookBus.onDid(operation, handler, \`ext:${this.extensionId}\`)`, push returned unsubscribe function to `gitHookUnsubscribes`.

`onWillGit(operation: GitOperation, handler: (ctx: GitHookContext) => void | Promise<void>): void` — call `gitHookBus.onWill(operation, handler, \`ext:${this.extensionId}\`)`, push returned unsubscribe function to `gitHookUnsubscribes`.

`onDispose(disposable: Disposable): void` — push disposable to `this.disposables` array.

**Updated cleanup() method:**
Keep existing cleanup logic (blades, commands, toolbar) exactly as-is. Add after them:

1. `useContextMenuRegistry.getState().unregisterBySource(\`ext:${this.extensionId}\`)`
2. `useSidebarPanelRegistry.getState().unregisterBySource(\`ext:${this.extensionId}\`)`
3. `useStatusBarRegistry.getState().unregisterBySource(\`ext:${this.extensionId}\`)`
4. `gitHookBus.removeBySource(\`ext:${this.extensionId}\`)`
5. For each unsub in `gitHookUnsubscribes`: call `unsub()` in try/catch
6. For each disposable in `this.disposables` (iterate in REVERSE order, `i = length-1` to `0`): if function, call it; if object with dispose, call dispose(). Wrap each in try/catch, log errors with `console.error` but continue.
7. Reset all new tracking arrays to `[]`.

The order matters: unregister UI first, then hooks, then disposables last (disposables may reference items from prior steps).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm the expanded class compiles. Verify that existing methods (registerBlade, registerCommand, contributeToolbar) remain unchanged. Verify priority clamping logic: sidebar panels clamped to 1-69, status bar items clamped to 1-89.
  </verify>
  <done>
ExtensionAPI has 6 new public methods (contributeContextMenu, contributeSidebarPanel, contributeStatusBar, onDidGit, onWillGit, onDispose) plus updated cleanup() covering all registries and disposables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive tests for ExtensionAPI expansion and onDispose lifecycle</name>
  <files>
    src/extensions/__tests__/ExtensionAPI.test.ts
  </files>
  <action>
Create a test file for the expanded ExtensionAPI. Reset all registries in `beforeEach`.

**Setup:**
- Import `ExtensionAPI` and config types
- Import all registry stores: `useContextMenuRegistry`, `useSidebarPanelRegistry`, `useStatusBarRegistry`
- Import `gitHookBus` (or the class for direct instantiation)
- In `beforeEach`: reset all registries to empty Maps, create a fresh `api = new ExtensionAPI("test-ext")`

**Tests (~10):**

1. **contributeContextMenu registers with namespaced ID and source:**
   - Call `api.contributeContextMenu({ id: "my-item", label: "Test", location: "branch-list", execute: vi.fn() })`
   - Assert `useContextMenuRegistry.getState().items.has("ext:test-ext:my-item")` is true
   - Assert the item's `source` is `"ext:test-ext"`

2. **contributeSidebarPanel registers with namespaced ID and clamped priority:**
   - Call with `priority: 100` (above 69 limit)
   - Assert registered panel has priority clamped to 69
   - Call with `priority: 0` (below 1 limit)
   - Assert registered panel has priority clamped to 1

3. **contributeStatusBar registers with namespaced ID and clamped priority:**
   - Call with `priority: 100` (above 89 limit)
   - Assert registered item has priority clamped to 89

4. **onDidGit registers handler that receives events:**
   - Call `api.onDidGit("commit", handler)`
   - Emit via `gitHookBus.emitDid("commit", { commitMessage: "test" })`
   - Assert handler was called with correct context

5. **onWillGit registers handler that can cancel:**
   - Call `api.onWillGit("commit", () => ({ cancel: true, reason: "blocked" }))`
   - Emit via `gitHookBus.emitWill("commit")`
   - Assert result has `cancel: true`

6. **onDispose collects callbacks:**
   - Register 3 dispose callbacks
   - Call `api.cleanup()`
   - Assert all 3 were called

7. **cleanup removes all contributions from all registries:**
   - Register items in all 6 registries (blade, command, toolbar, context menu, sidebar panel, status bar)
   - Register a git hook handler
   - Call `api.cleanup()`
   - Assert all registries are empty for this source
   - Assert git hook handler no longer fires on emit

8. **onDispose callbacks execute in reverse order:**
   - Register 3 dispose callbacks that push to an order array
   - Call `api.cleanup()`
   - Assert order is [3, 2, 1] (reverse of registration)

9. **cleanup continues after disposable error:**
   - Register fn1, fn2 (throws Error), fn3
   - Call `api.cleanup()`
   - Assert fn1 and fn3 were called despite fn2 throwing
   - Assert console.error was called (spy on it)

10. **cleanup resets all tracking arrays:**
    - Register various items, call cleanup, then register again
    - Assert second cleanup only removes second batch (no double-removal)
  </action>
  <verify>
Run `npx vitest run src/extensions/__tests__/ExtensionAPI.test.ts` and confirm all 10 tests pass.
  </verify>
  <done>
10 tests cover all new ExtensionAPI methods, priority clamping, namespacing, onDispose lifecycle (reverse order, error isolation), and cleanup atomicity across all 7 registry types.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without new errors
2. All 10 ExtensionAPI tests pass
3. Existing ExtensionAPI methods (registerBlade, registerCommand, contributeToolbar) remain unchanged
4. Priority clamping works: sidebar 1-69, status bar 1-89
5. cleanup() covers all 7 registry types (blade, command, toolbar, context menu, sidebar panel, status bar, git hooks) + custom disposables
6. onDispose executes in reverse order with error isolation
7. Namespacing follows existing pattern: `ext:{extensionId}:{config.id}`
8. The GitHub extension (src/extensions/github/index.ts) is NOT modified and continues working unchanged
</verification>

<success_criteria>
- ExtensionAPI has 9 public methods (3 existing + 6 new) plus onDispose
- Config type interfaces exported for extension authors
- Priority clamping prevents extensions from overriding core UI positions
- cleanup() is atomic and error-resilient
- onDispose callbacks fire in reverse registration order
- 10 tests pass covering all new functionality
- Zero breaking changes to existing API surface
</success_criteria>

<output>
After completion, create `.planning/phases/37-extension-platform-foundation/37-03-SUMMARY.md`
</output>
