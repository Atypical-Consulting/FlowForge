---
phase: 37-extension-platform-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/contextMenuRegistry.ts
  - src/lib/sidebarPanelRegistry.ts
  - src/lib/statusBarRegistry.ts
  - src/lib/gitHookBus.ts
  - src/lib/__tests__/contextMenuRegistry.test.ts
  - src/lib/__tests__/sidebarPanelRegistry.test.ts
  - src/lib/__tests__/statusBarRegistry.test.ts
  - src/lib/__tests__/gitHookBus.test.ts
autonomous: true

must_haves:
  truths:
    - "ContextMenuRegistry stores items with source tagging, filters by location and when(), and sorts by group then priority"
    - "SidebarPanelRegistry stores panel configs with priority-based ordering and visibility filtering"
    - "StatusBarRegistry stores items with left/right alignment, priority sorting, and visibility filtering"
    - "GitHookBus delivers onDid events to registered handlers with error isolation and re-entrancy guard"
    - "All four registries support unregisterBySource() for atomic cleanup"
  artifacts:
    - path: "src/lib/contextMenuRegistry.ts"
      provides: "Zustand store for context menu item registration"
      exports: ["useContextMenuRegistry", "ContextMenuLocation", "ContextMenuContext", "ContextMenuItem"]
    - path: "src/lib/sidebarPanelRegistry.ts"
      provides: "Zustand store for sidebar panel registration"
      exports: ["useSidebarPanelRegistry", "SidebarPanelConfig"]
    - path: "src/lib/statusBarRegistry.ts"
      provides: "Zustand store for status bar item registration"
      exports: ["useStatusBarRegistry", "StatusBarItem", "StatusBarAlignment"]
    - path: "src/lib/gitHookBus.ts"
      provides: "Singleton event bus for git operation events"
      exports: ["gitHookBus", "GitOperation", "GitHookContext"]
  key_links:
    - from: "src/lib/contextMenuRegistry.ts"
      to: "zustand"
      via: "create() with devtools middleware"
      pattern: "create<ContextMenuRegistryState>"
    - from: "src/lib/sidebarPanelRegistry.ts"
      to: "zustand"
      via: "create() with devtools middleware"
      pattern: "create<SidebarPanelRegistryState>"
    - from: "src/lib/statusBarRegistry.ts"
      to: "zustand"
      via: "create() with devtools middleware"
      pattern: "create<StatusBarRegistryState>"
---

<objective>
Create the four new registries that form the data layer of the Extension Platform Foundation: ContextMenuRegistry, SidebarPanelRegistry, StatusBarRegistry, and GitHookBus.

Purpose: These registries are the contribution points through which extensions declare UI surfaces and event subscriptions. They must exist before UI components (Plan 37-02) can render from them and before ExtensionAPI (Plan 37-03) can delegate to them.

Output: Four new registry files with full test coverage. Each registry follows the proven `toolbarRegistry.ts` Zustand store pattern (Map-based storage, immutable updates, source tagging, devtools middleware, filtered/sorted accessors). The GitHookBus is a singleton class with typed onDid/onWill handlers, error isolation, and re-entrancy guard.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/toolbarRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContextMenuRegistry, SidebarPanelRegistry, and StatusBarRegistry</name>
  <files>
    src/lib/contextMenuRegistry.ts
    src/lib/sidebarPanelRegistry.ts
    src/lib/statusBarRegistry.ts
  </files>
  <action>
Create three new Zustand stores by copying the exact pattern from `src/lib/toolbarRegistry.ts`:

**contextMenuRegistry.ts** (~100 lines):
- Types: `ContextMenuLocation` union (`"file-tree" | "branch-list" | "commit-list" | "stash-list" | "tag-list" | "diff-hunk" | "blade-tab"`), `ContextMenuContext` interface (location + optional branchName, filePath, commitOid, stashIndex, tagName), `ContextMenuItem` interface (id, label, icon?: LucideIcon, location, group?: string, priority?: number, when?: (ctx) => boolean, execute: (ctx) => void | Promise<void>, source?: string)
- State: `items: Map<string, ContextMenuItem>`, `activeMenu: { items, position: {x,y}, context } | null`
- Methods: `register(item)` — creates new Map with item added. `unregister(id)` — creates new Map with id removed. `unregisterBySource(source)` — filters all items with matching source. `getItemsForLocation(location, context)` — filters by location, applies when() condition, sorts by group alphabetically then by priority descending within group. `showMenu(position, location, context)` — calls getItemsForLocation, sets activeMenu if items found. `hideMenu()` — sets activeMenu to null.
- Wrap in `devtools()` with `name: "context-menu-registry"`, `enabled: import.meta.env.DEV`.

**sidebarPanelRegistry.ts** (~80 lines):
- Types: `SidebarPanelConfig` interface (id, title, icon: LucideIcon, component: ComponentType<any>, priority: number, when?: () => boolean, defaultOpen?: boolean, source?: string, renderAction?: () => ReactNode)
- State: `panels: Map<string, SidebarPanelConfig>`, `visibilityTick: number`
- Methods: `register(panel)` — creates new Map with panel added. `unregister(id)` — creates new Map with id removed. `unregisterBySource(source)` — filters all panels with matching source. `refreshVisibility()` — increments visibilityTick. `getVisiblePanels()` — filters panels where when() is undefined or returns true, sorts by priority descending (higher = first), then alphabetically by id for tiebreaking.
- Wrap in `devtools()` with `name: "sidebar-panel-registry"`, `enabled: import.meta.env.DEV`.

**statusBarRegistry.ts** (~90 lines):
- Types: `StatusBarAlignment` = `"left" | "right"`, `StatusBarItem` interface (id, alignment, priority: number, renderCustom: () => ReactNode, when?: () => boolean, execute?: () => void | Promise<void>, tooltip?: string, source?: string)
- State: `items: Map<string, StatusBarItem>`, `visibilityTick: number`
- Methods: `register(item)` — creates new Map with item added. `unregister(id)` — creates new Map with id removed. `unregisterBySource(source)` — filters all items with matching source. `refreshVisibility()` — increments visibilityTick. `getLeftItems()` — filters items where alignment is "left" and when() passes, sorted by priority descending. `getRightItems()` — same but alignment "right".
- Wrap in `devtools()` with `name: "status-bar-registry"`, `enabled: import.meta.env.DEV`.

All three registries follow toolbarRegistry.ts exactly for Map mutation (always create `new Map(get().items)`, mutate, then `set()`). Use `false` as the second arg to `set()` for replace flag, and a descriptive action string as third arg for devtools.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm the three new files compile without errors. Open each file and verify it follows the toolbarRegistry.ts pattern (Map-based, immutable updates, devtools middleware).
  </verify>
  <done>
Three new Zustand registry stores exist at src/lib/contextMenuRegistry.ts, src/lib/sidebarPanelRegistry.ts, and src/lib/statusBarRegistry.ts with correct types, methods, and devtools integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHookBus and test all four registries</name>
  <files>
    src/lib/gitHookBus.ts
    src/lib/__tests__/contextMenuRegistry.test.ts
    src/lib/__tests__/sidebarPanelRegistry.test.ts
    src/lib/__tests__/statusBarRegistry.test.ts
    src/lib/__tests__/gitHookBus.test.ts
  </files>
  <action>
**gitHookBus.ts** (~80 lines):
Create as a singleton class (NOT Zustand — it is pub/sub, not reactive state).

- Types: `GitOperation` union (`"commit" | "push" | "pull" | "fetch" | "checkout" | "branch-create" | "branch-delete" | "merge" | "stash" | "tag-create"`), `GitHookContext` interface (operation: GitOperation, branchName?, commitOid?, commitMessage?, remoteName?, tagName?, error?: string), `WillHookResult` interface (cancel?: boolean, reason?: string).
- `DidHandler` type = `(ctx: GitHookContext) => void | Promise<void>`
- `WillHandler` type = `(ctx: GitHookContext) => WillHookResult | Promise<WillHookResult | void> | void`
- Internal: `HandlerEntry<H>` = `{ handler: H, priority: number, source: string }`. Two Maps: `didHandlers: Map<GitOperation, Set<HandlerEntry<DidHandler>>>`, `willHandlers: Map<GitOperation, Set<HandlerEntry<WillHandler>>>`. A `reentryDepth: number` counter initialized to 0.
- `onDid(operation, handler, source, priority=0)`: Register a handler entry. Return unsubscribe function that removes the entry from the Set.
- `onWill(operation, handler, source, priority=0)`: Same pattern for will handlers.
- `emitDid(operation, ctx?)`: If `reentryDepth > 0`, return immediately (suppress cascading hooks). Increment reentryDepth. Build full context `{ operation, ...ctx }`. Get handlers for operation. Run ALL handlers in parallel with `Promise.allSettled()`. Each handler is try/catch wrapped — errors logged with `console.error` but do not propagate. Decrement reentryDepth in `finally`.
- `emitWill(operation, ctx?)`: Get will handlers for operation. Sort by priority descending. Run sequentially. If any returns `{ cancel: true }`, return that result immediately. Errors in handlers are logged but do NOT cancel (fail-open). Return `{}` if no cancellation.
- `removeBySource(source)`: Iterate both didHandlers and willHandlers Maps, remove entries where `entry.source === source`.
- Export singleton: `export const gitHookBus = new GitHookBus();`

**Tests** (follow existing test patterns from `src/stores/` tests):

**contextMenuRegistry.test.ts** (~8 tests):
- `beforeEach`: reset registry state `useContextMenuRegistry.setState({ items: new Map(), activeMenu: null })`
- Tests: registers and retrieves item by location; filters by when() condition; sorts by priority descending within group; separates items by group; unregister removes item; unregisterBySource removes all items for source; showMenu populates activeMenu; hideMenu clears activeMenu.

**sidebarPanelRegistry.test.ts** (~6 tests):
- `beforeEach`: reset registry state
- Tests: registers and retrieves panel; getVisiblePanels sorts by priority descending; getVisiblePanels filters by when() condition; unregister removes panel; unregisterBySource removes all panels for source; refreshVisibility increments tick.

**statusBarRegistry.test.ts** (~7 tests):
- `beforeEach`: reset registry state
- Tests: registers item; getLeftItems returns only left-aligned items sorted by priority; getRightItems returns only right-aligned items sorted by priority; filters by when() condition; unregister removes item; unregisterBySource removes all items for source; refreshVisibility increments tick.

**gitHookBus.test.ts** (~8 tests):
- Create a fresh `GitHookBus` instance in beforeEach (do NOT use the singleton — instantiate `new GitHookBus()` or reset the singleton).
- Tests: emitDid fires registered onDid handler with correct context; unsubscribe function removes handler; emitDid isolates handler errors (one throws, other still fires); emitWill runs handlers sequentially by priority; emitWill returns cancel result when handler cancels; emitWill fails open on handler error; removeBySource removes handlers for specific source; re-entrancy guard suppresses nested emitDid calls.

For the re-entrancy test: register a handler that calls `bus.emitDid()` inside itself, verify it does not infinite loop and the nested emit is suppressed. Export the class for testing: `export { GitHookBus }` in addition to the singleton.
  </action>
  <verify>
Run `npx vitest run src/lib/__tests__/contextMenuRegistry.test.ts src/lib/__tests__/sidebarPanelRegistry.test.ts src/lib/__tests__/statusBarRegistry.test.ts src/lib/__tests__/gitHookBus.test.ts` and confirm all tests pass. Expected: ~29 tests passing.
  </verify>
  <done>
GitHookBus singleton exists at src/lib/gitHookBus.ts with typed onDid/onWill handlers, error isolation, and re-entrancy guard. All four registries have comprehensive test coverage with ~29 passing tests.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without new errors (pre-existing TS2440 in bindings.ts is ignored)
2. All ~29 new tests pass via `npx vitest run src/lib/__tests__/`
3. Each registry has `register`, `unregister`, `unregisterBySource` methods with source tagging
4. ContextMenuRegistry has `getItemsForLocation` with when() filtering and group/priority sorting
5. SidebarPanelRegistry has `getVisiblePanels` with priority sorting
6. StatusBarRegistry has `getLeftItems`/`getRightItems` with alignment filtering and priority sorting
7. GitHookBus has `emitDid` (parallel, error-isolated) and `emitWill` (sequential, fail-open, can cancel)
8. GitHookBus re-entrancy guard prevents infinite hook loops
</verification>

<success_criteria>
- Four new registry files exist and compile cleanly
- All registry tests pass (~29 tests)
- No changes to existing files — this plan is purely additive
- Registries are ready for consumption by Plan 37-02 (UI surfaces) and Plan 37-03 (ExtensionAPI expansion)
</success_criteria>

<output>
After completion, create `.planning/phases/37-extension-platform-foundation/37-01-SUMMARY.md`
</output>
