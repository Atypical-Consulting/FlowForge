---
phase: 27-init-repo-blade
plan: 03
type: execute
wave: 2
depends_on: ["27-01", "27-02"]
files_modified:
  - src/stores/bladeTypes.ts
  - src/components/blades/registrations/init-repo.ts
  - src/components/blades/registrations/index.ts
  - src/components/blades/InitRepoBlade.tsx
  - src/hooks/useGitignoreTemplates.ts
  - src/components/init-repo/InitRepoForm.tsx
  - src/components/init-repo/components/TemplatePicker.tsx
  - src/components/init-repo/components/TemplateChips.tsx
  - src/components/init-repo/components/CategoryFilter.tsx
  - src/components/init-repo/components/ProjectDetectionBanner.tsx
autonomous: true

must_haves:
  truths:
    - "User can open the Init Repo blade and see a form with directory path, branch name, .gitignore section, README section, and commit section"
    - "User can search and filter .gitignore templates from the GitHub collection grouped by category"
    - "User can select multiple templates displayed as removable chips"
    - "User receives smart .gitignore recommendations based on auto-detected project type"
    - "User can browse .gitignore templates grouped by category (Languages, Frameworks, Editors/IDEs, OS)"
  artifacts:
    - path: "src/components/blades/InitRepoBlade.tsx"
      provides: "Main Init Repo blade component with SplitPaneLayout"
      exports: ["InitRepoBlade"]
    - path: "src/components/blades/registrations/init-repo.ts"
      provides: "Blade registration for init-repo type"
      contains: "registerBlade"
    - path: "src/hooks/useGitignoreTemplates.ts"
      provides: "React Query hooks for template fetching and project detection"
      exports: ["useGitignoreTemplateList", "useGitignoreTemplateContent", "useProjectDetection"]
    - path: "src/components/init-repo/InitRepoForm.tsx"
      provides: "Left column form with all configuration sections"
      exports: ["InitRepoForm"]
    - path: "src/components/init-repo/components/TemplatePicker.tsx"
      provides: "Inline expandable template picker with search, categories, and multi-select"
      exports: ["TemplatePicker"]
  key_links:
    - from: "src/hooks/useGitignoreTemplates.ts"
      to: "src/bindings.ts"
      via: "commands.listGitignoreTemplates() and commands.getGitignoreTemplate()"
      pattern: "commands\\.listGitignoreTemplates|commands\\.getGitignoreTemplate|commands\\.detectProjectType"
    - from: "src/components/blades/InitRepoBlade.tsx"
      to: "src/components/init-repo/InitRepoForm.tsx"
      via: "SplitPaneLayout primary prop"
      pattern: "SplitPaneLayout"
    - from: "src/components/init-repo/InitRepoForm.tsx"
      to: "src/stores/initRepo.ts"
      via: "useInitRepoStore hook"
      pattern: "useInitRepoStore"
---

<objective>
Build the Init Repo blade shell, React Query hooks, and form UI components: blade registration, template picker with search/categories/multi-select, project detection banner, and collapsible form sections.

Purpose: This is the core UI for the Init Repo feature. The blade, hooks, and form components enable users to configure repository initialization with smart defaults, template browsing, and multi-select composition.

Output: `InitRepoBlade.tsx` with SplitPaneLayout, `useGitignoreTemplates.ts` hooks, `InitRepoForm.tsx` with all sections, `TemplatePicker.tsx`, `TemplateChips.tsx`, `CategoryFilter.tsx`, `ProjectDetectionBanner.tsx`.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-init-repo-blade/27-01-SUMMARY.md
@.planning/phases/27-init-repo-blade/27-02-SUMMARY.md

@src/stores/bladeTypes.ts
@src/components/blades/registrations/settings.ts
@src/components/blades/registrations/index.ts
@src/components/blades/SettingsBlade.tsx
@src/components/layout/SplitPaneLayout.tsx
@src/lib/bladeRegistry.ts
@src/stores/initRepo.ts
@src/lib/gitignoreCategories.ts
@src/hooks/useRepoFile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Blade registration, React Query hooks, and InitRepoBlade shell</name>
  <files>src/stores/bladeTypes.ts, src/components/blades/registrations/init-repo.ts, src/components/blades/registrations/index.ts, src/components/blades/InitRepoBlade.tsx, src/hooks/useGitignoreTemplates.ts</files>
  <action>
1. **BladePropsMap** — Add to `src/stores/bladeTypes.ts`:
   ```typescript
   "init-repo": { directoryPath: string };
   ```

2. **Blade registration** — Create `src/components/blades/registrations/init-repo.ts`:
   ```typescript
   import { registerBlade } from "../../../lib/bladeRegistry";
   import { InitRepoBlade } from "../InitRepoBlade";

   registerBlade<{ directoryPath: string }>({
     type: "init-repo",
     defaultTitle: "Initialize Repository",
     component: InitRepoBlade,
     wrapInPanel: true,
     showBack: true,
     singleton: true,
   });
   ```

3. **EXPECTED_TYPES** — Add `"init-repo"` to the `EXPECTED_TYPES` array in `src/components/blades/registrations/index.ts`.

4. **React Query hooks** — Create `src/hooks/useGitignoreTemplates.ts`:
   ```typescript
   import { useQuery } from "@tanstack/react-query";
   import { commands } from "../bindings";

   export function useGitignoreTemplateList() {
     return useQuery({
       queryKey: ["gitignore-templates"],
       queryFn: async () => {
         const result = await commands.listGitignoreTemplates();
         if (result.status === "error") throw new Error("Failed to load templates");
         return result.data;
       },
       staleTime: Infinity,  // Cache for entire session
       retry: 1,
     });
   }

   export function useGitignoreTemplateContent(name: string | null) {
     return useQuery({
       queryKey: ["gitignore-template-content", name],
       queryFn: async () => {
         if (!name) return null;
         const result = await commands.getGitignoreTemplate(name);
         if (result.status === "error") throw new Error(`Failed to load template: ${name}`);
         return result.data;
       },
       enabled: !!name,
       staleTime: Infinity,
     });
   }

   export function useProjectDetection(path: string | null) {
     return useQuery({
       queryKey: ["project-detection", path],
       queryFn: async () => {
         if (!path) return null;
         const result = await commands.detectProjectType(path);
         if (result.status === "error") return null;
         return result.data;
       },
       enabled: !!path && path.length > 0,
       staleTime: 30_000,  // Re-detect every 30s (path might change)
     });
   }
   ```

5. **InitRepoBlade** — Create `src/components/blades/InitRepoBlade.tsx`:

   Structure:
   - Accept `{ directoryPath }` prop
   - On mount: set `useInitRepoStore.getState().setDirectoryPath(directoryPath)` and derive `readmeName` from folder name
   - On unmount: call `useInitRepoStore.getState().reset()`
   - Call `useProjectDetection(directoryPath)` and when data arrives, call `setDetectedTypes` and pre-select recommended templates via `addTemplate` for each
   - Use `SplitPaneLayout` with `autoSaveId="init-repo-split"`, `primaryDefaultSize={55}`, `primaryMinSize={35}`, `primaryMaxSize={70}`
   - Left panel (`primary`): `<InitRepoForm />`
   - Right panel (`detail`): `<InitRepoPreview />` (placeholder div for now — Plan 04 implements this)
   - The placeholder preview panel should show: "Preview" heading + `activeSection`-based content hint

   ```typescript
   export function InitRepoBlade({ directoryPath }: { directoryPath: string }) {
     // Store hydration on mount
     // Project detection hook
     // SplitPaneLayout with form and preview
   }
   ```
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts" | tail -15` — no errors from new files.
    Verify `"init-repo"` appears in `BladePropsMap` and `EXPECTED_TYPES`.
  </verify>
  <done>
    - `BladePropsMap` has `"init-repo": { directoryPath: string }`
    - Blade is registered as singleton with wrapInPanel: true and showBack: true
    - `"init-repo"` is in EXPECTED_TYPES array
    - 3 React Query hooks exported: useGitignoreTemplateList, useGitignoreTemplateContent, useProjectDetection
    - InitRepoBlade renders SplitPaneLayout with form and placeholder preview
    - Store is hydrated on mount and reset on unmount
  </done>
</task>

<task type="auto">
  <name>Task 2: InitRepoForm with template picker and all form sections</name>
  <files>src/components/init-repo/InitRepoForm.tsx, src/components/init-repo/components/TemplatePicker.tsx, src/components/init-repo/components/TemplateChips.tsx, src/components/init-repo/components/CategoryFilter.tsx, src/components/init-repo/components/ProjectDetectionBanner.tsx</files>
  <action>
1. **InitRepoForm.tsx** — The left column form component:

   Layout: scrollable container with `p-6 space-y-6 overflow-y-auto h-full` styling.

   **Section 1: Core Configuration** (always visible, no collapse)
   - Directory path: read-only display with folder icon (`FolderOpen` from lucide) and path text. Style: `bg-ctp-surface0 border border-ctp-surface1 rounded-lg p-3 text-sm text-ctp-subtext1 font-mono truncate`
   - Branch name: `<input>` with label "Default branch", placeholder "main", value from store `defaultBranch`, onChange calls `setDefaultBranch`. Use Tailwind classes matching existing Input component: `bg-ctp-surface0 border border-ctp-surface1 rounded-md px-3 py-2 text-sm text-ctp-text placeholder:text-ctp-overlay0 focus:outline-none focus:ring-2 focus:ring-ctp-blue/50`
   - If `detectedTypes.length > 0`, show `<ProjectDetectionBanner />`

   **Section 2: .gitignore** (collapsible via a `<details>` element or custom collapse with framer-motion, expanded by default)
   - Section header: `.gitignore Configuration` with FileText icon
   - If templates are selected: show `<TemplateChips />`
   - "Browse templates" button that toggles `isPickerOpen` in store
   - When `isPickerOpen`: render `<TemplatePicker />` inline below the button
   - Use `aria-expanded` on the browse button reflecting picker state

   **Section 3: README.md** (collapsible, collapsed by default)
   - Toggle switch for `readmeEnabled`: use a styled checkbox or custom toggle with label "Generate README.md"
   - When enabled: input for `readmeName` (pre-filled from folder name), textarea for `readmeDescription` (placeholder: "A brief description of this project")
   - Styles consistent with Section 1 inputs

   **Section 4: Initial Commit** (collapsible, collapsed by default)
   - Toggle switch for `commitEnabled` with label "Create initial commit"
   - When enabled: input for `commitMessage` (default: "Initial commit")
   - Subtle hint text: "Commits .gitignore and README.md (if enabled)" in `text-xs text-ctp-subtext0`

   **Action bar** (sticky bottom with `sticky bottom-0 bg-ctp-base border-t border-ctp-surface1 p-4 flex justify-between`):
   - "Cancel" ghost button on the left
   - "Initialize Repository" primary button on the right with loading state
   - Cancel calls `useBladeNavigation().goBack()` and `reset()`
   - Initialize calls the init pipeline (will be wired in Plan 04)
   - For now, Initialize button shows `disabled` state when `isInitializing` is true

2. **TemplatePicker.tsx** — Inline expandable template picker:

   - Search input at top with magnifying glass icon: `Search` from lucide-react
   - Debounce search input 150ms using `useState` + `useEffect` with timeout
   - `<CategoryFilter />` below search for category tabs
   - Template list: `<ul role="listbox" aria-multiselectable="true" aria-label="Gitignore templates">`
   - Each template row: `<li role="option" aria-selected={isSelected}>` with:
     - Checkbox visual (filled blue square if selected, empty if not)
     - Template name text
     - Eye icon button to set `previewingTemplate` (store or local state) — clicking previews in right panel
   - Filter templates by: active category AND search query (case-insensitive substring match)
   - Use `useGitignoreTemplateList()` hook to fetch template list
   - Show skeleton loading state while templates load: 8 rows of `animate-pulse bg-ctp-surface0 rounded h-8`
   - Show "Offline — showing bundled templates" badge when `source === "bundled"` using `bg-ctp-yellow/10 text-ctp-yellow border border-ctp-yellow/30 text-xs px-2 py-1 rounded`
   - "Done — N selected" button at bottom to close picker
   - Max height: `max-h-80 overflow-y-auto` for the template list
   - Keyboard: ArrowUp/ArrowDown navigate list, Space toggles selection, Enter toggles + previews

3. **TemplateChips.tsx** — Selected template chip display:

   - Horizontal flex wrap container: `flex flex-wrap gap-2`
   - Each chip: `inline-flex items-center gap-1 px-2 py-1 text-sm rounded-md bg-ctp-blue/20 text-ctp-blue border border-ctp-blue/30`
   - Remove button: `X` icon with `hover:bg-ctp-red/20 rounded p-0.5` and `aria-label="Remove {name} template"`
   - "Clear all" link when 2+ templates: `text-xs text-ctp-subtext0 hover:text-ctp-red cursor-pointer`
   - Show empty state when no templates selected: "No templates selected" in `text-sm text-ctp-subtext0 italic`

4. **CategoryFilter.tsx** — Horizontal tab filter:

   - Container: `flex gap-2 overflow-x-auto pb-2`
   - One tab per category from `GITIGNORE_CATEGORIES` plus "All" tab
   - Active tab: `bg-ctp-blue/20 text-ctp-blue border-ctp-blue/30`
   - Inactive tab: `bg-ctp-surface0 text-ctp-subtext1 border-ctp-surface1 hover:bg-ctp-surface1`
   - Each tab shows category icon + label, `text-xs px-3 py-1.5 rounded-full border inline-flex items-center gap-1.5`
   - Hide "Recommended" tab when `detectedTypes.length === 0`
   - Uses `role="tablist"` with `aria-label="Template categories"`, each button is `role="tab"` with `aria-selected`

5. **ProjectDetectionBanner.tsx** — Smart recommendation banner:

   - Container: `flex items-center gap-3 p-3 bg-ctp-blue/10 border border-ctp-blue/30 rounded-lg`
   - Sparkles icon in `text-ctp-blue`
   - Text: "Detected: {projectType}" for each detected type (comma-separated if multiple)
   - Recommended template quick-add buttons: for each recommended template not already selected, show `+{Name}` button with `bg-ctp-blue/20 text-ctp-blue text-xs px-2 py-1 rounded hover:bg-ctp-blue/30`
   - Already-selected recommendations show as filled chips (no "+" prefix, muted style)
   - `aria-live="polite"` on the container so screen readers announce detection results
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts" | tail -15` — no errors from new components.
    Verify directory structure: `find src/components/init-repo -type f | sort`.
  </verify>
  <done>
    - InitRepoForm renders 4 sections: core config, .gitignore, README, initial commit
    - TemplatePicker has search, category filter, multi-select list with keyboard navigation
    - TemplateChips shows selected templates as removable chips with "Clear all"
    - CategoryFilter renders horizontal scrollable tabs from GITIGNORE_CATEGORIES
    - ProjectDetectionBanner shows detected project types with quick-add template buttons
    - All components use Catppuccin color tokens and follow existing styling patterns
    - ARIA roles and labels applied: listbox, option, tablist, tab, aria-live
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignoring pre-existing bindings.ts error)
2. `"init-repo"` type is in BladePropsMap, EXPECTED_TYPES, and has a registration file
3. InitRepoBlade renders SplitPaneLayout with form on left
4. TemplatePicker shows template list with search filtering and category tabs
5. Selected templates appear as removable chips
6. Project detection banner shows recommended templates
</verification>

<success_criteria>
- Init Repo blade registered as singleton with showBack
- Form has all 4 sections with correct collapsible behavior
- Template picker supports search, category filter, and multi-select
- Project detection results pre-select recommended templates
- All ARIA roles and keyboard navigation implemented
</success_criteria>

<output>
After completion, create `.planning/phases/27-init-repo-blade/27-03-SUMMARY.md`
</output>
