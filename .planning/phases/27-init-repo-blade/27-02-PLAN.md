---
phase: 27-init-repo-blade
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/gitignoreComposer.ts
  - src/lib/gitignoreCategories.ts
  - src/stores/initRepo.ts
autonomous: true

must_haves:
  truths:
    - "gitignoreComposer merges multiple template contents into a single .gitignore with section headers and deduplication"
    - "gitignoreCategories maps all 163 GitHub template names into 5 categories (languages, frameworks, editors, os, other)"
    - "initRepo Zustand store holds all form state for the Init Repo blade (path, branch, selected templates, readme config, commit config)"
  artifacts:
    - path: "src/lib/gitignoreComposer.ts"
      provides: "composeGitignore function that merges templates with section headers and deduplication"
      exports: ["composeGitignore"]
    - path: "src/lib/gitignoreCategories.ts"
      provides: "Template-to-category mapping and category definitions"
      exports: ["GITIGNORE_CATEGORIES", "categorizeTemplate", "getCategoryForTemplate"]
    - path: "src/stores/initRepo.ts"
      provides: "Zustand store for Init Repo blade form state"
      exports: ["useInitRepoStore"]
  key_links:
    - from: "src/lib/gitignoreComposer.ts"
      to: "src/stores/initRepo.ts"
      via: "Store calls composeGitignore when selected templates change"
      pattern: "composeGitignore"
    - from: "src/lib/gitignoreCategories.ts"
      to: "src/stores/initRepo.ts"
      via: "Store uses category types"
      pattern: "GITIGNORE_CATEGORIES"
---

<objective>
Create TypeScript utilities and Zustand store for the Init Repo blade: gitignore template composition logic, category mapping, and centralized form state.

Purpose: The UI components (Plan 03-04) need a clean API for composing multiple .gitignore templates, categorizing templates for browsing, and managing form state. Building these first enables parallel UI development.

Output: `gitignoreComposer.ts` (template merging), `gitignoreCategories.ts` (category mapping), `initRepo.ts` (Zustand store).
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/stores/bladeTypes.ts
@src/stores/repository.ts
@src/stores/settings.ts
@src/lib/bladeRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gitignore composer and category utilities</name>
  <files>src/lib/gitignoreComposer.ts, src/lib/gitignoreCategories.ts</files>
  <action>
1. Create `src/lib/gitignoreComposer.ts`:

```typescript
export interface TemplateSection {
  name: string;
  content: string;
}

/**
 * Compose multiple .gitignore templates into a single merged output.
 *
 * - Each template gets a section header comment: `# === {Name} ===`
 * - Duplicate rules across templates are removed (keep first occurrence)
 * - Excessive blank lines collapsed to single blank line
 * - Leading/trailing whitespace per section is trimmed
 */
export function composeGitignore(templates: TemplateSection[]): string
```

Implementation details:
- For each template, add `# === {name} ===\n` section header
- Split each template content into lines
- Track seen rules in a `Set<string>` (normalized: trimmed, lowercased for comparison, but output uses original case)
- Skip blank lines and comment lines from deduplication (always keep comments)
- Skip lines that are already in the seen set
- Join all sections with a single blank line separator
- Collapse runs of 3+ consecutive blank lines to 2
- Trim trailing whitespace from the final output, ensure single trailing newline

Also export a helper:
```typescript
/**
 * Parse a composed .gitignore back into individual template sections.
 * Useful for displaying which templates contributed which rules.
 */
export function parseGitignoreSections(composed: string): TemplateSection[]
```

2. Create `src/lib/gitignoreCategories.ts`:

```typescript
import type { LucideIcon } from "lucide-react";
import { Code, Layers, Monitor, Laptop, Sparkles, MoreHorizontal } from "lucide-react";

export interface GitignoreCategory {
  id: string;
  label: string;
  icon: LucideIcon;
}

export const GITIGNORE_CATEGORIES: GitignoreCategory[] = [
  { id: "recommended", label: "Recommended", icon: Sparkles },
  { id: "languages", label: "Languages", icon: Code },
  { id: "frameworks", label: "Frameworks", icon: Layers },
  { id: "editors", label: "Editors/IDEs", icon: Monitor },
  { id: "os", label: "Operating Systems", icon: Laptop },
  { id: "other", label: "Other", icon: MoreHorizontal },
];

export type CategoryId = typeof GITIGNORE_CATEGORIES[number]["id"];
```

Create a `TEMPLATE_CATEGORY_MAP: Record<string, CategoryId>` that maps all known template names to categories. Use these groupings:

**languages**: Node, Python, Java, C++, C, CSharp (alias: VisualStudio in some contexts), Go, Rust, Ruby, Swift, Kotlin, Scala, Haskell, Elixir, Erlang, Clojure, R, Julia, Perl, PHP, Lua, Dart, OCaml, Fortran, Pascal, Objective-C, Assembly, Nim, Zig, V, Crystal, D, Elm, PureScript, Racket, Scheme, CommonLisp, FSharp, TeX, Sass, Less

**frameworks**: Rails, Django, Laravel, Angular, React (if it existed), Vue, Symfony, Spring, Flutter, Android, Unity, UnrealEngine, Godot, ROS, Terraform, Packer, Ansible, Chef, Puppet, Zephyr, Yii, CakePHP, CodeIgniter, FuelPHP, Lithium, Magento, WordPress, Joomla, Drupal, ExpressionEngine, SugarCRM, Concrete5, Umbraco, PlayFramework, GWT, Grails, Leiningen

**editors**: JetBrains, VisualStudioCode, Vim, Emacs, SublimeText, Eclipse, NetBeans, Xcode, Notepad++, Kate, Atom, TextMate

**os**: macOS, Windows, Linux

Everything else falls to **other**.

Export:
```typescript
export function getCategoryForTemplate(name: string): CategoryId
export function getTemplatesByCategory(templateNames: string[]): Record<CategoryId, string[]>
```

`getCategoryForTemplate` does a case-insensitive lookup in `TEMPLATE_CATEGORY_MAP`, defaulting to `"other"`.
`getTemplatesByCategory` groups an array of template names by category.
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts" | tail -10` — should have no errors from the new files.
    Verify files exist: `ls -la src/lib/gitignoreComposer.ts src/lib/gitignoreCategories.ts`.
  </verify>
  <done>
    - `composeGitignore` accepts TemplateSection[] and returns merged string with section headers, deduplication, and collapsed blank lines
    - `getCategoryForTemplate` maps 60+ template names to 4 categories (+ "other" fallback)
    - Both files export typed interfaces and pure functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zustand store for Init Repo form state</name>
  <files>src/stores/initRepo.ts</files>
  <action>
Create `src/stores/initRepo.ts` following the existing store pattern (see `src/stores/clone.ts` or `src/stores/settings.ts` for Zustand + devtools pattern):

```typescript
import { create } from "zustand";
import { devtools } from "zustand/middleware";

interface InitRepoState {
  // Core config
  directoryPath: string;
  defaultBranch: string;

  // Project detection
  detectedTypes: Array<{
    projectType: string;
    markerFile: string;
    recommendedTemplates: string[];
  }>;
  isDetecting: boolean;

  // Gitignore
  selectedTemplates: string[];  // ordered list of template names
  templateContents: Record<string, string>;  // name -> raw content cache
  isLoadingTemplates: boolean;
  templateSource: "github" | "bundled" | null;  // null = not loaded yet
  searchQuery: string;
  activeCategory: string;  // category filter id or "all"
  isPickerOpen: boolean;

  // README
  readmeEnabled: boolean;
  readmeName: string;
  readmeDescription: string;

  // Initial commit
  commitEnabled: boolean;
  commitMessage: string;

  // Active section (for preview context switching)
  activeSection: "gitignore" | "readme" | "commit" | "summary";

  // Init progress
  isInitializing: boolean;
  initError: string | null;

  // Actions
  setDirectoryPath: (path: string) => void;
  setDefaultBranch: (branch: string) => void;
  setDetectedTypes: (types: InitRepoState["detectedTypes"]) => void;
  setIsDetecting: (v: boolean) => void;
  addTemplate: (name: string) => void;
  removeTemplate: (name: string) => void;
  reorderTemplates: (names: string[]) => void;
  clearTemplates: () => void;
  setTemplateContent: (name: string, content: string) => void;
  setIsLoadingTemplates: (v: boolean) => void;
  setTemplateSource: (source: "github" | "bundled") => void;
  setSearchQuery: (query: string) => void;
  setActiveCategory: (category: string) => void;
  setIsPickerOpen: (open: boolean) => void;
  setReadmeEnabled: (enabled: boolean) => void;
  setReadmeName: (name: string) => void;
  setReadmeDescription: (desc: string) => void;
  setCommitEnabled: (enabled: boolean) => void;
  setCommitMessage: (msg: string) => void;
  setActiveSection: (section: InitRepoState["activeSection"]) => void;
  setIsInitializing: (v: boolean) => void;
  setInitError: (error: string | null) => void;
  reset: () => void;
}
```

Implementation:
- Use `create<InitRepoState>()(devtools((...) => ({ ... }), { name: "init-repo" }))` pattern consistent with other stores
- Default values:
  - `directoryPath: ""`
  - `defaultBranch: "main"`
  - `detectedTypes: []`, `isDetecting: false`
  - `selectedTemplates: []`, `templateContents: {}`, `isLoadingTemplates: false`, `templateSource: null`
  - `searchQuery: ""`, `activeCategory: "all"`, `isPickerOpen: false`
  - `readmeEnabled: false`, `readmeName: ""`, `readmeDescription: ""`
  - `commitEnabled: true`, `commitMessage: "Initial commit"`
  - `activeSection: "summary"`
  - `isInitializing: false`, `initError: null`
- `addTemplate`: push name to selectedTemplates if not already present
- `removeTemplate`: filter name out of selectedTemplates
- `reorderTemplates`: replace selectedTemplates with new ordered array
- `clearTemplates`: empty selectedTemplates array
- `reset`: return all state to defaults (call on blade close/cancel)
- Export as `export const useInitRepoStore = create<...>(...)`
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | grep -v "bindings.ts" | tail -10` — no errors from the new store.
    Verify file exists: `ls -la src/stores/initRepo.ts`.
  </verify>
  <done>
    - `useInitRepoStore` exported with full form state for Init Repo blade
    - Store has actions for all state mutations including template add/remove/reorder
    - `reset()` action clears all state to defaults
    - Store uses devtools middleware with name "init-repo"
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (ignoring pre-existing bindings.ts error)
2. `composeGitignore([{name: "A", content: "foo"}, {name: "B", content: "bar\nfoo"}])` produces output with section headers and deduplicates "foo"
3. `getCategoryForTemplate("Node")` returns "languages"
4. `getCategoryForTemplate("JetBrains")` returns "editors"
5. `useInitRepoStore.getState().selectedTemplates` starts as empty array
6. After `addTemplate("Node")`, `selectedTemplates` is `["Node"]`
</verification>

<success_criteria>
- gitignoreComposer correctly merges templates with headers and deduplication
- gitignoreCategories maps 60+ templates across 4 categories
- Zustand store manages all Init Repo form state with typed actions
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-init-repo-blade/27-02-SUMMARY.md`
</output>
