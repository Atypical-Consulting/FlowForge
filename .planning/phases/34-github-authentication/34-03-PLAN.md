---
phase: 34-github-authentication
plan: 03
type: execute
wave: 2
depends_on: ["34-01", "34-02"]
files_modified:
  - src/extensions/github/index.ts
  - src/extensions/github/githubStore.ts
  - src/extensions/github/types.ts
  - src/extensions/github/blades/GitHubAuthBlade.tsx
  - src/extensions/github/blades/GitHubAccountBlade.tsx
  - src/extensions/github/components/DeviceCodeDisplay.tsx
  - src/extensions/github/components/ScopeSelector.tsx
  - src/extensions/github/components/RateLimitBar.tsx
  - src/extensions/github/components/GitHubStatusButton.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can initiate GitHub sign-in from command palette or toolbar"
    - "Sign-in blade shows scope selection, then device code with copy button and open browser action"
    - "Polling detects authorization and transitions to success state automatically"
    - "User can see their GitHub username and avatar after signing in"
    - "Toolbar shows GitHub status with rate limit badge (green/yellow/red dot)"
    - "Account blade shows granted scopes and rate limit bars"
    - "User can sign out from account blade"
    - "GitHub remote is auto-detected when repo is opened"
    - "Rate limit warning toast fires when approaching limit (debounced 5min)"
    - "All GitHub UI is registered via ExtensionAPI -- zero GitHub code in core UI files"
    - "GitHub extension activates via registerBuiltIn in app initialization"
  artifacts:
    - path: "src/extensions/github/index.ts"
      provides: "Extension entry point with onActivate/onDeactivate"
      contains: "onActivate"
    - path: "src/extensions/github/githubStore.ts"
      provides: "Zustand store for auth state, rate limits, device flow"
      contains: "useGitHubStore"
    - path: "src/extensions/github/blades/GitHubAuthBlade.tsx"
      provides: "Multi-step sign-in wizard blade"
    - path: "src/extensions/github/blades/GitHubAccountBlade.tsx"
      provides: "Account info, scopes, rate limits, sign out"
    - path: "src/extensions/github/components/GitHubStatusButton.tsx"
      provides: "Custom toolbar widget with rate limit badge"
  key_links:
    - from: "src/extensions/github/index.ts"
      to: "src/extensions/ExtensionAPI.ts"
      via: "onActivate(api) registers blades, commands, toolbar"
      pattern: "api\\.registerBlade"
    - from: "src/extensions/github/githubStore.ts"
      to: "src/bindings.ts"
      via: "commands.githubStartDeviceFlow, commands.githubPollAuth, etc."
      pattern: "commands\\.github"
    - from: "src/App.tsx"
      to: "src/extensions/ExtensionHost.ts"
      via: "registerBuiltIn for GitHub extension"
      pattern: "registerBuiltIn"
    - from: "src/extensions/github/components/GitHubStatusButton.tsx"
      to: "src/extensions/github/githubStore.ts"
      via: "useGitHubStore for auth status and rate limit"
      pattern: "useGitHubStore"
---

<objective>
Build the complete GitHub extension as a built-in extension: Zustand store, sign-in wizard blade, account blade, toolbar widget with rate limit badge, commands, and auto-detection of GitHub remotes.

Purpose: This is the first real extension on the Phase 33 platform. It proves the extension system works end-to-end by delivering GitHub OAuth sign-in, scope selection, rate limit tracking, and remote auto-linking -- all through ExtensionAPI registrations with ZERO GitHub-specific code in core UI files.

Output: A working GitHub sign-in flow, account management, toolbar status, and remote detection -- all contributed through the extension system.
</objective>

<execution_context>
@C:/Users/matrayp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matrayp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-github-authentication/34-RESEARCH.md
@.planning/phases/34-github-authentication/34-RESEARCH-UX.md
@.planning/phases/34-github-authentication/34-01-SUMMARY.md
@.planning/phases/34-github-authentication/34-02-SUMMARY.md
@src/extensions/ExtensionAPI.ts
@src/extensions/ExtensionHost.ts
@src/lib/toolbarRegistry.ts
@src/bindings.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub extension store, types, entry point, and app initialization</name>
  <files>
    src/extensions/github/types.ts
    src/extensions/github/githubStore.ts
    src/extensions/github/index.ts
    src/App.tsx
  </files>
  <action>
1. Create `src/extensions/github/types.ts`:
   - Export `ScopeProfile` interface: `{ id: string; name: string; description: string; scopes: string[]; recommended?: boolean }`
   - Export `SCOPE_PROFILES` const array with three profiles:
     - `"basic"`: "Basic (Read Only)" -- scopes: `["public_repo", "read:user", "user:email", "read:org"]`
     - `"full"`: "Full Access" -- scopes: `["repo", "read:user", "user:email", "read:org"]`, recommended: true
     - `"custom"`: "Custom" -- scopes: `[]` (user picks individually)
   - Export `AuthStep` type: `"scopes" | "device-code" | "polling" | "success" | "error"`
   - Export `CUSTOM_SCOPES` array for the custom selector: `[{ id: "repo", label: "Repositories", description: "Full access to repos" }, { id: "public_repo", label: "Public Repos Only", description: "Read-only for public repos" }, ...]` (cover: repo, public_repo, read:user, user:email, read:org, notifications)

2. Create `src/extensions/github/githubStore.ts`:
   - Zustand store `useGitHubStore` with devtools middleware (name: "github-auth", enabled: import.meta.env.DEV)
   - **State fields:**
     - `isAuthenticated: boolean` (false)
     - `isAuthenticating: boolean` (false)
     - `authStep: AuthStep` ("scopes")
     - `username: string | null` (null)
     - `avatarUrl: string | null` (null)
     - `scopes: string[]` ([])
     - `userCode: string | null` (null)
     - `verificationUri: string | null` (null)
     - `deviceCode: string | null` (null -- internal, never displayed)
     - `expiresAt: number | null` (null -- unix timestamp ms)
     - `pollInterval: number` (5)
     - `authError: string | null` (null)
     - `rateLimit: { remaining: number; limit: number; reset: number; used: number } | null` (null)
     - `lastRateLimitWarning: number` (0 -- timestamp for debouncing)
     - `detectedRemotes: Array<{ remoteName: string; owner: string; repo: string; url: string }>` ([])
   - **Actions:**
     - `startDeviceFlow(selectedScopes: string[]): Promise<void>` -- calls `commands.githubStartDeviceFlow(selectedScopes)`, updates state with userCode, verificationUri, deviceCode, expiresAt (Date.now() + expiresIn * 1000), sets authStep to "device-code", starts polling
     - `pollForAuth(): Promise<void>` -- called internally on an interval. Calls `commands.githubPollAuth(deviceCode, interval)`. On success: updates auth state, sets authStep to "success". On AuthorizationPending: continue. On SlowDown: increase pollInterval by 5. On ExpiredToken: set authError, authStep to "error". On AccessDenied: set authError, authStep to "error". Uses setTimeout chain (NOT setInterval) to avoid zombie timers. Store a pollTimeoutId to enable cancellation.
     - `cancelAuth(): void` -- clears timeout, resets to scopes step
     - `signOut(): Promise<void>` -- calls `commands.githubSignOut()`, resets all auth state, shows toast
     - `checkAuth(): Promise<void>` -- calls `commands.githubGetAuthStatus()`, if authenticated sets state
     - `checkRateLimit(): Promise<void>` -- calls `commands.githubCheckRateLimit()`, updates rateLimit state, calls `checkRateLimitWarning()`
     - `checkRateLimitWarning(): void` -- if remaining < 500 (10% of 5000) and last warning was >5min ago, show warning toast with "View Details" action that opens account blade. Update lastRateLimitWarning.
     - `detectRemotes(): Promise<void>` -- calls `commands.githubDetectRemotes()`, updates detectedRemotes. If remotes found and authenticated, show info toast "Linked to github.com/owner/repo".
     - `resetRemotes(): void` -- clears detectedRemotes (called on repo switch)
   - **IMPORTANT:** This store is NOT registered for reset (auth persists across repo switches). Only detectedRemotes is reset on repo change.
   - **IMPORTANT:** The polling uses setTimeout chain pattern. Store the timeout ID in a module-level variable (not in Zustand state) for cancellation. Example:
     ```typescript
     let pollTimeoutId: ReturnType<typeof setTimeout> | null = null;
     ```

3. Create `src/extensions/github/index.ts` -- the extension entry point:
   - Export `async function onActivate(api: ExtensionAPI)`:
     - Register blade `{ type: "sign-in", title: "GitHub Sign In", component: GitHubAuthBlade, singleton: true, wrapInPanel: true, showBack: true }` -- becomes `ext:github:sign-in`
     - Register blade `{ type: "account", title: "GitHub Account", component: GitHubAccountBlade, singleton: true, wrapInPanel: true, showBack: true }` -- becomes `ext:github:account`
     - Register command `{ id: "sign-in", title: "Sign in to GitHub", category: "GitHub", icon: Github, action: () => openBlade("ext:github:sign-in"), enabled: () => !useGitHubStore.getState().isAuthenticated }` -- becomes `ext:github:sign-in`
     - Register command `{ id: "sign-out", title: "Sign out of GitHub", category: "GitHub", action: () => useGitHubStore.getState().signOut(), enabled: () => useGitHubStore.getState().isAuthenticated }` -- becomes `ext:github:sign-out`
     - Contribute toolbar `{ id: "github-status", label: "GitHub", icon: Github, group: "app", priority: 60, execute: () => { open sign-in or account blade based on auth state }, when: () => true, renderCustom: (action, tabIndex) => <GitHubStatusButton tabIndex={tabIndex} /> }`
     - Call `useGitHubStore.getState().checkAuth()` to restore session from keychain on startup
   - Export `function onDeactivate()`:
     - Cancel any active polling
     - Reset transient state (device code, polling) but NOT auth state
   - For blade opening, use the navigation system: import the blade push function from the navigation store/machine (check how other blades open blades -- look at ConventionalCommitBlade or CommandPalette for the pattern)

4. In `src/App.tsx` (or the appropriate initialization file -- check where extensions/repos are initialized):
   - Import `useExtensionHost` from extensions
   - Import the GitHub extension activate/deactivate functions
   - After app initialization, call `useExtensionHost.getState().registerBuiltIn({ id: "github", name: "GitHub Integration", version: "1.0.0", activate: onActivate, deactivate: onDeactivate })` where onActivate/onDeactivate come from the github extension index
   - This should happen AFTER the extension host is ready but BEFORE the UI renders (or in a useEffect on mount)
   - IMPORTANT: Look at where `discoverExtensions` is currently called and register the built-in extension alongside that flow. If there's an initialization sequence, add registerBuiltIn there.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- should compile with no errors. Verify the extension entry point registers exactly 2 blades, 2 commands, and 1 toolbar action.
  </verify>
  <done>
    GitHub extension store manages auth lifecycle, device flow state, rate limits, and remotes. Extension entry point registers all UI through ExtensionAPI. App initialization activates the extension via registerBuiltIn. Zero GitHub imports in core UI files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build GitHub auth blade, account blade, and toolbar status widget</name>
  <files>
    src/extensions/github/components/DeviceCodeDisplay.tsx
    src/extensions/github/components/ScopeSelector.tsx
    src/extensions/github/components/RateLimitBar.tsx
    src/extensions/github/components/GitHubStatusButton.tsx
    src/extensions/github/blades/GitHubAuthBlade.tsx
    src/extensions/github/blades/GitHubAccountBlade.tsx
  </files>
  <action>
1. Create `src/extensions/github/components/ScopeSelector.tsx`:
   - Props: `{ selectedProfile: string; onSelect: (profileId: string) => void; customScopes?: string[]; onCustomScopesChange?: (scopes: string[]) => void }`
   - Render 3 profile cards (Basic, Full Access, Custom) using Catppuccin design tokens
   - Each card: icon (Eye/Shield/Settings from lucide), name, description, "Recommended" badge on full
   - Selected card has `border-ctp-blue bg-ctp-blue/5`, unselected has `border-ctp-surface1 bg-ctp-base`
   - When "Custom" is selected, show expandable section with scope checkboxes below the cards
   - Custom scopes list: `repo`, `public_repo`, `read:user`, `user:email`, `read:org`, `notifications`
   - Each scope shows human-readable label and description, not raw scope strings

2. Create `src/extensions/github/components/DeviceCodeDisplay.tsx`:
   - Props: `{ userCode: string; verificationUri: string; expiresAt: number; onCancel: () => void }`
   - Large monospace code display: `font-mono text-3xl font-bold tracking-[0.3em] text-ctp-text` on `bg-ctp-surface0 border-2 border-ctp-blue/30 rounded-xl`
   - "Copy Code" button using `@tauri-apps/plugin-clipboard-manager` writeText (if available) or navigator.clipboard.writeText fallback. Button text swaps to "Copied!" with Check icon for 2 seconds.
   - "Open GitHub" button using `openUrl` from `@tauri-apps/plugin-opener` to open verificationUri
   - Countdown timer showing time remaining until expiration. Use a `useCountdown` hook or inline useEffect with setInterval updating remaining time every second. Show "Expires in MM:SS" format.
   - Polling spinner: `<Loader2 className="w-4 h-4 animate-spin" />` with "Waiting for authorization..."
   - Cancel link/button at bottom to go back to scope selection

3. Create `src/extensions/github/components/RateLimitBar.tsx`:
   - Props: `{ label: string; remaining: number; limit: number; reset: number }`
   - Progress bar with color coding: >50% green (`bg-ctp-green`), 10-50% yellow (`bg-ctp-yellow`), <10% red (`bg-ctp-red`)
   - Text showing "{remaining} / {limit}" in monospace
   - "Resets in {minutes}min" text below

4. Create `src/extensions/github/components/GitHubStatusButton.tsx`:
   - Props: `{ tabIndex: number }`
   - This is the custom toolbar widget rendered via `renderCustom`
   - Reads `useGitHubStore` for `isAuthenticated`, `rateLimit`, `username`
   - Renders a button styled like ToolbarButton (match existing toolbar button classes)
   - Shows Github icon (lucide-react)
   - When signed in and rate limit data available: show a small colored dot/badge overlay on the icon
     - Green dot: >50% remaining
     - Yellow dot: 10-50% remaining
     - Red dot: <10% remaining
   - Tooltip: Signed out: "Sign in to GitHub". Signed in: "GitHub: @{username} ({remaining} requests remaining)"
   - Click: opens `ext:github:sign-in` blade if not signed in, `ext:github:account` if signed in
   - Use `data-toolbar-item` attribute for toolbar overflow measurement

5. Create `src/extensions/github/blades/GitHubAuthBlade.tsx`:
   - Multi-step wizard with step indicator (3 dots/pills showing current step)
   - State: `step: "scopes" | "device-code" | "success" | "error"` synced from store's `authStep`
   - **Step 1 (scopes):** ScopeSelector component + "Continue" button. On continue, call `startDeviceFlow(selectedScopes)` which transitions to step 2
   - **Step 2 (device-code):** DeviceCodeDisplay component. Polling happens automatically in the store. Back button cancels and returns to step 1 (preserves scope selection).
   - **Step 3 (success):** Green checkmark animation (use framer-motion animate presence like ConventionalCommitBlade), "@username" with avatar, granted scopes list, "Done" button that closes the blade. Auto-close after 3 seconds (same pattern as CC blade success).
   - **Error state:** Error message with "Try Again" button that returns to step 2 if code expired, or step 1 if access denied
   - Wire to store: subscribe to `authStep`, `userCode`, `verificationUri`, `expiresAt`, `username`, `avatarUrl`, `scopes`, `authError`

6. Create `src/extensions/github/blades/GitHubAccountBlade.tsx`:
   - If not authenticated: EmptyState with GitHub icon, "Not signed in" text, "Sign In" button that opens sign-in blade
   - If authenticated, show sections:
     - **Account header:** Avatar image (with fallback to UserCircle icon on error) + @username + scope count
     - **Permissions:** Flex-wrap of scope badges (small rounded pills, `bg-ctp-surface0 text-ctp-subtext1`)
     - **Rate Limits:** RateLimitBar for core API (and search/graphql if data available)
     - **Linked Repositories:** List of detected GitHub remotes with owner/repo display
     - **Sign Out:** Danger-zone section at bottom with "Sign Out" button
   - Rate limits: call `checkRateLimit()` on blade mount to get fresh data
   - Listen for repo changes to update detected remotes (subscribe to repository store)

DESIGN NOTES (Catppuccin theme compliance):
- All backgrounds: ctp-base, ctp-crust, ctp-surface0
- All text: ctp-text (primary), ctp-subtext1 (secondary), ctp-subtext0 (muted), ctp-overlay0 (very muted)
- Borders: ctp-surface0 (subtle), ctp-surface1 (stronger)
- Accent: ctp-blue for primary actions, ctp-green for success, ctp-red for errors, ctp-yellow for warnings
- Match existing blade patterns: look at SettingsBlade for layout, ConventionalCommitBlade for multi-step flow

CLIPBOARD STRATEGY: Check if `@tauri-apps/plugin-clipboard-manager` is available. If not installed, install it. If the plugin is not in the Tauri project capabilities, add it. Fallback to navigator.clipboard.writeText for development/testing. Check `src-tauri/capabilities/default.json` for plugin permissions.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- should compile with no errors. Run `npx vitest run` to check no test regressions.
  </verify>
  <done>
    All 6 React components render correctly. Auth blade has 3-step wizard flow. Account blade shows account info, scopes, rate limits, and detected remotes. Toolbar widget shows dynamic rate limit badge. All using Catppuccin design tokens.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify GitHub sign-in flow end-to-end</name>
  <files>src/extensions/github/</files>
  <action>
    Human verification of the complete GitHub OAuth Device Flow authentication extension.
    What was built:
    - GitHub extension registered as built-in extension via registerBuiltIn
    - Sign-in wizard blade with scope selection, device code display, and polling
    - Account management blade with user info, scopes, rate limits, and sign out
    - Toolbar status button with rate limit badge
    - GitHub remote auto-detection
    - All UI contributed through ExtensionAPI (zero GitHub code in core UI files)
  </action>
  <verify>
    1. Open FlowForge and verify the GitHub icon appears in the toolbar "app" group
    2. Click the GitHub toolbar button -- should open the sign-in blade
    3. Open command palette (Cmd/Ctrl+K) -- verify "Sign in to GitHub" appears under GitHub category
    4. In the sign-in blade:
       a. Verify 3 scope profile cards are shown (Basic, Full Access, Custom)
       b. Select "Full Access" and click Continue
       c. Verify a device code is displayed in large monospace text
       d. Verify "Copy Code" button works (copies to clipboard)
       e. Verify "Open GitHub" button opens browser to github.com/login/device
       f. Complete authorization in browser
       g. Verify the blade transitions to success screen with username
    5. After sign-in:
       a. Verify toolbar button shows a colored rate limit dot
       b. Click toolbar button -- should open account blade
       c. Verify account blade shows username, avatar, scopes, and rate limits
       d. Verify rate limit bars are color-coded
    6. Open a repo with a GitHub remote -- verify "Linked to github.com/owner/repo" toast
    7. Sign out from account blade -- verify toolbar returns to unsigned state
    8. Verify NO GitHub-specific imports exist in core UI files (grep for "github" in src/components/, src/blades/, src/App.tsx -- only the registerBuiltIn call should appear in App.tsx)
  </verify>
  <done>User has verified the complete GitHub sign-in flow works end-to-end and all UI is extension-contributed</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. `npx vitest run` passes with no test regressions
3. GitHub extension appears in ExtensionHost extensions Map with status "active"
4. Toolbar shows GitHub status button with rate limit badge
5. Sign-in flow: scope selection -> device code -> polling -> success (all 4 steps)
6. Account blade: user info + scopes + rate limits + linked repos + sign out
7. Rate limit warning toast fires when < 500 remaining (debounced 5min)
8. Remote auto-detection shows GitHub remotes when repo is opened
9. `grep -r "github" src/components/ src/blades/` returns NO results (all GitHub UI is in src/extensions/github/)
</verification>

<success_criteria>
- Complete OAuth Device Flow works end-to-end (sign in, see code, authorize, return signed in)
- Tokens stored in OS keychain, never visible in frontend state or devtools
- Scope selection with profile cards (Basic/Full/Custom) before authorization
- GitHub remote auto-detection and linking
- Rate limit display in toolbar badge + account blade + warning toasts
- ALL GitHub UI flows through ExtensionAPI -- zero core UI file modifications for GitHub
</success_criteria>

<output>
After completion, create `.planning/phases/34-github-authentication/34-03-SUMMARY.md`
</output>
