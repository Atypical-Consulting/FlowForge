---
phase: 02-core-git-staging-commits
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - package.json
  - src/stores/staging.ts
  - src/components/staging/FileList.tsx
  - src/components/staging/FileItem.tsx
  - src/components/staging/FileTreeView.tsx
  - src/components/staging/StagingPanel.tsx
  - src/components/RepositoryView.tsx
autonomous: true

must_haves:
  truths:
    - "User sees files grouped by Staged, Unstaged, Untracked sections"
    - "User can click a file to select it"
    - "User can stage individual files with checkbox or button"
    - "User can unstage individual files"
    - "User can stage all or unstage all with single action"
  artifacts:
    - path: "src/components/staging/StagingPanel.tsx"
      provides: "Main staging panel with file list and actions"
    - path: "src/stores/staging.ts"
      provides: "Staging state with selected file"
  key_links:
    - from: "StagingPanel.tsx"
      to: "commands.getStagingStatus"
      via: "useQuery"
      pattern: "useQuery.*getStagingStatus"
    - from: "FileItem.tsx"
      to: "commands.stageFile"
      via: "mutation on click"
      pattern: "useMutation.*stageFile"
---

<objective>
Build the frontend staging UI that displays changed files grouped by status and allows users to stage/unstage files.

Purpose: Give users visibility into their working directory changes and control over what goes into the next commit.

Output: StagingPanel component with FileList, integrated into RepositoryView.
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-git-staging-commits/02-CONTEXT.md
@.planning/phases/02-core-git-staging-commits/02-01-SUMMARY.md

# Existing patterns
@src/stores/repository.ts
@src/components/RepositoryView.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create staging store and FileItem component</name>
  <files>
    src/stores/staging.ts
    src/components/staging/FileItem.tsx
  </files>
  <action>
**Create `src/stores/staging.ts`:**

```typescript
import { create } from 'zustand';
import type { FileChange } from '../bindings';

type ViewMode = 'tree' | 'flat';

interface StagingState {
  selectedFile: FileChange | null;
  viewMode: ViewMode;
  selectFile: (file: FileChange | null) => void;
  setViewMode: (mode: ViewMode) => void;
}

export const useStagingStore = create<StagingState>((set) => ({
  selectedFile: null,
  viewMode: 'tree', // Tree view as default per USER DECISIONS
  selectFile: (file) => set({ selectedFile: file }),
  setViewMode: (mode) => set({ viewMode: mode }),
}));
```

**Create `src/components/staging/FileItem.tsx`:**

```typescript
import { FileChange, FileStatus } from '../../bindings';
import { commands } from '../../bindings';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { useStagingStore } from '../../stores/staging';
import { cn } from '../../lib/utils';
import { 
  FilePlus, 
  FileMinus, 
  FileEdit, 
  FileQuestion,
  Check,
  X 
} from 'lucide-react';

interface FileItemProps {
  file: FileChange;
  section: 'staged' | 'unstaged' | 'untracked';
}

export function FileItem({ file, section }: FileItemProps) {
  const queryClient = useQueryClient();
  const { selectedFile, selectFile } = useStagingStore();
  const isSelected = selectedFile?.path === file.path;
  
  const stageMutation = useMutation({
    mutationFn: () => commands.stageFile({ path: file.path }),
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['stagingStatus'] }),
  });
  
  const unstageMutation = useMutation({
    mutationFn: () => commands.unstageFile({ path: file.path }),
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['stagingStatus'] }),
  });
  
  // Status icon based on FileStatus
  const StatusIcon = getStatusIcon(file.status);
  
  // Action button based on section
  const handleAction = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (section === 'staged') {
      unstageMutation.mutate();
    } else {
      stageMutation.mutate();
    }
  };
  
  return (
    <div
      onClick={() => selectFile(file)}
      className={cn(
        'flex items-center gap-2 px-3 py-1.5 cursor-pointer group',
        'hover:bg-gray-800/50 transition-colors',
        isSelected && 'bg-blue-900/30 border-l-2 border-blue-500'
      )}
    >
      <StatusIcon className="w-4 h-4 text-gray-400 flex-shrink-0" />
      <span className="flex-1 truncate text-sm text-gray-200">
        {file.path}
      </span>
      {file.additions !== null && file.deletions !== null && (
        <span className="text-xs text-gray-500">
          <span className="text-green-500">+{file.additions}</span>
          {' '}
          <span className="text-red-500">-{file.deletions}</span>
        </span>
      )}
      <button
        onClick={handleAction}
        className={cn(
          'opacity-0 group-hover:opacity-100 p-1 rounded transition-opacity',
          section === 'staged' 
            ? 'hover:bg-red-900/50 text-red-400' 
            : 'hover:bg-green-900/50 text-green-400'
        )}
        title={section === 'staged' ? 'Unstage' : 'Stage'}
      >
        {section === 'staged' ? <X className="w-3 h-3" /> : <Check className="w-3 h-3" />}
      </button>
    </div>
  );
}

function getStatusIcon(status: FileStatus) {
  switch (status) {
    case 'Added': return FilePlus;
    case 'Deleted': return FileMinus;
    case 'Modified': return FileEdit;
    case 'Untracked': return FileQuestion;
    default: return FileEdit;
  }
}
```

Note: Handle the `Renamed` status variant which has `{ oldPath: string }` content - show as FileEdit with old path in tooltip.
  </action>
  <verify>
    - TypeScript compiles without errors
    - FileItem renders with correct icon per status
    - Click selects file (check via React DevTools or visual feedback)
    - Hover shows stage/unstage button
  </verify>
  <done>
    - Staging store tracks selected file
    - FileItem shows status icon, path, and +/- counts
    - Stage/unstage button appears on hover
    - Clicking file selects it (for diff viewing)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FileTreeView component for tree display</name>
  <files>
    src/components/staging/FileTreeView.tsx
  </files>
  <action>
**Create `src/components/staging/FileTreeView.tsx`:**

Tree view displays files grouped by directory hierarchy (default view per USER DECISIONS).

```typescript
import { FileChange } from '../../bindings';
import { FileItem } from './FileItem';
import { ChevronDown, ChevronRight, Folder } from 'lucide-react';
import { useState, useMemo } from 'react';

interface FileTreeNode {
  name: string;
  path: string;
  isDirectory: boolean;
  children: Map<string, FileTreeNode>;
  file?: FileChange;
}

interface FileTreeViewProps {
  files: FileChange[];
  section: 'staged' | 'unstaged' | 'untracked';
}

export function FileTreeView({ files, section }: FileTreeViewProps) {
  // Build tree structure from flat file list
  const tree = useMemo(() => {
    const root: FileTreeNode = { 
      name: '', 
      path: '', 
      isDirectory: true, 
      children: new Map() 
    };
    
    for (const file of files) {
      const parts = file.path.split('/');
      let current = root;
      
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        const isLast = i === parts.length - 1;
        const fullPath = parts.slice(0, i + 1).join('/');
        
        if (!current.children.has(part)) {
          current.children.set(part, {
            name: part,
            path: fullPath,
            isDirectory: !isLast,
            children: new Map(),
            file: isLast ? file : undefined,
          });
        }
        current = current.children.get(part)!;
      }
    }
    
    return root;
  }, [files]);
  
  return (
    <div className="pl-2">
      {Array.from(tree.children.values()).map((node) => (
        <TreeNode key={node.path} node={node} section={section} depth={0} />
      ))}
    </div>
  );
}

interface TreeNodeProps {
  node: FileTreeNode;
  section: 'staged' | 'unstaged' | 'untracked';
  depth: number;
}

function TreeNode({ node, section, depth }: TreeNodeProps) {
  const [expanded, setExpanded] = useState(true);
  
  if (!node.isDirectory && node.file) {
    return <FileItem file={node.file} section={section} />;
  }
  
  const childNodes = Array.from(node.children.values());
  
  return (
    <div>
      <div 
        className="flex items-center gap-1 px-2 py-1 cursor-pointer hover:bg-gray-800/30 text-sm text-gray-400"
        onClick={() => setExpanded(!expanded)}
        style={{ paddingLeft: `${depth * 12 + 8}px` }}
      >
        {expanded ? (
          <ChevronDown className="w-3 h-3" />
        ) : (
          <ChevronRight className="w-3 h-3" />
        )}
        <Folder className="w-4 h-4 text-blue-400" />
        <span>{node.name}</span>
      </div>
      {expanded && (
        <div>
          {childNodes.map((child) => (
            <TreeNode 
              key={child.path} 
              node={child} 
              section={section} 
              depth={depth + 1} 
            />
          ))}
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
    - TypeScript compiles without errors
    - FileTreeView renders directory hierarchy
    - Folders are collapsible
    - Files show at correct depth with proper indentation
  </verify>
  <done>
    - Tree view displays files grouped by directory
    - Directories are collapsible with expand/collapse toggle
    - Proper indentation for nested structure
    - Files render using existing FileItem component
  </done>
</task>

<task type="auto">
  <name>Task 3: Create StagingPanel with grouped file list and view toggle</name>
  <files>
    src/components/staging/StagingPanel.tsx
    src/components/staging/FileList.tsx
  </files>
  <action>
**Create `src/components/staging/FileList.tsx`:**

```typescript
import { FileChange } from '../../bindings';
import { FileItem } from './FileItem';
import { ChevronDown, ChevronRight } from 'lucide-react';
import { useState } from 'react';

interface FileListProps {
  title: string;
  files: FileChange[];
  section: 'staged' | 'unstaged' | 'untracked';
  defaultExpanded?: boolean;
  onStageAll?: () => void;
  onUnstageAll?: () => void;
}

export function FileList({ 
  title, 
  files, 
  section, 
  defaultExpanded = true,
  onStageAll,
  onUnstageAll 
}: FileListProps) {
  const [expanded, setExpanded] = useState(defaultExpanded);
  
  if (files.length === 0) return null;
  
  return (
    <div className="mb-2">
      <div 
        className="flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-gray-800/30"
        onClick={() => setExpanded(!expanded)}
      >
        {expanded ? (
          <ChevronDown className="w-4 h-4 text-gray-400" />
        ) : (
          <ChevronRight className="w-4 h-4 text-gray-400" />
        )}
        <span className="text-sm font-medium text-gray-300">{title}</span>
        <span className="text-xs text-gray-500 bg-gray-800 px-1.5 py-0.5 rounded">
          {files.length}
        </span>
        
        {/* Stage All / Unstage All button */}
        {section === 'staged' && onUnstageAll && (
          <button
            onClick={(e) => { e.stopPropagation(); onUnstageAll(); }}
            className="ml-auto text-xs text-gray-400 hover:text-white"
          >
            Unstage All
          </button>
        )}
        {section !== 'staged' && onStageAll && (
          <button
            onClick={(e) => { e.stopPropagation(); onStageAll(); }}
            className="ml-auto text-xs text-gray-400 hover:text-white"
          >
            Stage All
          </button>
        )}
      </div>
      
      {expanded && (
        <div className="border-l border-gray-800 ml-3">
          {files.map((file) => (
            <FileItem key={file.path} file={file} section={section} />
          ))}
        </div>
      )}
    </div>
  );
}
```

**Create `src/components/staging/StagingPanel.tsx`:**

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { commands } from '../../bindings';
import { FileList } from './FileList';
import { FileTreeView } from './FileTreeView';
import { useStagingStore } from '../../stores/staging';
import { Loader2, List, FolderTree } from 'lucide-react';
import { Button } from '../ui/button';

export function StagingPanel() {
  const queryClient = useQueryClient();
  const { viewMode, setViewMode } = useStagingStore();
  
  const { data: status, isLoading, error } = useQuery({
    queryKey: ['stagingStatus'],
    queryFn: () => commands.getStagingStatus(),
    refetchInterval: 2000, // Poll every 2s for external changes
  });
  
  const stageAllMutation = useMutation({
    mutationFn: () => commands.stageAll(),
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['stagingStatus'] }),
  });
  
  const unstageAllMutation = useMutation({
    mutationFn: () => commands.unstageAll(),
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['stagingStatus'] }),
  });
  
  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-4">
        <Loader2 className="w-5 h-5 animate-spin text-gray-400" />
      </div>
    );
  }
  
  if (error) {
    return (
      <div className="p-4 text-red-400 text-sm">
        Failed to load file status
      </div>
    );
  }
  
  if (!status) return null;
  
  const hasChanges = 
    status.staged.length > 0 || 
    status.unstaged.length > 0 || 
    status.untracked.length > 0;
  
  if (!hasChanges) {
    return (
      <div className="p-4 text-gray-500 text-sm text-center">
        No changes to commit
      </div>
    );
  }
  
  // Choose component based on view mode (tree is default per USER DECISIONS)
  const FileDisplay = viewMode === 'tree' ? FileTreeView : FileList;
  
  return (
    <div className="flex flex-col h-full overflow-y-auto">
      {/* View mode toggle */}
      <div className="flex items-center justify-end px-3 py-1.5 border-b border-gray-800">
        <div className="flex items-center gap-1 bg-gray-800 rounded p-0.5">
          <Button
            variant={viewMode === 'tree' ? 'secondary' : 'ghost'}
            size="sm"
            onClick={() => setViewMode('tree')}
            title="Tree view"
            className="h-6 w-6 p-0"
          >
            <FolderTree className="w-3.5 h-3.5" />
          </Button>
          <Button
            variant={viewMode === 'flat' ? 'secondary' : 'ghost'}
            size="sm"
            onClick={() => setViewMode('flat')}
            title="Flat list"
            className="h-6 w-6 p-0"
          >
            <List className="w-3.5 h-3.5" />
          </Button>
        </div>
      </div>
      
      <FileDisplay
        title="Staged Changes"
        files={status.staged}
        section="staged"
        onUnstageAll={() => unstageAllMutation.mutate()}
      />
      <FileDisplay
        title="Changes"
        files={status.unstaged}
        section="unstaged"
        onStageAll={() => stageAllMutation.mutate()}
      />
      <FileDisplay
        title="Untracked Files"
        files={status.untracked}
        section="untracked"
        onStageAll={() => stageAllMutation.mutate()}
      />
    </div>
  );
}
```
  </action>
  <verify>
    - `npm run build` succeeds
    - StagingPanel renders three sections (staged, unstaged, untracked)
    - Empty sections are hidden
    - "No changes to commit" shows when working tree is clean
    - Stage All / Unstage All buttons work
  </verify>
  <done>
    - Files grouped by Staged, Changes, Untracked sections
    - Collapsible sections with file counts
    - Stage All / Unstage All buttons in section headers
    - Loading and error states handled
    - Auto-refresh every 2 seconds for external changes
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate StagingPanel into RepositoryView</name>
  <files>
    src/components/RepositoryView.tsx
    package.json
  </files>
  <action>
**Update `src/components/RepositoryView.tsx`:**

Replace the placeholder content with a two-column layout:
- Left panel: StagingPanel (file list)
- Right panel: Diff viewer placeholder (for Plan 05)

```typescript
import { useRepositoryStore } from "../stores/repository";
import { StagingPanel } from "./staging/StagingPanel";

export function RepositoryView() {
  const { status } = useRepositoryStore();

  if (!status) return null;

  return (
    <div className="flex-1 flex h-full overflow-hidden">
      {/* Left panel: Staging */}
      <div className="w-80 flex-shrink-0 border-r border-gray-800 bg-gray-950 overflow-hidden flex flex-col">
        <div className="p-3 border-b border-gray-800">
          <h2 className="text-sm font-medium text-gray-300">Changes</h2>
        </div>
        <StagingPanel />
      </div>
      
      {/* Right panel: Diff viewer (placeholder for Plan 05) */}
      <div className="flex-1 flex items-center justify-center bg-gray-900">
        <p className="text-gray-500 text-sm">
          Select a file to view diff
        </p>
      </div>
    </div>
  );
}
```

**Verify package.json has required dependencies:**
- @tanstack/react-query should already be installed
- lucide-react should already be installed
- If missing, add them:
```bash
npm install @tanstack/react-query lucide-react
```

**Ensure QueryClientProvider is set up in App.tsx or main.tsx:**
If not already present, wrap the app:
```typescript
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
const queryClient = new QueryClient();
// ... in render:
<QueryClientProvider client={queryClient}>
  <App />
</QueryClientProvider>
```
  </action>
  <verify>
    - `npm run build` succeeds
    - `npm run tauri dev` shows RepositoryView with staging panel
    - Files appear in correct sections
    - Clicking stage/unstage moves files between sections
    - Stage All / Unstage All work
  </verify>
  <done>
    - RepositoryView has two-column layout
    - Left panel shows StagingPanel with file list
    - Right panel placeholder for diff viewer
    - Full staging workflow functional (stage, unstage, stage all, unstage all)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `npm run build` succeeds without TypeScript errors
2. `npm run tauri dev` launches
3. Open a repository with uncommitted changes
4. Verify:
   - Files appear grouped by Staged, Changes, Untracked
   - Clicking file selects it (visual feedback)
   - Hover reveals stage/unstage button
   - Click stage button moves file to Staged section
   - Click unstage button moves file to Changes section
   - Stage All / Unstage All buttons work
   - Empty sections are hidden
   - "No changes to commit" shows for clean repos
</verification>

<success_criteria>
- GIT-01: User can view list of changed files (staged, unstaged, untracked) - COMPLETE
- GIT-02: User can stage individual files or all files - COMPLETE
- GIT-03: User can unstage individual files or all files - COMPLETE
- File selection tracked in staging store for diff viewing
- Tree view as default with flat list toggle (per USER DECISIONS)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-git-staging-commits/02-04-SUMMARY.md`
</output>
