---
phase: 46-topology-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/lib/commitClassifier.ts
  - src/core/components/icons/CommitTypeIcon.tsx
  - src/core/blades/commit-list-fallback/CommitListFallbackBlade.tsx
  - src/core/blades/commit-list-fallback/registration.ts
  - src/core/stores/bladeTypes.ts
  - src/core/machines/navigation/actions.ts
  - src/core/blades/_discovery.ts
autonomous: true

must_haves:
  truths:
    - "rootBladeForProcess('topology') returns commit-list-fallback blade when topology-graph is not in blade registry"
    - "CommitTypeIcon imports parseConventionalType from core/lib/commitClassifier instead of topology-graph/components/layoutUtils"
    - "commit-list-fallback blade renders CommitHistory with commit detail navigation"
  artifacts:
    - path: "src/core/lib/commitClassifier.ts"
      provides: "parseConventionalType function extracted from layoutUtils"
      exports: ["parseConventionalType"]
    - path: "src/core/blades/commit-list-fallback/CommitListFallbackBlade.tsx"
      provides: "Fallback blade wrapping CommitHistory"
      exports: ["CommitListFallbackBlade"]
    - path: "src/core/blades/commit-list-fallback/registration.ts"
      provides: "Core blade registration for commit-list-fallback"
  key_links:
    - from: "src/core/machines/navigation/actions.ts"
      to: "src/core/lib/bladeRegistry"
      via: "useBladeRegistry.getState().blades.has('topology-graph')"
      pattern: "blades\\.has\\(\"topology-graph\"\\)"
    - from: "src/core/components/icons/CommitTypeIcon.tsx"
      to: "src/core/lib/commitClassifier.ts"
      via: "import parseConventionalType"
      pattern: "from.*commitClassifier"
---

<objective>
Prepare the codebase for topology extraction by resolving cross-module dependencies and creating the fallback infrastructure that ensures the app never crashes when topology-graph blade is unregistered.

Purpose: These are blocking pre-requisites that must exist before topology files can be moved to the extension directory. The parseConventionalType function is imported by a core icon component from topology's layoutUtils -- it must be extracted to a shared core location first. The fallback blade and registry-aware rootBladeForProcess ensure graceful degradation.

Output: commitClassifier.ts utility, commit-list-fallback blade, registry-aware rootBladeForProcess
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-topology-extraction/46-RESEARCH.md

@src/core/blades/topology-graph/components/layoutUtils.ts
@src/core/components/icons/CommitTypeIcon.tsx
@src/core/machines/navigation/actions.ts
@src/core/stores/bladeTypes.ts
@src/core/blades/_discovery.ts
@src/core/components/commit/CommitHistory.tsx
@src/core/hooks/useBladeNavigation.ts
@src/core/lib/bladeRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract parseConventionalType to core utility + create fallback blade</name>
  <files>
    src/core/lib/commitClassifier.ts
    src/core/components/icons/CommitTypeIcon.tsx
    src/core/blades/commit-list-fallback/CommitListFallbackBlade.tsx
    src/core/blades/commit-list-fallback/registration.ts
    src/core/stores/bladeTypes.ts
    src/core/blades/_discovery.ts
  </files>
  <action>
    1. Create `src/core/lib/commitClassifier.ts`:
       - Extract the `parseConventionalType` function from `src/core/blades/topology-graph/components/layoutUtils.ts`
       - Import `parseConventionalMessage` from `../../extensions/conventional-commits/lib/conventional-utils`
       - Export `parseConventionalType(message: string): string | null` -- it calls `parseConventionalMessage(message)` and returns `parsed.commitType ?? null`
       - This is a small utility file (~10 lines)

    2. Update `src/core/components/icons/CommitTypeIcon.tsx`:
       - Change the import of `parseConventionalType` from `"../../blades/topology-graph/components/layoutUtils"` to `"../../lib/commitClassifier"`
       - No other changes needed

    3. Create `src/core/blades/commit-list-fallback/CommitListFallbackBlade.tsx`:
       - A minimal blade component that wraps `CommitHistory` with blade navigation
       - Import `useBladeNavigation` from `../../hooks/useBladeNavigation`
       - Import `CommitHistory` from `../../components/commit/CommitHistory`
       - The component calls `const { openBlade } = useBladeNavigation()` and renders:
         `<CommitHistory onCommitSelect={(oid) => openBlade("commit-details", { oid })} />`
       - Wrap in a `<div className="flex flex-col h-full">` container
       - Export as named export `CommitListFallbackBlade`

    4. Create `src/core/blades/commit-list-fallback/registration.ts`:
       - Import `registerBlade` from `../../lib/bladeRegistry`
       - Import `CommitListFallbackBlade` from `./CommitListFallbackBlade`
       - Call `registerBlade({ type: "commit-list-fallback", defaultTitle: "History", component: CommitListFallbackBlade, wrapInPanel: false, showBack: false })`

    5. Update `src/core/stores/bladeTypes.ts`:
       - Add `"commit-list-fallback": Record<string, never>;` to the `BladePropsMap` interface (after the "topology-graph" entry)

    6. Update `src/core/blades/_discovery.ts`:
       - Add `"commit-list-fallback"` to the `EXPECTED_TYPES` array
       - Do NOT remove "topology-graph" yet (it is still registered via registration.ts in this plan; removal happens in Plan 03)
  </action>
  <verify>
    - `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` should show no new type errors
    - `grep -r "parseConventionalType" src/core/components/icons/CommitTypeIcon.tsx` should show import from `commitClassifier`
    - `ls src/core/blades/commit-list-fallback/` should show both files
  </verify>
  <done>
    - parseConventionalType extracted to src/core/lib/commitClassifier.ts
    - CommitTypeIcon imports from new core location (no topology dependency)
    - commit-list-fallback blade exists and registers via _discovery.ts
    - BladePropsMap includes "commit-list-fallback" type
  </done>
</task>

<task type="auto">
  <name>Task 2: Make rootBladeForProcess registry-aware with fallback</name>
  <files>
    src/core/machines/navigation/actions.ts
  </files>
  <action>
    Update `src/core/machines/navigation/actions.ts`:

    1. Add import: `import { useBladeRegistry } from "../../lib/bladeRegistry";`

    2. Modify the `rootBladeForProcess` function. Currently it has:
       ```
       if (process === "staging") { return staging blade; }
       return { id: "root", type: "topology-graph", ... };
       ```
       Change the topology branch to check the blade registry:
       ```typescript
       export function rootBladeForProcess(process: ProcessType): TypedBlade {
         if (process === "staging") {
           return {
             id: "root",
             type: "staging-changes",
             title: "Changes",
             props: {} as Record<string, never>,
           };
         }
         // Check if topology-graph blade is registered (extension active)
         if (useBladeRegistry.getState().blades.has("topology-graph")) {
           return {
             id: "root",
             type: "topology-graph",
             title: "Topology",
             props: {} as Record<string, never>,
           };
         }
         // Fallback: simple commit list when topology extension is disabled
         return {
           id: "root",
           type: "commit-list-fallback",
           title: "History",
           props: {} as Record<string, never>,
         };
       }
       ```

    This ensures the navigation machine never tries to render an unregistered blade type. When topology extension is disabled, it falls back to the simple commit list.
  </action>
  <verify>
    - `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` should show no new type errors
    - `grep "useBladeRegistry" src/core/machines/navigation/actions.ts` confirms registry import
    - `grep "commit-list-fallback" src/core/machines/navigation/actions.ts` confirms fallback path
    - `npx vitest run --reporter=verbose 2>&1 | tail -5` should show all tests passing
  </verify>
  <done>
    - rootBladeForProcess checks blade registry before returning topology-graph
    - Falls back to commit-list-fallback when topology-graph is not registered
    - No regression in existing tests
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation clean: `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` -- no new errors
2. All tests pass: `npx vitest run`
3. parseConventionalType available from core: `grep "commitClassifier" src/core/components/icons/CommitTypeIcon.tsx`
4. Fallback blade registered: `grep "commit-list-fallback" src/core/blades/_discovery.ts`
5. rootBladeForProcess is registry-aware: `grep "useBladeRegistry" src/core/machines/navigation/actions.ts`
</verification>

<success_criteria>
- CommitTypeIcon no longer imports from topology-graph directory
- commit-list-fallback blade exists and renders CommitHistory
- rootBladeForProcess returns topology-graph when extension is active, commit-list-fallback when not
- Zero new type errors, all existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/46-topology-extraction/46-01-SUMMARY.md`
</output>
