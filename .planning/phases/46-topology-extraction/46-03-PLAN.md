---
phase: 46-topology-extraction
plan: 03
type: execute
wave: 3
depends_on: ["46-02"]
files_modified:
  - src/App.tsx
  - src/core/commands/navigation.ts
  - src/core/hooks/useKeyboardShortcuts.ts
  - src/core/blades/_discovery.ts
  - src/core/blades/settings/components/GeneralSettings.tsx
  - src/extensions/extensionCategories.ts
autonomous: true

must_haves:
  truths:
    - "Disabling the topology extension hides the topology process tab and renders commit-list-fallback instead of crashing"
    - "File watcher auto-refresh triggers topology reload only when topology extension is active (no orphaned event listeners)"
    - "Keyboard shortcut mod+2 is contributed by the extension command and the core show-history command is registry-aware"
    - "Settings defaultTab falls back to changes when topology extension is disabled"
    - "Extension Manager shows topology as independently toggleable built-in extension in source-control category"
  artifacts:
    - path: "src/App.tsx"
      provides: "registerBuiltIn for topology, defaultTab guard, topology file watcher removed"
      contains: "registerBuiltIn"
    - path: "src/core/commands/navigation.ts"
      provides: "Registry-aware show-history command with toast fallback"
      contains: "blades.has"
    - path: "src/extensions/extensionCategories.ts"
      provides: "Topology categorized as source-control"
      contains: "topology"
  key_links:
    - from: "src/App.tsx"
      to: "src/extensions/topology/index.ts"
      via: "registerBuiltIn({ id: 'topology' })"
      pattern: "registerBuiltIn.*topology"
    - from: "src/core/commands/navigation.ts"
      to: "src/core/lib/bladeRegistry"
      via: "useBladeRegistry for registry-aware show-history"
      pattern: "blades\\.has\\(\"topology-graph\"\\)"
---

<objective>
Complete the topology extraction by wiring the extension into the app, removing all hardcoded core references (old registration, file watcher, commands), and ensuring graceful degradation across settings, shortcuts, and Extension Manager.

Purpose: This is the final wiring step. After this plan, topology is a fully toggleable built-in extension. Disabling it hides the process tab, removes the keyboard shortcut from the command palette, and silently falls back in settings -- with zero crashes.

Output: Topology fully operational as extension #13 (7th independently toggleable), old core registration deleted
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-topology-extraction/46-RESEARCH.md
@.planning/phases/46-topology-extraction/46-01-SUMMARY.md
@.planning/phases/46-topology-extraction/46-02-SUMMARY.md

@src/App.tsx
@src/core/commands/navigation.ts
@src/core/hooks/useKeyboardShortcuts.ts
@src/core/blades/_discovery.ts
@src/core/blades/settings/components/GeneralSettings.tsx
@src/extensions/extensionCategories.ts
@src/core/blades/_shared/ProcessNavigation.tsx
@src/extensions/topology/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire topology extension in App.tsx + remove old core references</name>
  <files>
    src/App.tsx
    src/core/blades/_discovery.ts
    src/core/commands/navigation.ts
    src/core/hooks/useKeyboardShortcuts.ts
  </files>
  <action>
    1. **App.tsx -- Register topology as built-in extension:**
       - Find the section with `registerBuiltIn()` calls (near the other built-in extension registrations)
       - Add: `registerBuiltIn({ id: "topology", name: "Topology Graph", version: "1.0.0", activate: () => import("./extensions/topology"), icon: Network });`
       - Import `Network` from `lucide-react` if not already imported
       - Place it AFTER init-repo and BEFORE github (or at the end of the list -- ordering matters for activation sequence)

    2. **App.tsx -- Remove topology file watcher code:**
       - Find the file watcher `useEffect` that listens for `"repository-changed"` events
       - Remove the topology-specific refresh lines: the block that checks `topologyState.nodes.length > 0` and calls `topologyState.loadGraph()`
       - Remove any `useTopologyStore` or topology-related import that is no longer used after this removal
       - Keep ALL other file watcher logic intact (query invalidations, loadUndoInfo, etc.)

    3. **App.tsx -- Guard defaultTab for topology:**
       - Find the `initSettings().then(...)` block that handles `defaultTab`
       - The current code: `if (defaultTab === "topology" || defaultTab === "history") { getNavigationActor().send(...) }`
       - Add a blade registry guard: `if ((defaultTab === "topology" || defaultTab === "history") && useBladeRegistry.getState().blades.has("topology-graph")) { ... }`
       - Import `useBladeRegistry` from `./core/lib/bladeRegistry` if not already imported
       - This ensures a silent fallback to "changes" (staging) when topology is disabled

    4. **navigation.ts -- Make show-history command registry-aware:**
       - The "show-history" command currently directly sends `SWITCH_PROCESS: "topology"`
       - Update its action to check blade registry first:
         ```typescript
         action: () => {
           const hasTopology = useBladeRegistry.getState().blades.has("topology-graph");
           if (hasTopology) {
             getNavigationActor().send({ type: "SWITCH_PROCESS", process: "topology" });
           }
           // If topology is disabled, do nothing (user can enable via Extension Manager)
         },
         ```
       - Add import: `import { useBladeRegistry } from "../lib/bladeRegistry";`
       - This keeps the `mod+2` shortcut always registered in core (for muscle memory) but makes it conditional on extension availability

    5. **useKeyboardShortcuts.ts -- Conditionalize topology shortcuts:**
       - Find the `mod+2` shortcut handler (around line 252-262). It currently sends `SWITCH_PROCESS: "topology"` unconditionally.
       - Add a blade registry check: `if (!useBladeRegistry.getState().blades.has("topology-graph")) return;` at the top of the handler
       - Find the `Enter` key handler for topology commit details (around line 289-303). It already checks `activeProcess === "topology"` which is naturally safe (ProcessNavigation auto-redirects away from topology when disabled). But for code cleanliness, add the same blade registry guard.
       - Add import: `import { useBladeRegistry } from "../lib/bladeRegistry";` (if not already present)

    6. **_discovery.ts -- Remove topology-graph from EXPECTED_TYPES:**
       - In the `EXPECTED_TYPES` array, remove `"topology-graph"` (it is now registered by the extension, not by core registration.ts)
       - Keep `"commit-list-fallback"` (added in Plan 01)

    7. **Delete old core topology-graph directory:**
       - Delete `src/core/blades/topology-graph/` entirely:
         - `registration.ts` (replaced by extension's api.registerBlade)
         - `index.ts` (barrel export no longer needed)
         - `TopologyRootBlade.tsx` (moved to extension)
         - `TopologyRootBlade.test.tsx` (moved to extension)
         - `components/TopologyPanel.tsx` (moved to extension)
         - `components/TopologyEmptyState.tsx` (moved to extension)
         - `components/CommitBadge.tsx` (moved to extension)
         - `components/LaneHeader.tsx` (moved to extension)
         - `components/LaneBackground.tsx` (moved to extension)
         - `components/layoutUtils.ts` (moved to extension)
       - Verify no other files in the codebase import from this deleted directory (except the already-fixed CommitTypeIcon which was updated in Plan 01)

    IMPORTANT: Run `grep -r "core/blades/topology-graph" src/` BEFORE deleting to verify no remaining imports. The only expected match should be the old directory's own files (which are being deleted).
  </action>
  <verify>
    - `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` should show no new type errors
    - `ls src/core/blades/topology-graph/ 2>/dev/null` should show "No such file or directory"
    - `grep "topology" src/App.tsx` should show registerBuiltIn and defaultTab guard
    - `grep -r "core/blades/topology-graph" src/` should return EMPTY (all references removed)
    - `grep "useBladeRegistry" src/core/commands/navigation.ts` confirms registry-aware command
    - `grep "useBladeRegistry" src/core/hooks/useKeyboardShortcuts.ts` confirms conditional shortcuts
    - `grep "topology-graph" src/core/blades/_discovery.ts` should return EMPTY
  </verify>
  <done>
    - Topology registered as built-in extension in App.tsx
    - Old core/blades/topology-graph/ directory completely deleted
    - File watcher topology code removed from App.tsx (now in extension)
    - defaultTab guarded with blade registry check
    - show-history command is registry-aware
    - Keyboard shortcuts conditionalized on blade registry
    - "topology-graph" removed from _discovery.ts EXPECTED_TYPES
  </done>
</task>

<task type="auto">
  <name>Task 2: Update settings UI + extension categories + final verification</name>
  <files>
    src/core/blades/settings/components/GeneralSettings.tsx
    src/extensions/extensionCategories.ts
  </files>
  <action>
    1. **GeneralSettings.tsx -- Filter topology options when extension disabled:**
       - Add import: `import { useBladeRegistry } from "../../../lib/bladeRegistry";`
       - Inside the component, subscribe to blade registry: `const blades = useBladeRegistry((s) => s.blades);`
       - Compute: `const topologyAvailable = blades.has("topology-graph");`
       - Find the tab options definition (the radio buttons or option array for "Changes", "History", "Topology")
       - For the "History" and "Topology" options:
         - Add `disabled={!topologyAvailable}` attribute
         - Add `title={!topologyAvailable ? "Enable the Topology extension to use this option" : undefined}` tooltip
         - Add `className` with conditional `opacity-50 cursor-not-allowed` when disabled
         - Prevent selection when disabled: wrap onClick in `if (!disabled)` check
       - This follows the UX recommendation of showing disabled options with tooltip rather than hiding them entirely

    2. **extensionCategories.ts -- Add topology category:**
       - In the `EXTENSION_CATEGORIES` record, add: `topology: "source-control"`
       - This groups topology with "conventional-commits" and "worktrees" in the Extension Manager

    3. **Final cross-check -- verify all 9 TOPO requirements are met:**
       - TOPO-01: registerBuiltIn in App.tsx (Task 1)
       - TOPO-02: coreOverride: true in extension index.ts (Plan 02)
       - TOPO-03: commit-list-fallback blade renders via rootBladeForProcess (Plan 01)
       - TOPO-04: ProcessNavigation hides tab automatically (Phase 43 -- no changes needed)
       - TOPO-05: File watcher in extension lifecycle with onDispose (Plan 02 + Task 1 removal)
       - TOPO-06: show-history command registry-aware, mod+2 conditional (Task 1)
       - TOPO-07: defaultTab guarded with blade registry check (Task 1), settings UI disabled options (Task 2)
       - TOPO-08: Topology data stays in GitOpsStore (unchanged -- data slice untouched)
       - TOPO-09: Extension Manager shows topology in source-control category (Task 2)
  </action>
  <verify>
    - `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` should show no new type errors
    - `npx vitest run --reporter=verbose 2>&1 | tail -10` should show all tests passing
    - `grep "topology" src/extensions/extensionCategories.ts` confirms category mapping
    - `grep "useBladeRegistry" src/core/blades/settings/components/GeneralSettings.tsx` confirms reactive subscription
    - `grep "topologyAvailable" src/core/blades/settings/components/GeneralSettings.tsx` confirms conditional rendering
    - Extension count check: `grep -c "registerBuiltIn" src/App.tsx` should show 13 (12 existing + topology)
  </verify>
  <done>
    - GeneralSettings disables topology-related tab options with tooltip when extension is disabled
    - Topology categorized as "source-control" in Extension Manager
    - All 9 TOPO requirements addressed across plans 01-03
    - All tests pass, no type errors
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation clean: `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` -- no new errors
2. All tests pass: `npx vitest run`
3. Old directory deleted: `ls src/core/blades/topology-graph/ 2>/dev/null` returns error
4. No stale references: `grep -r "core/blades/topology-graph" src/` returns empty
5. Extension registered: `grep "registerBuiltIn.*topology" src/App.tsx`
6. Category mapped: `grep "topology.*source-control" src/extensions/extensionCategories.ts`
7. Settings guarded: `grep "topologyAvailable" src/core/blades/settings/components/GeneralSettings.tsx`
8. DefaultTab guarded: `grep "blades.has.*topology-graph" src/App.tsx`
9. Command registry-aware: `grep "blades.has.*topology-graph" src/core/commands/navigation.ts`
</verification>

<success_criteria>
- Topology is the 13th built-in extension (7th independently toggleable)
- Disabling topology: process tab hides, commit-list-fallback renders, shortcuts are no-op, settings show disabled options
- Enabling topology: full graph view, shortcuts work, settings options enabled
- File watcher only refreshes topology when extension is active
- Zero stale imports pointing to deleted core/blades/topology-graph/
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/46-topology-extraction/46-03-SUMMARY.md`
</output>
