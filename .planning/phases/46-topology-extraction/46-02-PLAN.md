---
phase: 46-topology-extraction
plan: 02
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - src/extensions/topology/manifest.json
  - src/extensions/topology/index.ts
  - src/extensions/topology/blades/TopologyRootBlade.tsx
  - src/extensions/topology/components/TopologyPanel.tsx
  - src/extensions/topology/components/TopologyEmptyState.tsx
  - src/extensions/topology/components/CommitBadge.tsx
  - src/extensions/topology/components/LaneHeader.tsx
  - src/extensions/topology/components/LaneBackground.tsx
  - src/extensions/topology/lib/layoutUtils.ts
autonomous: true

must_haves:
  truths:
    - "Topology extension directory exists at src/extensions/topology/ with manifest and entry point"
    - "All topology components moved from core/blades/topology-graph/ to extensions/topology/"
    - "All import paths updated to reflect new directory location"
    - "The topology extension onActivate registers blade with coreOverride:true, show-history command, and file watcher listener"
  artifacts:
    - path: "src/extensions/topology/index.ts"
      provides: "Extension entry point with onActivate/onDeactivate"
      exports: ["onActivate", "onDeactivate"]
    - path: "src/extensions/topology/manifest.json"
      provides: "Extension metadata"
      contains: "topology"
    - path: "src/extensions/topology/blades/TopologyRootBlade.tsx"
      provides: "Root blade with graph/history sub-tabs"
      exports: ["TopologyRootBlade"]
    - path: "src/extensions/topology/components/TopologyPanel.tsx"
      provides: "SVG graph renderer"
      exports: ["TopologyPanel"]
    - path: "src/extensions/topology/lib/layoutUtils.ts"
      provides: "Graph layout computation utilities"
      exports: ["parseConventionalType", "assignLanes", "buildEdgePaths"]
  key_links:
    - from: "src/extensions/topology/index.ts"
      to: "src/core/machines/navigation/context"
      via: "getNavigationActor import for SWITCH_PROCESS"
      pattern: "getNavigationActor"
    - from: "src/extensions/topology/index.ts"
      to: "src/core/stores/domain/git-ops"
      via: "useGitOpsStore import for topology data"
      pattern: "useGitOpsStore"
    - from: "src/extensions/topology/components/TopologyPanel.tsx"
      to: "src/core/hooks/useCommitGraph"
      via: "useCommitGraph hook import"
      pattern: "useCommitGraph"
---

<objective>
Create the topology extension directory structure, move all topology components from core to the extension, and implement the extension entry point with blade registration, command contribution, and file watcher lifecycle.

Purpose: This is the core extraction -- moving the topology graph from a hardcoded core blade to a self-contained extension that can be toggled on/off via Extension Manager.

Output: Complete src/extensions/topology/ directory with all components, entry point, and manifest
</objective>

<execution_context>
@/Users/phmatray/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phmatray/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-topology-extraction/46-RESEARCH.md
@.planning/phases/46-topology-extraction/46-01-SUMMARY.md

@src/extensions/init-repo/index.ts
@src/core/blades/topology-graph/TopologyRootBlade.tsx
@src/core/blades/topology-graph/components/TopologyPanel.tsx
@src/core/blades/topology-graph/components/TopologyEmptyState.tsx
@src/core/blades/topology-graph/components/CommitBadge.tsx
@src/core/blades/topology-graph/components/LaneHeader.tsx
@src/core/blades/topology-graph/components/LaneBackground.tsx
@src/core/blades/topology-graph/components/layoutUtils.ts
@src/core/hooks/useCommitGraph.ts
@src/core/stores/domain/git-ops/topology.slice.ts
@src/extensions/ExtensionAPI.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extension skeleton and move topology components</name>
  <files>
    src/extensions/topology/manifest.json
    src/extensions/topology/blades/TopologyRootBlade.tsx
    src/extensions/topology/components/TopologyPanel.tsx
    src/extensions/topology/components/TopologyEmptyState.tsx
    src/extensions/topology/components/CommitBadge.tsx
    src/extensions/topology/components/LaneHeader.tsx
    src/extensions/topology/components/LaneBackground.tsx
    src/extensions/topology/lib/layoutUtils.ts
  </files>
  <action>
    1. Create `src/extensions/topology/manifest.json`:
       ```json
       {
         "id": "topology",
         "name": "Topology Graph",
         "version": "1.0.0",
         "description": "Visualize commit history as an interactive lane-based graph with branch classification and commit type icons.",
         "apiVersion": "1",
         "main": "index.ts",
         "contributes": {
           "blades": [{ "type": "topology-graph", "title": "Topology" }],
           "commands": [{ "id": "show-topology", "title": "Show History", "category": "Navigation" }]
         },
         "trustLevel": "built-in"
       }
       ```

    2. Move components from `src/core/blades/topology-graph/` to `src/extensions/topology/`. For EACH moved file, update relative import paths:

       **TopologyRootBlade.tsx** -> `src/extensions/topology/blades/TopologyRootBlade.tsx`:
       - Update import of `TopologyPanel` from `./components/TopologyPanel` to `../components/TopologyPanel`
       - Update import of `CommitHistory` -- old path was `../../components/commit/CommitHistory`, new: `../../../core/components/commit/CommitHistory`
       - Update import of `useBladeNavigation` -- old: `../../hooks/useBladeNavigation`, new: `../../../core/hooks/useBladeNavigation`
       - Update any other relative imports (`cn` utility etc.) to navigate from `extensions/topology/blades/` to the core directory

       **TopologyPanel.tsx** -> `src/extensions/topology/components/TopologyPanel.tsx`:
       - Update import of `useCommitGraph` -- old: `../../../hooks/useCommitGraph`, new: `../../../core/hooks/useCommitGraph`
       - Update import of `branchClassifier` -- old: `../../../lib/branchClassifier`, new: `../../../core/lib/branchClassifier`
       - Update import of `layoutUtils` -- old: `./layoutUtils`, new: `../lib/layoutUtils`
       - Update imports of `CommitBadge`, `TopologyEmptyState`, `LaneHeader`, `LaneBackground` -- old: `./ComponentName`, new: `./ComponentName` (same level, no change needed since they move together)
       - Update bindings import -- old: `../../../../bindings`, new: `../../../bindings`

       **TopologyEmptyState.tsx** -> `src/extensions/topology/components/TopologyEmptyState.tsx`:
       - Update import of `getNavigationActor` -- old: `../../../machines/navigation/context`, new: `../../../core/machines/navigation/context`
       - Update any other relative imports accordingly

       **CommitBadge.tsx** -> `src/extensions/topology/components/CommitBadge.tsx`:
       - Update bindings import -- old: `../../../../bindings`, new: `../../../bindings`
       - Update conventional-commits import -- old: `../../../../extensions/conventional-commits/lib/commit-type-theme`, new: `../../conventional-commits/lib/commit-type-theme`
       - Update contextMenuRegistry import -- old: `../../../lib/contextMenuRegistry`, new: `../../../core/lib/contextMenuRegistry`
       - Update layoutUtils import -- old: `./layoutUtils`, new: `../lib/layoutUtils`

       **LaneHeader.tsx** -> `src/extensions/topology/components/LaneHeader.tsx`:
       - Update bindings import -- old: `../../../../bindings`, new: `../../../bindings`
       - Update layoutUtils import -- old: `./layoutUtils`, new: `../lib/layoutUtils`

       **LaneBackground.tsx** -> `src/extensions/topology/components/LaneBackground.tsx`:
       - Update bindings import -- old: `../../../../bindings`, new: `../../../bindings`
       - Update layoutUtils import -- old: `./layoutUtils`, new: `../lib/layoutUtils`

       **layoutUtils.ts** -> `src/extensions/topology/lib/layoutUtils.ts`:
       - Update bindings import -- old: `../../../../bindings`, new: `../../../bindings`
       - Update branchClassifier import -- old: `../../../lib/branchClassifier`, new: `../../../core/lib/branchClassifier`
       - Update conventional-utils import -- old: `../../../../extensions/conventional-commits/lib/conventional-utils`, new: `../../conventional-commits/lib/conventional-utils`
       - The `parseConventionalType` function can STAY in layoutUtils (it is also independently available from commitClassifier.ts in core now per Plan 01). Keeping it here avoids changing internal topology component imports.

    3. Also move the test file: `src/core/blades/topology-graph/TopologyRootBlade.test.tsx` -> `src/extensions/topology/__tests__/TopologyRootBlade.test.tsx`
       - Update all import paths in the test to reference the new component locations

    IMPORTANT: Do NOT delete the old `src/core/blades/topology-graph/` directory yet -- that happens in Plan 03. The old registration.ts still needs to exist until the extension is wired up.
  </action>
  <verify>
    - `ls src/extensions/topology/manifest.json src/extensions/topology/blades/ src/extensions/topology/components/ src/extensions/topology/lib/` should list all expected files
    - `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` should show no new type errors
    - `grep -r "from.*core/blades/topology-graph" src/extensions/topology/` should return EMPTY (no imports pointing back to old location)
  </verify>
  <done>
    - All topology components exist in src/extensions/topology/
    - All import paths updated to navigate correctly from extension directory
    - manifest.json describes the extension with correct metadata
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement topology extension entry point</name>
  <files>
    src/extensions/topology/index.ts
  </files>
  <action>
    Create `src/extensions/topology/index.ts` following the init-repo extension pattern (see `src/extensions/init-repo/index.ts`):

    ```typescript
    import { lazy } from "react";
    import { History } from "lucide-react";
    import { listen } from "@tauri-apps/api/event";
    import type { ExtensionAPI } from "../ExtensionAPI";
    import { getNavigationActor } from "../../core/machines/navigation/context";
    import { useGitOpsStore } from "../../core/stores/domain/git-ops";

    export async function onActivate(api: ExtensionAPI): Promise<void> {
      // 1. Register blade with coreOverride (preserves "topology-graph" type without ext: prefix)
      const TopologyRootBlade = lazy(() =>
        import("./blades/TopologyRootBlade").then((m) => ({
          default: m.TopologyRootBlade,
        }))
      );

      api.registerBlade({
        type: "topology-graph",
        title: "Topology",
        component: TopologyRootBlade,
        singleton: true,
        lazy: true,
        wrapInPanel: false,
        showBack: false,
        coreOverride: true,
      });

      // 2. Register "Show History" command (replaces core navigation.ts entry -- removed in Plan 03)
      api.registerCommand({
        id: "show-topology",
        title: "Show History",
        description: "Switch to the topology (history) view",
        category: "Navigation",
        shortcut: "mod+2",
        icon: History,
        keywords: ["topology", "history", "graph", "commits"],
        action: () => {
          getNavigationActor().send({ type: "SWITCH_PROCESS", process: "topology" });
        },
        enabled: () => !!useGitOpsStore.getState().repoStatus,
      });

      // 3. File watcher: auto-refresh topology when repository files change externally
      //    This replaces the topology-specific code in App.tsx (removed in Plan 03)
      const unlisten = await listen<{ paths: string[] }>("repository-changed", () => {
        const state = useGitOpsStore.getState();
        if (state.nodes.length > 0) {
          state.loadGraph();
        }
      });
      api.onDispose(() => unlisten());

      // 4. Apply defaultTab setting: if user prefers topology as default, switch to it
      //    This handles the timing issue where settings load before extension activation
      try {
        const { Store } = await import("@tauri-apps/plugin-store");
        const store = await Store.load("settings.json");
        const settings = await store.get<{ general?: { defaultTab?: string } }>("settings");
        const defaultTab = settings?.general?.defaultTab;
        if (defaultTab === "topology" || defaultTab === "history") {
          // Only switch if a repo is open (repoStatus exists)
          if (useGitOpsStore.getState().repoStatus) {
            getNavigationActor().send({ type: "SWITCH_PROCESS", process: "topology" });
          }
        }
      } catch {
        // Settings not available yet -- no-op, user can navigate manually
      }
    }

    export function onDeactivate(): void {
      // api.cleanup() handles all unregistrations (blade, commands, disposables)
      // Topology data stays in GitOpsStore (TOPO-08) -- no store cleanup needed
    }
    ```

    Key design decisions:
    - Blade uses `coreOverride: true` to register as raw "topology-graph" type (not "ext:topology:topology-graph")
    - File watcher listener is cleaned up via `api.onDispose()` so no orphaned listeners when extension is disabled
    - defaultTab handling is self-contained in the extension to avoid timing issues
    - Command uses "show-topology" as ID (the extension will namespace it). The core "show-history" command is updated in Plan 03 to be registry-aware
    - `onDeactivate` is empty because `api.cleanup()` handles all unregistrations atomically
    - Topology data stays in GitOpsStore per TOPO-08 -- no extension-owned store needed

    IMPORTANT: Verify the `listen` import path works. Check existing extensions that use `@tauri-apps/api/event`. Also verify that `useGitOpsStore.getState().nodes` and `useGitOpsStore.getState().loadGraph` exist on the topology slice (they are part of the combined GitOpsStore).
  </action>
  <verify>
    - `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` should show no new type errors
    - `grep "coreOverride" src/extensions/topology/index.ts` confirms blade registration pattern
    - `grep "repository-changed" src/extensions/topology/index.ts` confirms file watcher registration
    - `grep "onDispose" src/extensions/topology/index.ts` confirms cleanup registration
    - `grep "registerCommand" src/extensions/topology/index.ts` confirms command contribution
  </verify>
  <done>
    - Extension entry point exists with onActivate/onDeactivate
    - Blade registered with coreOverride: true preserving "topology-graph" type
    - Show History command registered with shortcut metadata
    - File watcher listener registered with cleanup via onDispose
    - defaultTab handling self-contained in extension
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation clean: `npx tsc --noEmit 2>&1 | grep -v 'bindings.ts'` -- no new errors
2. Extension directory complete: `find src/extensions/topology -type f | sort` shows all expected files
3. No imports from old location: `grep -r "core/blades/topology-graph" src/extensions/topology/` returns empty
4. Entry point well-formed: `grep -c "export.*function" src/extensions/topology/index.ts` shows 2 (onActivate, onDeactivate)
5. coreOverride pattern used: `grep "coreOverride.*true" src/extensions/topology/index.ts`
</verification>

<success_criteria>
- Complete src/extensions/topology/ directory with manifest, entry point, blades/, components/, lib/
- All import paths correct (no references to old core/blades/topology-graph/)
- Extension entry point registers blade, command, and file watcher with proper cleanup
- TypeScript compiles cleanly, no test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/46-topology-extraction/46-02-SUMMARY.md`
</output>
