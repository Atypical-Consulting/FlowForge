# Feature Landscape: Topology, Worktrees, and Init Repo Extraction to Extensions

**Domain:** Desktop Git client extension system (Tauri + React) -- feature extraction phase 2
**Researched:** 2026-02-11
**Milestone:** v1.7.0
**Confidence:** HIGH (based entirely on codebase evidence + v1.6.0 proven patterns)

## Table Stakes

Features users expect when more core features become extensions. Missing = extraction feels broken or the app regresses.

| Feature | Why Expected | Complexity | Notes |
|---------|--------------|------------|-------|
| Topology fallback when extension disabled | Topology is one of two root processes (staging/topology). Disabling it must not crash the app or leave a blank pane. v1.6.0 set precedent: CC -> plain textarea, Viewers -> plaintext, Gitflow -> plain Git mode. | **High** | This is the hardest extraction. `topology-graph` is hardcoded as a root blade in `rootBladeForProcess()` (navigation/actions.ts), the `ProcessNavigation` component lists it as one of two processes, and the `SWITCH_PROCESS` event in the navigation state machine routes to it. Fallback must be a minimal commit list blade (already exists as the "History" sub-tab in TopologyRootBlade). |
| Worktree sidebar disappears cleanly when disabled | Worktree panel is hardcoded in `RepositoryView.tsx` (lines 188-210) with its own `<details>` section, plus `CreateWorktreeDialog` and `DeleteWorktreeDialog`. Disabling must remove the entire section. v1.6.0 proved this: Gitflow panel moved to `contributeSidebarPanel()`. | **Med** | Follow exact Gitflow pattern: move from hardcoded `<details>` block to `api.contributeSidebarPanel()`. The `DynamicSidebarPanels` renderer in RepositoryView already handles extension-contributed panels with error boundaries. |
| Init Repo still works from WelcomeView when disabled | `WelcomeView.tsx` directly imports and renders `InitRepoBlade` for non-Git directories (line 117-131). Disabling the extension must show a simpler "run `git init`" fallback, not break the welcome experience. | **Med** | WelcomeView needs to check if the `init-repo` blade type is registered in BladeRegistry. If not, fall back to a basic "git init" action button (no template picker, no preview). |
| Extension enable/disable with persistence | Already built in v1.5.0. `persistDisabledExtensions()` saves state to tauri-plugin-store. New extensions inherit this automatically via `registerBuiltIn()`. | **None (free)** | Zero work needed. Pattern proven by 4 existing built-in extensions. |
| Clean lifecycle (activate/deactivate) | `ExtensionAPI.cleanup()` handles all 6 registry types (blades, commands, toolbar, context menu, sidebar panels, status bar). New extensions get atomic cleanup for free. | **None (free)** | Proven by all 4 existing extensions. |
| Topology auto-refresh survives extraction | `App.tsx` lines 131-136 auto-refresh topology on `repository-changed` events by checking `topologyState.nodes.length > 0`. This must continue working after extraction. | **Low** | The topology Zustand slice stays in `git-ops` store (data layer). Only the UI (blade + components) moves to the extension. The auto-refresh logic in App.tsx reads from the store, not the blade. |
| coreOverride blade type names preserved | All three features use core blade types (`topology-graph`, `init-repo`). Extensions must register with `coreOverride: true` so navigation and external references continue working unchanged. | **None (free)** | Pattern proven by content-viewers (`viewer-markdown`, `viewer-code`, `viewer-3d`), conventional-commits (`conventional-commit`, `changelog`), and Gitflow (`gitflow-cheatsheet`). |
| BladePropsMap type safety maintained | `stores/bladeTypes.ts` defines typed props for `topology-graph` and `init-repo`. These types must remain available even when extensions are disabled. | **Low** | Types stay in core. Extensions use them but don't own them. Same pattern as `viewer-markdown` -- type definition in BladePropsMap, component registration from extension. |
| Command palette entries for all three features | Topology ("Open Topology"), Worktrees ("Create Worktree", "List Worktrees"), Init Repo ("Initialize Repository") should appear in command palette and disappear when extension disabled. | **Low** | Use `api.registerCommand()` in each extension's `onActivate()`. Proven pattern from CC, Gitflow, and GitHub extensions. |

## Differentiators

Features that would improve the extraction beyond minimum viable, making the extension system more powerful.

| Feature | Value Proposition | Complexity | Notes |
|---------|-------------------|------------|-------|
| Process navigation becomes extension-contributed | Instead of hardcoding the staging/topology process tabs in `ProcessNavigation.tsx`, make processes registrable through extensions. Topology extension contributes the "Topology" process tab. | **High** | This is the ideal architectural outcome but adds a new "process registry" concept. The navigation state machine would need to support dynamic process types instead of the `"staging" \| "topology"` union. Consider deferring to v1.8.0 unless the extraction forces it. |
| Worktree status badge on sidebar panel | When worktrees extension contributes a sidebar panel via `contributeSidebarPanel()`, show a badge with count of dirty worktrees. Uses the `badge` property already supported by `SidebarPanelConfig`. | **Low** | The `SidebarPanelConfig` interface already has `badge?: () => number \| string \| null`. Worktree extension can read `worktreeList.filter(wt => wt.status === 'dirty').length`. |
| Topology contributes toolbar action | Add a "Topology" button to the toolbar via `api.contributeToolbar()` that switches to the topology process. Mirrors how Gitflow extension contributes a toolbar button for its cheatsheet. | **Low** | Simple: `api.contributeToolbar({ id: "topology", ... execute: () => switchProcess("topology") })`. Proven pattern. |
| Init Repo contributes command palette entry | Register "Initialize Repository" as a command that opens the init-repo blade. Only visible when no repo is open. | **Low** | `api.registerCommand({ id: "init-repo", ... enabled: () => !repoStatus })`. Already proven in CC and Gitflow extensions. |
| Worktree context menu items | Right-click a worktree item to get "Open in Explorer", "Switch To", "Delete" actions. Uses `api.contributeContextMenu()` added in v1.6.0. | **Med** | Context menu registry exists but worktree items don't have a context menu location yet. Needs a new `ContextMenuLocation` value like `"worktree-item"`. |
| Git hook integration for worktrees | Worktree extension listens to `onDidGit("checkout")` to auto-refresh the worktree list when branches change. | **Low** | `api.onDidGit("checkout", () => loadWorktrees())`. GitHookBus already supports this. |
| Topology extension contributes status bar item | Show current commit count or graph stats in the status bar. Uses `api.contributeStatusBar()` from v1.6.0. | **Low** | Simple reactive widget reading from topology store. Proven pattern from v1.6.0 status bar registry. |

## Anti-Features

Features to explicitly NOT build in this milestone.

| Anti-Feature | Why Avoid | What to Do Instead |
|--------------|-----------|-------------------|
| Dynamic process type registry | Allowing extensions to register arbitrary process types (beyond staging/topology) would require rewriting the XState navigation machine, ProcessNavigation component, rootBladeForProcess() action, keyboard shortcuts, and settings. Massive scope for a milestone focused on extraction. | Keep the `"staging" \| "topology"` ProcessType union. The topology extension uses `coreOverride` to replace the topology-graph blade. If topology extension is disabled, the topology process tab hides and default process becomes staging. This is simpler and safer. |
| Moving topology Zustand slice to extension | The topology slice (`topology.slice.ts`) is deeply integrated into the `GitOpsStore` composite store. Moving it would require splitting the store, changing all consumers, and dealing with state persistence across enable/disable cycles. | Keep `topology.slice.ts` in `git-ops` store (data layer). The extension only owns the UI (blade components). The slice continues to exist when the extension is disabled -- data just goes unused. Same pattern as Gitflow: the `gitflow.slice.ts` stays in git-ops even when the Gitflow extension is disabled. |
| Moving worktree Zustand slice to extension | Same reasoning as topology. `worktrees.slice.ts` is part of `GitOpsStore` and used by `WorktreePanel`, `CreateWorktreeDialog`, `DeleteWorktreeDialog`. | Keep `worktrees.slice.ts` in `git-ops` store. Extension owns only the UI components. |
| Moving init-repo Zustand store to extension | `useInitRepoStore` uses `createBladeStore()` (already blade-scoped). However, the store is imported by 7 components in `blades/init-repo/`. Moving it adds complexity with no user-facing benefit. | Move the entire `blades/init-repo/` directory contents into `extensions/init-repo/blades/`. The store travels with the components. This is a file move, not a refactor. |
| Topology SVG virtualization / canvas rendering | Performance optimization for large graphs. Out of scope for extraction -- extraction should be behavior-preserving. | Keep current SVG+DOM hybrid. Performance improvements are a future milestone. |
| Worktree multi-select bulk operations | Selecting multiple worktrees for bulk delete/switch. Not related to extraction. | Keep current single-select pattern. |
| Init Repo template marketplace | Downloading templates from GitHub API beyond the 163 bundled ones. Not related to extraction. | Keep current template discovery (163 bundled + GitHub API fallback). |
| CommitHistory component extraction | The `CommitHistory` component used in TopologyRootBlade's "History" tab is defined in `components/commit/`. It is shared with other features. | Keep `CommitHistory` in core `components/`. Topology extension imports it. If topology is disabled, CommitHistory is simply not rendered (no fallback needed -- the entire process tab hides). |

## Feature Dependencies

```
commandRegistry/previewRegistry migration to Zustand (tech debt)
     |
     v
Topology Extraction ---------> Process tab visibility logic
     |                                |
     |                                v
     |                         Navigation machine: fallback when topology disabled
     |
     v
Worktree Extraction ---------> Sidebar panel contribution (proven pattern)
     |                                |
     |                                v
     |                         Dialog lifecycle management (onDispose cleanup)
     |
     v
Init Repo Extraction --------> WelcomeView fallback logic
     |                                |
     |                                v
     |                         BladeRegistry check for conditional rendering
```

### Dependency Details

**Topology depends on:**
- Navigation machine understanding of disabled topology process
- `ProcessNavigation.tsx` conditionally hiding the topology tab
- `rootBladeForProcess()` returning staging blade when topology is disabled
- `App.tsx` topology auto-refresh logic working with store (not blade)

**Worktrees depends on:**
- `RepositoryView.tsx` removing hardcoded worktree `<details>` section
- Extension using `contributeSidebarPanel()` for sidebar integration
- Dialogs (Create/Delete) managed within extension scope with `onDispose` cleanup

**Init Repo depends on:**
- `WelcomeView.tsx` checking blade registry for fallback
- `_discovery.ts` removing init-repo from EXPECTED_TYPES list
- Extension registering blade with `coreOverride: true`

**All three share:**
- Existing `registerBuiltIn()` + `ExtensionAPI` infrastructure
- `coreOverride` blade registration pattern
- `api.registerCommand()` for command palette
- `api.contributeToolbar()` for toolbar actions

## MVP Recommendation

### Phase 1: Infrastructure Prep (must be first)

Prioritize addressing the structural prerequisites before any extraction:

1. **Migrate commandRegistry to Zustand** -- v1.6.0 tech debt. commandRegistry is a plain Map without `unregisterBySource()`. Extensions using `api.registerCommand()` need clean source-based cleanup. Currently works because commands are tracked by `ExtensionAPI.registeredCommands[]`, but migrating to Zustand aligns with all other registries.
2. **Add process tab visibility hook** -- Create a mechanism for `ProcessNavigation.tsx` to hide the topology tab when the topology extension is disabled. Simplest approach: check if `topology-graph` blade type is registered in `useBladeRegistry`.
3. **Add WelcomeView fallback pattern** -- Modify WelcomeView to check blade registry before rendering InitRepoBlade, with a simpler fallback.

### Phase 2: Worktree Extraction (lowest risk)

Extract worktrees first because it follows the exact Gitflow extraction pattern:

1. **Worktree sidebar panel** -- Move from hardcoded `<details>` in RepositoryView to `contributeSidebarPanel()`. Copy exact Gitflow pattern.
2. **Worktree dialogs** -- Manage Create/Delete dialogs within the extension. Use `onDispose` for cleanup.
3. **Worktree commands** -- Register "Create Worktree", "List Worktrees" in command palette.
4. **Worktree toolbar** -- Optional toolbar action for quick worktree creation.

### Phase 3: Init Repo Extraction (moderate risk)

1. **Move blade + components** to `extensions/init-repo/`. Register with `coreOverride: true`.
2. **WelcomeView integration** -- Conditional rendering based on blade registry.
3. **Fallback** -- When disabled, non-Git directories show a simple "Run git init" button instead of the full template wizard.
4. **Commands** -- Register in command palette.

### Phase 4: Topology Extraction (highest risk)

Extract topology last because it has the deepest integration:

1. **Move blade + components** to `extensions/topology/`. Register with `coreOverride: true`.
2. **Process navigation** -- Hide topology tab when extension disabled. Default to staging process.
3. **Navigation machine** -- Handle case where topology process is requested but blade not registered.
4. **Auto-refresh** -- Ensure App.tsx topology auto-refresh still works (reads store, not blade).
5. **Keyboard shortcuts** -- `useKeyboardShortcuts.ts` line 226 checks `activeProcess === "topology"` -- must handle disabled case.
6. **Settings default tab** -- App.tsx line 54 sets process to topology based on settings. Must check if topology is available first.

### Defer

- **Dynamic process registry**: Defer to v1.8.0. The extraction works fine with conditional hiding.
- **Worktree context menu**: Nice-to-have, not required for extraction.
- **Topology canvas rendering**: Performance concern, not extraction concern.

## Extraction Complexity Matrix

| Feature | Files to Move | Core References to Update | Fallback Complexity | Store Dependencies | Overall Risk |
|---------|--------------|--------------------------|--------------------|--------------------|-------------|
| **Worktrees** | 5 files (557 LOC) | 1 file (RepositoryView.tsx) | None (sidebar just disappears) | worktrees.slice stays in git-ops | **Low** |
| **Init Repo** | 9 files (1,213 LOC) | 2 files (WelcomeView.tsx, _discovery.ts) | Low (simple git init button) | initRepo store moves with blade | **Medium** |
| **Topology** | 8 files (677 LOC) + hook (45 LOC) | 5+ files (actions.ts, ProcessNavigation.tsx, App.tsx, _discovery.ts, useKeyboardShortcuts.ts) | High (process tab hiding, navigation fallback) | topology.slice stays in git-ops | **High** |

## Existing Extension Patterns to Reuse

All three extractions should follow these proven patterns from v1.6.0:

### Blade Registration (coreOverride)
```typescript
// From content-viewers/index.ts -- register blade without namespace prefix
api.registerBlade({
  type: "topology-graph",  // Same as core blade type
  title: "Topology",
  component: TopologyRootBlade,
  coreOverride: true,      // Registers as "topology-graph" not "ext:topology:topology-graph"
});
```

### Sidebar Panel Contribution
```typescript
// From gitflow/index.ts -- contribute sidebar section
api.contributeSidebarPanel({
  id: "worktree-panel",
  title: "Worktrees",
  icon: FolderGit2,
  component: WorktreePanel,
  priority: 60,
  defaultOpen: false,
  renderAction: () => createElement(CreateWorktreeButton),
});
```

### Toolbar Contribution
```typescript
// From conventional-commits/index.ts -- contribute toolbar button
api.contributeToolbar({
  id: "topology",
  label: "Topology",
  icon: Network,
  group: "views",
  priority: 60,
  when: () => !!useRepositoryStore.getState().repoStatus,
  execute: () => switchProcess("topology"),
});
```

### Command Registration
```typescript
// From gitflow/index.ts -- contribute command palette entry
api.registerCommand({
  id: "open-topology",
  title: "Open Topology Graph",
  category: "Navigation",
  icon: Network,
  action: () => switchProcess("topology"),
  enabled: () => !!useRepositoryStore.getState().repoStatus,
});
```

### Deactivation with Custom Cleanup
```typescript
// From github/index.ts -- extension-specific cleanup beyond api.cleanup()
export function onDeactivate(): void {
  // Cancel active subscriptions
  if (unsubWorktreeWatch) {
    unsubWorktreeWatch();
    unsubWorktreeWatch = null;
  }
  // Note: api.cleanup() handles all registered blades/commands/toolbar/sidebar automatically
}
```

## Fallback Patterns for Each Feature

### Topology Disabled
- **Process Navigation**: Hide "Topology" tab. Show only "Staging".
- **Default Tab Setting**: If user's default tab is "topology", fall back to "staging".
- **Keyboard Shortcut**: Process switch to topology becomes no-op.
- **App.tsx Auto-refresh**: Topology store still exists (data layer in git-ops). Auto-refresh code reads `topologyState.nodes.length > 0` -- with extension disabled, nodes will be empty, so refresh is safely skipped.
- **User experience**: User sees only the staging workflow. Commit history is still accessible through the staging blade's commit list. The rich SVG graph is gone, but basic functionality remains.

### Worktrees Disabled
- **Sidebar**: Worktree `<details>` section disappears from RepositoryView sidebar. Other sections (Branches, Stashes, Tags) remain unchanged.
- **Dialogs**: Create/Delete worktree dialogs are not rendered.
- **User experience**: Users can still manage worktrees via the command line. The GUI panel is simply absent. This is a clean absence -- no fallback UI needed because worktrees are an advanced feature.

### Init Repo Disabled
- **WelcomeView**: Non-Git directories show a simplified banner: "This folder is not a Git repository. [Initialize] [Cancel]". Clicking Initialize runs `git init` directly without the template picker, README options, or preview pane.
- **Blade navigation**: If something tries to open `init-repo` blade and it is not registered, the blade system shows a "Blade type not found" error (existing behavior for unregistered types). The WelcomeView fallback prevents this from happening in the normal flow.
- **User experience**: Users lose the guided setup experience (template picker, project detection, preview). They get a quick-init that creates a bare repo. The essential functionality (creating a Git repo) is preserved.

## Sources

- **Codebase analysis**: All findings based on direct file inspection of FlowForge source code
- **v1.6.0 patterns**: Proven extraction patterns from content-viewers, conventional-commits, gitflow, github extensions
- **Extension API**: `src/extensions/ExtensionAPI.ts` -- 6 registry methods, cleanup, lifecycle
- **Extension Host**: `src/extensions/ExtensionHost.ts` -- registerBuiltIn, activate/deactivate, persistence
- **Navigation Machine**: `src/machines/navigation/` -- process types, blade stack, SWITCH_PROCESS event
- **v1.6.0 MILESTONES.md entry**: Tech debt items (commandRegistry plain Map, previewRegistry plain Map)
