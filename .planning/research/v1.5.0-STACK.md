# Technology Stack

**Project:** FlowForge v1.5.0 -- Extension System, GitHub Integration, Toolbar UX
**Researched:** 2026-02-09

## Scope

This document covers ONLY the stack additions/changes needed for:
1. Extension system (manifest, loading, lifecycle, sandboxing)
2. GitHub integration (OAuth Device Flow, REST/GraphQL API, token storage)
3. Toolbar UX (overflow menu, responsive toolbar, customization)

Existing stack is validated and unchanged: Tauri 2.x, React 19, TypeScript, Tailwind v4, Catppuccin, XState v5, Zustand 5, React Query v5, Monaco, framer-motion, git2-rs, tauri-specta, reqwest.

---

## Recommended Stack Additions

### 1. GitHub OAuth -- Rust Side (Device Flow)

| Technology | Version | Purpose | Why |
|------------|---------|---------|-----|
| reqwest (existing) | 0.12 | HTTP client for Device Flow endpoints | Already a dependency. Device Flow is 2 POST endpoints + polling. Adding a crate for this is overkill. |
| keyring | ^3 | OS-native secure token storage | Uses macOS Keychain, Windows Credential Manager, Linux Secret Service. No passwords to manage (unlike Stronghold). Already the de facto Rust standard for credential storage. |

**Why NOT these alternatives:**

| Alternative | Why Not |
|------------|---------|
| `github-device-flow` crate | v0.2.0, 306 lines, uses blocking reqwest 0.11 (project uses async reqwest 0.12). Trivial to implement ourselves with existing deps. |
| `oauth2-rs` | Full OAuth2 library with generic abstractions. Device Flow is only 3 HTTP calls -- too heavy for what we need. |
| `tauri-plugin-stronghold` | Requires user to enter a password to unlock the vault. Wrong UX for transparent token management. |
| `tauri-plugin-keyring` | Community plugin wrapping the keyring crate. Adds a Tauri plugin indirection layer we don't need -- we can use keyring directly from our Rust commands. |
| `tauri-plugin-secure-storage` | New plugin (July 2025), limited version history. Keyring crate is more established (v3.6.3, widely used). |

**Implementation approach:** Implement Device Flow directly with reqwest in a new `src-tauri/src/github/` module. 3 functions: `request_device_code()`, `poll_for_token()`, `refresh_token()`. Store tokens via keyring crate. Expose as Tauri commands via tauri-specta.

**Confidence: HIGH** -- reqwest is already a dependency, keyring v3 is well-established, Device Flow is documented at [GitHub Docs](https://docs.github.com/en/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps).

### 2. GitHub API -- Frontend Side

| Technology | Version | Purpose | Why |
|------------|---------|---------|-----|
| `@octokit/rest` | ^22 | GitHub REST API client | Typed, complete REST API coverage. Decomposable -- only loads endpoint methods you import. |
| `@octokit/graphql` | ^8 | GitHub GraphQL API client | For efficient PR/issue queries that need nested data (reviews, labels, checks). Avoids N+1 REST calls. |
| `@octokit/auth-oauth-device` | ^8 | Device Flow auth strategy | Handles polling, code display, token exchange. The `onVerification` callback integrates cleanly with React state. |

**Why NOT these alternatives:**

| Alternative | Why Not |
|------------|---------|
| `octokit` (batteries-included) | Includes App client, Action client, webhook handling. We need only REST + GraphQL + device auth. Individual packages are smaller. |
| Raw `fetch` via Rust backend only | Loses TypeScript types for GitHub API. Octokit provides complete type coverage for 700+ endpoints. React Query integration is simpler from the frontend. |

**Architecture decision: Hybrid Rust + JS approach.**
- **Rust side:** Handles OAuth Device Flow (because it requires polling in background, opening browser via opener plugin, and storing tokens in OS keychain).
- **JS side:** Uses Octokit with token retrieved from Rust backend. React Query wraps Octokit calls for caching, refetching, optimistic updates.

**Confidence: HIGH** -- Octokit is the official GitHub SDK, actively maintained (v22.0.1 published Nov 2025). @octokit/auth-oauth-device v8.0.3 published Jan 2026.

### 3. Extension System -- No New Dependencies

| Technology | Version | Purpose | Why |
|------------|---------|---------|-----|
| (existing) `serde` + `serde_json` | 1.x | Parse extension manifest.json | Already dependencies. Extension manifests are JSON. |
| (existing) `tokio::fs` | 1.x | Async filesystem ops for extension loading | Already a dependency (tokio with "full" features). |
| (existing) `notify` | 8.x | Watch extension directory for changes | Already a dependency for git watcher. Reuse for `.flowforge/extensions/` watching. |
| (existing) Blade Registry | -- | Register extension-provided blades | Existing `bladeRegistry.ts` pattern handles component registration. Extensions add blades via same mechanism. |
| (existing) Command Registry | -- | Register extension-provided commands | Existing `commandRegistry.ts` handles command registration. Extensions add commands via same mechanism. |

**Why no new dependencies for extensions:**

The extension system is fundamentally about:
1. Reading a `manifest.json` (serde_json -- have it)
2. Scanning a directory (tokio::fs -- have it)
3. Watching for installs/uninstalls (notify -- have it)
4. Registering components at runtime (blade/command registries -- have them)
5. Loading JS bundles dynamically (dynamic `import()` -- built into the platform)

**Sandboxing approach:** Extensions run in the same React context (not iframes) for v1.5. They cannot access Tauri IPC directly -- they go through a constrained `ExtensionAPI` object that the host provides. True sandboxing (iframe isolation) is a v2.0 concern when third-party extensions are supported.

**Confidence: HIGH** -- All required capabilities exist in current dependencies.

### 4. Toolbar UX -- No New Dependencies

| Technology | Version | Purpose | Why |
|------------|---------|---------|-----|
| (existing) `ResizeObserver` API | Web API | Measure toolbar container width | Built into all modern browsers/webview. No library needed. |
| (existing) `framer-motion` | ^12 | Animate overflow menu transitions | Already a dependency. Use `AnimatePresence` + `motion.div` for dropdown. |
| (existing) `react-hotkeys-hook` | ^5 | Keyboard shortcuts for toolbar items | Already a dependency. |
| (existing) `@tauri-apps/plugin-store` | ^2 | Persist toolbar customization | Already used for settings. Store toolbar item visibility/order in same settings file. |

**Why no new dependencies for toolbar:**

The overflow menu pattern requires:
1. Measuring container width (ResizeObserver -- web API)
2. Measuring item widths (refs + `getBoundingClientRect()`)
3. Moving items to overflow when they don't fit (React state)
4. Animating the overflow dropdown (framer-motion -- have it)
5. Persisting show/hide preferences (tauri-plugin-store -- have it)

This is 100-200 lines of custom hook code (`useOverflowToolbar`), not a library problem.

**Confidence: HIGH** -- Standard web API pattern, no external dependencies needed.

---

## Supporting Infrastructure

### Tauri Capabilities Update

The following Tauri capabilities/permissions need updating (not new dependencies, but config changes):

| Capability | Purpose | Notes |
|-----------|---------|-------|
| `opener:default` | Open GitHub device verification URL in browser | Already configured. `openUrl` is already used in MarkdownLink component. |
| `store:default` | Persist extension settings, toolbar config | Already configured. |

**No new Tauri plugins needed.** The keyring crate is a pure Rust dependency, not a Tauri plugin, so it needs no capability configuration.

### Rust Dependencies to Add

```toml
# In src-tauri/Cargo.toml [dependencies]
keyring = { version = "3", features = ["apple-native", "windows-native", "linux-native"] }
```

That is the ONLY new Rust dependency.

### npm Dependencies to Add

```bash
npm install @octokit/rest@^22 @octokit/graphql@^8 @octokit/auth-oauth-device@^8
```

Three packages, all from the official Octokit organization.

---

## What NOT to Add

| Temptation | Why Not |
|-----------|---------|
| `tauri-plugin-fs` | Extension manifest loading happens in Rust (tokio::fs). Frontend doesn't need filesystem access for extensions. |
| `tauri-plugin-stronghold` | Requires user-entered password. OAuth tokens should be transparent. Use keyring instead. |
| `tauri-plugin-http` | We need HTTP only on the Rust side (reqwest, already there). Frontend GitHub API calls go through Octokit which uses fetch. |
| `iframe` sandboxing for extensions | Premature for v1.5 which only ships the GitHub extension (first-party). Adds massive complexity for message passing, style isolation, state sharing. |
| `@radix-ui/react-dropdown-menu` | Already have custom dropdown patterns with framer-motion. Adding a component library for one dropdown is wrong. |
| `@floating-ui/react` | Overflow menu is a simple absolute-positioned dropdown. CSS `position: absolute` + `right: 0` is sufficient. |
| React Query for Rust backend calls | Already established pattern: Zustand stores call Tauri commands directly. Don't mix patterns. React Query is for Octokit (HTTP API) only. |
| Full JSON Schema validator (e.g., `ajv`) | Extension manifests have <15 fields. TypeScript type guards + runtime checks are sufficient. |

---

## Integration Points with Existing Stack

### Extension System -> Blade Registry
Extensions register blades via `registerBlade()` from `bladeRegistry.ts`. The existing `BladeRegistration` interface already supports everything an extension blade needs: type, component, title, lazy loading, singleton behavior.

### Extension System -> Command Registry
Extensions register commands via `registerCommand()` from `commandRegistry.ts`. The existing `Command` interface supports id, title, category, action, shortcut, icon, enabled predicate.

### GitHub Integration -> Zustand Stores
New `useGitHubStore` Zustand store manages auth state, current user, token validity. Pattern: matches existing 3 domain stores (git-ops, ui-state, preferences).

### GitHub Extension -> React Query
GitHub PR/issue data is fetched via React Query + Octokit. Follows existing React Query patterns (`@tanstack/react-query` is already a dependency). Cache keys: `["github", "prs"]`, `["github", "issues"]`, etc.

### Toolbar -> Preferences Store
Toolbar customization (visible items, order) stored in preferences domain store. The existing `settings.slice.ts` and `navigation.slice.ts` patterns show how to persist UI preferences.

### OAuth -> Opener Plugin
Device Flow shows user a code and opens `https://github.com/login/device` in browser. The `openUrl` function from `@tauri-apps/plugin-opener` is already used (see `MarkdownLink.tsx`). Reuse for OAuth flow.

---

## Version Verification Summary

| Package | Claimed Version | Verification | Confidence |
|---------|----------------|--------------|------------|
| keyring (Rust) | ^3 (latest 3.6.3) | [crates.io](https://crates.io/crates/keyring), [docs.rs](https://docs.rs/keyring) | HIGH |
| @octokit/rest | ^22 (latest 22.0.1) | [npm](https://www.npmjs.com/package/@octokit/rest), [GitHub releases](https://github.com/octokit/rest.js/releases) | HIGH |
| @octokit/graphql | ^8 | [npm](https://www.npmjs.com/package/@octokit/graphql) | MEDIUM -- exact latest minor not verified |
| @octokit/auth-oauth-device | ^8 (latest 8.0.3) | [npm](https://www.npmjs.com/package/@octokit/auth-oauth-device) | HIGH |
| reqwest (existing) | 0.12 | Already in Cargo.toml | HIGH |
| tokio (existing) | 1.x full | Already in Cargo.toml | HIGH |
| notify (existing) | 8.x | Already in Cargo.toml | HIGH |

---

## Installation Commands

### Rust (Cargo.toml)

```toml
# Add to [dependencies] in src-tauri/Cargo.toml
keyring = { version = "3", features = ["apple-native", "windows-native", "linux-native"] }
```

### JavaScript (npm)

```bash
npm install @octokit/rest@^22 @octokit/graphql@^8 @octokit/auth-oauth-device@^8
```

### Dev Dependencies

No new dev dependencies needed.

---

## Sources

- [GitHub OAuth Device Flow documentation](https://docs.github.com/en/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps)
- [GitHub Device Flow changelog announcement](https://github.blog/changelog/2022-03-16-enable-oauth-device-authentication-flow-for-apps/)
- [@octokit/auth-oauth-device.js repository](https://github.com/octokit/auth-oauth-device.js)
- [@octokit/rest.js documentation](https://octokit.github.io/rest.js/v22/)
- [Octokit.js main repository](https://github.com/octokit/octokit.js/)
- [keyring crate documentation](https://docs.rs/keyring)
- [keyring crate on crates.io](https://crates.io/crates/keyring)
- [Tauri v2 Store plugin](https://v2.tauri.app/plugin/store/)
- [Tauri v2 Opener plugin](https://v2.tauri.app/plugin/opener/)
- [Tauri v2 Stronghold plugin](https://v2.tauri.app/plugin/stronghold/)
- [Tauri v2 Plugin Development](https://v2.tauri.app/develop/plugins/)
- [Tauri secure storage discussion](https://github.com/tauri-apps/tauri/discussions/7846)
- [tauri-plugin-keyring](https://github.com/HuakunShen/tauri-plugin-keyring)
- [VS Code Extension Manifest format](https://code.visualstudio.com/api/references/extension-manifest)
- [VS Code Contribution Points](https://code.visualstudio.com/api/references/contribution-points)
- [ResizeObserver MDN](https://developer.mozilla.org/en-US/docs/Web/API/ResizeObserver)
